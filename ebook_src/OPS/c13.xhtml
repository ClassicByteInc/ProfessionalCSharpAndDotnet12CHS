<!-- 这行注释会存在于经过翻译的源文件中。除非您获得许可请不要删除这个注释。
    翻译由 ClassicByte Org 的 higashitani yume 完成
    使用工具 沉浸式翻译 智谱GLM模型
    您可以阅读这个源代码，也可以向他人分发此源代码，但是不得用于商业用途。
    您也可以自己将这些代码打包成epub分发给别人，但是不得用于商业用途。
    如果此源代码侵犯了您的权益，请联系我我将会删除侵权内容。
    您在阅读此源代码时，可能会看到一些英文内容，这些内容是原书的内容，可能是因为翻译不准确或者是因为原书的内容没有被翻译。
    如果您发现了错误，请联系我我会进行修正。
  -->
<!--This line of comments will exist in the translated source file. Do not delete this comment unless you have permission.
    Translation is done by ClassicByte Org's higashitani yume
    Usage Tools Immersive Translation Zhipu GLM Model
    You can read this source code or distribute it to others, but it may not be used for commercial purposes.
    You can also package these codes yourself into epub and distribute them to others, but they may not be used for commercial purposes.
    If this source code infringes your rights, please contact me and I will delete the infringing content.
    When you read this source code, you may see some English content, which is the content of the original book, which may be because the translation is inaccurate or because the content of the original book has not been translated.
    If you find an error, please contact me and I will correct it.
  -->
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops"
    xmlns:svg="http://www.w3.org/2000/svg" epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en"
    imt-state="dual" imt-trans-position="after">

<head>
    <title>13 受管内存和未受管内存 --- 13 Managed and Unmanaged Memory</title>
    <link href="WileyTemplate_v5.5.css" rel="stylesheet" type="text/css" />
    <meta content="urn:uuid:e0000000-0000-0000-0000-000006715209" name="Adept.expected.resource" />
    <style data-id="immersive-translate-input-injected-css">
        .immersive-translate-input {
            position: absolute;
            top: 0;
            right: 0;
            left: 0;
            bottom: 0;
            z-index: 2147483647;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .immersive-translate-attach-loading::after {
            content: " ";

            --loading-color: #f78fb6;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: block;
            margin: 12px auto;
            position: relative;
            color: white;
            left: -100px;
            box-sizing: border-box;
            animation: immersiveTranslateShadowRolling 1.5s linear infinite;

            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-2000%, -50%);
            z-index: 100;
        }

        .immersive-translate-loading-spinner {
            vertical-align: middle !important;
            width: 10px !important;
            height: 10px !important;
            display: inline-block !important;
            margin: 0 4px !important;
            border: 2px rgba(221, 244, 255, 0.6) solid !important;
            border-top: 2px rgba(0, 0, 0, 0.375) solid !important;
            border-left: 2px rgba(0, 0, 0, 0.375) solid !important;
            border-radius: 50% !important;
            padding: 0 !important;
            -webkit-animation: immersive-translate-loading-animation 0.6s infinite linear !important;
            animation: immersive-translate-loading-animation 0.6s infinite linear !important;
        }

        @-webkit-keyframes immersive-translate-loading-animation {
            from {
                -webkit-transform: rotate(0deg);
            }

            to {
                -webkit-transform: rotate(359deg);
            }
        }

        @keyframes immersive-translate-loading-animation {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(359deg);
            }
        }

        .immersive-translate-input-loading {
            --loading-color: #f78fb6;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: block;
            margin: 12px auto;
            position: relative;
            color: white;
            left: -100px;
            box-sizing: border-box;
            animation: immersiveTranslateShadowRolling 1.5s linear infinite;
        }

        @keyframes immersiveTranslateShadowRolling {
            0% {
                box-shadow: 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0),
                    0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
            }

            12% {
                box-shadow: 100px 0 var(--loading-color), 0px 0 rgba(255, 255, 255, 0),
                    0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
            }

            25% {
                box-shadow: 110px 0 var(--loading-color), 100px 0 var(--loading-color),
                    0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
            }

            36% {
                box-shadow: 120px 0 var(--loading-color), 110px 0 var(--loading-color),
                    100px 0 var(--loading-color), 0px 0 rgba(255, 255, 255, 0);
            }

            50% {
                box-shadow: 130px 0 var(--loading-color), 120px 0 var(--loading-color),
                    110px 0 var(--loading-color), 100px 0 var(--loading-color);
            }

            62% {
                box-shadow: 200px 0 rgba(255, 255, 255, 0), 130px 0 var(--loading-color),
                    120px 0 var(--loading-color), 110px 0 var(--loading-color);
            }

            75% {
                box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0),
                    130px 0 var(--loading-color), 120px 0 var(--loading-color);
            }

            87% {
                box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0),
                    200px 0 rgba(255, 255, 255, 0), 130px 0 var(--loading-color);
            }

            100% {
                box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0),
                    200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0);
            }
        }

        .immersive-translate-toast {
            display: flex;
            position: fixed;
            z-index: 2147483647;
            left: 0;
            right: 0;
            top: 1%;
            width: fit-content;
            padding: 12px 20px;
            margin: auto;
            overflow: auto;
            background: #fef6f9;
            box-shadow: 0px 4px 10px 0px rgba(0, 10, 30, 0.06);
            font-size: 15px;
            border-radius: 8px;
            color: #333;
        }

        .immersive-translate-toast-content {
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        .immersive-translate-toast-hidden {
            margin: 0 20px 0 72px;
            text-decoration: underline;
            cursor: pointer;
        }

        .immersive-translate-toast-close {
            color: #666666;
            font-size: 20px;
            font-weight: bold;
            padding: 0 10px;
            cursor: pointer;
        }

        @media screen and (max-width: 768px) {
            .immersive-translate-toast {
                top: 0;
                padding: 12px 0px 0 10px;
            }

            .immersive-translate-toast-content {
                flex-direction: column;
                text-align: center;
            }

            .immersive-translate-toast-hidden {
                margin: 10px auto;
            }
        }

        .immersive-translate-modal {
            display: none;
            position: fixed;
            z-index: 2147483647;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0, 0, 0);
            background-color: rgba(0, 0, 0, 0.4);
            font-size: 15px;
        }

        .immersive-translate-modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 40px 24px 24px;
            border: 1px solid #888;
            border-radius: 10px;
            width: 80%;
            max-width: 270px;
            font-family: system-ui, -apple-system, "Segoe UI", "Roboto", "Ubuntu",
                "Cantarell", "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji",
                "Segoe UI Symbol", "Noto Color Emoji";
            position: relative;
        }

        @media screen and (max-width: 768px) {
            .immersive-translate-modal-content {
                margin: 50% auto !important;
            }
        }

        .immersive-translate-modal .immersive-translate-modal-content-in-input {
            max-width: 500px;
        }

        .immersive-translate-modal-content-in-input .immersive-translate-modal-body {
            text-align: left;
            max-height: unset;
        }

        .immersive-translate-modal-title {
            text-align: center;
            font-size: 16px;
            font-weight: 700;
            color: #333333;
        }

        .immersive-translate-modal-body {
            text-align: center;
            font-size: 14px;
            font-weight: 400;
            color: #333333;
            word-break: break-all;
            margin-top: 24px;
        }

        @media screen and (max-width: 768px) {
            .immersive-translate-modal-body {
                max-height: 250px;
                overflow-y: auto;
            }
        }

        .immersive-translate-close {
            color: #666666;
            position: absolute;
            right: 16px;
            top: 16px;
            font-size: 20px;
            font-weight: bold;
        }

        .immersive-translate-close:hover,
        .immersive-translate-close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .immersive-translate-modal-footer {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 24px;
        }

        .immersive-translate-btn {
            width: fit-content;
            color: #fff;
            background-color: #ea4c89;
            border: none;
            font-size: 16px;
            margin: 0 8px;
            padding: 9px 30px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .immersive-translate-btn:hover {
            background-color: #f082ac;
        }

        .immersive-translate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .immersive-translate-btn:disabled:hover {
            background-color: #ea4c89;
        }

        .immersive-translate-cancel-btn {
            /* gray color */
            background-color: rgb(89, 107, 120);
        }

        .immersive-translate-cancel-btn:hover {
            background-color: hsl(205, 20%, 32%);
        }

        .immersive-translate-action-btn {
            background-color: transparent;
            color: #ea4c89;
            border: 1px solid #ea4c89;
        }

        .immersive-translate-btn svg {
            margin-right: 5px;
        }

        .immersive-translate-link {
            cursor: pointer;
            user-select: none;
            -webkit-user-drag: none;
            text-decoration: none;
            color: #007bff;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
        }

        .immersive-translate-primary-link {
            cursor: pointer;
            user-select: none;
            -webkit-user-drag: none;
            text-decoration: none;
            color: #ea4c89;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
        }

        .immersive-translate-modal input[type="radio"] {
            margin: 0 6px;
            cursor: pointer;
        }

        .immersive-translate-modal label {
            cursor: pointer;
        }

        .immersive-translate-close-action {
            position: absolute;
            top: 2px;
            right: 0px;
            cursor: pointer;
        }

        .imt-image-status {
            background-color: rgba(0, 0, 0, 0.5) !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 16px !important;
        }

        .imt-image-status img,
        .imt-image-status svg,
        .imt-img-loading {
            width: 28px !important;
            height: 28px !important;
            margin: 0 0 8px 0 !important;
            min-height: 28px !important;
            min-width: 28px !important;
            position: relative !important;
        }

        .imt-img-loading {
            background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADgAAAA4CAMAAACfWMssAAAAtFBMVEUAAAD////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////oK74hAAAAPHRSTlMABBMIDyQXHwyBfFdDMSw+OjXCb+5RG51IvV/k0rOqlGRM6KKMhdvNyZBz9MaupmxpWyj437iYd/yJVNZeuUC7AAACt0lEQVRIx53T2XKiUBCA4QYOiyCbiAsuuGBcYtxiYtT3f6/pbqoYHVFO5r+iivpo6DpAWYpqeoFfr9f90DsYAuRSWkFnPO50OgR9PwiCUFcl2GEcx+N/YBh6pvKaefHlUgZd1zVe0NbYcQjGBfzrPE8Xz8aF+71D8gG6DHFPpc4a7xFiCDuhaWgKgGIJQ3d5IMGDrpS4S5KgpIm+en9f6PlAhKby4JwEIxlYJV9h5k5nee9GoxHJ2IDSNB0dwdad1NAxDJ/uXDHYmebdk4PdbkS58CIVHdYSUHTYYRWOJblWSyu2lmy3KNFVJNBhxcuGW4YBVCbYGRZwIooipHsNqjM4FbgOQqQqSKQQU9V8xmi1QlgHqQQ6DDBvRUVCDirs+EzGDGOQTCATgtYTnbCVLgsVgRE0T1QE0qHCFAht2z6dLvJQs3Lo2FQoDxWNUiBhaP4eRgwNkI+dAjVOA/kUrIDwf3CG8NfNOE0eiFotSuo+rBiq8tD9oY4Qzc6YJw99hl1wzpQvD7ef2M8QgnOGJfJw+EltQc+oX2yn907QB22WZcvlUpd143dqQu+8pCJZuGE4xCuPXJqqcs5sNpsI93Rmzym1k4Npk+oD1SH3/a3LOK/JpUBpWfqNySxWzCfNCUITuDG5dtuphrUJ1myeIE9bIsPiKrfqTai5WZxbhtNphYx6GEIHihyGFTI69lje/rxajdh0s0msZ0zYxyPLhYCb1CyHm9Qsd2H37Y3lugVwL9kNh8Ot8cha6fUNQ8nuXi5z9/ExsAO4zQrb/ev1yrCB7lGyQzgYDGuxq1toDN/JGvN+HyWNHKB7zEoK+PX11e12G431erGYzwmytAWU56fkMHY5JJnDRR2eZji3AwtIcrEV8Cojat/BdQ7XOwGV1e1hDjGGjXbdArm8uJZtCH5MbcctVX8A1WpqumJHwckAAAAASUVORK5CYII=");
            background-size: 28px 28px;
            animation: image-loading-rotate 1s linear infinite !important;
        }

        .imt-image-status span {
            color: var(--bg-2, #fff) !important;
            font-size: 14px !important;
            line-height: 14px !important;
            font-weight: 500 !important;
            font-family: "PingFang SC", Arial, sans-serif !important;
        }

        @keyframes image-loading-rotate {
            from {
                transform: rotate(360deg);
            }

            to {
                transform: rotate(0deg);
            }
        }
    </style>
    <style data-id="immersive-translate-default-injected-css">
        :root {
            --immersive-translate-theme-underline-borderColor: #72ece9;
            --immersive-translate-theme-nativeUnderline-borderColor: #72ece9;
            --immersive-translate-theme-nativeDashed-borderColor: #72ece9;
            --immersive-translate-theme-nativeDotted-borderColor: #72ece9;
            --immersive-translate-theme-highlight-backgroundColor: #ffff00;
            --immersive-translate-theme-dashed-borderColor: #59c1bd;
            --immersive-translate-theme-blockquote-borderColor: #cc3355;
            --immersive-translate-theme-thinDashed-borderColor: #ff374f;
            --immersive-translate-theme-dashedBorder-borderColor: #94a3b8;
            --immersive-translate-theme-dashedBorder-borderRadius: 0;
            --immersive-translate-theme-solidBorder-borderColor: #94a3b8;
            --immersive-translate-theme-solidBorder-borderRadius: 0;
            --immersive-translate-theme-dotted-borderColor: #94a3b8;
            --immersive-translate-theme-wavy-borderColor: #72ece9;
            --immersive-translate-theme-dividingLine-borderColor: #94a3b8;
            --immersive-translate-theme-grey-textColor: #2f4f4f;
            --immersive-translate-theme-marker-backgroundColor: #fbda41;
            --immersive-translate-theme-marker-backgroundColor-rgb: 251, 218, 65;
            --immersive-translate-theme-marker2-backgroundColor: #ffff00;
            --immersive-translate-theme-background-backgroundColor: #dbafaf;
            --immersive-translate-theme-background-backgroundColor-rgb: 219, 175, 175;
            --immersive-translate-theme-background-backgroundOpacity: 12;
            --immersive-translate-theme-opacity-opacity: 10;
        }

        [imt-state="dual"] .immersive-translate-target-translation-pre-whitespace {
            white-space: pre-wrap !important;
        }

        [imt-state="dual"] .immersive-translate-pdf-target-container {
            position: absolute;
            background-color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica,
                sans-serif;
            top: 0;
            width: 600px;
            height: 100%;
            z-index: 2;
            line-height: 1.3;
            font-size: 16px;
        }

        [imt-state="dual"] .immersive-translate-target-wrapper[dir="rtl"] {
            text-align: right;
        }

        [imt-state="dual"] .immersive-translate-pdf-target-container .immersive-translate-target-wrapper {
            color: rgb(0, 0, 0);
            white-space: normal;
            position: absolute;
        }

        [imt-state="dual"] .immersive-translate-pdf-target-container .immersive-translate-target-wrapper font {
            color: inherit;
            white-space: inherit;
            position: unset;
        }

        [imt-state="translation"] .immersive-translate-target-wrapper &gt;

        br {
            display: none;
        }

        [imt-state="translation"] .immersive-translate-target-translation-block-wrapper {
            margin: 0 !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper {
            margin: 8px 0 !important;
            display: inline-block;
        }

        [imt-trans-position="before"] .immersive-translate-target-translation-block-wrapper {
            display: block;
        }

        [imt-trans-position="before"] .immersive-translate-target-translation-block-wrapper {
            margin-top: 0 !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-pdf-block-wrapper {
            margin: 0 !important;
            display: inline-block;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-grey-inner {
            color: var(--immersive-translate-theme-grey-textColor);
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-underline-inner {
            border-bottom: 1px solid var(--immersive-translate-theme-underline-borderColor) !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-nativeUnderline-inner {
            text-decoration: underline !important;
            text-decoration-color: var(--immersive-translate-theme-nativeUnderline-borderColor) !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper-theme-dashedBorder {
            border: 1px dashed var(--immersive-translate-theme-dashedBorder-borderColor) !important;
            border-radius: var(--immersive-translate-theme-dashedBorder-borderRadius) !important;
            padding: 6px;
            margin-top: 2px;
            display: inline-block;
        }

        [imt-state="dual"] .immersive-translate-target-translation-inline-wrapper-theme-dashedBorder {
            border: 1px dashed var(--immersive-translate-theme-dashedBorder-borderColor) !important;
            border-radius: var(--immersive-translate-theme-dashedBorder-borderRadius) !important;
            padding: 2px;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper-theme-solidBorder {
            border: 1px solid var(--immersive-translate-theme-solidBorder-borderColor) !important;
            border-radius: var(--immersive-translate-theme-solidBorder-borderRadius) !important;
            padding: 6px;
            margin-top: 2px;
            display: inline-block;
        }

        [imt-state="dual"] .immersive-translate-target-translation-inline-wrapper-theme-solidBorder {
            border: 1px solid var(--immersive-translate-theme-solidBorder-borderColor) !important;
            border-radius: var(--immersive-translate-theme-solidBorder-borderRadius) !important;
            padding: 2px;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-nativeDashed-inner {
            text-decoration: underline !important;
            text-decoration-color: var(--immersive-translate-theme-nativeDashed-borderColor) !important;
            text-decoration-style: dashed !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-thinDashed-inner {
            border-bottom: 1px dashed var(--immersive-translate-theme-thinDashed-borderColor) !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-dotted-inner {
            background-image: linear-gradient(to right,
                    var(--immersive-translate-theme-dotted-borderColor) 30%,
                    rgba(255, 255, 255, 0) 0%);
            background-position: bottom;
            background-size: 5px 1px;
            background-repeat: repeat-x;
            padding-bottom: 3px;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-nativeDotted-inner {
            text-decoration: underline !important;
            text-decoration-color: var(--immersive-translate-theme-nativeDotted-borderColor) !important;
            text-decoration-style: dotted !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-wavy-inner {
            text-decoration: underline !important;
            text-decoration-color: var(--immersive-translate-theme-wavy-borderColor) !important;
            text-decoration-style: wavy !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-dashed-inner {
            background: linear-gradient(to right,
                    var(--immersive-translate-theme-dashed-borderColor) 0%,
                    var(--immersive-translate-theme-dashed-borderColor) 50%,
                    transparent 50%,
                    transparent 100%) repeat-x left bottom;
            background-size: 8px 2px;
            padding-bottom: 2px;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper-theme-dividingLine::before {
            content: "";
            display: block;
            max-width: 80px;
            width: 10%;
            border-top: 1px dashed var(--immersive-translate-theme-dividingLine-borderColor);
            padding-top: 8px;
        }

        [imt-state="dual"] .immersive-translate-target-translation-inline-wrapper-theme-dividingLine::before {
            content: "";
            border-left: 1px dashed var(--immersive-translate-theme-dividingLine-borderColor);
            max-height: 16px;
            height: 16px;
            padding-left: 8px;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-highlight-inner {
            background: var(--immersive-translate-theme-highlight-backgroundColor);
            box-decoration-break: clone;
            -webkit-box-decoration-break: clone;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper-theme-marker {
            line-height: 1.5em;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-marker2-inner {
            font-weight: bold;
            text-shadow: 10px 0px 3px var(--immersive-translate-theme-marker2-backgroundColor),
                16px 3px 9px var(--immersive-translate-theme-marker2-backgroundColor),
                2px 0px 6px var(--immersive-translate-theme-marker2-backgroundColor),
                -12px 0px 12px var(--immersive-translate-theme-marker2-backgroundColor) !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-marker-inner {
            /* TODO: add more texture */
            background: linear-gradient(to right,
                    rgba(var(--immersive-translate-theme-marker-backgroundColor-rgb), 0.1),
                    rgba(var(--immersive-translate-theme-marker-backgroundColor-rgb), 0.9) 3%,
                    rgba(var(--immersive-translate-theme-marker-backgroundColor-rgb), 0.9) 35%,
                    rgba(var(--immersive-translate-theme-marker-backgroundColor-rgb), 0.9) 70%,
                    rgba(var(--immersive-translate-theme-marker-backgroundColor-rgb), 0.8) 95%,
                    rgba(var(--immersive-translate-theme-marker-backgroundColor-rgb), 0.3));
            box-decoration-break: clone;
            -webkit-box-decoration-break: clone;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-weakening {
            opacity: 0.618 !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-italic {
            font-style: italic !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-bold {
            font-weight: bold !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper-theme-paper {
            margin: 8px 0;
            box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
            padding: 16px 32px;
            display: inline-block;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper-theme-blockquote {
            border-left: 4px solid var(--immersive-translate-theme-blockquote-borderColor) !important;
            padding-left: 12px !important;
            margin-top: 4px;
            margin-bottom: 4px;
            padding-top: 4px;
            padding-bottom: 4px;
            display: inline-block;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-mask-inner {
            filter: blur(5px) !important;
            transition: filter 0.3s ease !important;
            border-radius: 10px;
            display: inline-block;
        }

        [data-immersive-translate-root-translation-theme="none"] .immersive-translate-target-translation-theme-mask-inner {
            filter: none !important;
        }

        [data-immersive-translate-root-translation-theme="mask"] .immersive-translate-target-inner {
            filter: blur(5px) !important;
            transition: filter 0.3s ease !important;
            border-radius: 10px;
            display: inline-block;
        }

        /* opacity theme start */

        [imt-state="dual"] .immersive-translate-target-translation-theme-opacity-inner {
            filter: opacity(calc(var(--immersive-translate-theme-opacity-opacity) * 1%)) !important;
            transition: filter 0.3s ease !important;
            border-radius: 10px;
            display: inline-block;
        }

        [data-immersive-translate-root-translation-theme="none"] .immersive-translate-target-translation-theme-opacity-inner {
            filter: none !important;
        }

        [data-immersive-translate-root-translation-theme="opacity"] .immersive-translate-target-inner,
        [imt-state="dual"] .immersive-translate-target-translation-theme-opacity-inner:hover {
            filter: opacity(calc(var(--immersive-translate-theme-opacity-opacity) * 1%)) !important;
            transition: filter 0.3s ease !important;
            border-radius: 10px;
            display: inline-block;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-opacity-inner:hover {
            filter: none !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-mask-inner:hover {
            filter: none !important;
        }

        [data-immersive-translate-root-translation-theme="opacity"] .immersive-translate-target-inner:hover {
            filter: none !important;
        }

        [data-immersive-translate-root-translation-theme="mask"] .immersive-translate-target-inner:hover {
            filter: none !important;
        }

        /* opacity theme end */

        /* background theme start */
        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper-theme-background {
            margin: 8px 0;
            background: rgba(var(--immersive-translate-theme-background-backgroundColor-rgb),
                    calc(var(--immersive-translate-theme-background-backgroundOpacity) * 1%));
            border-radius: 4px;
            box-shadow: unset !important;
            padding: 12px;
            display: inline-block;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-background-inner {
            background: rgba(var(--immersive-translate-theme-background-backgroundColor-rgb),
                    calc(var(--immersive-translate-theme-background-backgroundOpacity) * 1%));
            padding-left: 6px;
            padding-right: 6px;
            box-decoration-break: clone;
            -webkit-box-decoration-break: clone;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper .immersive-translate-target-translation-theme-background-inner {
            background: unset;
            padding-left: unset;
            padding-right: unset;
        }

        /* background theme end */

        /* vertical css , please remain it in the last one. */
        .immersive-translate-target-translation-vertical-block-wrapper {
            margin: 0px 8px !important;
        }

        .immersive-translate-text {
            font-size: 15px !important;
        }

        .immersive-translate-error-toast {
            position: fixed;
            top: 5%;
            z-index: 99999999;
            left: 0;
            right: 0;
            margin: auto;
            max-width: 300px;
            padding: 16px;
            border-radius: 12px;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: row;
            justify-content: space-between;
        }

        @media all and (min-width: 750px) {
            .immersive-translate-error-toast {
                max-width: 400px;
            }
        }

        .immersive-translate-clickable-button {
            cursor: pointer;
        }

        .immersive-translate-help-button {
            cursor: pointer;
        }

        .immersive-translate-loading-text:before {
            content: "...";
        }

        /* dark mode for loading */

        @media only screen and (prefers-color-scheme: dark) {
            .immersive-translate-loading {
                border: 2px rgba(255, 255, 255, 0.25) solid !important;
                border-top: 2px rgba(255, 255, 255, 1) solid !important;
            }
        }

        .immersive-translate-error-wrapper {
            position: relative;
            display: inline-flex;
            padding: 6px;
            margin: 0 12px;
            white-space: nowrap;
            font-size: 0.9em;
        }

        [lang="zh-CN"] .immersive-translate-error-wrapper {
            font-size: 0.75em;
        }

        [lang="zh-TW"] .immersive-translate-error-wrapper {
            font-size: 0.75em;
        }

        .immersive-translate-tooltip {
            position: relative;
            display: inline-flex;
            /* little indicater to indicate it's hoverable */
        }

        .immersive-translate-tooltip-content {
            /* here's the magic */
            position: absolute;
            z-index: 100000000000;

            left: 50%;
            bottom: 0;
            transform: translate(-50%, 110%);
            line-height: 1;
            /* and add a small left margin */

            /* basic styles */
            width: max-content;
            max-width: 250px;
            word-wrap: break-word;
            white-space: pre-line;
            padding: 10px;
            border-radius: 10px;
            background: #000c;
            color: #fff;
            text-align: center;
            font-size: 14px;
            display: none;
            /* hide by default */
        }

        .immersive-translate-tooltip:hover .immersive-translate-tooltip-content {
            display: inline-block;
        }

        .immersive-translate-tooltip:hover+.immersive-translate-tooltip-content {
            display: inline-block;
        }

        .immersive-translate-tooltip-content-table {
            left: unset !important;
            bottom: unset !important;
            transform: translate(-10%, 50%) !important;
        }

        .immersive-translate-tooltip:hover:before {
            display: inline-block;
        }

        .immersive-translate-loading-spinner {
            vertical-align: middle !important;
            width: 10px !important;
            height: 10px !important;
            display: inline-block !important;
            margin: 0 4px !important;
            border: 2px rgba(221, 244, 255, 0.6) solid !important;
            border-top: 2px rgba(0, 0, 0, 0.375) solid !important;
            border-left: 2px rgba(0, 0, 0, 0.375) solid !important;
            border-radius: 50% !important;
            padding: 0 !important;
            -webkit-animation: immersive-translate-loading-animation 0.6s infinite linear !important;
            animation: immersive-translate-loading-animation 0.6s infinite linear !important;
        }

        @-webkit-keyframes immersive-translate-loading-animation {
            from {
                -webkit-transform: rotate(0deg);
            }

            to {
                -webkit-transform: rotate(359deg);
            }
        }

        @keyframes immersive-translate-loading-animation {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(359deg);
            }
        }

        .imt-image-status {
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--bg-2, #fff);
            font-size: 14px;
        }
    </style>
    <style data-id="immersive-translate-user-custom-style">
        :root {

            .immersive-translate-target-inner {
                font-family: inherit;
            }


            .immersive-translate-target-inner {
                font-family: inherit;
            }
        }
    </style>
    <style data-id="immersive-translate-dynamic-injected-css">
        .immersive-translate-target-wrapper[dir='rtl'] {
            text-align: right;
        }

        .immersive-translate-target-wrapper[dir='rtl'] [data-immersive-translate-class-bak*='block-wrapper'] {
            display: block;
        }

        .immersive-translate-target-wrapper {
            word-break: break-word;
            user-select: text;
        }

        [imt-state="translation"] .immersive-translate-target-wrapper[dir='rtl'] {
            display: inline-block;
        }

        [dir='rtl'] .immersive-translate-target-wrapper:not([dir]) {
            text-align: left;
        }

        [imt-state=dual] .immersive-translate-target-translation-block-wrapper-theme-dividingLine::before {
            display: block;
        }

        [imt-trans-position=before] .immersive-translate-target-translation-block-wrapper {
            display: block !important;
        }

        [imt-state][data-immersive-translate_rtl] .immersive-translate-target-wrapper {
            display: block !important;
        }
    </style>
</head>

<body epub:type="bodymatter" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
    <section aria-labelledby="c13_1" epub:type="chapter" role="doc-chapter"
        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
        <header data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
            <h1 id="c13_1" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1"><span aria-label="335" epub:type="pagebreak" id="Page_335"
                    role="doc-pagebreak"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span><span id="c13"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span><span
                    class="chapterNumber"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">13</span><br /><span
                    class="chapterTitle" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Managed
                    and Unmanaged Memory</span>
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">13 管理内存和未管理内存</font>
                    </font>
                </font>
            </h1>
        </header>
        <section aria-label="chapter opening" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
            <span id="c13-sec-0001" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
            <aside data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                <div class="top hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <hr />
                </div>
                <section class="feature3" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <h3 data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1">WHAT'S IN THIS CHAPTER?<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">本章包含什么内容？</font>
                            </font>
                        </font>
                    </h3>
                    <ul class="check2" id="c13-list-0001"
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <li id="c13-li-0001" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                            data-immersive-translate-paragraph="1">Allocating space on the stack and heap at runtime
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">在运行时在栈和堆上分配空间</font>
                                </font>
                            </font>
                        </li>
                        <li id="c13-li-0002" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                            data-immersive-translate-paragraph="1">Garbage collection<font
                                class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                <font class="notranslate" data-immersive-translate-translation-element-mark="1">  
                                </font>
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">垃圾回收</font>
                                </font>
                            </font>
                        </li>
                        <li id="c13-li-0003" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                            data-immersive-translate-paragraph="1">Releasing unmanaged resources using destructors and
                            the <code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">System.IDisposable</code>
                            interface<font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">使用析构函数和 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">System.IDisposable</code>
                                        接口释放非托管资源</font>
                                </font>
                            </font>
                        </li>
                        <li id="c13-li-0004" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                            data-immersive-translate-paragraph="1">Understanding the syntax for using pointers in C#
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">理解在 C#中使用指针的语法</font>
                                </font>
                            </font>
                        </li>
                        <li id="c13-li-0005" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                            data-immersive-translate-paragraph="1">Using the <code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code> type
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                <font class="notranslate" data-immersive-translate-translation-element-mark="1">  
                                </font>
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">使用 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code>
                                        类型</font>
                                </font>
                            </font>
                        </li>
                        <li id="c13-li-0006" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                            data-immersive-translate-paragraph="1">Using Platform Invoke to access native APIs on
                            Windows and Linux<font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">使用平台调用（PInvoke）在 Windows 和
                                        Linux 上访问原生 API</font>
                                </font>
                            </font>
                        </li>
                    </ul>
                    <div class="bottom hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <hr />
                    </div>
                </section>
            </aside>
            <aside data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                <div class="top hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <hr />
                </div>
                <section class="feature3" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span
                        id="c13-fea-0001" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                    <h3 id="head-2-112" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1">CODE DOWNLOADS FOR THIS CHAPTER<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">本章代码下载</font>
                            </font>
                        </font>
                    </h3>
                    <section data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span
                            id="c13-sec-0002"
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                        <p id="c13-para-0003" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                            data-immersive-translate-paragraph="1">The source code for this chapter is available on the
                            book page at <code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><a href="http://www.wiley.com">www.wiley.com</a></code>.
                            Click the Downloads link. The code can also be found at <code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><a href="https://github.com/ProfessionalCSharp/ProfessionalCSharp2021">https://github.com/ProfessionalCSharp/ProfessionalCSharp2021</a></code>
                            in the directory <code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">1_CS/Memory</code>.
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">本章的源代码可在书籍页面 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><a href="http://www.wiley.com">www.wiley.com</a></code>
                                        上找到。点击下载链接。代码也可以在目录 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">1_CS/Memory</code>
                                        中的 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><a href="https://github.com/ProfessionalCSharp/ProfessionalCSharp2021">https://github.com/ProfessionalCSharp/ProfessionalCSharp2021</a></code>
                                        找到。</font>
                                </font>
                            </font>
                        </p>
                        <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                            data-immersive-translate-paragraph="1">The code for this chapter is divided into the
                            following major examples:<font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">本章的代码分为以下主要示例：</font>
                                </font>
                            </font>
                        </p>
                        <ul class="check" id="c13-list-0002"
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                            <li id="c13-li-0007" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                                data-immersive-translate-paragraph="1">PointerPlayground</li>
                            <li id="c13-li-0008" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                                data-immersive-translate-paragraph="1">PointerPlayground2</li>
                            <li id="c13-li-0009" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                                data-immersive-translate-paragraph="1">QuickArray</li>
                            <li id="c13-li-0010" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                                data-immersive-translate-paragraph="1">SpanSample</li>
                            <li id="c13-li-0011" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                                data-immersive-translate-paragraph="1">PlatformInvokeSample</li>
                        </ul>
                        <p id="c13-para-0005" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                            data-immersive-translate-paragraph="1">All the projects have nullable reference types
                            enabled.<font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">所有项目都启用了可空引用类型。 </font>
                                </font>
                            </font>
                        </p>
                    </section>
                    <div class="bottom hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <hr />
                    </div>
                </section>
            </aside>
        </section> <span aria-label="336" epub:type="pagebreak" id="Page_336" role="doc-pagebreak"
            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
        <section aria-labelledby="head-2-113" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
            <span id="c13-sec-0003" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
            <h2 id="head-2-113" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1">MEMORY<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">内存</font>
                    </font>
                </font>
            </h2>
            <p id="c13-para-0006" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1">Variables are stored on the stack. The data they reference can be
                on the stack (structs) or on the heap (classes). Structs also can be boxed so objects on the heap are
                created. The garbage collector needs to free up unmanaged objects that are no longer needed from the
                managed heap. When you use native APIs, you can allocate memory on the native heap. The garbage
                collector is not responsible for memory allocated on the native heap. You have to free this memory on
                your own. There's a lot to consider with regard to memory.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            变量存储在栈上。它们引用的数据可以位于栈（结构体）或堆（类）上。结构体也可以被装箱，从而在堆上创建对象。垃圾回收器需要释放从托管堆中不再需要的未管理对象。当你使用原生 API
                            时，你可以在原生堆上分配内存。垃圾回收器不负责原生堆上分配的内存。你必须自行释放这些内存。关于内存有很多需要考虑的事项。</font>
                    </font>
                </font>
            </p>
            <p id="c13-para-0007" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1">When you use a managed environment, you can easily be misled into
                not paying attention to memory management because the garbage collector (GC) deals with that anyway. A
                lot of work is done by the GC; it's very practical to know how it works, what the small and large object
                heaps are, and what data types are stored within the stack. Also, while the garbage collector deals with
                managed resources, what about unmanaged ones? You have to free them on your own. Probably your programs
                are fully managed programs, but what about the types defined with the .NET runtime and class libraries?
                For example, file types (discussed in <a href="c18.xhtml"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Chapter 18</a>, “Files and
                Streams”) wrap a native file handle. This file handle needs to be released. To release this handle
                early, it's good to know the <code
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code> interface,
                the <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code> statement,
                and the <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                declaration that are explained in this chapter.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            在使用托管环境时，你很容易被误导而忽略内存管理，因为垃圾回收器（GC）会自动处理这些。垃圾回收器做了大量工作；了解它的工作原理、小对象堆和大对象堆是什么，以及栈中存储的数据类型，是非常实用的。此外，虽然垃圾回收器处理托管资源，但未托管资源呢？你必须自行释放它们。也许你的程序是完全托管的，但.NET
                            运行时和类库中定义的类型呢？例如，文件类型（在第 18 章“文件和流”中讨论）包装了一个原生文件句柄。这个文件句柄需要被释放。为了尽早释放这个句柄，了解本章中解释的 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code>
                            接口、 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code> 语句和
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                            声明是很有帮助的。</font>
                    </font>
                </font>
            </p>
            <p id="c13-para-0008" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1">Other aspects are important as well. Although several language
                constructs make it easier to create immutable types, mutable objects have an advantage as well. The
                <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">string</code> class is an
                immutable type that's been available since .NET 1.0. Nowadays, people often have to deal with large
                strings, and the GC needs to clean up a lot of objects. Directly accessing the memory of the string and
                making changes makes a mutable—and in different scenarios, a more performant—program. The <code
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code> type makes this
                possible. With arrays (<a href="c06.xhtml"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Chapter 6</a>, “Arrays”),
                you've also seen the <code
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">ArrayPool</code> class that
                also can reduce the work of the GC.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            其他方面也同样重要。尽管某些语言结构使得创建不可变类型更加容易，但可变对象也有其优势。 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">string</code>
                            类是一个自 .NET 1.0
                            起就存在的不可变类型。如今，人们常常需要处理大型字符串，而垃圾回收器需要清理大量对象。直接访问字符串的内存并进行修改，可以使程序变得可变——在不同的场景下，这也能带来更高的性能。
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code>
                            类型使得这一点成为可能。在数组（第 6 章，“数组”）中，你也见过 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">ArrayPool</code>
                            类，它也能减轻垃圾回收器的工作负担。</font>
                    </font>
                </font>
            </p>
            <p id="c13-para-0009" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1">This chapter starts with various aspects of memory management and
                memory access. A good understanding of memory management and knowledge of the pointer capabilities
                provided by C# will better enable you to integrate C# code with legacy code and perform efficient memory
                manipulation in performance-critical systems. This chapter covers ways to use the <code
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">ref</code> keyword for return
                types and local variables. This feature reduces the need for unsafe code and using pointers with C#.
                This chapter also discusses more details about using the <code
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code> type to access a
                different kind of memory, such as the managed heap, the native heap, and the stack.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">本章从内存管理和内存访问的多个方面开始。对内存管理的良好理解以及了解
                            C#提供的指针功能将更好地使你能够将 C#代码与旧代码集成，并在性能关键系统中执行高效的内存操作。本章涵盖了使用 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">ref</code>
                            关键字作为返回类型和局部变量的方法。此功能减少了使用不安全代码和 C#指针的需求。本章还详细讨论了使用 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code>
                            类型访问不同类型内存的更多细节，例如托管堆、本机堆和栈。</font>
                    </font>
                </font>
            </p>
        </section>
        <section aria-labelledby="head-2-114" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
            <span id="c13-sec-0004" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
            <h2 id="head-2-114" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1">MEMORY MANAGEMENT UNDER THE HOOD<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">底层内存管理</font>
                    </font>
                </font>
            </h2>
            <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1">One of the advantages of C# programming is that the programmer
                does not need to worry about detailed memory management; the garbage collector deals with the problem of
                memory cleanup on your behalf. As a result, you get something that approximates the efficiency of
                languages such as C++ without the complexity of having to handle memory management yourself as you do in
                C++. However, although you do not have to manage memory manually, it still pays to understand what is
                going on behind the scenes. Understanding how your program manages memory under the covers will help you
                increase the speed and performance of your applications. This section looks at what happens in the
                computer's memory when you allocate variables.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            C#编程的一个优势是程序员无需担心详细的内存管理；垃圾收集器会为你处理内存清理的问题。因此，你能够获得类似于 C++等语言的效率，同时又无需像在
                            C++中那样处理内存管理的复杂性。然而，尽管你不必手动管理内存，但了解背后的机制仍然是有益的。了解你的程序如何管理内存将有助于提高应用程序的速度和性能。本节将探讨当你分配变量时，计算机内存中会发生什么。
                        </font>
                    </font>
                </font>
            </p>
            <aside data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                <div class="top hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <hr />
                </div>
                <section class="feature2" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <p id="c13-para-0011" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1"><b
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">NOTE</b> <i
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">The precise details
                            of many of the topics of this section are not presented here. This section serves as an
                            abbreviated guide to the general processes rather than a statement of exact
                            implementation.</i>
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">注意
                                    本节中许多主题的精确细节并未在此呈现。本节作为一般过程的简要指南，而非精确实现的陈述。</font>
                            </font>
                        </font>
                    </p>
                    <div class="bottom hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <hr />
                    </div>
                </section>
            </aside>
            <section data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span id="c13-sec-0006"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                <h3 id="head-3-246" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Value Data Types <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">值数据类型</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Windows uses a system known as <i
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">virtual addressing</i> in
                    which the mapping from the memory address seen by your program to the actual location in hardware
                    memory is entirely managed by Windows. As a result, each process of a 32-bit application sees 4GB of
                    available memory, regardless of how much hardware memory you actually have in your computer (with
                    64-bit applications on 64-bit processors this number is greater). This memory contains everything
                    that is part of the program, including the executable code, any DLLs loaded by the code, and <span
                        aria-label="337" epub:type="pagebreak" id="Page_337" role="doc-pagebreak"
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>the contents of
                    all variables used when the program runs. This 4GB of memory is known as the <i
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">virtual address</i> space
                    or <i data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">virtual memory</i>. For
                    convenience, this chapter uses the shorthand <i
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">memory</i>.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">Windows
                                使用一种称为虚拟寻址的系统，其中从程序看到的内存地址到硬件内存实际位置的映射完全由 Windows 管理。因此，32 位应用程序的每个进程都看到 4GB
                                的可用内存，无论您的计算机实际有多少硬件内存（在 64 位处理器上运行的 64 位应用程序这个数字更大）。这内存包含程序的所有部分，包括可执行代码、代码加载的任何 DLL
                                以及程序运行时使用的所有变量的内容。这 4GB 的内存被称为虚拟地址空间或虚拟内存。为方便起见，本章使用简称 memory。</font>
                        </font>
                    </font>
                </p>
                <aside data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <div class="top hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <p id="c13-para-0013" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">NOTE</b> <i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">.NET applications
                                are built as portable applications by default. A portable application runs on both 32-
                                and 64-bit environments on Windows and on Linux as long as the .NET runtime is installed
                                on the system. Not all APIs are available on all platforms, especially if you use native
                                APIs. For this, you can specify platforms with your .NET application as explained in <a
                                    href="c01.xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Chapter
                                    1</a>, “.NET Applications and Tools.”</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意 .NET
                                        应用程序默认构建为便携式应用程序。便携式应用程序在 Windows 和 Linux 上运行，只要系统上安装了.NET 运行时。并非所有 API
                                        在所有平台上都可用，特别是如果您使用原生 API。为此，您可以根据第 1 章“ .NET 应用程序和工具”中解释的方式指定您的.NET 应用程序的平台。
                                    </font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                            <hr />
                        </div>
                    </section>
                </aside>
                <p id="c13-para-0014" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Each memory location in the available 4GB is numbered
                    starting from zero. To access a value stored at a particular location in memory, you need to supply
                    the number that represents that memory location. In any compiled high-level language, the compiler
                    converts human-readable variable names into memory addresses that the processor understands.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">可用 4GB
                                内存中的每个存储位置从零开始编号。要访问内存中特定位置的值，你需要提供代表该内存位置的编号。在任何编译型高级语言中，编译器将人类可读的变量名转换为处理器理解的内存地址。
                            </font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Somewhere inside a processor's virtual memory is an area
                    known as the <i data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">stack</i>.
                    The stack stores value data types that are not members of objects. In addition, when you call a
                    method, the stack is used to hold a copy of any parameters passed to the method. To understand how
                    the stack works, you need to understand the importance of variable scope in C#. If variable <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">a</code> goes into scope
                    before variable <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">b</code>, then <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">b</code> always goes out
                    of scope first. Consider the following code:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                处理器虚拟内存的某个位置有一个被称为堆栈的区域。堆栈存储非对象成员的值数据类型。此外，当你调用方法时，堆栈用于保存传递给方法的任何参数的副本。要理解堆栈的工作原理，你需要了解
                                C#中变量作用域的重要性。如果变量 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">a</code> 在变量
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">b</code>
                                之前进入作用域，那么 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">b</code>
                                总是最先离开作用域。考虑以下代码：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0001"><code>{</code>
<code>  int a;</code>
<code>  // do something</code>
<code>  {</code>
<code>    int b;</code>
<code>    // do something else</code>
<code>  }</code>
<code>}</code></pre>
                <p id="c13-para-0016" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">First, the variable <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">a</code> is declared.
                    Then, inside the inner code block, <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">b</code> is declared.
                    Then the inner code block terminates, and <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">b</code> goes out of
                    scope; then <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">a</code>
                    goes out of scope. Therefore, the lifetime of <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">b</code> is entirely
                    contained within the lifetime of <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">a</code>. The idea that
                    you always deallocate variables in the reverse order of how you allocate them is crucial to the way
                    the stack works.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">首先声明变量 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">a</code>
                                。然后，在内部代码块中声明 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">b</code>
                                。接着内部代码块结束， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">b</code>
                                超出作用域；然后 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">a</code>
                                超出作用域。因此， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">b</code>
                                的生命周期完全包含在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">a</code>
                                的生命周期内。你总是以与分配变量的相反顺序释放变量的概念，是栈工作方式的关键。</font>
                        </font>
                    </font>
                </p>
                <p id="c13-para-0017" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Note that <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">b</code> is in a
                    different block from code (defined by a different nesting of curly braces). For this reason, it is
                    contained within a different scope. This is called <i
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">block scope</i> or <i
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">structure scope</i>.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">请注意， <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">b</code>
                                位于与代码（由不同嵌套的大括号定义）不同的代码块中。因此，它位于不同的作用域内。这被称为块作用域或结构作用域。</font>
                        </font>
                    </font>
                </p>
                <p id="c13-para-0018" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">You do not know exactly where in the address space the stack
                    is—you don't need to know for C# development. A <i
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">stack pointer</i> (a
                    variable maintained by the operating system) identifies the next free location on the stack. When
                    your program first starts running, the stack pointer points to just past the end of the block of
                    memory that is reserved for the stack. The stack fills downward, from high memory addresses to low
                    addresses. As data is put on the stack, the stack pointer is adjusted accordingly, so it always
                    points to just past the next free location. This is illustrated in <a href="#c13-fig-0001"
                        id="R_c13-fig-0001"
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Figure 13-1</a>, which
                    shows a stack pointer with a value of <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">800000</code> (<code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">0xC3500</code> in hex);
                    the next free location is the address <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">799999</code>.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">你不知道堆栈在地址空间中的确切位置——对于
                                C#开发来说，你不需要知道这一点。堆栈指针（由操作系统维护的一个变量）标识了堆栈上的下一个空闲位置。当你的程序开始运行时，堆栈指针指向为堆栈保留的内存块的末尾之后。堆栈向下填充，从高内存地址到低地址。当数据被放入堆栈时，堆栈指针会相应调整，因此它始终指向下一个空闲位置之后。这如图
                                13-1 所示，图中显示了一个值为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">800000</code>
                                （十六进制的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">0xC3500</code>
                                ）的堆栈指针；下一个空闲位置是地址 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">799999</code>
                                。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">The following code tells the compiler that you need space in
                    memory to store an integer and a double, and these memory locations are referred to as <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">nRacingCars</code> and
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">engineSize</code>. The
                    line that declares each variable indicates the point at which you start requiring access to this
                    variable. The closing curly brace of the block in which the variables are declared identifies the
                    point at which both variables go out of scope:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                以下代码告诉编译器，你需要在内存中为存储一个整数和一个双精度浮点数分配空间，这些内存位置被称为 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">nRacingCars</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">engineSize</code>
                                。声明每个变量的那一行指示了你开始需要访问该变量的位置。声明变量的代码块的闭花括号标识了两个变量都超出作用域的位置：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0002"><code>{</code>
<code>  int nRacingCars = 10;</code>
<code>  double engineSize = 3000.0;</code>
<code>  // do calculations;</code>
<code>}</code></pre>
                <figure data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> <img
                        alt="Schematic illustration of value data types access." class="center"
                        src="images/c13f001.png" />
                    <figcaption data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span
                                class="figureLabel"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><a
                                    href="#R_c13-fig-0001" id="c13-fig-0001" role="doc-backlink"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><b
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                                        data-immersive-translate-paragraph="1">FIGURE 13-1<font
                                            class="notranslate immersive-translate-target-wrapper"
                                            data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                            <font class="notranslate"
                                                data-immersive-translate-translation-element-mark="1">  </font>
                                            <font
                                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                                data-immersive-translate-translation-element-mark="1">
                                                <font
                                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                                    data-immersive-translate-translation-element-mark="1">图 13-1</font>
                                            </font>
                                        </font></b></a></span></p>
                    </figcaption>
                </figure>

                <p id="c13-para-0020" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1"><span aria-label="338" epub:type="pagebreak" id="Page_338"
                        role="doc-pagebreak"
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>Assuming that you
                    use the stack shown in <a href="#c13-fig-0001"
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Figure 13-1</a>, when the
                    variable <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">nRacingCars</code> comes
                    into scope and is assigned the value <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">10</code>, this value
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></code> is placed in
                    locations <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">799996</code>
                    through <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">799999</code>
                    —the 4 bytes just below the location pointed to by the stack pointer (4 bytes because that's how
                    much memory is needed to store an <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code>). To
                    accommodate this, 4 is subtracted from the value of the stack pointer, so it now points to the
                    location <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">799996</code>,
                    just after the new first free location (<code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">799995</code>).<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">假设你使用图 13-1 所示的栈，当变量 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">nRacingCars</code>
                                进入作用域并被赋值为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">10</code>
                                时，这个值 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></code>
                                被放置在位置 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">799996</code>
                                到 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">799999</code>
                                ——即栈指针所指向位置下方紧邻的 4 个字节（因为存储一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code> 需要
                                4 个字节）。为了适应这一点，栈指针的值减去 4，因此它现在指向新第一个空闲位置（ <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">799996</code>
                                ）之后的位置（ <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">799995</code>
                                ）。</font>
                        </font>
                    </font>
                </p>
                <p id="c13-para-0021" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">The next line of code declares the variable <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">engineSize</code> (a
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">double</code>) and
                    initializes it to the value <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">3000.0</code>. A <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">double</code> occupies 8
                    bytes, so the value <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">3000.0</code> is placed
                    in locations <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">799988</code> through
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">799995</code> on the
                    stack, and the stack pointer is decremented by 8 so that it again points to the location just after
                    the next free location on the stack.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">下一行代码声明变量 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">engineSize</code>
                                （一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">double</code>
                                ）并将其初始化为值 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">3000.0</code>
                                。一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">double</code>
                                占用 8 个字节，因此值 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">3000.0</code>
                                被放置在栈的位置 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">799988</code>
                                到 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">799995</code>
                                ，栈指针减去 8，使其再次指向栈中下一个空闲位置之后的位置。</font>
                        </font>
                    </font>
                </p>
                <p id="c13-para-0022" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">When <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">engineSize</code> goes
                    out of scope, the runtime knows that it is no longer needed. Because of the way variable lifetimes
                    are always nested, you can guarantee that whatever happened while <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">engineSize</code> was in
                    scope, the stack pointer is now pointing to the location where <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">engineSize</code> is
                    stored. To remove <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">engineSize</code> from
                    the stack, the stack pointer is incremented by 8, and it now points to the location immediately
                    after the end of <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">engineSize</code>. At
                    this point in the code, you are at the closing curly brace, so <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">nRacingCars</code> also
                    goes out of scope. The stack pointer is incremented by 4. When another variable comes into scope
                    after <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">engineSize</code>
                    and <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">nRacingCars</code>
                    have been removed from the stack, it overwrites the memory descending from location <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">799999</code>, where
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">nRacingCars</code> was
                    stored.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">当 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">engineSize</code>
                                超出作用域时，运行时知道它不再需要。由于变量生命周期的嵌套方式，你可以保证 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">engineSize</code>
                                在作用域内的任何时候，栈指针都指向 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">engineSize</code>
                                存储的位置。要从栈中移除 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">engineSize</code>
                                ，栈指针增加 8，现在指向 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">engineSize</code>
                                结束位置之后的位置。在这个代码点，你位于闭合花括号处，所以 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">nRacingCars</code>
                                也超出作用域。栈指针增加 4。当 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">engineSize</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">nRacingCars</code>
                                从栈中移除后，另一个变量进入作用域时，它会覆盖从 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">799999</code>
                                位置（ <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">nRacingCars</code>
                                存储的位置）向下延伸的内存。</font>
                        </font>
                    </font>
                </p>
                <p id="c13-para-0023" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">If the compiler hits a line such as <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int i</code>, <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">j</code>, then the order
                    of variables coming into scope looks indeterminate. Both variables are declared at the same time and
                    go out of scope at the same time. In this situation, it does not matter in what order the two
                    variables are removed from memory. The compiler internally always ensures that the one that was put
                    in memory first is removed last, thus preserving the rule that prohibits crossover of variable
                    lifetimes.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">如果编译器遇到类似 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int i</code>
                                ， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">j</code>
                                这样的行，那么进入作用域的变量顺序看起来是不确定的。两个变量同时声明并同时超出作用域。在这种情况下，两个变量从内存中移除的顺序无关紧要。编译器内部始终确保先放入内存的那个变量最后被移除，从而保持禁止变量生命周期交叉的规则。
                            </font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span id="c13-sec-0008"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                <h3 id="head-3-247" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Reference Data Types <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">引用数据类型</font>
                        </font>
                    </font>
                </h3>
                <p id="c13-para-0024" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Although the stack provides very high performance, it is not
                    flexible enough to be used for all variables. The requirement that the lifetime of a variable must
                    be nested is too restrictive for many purposes. Often, you need to use a method to allocate memory
                    for storing data and keeping that data available long after that method has exited. This possibility
                    exists whenever storage space is requested with the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">new</code> operator—as is
                    the case for all reference types. That is where the <i
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">managed heap</i> comes
                    in.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                尽管栈提供了非常高的性能，但它不够灵活，无法用于所有变量。变量生命周期必须嵌套的要求对许多用途来说过于严格。通常，你需要使用一种方法来分配内存以存储数据，并在该方法退出后长时间保持这些数据可用。只要使用
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">new</code>
                                运算符请求存储空间，这种可能性就存在——所有引用类型都是如此。这就是托管堆发挥作用的地方。</font>
                        </font>
                    </font>
                </p>
                <p id="c13-para-0025" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">If you have done any C++ coding that required low-level
                    memory management, you are familiar with the heap. The managed heap is not quite the same as the
                    native heap C++ uses, however; the managed heap works under the control of the garbage collector and
                    provides significant benefits compared to traditional heaps.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">如果你做过任何需要底层内存管理的
                                C++编程，你熟悉堆。然而，托管堆与 C++使用的原生堆并不完全相同；托管堆在垃圾回收器的控制下工作，并与传统堆相比提供了显著的优势。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">The managed heap (or heap for short) is just another area of
                    memory from the processor's available memory. The following code demonstrates how the heap works and
                    how memory is allocated for reference data types:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                托管堆（简称堆）只是处理器可用内存的另一个区域。以下代码演示了堆的工作原理以及如何为引用数据类型分配内存：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0003"><code>void DoWork()</code>
<code>{</code>
<code>  Customer? arabel;</code>
<code>  arabel = new();</code>
<code>  Customer otherCustomer2 = new EnhancedCustomer();</code>
<code>}</code></pre>
                <p id="c13-para-0027" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">This code assumes the existence of two classes, <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Customer</code> and <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">EnhancedCustomer</code>.
                    The <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">EnhancedCustomer</code>
                    class extends the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Customer</code> class.
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">这段代码假设存在两个类， <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Customer</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">EnhancedCustomer</code>
                                。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">EnhancedCustomer</code>
                                类继承自 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Customer</code>
                                类。</font>
                        </font>
                    </font>
                </p>
                <p id="c13-para-0028" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">First, you declare a <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Customer</code> reference
                    called <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">arabel</code>.
                    The space for this is allocated on the stack, but remember that this is only a reference rather than
                    an actual <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Customer</code> object.
                    The <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">arabel</code>
                    reference occupies 4 bytes, enough space to hold the address at which a <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Customer</code> object
                    will be stored. (You need 4 bytes to represent a memory address as an unsigned integer value between
                    0 and 4GB.)<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">首先，你声明一个 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Customer</code>
                                类型的引用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">arabel</code>
                                。这个引用的空间在栈上分配，但请记住这只是一个引用，而不是一个实际的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Customer</code>
                                对象。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">arabel</code>
                                类型的引用占用 4 字节，足以存放一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Customer</code>
                                对象的存储地址。（你需要 4 字节来表示一个内存地址，作为一个介于 0 和 4GB 之间的无符号整数值。）</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1"><span aria-label="339" epub:type="pagebreak" id="Page_339"
                        role="doc-pagebreak"
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>The next line,
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">下一行，</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0004"><code>arabel = new Customer();</code></pre>
                <p id="c13-para-0029" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">does several things. First, it allocates memory on the heap
                    to store a <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Customer</code> object (a
                    real object, not just an address). Then it sets the value of the variable <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">arabel</code> to the
                    address of the memory it has allocated to the new <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Customer</code> object.
                    (It also calls the appropriate <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Customer</code>
                    constructor to initialize the fields in the class instance, but you don't need to worry about that
                    here.)<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">做了几件事情。首先，它在堆上分配内存来存储一个 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Customer</code>
                                对象（一个真实的对象，而不仅仅是地址）。然后，它将变量 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">arabel</code>
                                的值设置为它为新 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Customer</code>
                                对象分配的内存地址。（它还调用了适当的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Customer</code>
                                构造函数来初始化类实例中的字段，但在这里你不需要担心这些。）</font>
                        </font>
                    </font>
                </p>
                <p id="c13-para-0031" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">The <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Customer</code> instance
                    is not placed on the stack—it is placed on the heap. In this example, you don't know precisely how
                    many bytes a <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Customer</code> object
                    occupies, but assume for the sake of argument that it is 32. These 32 bytes contain the instance
                    fields of <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Customer</code> as well
                    as some information that .NET uses to identify and manage its class instances.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Customer</code>
                                实例不会放在栈上——它被放在堆上。在这个例子中，你不知道 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Customer</code>
                                对象具体占用多少字节，但假设为了论证方便它是 32 字节。这 32 字节包含了 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Customer</code>
                                的实例字段以及 .NET 用于识别和管理其类实例的一些信息。</font>
                        </font>
                    </font>
                </p>
                <p id="c13-para-0032" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">To find a storage location on the heap for the new <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Customer</code> object,
                    the .NET runtime looks through the heap and grabs the first adjacent unused block of 32 bytes.
                    Again, for the sake of argument, assume that this happens to be at address <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">200000</code> and that
                    the <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">arabel</code>
                    reference occupied locations <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">799996</code> through
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">799999</code> on the
                    stack. This means that before instantiating the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">arabel</code> object, the
                    memory content looks like <a href="#c13-fig-0002" id="R_c13-fig-0002"
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Figure 13-2</a>.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">为了在堆上为新 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Customer</code>
                                对象找到一个存储位置，.NET 运行时会遍历堆并获取第一个相邻的未使用 32 字节块。再次为了论证方便，假设这发生在地址 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">200000</code>
                                ，并且 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">arabel</code>
                                引用占用了栈上的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">799996</code>
                                到 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">799999</code>
                                位置。这意味着在实例化 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">arabel</code>
                                对象之前，内存内容看起来像图 13-2。</font>
                        </font>
                    </font>
                </p>
                <figure data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> <img
                        alt="Schematic illustration of stack pointer pointing a value in stack and heap." class="center"
                        src="images/c13f002.png" />
                    <figcaption data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span
                                class="figureLabel"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><a
                                    href="#R_c13-fig-0002" id="c13-fig-0002" role="doc-backlink"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><b
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                                        data-immersive-translate-paragraph="1">FIGURE 13-2<font
                                            class="notranslate immersive-translate-target-wrapper"
                                            data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                            <font class="notranslate"
                                                data-immersive-translate-translation-element-mark="1">  </font>
                                            <font
                                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                                data-immersive-translate-translation-element-mark="1">
                                                <font
                                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                                    data-immersive-translate-translation-element-mark="1">图 13-2</font>
                                            </font>
                                        </font></b></a></span></p>
                    </figcaption>
                </figure>
                <p id="c13-para-0033" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">After allocating the new <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Customer</code> object,
                    the content of memory looks like <a href="#c13-fig-0003" id="R_c13-fig-0003"
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Figure 13-3</a>. Note
                    that unlike the stack, memory in the heap is allocated upward, so the free space is above the used
                    space.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在分配新的 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Customer</code>
                                对象后，内存的内容看起来如图 13-3 所示。请注意，与栈不同，堆中的内存是向上分配的，因此空闲空间位于已用空间之上。</font>
                        </font>
                    </font>
                </p> <span aria-label="340" epub:type="pagebreak" id="Page_340" role="doc-pagebreak"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                <figure data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> <img
                        alt="Schematic illustration of stack pointer pointing a value in stack and heap." class="center"
                        src="images/c13f003.png" />
                    <figcaption data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span
                                class="figureLabel"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><a
                                    href="#R_c13-fig-0003" id="c13-fig-0003" role="doc-backlink"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><b
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                                        data-immersive-translate-paragraph="1">FIGURE 13-3<font
                                            class="notranslate immersive-translate-target-wrapper"
                                            data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                            <font class="notranslate"
                                                data-immersive-translate-translation-element-mark="1">  </font>
                                            <font
                                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                                data-immersive-translate-translation-element-mark="1">
                                                <font
                                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                                    data-immersive-translate-translation-element-mark="1">图 13-3</font>
                                            </font>
                                        </font></b></a></span></p>
                    </figcaption>
                </figure>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">The next line of code both declares a <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Customer</code> reference
                    and instantiates a <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Customer</code> object.
                    In this instance, space on the stack for the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">otherCustomer2</code>
                    reference is allocated, and space for the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">otherCustomer2</code>
                    object is allocated on the heap in a single line of code:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">下一行代码既声明了一个 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Customer</code>
                                引用，又实例化了一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Customer</code>
                                对象。在这个例子中，为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">otherCustomer2</code>
                                引用在栈上分配了空间，并且为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">otherCustomer2</code>
                                对象在堆上分配了空间，这一切都在一行代码中完成：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0005"><code>Customer otherCustomer2 = new EnhancedCustomer();</code></pre>
                <p id="c13-para-0035" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">This line allocates 4 bytes on the stack to hold the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">otherCustomer2</code>
                    reference, stored at locations <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">799992</code> through
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">799995</code>. The
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">otherCustomer2</code>
                    object is allocated space on the heap starting at location <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">200032</code>.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">这行代码在栈上分配 4 个字节来存储 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">otherCustomer2</code>
                                引用，存储位置为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">799992</code>
                                到 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">799995</code>
                                。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">otherCustomer2</code>
                                对象在堆上从位置 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">200032</code>
                                开始分配空间。</font>
                        </font>
                    </font>
                </p>
                <p id="c13-para-0036" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">It is clear from the example that the process of setting up a
                    reference variable is more complex than for setting up a value variable, and there is performance
                    overhead. In fact, the process is somewhat oversimplified here because the .NET runtime needs to
                    maintain information about the state of the heap, and this information needs to be updated whenever
                    new data is added to the heap. Despite this overhead, you now have a mechanism for allocating
                    variables that is not constrained by the limitations of the stack. By assigning the value of one
                    reference variable to another of the same type, you have two variables that reference the same
                    object in memory. When a reference variable goes out of scope, it is removed from the stack as
                    described in the previous section, but the data for a referenced object is still sitting on the
                    heap. The data remains on the heap until either the program terminates or the garbage collector
                    removes it, which happens only when the data is no longer referenced by any variables and the
                    garbage collector runs.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                从示例中可以看出，设置引用变量的过程比设置值变量的过程更复杂，并且存在性能开销。实际上，这里的处理过程有所简化，因为.NET
                                运行时需要维护堆状态的信息，并且每当有新数据添加到堆中时，这些信息都需要更新。尽管存在这种开销，你现在已经拥有一种不受栈限制的变量分配机制。通过将一个引用变量的值赋给另一个同类型的引用变量，你将得到两个引用同一内存中对象的变量。当引用变量超出作用域时，它会被像前一节描述的那样从栈中移除，但被引用对象的数据仍然位于堆上。数据会一直留在堆上，直到程序终止或垃圾收集器将其移除，而垃圾收集器只有在数据不再被任何变量引用并且运行时才会执行这一操作。
                            </font>
                        </font>
                    </font>
                </p>
                <p id="c13-para-0037" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">The fact that data can remain in the heap for a long time is
                    the power of reference data types, and you will see this feature used extensively in C# code. It
                    means that you have a high degree of control over the lifetime of your data because it is guaranteed
                    to exist in the heap as long as you are maintaining some reference to it.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">数据能够在堆中长时间存在是引用数据类型的优势，你将在
                                C#代码中广泛看到这一特性的应用。这意味着你对自己的数据的生命周期有很高的控制权，因为只要你还维持着对它的某个引用，它就保证存在于堆中。</font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span id="c13-sec-0009"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                <h3 id="head-3-248" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Garbage Collection <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">垃圾回收</font>
                        </font>
                    </font>
                </h3>
                <p id="c13-para-0038" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">The previous discussion and diagrams show the managed heap
                    working very much like the stack, to the extent that successive objects are placed next to each
                    other in memory. This means you can determine where to place the next object by using a heap pointer
                    that indicates the next free memory location, which is adjusted as you add more objects to the heap.
                    However, things are complicated by the fact that the lives of the heap-based objects are not coupled
                    with the scope of the individual stack-based variables that reference them.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                之前的讨论和图表展示了托管堆与栈非常相似的工作方式，到连续的对象在内存中彼此相邻放置的程度。这意味着你可以通过使用一个指向下一个空闲内存位置的堆指针来确定下一个对象的放置位置，这个指针会随着你向堆中添加更多对象而调整。然而，基于堆的对象的生命周期与引用它们的各个基于栈的变量的作用域并不相关，这一点使得情况变得复杂。
                            </font>
                        </font>
                    </font>
                </p>
                <p id="c13-para-0039" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">When the garbage collector runs, it removes all those objects
                    from the heap that are no longer referenced. The GC finds all referenced objects from a root table
                    of references and continues to a tree of referenced objects. Immediately after, the heap has objects
                    scattered on it, which are mixed up with memory that has just been freed (see <a
                        href="#c13-fig-0004" id="R_c13-fig-0004"
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Figure 13-4</a>).<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                当垃圾收集器运行时，它会从堆中移除所有未被引用的对象。垃圾收集器从引用根表查找所有被引用的对象，并继续遍历被引用对象的树状结构。紧随其后，堆上散布着对象，它们与刚刚释放的内存混合在一起（见图
                                13-4）。</font>
                        </font>
                    </font>
                </p>
                <figure data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> <img
                        alt="Schematic illustration of garbage collection." class="center" src="images/c13f004.png" />
                    <figcaption data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span
                                class="figureLabel"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><a
                                    href="#R_c13-fig-0004" id="c13-fig-0004" role="doc-backlink"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><b
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                                        data-immersive-translate-paragraph="1">FIGURE 13-4<font
                                            class="notranslate immersive-translate-target-wrapper"
                                            data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                            <font class="notranslate"
                                                data-immersive-translate-translation-element-mark="1">  </font>
                                            <font
                                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                                data-immersive-translate-translation-element-mark="1">
                                                <font
                                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                                    data-immersive-translate-translation-element-mark="1">图 13-4</font>
                                            </font>
                                        </font></b></a></span></p>
                    </figcaption>
                </figure>
                <p id="c13-para-0040" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">If the managed heap stayed like this, allocating space for
                    new objects would be an awkward process, with the runtime having to search through the heap for a
                    block of memory big enough to store each new object. However, the garbage collector does not leave
                    the heap in this state. As soon as the garbage collector has freed all the objects it can, it
                    compacts the heap by moving all the remaining objects to form one continuous block of memory. This
                    means that the heap can continue working just like the stack, as far as locating where to store new
                    objects. Of course, when the objects are moved about, all the references to those objects need to be
                    updated with the correct new addresses, but the garbage collector handles that, too.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                如果托管堆保持这种状态，为新对象分配空间将是一个尴尬的过程，运行时需要遍历堆以找到足够大的内存块来存储每个新对象。然而，垃圾回收器不会让堆保持这种状态。一旦垃圾回收器释放了它能释放的所有对象，它就会通过将所有剩余对象移动到一起形成一块连续的内存块来压缩堆。这意味着，就定位新对象存储位置而言，堆可以像栈一样继续工作。当然，当对象被移动时，所有指向这些对象的引用都需要更新为正确的地址，但垃圾回收器也会处理这个问题。
                            </font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">This action of compacting by the garbage collector is where
                    the managed heap works very differently from unmanaged heaps. With the managed heap, it is just a
                    question of reading the value of the heap pointer rather than iterating through a linked list of
                    addresses to find somewhere to put the new data.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                垃圾回收器通过压缩来执行这一操作，这是托管堆与未托管堆工作方式非常不同之处。对于托管堆来说，只需要读取堆指针的值，而不是遍历地址链表来找到放置新数据的位置。</font>
                        </font>
                    </font><span aria-label="341" epub:type="pagebreak" id="Page_341" role="doc-pagebreak"
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span></p>
                <aside data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <div class="top hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <p id="c13-para-0042" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">NOTE</b> <i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Generally, the
                                garbage collector runs when the .NET runtime determines that garbage collection is
                                required. You can force the garbage collector to run at a certain point in your code by
                                calling </i>
                            <code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">System.GC.Collect</code>
                            <i data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">. </i>
                            <code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">System.GC</code>
                            <i data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> is a .NET class
                                that represents the garbage collector, and the </i>
                            <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Collect</code>
                            <i data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> method initiates
                                a garbage collection.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意 通常情况下，垃圾回收器会在 .NET
                                        运行时确定需要垃圾回收时运行。您可以通过调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">System.GC.Collect</code>
                                        在代码的某个特定点强制垃圾回收器运行。 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">System.GC</code>
                                        是一个代表垃圾回收器的 .NET 类，而 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Collect</code>
                                        方法会启动垃圾回收。</font>
                                </font>
                            </font>
                        </p>
                        <p id="c13-para-0043" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                            data-immersive-translate-paragraph="1"><i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Usually you
                                shouldn't invoke </i><code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">GC.Collect</code><i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> programmatically
                                because surviving objects move faster in the next generation (as described in the next
                                section). However, this method has great usage during testing when you can see memory
                                leaks where objects that should have been garbage collected are still alive. You also
                                can see other scenarios where an object is garbage collected even if you still expect a
                                reference to be available. Be aware that code can behave differently in debug and
                                release builds. With release builds, more optimizations are taking place.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">通常你不应该通过编程方式调用 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">GC.Collect</code>
                                        ，因为在下一代中存活的对象移动得更快（如下一节所述）。然而，在测试期间这种方法非常有用，你可以看到内存泄漏，即本应被垃圾回收的对象仍然存活。你也可以看到其他场景，即对象被垃圾回收了，即使你仍然期望有引用可用。要注意代码在调试版本和发布版本中的行为可能不同。在发布版本中，会进行更多的优化。
                                    </font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                            <hr />
                        </div>
                    </section>
                </aside>
                <p id="c13-para-0044" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">When objects are created, they are placed within the managed
                    heap. The first section of the heap is called the generation 0 section, or gen 0. As your new
                    objects are created, they are moved into this section of the heap. Therefore, this is where the
                    youngest objects reside.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">当对象被创建时，它们会被放置在托管堆中。堆的第一部分称为 0
                                代部分，或 gen 0。随着新对象的创建，它们会被移到堆的这部分。因此，这里居住着最年轻的对象。</font>
                        </font>
                    </font>
                </p>
                <p id="c13-para-0045" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Your objects remain there until the first collection of
                    objects occurs through the garbage collection process. The objects that remain alive after this
                    cleansing are compacted and then moved to the next section or generational part of the heap—the
                    generation 1, or gen 1, section.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                你的对象会一直停留在这里，直到通过垃圾回收过程发生第一次对象收集。这次清理后仍然存活的对象会被压缩，然后移到堆的下一部分或代的部分——即 1 代，或 gen 1 部分。
                            </font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">At this point, the generation 0 section is empty, and all new
                    objects are again placed in this section. Older objects that survived the garbage collection process
                    are further down in the generation 1 section. This movement of aged items actually occurs one more
                    time. The next collection process that occurs is then repeated. This means that the items that
                    survived the garbage collection process from the generation 1 section are moved to the generation 2
                    section, and the gen 0 items go to gen 1, again leaving gen 0 open for new objects.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">此时，0
                                代区域是空的，所有新对象再次被放置在这个区域中。那些在垃圾回收过程中幸存下来的较老对象则位于 1
                                代区域下方。这些老化项目的移动实际上发生了一次。接下来的垃圾回收过程会重复进行。这意味着 1 代区域中幸存下来的对象会被移动到 2 代区域，而 0 代对象则进入 1 代，再次为
                                0 代腾出空间以容纳新对象。</font>
                        </font>
                    </font>
                </p>
                <aside data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <div class="top hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <p id="c13-para-0047" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">NOTE</b> <i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Garbage
                                collection occurs when you allocate an item that exceeds the capacity of the generation
                                0 section or when a </i>
                            <code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">GC.Collect</code>
                            <i data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> is called.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意：当分配的对象超过 0
                                        代区域的容量时，或者当调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">GC.Collect</code>
                                        时，会发生垃圾回收。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                            <hr />
                        </div>
                    </section>
                </aside>
                <p id="c13-para-0048" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">This process greatly improves the performance of your
                    application. Typically, your youngest objects are the ones that can be collected, and a large number
                    of objects that are associated with younger objects might be reclaimed as well. If these objects
                    reside next to each other in the heap, then the garbage collection is faster. In addition, because
                    related objects are residing next to each other, program execution is faster all around.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                这个过程极大地提高了您的应用程序性能。通常，您最年轻的对象是可以被回收的，而大量与年轻对象相关联的对象也可能被回收。如果这些对象在堆中彼此相邻，那么垃圾回收速度更快。此外，由于相关对象彼此相邻，整个程序的执行速度也更快。
                            </font>
                        </font>
                    </font>
                </p>
                <p id="c13-para-0049" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Another performance-related aspect of garbage collection in
                    .NET is how the framework deals with larger objects that are added to the heap. In .NET, larger
                    objects have their own managed heap, referred to as the <i
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">large object heap</i>.
                    When objects greater than 85,000 bytes are utilized, they go to this special heap rather than the
                    main heap. Your .NET application doesn't know the difference because this is all managed for you.
                    Because compressing large items in the heap is expensive, it isn't done for the objects residing in
                    the large object heap.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">.NET
                                中垃圾回收的另一个与性能相关的方面是框架如何处理添加到堆中的较大对象。在.NET 中，较大的对象有自己的托管堆，称为大对象堆。当使用大于 85,000
                                字节的对象时，它们会进入这个特殊堆而不是主堆。由于在堆中压缩大型项目成本很高，因此不会对驻留在大对象堆中的对象进行压缩。</font>
                        </font>
                    </font>
                </p>
                <p id="c13-para-0050" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">To improve garbage collection even more, collections in the
                    generation 2 section and from the large object heap are done on a background thread. This means that
                    application threads are only blocked for generation 0 and generation 1 collections, which reduces
                    the overall pause time, especially for large-scale server apps. This feature is on by default for
                    both servers and workstations.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">为了进一步提高垃圾回收效率，2
                                代部分的集合以及来自大对象堆的集合是在后台线程上执行的。这意味着应用程序线程仅被 0 代和 1
                                代的集合阻塞，这减少了整体暂停时间，特别是对于大规模服务器应用程序。此功能在服务器和工作站上默认启用。</font>
                        </font>
                    </font>
                </p>
                <p id="c13-para-0051" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1"><span aria-label="342" epub:type="pagebreak" id="Page_342"
                        role="doc-pagebreak"
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>Another
                    optimization that helps in application performance is garbage collection balancing. This is specific
                    to server garbage collection. Typically, a server has a pool of threads doing roughly the same
                    thing. The memory allocation is similar across all the threads. For servers, there is one garbage
                    collection heap per logical server. So, when one of the heaps runs out of memory and triggers a
                    garbage collection, all of the other heaps most likely will benefit from the garbage collection as
                    well. If a thread happens to use a lot more memory than other threads and it causes a garbage
                    collection, the other threads may not be close to requiring the garbage collection, so it's not
                    efficient. The GC balances the heaps—both the small object heap and the large object heap. This
                    balancing process reduces unnecessary collection.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                另一个有助于提升应用性能的优化是垃圾收集平衡。这特指服务器垃圾收集。通常，服务器拥有一组执行相似任务的线程。所有线程的内存分配方式相似。对于服务器而言，每个逻辑服务器都有一个垃圾收集堆。因此，当其中一个堆内存耗尽并触发垃圾收集时，其他所有堆很可能也会从垃圾收集中受益。如果某个线程使用的内存远超其他线程，导致触发垃圾收集，而其他线程可能并未接近需要垃圾收集，那么这种方式效率不高。垃圾收集器平衡各个堆——包括小型对象堆和大型对象堆。这种平衡过程减少了不必要的收集。
                            </font>
                        </font>
                    </font>
                </p>
                <p id="c13-para-0052" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">To take advantage of hardware with lots of memory, the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">GC</code> class has added
                    the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">GCSettings.LatencyMode</code>
                    property. Setting the property to one of the values in the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">GCLatencyMode</code>
                    enumeration gives a little control over how the GC performs collections. The following table shows
                    the possible values for the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">GCLatencyMode</code> that
                    can be used:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">为了利用具有大量内存的硬件， <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">GC</code>
                                类添加了 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">GCSettings.LatencyMode</code>
                                属性。将属性设置为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">GCLatencyMode</code>
                                枚举中的某个值，可以对垃圾收集器如何执行收集提供一定控制。下表显示了可用于 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">GCLatencyMode</code>
                                的可能值：</font>
                        </font>
                    </font>
                </p>
                <table border="1" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <thead data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <tr data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                            <th class="left bgcolor2" scope="col">MEMBER</th>
                            <th class="left bgcolor2" scope="col">DESCRIPTION</th>
                        </tr>
                    </thead>
                    <tbody data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <tr data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                            <td class="left bgcolor3"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><code
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Batch</code>
                            </td>
                            <td class="left bgcolor3"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                                data-immersive-translate-paragraph="1">Disables the concurrency settings and sets the
                                garbage collection for maximum throughput at the expense of responsiveness. This
                                overrides the configuration setting.<font
                                    class="notranslate immersive-translate-target-wrapper"
                                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                    <font
                                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                        data-immersive-translate-translation-element-mark="1">
                                        <font
                                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                            data-immersive-translate-translation-element-mark="1">
                                            禁用并发设置，并将垃圾回收设置为以最大吞吐量为代价牺牲响应能力。这将覆盖配置设置。</font>
                                    </font>
                                </font>
                            </td>
                        </tr>
                        <tr data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                            <td class="left bgcolor3"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><code
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Interactive</code>
                            </td>
                            <td class="left bgcolor3"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                                data-immersive-translate-paragraph="1">The default behavior on a workstation. This uses
                                garbage collection concurrency and balances throughput and responsiveness.<font
                                    class="notranslate immersive-translate-target-wrapper"
                                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                    <font
                                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                        data-immersive-translate-translation-element-mark="1">
                                        <font
                                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                            data-immersive-translate-translation-element-mark="1">
                                            工作站上的默认行为。这使用垃圾回收并发，并平衡吞吐量和响应能力。</font>
                                    </font>
                                </font>
                            </td>
                        </tr>
                        <tr data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                            <td class="left bgcolor3"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><code
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">LowLatency</code>
                            </td>
                            <td class="left bgcolor3"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                                data-immersive-translate-paragraph="1">Conservative garbage collection. Full collections
                                occur only when there is memory pressure on the system. This setting should only be used
                                for short periods of time to perform specific operations.<font
                                    class="notranslate immersive-translate-target-wrapper"
                                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                    <font
                                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                        data-immersive-translate-translation-element-mark="1">
                                        <font
                                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                            data-immersive-translate-translation-element-mark="1">
                                            保守式垃圾回收。只有在系统存在内存压力时才会进行完整收集。此设置仅应短时间使用以执行特定操作。</font>
                                    </font>
                                </font>
                            </td>
                        </tr>
                        <tr data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                            <td class="left bgcolor3"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><code
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SustainedLowLatency</code>
                            </td>
                            <td class="left bgcolor3"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                                data-immersive-translate-paragraph="1">Does full blocking collections only when there is
                                system memory pressure.<font class="notranslate immersive-translate-target-wrapper"
                                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                    <font
                                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                        data-immersive-translate-translation-element-mark="1">
                                        <font
                                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                            data-immersive-translate-translation-element-mark="1">仅在系统内存压力时才进行完整阻塞收集。
                                        </font>
                                    </font>
                                </font>
                            </td>
                        </tr>
                        <tr data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                            <td class="left bgcolor3"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><code
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">NoGCRegion</code>
                            </td>
                            <td class="left bgcolor3"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                                data-immersive-translate-paragraph="1">With <code
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">GCSettings</code>,
                                this is a read-only property. You can set it within a code block by calling <code
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">GC.TryStartNoGCRegion</code>
                                and <code
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">EndNoGCRegion</code>.
                                By invoking <code
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">TryStartNoGCRegion</code>,
                                you define the size of the memory that needs to be available, which the GC tries to
                                reach. After a successful call to <code
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">TryStartNoGCRegion</code>,
                                you define that the garbage collector should not run—until calling <code
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">EndNoGCRegion</code>.
                                <font class="notranslate immersive-translate-target-wrapper"
                                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                    <font
                                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                        data-immersive-translate-translation-element-mark="1">
                                        <font
                                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                            data-immersive-translate-translation-element-mark="1">使用 <code
                                                xmlns="http://www.w3.org/1999/xhtml"
                                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">GCSettings</code>
                                            时，这是一个只读属性。您可以通过调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">GC.TryStartNoGCRegion</code>
                                            和 <code xmlns="http://www.w3.org/1999/xhtml"
                                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">EndNoGCRegion</code>
                                            在代码块中设置它。通过调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">TryStartNoGCRegion</code>
                                            ，您定义需要可用的内存大小，GC 尝试达到这个大小。在成功调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">TryStartNoGCRegion</code>
                                            后，您定义垃圾收集器不应运行——直到调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">EndNoGCRegion</code>
                                            。</font>
                                    </font>
                                </font>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <p id="c13-para-0055" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">The amount of time that the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">LowLatency</code> or
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">NoGCRegion</code>
                    settings are used should be kept to a minimum. The amount of memory being allocated should be as
                    small as possible. An out-of-memory error could occur if you're not careful.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">LowLatency</code>
                                或 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">NoGCRegion</code>
                                设置的时间应尽量减少。分配的内存量应尽可能小。如果不小心，可能会出现内存不足错误。</font>
                        </font>
                    </font>
                </p>
            </section>
        </section>
        <section aria-labelledby="head-2-115" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
            <span id="c13-sec-0012" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
            <h2 id="head-2-115" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1">STRONG AND WEAK REFERENCES<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">强引用和弱引用</font>
                    </font>
                </font>
            </h2>
            <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1">The garbage collector cannot reclaim memory of an object that
                still has a reference—that is a strong reference. It can reclaim managed memory that is not referenced
                from the root table directly or indirectly. However, sometimes developers miss properly releasing a
                reference. Memory leaks can easily happen when not unsubscribing from events.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            垃圾回收器无法回收仍然存在引用的对象——即强引用。它可以回收未直接或间接从根表中引用的管理内存。然而，有时开发者未能正确释放引用。如果没有取消订阅事件，内存泄漏很容易发生。
                        </font>
                    </font>
                </font>
            </p>
            <aside data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                <div class="top hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <hr />
                </div>
                <section class="feature2" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <p id="c13-para-0057" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1"><b
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">NOTE</b> <i
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">In case you have
                            objects that reference each other but are not referenced from the root table—for example,
                            object A references B, B references C, and C references A—the GC can destroy all these
                            objects.</i>
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">注意 如果你有相互引用但未从根表中引用的对象——例如，对象
                                    A 引用 B，B 引用 C，C 引用 A——GC 可以销毁所有这些对象。</font>
                            </font>
                        </font>
                    </p>
                    <div class="bottom hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <hr />
                    </div>
                </section>
            </aside>
            <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1"><span aria-label="343" epub:type="pagebreak" id="Page_343"
                    role="doc-pagebreak"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>When the class or
                struct is instantiated in the application code, it has a strong reference as long as there is any other
                code that references it. For example, if you have a class called <code
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">MyClass</code> and you create
                a reference to objects based on that class and call the variable <code
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">myClassVariable</code> as
                follows, as long as <code
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">myClassVariable</code> is in
                scope, there is a strong reference to the <code
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">MyClass</code> object:<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            当类或结构在应用程序代码中被实例化时，只要还有其他代码引用它，它就有强引用。例如，如果你有一个名为 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">MyClass</code>
                            的类，你基于该类创建对象引用，并像下面这样调用变量 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">myClassVariable</code>
                            ，只要 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">myClassVariable</code>
                            在作用域内，就存在对 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">MyClass</code>
                            对象的强引用：</font>
                    </font>
                </font>
            </p>
            <pre id="c13-code-0006"><code>MyClass? myClassVariable = new();</code></pre>
            <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1">This means that the garbage collector cannot clean up the memory
                used by the <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">MyClass</code>
                object. Generally, this is a good thing because you might need to access the <code
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">MyClass</code> object. You
                might create a cache object that has references to several other objects, like this:<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">这意味着垃圾回收器无法清理 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">MyClass</code>
                            对象使用的内存。通常情况下，这是好事，因为你可能需要访问 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">MyClass</code>
                            对象。你可以创建一个缓存对象，它引用了其他几个对象，就像这样：</font>
                    </font>
                </font>
            </p>
            <pre id="c13-code-0007"><code>MyCache myCache = new();</code>
<code>myCache.Add(myClassVariable);</code></pre>
            <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1">Now you've finished using the <code
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">myClassVariable</code>. It
                can go out of scope, or you assign <code
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">null</code>
                :<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">现在你已经完成了对 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">myClassVariable</code>
                            的使用。它可以超出作用域，或者你分配给 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">null</code> ：
                        </font>
                    </font>
                </font>
            </p>
            <pre id="c13-code-0008"><code>myClassVariable = null;</code></pre>
            <p id="c13-para-0061" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1">In case the garbage collector runs now, it can't release the
                memory that was referenced by the <code
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">myClassVariable</code>
                because the object is still referenced from the cache object. Such references can easily be missed, and
                you can avoid this by using the <code
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">WeakReference</code>.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">如果垃圾回收器现在运行，它无法释放 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">myClassVariable</code>
                            引用的内存，因为该对象仍然被缓存对象引用。这种引用很容易被忽略，你可以通过使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">WeakReference</code>
                            来避免这种情况。</font>
                    </font>
                </font>
            </p>
            <p id="c13-para-0062" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1">A weak reference allows the object to be created and used, but if
                the garbage collector happens to run, it collects the object and frees up the memory. This is not
                something you would typically want to do because of potential bugs and performance issues, but there are
                certainly situations in which it makes sense. Weak references also don't make sense with small objects
                because weak references have an overhead of their own, and that might be bigger than the small object.
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            弱引用允许对象被创建和使用，但如果垃圾回收器恰好运行，它会回收对象并释放内存。这通常不是你想要做的事情，因为可能存在潜在的 bug
                            和性能问题，但确实有一些情况下这样做是有意义的。弱引用对于小对象也不适用，因为弱引用本身也有开销，这可能比小对象还要大。</font>
                    </font>
                </font>
            </p>
            <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1">Weak references are created using the <code
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">WeakReference</code> class.
                With the constructor, you can pass a strong reference. The sample code creates a <code
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">DataObject</code> and passes
                the reference returned from the constructor. When using <code
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">WeakReference</code>, you can
                try to access the <code
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Target</code> property. If
                the <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Target</code> property
                doesn't return <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">null</code>,
                the object is still available. Assigning it to the variable <code
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">strongReference</code>, a
                strong reference to the object is created again, and it can't be garbage collected:<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">弱引用是通过 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">WeakReference</code>
                            类创建的。使用构造函数时，你可以传递一个强引用。示例代码创建了一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">DataObject</code>
                            并传递了构造函数返回的引用。在使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">WeakReference</code>
                            时，你可以尝试访问 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Target</code>
                            属性。如果 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Target</code>
                            属性不返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">null</code>
                            ，对象仍然可用。将其赋值给变量 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">strongReference</code>
                            ，会再次创建对该对象的强引用，并且它不能被垃圾回收：</font>
                    </font>
                </font>
            </p>
            <pre id="c13-code-0009"><code>// Instantiate a weak reference to the DataObject object</code>
<code>WeakReference myWeakReference = new(new DataObject());</code>
<code>DataObject? strongReference = myWeakReference.Target as DataObject;</code>
<code>if (strongReference is not null)</code>
<code>{</code>
<code>  // use the strongReference</code>
<code>}</code>
<code>else</code>
<code>{</code>
<code>  // reference not available</code>
<code>}</code></pre>
            <aside data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                <div class="top hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <hr />
                </div>
                <section class="feature2" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <p id="c13-para-0065" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1"><b
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">NOTE</b> <i
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">The </i><code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">WeakReference</code><i
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> class defines the
                        </i><code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IsAlive</code><i
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> property. Accessing
                            this property before creating a strong reference is not useful. In the time between
                            accessing the </i><code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IsAlive</code><i
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> property and using
                            the </i><code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Target</code><i
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> property, the object
                            can be garbage collected. It's always necessary to check for null after accessing the
                        </i><code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Target</code><i
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> property. A
                            practical use of the </i><code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IsAlive</code><i
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> property is that a
                            strong reference is currently not required, and you just want to check if the object is not
                            alive anymore (e.g., to set a flag in a class or do some other cleanup).</i>
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">注意： <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">WeakReference</code>
                                    类定义了 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IsAlive</code>
                                    属性。在创建强引用之前访问此属性没有用。在访问 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IsAlive</code>
                                    属性和使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Target</code>
                                    属性之间，对象可能会被垃圾回收。访问 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Target</code>
                                    属性后总是需要检查是否为 null。 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IsAlive</code>
                                    属性的一个实际用途是当前不需要强引用，你只想检查对象是否已经不再存活（例如，在类中设置一个标志或进行一些其他清理）。</font>
                            </font>
                        </font>
                    </p>
                    <div class="bottom hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <hr />
                    </div>
                </section>
            </aside>
        </section> <span aria-label="344" epub:type="pagebreak" id="Page_344" role="doc-pagebreak"
            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
        <section aria-labelledby="head-2-116" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
            <span id="c13-sec-0015" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
            <h2 id="head-2-116" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1">WORKING WITH UNMANAGED RESOURCES<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">处理未管理资源</font>
                    </font>
                </font>
            </h2>
            <p id="c13-para-0066" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1">The presence of the garbage collector means that you usually do
                not need to worry about objects you no longer need; you simply allow all references to those objects to
                go out of scope and let the garbage collector free memory as required. However, the garbage collector
                does not know how to free unmanaged resources (such as file handles, network connections, and database
                connections). When managed classes encapsulate direct or indirect references to unmanaged resources, you
                need to make special provisions to ensure that the unmanaged resources are released when an instance of
                the class is garbage collected.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            垃圾回收器的存在意味着你通常不需要担心不再需要的对象；你只需让这些对象的引用超出作用域，并让垃圾回收器按需释放内存。然而，垃圾回收器不知道如何释放未管理资源（例如文件句柄、网络连接和数据库连接）。当管理类封装了对未管理资源的直接或间接引用时，你需要做出特殊安排以确保在类的实例被垃圾回收时释放未管理资源。
                        </font>
                    </font>
                </font>
            </p>
            <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1">When defining a class, you can use two mechanisms to automate the
                freeing of unmanaged resources. These mechanisms are often implemented together because each provides a
                slightly different approach:<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            在定义类时，你可以使用两种机制来自动释放未管理的资源。这些机制通常一起实现，因为每种方法略有不同：</font>
                    </font>
                </font>
            </p>
            <ul class="check" id="c13-list-0003" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                <li id="c13-li-0012" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Declare a <i
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">destructor</i> (or
                    finalizer) as a member of your class.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">将析构函数（或终结器）声明为类的成员。</font>
                        </font>
                    </font>
                </li>
                <li id="c13-li-0013" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Implement the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">System.IDisposable</code>
                    interface in your class.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在你的类中实现 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">System.IDisposable</code>
                                接口。</font>
                        </font>
                    </font>
                </li>
            </ul>
            <p id="c13-para-0068" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1">The following sections discuss each of these mechanisms in turn
                and then look at how to implement the mechanisms together for best results.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">接下来的部分将依次讨论这些机制，然后探讨如何结合使用这些机制以获得最佳效果。
                        </font>
                    </font>
                </font>
            </p>
            <section data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span id="c13-sec-0016"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                <h3 id="head-3-249" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Destructors or Finalizers <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">析构函数或终结器</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">You have seen that constructors enable you to specify actions
                    that must take place whenever an instance of a class is created. Conversely, destructors are called
                    before an object is destroyed by the garbage collector. Given this behavior, a destructor would
                    initially seem like a great place to put code to free unmanaged resources and perform a general
                    cleanup. Unfortunately, things are not always so straightforward.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                你已经看到构造函数能够让你指定每当创建类的实例时必须执行的操作。相反，析构函数会在对象被垃圾收集器销毁之前被调用。根据这种行为，析构函数最初看起来像是释放未管理资源并进行一般清理的绝佳位置。不幸的是，事情并不总是如此简单。
                            </font>
                        </font>
                    </font>
                </p>
                <aside data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <div class="top hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <p id="c13-para-0070" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">NOTE</b> <i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Although we talk
                                about destructors in C#, in the underlying .NET architecture, these are known as
                                finalizers. When you define a destructor in C#, what is emitted into the assembly by the
                                compiler is actually a </i><code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Finalize</code><i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> method. It
                                doesn't affect any of your source code, but you need to be aware of it when examining
                                generated Intermediate Language (IL) code.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意 虽然我们在
                                        C#中谈论析构函数，但在底层的.NET 架构中，这些被称为终结器。当你定义 C#中的析构函数时，编译器实际向程序集发射的是 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Finalize</code>
                                        方法。它不会影响你的任何源代码，但在检查生成的中间语言（IL）代码时，你需要了解这一点。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                            <hr />
                        </div>
                    </section>
                </aside>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">The syntax for a destructor will be familiar to C++
                    developers. It looks like a method, with the same name as the containing class, but prefixed with a
                    tilde (<code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">~</code>). It
                    has no return type and takes no parameters or access modifiers. Here is an example:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">析构函数的语法对
                                C++开发者来说会很熟悉。它看起来像是一个方法，与包含它的类的名称相同，但前面有一个波浪号（ <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">~</code>
                                ）。它没有返回类型，也不接受参数或访问修饰符。这里有一个示例：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0010"><code>class MyClass</code>
<code>{</code>
<code>  ~MyClass()</code>
<code>  {</code>
<code>    // Finalizer implementation</code>
<code>  }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">When the C# compiler compiles a destructor, it implicitly
                    translates the destructor code to the equivalent of an override of the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Finalize</code> method,
                    which ensures that the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Finalize</code> method of
                    the parent class is executed. The following example shows the C# code equivalent to the IL that the
                    compiler would generate for the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">~MyClass</code>
                    destructor:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">当
                                C#编译器编译析构函数时，它会隐式地将析构函数代码转换为相当于重写 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Finalize</code>
                                方法的等价形式，这确保了父类的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Finalize</code>
                                方法被执行。以下示例展示了编译器为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">~MyClass</code>
                                析构函数生成的 IL 代码对应的 C#代码：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0011"><code>protected override void Finalize()</code>
<code>{</code>
<code>  try</code>
<code>  {</code>
<code>    // Finalizer implementation</code>
<code>  }<span aria-label="345" epub:type="pagebreak" id="Page_345" role="doc-pagebreak"></span></code>
<code>  finally</code>
<code>  {</code>
<code>    base.Finalize();</code>
<code>  }</code>
<code>}</code></pre>
                <p id="c13-para-0073" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">As shown, the code implemented in the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">~MyClass</code>
                    destructor is wrapped in a <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">try</code> block
                    contained in the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Finalize</code> method. A
                    call to the parent's <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Finalize</code> method is
                    ensured by placing the call in a <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">finally</code> block. You
                    can read about <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">try</code> and <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">finally</code> blocks in
                    <a href="c10.xhtml" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Chapter
                        10</a>, “Errors and Exceptions.”<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">如所示， <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">~MyClass</code>
                                析构函数中实现的代码被包裹在包含在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Finalize</code>
                                方法中的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">try</code>
                                块中。通过将调用置于 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">finally</code>
                                块中，确保了对父类 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Finalize</code>
                                方法的调用。你可以在第 10 章“错误和异常”中阅读关于 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">try</code> 和
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">finally</code>
                                块的信息。</font>
                        </font>
                    </font>
                </p>
                <p id="c13-para-0074" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Experienced C++ developers make extensive use of destructors,
                    sometimes not only to clean up resources but also to provide debugging information or perform other
                    tasks. C# destructors are used far less than their C++ equivalents. The problem with C# destructors
                    as compared to their C++ counterparts is that they are nondeterministic. When a C++ object is
                    destroyed, its destructor runs immediately. However, because of the way the garbage collector works
                    when using C#, there is no way to know when an object's destructor will actually execute. The
                    destructor runs when a finalizer starts. The finalizer is started with a garbage collection. Hence,
                    you cannot place any code in the destructor that relies on being run at a certain time, and you
                    should not rely on the destructor being called for different class instances in any particular
                    order. When your object is holding scarce and critical resources that need to be freed as soon as
                    possible, you do not want to wait for garbage collection.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">有经验的
                                C++开发者会大量使用析构函数，有时不仅是为了清理资源，还为了提供调试信息或执行其他任务。C#的析构函数远不如 C++的析构函数使用得多。C#析构函数与
                                C++析构函数相比的问题在于它们是非确定性的。当 C++对象被销毁时，它的析构函数会立即运行。然而，由于使用
                                C#时垃圾回收器的工作方式，无法知道对象的确构函数何时会实际执行。析构函数在终结器开始时运行。终结器是在垃圾回收时启动的。因此，你无法在析构函数中放置任何依赖于在特定时间运行的代码，也不应该依赖于析构函数按任何特定顺序被不同类实例调用。当你的对象持有稀缺且关键资源，需要尽快释放时，你不想等待垃圾回收。
                            </font>
                        </font>
                    </font>
                </p>
                <p id="c13-para-0075" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Another problem with C# destructors is that the
                    implementation of a destructor delays the final removal of an object from memory. Objects that do
                    not have a destructor are removed from memory in one pass of the garbage collector, but objects that
                    have destructors require two passes to be destroyed: the first pass calls the destructor without
                    removing the object, and the second pass actually deletes the object. In addition, the runtime uses
                    a single thread to execute the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Finalize</code> methods
                    of all objects. If you use destructors frequently and use them to execute lengthy cleanup tasks, the
                    impact on performance can be noticeable.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                C#析构函数的另一个问题是，析构函数的实现会延迟对象从内存中最终被移除。没有析构函数的对象在垃圾回收的一次遍历中就会被移除，但具有析构函数的对象需要两次遍历才能被销毁：第一次遍历调用析构函数但不移除对象，第二次遍历才实际删除对象。此外，运行时使用单个线程来执行所有对象的
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Finalize</code>
                                方法。如果你频繁使用析构函数并使用它们执行耗时的清理任务，对性能的影响可能会很明显。</font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span id="c13-sec-0018"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                <h3 id="head-3-250" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">The IDisposable and IAsyncDiposable Interfaces <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">IDisposable 和 IAsyncDisposable 接口
                            </font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">In C#, the recommended alternative to using a destructor is
                    using the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code> or
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IAsyncDiposable</code>
                    interfaces. These interfaces define a pattern (with language-level support) that provides a
                    deterministic mechanism for freeing unmanaged resources and avoids the garbage collector–related
                    problems inherent with destructors. The <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code>
                    interface declares a single method named <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code>, which
                    takes no parameters and returns <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">void</code>. Here is an
                    implementation for <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">MyClass</code>
                    :<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在 C#中，推荐使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code>
                                或 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IAsyncDiposable</code>
                                接口作为使用析构函数的替代方案。这些接口定义了一种模式（并得到语言级别的支持），提供了一种确定性机制来释放非托管资源，并避免了与析构函数相关的垃圾回收问题。 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code>
                                接口声明了一个名为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code>
                                的方法，该方法不接受参数并返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">void</code>
                                。以下是 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">MyClass</code>
                                的一个实现：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0012"><code>class MyClass: IDisposable</code>
<code>{</code>
<code>  public void Dispose()</code>
<code>  {</code>
<code>    // implementation</code>
<code>  }</code>
<code>}</code></pre>
                <p id="c13-para-0077" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">The <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IAsyncDisposable</code>
                    interface defines the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">DisposeAsync</code>
                    method that returns a <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">ValueTask</code>.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IAsyncDisposable</code>
                                接口定义了返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">ValueTask</code>
                                的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">DisposeAsync</code>
                                方法。</font>
                        </font>
                    </font>
                </p>
                <p id="c13-para-0078" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">The implementation of <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code> should
                    explicitly free all unmanaged resources used directly by an object and call <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code> on any
                    encapsulated objects that also implement the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code>
                    interface. In this way, the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code> method
                    provides precise control over when unmanaged resources are freed.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code>
                                的实现应当明确释放对象直接使用的所有非托管资源，并对任何实现 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code>
                                接口的封装对象调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code>
                                。通过这种方式， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code>
                                方法提供了对非托管资源何时被释放的精确控制。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Suppose that you have a class named <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">ResourceGobbler</code>,
                    which relies on the use of some external resource and implements <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code>. If
                    you want to instantiate an instance of this class, use it, and then dispose of it, you could do so
                    like this:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">假设你有一个名为 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">ResourceGobbler</code>
                                的类，它依赖于某些外部资源并实现了 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code>
                                。如果你想要实例化这个类的对象，使用它，然后释放它，你可以这样做：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0013"><code>ResourceGobbler theInstance = new();</code>
<code>// do your processing</code>
<code>theInstance.Dispose();</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1"><span aria-label="346" epub:type="pagebreak" id="Page_346"
                        role="doc-pagebreak"
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>Unfortunately,
                    this code fails to free the resources consumed by <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">theInstance</code> if an
                    exception occurs during processing, so you should write the code as follows using a <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">try</code> block (as
                    covered in detail in <a href="c10.xhtml"
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Chapter 10</a>):<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">不幸的是，如果在处理过程中发生异常，这段代码未能释放 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">theInstance</code>
                                消耗的资源，因此你应该使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">try</code>
                                块来编写代码（如第 10 章详细介绍的）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0014"><code>ResourceGobbler? theInstance = null;</code>
<code>try</code>
<code>{</code>
<code>  theInstance = new();</code>
<code>  // do your processing</code>
<code>}</code>
<code>finally</code>
<code>{</code>
<code>  theInstance?.Dispose();</code>
<code>}</code></pre>
            </section>
            <section data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span id="c13-sec-0019"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                <h3 id="head-3-251" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">The using Statement and the using Declaration <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">using 语句和 using 声明</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Using <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">try</code>
                    /
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">finally</code> ensures
                    that <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code> is
                    always called on <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">theInstance</code> and
                    that any resources consumed by it are always freed, even if an exception occurs during processing.
                    However, if you always had to repeat such a construct, it would result in confusing code. C# offers
                    a syntax that you can use to guarantee that <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code> or <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">DisposeAsync</code> is
                    automatically called against an object that implements <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code> or
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IAsyncDisposable</code>
                    when its reference goes out of scope. The syntax to do this involves the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code> keyword. The
                    following code generates IL code equivalent to the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">try</code> block just
                    shown:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">try</code> /
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">finally</code>
                                可以确保 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code>
                                总是在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">theInstance</code>
                                上被调用，并且它所消耗的资源在处理过程中即使发生异常也总是被释放。但是，如果你总是不得不重复这种结构，会导致代码混乱。C# 提供了一种语法，你可以用它来保证当实现 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code>
                                或 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IAsyncDisposable</code>
                                的对象的引用超出作用域时，会自动调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code>
                                或 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">DisposeAsync</code>
                                。这种语法的关键字是 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                                。以下代码生成的 IL 代码与前面显示的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">try</code>
                                块等效：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0015"><code>using (ResourceGobbler theInstance = new())</code>
<code>{</code>
<code>  // do your processing</code>
<code>}</code></pre>
                <aside data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <div class="top hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <p id="c13-para-0083" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">NOTE</b> <i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">The interface
                            </i><code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code><i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> or </i><code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IAsyncDisposable</code><i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> is required to
                                use an object with the </i><code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code><i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> statement or the
                            </i><code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code><i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> declaration.
                                There's one exception: because a value-only type (a </i><code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">ref struct</code><i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">) cannot
                                implement any interface, with a </i><code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">ref struct</code><i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">, just the
                                implementation of a </i><code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code><i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> method is
                                required to use this type with the </i><code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code><i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> statement or the
                            </i><code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code><i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> declaration.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意 使用 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code>
                                        或 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IAsyncDisposable</code>
                                        语句或 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                                        声明时，需要对象实现 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                                        接口。有一个例外：因为值类型（即 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">ref struct</code>
                                        ）不能实现任何接口，使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">ref struct</code>
                                        时，只需要实现 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code>
                                        方法即可使用该类型与 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                                        语句或 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                                        声明。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                            <hr />
                        </div>
                    </section>
                </aside>
                <p id="c13-para-0084" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">The <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code> statement,
                    followed in parentheses by a reference variable declaration and instantiation, causes that variable
                    to be scoped to the accompanying statement block. In addition, when that variable goes out of scope,
                    its <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code>
                    method is called automatically, even if an exception occurs.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                                语句，其后括号内跟随一个引用变量声明和实例化，会使该变量作用域限定于伴随的语句块。此外，当该变量超出作用域时，其 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code>
                                方法会自动被调用，即使发生异常也是如此。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Since C# 8, a shorter form to release resources is available:
                    the <i data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using declaration</i>.
                    With the <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                    declaration, you don't write parentheses, and the curly brackets are not necessary. The compiler
                    still creates code with <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">try</code>
                    /
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">finally</code> to
                    invoke the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code> or <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">DisposeAsync</code>
                    method. The resource is disposed when the variable goes out of scope. Typically, the variable goes
                    out of scope when the method ends. As most methods are very short, disposing should often be done at
                    the end of the method. That much indentation of code using many curly brackets can be reduced with
                    the <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                    declaration. With the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code> declaration,
                    you can also add curly brackets to invoke the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dipose</code> method
                    earlier.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">自 C# 8 起，有一种更简短的方式来释放资源：using
                                声明。使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                                声明时，无需编写括号，大括号也不必要。编译器仍然会生成包含 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">try</code> /
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">finally</code>
                                的代码来调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code>
                                或 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">DisposeAsync</code>
                                方法。当变量超出作用域时，资源会被释放。通常情况下，变量会在方法结束时超出作用域。由于大多数方法都非常短，释放资源通常应在方法结束时进行。使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                                声明可以减少大量使用大括号的代码缩进。使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                                声明，你也可以添加大括号来提前调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dipose</code>
                                方法。</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0016"><code>using ResourceGobbler theInstance = new();</code>
<code>// do your processing</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">There's another difference with the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code> statement
                    and the <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                    declaration. With the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code> declaration,
                    a variable is always needed. The <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code> statement
                    can be used with the return of a method; you don't necessarily need to declare a variable if a
                    variable is not needed to invoke members.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">与 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                                语句和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                                声明还有另一个不同之处。在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                                声明中，始终需要一个变量。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                                语句可以用于方法的返回；如果不需要声明变量来调用成员，则不一定需要声明变量。</font>
                        </font>
                    </font><span aria-label="347" epub:type="pagebreak" id="Page_347" role="doc-pagebreak"
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span></p>
                <aside data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <div class="top hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <p id="c13-para-0087" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">NOTE</b> <i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">The </i>
                            <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                            <i data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> keyword has
                                multiple uses with C#. The </i>
                            <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                            <i data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> directive is used
                                to import namespaces. The </i>
                            <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                            <i data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> statement and
                            </i>
                            <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                            <i data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> declaration can
                                be used with objects implementing the </i>
                            <code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code>
                            <i data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> interface. The
                            </i>
                            <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code>
                            <i data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> method is invoked
                                with the end of the using scope.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                                        关键字在 C#中有多种用途。 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                                        指令用于导入命名空间。 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                                        语句和 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                                        声明可以用于实现 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code>
                                        接口的对象。 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code>
                                        方法在 using 作用域结束时被调用。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                            <hr />
                        </div>
                    </section>
                </aside>
                <aside data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <div class="top hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <p id="c13-para-0088" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">NOTE</b> <i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">With several
                                classes, both a </i><code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Close</code><i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> and a </i><code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code><i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> method exist. If
                                it is common to close a resource (such as a file and a database), both </i><code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Close</code><i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> and </i><code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code><i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> have been
                                implemented. Here, the </i><code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Close</code><i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> method simply
                                calls </i><code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code><i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">. This approach
                                provides clarity in the use of these classes and supports the </i><code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code><i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> statement. Newer
                                types only implement the </i><code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code><i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> method as we're
                                already used to it.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意在多个类中，都存在 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Close</code>
                                        和 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code>
                                        方法。如果通常需要关闭资源（例如文件和数据库），则 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Close</code>
                                        和 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code>
                                        都已被实现。在这里， <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Close</code>
                                        方法简单地调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code>
                                        。这种方法在使用这些类时提供了清晰性，并支持 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                                        语句。较新的类型只实现了 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code>
                                        方法，因为我们已经习惯了它。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                            <hr />
                        </div>
                    </section>
                </aside>
            </section>
            <section data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span id="c13-sec-0023"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                <h3 id="head-3-252" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Implementing IDisposable and a Destructor <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">实现 IDisposable 和析构函数</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">The previous sections discussed two alternatives for freeing
                    unmanaged resources used by the classes you create:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">前面的章节讨论了两个释放你创建的类使用的非托管资源的方法：
                            </font>
                        </font>
                    </font>
                </p>
                <ul class="check" id="c13-list-0004"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <li id="c13-li-0014" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1">The execution of a destructor is enforced by the runtime
                        but is nondeterministic and places an unacceptable overhead on the runtime because of the way
                        garbage collection works.<font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">
                                    析构函数的执行由运行时强制执行，但由于垃圾回收的工作方式，它是非确定性的，并且给运行时带来了不可接受的开销。</font>
                            </font>
                        </font>
                    </li>
                    <li id="c13-li-0015" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1">The <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code>
                        interface provides a mechanism that enables users of a class to control when resources are freed
                        but requires discipline to ensure that <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code> is
                        called.<font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1"> <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code>
                                    接口提供了一个机制，使用户能够控制何时释放资源，但需要自律来确保 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code>
                                    被调用。</font>
                            </font>
                        </font>
                    </li>
                </ul>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">If you are creating a finalizer, you should also implement
                    the <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code>
                    interface. You implement <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code> on the
                    assumption that most programmers will call <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code> correctly,
                    but implement a destructor as a safety mechanism in case <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code> is not
                    called. Here is an example of a dual implementation:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">如果你正在创建一个析构函数，你也应该实现 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code>
                                接口。你实现 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code>
                                是假设大多数程序员会正确调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code>
                                ，但实现析构函数作为安全机制，以防 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code>
                                未被调用。这里是一个双重实现的例子：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0017"><code>public class ResourceHolder: IDisposable</code>
<code>{</code>
<code>  private bool _isDisposed = false;</code>
<code>  public void Dispose()</code>
<code>  {</code>
<code>    Dispose(true);</code>
<code>    GC.SuppressFinalize(this);</code>
<code>  }</code>
<code> </code>
<code>  protected virtual void Dispose(bool disposing)</code>
<code>  {</code>
<code>    if (!_isDisposed)</code>
<code>    {</code>
<code>      if (disposing)</code>
<code>      {</code>
<code>        // Cleanup managed objects by calling their</code>
<code>        // Dispose() methods.</code>
<code>      }</code>
<code>      // Cleanup unmanaged objects</code>
<code>      _isDisposed = true;</code>
<code>    }</code>
<code>  }</code>
<code> <span aria-label="348" epub:type="pagebreak" id="Page_348" role="doc-pagebreak"></span></code>
<code>  ~ResourceHolder()</code>
<code>  {</code>
<code>    Dispose(false);</code>
<code>  }</code>
<code> </code>
<code>  public void SomeMethod()</code>
<code>  {</code>
<code>    // Ensure object not already disposed before execution of any method</code>
<code>    if(_isDisposed)</code>
<code>    {</code>
<code>      throw new ObjectDisposedException(nameof(ResourceHolder));</code>
<code>    }</code>
<code>    // method implementation…</code>
<code>  }</code>
<code>}</code></pre>
                <p id="c13-para-0091" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">You can see from this code that there is a second <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">protected</code> overload
                    of <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code> that
                    takes one <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">bool</code>
                    parameter—and this is the method that does all the cleaning up. <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose(bool)</code> is
                    called by both the destructor and <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable.Dispose</code>.
                    The point of this approach is to ensure that all cleanup code is in one place.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">从这段代码中可以看出， <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code>
                                有一个第二个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">protected</code>
                                重载版本，它接受一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">bool</code>
                                参数——而这就是执行所有清理工作的方法。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose(bool)</code>
                                会被析构函数和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable.Dispose</code>
                                调用。这种方法的目的是确保所有清理代码都位于一个地方。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">The parameter passed to <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose(bool)</code>
                    indicates whether <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose(bool)</code> has
                    been invoked by the destructor or by <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable.Dispose</code>.
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose(bool)</code>
                    should not be invoked from anywhere else in your code. The idea is this:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">传递给 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose(bool)</code>
                                的参数表示 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose(bool)</code>
                                是由析构函数调用还是由 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable.Dispose</code>
                                调用的。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose(bool)</code>
                                不应在代码的任何其他地方被调用。其思路如下：</font>
                        </font>
                    </font>
                </p>
                <ul class="check" id="c13-list-0005"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <li id="c13-li-0016" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1">If a consumer calls <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable.Dispose</code>,
                        that consumer is indicating that all managed and unmanaged resources associated with that object
                        should be cleaned up.<font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">如果消费者调用 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable.Dispose</code>
                                    ，那么该消费者表示与该对象相关的所有托管和非托管资源都应该被清理。</font>
                            </font>
                        </font>
                    </li>
                    <li id="c13-li-0017" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1">If a destructor has been invoked, all resources still
                        need to be cleaned up. However, in this case, you know that the destructor must have been called
                        by the garbage collector, and you should not attempt to access other managed objects because you
                        can no longer be certain of their state. In this situation, the best you can do is clean up the
                        known unmanaged resources and hope that any referenced managed objects also have destructors
                        that will perform their own cleaning up.<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">
                                    如果已经调用了析构函数，所有资源仍然需要被清理。但是在这种情况下，你知道析构函数一定是由垃圾回收器调用的，并且你不应该尝试访问其他托管对象，因为你无法再确定它们的状态。在这种情况下，你能做的最好的事情就是清理已知的非托管资源，并希望任何被引用的托管对象也有析构函数来执行自己的清理。
                                </font>
                            </font>
                        </font>
                    </li>
                </ul>
                <p id="c13-para-0093" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">The <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">_isDisposed</code> member
                    variable indicates whether the object has already been disposed of and ensures that you do not try
                    to dispose of member variables more than once. It also enables you to test whether an object has
                    been disposed of before executing any instance methods, as shown in <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SomeMethod</code>. This
                    simplistic approach is not thread-safe and depends on the caller ensuring that only one thread is
                    calling the method concurrently. Requiring a consumer to enforce synchronization is a reasonable
                    assumption and one that is used repeatedly throughout the .NET class libraries (in the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Collection</code>
                    classes, for example). Threading and synchronization are discussed in <a href="c17.xhtml"
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Chapter 17</a>, “Parallel
                    Programming.”<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">_isDisposed</code>
                                成员变量表示对象是否已经被释放，并确保你不会多次尝试释放成员变量。它还允许你在执行任何实例方法之前测试对象是否已被释放，如 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SomeMethod</code>
                                所示。这种简单的方法不是线程安全的，并且依赖于调用者确保只有一个线程同时调用该方法。要求消费者强制执行同步是一种合理的假设，并且在 .NET 类库中反复使用（例如在 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Collection</code>
                                类中）。线程和同步在“第 17 章：并行编程”中讨论。</font>
                        </font>
                    </font>
                </p>
                <p id="c13-para-0094" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Finally, <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable.Dispose</code>
                    contains a call to the method <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">System.GC.SuppressFinalize</code>.
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">GC</code> is the class
                    that represents the garbage collector, and the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SuppressFinalize</code>
                    method tells the garbage collector that a class no longer needs to have its destructor called.
                    Because your implementation of <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code> has
                    already done all the cleanup required, there's nothing left for the destructor to do. Calling <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SuppressFinalize</code>
                    means that the garbage collector will treat that object as if it doesn't have a destructor at all.
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">最后， <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable.Dispose</code>
                                包含对方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">System.GC.SuppressFinalize</code>
                                的调用。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">GC</code>
                                是代表垃圾回收器的类，而 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SuppressFinalize</code>
                                方法告诉垃圾回收器一个类不再需要调用其析构函数。由于你的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code>
                                实现已经完成了所有必要的清理工作，因此析构函数没有剩下任何需要执行的操作。调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SuppressFinalize</code>
                                意味着垃圾回收器将把该对象视为根本没有析构函数。</font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span id="c13-sec-0024"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                <h3 id="head-3-253" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">IDisposable and Finalizer Rules <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">IDisposable 和 Finalizer 规则</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">You've learned about finalizers, the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code>
                    interface, the Dispose pattern, and some rules on using these constructs. Because releasing
                    resources is such an important aspect with managed code, the rules are summarized in this list:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">你已经学习了终结器、 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code>
                                接口、Dispose 模式以及使用这些结构的规则。由于释放资源是托管代码的一个非常重要的方面，这些规则被总结在以下列表中：</font>
                        </font>
                    </font>
                </p>
                <ul class="check" id="c13-list-0006"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <li id="c13-li-0018" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1">If your class defines a member that implements <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code>,
                        the class should also implement <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code>.
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">如果你的类定义了一个实现 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code>
                                    的成员，那么这个类也应该实现 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code>
                                    。</font>
                            </font>
                        </font>
                    </li>
                    <li id="c13-li-0019" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1">Implementing <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code>
                        does not mean you should also implement a finalizer. Finalizers create additional overhead with
                        both creating an object and releasing the memory of the object as an additional <span
                            aria-label="349" epub:type="pagebreak" id="Page_349" role="doc-pagebreak"
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>pass from the
                        GC is needed. You should implement a finalizer only if needed—for example, to release native
                        resources, a finalizer is really needed.<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">实现 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code>
                                    并不意味着你也应该实现一个终结器。终结器在创建对象和释放对象内存时都会产生额外的开销，因为需要 GC
                                    进行额外的遍历来释放内存。只有在你确实需要时才应该实现终结器——例如，为了释放原生资源，终结器是真正需要的。</font>
                            </font>
                        </font>
                    </li>
                    <li id="c13-li-0020" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1">If a finalizer is implemented, you should also implement
                        the interface <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code>.
                        This way, the native resource can be released earlier, not only when the GC is finding out about
                        the allocated resource that's available for releasing it.<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">如果实现了终结器，你也应该实现接口 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code>
                                    。这样，原生资源可以更早地被释放，而不仅仅是在 GC 发现可以释放的已分配资源时。</font>
                            </font>
                        </font>
                    </li>
                    <li id="c13-li-0021" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1">Within the finalization code implementation, don't access
                        objects that might have been finalized already. The order of finalizers is not guaranteed.<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">
                                    在终结代码实现中，不要访问可能已经被终结的对象。终结器的执行顺序是不确定的。</font>
                            </font>
                        </font>
                    </li>
                    <li id="c13-li-0022" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1">If an object you use implements the <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code>
                        interface, call the <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code> method
                        when the object is no longer needed. In case you're using this object within a method, the <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                        statement or <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                        declaration comes in handy. In case the object is a member of the class, make the class
                        implement <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code> as
                        well.<font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">如果你使用的对象实现了 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code>
                                    接口，当对象不再需要时调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Dispose</code>
                                    方法。如果你在方法中使用该对象， <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                                    语句或 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                                    声明会很有用。如果该对象是类的成员，则让该类也实现 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code>
                                    。</font>
                            </font>
                        </font>
                    </li>
                </ul>
            </section>
        </section>
        <section aria-labelledby="head-2-117" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
            <span id="c13-sec-0025" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
            <h2 id="head-2-117" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1">UNSAFE CODE<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">不安全的代码</font>
                    </font>
                </font>
            </h2>
            <p id="c13-para-0096" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1">As you have just seen, C# is good at hiding much of the basic
                memory management from the developer, thanks to the garbage collector and the use of references.
                However, sometimes you will want direct access to memory. For example, you might want to access a
                function in an external (non-.NET) DLL that requires a pointer to be passed as a parameter (as many
                Windows API functions or native Linux functions do), or possibly for performance reasons. This section
                examines the C# facilities that provide direct access to the content of memory.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">正如你所看到的，C#
                            通过垃圾回收器和引用的使用，很好地隐藏了大部分基本内存管理，但有时你可能需要直接访问内存。例如，你可能需要访问一个外部（非-.NET）DLL
                            中的函数，该函数需要一个指针作为参数传递（就像许多 Windows API 函数或原生 Linux 函数那样），或者出于性能原因。本节将探讨 C# 提供的直接访问内存内容的特性。
                        </font>
                    </font>
                </font>
            </p>
            <section data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span id="c13-sec-0026"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                <h3 id="head-3-254" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Accessing Memory Directly with Pointers <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用指针直接访问内存</font>
                        </font>
                    </font>
                </h3>
                <p id="c13-para-0097" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Although I am introducing <i
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pointers</i> as if they
                    are a new topic, in reality pointers are not new at all. You have been using references freely in
                    your code, and a reference is simply a type-safe pointer. You have already seen how variables that
                    represent objects and arrays actually store the memory address of where the corresponding data (the
                    <i data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">referent</i>) is stored. A
                    pointer is simply a variable that stores the address of something else in the same way as a
                    reference. The <i
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">difference</i> is that C#
                    does not allow you direct access to the address contained in a reference variable. With a reference,
                    the variable is treated syntactically as if it stores the actual content of the referent.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                尽管我似乎在介绍一个新主题——指针，但实际上指针一点也不新。你已经在代码中自由地使用了引用，而引用本质上就是一种类型安全的指针。你已经看到，代表对象和数组的变量实际上存储的是相应数据（被引用对象）的内存地址。指针与引用类似，都是一种存储其他地址的变量。不同之处在于，C#不允许你直接访问引用变量中包含的地址。使用引用时，该变量在语法上被视为存储了被引用对象的实际内容。
                            </font>
                        </font>
                    </font>
                </p>
                <p id="c13-para-0098" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">C# references are designed to make the language simpler to
                    use and to prevent you from inadvertently doing something that corrupts the contents of memory. With
                    a pointer, however, the actual memory address is available to you. This gives you a lot of power to
                    perform new kinds of operations. For example, you can add 4 bytes to the address to examine or even
                    modify whatever data happens to be stored 4 bytes further in memory.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">C#
                                引用设计得让语言更易使用，并防止你无意中做出损坏内存内容的事情。然而，使用指针时，你可以直接获取实际的内存地址。这赋予你执行新类型操作的能力。例如，你可以将地址加 4
                                个字节来检查甚至修改内存中 4 个字节之后存储的任何数据。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">There are two main reasons for using pointers:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用指针有两个主要原因：</font>
                        </font>
                    </font>
                </p>
                <ul class="check" id="c13-list-0007"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <li id="c13-li-0023" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1"><b
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Backward
                            compatibility</b>—Despite all the facilities provided by .NET, it is still possible to call
                        native Windows and Linux API functions, and for some operations, this may be the only way to
                        accomplish your task. These API functions are generally written in C++ or C and often require
                        pointers as parameters. However, in many cases, it is possible to write the <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">DllImport</code>
                        declaration in a way that avoids use of pointers—for example, by using the <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">System.IntPtr</code>
                        class. Many features of .NET itself make use of native APIs.<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">向后兼容性—尽管.NET 提供了各种功能，但仍然可以调用原生
                                    Windows 和 Linux API 函数，对于某些操作，这可能是你完成任务的唯一方法。这些 API 函数通常用 C++或 C
                                    编写，并且经常需要指针作为参数。然而，在许多情况下，可以通过使用类来避免使用指针的方式编写 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">DllImport</code>
                                    声明。.NET 本身的许多功能都使用了原生 API。</font>
                            </font>
                        </font>
                    </li>
                    <li id="c13-li-0024" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1"><b
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Performance</b>—On
                        those occasions when speed is of the utmost importance, pointers can provide a route to
                        optimized performance. If you know what you are doing, you can ensure that data is accessed or
                        manipulated in the most efficient way. However, be aware that more often than not, there are
                        other areas of your code where you can likely make the necessary performance improvements
                        without resorting to using pointers. Try using a code profiler to look for the bottlenecks in
                        your code; Visual Studio includes a code profiler.<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">
                                    性能—在速度最为关键的那些情况下，指针可以提供优化性能的途径。如果你知道自己在做什么，可以确保以最高效的方式访问或操作数据。然而，要注意的是，在大多数情况下，你可以在不使用指针的情况下，在代码的其他地方做出必要的性能改进。尝试使用代码分析器来查找代码中的瓶颈；Visual
                                    Studio 包含一个代码分析器。</font>
                            </font>
                        </font>
                    </li>
                </ul>
                <p id="c13-para-0100" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Low-level memory access has a price. The syntax for using
                    pointers is more complex than that for reference types, and pointers are unquestionably more
                    difficult to use correctly. You need good programming skills and an <span aria-label="350"
                        epub:type="pagebreak" id="Page_350" role="doc-pagebreak"
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>excellent ability
                    to think carefully and logically about what your code is doing to use pointers successfully.
                    Otherwise, it is easy to introduce subtle, difficult-to-find bugs into your program when using
                    pointers. For example, it is easy to overwrite other variables, cause stack overflows, access areas
                    of memory that don't store any variables, or even overwrite information about your code that is
                    needed by the .NET runtime, thereby crashing your program.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                低级内存访问是有代价的。使用指针的语法比引用类型的语法更复杂，而且指针无疑更难正确使用。你需要良好的编程技能和出色的仔细思考及逻辑分析能力，才能成功使用指针。否则，在使用指针时很容易引入难以发现的细微错误到你的程序中。例如，很容易覆盖其他变量，导致栈溢出，访问不存储任何变量的内存区域，甚至覆盖.NET
                                运行时所需的信息，从而崩溃你的程序。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Despite these issues, pointers remain a powerful and flexible
                    tool in the writing of efficient code.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">尽管存在这些问题，指针在编写高效代码时仍然是一个强大而灵活的工具。
                            </font>
                        </font>
                    </font>
                </p>
                <aside data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <div class="top hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <p id="c13-para-0102" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">WARNING</b> <i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">I strongly advise
                                against using pointers unnecessarily because your code will not only be harder to write
                                and debug, but it will also fail the memory type safety checks imposed by the CLR. An
                                example where pointers are necessary is to invoke native APIs.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">警告
                                        我强烈建议不要不必要地使用指针，因为你的代码不仅更难编写和调试，而且还会失败 CLR 强制的内存类型安全检查。指针是必要的例子是调用原生 API。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                            <hr />
                        </div>
                    </section>
                </aside>
            </section>
            <section data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span id="c13-sec-0028"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                <h3 id="head-3-255" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Writing Unsafe Code with the unsafe Keyword <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用 unsafe 关键字编写不安全代码</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">As a result of the risks associated with pointers, C# allows
                    the use of pointers only in blocks of code that you have specifically marked for this purpose. The
                    keyword to do this is <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">unsafe</code>. You can
                    mark an individual method as being <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">unsafe</code> like this:
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                由于指针相关的风险，C#仅允许在您特别标记用于此目的的代码块中使用指针。执行此操作的关键字是 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">unsafe</code>
                                。您可以像这样将单个方法标记为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">unsafe</code>
                                ：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0018"><code>unsafe int GetSomeNumber()</code>
<code>{</code>
<code>  // code that can use pointers</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Any method can be marked as <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">unsafe</code>, regardless
                    of what other modifiers have been applied to it (for example, <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">static</code> methods or
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">virtual</code>
                    methods). In the case of methods, the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">unsafe</code> modifier
                    applies to the method's parameters, allowing you to use pointers as parameters. You can also mark an
                    entire class or struct as <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">unsafe</code>, which
                    means that all its members are assumed unsafe:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">任何方法都可以被标记为 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">unsafe</code>
                                ，无论它已经被应用了哪些其他修饰符（例如 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">static</code>
                                方法或 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">virtual</code>
                                方法）。对于方法来说， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">unsafe</code>
                                修饰符应用于方法的参数，允许你将指针作为参数使用。你也可以将整个类或结构体标记为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">unsafe</code>
                                ，这意味着它的所有成员都被视为不安全：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0019"><code>unsafe class MyClass</code>
<code>{</code>
<code>  // any method in this class can now use pointers</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Similarly, you can mark a member as <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">unsafe</code>
                    :<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">类似地，你可以将一个成员标记为 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">unsafe</code>
                                ：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0020"><code>class MyClass</code>
<code>{</code>
<code>  unsafe int* pX; // declaration of a pointer field in a class</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Or you can mark a block of code within a method as <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">unsafe</code>
                    :<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">或者你可以将方法内部的一块代码标记为 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">unsafe</code>
                                ：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0021"><code>void MyMethod()</code>
<code>{</code>
<code>  // code that doesn't use pointers</code>
<code>  unsafe</code>
<code>  {</code>
<code>    // unsafe code that uses pointers here</code>
<code>  }</code>
<code> </code>
<code>  // more 'safe' code that doesn't use pointers</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">You cannot mark a local variable by itself as <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">unsafe</code>. If you
                    want to use an unsafe local variable, you need to declare and use it inside a method or block that
                    is unsafe. There is one more step before you can use pointers. <span aria-label="351"
                        epub:type="pagebreak" id="Page_351" role="doc-pagebreak"
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>The C# compiler
                    rejects unsafe code unless you tell it that your code includes unsafe blocks. You can configure
                    unsafe code by setting the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">AllowUnsafeBlocks</code>
                    in the <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">csproj</code>
                    project file, as shown here:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">你不能单独将一个局部变量标记为 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">unsafe</code>
                                。如果你想要使用一个不安全的局部变量，需要将其声明和使用在标记为不安全的方法或代码块内部。在使用指针之前，还有一步需要完成。C#
                                编译器会拒绝不安全的代码，除非你告诉它你的代码包含不安全的代码块。你可以通过在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">csproj</code>
                                项目文件中设置 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">AllowUnsafeBlocks</code>
                                来配置不安全的代码，示例如下：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0022"><code>&lt;PropertyGroup&gt;</code>
<code>  <b>&lt;AllowUnsafeBlocks&gt;True&lt;/AllowUnsafeBlocks&gt;</b></code>
<code>&lt;/PropertyGroup&gt;</code></pre>
            </section>
            <section data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span id="c13-sec-0029"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                <h3 id="head-3-256" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Pointer Syntax <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">指针语法</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">After you have marked a block of code as <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">unsafe</code>, you can
                    declare a pointer using the following syntax:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在将代码块标记为 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">unsafe</code>
                                后，您可以使用以下语法声明指针：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0023"><code>int* pWidth, pHeight;</code>
<code>double* pResult;</code>
<code>byte*[] pFlags;</code></pre>
                <p id="c13-para-0109" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">This code declares four variables: <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pWidth</code> and <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pHeight</code> are
                    pointers to integers, <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pResult</code> is a
                    pointer to a <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">double</code>, and <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pFlags</code> is an array
                    of pointers to bytes. It is common practice to use the prefix <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">p</code> in front of
                    names of pointer variables to indicate that they are pointers. When used in a variable declaration,
                    the symbol <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">*</code>
                    indicates that you are declaring a pointer (that is, something that stores the address of a variable
                    of the specified type).<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">这段代码声明了四个变量： <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pWidth</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pHeight</code>
                                是指向整数的指针， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pResult</code>
                                是指向 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">double</code>
                                的指针，而 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pFlags</code>
                                是一个指向字节的指针数组。通常的做法是在指针变量名前加上前缀 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">p</code>
                                来表示它们是指针。在变量声明中使用符号 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">*</code>
                                表示你正在声明一个指针（也就是说，一个存储指定类型变量地址的东西）。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">When you have declared variables of pointer types, you can
                    use them in the same way as normal variables, but first you need to learn two more operators:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                当你声明了指针类型的变量后，你可以像使用普通变量一样使用它们，但首先你需要学习两个更多的运算符：</font>
                        </font>
                    </font>
                </p>
                <ul class="check" id="c13-list-0008"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <li id="c13-li-0025" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1">
                        <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">&amp;</code> means
                        take the address of, and it converts a value data type to a pointer—for example, <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code> to *
                        <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code>. This
                        operator is known as the address operator.<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1"> <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">&amp;</code>
                                    表示取地址，它将一个值数据类型转换为指针—for 例如， <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code>
                                    到 * <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code>
                                    。这个运算符被称为地址运算符。</font>
                            </font>
                        </font>
                    </li>
                    <li id="c13-li-0026" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1">
                        <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">*</code> means get
                        the content of this address and convert a pointer to a value data type—for example, *
                        <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">float</code> to
                        <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">float</code>. This
                        operator is known as the <i
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">indirection</i>
                        operator (or the <i
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">dereference</i>
                        operator).<font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1"> <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">*</code>
                                    表示获取该地址的内容，并将指针转换为值数据类型—for 例如，* <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">float</code>
                                    到 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">float</code>
                                    。这个运算符被称为间接运算符（或解引用运算符）。</font>
                            </font>
                        </font>
                    </li>
                </ul>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">You can see from these definitions that <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">&amp;</code> and <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">*</code> have opposite
                    effects.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">从这些定义中可以看出， <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">&amp;</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">*</code>
                                具有相反的效果。</font>
                        </font>
                    </font>
                </p>
                <aside data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <div class="top hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <p id="c13-para-0112" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">NOTE</b> <i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">You might be
                                wondering how it is possible to use the symbols </i>
                            <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">&amp;</code>
                            <i data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> and </i>
                            <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">*</code>
                            <i data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> in this manner
                                because these symbols also refer to the operators of bitwise </i>
                            <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">AND</code>
                            <i data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> (</i>
                            <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">&amp;</code>
                            <i data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">) and
                                multiplication </i>(<code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">*</code>)<i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">. Actually, it is
                                always possible for both you and the compiler to know what is meant in each case because
                                with the pointer meanings, these symbols always appear as unary operators—they act on
                                only one variable and appear in front of that variable in your code. By contrast,
                                bitwise </i>
                            <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">AND</code>
                            <i data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> multiplication
                                are binary operators—they require two operands.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意 你可能想知道如何以这种方式使用 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">&amp;</code>
                                        和 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">*</code>
                                        这些符号，因为这些符号也指代位运算符 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">AND</code>
                                        ( <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">&amp;</code>
                                        ) 和乘法运算符 ( <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">*</code>
                                        )。实际上，无论对于你还是编译器，都可以始终知道每种情况下的含义，因为对于指针含义来说，这些符号始终作为一元运算符出现——它们只作用于一个变量，并在该变量前出现在你的代码中。相比之下，位运算
                                        <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">AND</code>
                                        乘法是二元运算符——它们需要两个操作数。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                            <hr />
                        </div>
                    </section>
                </aside>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">The following code shows examples of how to use these
                    operators:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">以下代码展示了如何使用这些运算符的示例：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0024"><code>int x = 10;</code>
<code>int* pX, pY;</code>
<code>pX = &amp;x;</code>
<code>pY = pX;</code>
<code>*pY = 20;</code></pre>
                <p id="c13-para-0114" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">You start by declaring an integer, <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">x</code>, with the value
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">10</code> followed by
                    two pointers to integers, <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pX</code> and <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pY</code>. You then set
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pX</code> to point to
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">x</code> (that is, you
                    set the content of <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pX</code> to the address
                    of <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">x</code>). Then you
                    assign the value of <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pX</code> to <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pY</code> so that <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pY</code> also points to
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">x</code>. Finally, in
                    the statement *
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pY</code> = <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">20</code>, you assign the
                    value 20 as the contents of the location pointed to by <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pY</code>
                    —in effect changing <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">x</code> to <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">20</code> because <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pY</code> happens to
                    point to <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">x</code>. Note
                    that there is no particular connection between the variables <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pY</code> and <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">x</code>. It is just that
                    at the present time, <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pY</code> happens to
                    point to the memory location at which <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">x</code> is held.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">你首先声明一个整型变量 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">x</code>
                                ，并赋予其值 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">10</code>
                                ，然后声明两个指向整型的指针 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pX</code> 和
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pY</code>
                                。接着，你将 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pX</code>
                                设置为指向 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">x</code>
                                （即，你将 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pX</code>
                                的内容设置为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">x</code>
                                的地址）。然后，你将 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pX</code>
                                的值赋给 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pY</code> ，使得
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pY</code> 也指向
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">x</code>
                                。最后，在语句 * <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pY</code> =
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">20</code>
                                中，你将值 20 赋给 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pY</code>
                                所指向的内存位置——实际上将 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">x</code> 改变为
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">20</code> ，因为
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pY</code>
                                恰好指向了 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">x</code>
                                。请注意，变量 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pY</code> 和
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">x</code>
                                之间没有特定的关联。只是目前 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pY</code>
                                恰好指向了存储 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">x</code>
                                的内存位置。</font>
                        </font>
                    </font>
                </p>
                <p id="c13-para-0115" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1"><span aria-label="352" epub:type="pagebreak" id="Page_352"
                        role="doc-pagebreak"
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>To get a better
                    understanding of what is going on, consider that the integer <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">x</code> is stored at
                    memory locations <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">0x12F8C4</code> through
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">0x12F8C7</code> (<code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">1243332</code> to <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">1243335</code> in
                    decimal) on the stack (there are four locations because an <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code> occupies 4
                    bytes). Because the stack allocates memory downward, this means that the variables <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pX</code> will be stored
                    at locations <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">0x12F8C0</code> to <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">0x12F8C3</code>, and
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pY</code> will end up
                    at locations <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">0x12F8BC</code> to <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">0x12F8BF</code>. Note
                    that <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pX</code> and
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pY</code> also occupy 4
                    bytes each. That is not because an <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code> occupies 4
                    bytes, but because on a 32-bit application you need 4 bytes to store an address. With these
                    addresses, after executing the previous code, the stack will look like <a href="#c13-fig-0005"
                        id="R_c13-fig-0005"
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Figure 13-5</a>.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">为了更好地理解发生的情况，可以考虑整数 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">x</code>
                                存储在栈的内存位置 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">0x12F8C4</code>
                                到 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">0x12F8C7</code>
                                （十进制的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">1243332</code>
                                到 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">1243335</code>
                                ）（栈中有四个位置，因为一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code> 占用
                                4 字节）。由于栈向下分配内存，这意味着变量 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pX</code>
                                将存储在位置 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">0x12F8C0</code>
                                到 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">0x12F8C3</code>
                                ，而 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pY</code>
                                最终会位于位置 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">0x12F8BC</code>
                                到 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">0x12F8BF</code>
                                。请注意， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pX</code> 和
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pY</code>
                                也各占用 4 字节。这不是因为一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code> 占用
                                4 字节，而是在 32 位应用程序中，你需要 4 字节来存储一个地址。使用这些地址，执行前面的代码后，栈将看起来像图 13-5。</font>
                        </font>
                    </font>
                </p>
                <figure data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> <img
                        alt="Schematic illustration of the execution of a stack operation." class="center"
                        src="images/c13f005.png" />
                    <figcaption data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span
                                class="figureLabel"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><a
                                    href="#R_c13-fig-0005" id="c13-fig-0005" role="doc-backlink"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><b
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                                        data-immersive-translate-paragraph="1">FIGURE 13-5<font
                                            class="notranslate immersive-translate-target-wrapper"
                                            data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                            <font class="notranslate"
                                                data-immersive-translate-translation-element-mark="1">  </font>
                                            <font
                                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                                data-immersive-translate-translation-element-mark="1">
                                                <font
                                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                                    data-immersive-translate-translation-element-mark="1">图 13-5</font>
                                            </font>
                                        </font></b></a></span></p>
                    </figcaption>
                </figure>
                <aside data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <div class="top hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <p id="c13-para-0117" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">NOTE</b> <i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Although this
                                process is illustrated with integers, which are stored consecutively on the stack on a
                                32-bit processor, this does not happen for all data types. The reason is that 32-bit
                                processors work best when retrieving data from memory in 4-byte chunks. Memory on such
                                machines tends to be divided into 4-byte blocks, and each block is sometimes known under
                                Windows as a DWORD because this was the name of a 32-bit unsigned </i> <code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code> <i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> in pre-.NET
                                days. It is most efficient to grab DWORDs from memory—storing data across DWORD
                                boundaries normally results in a hardware performance hit. For this reason, the .NET
                                runtime normally pads out data types so that the memory they occupy is a multiple of 4.
                                For example, a short occupies 2 bytes, but if a short is placed on the stack, the stack
                                pointer will still be decremented by 4, not 2, so the next variable to go on the stack
                                will still start at a DWORD boundary.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意：虽然这个过程是用整数来说明的，在 32
                                        位处理器上，整数是连续存储在栈上的，但这并不适用于所有数据类型。原因是 32 位处理器在以 4
                                        字节块从内存中检索数据时效率最高。在这样的机器上，内存通常被划分为 4 字节的块，每个块在 Windows 下有时被称为 DWORD，因为在.NET
                                        之前的年代，DWORD 是 32 位无符号整数的名称。从内存中获取 DWORD 是最有效的——跨 DWORD 边界存储数据通常会降低硬件性能。因此，.NET
                                        运行时通常会填充数据类型，以确保它们占用的内存是 4 的倍数。例如，一个 short 占用 2 字节，但如果一个 short 被放在栈上，栈指针仍然会减少 4
                                        而不是 2，所以下一个要放在栈上的变量仍然会从 DWORD 边界开始。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                            <hr />
                        </div>
                    </section>
                </aside>
                <p id="c13-para-0118" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">You can declare a pointer to any value type (that is, any of
                    the predefined types <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">uint</code>, <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code>, <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">byte</code>, and so on,
                    or to a struct). However, it is not possible to declare a pointer to a class or an array; this is
                    because doing so could cause problems for the garbage collector. To work properly, the garbage
                    collector needs to know exactly what class instances have been created on the heap, and where they
                    are; but if your code started manipulating classes using pointers, you could easily corrupt the
                    information on the heap concerning classes that the .NET runtime maintains for the garbage
                    collector. In this context, any data type that the garbage collector can access is known as a <i
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">managed type</i>.
                    Pointers can only be declared as <i
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">unmanaged</i> types
                    because the garbage collector cannot deal with them.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">你可以声明指向任何值类型的指针（即预定义类型 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">uint</code> 、
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code> 、
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">byte</code>
                                等或结构体）。然而，无法声明指向类或数组的指针；这是因为这样做可能会给垃圾回收器带来问题。为了让垃圾回收器正常工作，它需要确切知道在堆上创建了哪些类实例以及它们的位置；但如果你的代码开始使用指针操作类，你很容易就会破坏
                                .NET 运行时为垃圾回收器维护的堆上关于类的信息。在这种情况下，垃圾回收器可以访问的任何数据类型都被称为托管类型。指针只能声明为非托管类型，因为垃圾回收器无法处理它们。
                            </font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span id="c13-sec-0032"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                <h3 id="head-3-257" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Casting Pointers to Integer Types <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">将指针转换为整型</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Because a pointer really stores an integer that represents an
                    address, you won't be surprised to know that the address in any pointer can be converted to or from
                    any integer type. Pointer-to-integer-type conversions must be explicit. Implicit conversions are not
                    available for such conversions. For example, it is perfectly legitimate to write the following:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                由于指针实际上存储的是一个表示地址的整数，因此您不会对知道任何指针中的地址都可以转换为或从任何整型转换而感到惊讶。指针到整型的转换必须是显式的。此类转换不支持隐式转换。例如，以下写法完全合法：
                            </font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0025"><code>int x = 10;</code>
<code>int* pX, pY;</code>
<code>pX = &amp;x;</code>
<code>pY = pX;</code>
<code>*pY = 20;</code>
<code>ulong y = (ulong)pX;</code>
<code>int* pD = (int*)y;</code></pre>
                <p id="c13-para-0120" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">The address held in the pointer <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pX</code> is cast to a
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">ulong</code> and stored
                    in the variable <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">y</code>. You have then
                    cast <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">y</code> back to
                    an <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code>
                    * and store it in the new variable <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pD</code>. Hence, now
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pD</code> also points
                    to the value of <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">x</code>.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">指针 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pX</code>
                                中存储的地址被转换为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">ulong</code>
                                并存储在变量 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">y</code>
                                中。然后您将 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">y</code> 转换回
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code> *
                                并将其存储在新变量 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pD</code>
                                中。因此，现在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pD</code> 也指向
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">x</code> 的值。
                            </font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1"><span aria-label="353" epub:type="pagebreak" id="Page_353"
                        role="doc-pagebreak"
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>The primary reason
                    for casting a pointer value to an integer type is to display it. The interpolation string (and
                    similarly <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Console.Write</code>)
                    does not have any overloads that can take pointers, but they do accept and display pointer values
                    that have been cast to integer types:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">将指针值转换为整型的主要原因是显示它。插值字符串（以及类似
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Console.Write</code>
                                的）没有任何重载可以接受指针，但它们确实可以接受并显示已转换为整型的指针值：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0026"><code>WriteLine($"Address is {pX}"); // wrong -- will give a compilation error</code>
<code>WriteLine($"Address is {(ulong)pX}"); // OK</code></pre>
                <p id="c13-para-0122" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">You can cast a pointer to any of the integer types. However,
                    because an address occupies 4 bytes on 32-bit systems, casting a pointer to anything other than a
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">uint</code>, <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">long</code>, or <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">ulong</code> is almost
                    certain to lead to overflow errors. (An <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code> causes
                    problems because its range is from roughly –2 billion to 2 billion, whereas an address runs from
                    zero to about 4 billion.) If you are creating a 64-bit application, you need to cast the pointer to
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">ulong</code>.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">你可以将指针转换为任何整数类型。然而，因为在 32
                                位系统上，一个地址占用 4 个字节，将指针转换为除 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">uint</code> 、
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">long</code> 或
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">ulong</code>
                                以外的任何类型几乎肯定会引发溢出错误。（ <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code>
                                会导致问题，因为它的范围大约在-20 亿到 20 亿之间，而地址的范围从 0 到大约 40 亿。）如果你正在创建一个 64 位应用程序，你需要将指针转换为 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">ulong</code>
                                。</font>
                        </font>
                    </font>
                </p>
                <p id="c13-para-0123" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">It is also important to be aware that the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">checked</code> keyword
                    does not apply to conversions involving pointers. For such conversions, exceptions are not raised
                    when overflows occur, even in a <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">checked</code> context.
                    The .NET runtime assumes that if you are using pointers, you know what you are doing and are not
                    worried about possible overflows.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">还需要注意的是， <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">checked</code>
                                关键字不适用于涉及指针的转换。对于此类转换，即使在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">checked</code>
                                上下文中，即使发生溢出也不会引发异常。.NET 运行时假设如果你使用指针，你知道自己在做什么，并且不担心可能的溢出。</font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span id="c13-sec-0033"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                <h3 id="head-3-258" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Casting Between Pointer Types <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">指针类型之间的转换</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">You can also explicitly convert between pointers pointing to
                    different types. For example, the following is perfectly legal code:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                你也可以显式地在指向不同类型的指针之间进行转换。例如，以下代码完全合法：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0027"><code>byte aByte = 8;</code>
<code>byte* pByte= &amp;aByte;</code>
<code>double* pDouble = (double*)pByte;</code></pre>
                <p id="c13-para-0125" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">However, if you try something like this, be careful. In this
                    example, if you look at the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">double</code> value
                    pointed to by <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pDouble</code>, you are
                    actually looking up some memory that contains a <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">byte</code> (<code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">aByte</code>), combined
                    with some other memory, and treating it as if this area of memory contained a <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">double</code>, which does
                    not give you a meaningful value. However, you might want to convert between types to implement the
                    equivalent of a C <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">union</code>, or you
                    might want to cast pointers from other types into pointers to <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">sbyte</code> to examine
                    individual bytes of memory.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">然而，如果你尝试这样做，请小心。在这个例子中，如果你查看由
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pDouble</code>
                                指向的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">double</code>
                                值，你实际上是在查找一些包含 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">byte</code> （
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">aByte</code>
                                ）的内存，并结合其他内存，将其视为包含 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">double</code>
                                的内存区域，这并不能给你一个有意义的值。但是，你可能需要转换类型来实现 C 语言中的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">union</code>
                                功能，或者你可能需要将其他类型的指针转换为指向 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">sbyte</code>
                                的指针，以检查内存中的单个字节。</font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span id="c13-sec-0034"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                <h3 id="head-3-259" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">void Pointers <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">空指针</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">If you want to maintain a pointer but not specify to what
                    type of data it points, you can declare it as a pointer to a <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">void</code>
                    :<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                如果你想保留一个指针但不指定它指向哪种类型的数据，你可以将其声明为指向 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">void</code>
                                的指针：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0028"><code>int x = 10;</code>
<code>int* pointerToInt = &amp;x;</code>
<code>void* pointerToVoid;</code>
<code>pointerToVoid = (void*)pointerToInt;</code></pre>
                <p id="c13-para-0127" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">The main use of this is if you need to call an API function
                    that requires <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">void</code>
                    * parameters. Within the C# language, there isn't a great deal that you can do using <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">void</code> pointers. In
                    particular, the compiler flags an error if you attempt to de-reference a <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">void</code> pointer using
                    the <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">*</code> operator.
                    You can cast the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">void*</code> into some
                    other pointer type and then use it with other scenarios.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">这种用法的主要场景是当你需要调用一个要求 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">void</code>
                                *参数的 API 函数时。在 C#语言中，使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">void</code>
                                指针并没有太多实际用途。特别是，如果你尝试使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">*</code>
                                运算符取消引用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">void</code>
                                指针，编译器会报错。你可以将 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">void*</code>
                                强制转换为其他指针类型，然后在其他场景中使用它。</font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span id="c13-sec-0035"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                <h3 id="head-3-260" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Pointer Arithmetic <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">指针算术</font>
                        </font>
                    </font>
                </h3>
                <p id="c13-para-0128" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">It is possible to add or subtract integers to and from
                    pointers. However, the compiler is quite clever about how it arranges this. For example, suppose
                    that you have a pointer to an <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code>, and you try
                    to add 1 to its value. The compiler assumes that you actually mean you want to look at the memory
                    location following the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code>, and hence it
                    increases the value by 4 bytes—the size of an <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code>. If it is a
                    pointer to a <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">double</code>, adding 1
                    actually increases the value of the pointer by 8 bytes, the size of a <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">double</code>. Only if
                    the pointer points to a <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">byte</code> or <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">sbyte</code> (1 byte
                    each) does adding 1 to the value of the pointer actually change its value by 1.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                可以将整数加到或从指针中减去。然而，编译器对此如何安排非常聪明。例如，假设你有一个指向 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code>
                                的指针，并尝试将其值加 1。编译器认为你实际上想要查看 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code>
                                之后的内存位置，因此它将值增加 4 字节——即 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code>
                                的大小。如果它是指向 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">double</code>
                                的指针，则加 1 实际上会使指针的值增加 8 字节，即 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">double</code>
                                的大小。只有当指针指向 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">byte</code> 或
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">sbyte</code>
                                （每个 1 字节）时，将 1 加到指针的值上才会实际改变其值 1。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1"><span aria-label="354" epub:type="pagebreak" id="Page_354"
                        role="doc-pagebreak"
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>You can use the
                    operators +, <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">−</code>,
                    +=, <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">−</code>
                    =, ++, and <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">−−</code>
                    with pointers, with the variable on the right side of these operators being a <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">long</code> or <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">ulong</code>.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">你可以使用 +、 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">−</code> 、+=、
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">−</code> =、++
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">−−</code>
                                这些运算符与指针一起使用，这些运算符右侧的变量是 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">long</code> 或
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">ulong</code>
                                。</font>
                        </font>
                    </font>
                </p>
                <aside data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <div class="top hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <p id="c13-para-0130" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">NOTE</b> <i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">You may not carry
                                out arithmetic operations on void pointers. You need to cast the </i>
                            <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">void</code>
                            <i data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> pointer to other
                                pointer types, and then you can perform pointer arithmetic.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意 你不能对 void 指针执行算术运算。你需要将
                                        <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">void</code>
                                        指针转换为其他指针类型，然后才能执行指针运算。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                            <hr />
                        </div>
                    </section>
                </aside>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">For example, assume the following definitions:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">例如，假设以下定义：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0029"><code>uint u = 3;</code>
<code>byte b = 8;</code>
<code>double d = 10.0;</code>
<code>uint* pUint= &amp;u; // size of a uint is 4</code>
<code>byte* pByte = &amp;b; // size of a byte is 1</code>
<code>double* pDouble = &amp;d; // size of a double is 8</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Next, assume the addresses to which these pointers point are
                    as follows:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">接下来，假设这些指针指向的地址如下：</font>
                        </font>
                    </font>
                </p>
                <ul class="check" id="c13-list-0009"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <li id="c13-li-0027" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pUint</code>
                        : <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">1243332</code>
                    </li>
                    <li id="c13-li-0028" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pByte</code>
                        : <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">1243328</code>
                    </li>
                    <li id="c13-li-0029" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pDouble</code>
                        : <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">1243320</code>
                    </li>
                </ul>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Then execute this code:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">然后执行这段代码：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0030"><code>++pUint; // adds (1*4) = 4 bytes to pUint</code>
<code>pByte -= 3; // subtracts (3*1) = 3 bytes from pByte</code>
<code>double* pDouble2 = pDouble + 4; // pDouble2 = pDouble + 32 bytes (4*8 bytes)</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">The pointers now contain this:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">指针现在包含以下内容：</font>
                        </font>
                    </font>
                </p>
                <ul class="check" id="c13-list-0010"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <li id="c13-li-0030" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pUint</code>
                        : <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">1243336</code>
                    </li>
                    <li id="c13-li-0031" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pByte</code>
                        : <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">1243325</code>
                    </li>
                    <li id="c13-li-0032" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pDouble2</code>
                        : <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">1243352</code>
                    </li>
                </ul>
                <aside data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <div class="top hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <p id="c13-para-0135" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">NOTE</b> <i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">The general rule
                                is that adding a number </i>
                            <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">X</code>
                            <i data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> to a pointer to
                                type </i>
                            <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">T</code>
                            <i data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> with value </i>
                            <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">P</code>
                            <i data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> gives the result
                            </i>
                            <code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">P + X*(sizeof(T))</code>
                            <i data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">. If successive
                                values of a given type are stored in successive memory locations, pointer addition works
                                very well, allowing you to move pointers between memory locations. If you are dealing
                                with types such as </i>
                            <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">byte</code>
                            <i data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> or </i>
                            <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">char</code>
                            <i data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">, though, with
                                sizes not in multiples of 4, successive values will not, by default, be stored in
                                successive memory locations.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意：通常情况下，将数字 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">X</code>
                                        加到类型为 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">T</code>
                                        、值为 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">P</code>
                                        的指针上会得到结果 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">P + X*(sizeof(T))</code>
                                        。如果同一类型的连续值存储在连续的内存位置中，指针加法会非常有效，允许你在内存位置之间移动指针。但如果你处理的是类型为 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">byte</code>
                                        或 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">char</code>
                                        的数据，这些类型的大小不是 4 的倍数，那么连续的值默认不会存储在连续的内存位置中。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                            <hr />
                        </div>
                    </section>
                </aside>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">You can also subtract one pointer from another pointer if
                    both pointers point to the same data type. In this case, the result is a <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">long</code> whose value
                    is given by the difference between the pointer values divided by the size of the type that they
                    represent:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                你还可以从一个指针减去另一个指针，前提是两个指针指向相同的数据类型。在这种情况下，结果是数字 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">long</code>
                                ，其值由指针值之差除以它们所代表类型的尺寸给出：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0031"><code>double* pD1 = (double*)1243324; // note that it is perfectly valid to</code>
<code>// initialize a pointer like this.</code>
<code>double* pD2 = (double*)1243300;</code>
<code>long L = pD1-pD2; // gives the result 3 (=24/sizeof(double))</code></pre>
            </section> <span aria-label="355" epub:type="pagebreak" id="Page_355" role="doc-pagebreak"
                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
            <section data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span id="c13-sec-0038"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                <h3 id="head-3-261" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">The sizeof Operator <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">sizeof 运算符</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">This section has been referring to the size of various data
                    types. If you need to use the size of a type in your code, you can use the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">sizeof</code> operator,
                    which takes the name of a data type as a parameter and returns the number of bytes occupied by that
                    type, as shown in this example:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                本节已涉及各种数据类型的大小。如果你需要在代码中使用某个类型的大小，可以使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">sizeof</code>
                                运算符，它以数据类型的名称作为参数，并返回该类型所占用的字节数，如本例所示：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0032"><code>int x = sizeof(double);</code></pre>
                <p id="c13-para-0138" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">This sets <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">x</code> to the value
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">8</code>.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">这设置了 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">x</code> 的值为
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">8</code> 。
                            </font>
                        </font>
                    </font>
                </p>
                <p id="c13-para-0139" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">The advantage of using <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">sizeof</code> is that you
                    don't have to hard-code data type sizes in your code, which makes your code more portable. A <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">byte</code> (or <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">sbyte</code>) has the
                    size of 1 byte, <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">sizeof(short)</code>
                    returns 2, an <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code> has the length
                    of 4 bytes, and a <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">long</code> 8 bytes. You
                    can also use <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">sizeof</code> for structs
                    that you define yourself, although, in that case, the result depends on what fields are in the
                    struct. You cannot use <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">sizeof</code> for
                    classes.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">sizeof</code>
                                的优势在于你无需在代码中硬编码数据类型大小，这使得你的代码更具可移植性。一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">byte</code>
                                （或 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">sbyte</code>
                                ）的大小为 1 字节， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">sizeof(short)</code>
                                返回 2，一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code> 有
                                4 字节长度，而一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">long</code> 有
                                8 字节。你也可以使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">sizeof</code>
                                来定义你自己的结构体，尽管在这种情况下，结果取决于结构体中包含的字段。你不能使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">sizeof</code>
                                来定义类。</font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span id="c13-sec-0039"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                <h3 id="head-3-262" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Pointers to Structs: The Pointer Member Access Operator <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">结构体指针：指针成员访问运算符</font>
                        </font>
                    </font>
                </h3>
                <p id="c13-para-0140" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Pointers to structs work in exactly the same way as pointers
                    to the predefined value types. There is, however, one condition: the struct must not contain any
                    reference types. This is due to the restriction mentioned earlier that pointers cannot point to any
                    reference types. To avoid this, the compiler flags an error if you create a pointer to any struct
                    that contains any reference types.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                结构体指针的工作方式与预定义值类型的指针完全相同。然而，有一个条件：结构体不能包含任何引用类型。这是由于前面提到的限制，即指针不能指向任何引用类型。为了避免这种情况，如果创建了一个包含任何引用类型的结构体指针，编译器会报错。
                            </font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Suppose that you had a struct defined like this:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">假设你有一个结构体定义如下：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0033"><code>struct MyStruct</code>
<code>{</code>
<code>  public long X;</code>
<code>  public float F;</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">You could define a pointer to it as follows:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">你可以这样定义指向它的指针：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0034"><code>MyStruct* pStruct;</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Then you could initialize it like this:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">然后你可以这样初始化它：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0035"><code>MyStruct myStruct = new();</code>
<code>pStruct = &amp;myStruct;</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">It is also possible to access member values of a struct
                    through the pointer:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">你也可以通过指针访问结构体的成员值：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0036"><code>(*pStruct).X = 4;</code>
<code>(*pStruct).F = 3.4f;</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">However, this syntax is a bit complex. For this reason, C#
                    defines another operator that enables you to access members of structs through pointers using a
                    simpler syntax. It is known as the <i
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pointer member access
                        operator</i>, and the symbol is a dash followed by a greater-than sign, so it looks like an
                    arrow: <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">-&gt;</code>.
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                然而这种语法有点复杂。因此，C#定义了另一个操作符，它允许你使用更简单的语法通过指针访问结构体的成员。这个操作符被称为指针成员访问操作符，符号是一个短横线后跟一个大于号，看起来像箭头：
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">-&gt;</code>
                                。</font>
                        </font>
                    </font>
                </p>
                <aside data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <div class="top hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <p id="c13-para-0146" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">NOTE</b> <i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">C++ developers
                                will recognize the pointer member access operator because C++ also uses the symbol for
                                this purpose.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意 C++ 开发者会认出指针成员访问运算符，因为
                                        C++ 也使用该符号来达到这个目的。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                            <hr />
                        </div>
                    </section>
                </aside>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Using the pointer member access operator, the previous code
                    can be rewritten like this:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用指针成员访问运算符，之前的代码可以重写为如下形式：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0037"><code>pStruct-&gt;X = 4;</code>
<code>pStruct-&gt;F = 3.4f;</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1"><span aria-label="356" epub:type="pagebreak" id="Page_356"
                        role="doc-pagebreak"
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>You can also
                    directly set up pointers of the appropriate type to point to fields within a struct,<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">你也可以直接设置适当类型的指针指向结构体中的字段，</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0038"><code>long* pL = &amp;(myStruct.X);</code>
<code>float* pF = &amp;(myStruct.F);</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">or,<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">或者，</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0039"><code>long* pL = &amp;(pStruct-&gt;X);</code>
<code>float* pF = &amp;(pStruct-&gt;F);</code></pre>
            </section>
            <section data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span id="c13-sec-0041"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                <h3 id="head-3-263" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Pointers to Class Members <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">指向类成员</font>
                        </font>
                    </font>
                </h3>
                <p id="c13-para-0150" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">As indicated earlier, it is not possible to create pointers
                    to classes. That is because the garbage collector does not maintain any information about
                    pointers—only about references—so creating pointers to classes could cause garbage collection not to
                    work properly.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                如前所述，无法创建指向类的指针。这是因为垃圾回收器不维护任何关于指针的信息——仅维护关于引用的信息——因此创建指向类的指针可能会导致垃圾回收无法正常工作。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">However, most classes contain value type members, and you
                    might want to create pointers to them. This is possible, but it requires a special syntax. For
                    example, suppose that you rewrite the struct from the previous example as a class:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                然而，大多数类包含值类型成员，你可能想要创建指向它们的指针。这是可能的，但需要特殊的语法。例如，假设你将前一个示例中的结构体重写为类：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0040"><code>class MyClass</code>
<code>{</code>
<code>  public long X;</code>
<code>  public float F;</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Then you might want to create pointers to its fields, <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">X</code> and <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">F</code>, in the same way
                    as you did earlier. Unfortunately, doing so produces a compilation error:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">然后你可能需要像之前那样创建指向其字段的指针 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">X</code> 和
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">F</code>
                                。不幸的是，这样做会产生编译错误：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0041"><code>MyClass myObject = new();</code>
<code>long* pL = &amp;(myObject.X); // wrong -- compilation error</code>
<code>float* pF = &amp;(myObject.F); // wrong -- compilation error</code></pre>
                <p id="c13-para-0153" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Although <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">X</code> and <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">F</code> are unmanaged
                    types, they are embedded in an object, which sits on the heap. During garbage collection, the
                    garbage collector might move <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">MyObject</code> to a new
                    location, which would leave <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pL</code> and <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pF</code> pointing to the
                    wrong memory addresses. Because of this, the compiler does not let you assign addresses of members
                    of managed types to pointers in this manner.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">虽然 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">X</code> 和
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">F</code>
                                是未管理类型，但它们嵌套在对象中，而该对象位于堆上。在垃圾回收过程中，垃圾回收器可能会将 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">MyObject</code>
                                移动到新位置，这将导致 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pL</code> 和
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pF</code>
                                指向错误的内存地址。由于这个原因，编译器不允许以这种方式将管理类型的成员地址赋值给指针。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">The solution is to use the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">fixed</code> keyword,
                    which tells the garbage collector that there may be pointers referencing members of certain objects,
                    so those objects must not be moved. The syntax for using <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">fixed</code> looks like
                    this when you want to declare only one pointer:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">解决方案是使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">fixed</code>
                                关键字，它告诉垃圾回收器可能存在指向某些对象成员的指针，因此这些对象不能被移动。当你只想声明一个指针时，使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">fixed</code>
                                的语法如下：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0042"><code>MyClass myObject = new();</code>
<code>fixed (long* pObject = &amp;(myObject.X))</code>
<code>{</code>
<code>  // do something</code>
<code>}</code></pre>
                <p id="c13-para-0155" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">You define and initialize the pointer variable in the
                    brackets following the keyword <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">fixed</code>. This
                    pointer variable (<code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pObject</code> in the
                    example) is scoped to the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">fixed</code> block
                    identified by the curly braces. As a result, the garbage collector knows not to move the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">myObject</code> object
                    while the code inside the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">fixed</code> block is
                    executing.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">你需要在 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">fixed</code>
                                关键字后面的括号中定义和初始化指针变量。这个指针变量（示例中的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pObject</code>
                                ）的作用域限定在由花括号标识的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">fixed</code>
                                块内。因此，垃圾回收器知道在执行 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">fixed</code>
                                块内的代码时不会移动 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">myObject</code>
                                对象。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">If you want to declare more than one pointer, you can place
                    multiple <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">fixed</code>
                    statements before the same code block:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">如果你想声明多个指针，你可以在相同的代码块之前放置多个 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">fixed</code>
                                语句：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0043"><code>MyClass myObject = new();</code>
<code>fixed (long* pX = &amp;(myObject.X))</code>
<code>fixed (float* pF = &amp;(myObject.F))<span aria-label="357" epub:type="pagebreak" id="Page_357" role="doc-pagebreak"></span></code>
<code>{</code>
<code>  // do something</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">You can nest entire <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">fixed</code> blocks if
                    you want to fix several pointers for different periods:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">如果你想要为不同时期固定多个指针，你可以嵌套整个 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">fixed</code>
                                块：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0044"><code>MyClass myObject = new();</code>
<code>fixed (long* pX = &amp;(myObject.X))</code>
<code>{</code>
<code>  // do something with pX</code>
<code>  fixed (float* pF = &amp;(myObject.F))</code>
<code>  {</code>
<code>    // do something else with pF</code>
<code>  }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">You can also initialize several variables within the same
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">fixed</code> block, if
                    they are of the same type:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">如果你在同一 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">fixed</code>
                                块内初始化多个变量，且它们类型相同，这也是可以的：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0045"><code>MyClass myObject = new();</code>
<code>MyClass myObject2 = new();</code>
<code>fixed (long* pX = &amp;(myObject.X), pX2 = &amp;(myObject2.X))</code>
<code>{</code>
<code>  //…</code>
<code>}</code></pre>
                <p id="c13-para-0159" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">In all these cases, it is immaterial whether the various
                    pointers you are declaring point to fields in the same or different objects or to static fields not
                    associated with any class instance.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                在所有这些情况下，你声明的各种指针指向相同或不同对象的字段，或指向与任何类实例无关的静态字段，这都无关紧要。</font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span id="c13-sec-0042"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                <h3 id="head-3-264" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Pointer Example: PointerPlayground <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">指针示例：PointerPlayground</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">For understanding pointers, it's best to write a program
                    using pointers and to use the debugger. The following code snippet is from an example named <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">PointerPlayground</code>.
                    It does some simple pointer manipulation and displays the results, enabling you to see what is
                    happening in memory and where variables are stored (code file <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">PointerPlayground/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                理解指针的最佳方式是编写一个使用指针的程序并使用调试器。以下代码片段来自一个名为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">PointerPlayground</code>
                                的示例。它进行一些简单的指针操作并显示结果，使你能够看到内存中的情况以及变量存储的位置（代码文件 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">PointerPlayground/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0046"><code>unsafe static void Main()</code>
<code>{</code>
<code>  int a = 10;</code>
<code>  short b = -1;</code>
<code>  byte c = 4;</code>
<code>  float d = 1.5F;</code>
<code>  int* pa = &amp;a;</code>
<code>  short* pb = &amp;b;</code>
<code>  byte* pc = &amp;c;</code>
<code>  float* pd = &amp;d;</code>
<code> </code>
<code>  Console.WriteLine($"Address of a is 0x{(ulong)&amp;a:X}, " +</code>
<code>    $"size is {sizeof(int)}, value is {a}");</code>
<code>  Console.WriteLine($"Address of b is 0x{(ulong)&amp;b:X}, " +</code>
<code>    $"size is {sizeof(short)}, value is {b}");</code>
<code>  Console.WriteLine($"Address of c is 0x{(ulong)&amp;c:X}, " +</code>
<code>    $"size is {sizeof(byte)}, value is {c}");</code>
<code>  Console.WriteLine($"Address of d is 0x{(ulong)&amp;d:X}, " +</code>
<code>    $"size is {sizeof(float)}, value is {d}");</code>
<code>  Console.WriteLine($"Address of pa=&amp;a is 0x{(ulong)&amp;pa:X}, " +</code>
<code>    $"size is {sizeof(int*)}, value is 0x{(ulong)pa:X}");<span aria-label="358" epub:type="pagebreak" id="Page_358" role="doc-pagebreak"></span></code>
<code>  Console.WriteLine($"Address of pb=&amp;b is 0x{(ulong)&amp;pb:X}, " +</code>
<code>    $"size is {sizeof(short*)}, value is 0x{(ulong)pb:X}");</code>
<code>  Console.WriteLine($"Address of pc=&amp;c is 0x{(ulong)&amp;pc:X}, " +</code>
<code>    $"size is {sizeof(byte*)}, value is 0x{(ulong)pc:X}");</code>
<code>  Console.WriteLine($"Address of pd=&amp;d is 0x{(ulong)&amp;pd:X}, " +</code>
<code>    $"size is {sizeof(float*)}, value is 0x{(ulong)pd:X}");</code>
<code> </code>
<code>  *pa = 20;</code>
<code>  Console.WriteLine($"After setting *pa, a = {a}");</code>
<code>  Console.WriteLine($"*pa = {*pa}");</code>
<code> </code>
<code>  pd = (float*)pa;</code>
<code>  Console.WriteLine($"a treated as a float = {*pd}");</code>
<code> </code>
<code>  Console.ReadLine();</code>
<code>}</code></pre>
                <p id="c13-para-0161" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">This code declares four value variables: <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int a</code>, <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">short b</code>, <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">byte c</code>, <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">float d</code>. Also, it
                    declares four pointers of these values: <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pa</code>, <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pb</code>, <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pc</code>, and <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pd</code>.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">这段代码声明了四个值变量： <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int a</code>
                                、 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">short b</code>
                                、 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">byte c</code>
                                、 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">float d</code>
                                。此外，它还声明了这四个值的四个指针： <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pa</code> 、
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pb</code> 、
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pc</code> 和
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pd</code> 。
                            </font>
                        </font>
                    </font>
                </p>
                <p id="c13-para-0162" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Next, you display the values of these variables as well as
                    their sizes and addresses. Note that in taking the addresses of <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pa</code>, <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pb</code>, <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pc</code>, and <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pd</code>, you are
                    effectively looking at a pointer <i
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">to</i> a pointer—an
                    address of an address of a value. Also, in accordance with the usual practice when displaying
                    addresses, you have used the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">{0:X}</code> format
                    specifier in the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">WriteLine</code> commands
                    to ensure that memory addresses are displayed in hexadecimal format.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">接下来，你显示这些变量的值以及它们的大小和地址。注意在获取
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pa</code> 、
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pb</code> 、
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pc</code> 和
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pd</code>
                                的地址时，你实际上是在查看一个指向指针的指针——一个值的地址的地址。此外，根据显示地址的常规做法，你在 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">WriteLine</code>
                                命令中使用了 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">{0:X}</code>
                                格式说明符，以确保内存地址以十六进制格式显示。</font>
                        </font>
                    </font>
                </p>
                <p id="c13-para-0163" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Finally, you use the pointer <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pa</code> to change the
                    value of <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">a</code> to
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">20</code> and do some
                    pointer casting to see what happens if you try to treat the content of <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">a</code> as if it were a
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">float</code>, with the
                    same number of bytes but a different memory representation.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">最后，你使用指针 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pa</code> 将
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">a</code> 的值改为
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">20</code>
                                ，并进行一些指针强制转换，看看如果你尝试将 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">a</code>
                                的内容当作一个具有相同字节数但不同内存表示的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">float</code>
                                来处理会发生什么。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Compiling and running this code results in the following
                    output:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">编译并运行此代码会产生以下输出：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0047"><code>Address of a is 0x565DD7E53C, size is 4, value is 10</code>
<code>Address of b is 0x565DD7E538, size is 2, value is -1</code>
<code>Address of c is 0x565DD7E534, size is 1, value is 4</code>
<code>Address of d is 0x565DD7E530, size is 4, value is 1.5</code>
<code>Address of pa=&amp;a is 0x565DD7E528, size is 8, value is 0x565DD7E53C</code>
<code>Address of pb=&amp;b is 0x565DD7E520, size is 8, value is 0x565DD7E538, diff -4</code>
<code>Address of pc=&amp;c is 0x565DD7E518, size is 8, value is 0x565DD7E534, diff -4</code>
<code>Address of pd=&amp;d is 0x565DD7E510, size is 8, value is 0x565DD7E530, diff -4</code>
<code>After setting *pa, a = 20</code>
<code>*pa = 20</code>
<code>a treated as a float = 2.8E-44</code></pre>
                <aside data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <div class="top hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <p id="c13-para-0166" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">NOTE</b> <i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">With the new .NET
                                runtime, different addresses are shown every time you run the application.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意：使用新的 .NET
                                        运行时，每次运行应用程序时都会显示不同的地址。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                            <hr />
                        </div>
                    </section>
                </aside>
                <p id="c13-para-0167" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Checking through these results confirms the description of
                    how the stack operates presented in the “Memory Management Under the Hood” section earlier in this
                    chapter. It allocates successive variables moving downward in memory. Notice how it also confirms
                    that blocks of memory on the stack are always allocated in multiples of 4 or 8 bytes. For example,
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">b</code> is a <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">short</code> (of size 2)
                    and has the (hex) address <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">0x565DD7E538</code>,
                    indicating that the memory locations reserved for it are locations <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">0x565DD7E538</code>
                    through <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">0x565DD7E53B</code>. If
                    the .NET runtime had been strictly packing up variables next to each other, <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">b</code> would have
                    occupied just two locations, <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">0x565DD7E538</code> and
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">0x565DD7E539</code>.
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                通过检查这些结果，可以确认本章前面“内存管理底层”部分中描述的栈操作方式。它按内存向下分配连续的变量。注意它还确认了栈上的内存块总是以 4 或 8 字节为倍数分配。例如，
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">b</code> 是一个
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">short</code>
                                （大小为 2），其（十六进制）地址为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">0x565DD7E538</code>
                                ，表明为其保留的内存位置是 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">0x565DD7E538</code>
                                到 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">0x565DD7E53B</code>
                                。如果 .NET 运行时严格将变量紧挨着打包， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">b</code>
                                将只占用两个位置， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">0x565DD7E538</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">0x565DD7E539</code>
                                。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1"><span aria-label="359" epub:type="pagebreak" id="Page_359"
                        role="doc-pagebreak"
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>The next example
                    illustrates pointer arithmetic, as well as pointers to structs and class members. This example is
                    named <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">PointerPlayground2</code>.
                    To start, you define a struct named <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CurrencyStruct</code>,
                    which represents a currency value as dollars and cents. You also define an equivalent class named
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CurrencyClass</code>
                    (code file <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">PointerPlayground2/Currency.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">下一个示例说明了指针算术以及指向结构和类成员的指针。此示例名为
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">PointerPlayground2</code>
                                。首先，你定义一个名为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CurrencyStruct</code>
                                的结构体，它表示以美元和美分形式表示的货币值。你还定义了一个等效的类名为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CurrencyClass</code>
                                （代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">PointerPlayground2/Currency.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0048"><code>internal struct CurrencyStruct</code>
<code>{</code>
<code>  public CurrencyStruct(long dollars, byte cents) </code>
<code>    =&gt; (Dollars, Cents) = (dollars, cents);</code>
<code> </code>
<code>  public readonly long Dollars;</code>
<code>  public readonly byte Cents;</code>
<code>  public override string ToString() =&gt; $"$ {Dollars}.{Cents}";</code>
<code>}</code>
<code> </code>
<code>internal class CurrencyClass</code>
<code>{</code>
<code>  public CurrencyClass(long dollars, byte cents) </code>
<code>    =&gt; (Dollars, Cents) = (dollars, cents);</code>
<code> </code>
<code>  public readonly long Dollars = 0;</code>
<code>  public readonly byte Cents = 0;</code>
<code>  public override string ToString() =&gt; $"$ {Dollars}.{Cents}";</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Now that you have your struct and class defined, you can
                    apply some pointers to them. The following is the code for the new example. Because the code is
                    fairly long, I'm going through it in pieces. You start by displaying the size of <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CurrencyStruct</code>,
                    creating a couple of <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CurrencyStruct</code>
                    instances and some <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CurrencyStruct</code>
                    pointers. You use the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pAmount</code> pointer to
                    initialize the members of the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">amount1 CurrencyStruct</code>
                    and then display the addresses of your variables (code file <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">PointerPlayground2/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">现在你已经定义了你的 struct 和
                                class，可以应用一些指针到它们上。以下是新示例的代码。由于代码比较长，我将分段进行讲解。你首先显示 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CurrencyStruct</code>
                                的大小，创建几个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CurrencyStruct</code>
                                实例和一些 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CurrencyStruct</code>
                                指针。你使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pAmount</code>
                                指针来初始化 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">amount1 CurrencyStruct</code>
                                的成员，然后显示你的变量的地址（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">PointerPlayground2/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0049"><code>unsafe static void Main()</code>
<code>{</code>
<code>  Console.WriteLine($"Size of CurrencyStruct struct is " +   </code>
<code>    $"{sizeof(CurrencyStruct)}");</code>
<code>  CurrencyStruct amount1 = new(10, 10), amount2 = new(20, 20);</code>
<code>  CurrencyStruct* pAmount = &amp;amount1;</code>
<code>  long* pDollars = &amp;(pAmount-&gt;Dollars);</code>
<code>  byte* pCents = &amp;(pAmount-&gt;Cents);</code>
<code> </code>
<code> </code>
<code>  Console.WriteLine($"Address of amount1 is 0x{(ulong)&amp;amount1:X}");</code>
<code>  Console.WriteLine($"Address of amount2 is 0x{(ulong)&amp;amount2:X}");</code>
<code>  Console.WriteLine($"Address of pAmount is 0x{(ulong)&amp;pAmount:X}");</code>
<code>  Console.WriteLine($"Value of pAmount is 0x{(ulong)pAmount:X}");</code>
<code>  Console.WriteLine($"Address of pDollars is 0x{(ulong)&amp;pDollars:X}");</code>
<code>  Console.WriteLine($"Value of pDollars is 0x{(ulong)pDollars:X}");</code>
<code>  Console.WriteLine($"Address of pCents is 0x{(ulong)&amp;pCents:X}");</code>
<code>  Console.WriteLine($"Value of pCents is 0x{(ulong)pCents:X}");</code>
<code> </code>
<code>  // because Dollars are declared readonly in CurrencyStruct, you cannot change it </code>
<code>  // with a variable of type CurrencyStruct</code>
<code>  // pAmount-&gt;Dollars = 20;</code>
<code>  // but you can change it via a pointer referencing the memory address!</code>
<code>  *pDollars = 100;<span aria-label="360" epub:type="pagebreak" id="Page_360" role="doc-pagebreak"></span></code>
<code>  Console.WriteLine($"amount1 contains {amount1}");</code>
<code>  //…</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Now you do some pointer manipulation that relies on your
                    knowledge of how the stack works. Because of the order in which the variables were declared, you
                    know that <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">amount2</code> will be
                    stored at an address immediately below <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">amount1</code>. The <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">sizeof(CurrencyStruct)</code>
                    operator returns <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">16</code> (as
                    demonstrated in the upcoming screen output), so <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CurrencyStruct</code>
                    occupies a multiple of 4 bytes. Therefore, after you decrement your currency pointer, it points to
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">amount2</code>
                    :<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                现在你进行一些依赖于你对栈工作原理的了解的指针操作。由于变量声明的顺序，你知道 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">amount2</code>
                                将存储在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">amount1</code>
                                地址的下方。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">sizeof(CurrencyStruct)</code>
                                运算符返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">16</code>
                                （如接下来的屏幕输出所示），所以 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CurrencyStruct</code>
                                占据 4 字节的倍数。因此，在你递减你的货币指针后，它指向 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">amount2</code>
                                ：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0050"><code>--pAmount; // this should get it to point to amount2</code>
<code>Console.WriteLine($"amount2 has address 0x{(ulong)pAmount:X} " +</code>
<code>  $"and contains {*pAmount}");</code></pre>
                <p id="c13-para-0171" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Only you know that, because your knowledge of the stack means
                    you can tell what the effect of decrementing <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pAmount</code> will be.
                    After you start doing pointer arithmetic, you will find that you can access all sorts of variables
                    and memory locations that the compiler would usually stop you from accessing, hence the description
                    of pointer arithmetic as unsafe.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">只有你知道这一点，因为你的栈知识意味着你可以知道递减 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pAmount</code>
                                的效果。当你开始进行指针运算时，你会发现你可以访问编译器通常禁止你访问的各种变量和内存位置，这就是指针运算被描述为不安全的原因。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Next, you do some pointer arithmetic on your <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pCents</code> pointer.
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pCents</code> currently
                    points to <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">amount1.Cents</code>, but
                    the aim here is to get it to point to <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">amount2.Cents</code>,
                    again using pointer operations instead of directly telling the compiler that's what you want to do.
                    To do this, you need to decrement the address that <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pCents</code> contains by
                    <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">sizeof(Currency)</code>.
                    The following <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">WriteLine</code> methods
                    show the value of <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pCents</code> with the
                    new address, and the value that's referenced from <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pCents</code>, which is
                    the value for the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Cents</code> with <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">amount2</code>
                    :<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">接下来，你对你的 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pCents</code>
                                指针做一些指针运算。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pCents</code>
                                目前指向 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">amount1.Cents</code>
                                ，但目标是通过指针操作让它指向 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">amount2.Cents</code>
                                ，而不是直接告诉编译器你想做什么。要做到这一点，你需要将 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pCents</code>
                                中包含的地址减去 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">sizeof(Currency)</code>
                                。下面的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">WriteLine</code>
                                方法显示了 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pCents</code>
                                的新地址的值，以及从 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pCents</code>
                                引用的值，这是 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Cents</code>
                                的值，其中 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">amount2</code>
                                ：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0051"><code>// do some clever casting to get pCents to point to cents</code>
<code>// inside amount2</code>
<code>CurrencyStruct* pTempCurrency = (CurrencyStruct*)pCents;</code>
<code>pCents = (byte*)( --pTempCurrency );</code>
<code>Console.WriteLine("Value of pCents is now 0x{(ulong)pCents:X}");</code>
<code>Console.WriteLine($"The value where pCents points to: {*pCents}");</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Finally, you use the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">fixed</code> keyword to
                    create some pointers that point to the fields in a class instance and use these pointers to set the
                    value of this instance. Notice that this is also the first time that you have been able to look at
                    the address of an item stored on the heap, rather than the stack:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">最后，你使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">fixed</code>
                                关键字创建一些指向类实例字段的指针，并使用这些指针来设置这个实例的值。注意，这也是你第一次能够查看堆上存储项的地址，而不是栈上的地址：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0052"><code>Console.WriteLine("\nNow with classes");</code>
<code>// now try it out with classes</code>
<code>CurrencyClass amount3 = new(30, 0);</code>
<code>fixed(long* pDollars2 = &amp;(amount3.Dollars))</code>
<code>fixed(byte* pCents2 = &amp;(amount3.Cents))</code>
<code>{</code>
<code>  Console.WriteLine($"amount3.Dollars has address 0x{(ulong)pDollars2:X}");</code>
<code>  Console.WriteLine($"amount3.Cents has address 0x{(ulong)pCents2:X}");</code>
<code>  *pDollars2 = -100;</code>
<code>  Console.WriteLine($"amount3 contains {amount3}");</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Compiling and running this code gives output similar to this:
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">编译并运行这段代码会给出类似这样的输出：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0053"><code>Size of CurrencyStruct struct is 16</code>
<code>Address of amount1 is 0x5E5657E2F0</code>
<code>Address of amount2 is 0x5E5657E2E0</code>
<code>Address of pAmount is 0x5E5657E2D8</code>
<code>Value of pAmount is 0x5E5657E2F0</code>
<code>Address of pDollars is 0x5E5657E2D0</code>
<code>Value of pDollars is 0x5E5657E2F0<span aria-label="361" epub:type="pagebreak" id="Page_361" role="doc-pagebreak"></span></code>
<code>Address of pCents is 0x5E5657E2C8</code>
<code>Value of pCents is 0x5E5657E2F8</code>
<code>amount1 contains $ 100.10</code>
<code>pAmount contains the new address 5E5657E2E0 and references this value $ 20.20</code>
<code>Value of pCents is now 0x5E5657E2E8</code>
<code>The value where pCents points to: 20</code>
<code> </code>
<code>Now with classes</code>
<code>amount3.Dollars has address 0x1AF3BFFF988</code>
<code>amount3.Cents has address 0x1AF3BFFF990</code>
<code>amount3 contains $ -100.0</code></pre>
                <p id="c13-para-0175" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Notice that the size of the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CurrencyStruct</code>
                    struct is <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">16</code>
                    —somewhat larger than you would expect given the size of its fields (a <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">long</code> and a <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">byte</code> should total
                    9 bytes).<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">注意， <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CurrencyStruct</code>
                                结构体的大小是 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">16</code>
                                ——比根据其字段大小（一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">long</code>
                                和一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">byte</code>
                                应该总共是 9 字节）所预期的稍大一些。</font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span id="c13-sec-0044"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                <h3 id="head-3-265" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Function Pointers <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">函数指针</font>
                        </font>
                    </font>
                </h3>
                <p id="c13-para-0176" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Function pointers are a new feature with C# 9. You've already
                    learned about delegates that are type-safe pointers to methods. However, delegates are classes, and
                    a delegate holds a list of methods, so there's some overhead associated with delegates. With
                    function pointers, just the memory address is used to reference a method—in a type-safe manner. Type
                    safety is similar to the type safety of delegates, and the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">delegate</code> keyword
                    is used here as well—a delegate combined with an asterisk: <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">delegate*</code>.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">函数指针是 C# 9
                                中的一个新特性。你已经学过了委托，它们是类型安全的指向方法的指针。然而，委托是类，并且委托持有一系列方法，所以委托有一些额外的开销。使用函数指针时，只需内存地址即可以类型安全的方式引用一个方法。类型安全性与委托的类型安全性类似，这里也使用了
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">delegate</code>
                                关键字——一个结合了星号的委托： <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">delegate*</code>
                                。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">The following <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Calc</code> method
                    declares a parameter of type <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">delegate* managed&lt;int, int, int&gt;</code>.
                    You use angle brackets to specify—similarly to the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Func</code> delegate—the
                    parameter types and the return type. The method passed to the Calc method needs to have two <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code> parameters and
                    an <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code> return.
                    With the <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">managed</code>
                    modifier, the method needs to be a .NET method. The <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">managed</code> modifier
                    is optional, and you can remove it without any change in behavior (code file <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">PointerPlayground2/FunctionPointerSample.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">以下 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Calc</code>
                                方法声明了一个类型为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">delegate* managed&lt;int, int, int&gt;</code>
                                的参数。您使用尖括号来指定——类似于 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Func</code>
                                委托——参数类型和返回类型。传递给 Calc 方法的需要有两个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code>
                                参数和一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code>
                                返回值。使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">managed</code>
                                修饰符时，该方法需要是一个 .NET 方法。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">managed</code>
                                修饰符是可选的，您可以移除它而不会改变行为（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">PointerPlayground2/FunctionPointerSample.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0054"><code>public static void Calc(delegate* managed&lt;int, int, int&gt; func)</code>
<code>{</code>
<code>  int result = func(42, 11);</code>
<code>  Console.WriteLine($"function pointer result: {result}");</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">The <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">managed</code> modifier
                    is optional, but the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">unmanaged</code> modifier
                    is required on declaring function pointers to unmanaged or native functions. With the unmanaged
                    modifier you also can specify the calling convention such as <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">StdCall</code>. The
                    calling convention specifies how the native function deals with parameters, in which order they are
                    put on the stack, or if they are put on the stack at all. The convention specified here needs to
                    match the implementation of the native method.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">managed</code>
                                修饰符是可选的，但在声明指向未管理或原生函数的函数指针时， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">unmanaged</code>
                                修饰符是必需的。使用未管理修饰符时，您还可以指定调用约定，例如 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">StdCall</code>
                                。调用约定指定了原生函数如何处理参数、它们在栈上的顺序，或者是否将它们放在栈上。这里指定的约定需要与原生方法的实现相匹配。</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0055"><code>public static void CalcUnmanaged(delegate* unmanaged[Stdcall]&lt;int, int, int&gt; func)</code>
<code>{</code>
<code>  int result = func(42, 11);</code>
<code>  Console.WriteLine($"function pointer result: {result}");</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Because function pointers are pointers in memory that can be
                    misused, they need to be declared in classes with the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">unsafe</code> keyword.
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">因为函数指针是内存中的指针，可能会被误用，所以它们需要在类中用
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">unsafe</code>
                                关键字声明。</font>
                        </font>
                    </font>
                </p>
                <aside data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <div class="top hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <p id="c13-para-0180" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">NOTE</b> <i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Read the section
                                “Platform Invoke” later in this chapter for information on how to invoke unmanaged
                                methods with P/Invoke.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意 有关如何使用 P/Invoke
                                        调用非托管方法的详细信息，请参阅本章后面的“平台调用”部分。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                            <hr />
                        </div>
                    </section>
                </aside>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1"><span aria-label="362" epub:type="pagebreak" id="Page_362"
                        role="doc-pagebreak"
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>With the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Calc</code> method in
                    place, you can declare a managed method that supports the parameter and return type requirements
                    such as the <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Add</code>
                    method defined here:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">有了 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Calc</code>
                                方法，你可以声明一个支持参数和返回类型要求的托管方法，例如这里定义的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Add</code>
                                方法：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0056"><code>static int Add(int x, int y) =&gt; x + y;</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">and invoke the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Calc</code> method
                    passing the address of the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Add</code> method with
                    the <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">&amp;</code>
                    operator:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">然后使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">&amp;</code>
                                运算符传递 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Add</code>
                                方法的地址来调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Calc</code>
                                方法：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0057"><code>FunctionPointerSample.Calc(&amp;Add);</code></pre>
            </section>
            <section data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span id="c13-sec-0046"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                <h3 id="head-3-266" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Using Pointers to Optimize Performance <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用指针优化性能</font>
                        </font>
                    </font>
                </h3>
                <p id="c13-para-0183" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Until now, all the examples have been designed to demonstrate
                    the various things that you can do with pointers. You have played around with memory in a way that
                    is probably interesting only to people who like to know what's happening under the hood, but that
                    doesn't really help you write better code. Now you're going to apply your understanding of pointers
                    and see an example of how judicious use of pointers has a significant performance benefit.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                到目前为止，所有的示例都设计用来展示你可以用指针做各种事情。你以一种可能只有那些喜欢了解底层工作原理的人才感兴趣的方式在内存中玩耍，但这并不能真正帮助你写出更好的代码。现在你将应用你对指针的理解，并看到一个示例，说明如何明智地使用指针可以显著提高性能。
                            </font>
                        </font>
                    </font>
                </p>
                <section data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span id="c13-sec-0047"
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                    <h4 id="head-4-48" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1">Creating Stack-Based Arrays<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">创建基于栈的数组</font>
                            </font>
                        </font>
                    </h4>
                    <p id="c13-para-0184" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1">This section explores one of the main areas in which
                        pointers can be useful: creating high-performance, low-overhead arrays on the stack. As
                        discussed in <a href="c02.xhtml"
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Chapter 2</a>, “Core
                        C#,” C# includes rich support for handling arrays. <a href="c06.xhtml"
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Chapter 6</a> gives
                        more details on arrays. Although C# makes it easy to use both one-dimensional and rectangular or
                        jagged multidimensional arrays, it suffers from the disadvantage that these arrays are actually
                        objects; they are instances of <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">System.Array</code>.
                        This means that the arrays are stored on the heap, with all the overhead that this involves.
                        There may be occasions when you need to create a short-lived, high-performance array and don't
                        want the overhead of reference objects. You can do this by using pointers, although this is easy
                        only for one-dimensional arrays.<font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">
                                    本节探讨了指针主要用途之一：在栈上创建高性能、低开销的数组。如第 2 章“核心 C#”所述，C#提供了丰富的数组处理支持。第 6 章将更详细地介绍数组。尽管
                                    C#使用一维数组和矩形或锯齿形多维数组都很方便，但它存在一个缺点，即这些数组实际上是对象；它们是 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">System.Array</code>
                                    的实例。这意味着数组存储在堆上，涉及所有相关开销。在某些情况下，你可能需要创建一个生命周期短、高性能的数组，并且不希望有引用对象的开销。你可以通过使用指针来实现这一点，尽管这仅适用于一维数组。
                                </font>
                            </font>
                        </font>
                    </p>
                    <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1">To create a high-performance array, you need to use a
                        keyword: <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">stackalloc</code>.
                        The <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">stackalloc</code>
                        command instructs the .NET runtime to allocate an amount of memory on the stack. When you call
                        <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">stackalloc</code>,
                        you need to supply it with two pieces of information:<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">要创建一个高性能数组，你需要使用一个关键字： <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">stackalloc</code>
                                    。 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">stackalloc</code>
                                    命令指示.NET 运行时在栈上分配一定量的内存。当你调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">stackalloc</code>
                                    时，你需要向它提供两块信息：</font>
                            </font>
                        </font>
                    </p>
                    <ul class="check" id="c13-list-0011"
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <li id="c13-li-0033" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                            data-immersive-translate-paragraph="1">The type of data you want to store<font
                                class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">你想存储的数据类型</font>
                                </font>
                            </font>
                        </li>
                        <li id="c13-li-0034" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                            data-immersive-translate-paragraph="1">The number of these data items you need to store<font
                                class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">你需要存储这些数据项的数量</font>
                                </font>
                            </font>
                        </li>
                    </ul>
                    <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1">For example, to allocate enough memory to store 10 <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">decimal</code> data
                        items, you can write the following:<font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">例如，要分配足够的内存来存储 10 个 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">decimal</code>
                                    数据项，你可以编写以下代码：</font>
                            </font>
                        </font>
                    </p>
                    <pre id="c13-code-0058"><code>decimal* pDecimals = stackalloc decimal[10];</code></pre>
                    <p id="c13-para-0187" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1">This command simply allocates the stack memory; it does
                        not attempt to initialize the memory to any default value. This is fine for the purpose of this
                        example because you are creating a high-performance array, and initializing values unnecessarily
                        would hurt performance. Your program can initialize the memory if necessary.<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">
                                    这条命令仅分配栈内存；它不会尝试将内存初始化为任何默认值。对于本例的目的是可以的，因为你正在创建一个高性能数组，不必要地初始化值会损害性能。如果需要，你的程序可以初始化内存。
                                </font>
                            </font>
                        </font>
                    </p>
                    <p id="c13-para-0188" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1">Remember, different than the heap, the variables stored
                        on the stack are released when the method completes. This is also true for allocating an array
                        on the stack, so allocating memory with <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">stackalloc</code> you
                        don't need to release the memory on your own.<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">
                                    记住，与堆不同，栈上存储的变量在方法完成后会被释放。为栈分配数组也是如此，因此使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">stackalloc</code>
                                    分配内存时，你无需自行释放内存。</font>
                            </font>
                        </font>
                    </p>
                    <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1">Similarly, to store 20 <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">double</code> data
                        items, you write this:<font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">同样地，要存储 20 个 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">double</code>
                                    数据项，你这样写：</font>
                            </font>
                        </font>
                    </p>
                    <pre id="c13-code-0059"><code>double* pDoubles = stackalloc double[20];</code></pre>
                    <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1">Although this line of code specifies the number of
                        variables to store as a constant, this can equally be a quantity evaluated at runtime.
                        Therefore, you can write the previous example like this:<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">
                                    虽然这行代码将存储变量的数量指定为常量，但这同样可以是一个在运行时评估的数量。因此，你可以像这样编写前面的示例：</font>
                            </font>
                        </font>
                    </p>
                    <pre id="c13-code-0060"><code>int size;</code>
<code>size = 20; // or some other value calculated at runtime</code>
<code>double* pDoubles = stackalloc double[size];</code></pre>
                    <p id="c13-para-0191" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1"><span aria-label="363" epub:type="pagebreak"
                            id="Page_363" role="doc-pagebreak"
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>You can see
                        from these code snippets that the syntax of <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">stackalloc</code> is
                        slightly unusual. It is followed immediately by the name of the data type you want to store
                        (which must be a value type) and then by the number of items you need space for, in square
                        brackets. The number of bytes allocated is this number multiplied by <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">sizeof(data type)</code>.
                        The use of square brackets in the preceding code sample suggests an array, which is not too
                        surprising. If you have allocated space for 20 <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">doubles</code>, then
                        what you have is an array of 20 <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">doubles</code>. The
                        simplest type of array that you can have is a block of memory that stores one element after
                        another (see <a href="#c13-fig-0006" id="R_c13-fig-0006"
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Figure 13-6</a>).
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">从这些代码片段中可以看出， <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">stackalloc</code>
                                    的语法略有不同。它紧跟着你要存储的数据类型的名称（该类型必须是值类型），然后是方括号中的项目数量。分配的字节数是这个数字乘以 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">sizeof(data type)</code>
                                    。前一个代码示例中方括号的使用表明这是一个数组，这并不令人意外。如果你为 20 个 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">doubles</code>
                                    分配了空间，那么你得到的就是一个包含 20 个 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">doubles</code>
                                    的数组。你能拥有的最简单的数组类型是一块存储一个接一个元素的内存块（见图 13-6）。</font>
                            </font>
                        </font>
                    </p>
                    <figure data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> <img
                            alt="Schematic illustration of returning a pointer by stackalloc." class="center"
                            src="images/c13f006.png" />
                        <figcaption data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                            <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span
                                    class="figureLabel"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><a
                                        href="#R_c13-fig-0006" id="c13-fig-0006" role="doc-backlink"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><b
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                                            data-immersive-translate-paragraph="1">FIGURE 13-6<font
                                                class="notranslate immersive-translate-target-wrapper"
                                                data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                                <font class="notranslate"
                                                    data-immersive-translate-translation-element-mark="1">  </font>
                                                <font
                                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                                    data-immersive-translate-translation-element-mark="1">
                                                    <font
                                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                                        data-immersive-translate-translation-element-mark="1">图 13-6
                                                    </font>
                                                </font>
                                            </font></b></a></span></p>
                        </figcaption>
                    </figure>
                    <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1">This diagram also shows the pointer returned by <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">stackalloc</code>,
                        which is always a pointer to the allocated data type that points to the top of the newly
                        allocated memory block. To use the memory block, you simply dereference the returned pointer.
                        For example, to allocate space for 20 <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">doubles</code> and
                        then set the first element (element 0 of the array) to the value <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">3.0</code>, write
                        this:<font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">这张图也显示了 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">stackalloc</code>
                                    返回的指针，它始终是指向已分配数据类型的指针，指向新分配内存块的顶部。要使用内存块，只需对返回的指针进行解引用。例如，要为 20 个 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">doubles</code>
                                    分配空间，并将第一个元素（数组元素 0）设置为值 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">3.0</code>
                                    ，可以编写如下代码：</font>
                            </font>
                        </font>
                    </p>
                    <pre id="c13-code-0061"><code>double* pDoubles = stackalloc double[20];</code>
<code>*pDoubles = 3.0;</code></pre>
                    <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1">To access the next element of the array, you use pointer
                        arithmetic. As described earlier, if you add 1 to a pointer, its value will be increased by the
                        size of whatever data type it points to. In this case, that's just enough to take you to the
                        next free memory location in the block that you have allocated. Therefore, you can set the
                        second element of the array (element number <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">1</code>) to the
                        value <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">8.4</code>
                        :<font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">
                                    要访问数组的下一个元素，你使用指针算术。如前所述，如果你给一个指针加
                                    1，它的值会增加它指向的数据类型的大小。在这种情况下，这足以带你到已分配内存块中的下一个空闲内存位置。因此，你可以将数组的第二个元素（元素编号 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">1</code>
                                    ）设置为值 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">8.4</code>
                                    ：</font>
                            </font>
                        </font>
                    </p>
                    <pre id="c13-code-0062"><code>double* pDoubles = stackalloc double[20];</code>
<code>*pDoubles = 3.0;</code>
<code>*(pDoubles + 1) = 8.4;</code></pre>
                    <p id="c13-para-0194" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1">By the same reasoning, you can access the element with
                        index <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">X</code> of
                        the array with the expression <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">*(pDoubles+ X)</code>.
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">根据同样的推理，你可以使用表达式 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">*(pDoubles+ X)</code>
                                    访问数组索引为 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">X</code>
                                    的元素。</font>
                            </font>
                        </font>
                    </p>
                    <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1">Effectively, you have a means by which you can access
                        elements of your array, but for general-purpose use, this syntax is too complex. Fortunately, C#
                        defines an alternative syntax using square brackets. C# gives a precise meaning to square
                        brackets when they are applied to pointers; if the variable <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">p</code> is any
                        pointer type and <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">X</code> is an
                        integer, then the expression <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">p[X]</code> is always
                        interpreted by the compiler as meaning <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">*(p</code>
                        +
                        <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">X)</code>. This is
                        true for all pointers, not only those initialized using <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">stackalloc</code>.
                        With this shorthand notation, you now have a convenient syntax for accessing your array. In
                        fact, it means that you have the same syntax for accessing one-dimensional, stack-based arrays
                        as you do for accessing heap-based arrays that are represented by the <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">System.Array</code>
                        class:<font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">
                                    实际上，你有一种访问数组元素的方式，但对于通用用途，这种语法过于复杂。幸运的是，C# 定义了一种使用方括号的替代语法。当方括号应用于指针时，C#
                                    为其赋予了精确的含义；如果 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">p</code>
                                    是任何指针类型，而 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">X</code>
                                    是一个整数，那么表达式 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">p[X]</code>
                                    总是被编译器解释为 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">*(p</code>
                                    + <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">X)</code>
                                    。这对所有指针都适用，而不仅仅是使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">stackalloc</code>
                                    初始化的那些。有了这种简写符号，你现在有一种方便的语法来访问你的数组。事实上，这意味着你访问一维、基于栈的数组与访问由 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">System.Array</code>
                                    类表示的基于堆的数组具有相同的语法：</font>
                            </font>
                        </font>
                    </p>
                    <pre id="c13-code-0063"><code>double* pDoubles = stackalloc double [20];</code>
<code>pDoubles[0] = 3.0; // pDoubles[0] is the same as *pDoubles</code>
<code>pDoubles[1] = 8.4; // pDoubles[1] is the same as *(pDoubles+1)</code></pre>
                    <aside data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <div class="top hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                            <hr />
                        </div>
                        <section class="feature2"
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                            <p id="c13-para-0197" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                                data-immersive-translate-paragraph="1"><b
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">NOTE</b> <i
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">This idea of
                                    applying array syntax to pointers is not new. It has been a fundamental part of both
                                    the C and the C++ languages ever since those languages were invented. Indeed, C++
                                    developers will recognize the stack-based arrays they can obtain using </i> <code
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">stackalloc</code>
                                <i data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> as being
                                    essentially identical to classic stack-based C and C++ arrays. This syntax and the
                                    way it links pointers and arrays is one reason why the C language became popular in
                                    the 1970s and the main reason why the use of pointers became such a popular
                                    programming technique in C and C++.</i>
                                <font class="notranslate immersive-translate-target-wrapper"
                                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                    <font
                                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                        data-immersive-translate-translation-element-mark="1">
                                        <font
                                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                            data-immersive-translate-translation-element-mark="1">注意
                                            将数组语法应用于指针的想法并不新鲜。自这些语言被发明以来，它一直是 C 和 C++语言的基本部分。事实上，C++开发者会认出他们可以使用 <code
                                                xmlns="http://www.w3.org/1999/xhtml"
                                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">stackalloc</code>
                                            获得的基于栈的数组本质上与经典的基于栈的 C 和 C++数组相同。这种语法以及它如何将指针和数组链接起来是 C 语言在 1970
                                            年代变得流行的原因之一，也是指针在 C 和 C++中成为如此流行的编程技术的根本原因。</font>
                                    </font>
                                </font>
                            </p>
                            <div class="bottom hr"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                                <hr />
                            </div>
                        </section>
                    </aside>
                    <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1"><span aria-label="364" epub:type="pagebreak"
                            id="Page_364" role="doc-pagebreak"
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>Although your
                        high-performance array can be accessed in the same way as a normal C# array, a word of caution
                        is in order. The following code in C# raises an exception:<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">尽管你的高性能数组可以像普通的
                                    C#数组一样被访问，但需要提醒的是。以下 C#代码会引发异常：</font>
                            </font>
                        </font>
                    </p>
                    <pre id="c13-code-0064"><code>double[] myDoubleArray = new double[20];</code>
<code>myDoubleArray[50] = 3.0;</code></pre>
                    <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1">The exception occurs because you are trying to access an
                        array using an index that is out of bounds; the index is <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">50</code>, whereas
                        the maximum allowed value is <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">19</code>. However,
                        if you declare the equivalent array using <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">stackalloc</code>,
                        there is no object wrapped around the array that can perform bounds checking. Hence, the
                        following code does <i
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">not</i> raise an
                        exception:<font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">异常发生是因为你试图使用一个超出范围的索引来访问数组；索引是
                                    <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">50</code>
                                    ，而允许的最大值是 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">19</code>
                                    。然而，如果你使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">stackalloc</code>
                                    声明等效的数组，数组周围没有对象可以执行边界检查。因此，以下代码不会引发异常：</font>
                            </font>
                        </font>
                    </p>
                    <pre id="c13-code-0065"><code>double* pDoubles = stackalloc double[20];</code>
<code>pDoubles[50] = 3.0;</code></pre>
                    <p id="c13-para-0200" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1">In this code, you allocate enough memory to hold 20 <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">doubles</code>. Then
                        you use the <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pDoubles</code>
                        variable to reference memory that is way outside the area of memory that you have allocated for
                        the doubles. There is no knowing what data might be stored at that address. At best, you might
                        have used some currently unused memory, but it is equally possible that you might have just
                        overwritten some locations in the stack that were being used to store other variables or even
                        the return address from the method currently being executed. Again, you see that the high
                        performance to be gained from pointers comes at a cost; you need to be certain you know what you
                        are doing, or you will get some very strange runtime bugs.<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">在这个代码中，你分配了足够的内存来存储 20 个 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">doubles</code>
                                    。然后你使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">pDoubles</code>
                                    变量来引用远远超出你为双精度浮点数分配的内存区域的内存。无法知道该地址可能存储了什么数据。最好情况下，你可能使用了一些当前未被使用的内存，但同样可能的是，你可能只是覆盖了栈中用于存储其他变量或当前正在执行的方法的返回地址的一些位置。再次看到，通过指针获得的高性能是有代价的；你必须确保你知道自己在做什么，否则你会遇到一些非常奇怪的运行时错误。
                                </font>
                            </font>
                        </font>
                    </p>
                </section>
                <section data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span id="c13-sec-0049"
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                    <h4 id="head-4-49" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1">QuickArray Example<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                            <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">QuickArray 示例</font>
                            </font>
                        </font>
                    </h4>
                    <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1">The discussion of pointers ends with a <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">stackalloc</code>
                        example called <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">QuickArray</code>. In
                        this example, the program simply asks users how many elements they want to be allocated for an
                        array. The code then uses <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">stackalloc</code> to
                        allocate an array of <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">long</code>
                        s that size. The elements of this array are populated with the squares of the integers starting
                        with <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">0</code>, and
                        the results are displayed on the console (code file <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">QuickArray/Program.cs</code>):
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">关于指针的讨论以一个 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">stackalloc</code>
                                    示例 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">QuickArray</code>
                                    结束。在这个示例中，程序简单地询问用户想要为数组分配多少个元素。然后代码使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">stackalloc</code>
                                    来分配一个大小为 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">long</code>
                                    的 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">0</code>
                                    数组。这个数组的元素被填充为从 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">0</code>
                                    开始的整数的平方，结果在控制台上显示（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">QuickArray/Program.cs</code>
                                    ）：</font>
                            </font>
                        </font>
                    </p>
                    <pre id="c13-code-0066"><code>class Program</code>
<code>{</code>
<code>  unsafe public static void Main()</code>
<code>  {</code>
<code>    string? userInput;</code>
<code>    int size;</code>
<code>    do</code>
<code>    {</code>
<code>      Console.Write($"How big an array do you want? {Environment.NewLine}&gt;");</code>
<code>      userInput = Console.ReadLine();</code>
<code>    } while (!int.TryParse(userInput, out size));</code>
<code> </code>
<code>    long* pArray = stackalloc long[size];</code>
<code>    for (int i = 0; i &lt; size; i++)</code>
<code>    {</code>
<code>      pArray[i] = i * i;</code>
<code>    }</code>
<code> </code>
<code>    for (int i = 0; i &lt; size; i++)</code>
<code>    {</code>
<code>      Console.WriteLine($"Element {i} = {*(pArray + i)}");</code>
<code>    }</code>
<code> </code>
<code>    Console.ReadLine();</code>
<code>  }</code>
<code>}</code></pre>
                    <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1"><span aria-label="365" epub:type="pagebreak"
                            id="Page_365" role="doc-pagebreak"
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>Here is the
                        output from the <code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">QuickArray</code>
                        example:<font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">这是 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">QuickArray</code>
                                    示例的输出：</font>
                            </font>
                        </font>
                    </p>
                    <pre id="c13-code-0067"><code>How big an array do you want?</code>
<code>&gt; 15</code>
<code>Element 0 = 0</code>
<code>Element 1 = 1</code>
<code>Element 2 = 4</code>
<code>Element 3 = 9</code>
<code>Element 4 = 16</code>
<code>Element 5 = 25</code>
<code>Element 6 = 36</code>
<code>Element 7 = 49</code>
<code>Element 8 = 64</code>
<code>Element 9 = 81</code>
<code>Element 10 = 100</code>
<code>Element 11 = 121</code>
<code>Element 12 = 144</code>
<code>Element 13 = 169</code>
<code>Element 14 = 196</code></pre>
                </section>
            </section>
        </section>
        <section aria-labelledby="head-2-118" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
            <span id="c13-sec-0050" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
            <h2 id="head-2-118" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1">SPAN&lt;T&gt;</h2>
            <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1"><a href="c03.xhtml"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Chapter 3</a>, “Classes,
                Records, Structs, and Tuples,” includes creating reference types (classes) and value types (structs).
                Instances of classes are stored on the managed heap. The value of structs can be stored on the stack or,
                when boxing is used, on the managed heap. Now we have another kind: a type that can have its value only
                on the stack but never on the heap, which is sometimes called <i
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">ref-like types</i>. Boxing is
                not possible with these types. Such a type is declared with the <code
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">ref struct</code> keyword.
                Using <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">ref struct</code>
                gives some additional behaviors and restrictions. The restrictions are the following:<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            第三章“类、记录、结构体和元组”包括创建引用类型（类）和值类型（结构体）。类的实例存储在托管堆上。结构体的值可以存储在栈上，或者在装箱使用时存储在托管堆上。现在我们有了另一种类型：一种只能存在于栈上而永远不会在堆上的类型，有时被称为类似引用的类型。这些类型无法进行装箱。这种类型使用
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">ref struct</code>
                            关键字声明。使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">ref struct</code>
                            会提供一些额外的行为和限制。限制如下：</font>
                    </font>
                </font>
            </p>
            <ul class="check" id="c13-list-0012" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                <li id="c13-li-0035" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">They can't be added as array items.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">它们不能作为数组项添加。</font>
                        </font>
                    </font>
                </li>
                <li id="c13-li-0036" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">They can't be used as generic type arguments.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">它们不能用作泛型类型参数。</font>
                        </font>
                    </font>
                </li>
                <li id="c13-li-0037" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">They can't be boxed.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">它们不能被装箱。</font>
                        </font>
                    </font>
                </li>
                <li id="c13-li-0038" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">They can't be static fields.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">它们不能是静态字段。</font>
                        </font>
                    </font>
                </li>
                <li id="c13-li-0039" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">They can only be instance fields of ref-like types.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">它们只能是 ref 类型的实例字段。</font>
                        </font>
                    </font>
                </li>
            </ul>
            <p id="c13-para-0204" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1">
                <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span&lt;T&gt;</code> and
                <code
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">ReadOnlySpan&lt;T&gt;</code>
                are ref-like types covered in this section. These types are already covered in <a href="c06.xhtml"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Chapter 6</a> with extension
                methods for arrays. Here, additional features are covered to reference data on the managed heap, the
                stack, and the native heap.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1"> <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span&lt;T&gt;</code>
                            和 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">ReadOnlySpan&lt;T&gt;</code>
                            是本节中提到的 ref 类型的类型。这些类型在第六章中已经通过数组扩展方法进行了介绍。在这里，将介绍更多功能，用于引用托管堆、栈和本机堆上的数据。</font>
                    </font>
                </font>
            </p>
            <section data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span id="c13-sec-0051"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                <h3 id="head-3-267" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Spans Referencing the Managed Heap <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">引用托管堆的 Spans</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">A <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code> can reference
                    memory on the managed heap, as you've seen in <a href="c06.xhtml"
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Chapter 6</a>. In the
                    following code snippet, an array is created, and with the extension method <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">AsSpan</code>, a new
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code> is created
                    that references the memory of the array on the managed heap. After creating the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code> referenced
                    from the variable <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">span1</code>, a slice of
                    the <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code> is
                    created that is filled with the value <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">42</code>. Within
                    comments in the following source code, you see the syntax using the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Slice</code> method of
                    the <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code> type.
                    The range operator is used to fulfill the same functionality. The next <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Console.WriteLine</code>
                    writes the values of the span <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">span1</code> to the
                    console (code file <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SpanSample/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">一个 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code>
                                可以引用托管堆上的内存，正如你在第 6 章所见。在以下代码片段中，创建了一个数组，并使用扩展方法 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">AsSpan</code>
                                创建了一个新的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code>
                                ，它引用了托管堆上数组的内存。在从变量 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">span1</code>
                                引用的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code>
                                创建后，创建了一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code>
                                的切片，并用值 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">42</code>
                                填充。在以下源代码的注释中，你可以看到使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Slice</code>
                                类型的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code>
                                方法的语法。范围运算符用于实现相同的功能。下一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Console.WriteLine</code>
                                将切片 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">span1</code>
                                的值写入控制台（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SpanSample/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0068"><code>void SpanOnTheHeap()</code>
<code>{</code>
<code>  Console.WriteLine(nameof(SpanOnTheHeap));</code>
<code>  Span&lt;int&gt; span1 = (new int[] { 1, 5, 11, 71, 22, 19, 21, 33 }).AsSpan();</code>
<code> <span aria-label="366" epub:type="pagebreak" id="Page_366" role="doc-pagebreak"></span></code>
<code>  // span1.Slice(start: 4, length: 3).Fill(42);</code>
<code>  span1[4..7].Fill(42);</code>
<code> </code>
<code>  Console.WriteLine(string.Join(", ", span1.ToArray()));</code>
<code> </code>
<code>  Console.WriteLine();</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">When you run the application, you can see the output of <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">span1</code> with the 42
                    filled within the slice of the span:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">当你运行应用程序时，你可以看到 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">span1</code>
                                的输出，其中 42 被填充在切片中：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0069"><code>SpanOnTheHeap</code>
<code>1, 5, 11, 71, 42, 42, 42, 33</code></pre>
            </section>
            <section data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span id="c13-sec-0052"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                <h3 id="head-3-268" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Spans Referencing the Stack <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">引用堆栈的切片</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code> can be used
                    to reference memory on the stack. Referencing a single variable on the stack is not as interesting
                    as referencing a block of memory; that's why the following code snippet makes use of the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">stackalloc</code>
                    keyword. <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">stackalloc</code> returns
                    a <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">long*</code>, which
                    requires the method <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SpanOnTheStack</code> to
                    be declared <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">unsafe</code>. A
                    constructor of the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code> type allows
                    passing a pointer with the additional parameter for the size. Next, the variable <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">span1</code> is used with
                    the indexer to fill every item (code file <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SpanSample/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code>
                                可用于引用栈上的内存。引用栈上的单个变量并不像引用内存块那么有趣；这就是为什么以下代码片段使用了 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">stackalloc</code>
                                关键字。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">stackalloc</code>
                                返回一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">long*</code>
                                ，这需要方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SpanOnTheStack</code>
                                以 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">unsafe</code>
                                方式声明。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code>
                                类型的构造函数允许通过额外的参数传递大小来传递指针。接下来，使用索引器来填充每个项目（代码文件 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SpanSample/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0070"><code>unsafe void SpanOnTheStack()</code>
<code>{</code>
<code>  Console.WriteLine(nameof(SpanOnTheStack));</code>
<code> </code>
<code>  long* lp = stackalloc long[20];</code>
<code>  Span&lt;long&gt; span1 = new(lp, 20);</code>
<code>            </code>
<code>  for (int i = 0; i &lt; 20; i++)</code>
<code>  {</code>
<code>    span1[i] = i;</code>
<code>  }</code>
<code> </code>
<code>  Console.WriteLine(string.Join(", ", span1.ToArray()));</code>
<code>  Console.WriteLine();</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">When you run the program, the following output shows the span
                    with the initialized data on the stack:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">当你运行程序时，以下输出显示了栈上初始化数据的范围：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0071"><code>SpanOnTheStack</code>
<code>0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19</code></pre>
            </section>
            <section data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span id="c13-sec-0053"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                <h3 id="head-3-269" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Spans Referencing the Native Heap <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">引用原生堆的跨度</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">A great feature of spans is they can also reference memory on
                    the native heap. Memory on the native heap usually is allocated from native APIs. In the following
                    code snippet, the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">AllocHGlobal</code>
                    method of the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Marshal</code> class is
                    used to allocate 100 bytes on the native heap. This class is defined in the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">System.Runtime.InteropServices</code>
                    namespace. The <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Marshal</code> class
                    returns a pointer with the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IntPtr</code> type. To
                    directly access the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int*</code>, the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">ToPointer</code> method
                    of <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IntPtr</code> is
                    invoked. This is the pointer required by the constructor of the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code> class.
                    Writing <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code>
                    values to this memory, you need to pay attention how many bytes are needed. As an <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code> contains 32
                    bits, the number of bytes is divided by 4 with a bit shift of two bits to get the number of int
                    values that will fit in the memory. After this, the native memory is filled by invoking the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Fill</code> method of the
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code>. With a
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">for</code> loop, every
                    item referenced from the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code> is written to
                    the console (code file <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SpanSample/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                跨度的一大特点是它们也可以引用原生堆上的内存。原生堆上的内存通常是从原生 API 分配的。在以下代码片段中，使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Marshal</code>
                                类中的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">AllocHGlobal</code>
                                方法在原生堆上分配了 100 字节。这个类定义在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">System.Runtime.InteropServices</code>
                                命名空间中。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Marshal</code>
                                类返回一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IntPtr</code>
                                类型的指针。为了直接访问 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int*</code>
                                ，调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IntPtr</code>
                                的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">ToPointer</code>
                                方法。这是 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code>
                                类构造函数所需的指针。向这段内存写入 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code>
                                值时，需要注意需要多少字节。由于 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">int</code> 包含
                                32 位，字节数量通过右移两位（即除以 4）来获取内存中可以容纳的 int 值的数量。之后，通过调用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code> 的
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Fill</code>
                                方法填充原生内存。使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">for</code>
                                循环，将 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code>
                                中引用的每个项写入控制台（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SpanSample/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0072"><code>unsafe void SpanOnNativeMemory()</code>
<code>{</code>
<code>  Console.WriteLine(nameof(SpanOnNativeMemory));</code>
<code>  const int nbytes = 100;<span aria-label="367" epub:type="pagebreak" id="Page_367" role="doc-pagebreak"></span></code>
<code>  IntPtr p = Marshal.AllocHGlobal(nbytes);</code>
<code>  try</code>
<code>  {              </code>
<code>    int* p2 = (int*)p.ToPointer();</code>
<code>    Span&lt;int&gt; span = new(p2, nbytes&gt;&gt; 2);</code>
<code>    span.Fill(42);</code>
<code> </code>
<code>    int max = nbytes&gt;&gt; 2;</code>
<code>    for (int i = 0; i &lt; max; i++)</code>
<code>    {</code>
<code>      Console.Write($"{span[i]} ");</code>
<code>    }</code>
<code>    Console.WriteLine();</code>
<code>  }</code>
<code>  finally</code>
<code>  {</code>
<code>    Marshal.FreeHGlobal(p);</code>
<code>  }</code>
<code>  Console.WriteLine();</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">When you run the application, the values stored in the native
                    heap are written to the console:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">当你运行应用程序时，原生堆中存储的值被写入控制台：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0073"><code>SpanOnNativeMemory</code>
<code>42 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42</code></pre>
                <aside data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <div class="top hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <p id="c13-para-0212" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">NOTE</b> <i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">For using
                            </i><code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code><i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> to access native
                                memory and the stack, unsafe code was needed because of the memory allocation and
                                creation of the </i><code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code><i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> by passing a
                                pointer. After the initialization, unsafe code is no longer required using the </i><code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code><i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">. Allocating
                                native memory (as done with the </i><code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">AllocHGlobal</code><i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> method of the
                            </i><code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Marshal</code><i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> class), it's
                                important to release this memory with </i><code
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">FreeHGlobal</code><i
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意：要使用 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code>
                                        访问原生内存和栈，由于需要通过指针传递来分配内存和创建 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code>
                                        ，因此需要使用不安全代码。初始化后，使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code>
                                        就不再需要不安全代码。分配原生内存（如使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Marshal</code>
                                        类的 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">AllocHGlobal</code>
                                        方法完成），重要的是使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">FreeHGlobal</code>
                                        释放这些内存。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                            <hr />
                        </div>
                    </section>
                </aside>
            </section>
            <section data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span id="c13-sec-0055"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                <h3 id="head-3-270" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Span Extension Methods <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">Span 扩展方法</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">For the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code> type,
                    extension methods are defined to make it easier to work with this type. The following code snippet
                    demonstrates the use of the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Overlaps</code>, the
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Reverse</code>, and the
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IndexOf</code> methods.
                    With the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Overlaps</code> method,
                    it is checked if the span that is used to invoke this extension method overlaps the span passed with
                    the argument. The <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Reverse</code> method
                    reverses the content of the span. The <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IndexOf</code> method
                    returns the index of the span passed with the argument (code file <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SpanSample/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">对于 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code>
                                类型，定义了扩展方法以便更方便地使用该类型。以下代码片段展示了 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Overlaps</code>
                                、 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Reverse</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IndexOf</code>
                                方法的使用。使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Overlaps</code>
                                方法时，会检查调用此扩展方法的 span 是否与参数中传递的 span 重叠。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Reverse</code>
                                方法反转 span 的内容。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IndexOf</code>
                                方法返回参数中传递的 span 的索引（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SpanSample/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0074"><code>void SpanExtensions()</code>
<code>{</code>
<code>  Console.WriteLine(nameof(SpanExtensions));</code>
<code>  Span&lt;int&gt; span1 = (new int[] { 1, 5, 11, 71, 22, 19, 21, 33 }).AsSpan();</code>
<code>  Span&lt;int&gt; span2 = span1[3..7];</code>
<code> </code>
<code>  <b>bool overlaps = span1.Overlaps(span2);</b></code>
<code>  Console.WriteLine($"span1 overlaps span2: {overlaps}");</code>
<code>  <b>span1.Reverse();</b></code>
<code>  Console.WriteLine($"span1 reversed: {string.Join(", ", span1.ToArray())}");</code>
<code>  Console.WriteLine($"span2 (a slice) after reversing span1: " +</code>
<code>    $"{string.Join(", ", span2.ToArray())}");</code>
<code>  <b>int index = span1.IndexOf(span2);<span aria-label="368" epub:type="pagebreak" id="Page_368" role="doc-pagebreak"></span></b></code>
<code>  Console.WriteLine($"index of span2 in span1: {index}");</code>
<code>  Console.WriteLine();</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Running the program produces this output:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">运行程序产生此输出：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0075"><code>SpanExtensions</code>
<code>span1 overlaps span2: True</code>
<code>span1 reversed: 33, 21, 19, 22, 71, 11, 5, 1</code>
<code>span2 (a slice) after reversing span1: 22, 71, 11, 5</code>
<code>index of span2 in span1: 3</code></pre>
                <p id="c13-para-0215" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Other extension methods defined for the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code> type are
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">StartsWith</code> to
                    check if a span starts with the sequence of another span, <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SequenceEqual</code> to
                    compare the sequence of two spans, <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SequenceCompareTo</code>
                    for ordering of sequences, and <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">LastIndexOf</code> for
                    returning the first matching index starting from the end of the span.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">为 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Span</code>
                                类型定义的其他扩展方法包括 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">StartsWith</code>
                                用于检查一个 span 是否以另一个 span 的序列开头， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SequenceEqual</code>
                                用于比较两个 span 的序列， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SequenceCompareTo</code>
                                用于序列排序，以及 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">LastIndexOf</code>
                                用于返回从 span 结尾开始匹配的第一个索引。</font>
                        </font>
                    </font>
                </p>
            </section>
        </section>
        <section aria-labelledby="head-2-119" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
            <span id="c13-sec-0056" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
            <h2 id="head-2-119" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1">PLATFORM INVOKE</h2>
            <p id="c13-para-0216" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1">Not all the features of Windows or Linux API calls are available
                from .NET. This is true not only for old Windows API calls but also for very new features. Maybe you've
                written some DLLs that export unmanaged methods and you would like to use them from C# as well.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">.NET 无法使用所有 Windows 或 Linux API
                            调用的功能。这不仅适用于旧的 Windows API 调用，也适用于非常新的功能。也许你已经编写了一些导出未管理方法的 DLL，并希望从 C# 中使用它们。</font>
                    </font>
                </font>
            </p>
            <p id="c13-para-0217" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1">To reuse a native library, you can use platform invoke
                (P/Invoke). With P/Invoke, the CLR loads the library that includes the function that should be called
                and marshals the parameters.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">要重用本地库，可以使用平台调用（P/Invoke）。通过
                            P/Invoke，CLR 加载包含要调用的函数的库，并 marshals 参数。</font>
                    </font>
                </font>
            </p>
            <p id="c13-para-0218" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1">To use the unmanaged function, first you must determine the name
                of the function and the parameters as they are exported. In the example, you use the <code
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CreateHardLink</code> Windows
                API function to create a hard link to an existing file and the Linux <code
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">link</code> API function to
                do the same. With these API calls, you can have several filenames that reference the same file as long
                as the filenames are on the same hard disk. This API call is not available from .NET, so you must use
                platform invoke.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">要使用未管理的函数，首先必须确定函数的名称和它们导出的参数。在示例中，你使用
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CreateHardLink</code>
                            Windows API 函数创建现有文件的硬链接，以及 Linux <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">link</code> API
                            函数执行相同操作。通过这些 API 调用，只要文件名在同一硬盘上，你可以有多个文件名引用同一个文件。这个 API 调用在.NET 中不可用，因此你必须使用平台调用。</font>
                    </font>
                </font>
            </p>
            <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1">For Windows APIs, <code
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><a href="https://pinvoke.net">https://pinvoke.net</a></code>
                has great information on mapping Windows APIs to .NET. This site lists many Windows APIs and how they
                can be represented with .NET. With Linux, the APIs are described with the manual pages accessible with
                the <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">man</code> command.
                <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">man link</code> shows the
                documentation on the link command, and <code
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">man 2 link</code> opens
                section 2 of the documentation to display the system calls. When you use this information from the
                manual pages, it's not too hard to map the APIs to .NET types.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">对于 Windows API， <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><a href="https://pinvoke.net">https://pinvoke.net</a></code>
                            提供了大量关于将 Windows API 映射到.NET 的信息。这个网站列出了许多 Windows API 以及它们如何用.NET 表示。对于 Linux，API 通过 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">man</code>
                            命令可访问的手册页进行描述。 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">man link</code>
                            显示了链接命令的文档， <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">man 2 link</code>
                            打开文档的第 2 节以显示系统调用。当你使用手册页中的这些信息时，将 API 映射到.NET 类型并不太难。</font>
                    </font>
                </font>
            </p>
            <aside data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                <div class="top hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <hr />
                </div>
                <section class="feature2" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <p id="c13-para-0220" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                        data-immersive-translate-paragraph="1"><b
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">NOTE</b> <i
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">To use Windows APIs
                            from .NET, Microsoft has started the win32metadata project (</i><code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><a href="https://github.com/microsoft/win32metadata">https://github.com/microsoft/win32metadata</a></code><i
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">) that's in its early
                            stages at the time of this writing. This project makes use of the C# source generators to
                            automatically generate </i><code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">DllImport</code><i
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> declarations, and
                            you just need to write the API method you want to invoke in a text file. For using these
                            definitions, you just need to add a text file named </i><code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">NativeMethods.txt</code><i
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"> to the project, add
                            the APIs you want to invoke (for example, </i><code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CreateHardLink</code><i
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">), add the NuGet
                            package </i><code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Microsoft.Windows.CsWin32</code><i
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">, and import the
                            namespace </i><code
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Microsoft.Windows.Sdk</code><i
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">.</i>
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">注意 要在.NET 中使用 Windows
                                    API，微软启动了 win32metadata 项目（ <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><a href="https://github.com/microsoft/win32metadata">https://github.com/microsoft/win32metadata</a></code>
                                    ），该项目在撰写本文时仍处于早期阶段。该项目利用 C#源生成器自动生成 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">DllImport</code>
                                    声明，你只需在文本文件中编写想要调用的 API 方法。要使用这些定义，你只需将一个名为 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">NativeMethods.txt</code>
                                    的文本文件添加到项目中，添加你想要调用的 API（例如， <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CreateHardLink</code>
                                    ），添加 NuGet 包 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Microsoft.Windows.CsWin32</code>
                                    ，并导入命名空间 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Microsoft.Windows.Sdk</code>
                                    。</font>
                            </font>
                        </font>
                    </p>
                    <p id="c13-para-0221" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><i
                            data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                            data-immersive-translate-paragraph="1">You can read more about source generators in <a
                                href="c12.xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Chapter 12</a>,
                            “Reflection, Metadata, and Source Generators.”<font
                                class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">你可以阅读更多关于源生成器的信息，请参阅第 12
                                        章“反射、元数据和源生成器。”</font>
                                </font>
                            </font></i></p>
                    <div class="bottom hr" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <hr />
                    </div>
                </section>
            </aside>
            <section data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span id="c13-sec-0058"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                <h3 id="head-3-271" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Calling Native Windows APIs <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">调用原生 Windows API </font>
                        </font>
                    </font>
                </h3>
                <p id="c13-para-0222" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">To call a native function, you have to define a C# external
                    method with the same number of arguments, and the argument types that are defined with the unmanaged
                    method must have mapped types with managed code.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">要调用一个原生函数，你必须定义一个具有相同数量参数的 C#
                                外部方法，并且未管理方法中定义的参数类型必须与托管代码中的映射类型相对应。 </font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1"><span aria-label="369" epub:type="pagebreak" id="Page_369"
                        role="doc-pagebreak"
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>The Windows API
                    call <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CreateHardLink</code> has
                    this definition in C++:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">Windows API 调用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CreateHardLink</code>
                                在 C++ 中的定义如下：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0076"><code>BOOL CreateHardLink(</code>
<code>  LPCTSTR lpFileName,</code>
<code>  LPCTSTR lpExistingFileName,</code>
<code>  LPSECURITY_ATTRIBUTES lpSecurityAttributes);</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">This definition must be mapped to .NET data types. The return
                    type is a <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">BOOL</code>
                    with unmanaged code; this simply maps to the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">bool</code> data type.
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">LPCTSTR</code> defines
                    a <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">long</code> pointer
                    to a <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">const</code>
                    string. The Windows API uses the Hungarian naming convention for the data type. <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">LP</code> is a <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">long</code> pointer,
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">C</code> is a const,
                    and <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">STR</code> is a
                    null-terminated string. The <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">T</code> marks the type
                    as a generic type, and the type is resolved to either <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">LPCSTR</code> (an ANSI
                    string) or <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">LPWSTR</code> (a wide
                    Unicode string), depending on the compiler's settings to 32 or 64 bit. C strings map to the .NET
                    type <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">String</code>.
                    <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">LPSECURITY_ATTRIBUTES</code>
                    is a long pointer to a struct of type <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SECURITY_ATTRIBUTES</code>.
                    You can create a .NET representation of <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SECURITY_ATTRIBUTES</code>
                    with a struct:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">这个定义必须映射到 .NET 数据类型。返回类型是 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">BOOL</code>
                                ，用于未管理代码；这简单地映射到 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">bool</code>
                                数据类型。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">LPCTSTR</code>
                                定义了一个指向 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">const</code>
                                字符串的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">long</code>
                                指针。Windows API 使用匈牙利命名约定来命名数据类型。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">LP</code> 是一个
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">long</code>
                                指针， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">C</code> 是一个
                                const， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">STR</code>
                                是一个空终止字符串。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">T</code>
                                将类型标记为泛型类型，并且根据编译器设置为 32 位或 64 位的设置，类型解析为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">LPCSTR</code>
                                （一个 ANSI 字符串）或 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">LPWSTR</code>
                                （一个宽 Unicode 字符串）。C 字符串映射到 .NET 类型 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">String</code>
                                。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">LPSECURITY_ATTRIBUTES</code>
                                是一个指向 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SECURITY_ATTRIBUTES</code>
                                类型结构的长指针。你可以使用结构来创建 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SECURITY_ATTRIBUTES</code>
                                的 .NET 表示：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0077"><code>struct SECURITY_ATTRIBUTES</code>
<code>{</code>
<code>  uint nLength;</code>
<code>  unsafe void *lpSecurityDescriptor;</code>
<code>  bool bInheritHandle;</code>
<code>}</code></pre>
                <p id="c13-para-0225" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">However, because passing NULL to this argument is allowed,
                    mapping this type to the native int type <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">nint</code> is okay.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">然而，因为允许将 NULL 传递给这个参数，将这种类型映射到本地
                                int 类型 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">nint</code>
                                是可以的。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">The C# declaration of the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CreateHardLink</code>
                    method must be marked with the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">extern</code> modifier
                    because there's no implementation of this method within the C# code. The native implementation is in
                    the DLL <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">kernel32.dll</code>,
                    which is referenced with the attribute <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">[DllImport]</code>. The
                    return type of the .NET declaration <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CreateHardLink</code> is
                    of type <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">bool</code>,
                    and the native method <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CreateHardLink</code>
                    returns a <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">BOOL</code>,
                    so some additional clarification is useful. Because there are different Boolean data types with C++
                    (for example, the native <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">bool</code> and the
                    Windows-defined <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">BOOL</code>, which have
                    different values), the attribute <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">[MarshalAs]</code>
                    specifies to what native type the .NET type <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">bool</code> should map
                    (code file <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">PInvokeSampleLib/Windows/WindowsNativeMethods.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CreateHardLink</code>
                                方法的 C# 声明必须标记为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">extern</code>
                                修饰符，因为在 C# 代码中没有实现这个方法。原生实现位于 DLL <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">kernel32.dll</code>
                                中，该 DLL 通过属性 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">[DllImport]</code>
                                进行引用。.NET 声明 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CreateHardLink</code>
                                的返回类型为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">bool</code>
                                ，而原生方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CreateHardLink</code>
                                返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">BOOL</code>
                                ，因此需要一些额外的说明。由于 C++ 中有不同类型的布尔数据（例如，原生的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">bool</code> 和
                                Windows 定义的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">BOOL</code>
                                ，它们具有不同的值），属性 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">[MarshalAs]</code>
                                指定了 .NET 类型 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">bool</code>
                                应映射到哪种原生类型（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">PInvokeSampleLib/Windows/WindowsNativeMethods.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0078"><code>[DllImport("kernel32.dll", SetLastError = true,</code>
<code>  EntryPoint = "CreateHardLinkW", CharSet = CharSet.Unicode)]</code>
<code>[return: MarshalAs(UnmanagedType.Bool)]</code>
<code>private static extern bool CreateHardLink(</code>
<code>  [In, MarshalAs(UnmanagedType.LPWStr)] string newFileName,</code>
<code>  [In, MarshalAs(UnmanagedType.LPWStr)] string existingFileName,</code>
<code>  nint securityAttributes);</code></pre>
                <p id="c13-para-0227" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">The following table describes the settings that you can
                    specify with the attribute <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">[DllImport]</code>. The
                    <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">DllImportAttribute</code>
                    class is defined in the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">System.Runtime.InteropServices</code>
                    namespace.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">下表描述了您可以使用属性 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">[DllImport]</code>
                                指定的设置。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">DllImportAttribute</code>
                                类在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">System.Runtime.InteropServices</code>
                                命名空间中定义。</font>
                        </font>
                    </font>
                </p>
                <table border="1" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                    <thead data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <tr data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                            <th class="left bgcolor2" scope="col"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                                data-immersive-translate-paragraph="1">DLLIMPORT PROPERTY OR FIELD<font
                                    class="notranslate immersive-translate-target-wrapper"
                                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                    <font
                                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                        data-immersive-translate-translation-element-mark="1">
                                        <font
                                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                            data-immersive-translate-translation-element-mark="1">DLLIMPORT 属性或字段
                                        </font>
                                    </font>
                                </font>
                            </th>
                            <th class="left bgcolor2" scope="col">DESCRIPTION</th>
                        </tr>
                    </thead>
                    <tbody data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                        <tr data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                            <td class="left bgcolor3"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><code
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">EntryPoint</code>
                            </td>
                            <td class="left bgcolor3"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                                data-immersive-translate-paragraph="1">You can give the C# declaration of the function a
                                different name than the one it has with the unmanaged library. The name of the method in
                                the unmanaged library is defined in the field <code
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">EntryPoint</code>.
                                <font class="notranslate immersive-translate-target-wrapper"
                                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                    <font
                                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                        data-immersive-translate-translation-element-mark="1">
                                        <font
                                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                            data-immersive-translate-translation-element-mark="1">您可以将函数的 C#
                                            声明命名为与未管理库中的名称不同。未管理库中方法的名称定义在字段 <code xmlns="http://www.w3.org/1999/xhtml"
                                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">EntryPoint</code>
                                            中。</font>
                                    </font>
                                </font>
                            </td>
                        </tr>
                        <tr data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                            <td class="left bgcolor3"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><code
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CallingConvention</code>
                            </td>
                            <td class="left bgcolor3"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                                data-immersive-translate-paragraph="1">Depending on the compiler or compiler settings
                                that were used to compile the unmanaged function, you can use different calling
                                conventions. The calling convention defines how the parameters are handled and where to
                                put them on the stack. You can define the calling convention by setting an enum value.
                                The Windows API usually uses the <code
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">StdCall</code>
                                calling convention on the Windows operating system, and it uses the <code
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Cdecl</code>
                                calling convention on Windows CE. Setting the value to <code
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CallingConvention.Winapi</code>
                                works for the Windows API.<font class="notranslate immersive-translate-target-wrapper"
                                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                    <font
                                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                        data-immersive-translate-translation-element-mark="1">
                                        <font
                                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                            data-immersive-translate-translation-element-mark="1">
                                            根据用于编译未管理函数的编译器或编译器设置，您可以使用不同的调用约定。调用约定定义了参数的处理方式以及它们在栈上的位置。您可以通过设置枚举值来定义调用约定。Windows
                                            API 在 Windows 操作系统上通常使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">StdCall</code>
                                            调用约定，在 Windows CE 上使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Cdecl</code>
                                            调用约定。将值设置为 <code xmlns="http://www.w3.org/1999/xhtml"
                                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CallingConvention.Winapi</code>
                                            对 Windows API 有效。</font>
                                    </font>
                                </font>
                            </td>
                        </tr>
                        <tr data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                            <td class="left bgcolor3"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><code
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CharSet</code>
                            </td>
                            <td class="left bgcolor3"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                                data-immersive-translate-paragraph="1">String parameters can be either ANSI or Unicode.
                                With the <code
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CharSet</code>
                                setting, you can define how strings are managed. Possible values that are defined with
                                the <code
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CharSet</code>
                                enumeration are <code
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Ansi</code>,
                                <code
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Unicode</code>,
                                and <code
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Auto</code>.
                                <code
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CharSet.Auto</code>
                                uses Unicode on the Windows NT platform, and ANSI on Microsoft's older operating
                                systems.<font class="notranslate immersive-translate-target-wrapper"
                                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                    <font
                                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                        data-immersive-translate-translation-element-mark="1">
                                        <font
                                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                            data-immersive-translate-translation-element-mark="1">字符串参数可以是 ANSI 或
                                            Unicode。在 <code xmlns="http://www.w3.org/1999/xhtml"
                                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CharSet</code>
                                            设置下，您可以定义字符串的管理方式。使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CharSet</code>
                                            枚举定义的可能值有 <code xmlns="http://www.w3.org/1999/xhtml"
                                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Ansi</code>
                                            、 <code xmlns="http://www.w3.org/1999/xhtml"
                                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Unicode</code>
                                            和 <code xmlns="http://www.w3.org/1999/xhtml"
                                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Auto</code>
                                            。 <code xmlns="http://www.w3.org/1999/xhtml"
                                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CharSet.Auto</code>
                                            在 Windows NT 平台上使用 Unicode，在微软的旧操作系统上使用 ANSI。</font>
                                    </font>
                                </font>
                            </td>
                        </tr>
                        <tr data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
                            <td class="left bgcolor3"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><code
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SetLastError</code>
                            </td>
                            <td class="left bgcolor3"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                                data-immersive-translate-paragraph="1">If the unmanaged function sets an error by using
                                the Windows API <code
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SetLastError</code>,
                                you can set the <code
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SetLastError</code>
                                field to <code
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">true</code>.
                                This way, you can read the error number afterward by using <code
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Marshal.GetLastWin32Error</code>.
                                With .NET 6, new APIs are planned. The method <code
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">GetLastWin32Error</code>
                                can be used with Windows and with Linux, although because of this naming, you probably
                                wouldn't expect this API to be available on Linux. Because of the platform-independence
                                of .NET, new API names are planned.<font
                                    class="notranslate immersive-translate-target-wrapper"
                                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                    <font
                                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                        data-immersive-translate-translation-element-mark="1">
                                        <font
                                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                            data-immersive-translate-translation-element-mark="1">如果未管理函数通过使用 Windows
                                            API <code xmlns="http://www.w3.org/1999/xhtml"
                                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SetLastError</code>
                                            设置了错误，你可以将 <code xmlns="http://www.w3.org/1999/xhtml"
                                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SetLastError</code>
                                            字段设置为 <code xmlns="http://www.w3.org/1999/xhtml"
                                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">true</code>
                                            。这样，你就可以使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Marshal.GetLastWin32Error</code>
                                            后续读取错误号。在 .NET 6 中，计划引入新的 API。方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">GetLastWin32Error</code>
                                            可以在 Windows 和 Linux 上使用，尽管由于这个名字，你可能不会期望这个 API 在 Linux 上可用。由于 .NET
                                            的平台独立性，计划引入新的 API 名称。</font>
                                    </font>
                                </font><span aria-label="370" epub:type="pagebreak" id="Page_370" role="doc-pagebreak"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span></td>
                        </tr>
                    </tbody>
                </table>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">To use the Windows API <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CreateHardLink</code>,
                    the external method declaration with the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">DllImport</code>
                    attribute is declared with the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">private</code> access
                    modifier in the class <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">WindowsNativeMethods</code>.
                    A method with the same name (<code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CreateHardLink</code>)
                    but a different implementation is declared in the same class by using an <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">internal</code> access
                    modifier. This method can be used within the library where the class is declared. The .NET
                    implementation invokes the native method, checks for the error code that's retrieved with <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Marshal.GetLastWin32Error</code>,
                    and throws an exception in case of an error. To create an error message from this number, the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Win32Exception</code>
                    class from the namespace <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">System.ComponentModel</code>
                    is used. This class accepts an error number with the constructor and returns a localized error
                    message. In case of an error, an exception of type <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IOException</code> is
                    thrown, which has an inner exception of type <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Win32Exception</code>.
                    The class <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">WindowsNativeMethods</code>
                    has the attribute <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SupportedOSPlatform</code>
                    applied to give information to the programmer using this class that it's only available on the
                    Windows platform (code file <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">PInvokeSampleLib/Windows/WindowsNativeMethods.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">要使用 Windows API <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CreateHardLink</code>
                                ，在类 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">WindowsNativeMethods</code>
                                中使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">private</code>
                                访问修饰符声明外部方法声明，并带有 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">DllImport</code>
                                属性。通过使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">internal</code>
                                访问修饰符，在同一类中声明一个具有相同名称（ <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CreateHardLink</code>
                                ）但不同实现的方法。该方法可以在声明该类的库中使用。.NET 实现调用原生方法，检查使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Marshal.GetLastWin32Error</code>
                                获取的错误代码，并在出错时抛出异常。要从此数字创建错误消息，使用来自命名空间 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">System.ComponentModel</code>
                                的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Win32Exception</code>
                                类。此类接受构造函数中的错误编号，并返回本地化的错误消息。出错时，会抛出类型为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IOException</code>
                                的异常，该异常具有类型为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Win32Exception</code>
                                的内部异常。类 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">WindowsNativeMethods</code>
                                使用了 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">SupportedOSPlatform</code>
                                属性，以向使用该类的程序员提供信息，表明它仅在 Windows 平台上可用（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">PInvokeSampleLib/Windows/WindowsNativeMethods.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0079"><code>using System;</code>
<code>using System.IO;</code>
<code>using System.Runtime.InteropServices;</code>
<code>using System.Runtime.Versioning;</code>
<code> </code>
<code>namespace PInvokeSample</code>
<code>{</code>
<code>  [SupportedOSPlatform("Windows")]</code>
<code>  internal static class WindowsNativeMethods</code>
<code>  {</code>
<code>    <b>[DllImport("kernel32.dll", SetLastError = true,</b></code>
<code>      <b>EntryPoint = "CreateHardLinkW", CharSet = CharSet.Unicode)]</b></code>
<code>    <b>[return: MarshalAs(UnmanagedType.Bool)]</b></code>
<code>    private static extern bool CreateHardLink(</code>
<code>      [In, MarshalAs(UnmanagedType.LPWStr)] string newFileName,</code>
<code>      [In, MarshalAs(UnmanagedType.LPWStr)] string existingFileName,</code>
<code>      nint securityAttributes);</code>
<code> </code>
<code>    internal static void CreateHardLink(string oldFileName,</code>
<code>                                        string newFileName)</code>
<code>    {</code>
<code>      if (!CreateHardLink(newFileName, oldFileName, IntPtr.Zero))<span aria-label="371" epub:type="pagebreak" id="Page_371" role="doc-pagebreak"></span></code>
<code>      {</code>
<code>        int errorCode = Marshal.GetLastWin32Error();</code>
<code>        throw new IOException($"CreateHardLink error: {errorCode}", errorCode);</code>
<code>      }</code>
<code>    }</code>
<code>  }</code>
<code>}</code></pre>
            </section>
            <section data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span id="c13-sec-0059"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                <h3 id="head-3-272" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Calling Native Linux APIs <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">调用原生 Linux API</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">To invoke the link method running on the Linux operating
                    system, the method <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CreateHardLink</code>
                    with the same signature and return type is defined. The Linux version of this method is defined in
                    the class <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">LinuxNativeMethods</code>.
                    The <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CreateHardLink</code>
                    method is implemented to invoke the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Link</code> method. The
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Link</code> method is
                    declared with the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">extern</code> modifier
                    and has the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">DllImport</code>
                    attribute applied. The native method is implemented in the shared library <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">libc</code>
                    ; the name of this shared library is passed to the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">DllImport</code>
                    constructor. In case of an error, the link method doesn't return the value 0. In this case, the
                    <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Marshal.GetLastWin32Error</code>
                    method returns the error code. The possible error codes are defined with the enum <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">LinkErrors</code>, and
                    error messages are defined in a dictionary (code file <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">PInvokeSampleLib/Linux/LinuxNativeMethods.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">为了调用在 Linux
                                操作系统上运行的链接方法，定义了具有相同签名和返回类型的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CreateHardLink</code>
                                方法。这个方法的 Linux 版本在类 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">LinuxNativeMethods</code>
                                中定义。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CreateHardLink</code>
                                方法用于调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Link</code>
                                方法。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Link</code>
                                方法使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">extern</code>
                                修饰符声明，并应用了 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">DllImport</code>
                                属性。原生方法实现在共享库 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">libc</code>
                                中；该共享库名称传递给 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">DllImport</code>
                                构造函数。如果发生错误，链接方法不会返回值 0。在这种情况下， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">Marshal.GetLastWin32Error</code>
                                方法返回错误代码。可能的错误代码使用枚举 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">LinkErrors</code>
                                定义，错误消息定义在字典（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">PInvokeSampleLib/Linux/LinuxNativeMethods.cs</code>
                                ）中：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0080"><code>using System.Collections.Generic;</code>
<code>using System.IO;</code>
<code>using System.Runtime.InteropServices;</code>
<code>using System.Runtime.Versioning;</code>
<code>using static PInvokeSample.LinuxNativeMethods.LinkErrors;</code>
<code> </code>
<code>namespace PInvokeSample</code>
<code>{</code>
<code>  [SupportedOSPlatform("Linux")]</code>
<code>  internal static class LinuxNativeMethods</code>
<code>  {</code>
<code>    internal enum LinkErrors</code>
<code>    {</code>
<code>      EPERM = 1,</code>
<code>      ENOENT = 2,</code>
<code>      EIO = 5,</code>
<code>      EACCES = 13,</code>
<code>      EEXIST = 17,</code>
<code>      EXDEV = 18,</code>
<code>      ENOSPC = 28,</code>
<code>      EROFS = 30,</code>
<code>      EMLINK = 31</code>
<code>    }</code>
<code> </code>
<code>    private static Dictionary&lt;LinkErrors, string&gt; _errorMessages = new()</code>
<code>    {</code>
<code>      { EPERM, "On GNU/Linux and GNU/Hurd systems and some others, you cannot " +</code>
<code>        "make links to directories.Many systems allow only privileged users to do so." },</code>
<code>      { ENOENT, "The file named by oldname doesn't exist. You can't make a link " +</code>
<code>        "to a file that doesn't exist." },</code>
<code>      { EIO, "A hardware error occurred while trying to read or write to the " +  </code>
<code>        "filesystem." },</code>
<code>      //…</code>
<code>    };</code>
<code> </code>
<code> <span aria-label="372" epub:type="pagebreak" id="Page_372" role="doc-pagebreak"></span></code>
<code>    <b>[DllImport("libc",</b> </code>
<code>      <b>EntryPoint = "Link",</b> </code>
<code>      <b>CallingConvention = CallingConvention.Cdecl,</b> </code>
<code>      <b>SetLastError = true)]</b></code>
<code>    private static extern int Link(string oldpath, string newpath);</code>
<code> </code>
<code>    internal static void CreateHardLink(string oldFileName, string newFileName)</code>
<code>    {</code>
<code>      int result = link(newFileName, oldFileName);</code>
<code>      if (result != 0)</code>
<code>        {</code>
<code>          int errorCode = Marshal.GetLastWin32Error();</code>
<code>          if (!_errorMessages.TryGetValue((LinkErrors)errorCode, </code>
<code>            out string? errorText))</code>
<code>          {</code>
<code>            errorText = "No error message defined";</code>
<code>          }</code>
<code>          throw new IOException(errorText, errorCode);</code>
<code>        }</code>
<code>      }</code>
<code>    }</code>
<code>  }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">The only <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">public</code> class
                    offered by the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">PInvokeSampleLib</code>
                    library is <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">FileUtility</code>. Here,
                    the implementation of the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CreateHardLink</code>
                    method checks what operating system the application is running on with the help of the <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">OperatingSystem</code>
                    class. Depending on the result, the parameters <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">oldFileName</code> and
                    <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">newFileName</code> are
                    forwarded to the corresponding method. Compared to the native method, the filename parameters are
                    reversed. This is similar to other .NET classes such as <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">File.Copy</code> and also
                    similar to the Linux <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">link</code> API (code
                    file <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">PInvokeSampleLib/FileUtility.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">PInvokeSampleLib</code>
                                库提供的唯一 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">public</code>
                                类是 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">FileUtility</code>
                                。在这里， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">CreateHardLink</code>
                                方法的实现通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">OperatingSystem</code>
                                类检查应用程序正在运行哪个操作系统。根据结果，参数 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">oldFileName</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">newFileName</code>
                                被转发到相应的方法。与原生方法相比，文件名参数的顺序是相反的。这类似于其他 .NET 类，如 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">File.Copy</code>
                                ，也类似于 Linux <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">link</code>
                                API（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">PInvokeSampleLib/FileUtility.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0081"><code>public static class FileUtility</code>
<code>{</code>
<code>  public static void CreateHardLink(string oldFileName,</code>
<code>                                    string newFileName)</code>
<code>  {</code>
<code>    if (OperatingSystem.IsWindows())</code>
<code>    {</code>
<code>      WindowsNativeMethods.CreateHardLink(oldFileName, newFileName);</code>
<code>    }</code>
<code>    else if (OperatingSystem.IsLinux())</code>
<code>    {</code>
<code>      LinuxNativeMethods.CreateHardLink(oldFileName, newFileName);</code>
<code>    }</code>
<code>    else</code>
<code>    {</code>
<code>      throw new PlatformNotSupportedException();</code>
<code>    }</code>
<code>  }</code>
<code>}</code></pre>
            </section> <span aria-label="373" epub:type="pagebreak" id="Page_373" role="doc-pagebreak"
                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
            <section data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"><span id="c13-sec-0060"
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
                <h3 id="head-3-273" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">Using the Library for Calling Native APIs <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用库调用原生 API</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">You can now use this class to easily create hard links. If
                    the file passed with the first argument of the program does not exist, you get an exception with the
                    message <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">The system cannot find the file specified</code>.
                    If the file exists, you get a new filename that references the original file. You can easily verify
                    this by changing text in one file; it shows up in the other file as well (code file <code
                        data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">PInvokeSample/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                现在您可以使用这个类轻松创建硬链接。如果程序第一个参数传递的文件不存在，您会得到一个消息为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">The system cannot find the file specified</code>
                                的异常。如果文件存在，您会得到一个引用原始文件的新文件名。您可以通过修改一个文件中的文本来轻松验证这一点；它在另一个文件中也会显示出来（代码文件 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">PInvokeSample/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0082"><code>if (args.Length != 2)</code>
<code>{</code>
<code>  Console.WriteLine("usage: PInvokeSample existingfilename newfilename");</code>
<code>  return;</code>
<code>}</code>
<code>try</code>
<code>{</code>
<code>  FileUtility.CreateHardLink(args[0], args[1]);</code>
<code>}</code>
<code>catch (IOException ex)</code>
<code>{</code>
<code>  Console.WriteLine(ex.Message);</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                    data-immersive-translate-paragraph="1">To run the application in a Linux environment, you can use
                    the Windows Subsystem for Linux and run the application using the Windows terminal. With the Linux
                    version of the application, if you specify a source file that does not exist, the following error
                    message is shown:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">要在 Linux 环境中运行应用程序，您可以使用 Windows
                                子系统 for Linux 并使用 Windows 终端运行应用程序。使用应用程序的 Linux 版本时，如果您指定一个不存在的源文件，将显示以下错误消息：</font>
                        </font>
                    </font>
                </p>
                <pre id="c13-code-0083"><code>The file named by oldname doesn't exist. You can't make a link to a file </code>
<code>that doesn't exist.</code></pre>
            </section>
        </section>
        <section aria-labelledby="head-2-120" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">
            <span id="c13-sec-0061" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"></span>
            <h2 id="head-2-120" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1">SUMMARY<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">摘要</font>
                    </font>
                </font>
            </h2>
            <p id="c13-para-0234" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1">Remember that to become a truly proficient C# programmer, you
                must have a solid understanding of how memory allocation and garbage collection work. This chapter
                described how the CLR manages and allocates memory on the heap and the stack. It also illustrated how to
                write classes that free unmanaged resources correctly and how to use pointers in C#. These are both
                advanced topics that are poorly understood and often implemented incorrectly by novice programmers. At a
                minimum, this chapter should have helped you understand how to release resources using the <code
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code> interface
                and the <code data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                declaration.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">记住，要成为一名真正熟练的
                            C#程序员，你必须对内存分配和垃圾回收的工作原理有扎实的理解。本章描述了 CLR 如何管理和分配堆和栈上的内存。它还说明了如何编写正确释放未管理资源的类，以及如何在
                            C#中使用指针。这些都是高级主题，新手程序员往往理解不透彻且常常实现不正确。至少，本章应该帮助你理解如何使用 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">IDisposable</code>
                            接口和 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">using</code>
                            声明来释放资源。</font>
                    </font>
                </font>
            </p>
            <p id="c13-para-0235" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1">You've also seen how to write code to invoke native methods of
                the Windows and Linux platforms. Many .NET APIs are built with native APIs behind, and you don't need to
                write your own <code
                    data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">extern</code> declared
                methods. However, there are still many functions not covered from .NET, and you can use this technique
                to invoke these. You probably have some other C++ libraries that would be too hard to port to .NET, but
                now you can simply invoke these methods.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">你还看到了如何编写代码来调用 Windows 和 Linux
                            平台的本地方法。许多.NET API 背后都是基于本地 API 构建的，你不需要自己编写 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585">extern</code>
                            声明的本地方法。然而，仍然有许多.NET 未涵盖的功能，你可以使用这种技术来调用这些功能。你可能有一些其他难以移植到.NET 的 C++库，但现在你可以简单地调用这些方法。
                        </font>
                    </font>
                </font>
            </p>
            <p id="c13-para-0236" data-immersive-translate-walked="5fd06ec7-2dc4-43f8-b6bf-f2e4976a8585"
                data-immersive-translate-paragraph="1">The first part of the book concludes with this chapter. The next
                chapter starts to dive into creating libraries and NuGet packages.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">本书的第一部分以本章结束。下一章开始深入探讨创建库和 NuGet 包。
                        </font>
                    </font>
                </font>
            </p>
        </section>
    </section>
</body>
<div id="immersive-translate-popup" style="all: initial"></div>

</html>