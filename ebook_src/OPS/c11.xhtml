<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops"
    xmlns:svg="http://www.w3.org/2000/svg" epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en"
    imt-state="dual" imt-trans-position="after">

<head>
    <title>11 任务和异步编程 --- 11 Tasks and Asynchronous Programming</title>
    <link href="WileyTemplate_v5.5.css" rel="stylesheet" type="text/css" />
    <meta content="urn:uuid:e0000000-0000-0000-0000-000006715209" name="Adept.expected.resource" />
    <style data-id="immersive-translate-input-injected-css">
        .immersive-translate-input {
            position: absolute;
            top: 0;
            right: 0;
            left: 0;
            bottom: 0;
            z-index: 2147483647;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .immersive-translate-attach-loading::after {
            content: " ";

            --loading-color: #f78fb6;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: block;
            margin: 12px auto;
            position: relative;
            color: white;
            left: -100px;
            box-sizing: border-box;
            animation: immersiveTranslateShadowRolling 1.5s linear infinite;

            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-2000%, -50%);
            z-index: 100;
        }

        .immersive-translate-loading-spinner {
            vertical-align: middle !important;
            width: 10px !important;
            height: 10px !important;
            display: inline-block !important;
            margin: 0 4px !important;
            border: 2px rgba(221, 244, 255, 0.6) solid !important;
            border-top: 2px rgba(0, 0, 0, 0.375) solid !important;
            border-left: 2px rgba(0, 0, 0, 0.375) solid !important;
            border-radius: 50% !important;
            padding: 0 !important;
            -webkit-animation: immersive-translate-loading-animation 0.6s infinite linear !important;
            animation: immersive-translate-loading-animation 0.6s infinite linear !important;
        }

        @-webkit-keyframes immersive-translate-loading-animation {
            from {
                -webkit-transform: rotate(0deg);
            }

            to {
                -webkit-transform: rotate(359deg);
            }
        }

        @keyframes immersive-translate-loading-animation {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(359deg);
            }
        }

        .immersive-translate-input-loading {
            --loading-color: #f78fb6;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: block;
            margin: 12px auto;
            position: relative;
            color: white;
            left: -100px;
            box-sizing: border-box;
            animation: immersiveTranslateShadowRolling 1.5s linear infinite;
        }

        @keyframes immersiveTranslateShadowRolling {
            0% {
                box-shadow: 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0),
                    0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
            }

            12% {
                box-shadow: 100px 0 var(--loading-color), 0px 0 rgba(255, 255, 255, 0),
                    0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
            }

            25% {
                box-shadow: 110px 0 var(--loading-color), 100px 0 var(--loading-color),
                    0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
            }

            36% {
                box-shadow: 120px 0 var(--loading-color), 110px 0 var(--loading-color),
                    100px 0 var(--loading-color), 0px 0 rgba(255, 255, 255, 0);
            }

            50% {
                box-shadow: 130px 0 var(--loading-color), 120px 0 var(--loading-color),
                    110px 0 var(--loading-color), 100px 0 var(--loading-color);
            }

            62% {
                box-shadow: 200px 0 rgba(255, 255, 255, 0), 130px 0 var(--loading-color),
                    120px 0 var(--loading-color), 110px 0 var(--loading-color);
            }

            75% {
                box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0),
                    130px 0 var(--loading-color), 120px 0 var(--loading-color);
            }

            87% {
                box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0),
                    200px 0 rgba(255, 255, 255, 0), 130px 0 var(--loading-color);
            }

            100% {
                box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0),
                    200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0);
            }
        }

        .immersive-translate-toast {
            display: flex;
            position: fixed;
            z-index: 2147483647;
            left: 0;
            right: 0;
            top: 1%;
            width: fit-content;
            padding: 12px 20px;
            margin: auto;
            overflow: auto;
            background: #fef6f9;
            box-shadow: 0px 4px 10px 0px rgba(0, 10, 30, 0.06);
            font-size: 15px;
            border-radius: 8px;
            color: #333;
        }

        .immersive-translate-toast-content {
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        .immersive-translate-toast-hidden {
            margin: 0 20px 0 72px;
            text-decoration: underline;
            cursor: pointer;
        }

        .immersive-translate-toast-close {
            color: #666666;
            font-size: 20px;
            font-weight: bold;
            padding: 0 10px;
            cursor: pointer;
        }

        @media screen and (max-width: 768px) {
            .immersive-translate-toast {
                top: 0;
                padding: 12px 0px 0 10px;
            }

            .immersive-translate-toast-content {
                flex-direction: column;
                text-align: center;
            }

            .immersive-translate-toast-hidden {
                margin: 10px auto;
            }
        }

        .immersive-translate-modal {
            display: none;
            position: fixed;
            z-index: 2147483647;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0, 0, 0);
            background-color: rgba(0, 0, 0, 0.4);
            font-size: 15px;
        }

        .immersive-translate-modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 40px 24px 24px;
            border: 1px solid #888;
            border-radius: 10px;
            width: 80%;
            max-width: 270px;
            font-family: system-ui, -apple-system, "Segoe UI", "Roboto", "Ubuntu",
                "Cantarell", "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji",
                "Segoe UI Symbol", "Noto Color Emoji";
            position: relative;
        }

        @media screen and (max-width: 768px) {
            .immersive-translate-modal-content {
                margin: 50% auto !important;
            }
        }

        .immersive-translate-modal .immersive-translate-modal-content-in-input {
            max-width: 500px;
        }

        .immersive-translate-modal-content-in-input .immersive-translate-modal-body {
            text-align: left;
            max-height: unset;
        }

        .immersive-translate-modal-title {
            text-align: center;
            font-size: 16px;
            font-weight: 700;
            color: #333333;
        }

        .immersive-translate-modal-body {
            text-align: center;
            font-size: 14px;
            font-weight: 400;
            color: #333333;
            word-break: break-all;
            margin-top: 24px;
        }

        @media screen and (max-width: 768px) {
            .immersive-translate-modal-body {
                max-height: 250px;
                overflow-y: auto;
            }
        }

        .immersive-translate-close {
            color: #666666;
            position: absolute;
            right: 16px;
            top: 16px;
            font-size: 20px;
            font-weight: bold;
        }

        .immersive-translate-close:hover,
        .immersive-translate-close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .immersive-translate-modal-footer {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 24px;
        }

        .immersive-translate-btn {
            width: fit-content;
            color: #fff;
            background-color: #ea4c89;
            border: none;
            font-size: 16px;
            margin: 0 8px;
            padding: 9px 30px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .immersive-translate-btn:hover {
            background-color: #f082ac;
        }

        .immersive-translate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .immersive-translate-btn:disabled:hover {
            background-color: #ea4c89;
        }

        .immersive-translate-cancel-btn {
            /* gray color */
            background-color: rgb(89, 107, 120);
        }

        .immersive-translate-cancel-btn:hover {
            background-color: hsl(205, 20%, 32%);
        }

        .immersive-translate-action-btn {
            background-color: transparent;
            color: #ea4c89;
            border: 1px solid #ea4c89;
        }

        .immersive-translate-btn svg {
            margin-right: 5px;
        }

        .immersive-translate-link {
            cursor: pointer;
            user-select: none;
            -webkit-user-drag: none;
            text-decoration: none;
            color: #007bff;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
        }

        .immersive-translate-primary-link {
            cursor: pointer;
            user-select: none;
            -webkit-user-drag: none;
            text-decoration: none;
            color: #ea4c89;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
        }

        .immersive-translate-modal input[type="radio"] {
            margin: 0 6px;
            cursor: pointer;
        }

        .immersive-translate-modal label {
            cursor: pointer;
        }

        .immersive-translate-close-action {
            position: absolute;
            top: 2px;
            right: 0px;
            cursor: pointer;
        }

        .imt-image-status {
            background-color: rgba(0, 0, 0, 0.5) !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 16px !important;
        }

        .imt-image-status img,
        .imt-image-status svg,
        .imt-img-loading {
            width: 28px !important;
            height: 28px !important;
            margin: 0 0 8px 0 !important;
            min-height: 28px !important;
            min-width: 28px !important;
            position: relative !important;
        }

        .imt-img-loading {
            background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADgAAAA4CAMAAACfWMssAAAAtFBMVEUAAAD////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////oK74hAAAAPHRSTlMABBMIDyQXHwyBfFdDMSw+OjXCb+5RG51IvV/k0rOqlGRM6KKMhdvNyZBz9MaupmxpWyj437iYd/yJVNZeuUC7AAACt0lEQVRIx53T2XKiUBCA4QYOiyCbiAsuuGBcYtxiYtT3f6/pbqoYHVFO5r+iivpo6DpAWYpqeoFfr9f90DsYAuRSWkFnPO50OgR9PwiCUFcl2GEcx+N/YBh6pvKaefHlUgZd1zVe0NbYcQjGBfzrPE8Xz8aF+71D8gG6DHFPpc4a7xFiCDuhaWgKgGIJQ3d5IMGDrpS4S5KgpIm+en9f6PlAhKby4JwEIxlYJV9h5k5nee9GoxHJ2IDSNB0dwdad1NAxDJ/uXDHYmebdk4PdbkS58CIVHdYSUHTYYRWOJblWSyu2lmy3KNFVJNBhxcuGW4YBVCbYGRZwIooipHsNqjM4FbgOQqQqSKQQU9V8xmi1QlgHqQQ6DDBvRUVCDirs+EzGDGOQTCATgtYTnbCVLgsVgRE0T1QE0qHCFAht2z6dLvJQs3Lo2FQoDxWNUiBhaP4eRgwNkI+dAjVOA/kUrIDwf3CG8NfNOE0eiFotSuo+rBiq8tD9oY4Qzc6YJw99hl1wzpQvD7ef2M8QgnOGJfJw+EltQc+oX2yn907QB22WZcvlUpd143dqQu+8pCJZuGE4xCuPXJqqcs5sNpsI93Rmzym1k4Npk+oD1SH3/a3LOK/JpUBpWfqNySxWzCfNCUITuDG5dtuphrUJ1myeIE9bIsPiKrfqTai5WZxbhtNphYx6GEIHihyGFTI69lje/rxajdh0s0msZ0zYxyPLhYCb1CyHm9Qsd2H37Y3lugVwL9kNh8Ot8cha6fUNQ8nuXi5z9/ExsAO4zQrb/ev1yrCB7lGyQzgYDGuxq1toDN/JGvN+HyWNHKB7zEoK+PX11e12G431erGYzwmytAWU56fkMHY5JJnDRR2eZji3AwtIcrEV8Cojat/BdQ7XOwGV1e1hDjGGjXbdArm8uJZtCH5MbcctVX8A1WpqumJHwckAAAAASUVORK5CYII=");
            background-size: 28px 28px;
            animation: image-loading-rotate 1s linear infinite !important;
        }

        .imt-image-status span {
            color: var(--bg-2, #fff) !important;
            font-size: 14px !important;
            line-height: 14px !important;
            font-weight: 500 !important;
            font-family: "PingFang SC", Arial, sans-serif !important;
        }

        @keyframes image-loading-rotate {
            from {
                transform: rotate(360deg);
            }

            to {
                transform: rotate(0deg);
            }
        }
    </style>
    <style data-id="immersive-translate-default-injected-css">
        :root {
            --immersive-translate-theme-underline-borderColor: #72ece9;
            --immersive-translate-theme-nativeUnderline-borderColor: #72ece9;
            --immersive-translate-theme-nativeDashed-borderColor: #72ece9;
            --immersive-translate-theme-nativeDotted-borderColor: #72ece9;
            --immersive-translate-theme-highlight-backgroundColor: #ffff00;
            --immersive-translate-theme-dashed-borderColor: #59c1bd;
            --immersive-translate-theme-blockquote-borderColor: #cc3355;
            --immersive-translate-theme-thinDashed-borderColor: #ff374f;
            --immersive-translate-theme-dashedBorder-borderColor: #94a3b8;
            --immersive-translate-theme-dashedBorder-borderRadius: 0;
            --immersive-translate-theme-solidBorder-borderColor: #94a3b8;
            --immersive-translate-theme-solidBorder-borderRadius: 0;
            --immersive-translate-theme-dotted-borderColor: #94a3b8;
            --immersive-translate-theme-wavy-borderColor: #72ece9;
            --immersive-translate-theme-dividingLine-borderColor: #94a3b8;
            --immersive-translate-theme-grey-textColor: #2f4f4f;
            --immersive-translate-theme-marker-backgroundColor: #fbda41;
            --immersive-translate-theme-marker-backgroundColor-rgb: 251, 218, 65;
            --immersive-translate-theme-marker2-backgroundColor: #ffff00;
            --immersive-translate-theme-background-backgroundColor: #dbafaf;
            --immersive-translate-theme-background-backgroundColor-rgb: 219, 175, 175;
            --immersive-translate-theme-background-backgroundOpacity: 12;
            --immersive-translate-theme-opacity-opacity: 10;
        }

        [imt-state="dual"] .immersive-translate-target-translation-pre-whitespace {
            white-space: pre-wrap !important;
        }

        [imt-state="dual"] .immersive-translate-pdf-target-container {
            position: absolute;
            background-color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica,
                sans-serif;
            top: 0;
            width: 600px;
            height: 100%;
            z-index: 2;
            line-height: 1.3;
            font-size: 16px;
        }

        [imt-state="dual"] .immersive-translate-target-wrapper[dir="rtl"] {
            text-align: right;
        }

        [imt-state="dual"] .immersive-translate-pdf-target-container .immersive-translate-target-wrapper {
            color: rgb(0, 0, 0);
            white-space: normal;
            position: absolute;
        }

        [imt-state="dual"] .immersive-translate-pdf-target-container .immersive-translate-target-wrapper font {
            color: inherit;
            white-space: inherit;
            position: unset;
        }

        [imt-state="translation"] .immersive-translate-target-wrapper &gt;

        br {
            display: none;
        }

        [imt-state="translation"] .immersive-translate-target-translation-block-wrapper {
            margin: 0 !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper {
            margin: 8px 0 !important;
            display: inline-block;
        }

        [imt-trans-position="before"] .immersive-translate-target-translation-block-wrapper {
            display: block;
        }

        [imt-trans-position="before"] .immersive-translate-target-translation-block-wrapper {
            margin-top: 0 !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-pdf-block-wrapper {
            margin: 0 !important;
            display: inline-block;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-grey-inner {
            color: var(--immersive-translate-theme-grey-textColor);
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-underline-inner {
            border-bottom: 1px solid var(--immersive-translate-theme-underline-borderColor) !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-nativeUnderline-inner {
            text-decoration: underline !important;
            text-decoration-color: var(--immersive-translate-theme-nativeUnderline-borderColor) !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper-theme-dashedBorder {
            border: 1px dashed var(--immersive-translate-theme-dashedBorder-borderColor) !important;
            border-radius: var(--immersive-translate-theme-dashedBorder-borderRadius) !important;
            padding: 6px;
            margin-top: 2px;
            display: inline-block;
        }

        [imt-state="dual"] .immersive-translate-target-translation-inline-wrapper-theme-dashedBorder {
            border: 1px dashed var(--immersive-translate-theme-dashedBorder-borderColor) !important;
            border-radius: var(--immersive-translate-theme-dashedBorder-borderRadius) !important;
            padding: 2px;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper-theme-solidBorder {
            border: 1px solid var(--immersive-translate-theme-solidBorder-borderColor) !important;
            border-radius: var(--immersive-translate-theme-solidBorder-borderRadius) !important;
            padding: 6px;
            margin-top: 2px;
            display: inline-block;
        }

        [imt-state="dual"] .immersive-translate-target-translation-inline-wrapper-theme-solidBorder {
            border: 1px solid var(--immersive-translate-theme-solidBorder-borderColor) !important;
            border-radius: var(--immersive-translate-theme-solidBorder-borderRadius) !important;
            padding: 2px;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-nativeDashed-inner {
            text-decoration: underline !important;
            text-decoration-color: var(--immersive-translate-theme-nativeDashed-borderColor) !important;
            text-decoration-style: dashed !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-thinDashed-inner {
            border-bottom: 1px dashed var(--immersive-translate-theme-thinDashed-borderColor) !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-dotted-inner {
            background-image: linear-gradient(to right,
                    var(--immersive-translate-theme-dotted-borderColor) 30%,
                    rgba(255, 255, 255, 0) 0%);
            background-position: bottom;
            background-size: 5px 1px;
            background-repeat: repeat-x;
            padding-bottom: 3px;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-nativeDotted-inner {
            text-decoration: underline !important;
            text-decoration-color: var(--immersive-translate-theme-nativeDotted-borderColor) !important;
            text-decoration-style: dotted !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-wavy-inner {
            text-decoration: underline !important;
            text-decoration-color: var(--immersive-translate-theme-wavy-borderColor) !important;
            text-decoration-style: wavy !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-dashed-inner {
            background: linear-gradient(to right,
                    var(--immersive-translate-theme-dashed-borderColor) 0%,
                    var(--immersive-translate-theme-dashed-borderColor) 50%,
                    transparent 50%,
                    transparent 100%) repeat-x left bottom;
            background-size: 8px 2px;
            padding-bottom: 2px;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper-theme-dividingLine::before {
            content: "";
            display: block;
            max-width: 80px;
            width: 10%;
            border-top: 1px dashed var(--immersive-translate-theme-dividingLine-borderColor);
            padding-top: 8px;
        }

        [imt-state="dual"] .immersive-translate-target-translation-inline-wrapper-theme-dividingLine::before {
            content: "";
            border-left: 1px dashed var(--immersive-translate-theme-dividingLine-borderColor);
            max-height: 16px;
            height: 16px;
            padding-left: 8px;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-highlight-inner {
            background: var(--immersive-translate-theme-highlight-backgroundColor);
            box-decoration-break: clone;
            -webkit-box-decoration-break: clone;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper-theme-marker {
            line-height: 1.5em;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-marker2-inner {
            font-weight: bold;
            text-shadow: 10px 0px 3px var(--immersive-translate-theme-marker2-backgroundColor),
                16px 3px 9px var(--immersive-translate-theme-marker2-backgroundColor),
                2px 0px 6px var(--immersive-translate-theme-marker2-backgroundColor),
                -12px 0px 12px var(--immersive-translate-theme-marker2-backgroundColor) !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-marker-inner {
            /* TODO: add more texture */
            background: linear-gradient(to right,
                    rgba(var(--immersive-translate-theme-marker-backgroundColor-rgb), 0.1),
                    rgba(var(--immersive-translate-theme-marker-backgroundColor-rgb), 0.9) 3%,
                    rgba(var(--immersive-translate-theme-marker-backgroundColor-rgb), 0.9) 35%,
                    rgba(var(--immersive-translate-theme-marker-backgroundColor-rgb), 0.9) 70%,
                    rgba(var(--immersive-translate-theme-marker-backgroundColor-rgb), 0.8) 95%,
                    rgba(var(--immersive-translate-theme-marker-backgroundColor-rgb), 0.3));
            box-decoration-break: clone;
            -webkit-box-decoration-break: clone;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-weakening {
            opacity: 0.618 !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-italic {
            font-style: italic !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-bold {
            font-weight: bold !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper-theme-paper {
            margin: 8px 0;
            box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
            padding: 16px 32px;
            display: inline-block;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper-theme-blockquote {
            border-left: 4px solid var(--immersive-translate-theme-blockquote-borderColor) !important;
            padding-left: 12px !important;
            margin-top: 4px;
            margin-bottom: 4px;
            padding-top: 4px;
            padding-bottom: 4px;
            display: inline-block;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-mask-inner {
            filter: blur(5px) !important;
            transition: filter 0.3s ease !important;
            border-radius: 10px;
            display: inline-block;
        }

        [data-immersive-translate-root-translation-theme="none"] .immersive-translate-target-translation-theme-mask-inner {
            filter: none !important;
        }

        [data-immersive-translate-root-translation-theme="mask"] .immersive-translate-target-inner {
            filter: blur(5px) !important;
            transition: filter 0.3s ease !important;
            border-radius: 10px;
            display: inline-block;
        }

        /* opacity theme start */

        [imt-state="dual"] .immersive-translate-target-translation-theme-opacity-inner {
            filter: opacity(calc(var(--immersive-translate-theme-opacity-opacity) * 1%)) !important;
            transition: filter 0.3s ease !important;
            border-radius: 10px;
            display: inline-block;
        }

        [data-immersive-translate-root-translation-theme="none"] .immersive-translate-target-translation-theme-opacity-inner {
            filter: none !important;
        }

        [data-immersive-translate-root-translation-theme="opacity"] .immersive-translate-target-inner,
        [imt-state="dual"] .immersive-translate-target-translation-theme-opacity-inner:hover {
            filter: opacity(calc(var(--immersive-translate-theme-opacity-opacity) * 1%)) !important;
            transition: filter 0.3s ease !important;
            border-radius: 10px;
            display: inline-block;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-opacity-inner:hover {
            filter: none !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-mask-inner:hover {
            filter: none !important;
        }

        [data-immersive-translate-root-translation-theme="opacity"] .immersive-translate-target-inner:hover {
            filter: none !important;
        }

        [data-immersive-translate-root-translation-theme="mask"] .immersive-translate-target-inner:hover {
            filter: none !important;
        }

        /* opacity theme end */

        /* background theme start */
        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper-theme-background {
            margin: 8px 0;
            background: rgba(var(--immersive-translate-theme-background-backgroundColor-rgb),
                    calc(var(--immersive-translate-theme-background-backgroundOpacity) * 1%));
            border-radius: 4px;
            box-shadow: unset !important;
            padding: 12px;
            display: inline-block;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-background-inner {
            background: rgba(var(--immersive-translate-theme-background-backgroundColor-rgb),
                    calc(var(--immersive-translate-theme-background-backgroundOpacity) * 1%));
            padding-left: 6px;
            padding-right: 6px;
            box-decoration-break: clone;
            -webkit-box-decoration-break: clone;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper .immersive-translate-target-translation-theme-background-inner {
            background: unset;
            padding-left: unset;
            padding-right: unset;
        }

        /* background theme end */

        /* vertical css , please remain it in the last one. */
        .immersive-translate-target-translation-vertical-block-wrapper {
            margin: 0px 8px !important;
        }

        .immersive-translate-text {
            font-size: 15px !important;
        }

        .immersive-translate-error-toast {
            position: fixed;
            top: 5%;
            z-index: 99999999;
            left: 0;
            right: 0;
            margin: auto;
            max-width: 300px;
            padding: 16px;
            border-radius: 12px;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: row;
            justify-content: space-between;
        }

        @media all and (min-width: 750px) {
            .immersive-translate-error-toast {
                max-width: 400px;
            }
        }

        .immersive-translate-clickable-button {
            cursor: pointer;
        }

        .immersive-translate-help-button {
            cursor: pointer;
        }

        .immersive-translate-loading-text:before {
            content: "...";
        }

        /* dark mode for loading */

        @media only screen and (prefers-color-scheme: dark) {
            .immersive-translate-loading {
                border: 2px rgba(255, 255, 255, 0.25) solid !important;
                border-top: 2px rgba(255, 255, 255, 1) solid !important;
            }
        }

        .immersive-translate-error-wrapper {
            position: relative;
            display: inline-flex;
            padding: 6px;
            margin: 0 12px;
            white-space: nowrap;
            font-size: 0.9em;
        }

        [lang="zh-CN"] .immersive-translate-error-wrapper {
            font-size: 0.75em;
        }

        [lang="zh-TW"] .immersive-translate-error-wrapper {
            font-size: 0.75em;
        }

        .immersive-translate-tooltip {
            position: relative;
            display: inline-flex;
            /* little indicater to indicate it's hoverable */
        }

        .immersive-translate-tooltip-content {
            /* here's the magic */
            position: absolute;
            z-index: 100000000000;

            left: 50%;
            bottom: 0;
            transform: translate(-50%, 110%);
            line-height: 1;
            /* and add a small left margin */

            /* basic styles */
            width: max-content;
            max-width: 250px;
            word-wrap: break-word;
            white-space: pre-line;
            padding: 10px;
            border-radius: 10px;
            background: #000c;
            color: #fff;
            text-align: center;
            font-size: 14px;
            display: none;
            /* hide by default */
        }

        .immersive-translate-tooltip:hover .immersive-translate-tooltip-content {
            display: inline-block;
        }

        .immersive-translate-tooltip:hover+.immersive-translate-tooltip-content {
            display: inline-block;
        }

        .immersive-translate-tooltip-content-table {
            left: unset !important;
            bottom: unset !important;
            transform: translate(-10%, 50%) !important;
        }

        .immersive-translate-tooltip:hover:before {
            display: inline-block;
        }

        .immersive-translate-loading-spinner {
            vertical-align: middle !important;
            width: 10px !important;
            height: 10px !important;
            display: inline-block !important;
            margin: 0 4px !important;
            border: 2px rgba(221, 244, 255, 0.6) solid !important;
            border-top: 2px rgba(0, 0, 0, 0.375) solid !important;
            border-left: 2px rgba(0, 0, 0, 0.375) solid !important;
            border-radius: 50% !important;
            padding: 0 !important;
            -webkit-animation: immersive-translate-loading-animation 0.6s infinite linear !important;
            animation: immersive-translate-loading-animation 0.6s infinite linear !important;
        }

        @-webkit-keyframes immersive-translate-loading-animation {
            from {
                -webkit-transform: rotate(0deg);
            }

            to {
                -webkit-transform: rotate(359deg);
            }
        }

        @keyframes immersive-translate-loading-animation {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(359deg);
            }
        }

        .imt-image-status {
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--bg-2, #fff);
            font-size: 14px;
        }
    </style>
    <style data-id="immersive-translate-user-custom-style">
        :root {

            .immersive-translate-target-inner {
                font-family: inherit;
            }


            .immersive-translate-target-inner {
                font-family: inherit;
            }
        }
    </style>
    <style data-id="immersive-translate-dynamic-injected-css">
        .immersive-translate-target-wrapper[dir='rtl'] {
            text-align: right;
        }

        .immersive-translate-target-wrapper[dir='rtl'] [data-immersive-translate-class-bak*='block-wrapper'] {
            display: block;
        }

        .immersive-translate-target-wrapper {
            word-break: break-word;
            user-select: text;
        }

        [imt-state="translation"] .immersive-translate-target-wrapper[dir='rtl'] {
            display: inline-block;
        }

        [dir='rtl'] .immersive-translate-target-wrapper:not([dir]) {
            text-align: left;
        }

        [imt-state=dual] .immersive-translate-target-translation-block-wrapper-theme-dividingLine::before {
            display: block;
        }

        [imt-trans-position=before] .immersive-translate-target-translation-block-wrapper {
            display: block !important;
        }

        [imt-state][data-immersive-translate_rtl] .immersive-translate-target-wrapper {
            display: block !important;
        }
    </style>
</head>

<body epub:type="bodymatter" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
    <section aria-labelledby="c11_1" epub:type="chapter" role="doc-chapter"
        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
        <header data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
            <h1 id="c11_1" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1"><span aria-label="288" epub:type="pagebreak" id="Page_288"
                    role="doc-pagebreak"
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span><span id="c11"
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span><span
                    class="chapterNumber"
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">11</span><br /><span
                    class="chapterTitle" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Tasks
                    and Asynchronous Programming</span></h1>
        </header>
        <section aria-label="chapter opening" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
            <span id="c11-sec-0001" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
            <aside data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                <div class="top hr" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <hr />
                </div>
                <section class="feature3" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <h3 data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                        data-immersive-translate-paragraph="1">WHAT'S IN THIS CHAPTER?<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">本章包含什么内容？</font>
                            </font>
                        </font>
                    </h3>
                    <ul class="check2" id="c11-list-0001"
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                        <li id="c11-li-0001" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                            data-immersive-translate-paragraph="1">The importance of asynchronous programming<font
                                class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">异步编程的重要性</font>
                                </font>
                            </font>
                        </li>
                        <li id="c11-li-0002" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                            data-immersive-translate-paragraph="1">Using the <code
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code> and
                            <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                            keywords with the task-based async pattern<font
                                class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">使用 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code>
                                        和 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                                        关键字与基于任务的异步模式</font>
                                </font>
                            </font>
                        </li>
                        <li id="c11-li-0003" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                            data-immersive-translate-paragraph="1">Creating and using tasks</li>
                        <li id="c11-li-0004" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                            data-immersive-translate-paragraph="1">Foundations of asynchronous programming<font
                                class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">异步编程的基础</font>
                                </font>
                            </font>
                        </li>
                        <li id="c11-li-0005" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                            data-immersive-translate-paragraph="1">Error handling with asynchronous methods<font
                                class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">异步方法中的错误处理</font>
                                </font>
                            </font>
                        </li>
                        <li id="c11-li-0006" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                            data-immersive-translate-paragraph="1">Cancellation of asynchronous methods<font
                                class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">异步方法的取消</font>
                                </font>
                            </font>
                        </li>
                        <li id="c11-li-0007" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                            data-immersive-translate-paragraph="1">Async streams</li>
                        <li id="c11-li-0008" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                            data-immersive-translate-paragraph="1">Asynchronous programming with Windows apps<font
                                class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">Windows 应用中的异步编程</font>
                                </font>
                            </font>
                        </li>
                    </ul>
                    <div class="bottom hr" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                        <hr />
                    </div>
                </section>
            </aside>
            <aside data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                <div class="top hr" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <hr />
                </div>
                <section class="feature3" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"><span
                        id="c11-fea-0001" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
                    <h3 id="head-2-95" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                        data-immersive-translate-paragraph="1">CODE DOWNLOADS FOR THIS CHAPTER<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">本章代码下载</font>
                            </font>
                        </font>
                    </h3>
                    <section data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"><span
                            id="c11-sec-0002"
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
                        <p id="c11-para-0003" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                            data-immersive-translate-paragraph="1">The source code for this chapter is available on the
                            book page at <code
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"><a href="http://www.wiley.com">www.wiley.com</a></code>.
                            Click the Downloads link. The code can also be found at <code
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"><a href="https://github.com/ProfessionalCSharp/ProfessionalCSharp2021">https://github.com/ProfessionalCSharp/ProfessionalCSharp2021</a></code>
                            in the directory <code
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">1_CS/Tasks</code>.
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">本章的源代码可在书籍页面 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"><a href="http://www.wiley.com">www.wiley.com</a></code>
                                        上找到。点击下载链接。代码也可以在目录 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">1_CS/Tasks</code>
                                        中的 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"><a href="https://github.com/ProfessionalCSharp/ProfessionalCSharp2021">https://github.com/ProfessionalCSharp/ProfessionalCSharp2021</a></code>
                                        找到。</font>
                                </font>
                            </font>
                        </p>
                        <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                            data-immersive-translate-paragraph="1">The code for this chapter is divided into the
                            following major examples:<font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">本章的代码分为以下主要示例：</font>
                                </font>
                            </font>
                        </p>
                        <ul class="check" id="c11-list-0002"
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                            <li id="c11-li-0009" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                                data-immersive-translate-paragraph="1">TaskBasedAsyncPattern</li>
                            <li id="c11-li-0010" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                                data-immersive-translate-paragraph="1">TaskFoundations<font
                                    class="notranslate immersive-translate-target-wrapper"
                                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  
                                    </font>
                                    <font
                                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                        data-immersive-translate-translation-element-mark="1">
                                        <font
                                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                            data-immersive-translate-translation-element-mark="1">任务基础</font>
                                    </font>
                                </font>
                            </li>
                            <li id="c11-li-0011" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                                data-immersive-translate-paragraph="1">ErrorHandling<font
                                    class="notranslate immersive-translate-target-wrapper"
                                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  
                                    </font>
                                    <font
                                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                        data-immersive-translate-translation-element-mark="1">
                                        <font
                                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                            data-immersive-translate-translation-element-mark="1">错误处理</font>
                                    </font>
                                </font>
                            </li>
                            <li id="c11-li-0012" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                                data-immersive-translate-paragraph="1">AsyncStreams<font
                                    class="notranslate immersive-translate-target-wrapper"
                                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  
                                    </font>
                                    <font
                                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                        data-immersive-translate-translation-element-mark="1">
                                        <font
                                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                            data-immersive-translate-translation-element-mark="1">异步流</font>
                                    </font>
                                </font>
                            </li>
                            <li id="c11-li-0013" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                                data-immersive-translate-paragraph="1">AsyncDesktopWindowsApp<font
                                    class="notranslate immersive-translate-target-wrapper"
                                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  
                                    </font>
                                    <font
                                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                        data-immersive-translate-translation-element-mark="1">
                                        <font
                                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                            data-immersive-translate-translation-element-mark="1">异步桌面应用程序</font>
                                    </font>
                                </font>
                            </li>
                        </ul>
                        <p id="c11-para-0005" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                            data-immersive-translate-paragraph="1">All the sample projects have nullable reference types
                            enabled.<font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">所有示例项目都已启用可空引用类型。</font>
                                </font>
                            </font>
                        </p>
                    </section>
                    <div class="bottom hr" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                        <hr />
                    </div>
                </section>
            </aside>
        </section> <span aria-label="289" epub:type="pagebreak" id="Page_289" role="doc-pagebreak"
            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
        <section aria-labelledby="head-2-96" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
            <span id="c11-sec-0003" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
            <h2 id="head-2-96" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">WHY ASYNCHRONOUS PROGRAMMING IS IMPORTANT<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">为什么异步编程很重要 </font>
                    </font>
                </font>
            </h2>
            <p id="c11-para-0006" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">Users find it annoying when an application does not immediately
                react to requests. As we scroll through a list, we have become accustomed to experiencing a delay
                because we've learned that behavior over several decades. We are accustomed to this behavior when using
                the mouse. However, with a touch UI, we often don't accept such a delay. An application with a touch UI
                needs to react immediately to requests. Otherwise, the user tries to redo the action, possibly by
                touching the screen more firmly.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            当应用程序对请求没有立即做出反应时，用户会觉得烦人。当我们滚动列表时，我们已经习惯了这种延迟，因为我们已经学习了数十年的这种行为。我们习惯了使用鼠标时的这种行为。然而，在使用触摸界面时，我们通常无法接受这种延迟。具有触摸界面的应用程序需要立即对请求做出反应。否则，用户会尝试重做该操作，可能通过更用力地触摸屏幕。
                        </font>
                    </font>
                </font>
            </p>
            <p id="c11-para-0007" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">Because asynchronous programming was hard to achieve with older
                versions of .NET, it was not always done when it should have been. One of the applications that blocked
                the UI thread fairly often is an older version of Visual Studio. With that version, opening a solution
                containing hundreds of projects meant you could take a long coffee break. Visual Studio 2017 offered the
                <i data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Lightweight Solution Load</i>
                feature, which loads projects only as needed and with the selected project loaded first. Since Visual
                Studio 2015, the NuGet package manager is no longer implemented as a modal dialog. The new NuGet package
                manager can load information about packages asynchronously while you do other things at the same time.
                These are just a few examples of important changes built into Visual Studio related to asynchronous
                programming.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">由于在旧版本的.NET
                            中异步编程难以实现，因此并不总是按需进行。其中一个经常阻塞 UI 线程的应用是旧版本的 Visual
                            Studio。使用那个版本时，打开包含数百个项目的工作区意味着你可以安心地喝杯咖啡。Visual Studio 2017
                            提供了轻量级解决方案加载功能，该功能按需加载项目，并首先加载选定项目。自 Visual Studio 2015 以来，NuGet 包管理器不再作为模态对话框实现。新的 NuGet
                            包管理器可以在你同时进行其他操作时异步加载包信息。这些都是与异步编程相关的、Visual Studio 中引入的重要变更的几个例子。</font>
                    </font>
                </font>
            </p>
            <p id="c11-para-0008" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">Many APIs with .NET offer both a synchronous and an asynchronous
                version. Because the synchronous version of the API was a lot easier to use, it was often used where it
                wasn't appropriate. With the Windows Runtime (WinRT), if an API call is expected to take longer than 40
                milliseconds, only an asynchronous version is available. Since C# 5.0, programming asynchronously is as
                easy as programming in a synchronous manner, so there shouldn't be any barriers to using the
                asynchronous APIs, but of course there can be traps, which are covered in this chapter.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">许多 .NET API 都提供同步和异步两种版本。由于 API
                            的同步版本使用起来更简单，因此它经常被用于不合适的地方。在 Windows 运行时 (WinRT) 中，如果预期 API 调用将花费超过 40 毫秒的时间，则只提供异步版本。自 C#
                            5.0 起，异步编程与同步编程一样简单，因此不应有任何使用异步 API 的障碍，但当然可能会有陷阱，这些陷阱在本章中进行了介绍。</font>
                    </font>
                </font>
            </p>
            <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">C# 8 introduced async streams that make it easy to consume async
                results continuously. This topic is covered in this chapter as well.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">C# 8
                            引入了异步流，使连续消费异步结果变得容易。本主题也在本章中进行了介绍。</font>
                    </font>
                </font>
            </p>
            <aside data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                <div class="top hr" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <hr />
                </div>
                <section class="feature2" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <p id="c11-para-0010" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                        data-immersive-translate-paragraph="1"><b
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">NOTE</b> <i
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">.NET offers different
                            patterns for asynchronous programming. .NET 1.0 defined the async pattern. With this
                            pattern, </i>
                        <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">BeginXX</code>
                        <i data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> and </i>
                        <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">EndXX</code>
                        <i data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> methods are offered.
                            One example is the </i>
                        <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WebRequest</code>
                        <i data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> class in the </i>
                        <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">System.Net</code>
                        <i data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> namespace with the
                        </i>
                        <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">BeginGetResponse</code>
                        <i data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> and </i>
                        <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">EndGetResponse</code>
                        <i data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> methods. This pattern
                            is based on the </i>
                        <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncResult</code>
                        <i data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> interface and the
                        </i>
                        <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">AsyncCallback</code>
                        <i data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> delegate. When using
                            this pattern with the implementation of Windows applications, it is necessary to switch back
                            to the user interface (UI) thread after the result </i><i
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">is received.</i>
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">注意 .NET 提供了不同的异步编程模式。.NET 1.0
                                    定义了异步模式。使用此模式，会提供 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">BeginXX</code>
                                    和 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">EndXX</code>
                                    方法。一个例子是 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">System.Net</code>
                                    命名空间中的 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WebRequest</code>
                                    类及其 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">BeginGetResponse</code>
                                    和 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">EndGetResponse</code>
                                    方法。此模式基于 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncResult</code>
                                    接口和 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">AsyncCallback</code>
                                    委托。在使用此模式实现 Windows 应用程序时，在接收到结果后需要切换回用户界面 (UI) 线程。</font>
                            </font>
                        </font>
                    </p>
                    <p id="c11-para-0011" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                        data-immersive-translate-paragraph="1"><i
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">.NET 2.0 introduced
                            the event-based async pattern. With this pattern, an event is used to receive the
                            asynchronous result, and the method to invoke has the Async postfix. An example is the
                        </i><code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WebClient</code><i
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> class (an
                            abstraction of </i><code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WebRequest</code><i
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">) with the method
                        </i><code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">DownloadStringAsync</code><i
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> and the
                            corresponding event </i><code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">DownloadStringCompleted</code><i
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">. Using this pattern
                            with Windows applications where a synchronization context is created, it's not necessary to
                            switch to the UI thread manually. This is done from the event.</i>
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">.NET 2.0
                                    引入了基于事件的异步模式。使用这种模式时，通过事件来接收异步结果，而调用的方法带有 Async 后缀。例如 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WebClient</code>
                                    类（ <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WebRequest</code>
                                    的抽象）中的 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">DownloadStringAsync</code>
                                    方法和对应的事件 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">DownloadStringCompleted</code>
                                    。在创建同步上下文的 Windows 应用程序中使用这种模式时，无需手动切换到 UI 线程，这由事件完成。</font>
                            </font>
                        </font>
                    </p>
                    <p id="c11-para-0012" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                        data-immersive-translate-paragraph="1"><i
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">With new
                            applications, you can ignore the methods offered by these patterns. Instead, C# 5 introduced
                            the task-based async pattern. This pattern is based on .NET 4 features, the task parallel
                            library (TPL). With this pattern, an asynchronous method returns a </i>
                        <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                        <i data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> (or other types
                            offering the </i>
                        <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GetAwaiter</code>
                        <i data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> method), and you can
                            use the </i>
                        <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                        <i data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> keyword to wait for
                            the result. Methods usually have the Async postfix with this pattern as well. A modern class
                            for doing </i><i
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">network requests for
                            implementing this pattern is </i>
                        <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">HttpClient</code>
                        <i data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> with the </i>
                        <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GetAsync</code>
                        <i data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> method.</i>
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">对于新应用程序，可以忽略这些模式提供的方法。相反，C# 5
                                    引入了基于任务的异步模式。这种模式基于 .NET 4 的特性，即任务并行库（TPL）。使用这种模式时，异步方法返回一个 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                                    （或其他提供 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GetAwaiter</code>
                                    方法的类型），并可以使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                                    关键字来等待结果。通常，这种模式下的方法也带有 Async 后缀。一个现代的用于执行网络请求以实现这种模式的类是 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">HttpClient</code>
                                    ，其中包含 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GetAsync</code>
                                    方法。</font>
                            </font>
                        </font>
                    </p>
                    <p id="c11-para-0013" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                        data-immersive-translate-paragraph="1"><i
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Both the </i>
                        <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WebClient</code>
                        <i data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> and </i>
                        <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WebRequest</code>
                        <i data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> classes offer the new
                            pattern as well. To avoid a </i><i
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">naming conflict with
                            the older pattern, </i>
                        <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WebClient</code>
                        <i data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> adds </i>
                        <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                        <i data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> to the method
                            name—for example, </i>
                        <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">DownloadStringTaskAsync</code>
                        <i data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">.</i>
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1"> <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WebClient</code>
                                    和 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WebRequest</code>
                                    类也提供了新模式。为了避免与旧模式的命名冲突， <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WebClient</code>
                                    在方法名中添加 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                                    ，例如 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">DownloadStringTaskAsync</code>
                                    。</font>
                            </font>
                        </font>
                    </p>
                    <p id="c11-para-0014" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                        data-immersive-translate-paragraph="1"><i
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">With new clients,
                            just ignore the </i>
                        <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Begin</code>
                        <i data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">/</i>
                        <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">End</code>
                        <i data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> methods, and the
                            events based on the async pattern with the classes that offer this functionality to support
                            legacy applications.</i>
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">对于新客户，只需忽略 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Begin</code>
                                    / <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">End</code>
                                    方法，以及基于异步模式的事件和提供此类功能以支持旧版应用程序的类。</font>
                            </font>
                        </font>
                    </p>
                    <div class="bottom hr" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                        <hr />
                    </div>
                </section>
            </aside>
        </section> <span aria-label="290" epub:type="pagebreak" id="Page_290" role="doc-pagebreak"
            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
        <section aria-labelledby="head-2-97" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
            <span id="c11-sec-0005" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
            <h2 id="head-2-97" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">TASK-BASED ASYNC PATTERN<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">基于任务的异步模式</font>
                    </font>
                </font>
            </h2>
            <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">Let's start with using an implementation of the task-based async
                pattern. The <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">HttpClient</code> class
                (which is explained in more detail in <a href="c19.xhtml"
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Chapter 19</a>, “Networking”)
                among many other classes implements this pattern. Nearly all methods of this class are named with an
                <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Async</code> postfix and
                return a <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>. This
                is the declaration of one overload of the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GetAsync</code> method:<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">让我们从使用基于任务的异步模式实现开始。 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">HttpClient</code>
                            类（在“网络”第 19 章中有更详细的解释）在许多其他类中实现了这种模式。该类的几乎所有方法都以 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Async</code>
                            后缀命名，并返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code> 。这是
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GetAsync</code>
                            方法的一个重载的声明：</font>
                    </font>
                </font>
            </p>
            <pre id="c11-code-0001"><code>public Task&lt;HttpResponseMessage&gt; GetAsync(Uri? requestUri);</code></pre>
            <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">The sample application uses these namespaces besides the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">System</code> namespace:<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">示例应用程序除了 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">System</code>
                            命名空间外，还使用这些命名空间：</font>
                    </font>
                </font>
            </p>
            <ul class="none" id="c11-list-0003" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                <li id="c11-li-0014" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">System.Net.Http</code>
                </li>
                <li id="c11-li-0015" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">System.Threading.Tasks</code>
                </li>
            </ul>
            <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">With the sample application, a command-line argument can be
                passed to start the application. If a command-line argument is not set, the user is asked to enter a
                link to a website. After the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">HttpClient</code> is
                instantiated, the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GetAsync</code> method is
                invoked. Using the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code> keyword, the
                calling thread is not blocked, but the result variable response is only filled as soon as the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code> returned from the
                <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GetAsync</code> method is
                completed (the task status will have the state <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">RunToCompletion</code>). When
                you use the <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code>
                keyword, there's no need to specify an event handler or pass a completion delegate as was necessary with
                the older async patterns. The <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">HttpResponseMessage</code>
                has a <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IsSuccessStatusCode</code>
                property that is used to verify if the response from the service was successful. With a successful
                return, the content is retrieved using the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ReadAsStringAsync</code>
                method. This method returns <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task&lt;string&gt;</code>
                that can be awaited as well. As soon as the result is available, the first 200 characters of the string
                HTML are written to the console (code file <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TaskBasedAsyncPattern/Program.cs</code>):
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            通过示例应用程序，可以通过命令行参数启动应用程序。如果没有设置命令行参数，系统会提示用户输入一个网站链接。在实例化 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">HttpClient</code>
                            后，会调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GetAsync</code>
                            方法。使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                            关键字，调用线程不会被阻塞，但结果变量 response 只有在从 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GetAsync</code>
                            方法返回的 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                            完成后才会被填充（任务状态将变为 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">RunToCompletion</code>
                            ）。当你使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code>
                            关键字时，无需指定事件处理程序或传递完成委托，这是旧版异步模式所必需的。 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">HttpResponseMessage</code>
                            具有一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IsSuccessStatusCode</code>
                            属性，用于验证服务返回的响应是否成功。如果返回成功，则使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ReadAsStringAsync</code>
                            方法获取内容。该方法返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task&lt;string&gt;</code>
                            ，也可以被异步等待。一旦结果可用，字符串 HTML 的前 200 个字符将被写入控制台（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TaskBasedAsyncPattern/Program.cs</code>
                            ）：</font>
                    </font>
                </font>
            </p>
            <pre id="c11-code-0002"><code>using System;</code>
<code>using System.Net.Http;</code>
<code>using System.Threading.Tasks;</code>
<code> </code>
<code>string uri = (args.Length&gt;= 1) ? args[0] : string.Empty;</code>
<code>if (string.IsNullOrEmpty(uri))</code>
<code>{</code>
<code>  Console.Write("enter an URL (e.g. https://csharp.christiannagel.com): ");</code>
<code>  uri = Console.ReadLine() ?? throw new InvalidOperationException();</code>
<code>}</code>
<code><b>using HttpClient httpClient = new();</b></code>
<code>try</code>
<code>{</code>
<code>  <b>using HttpResponseMessage response = await httpClient.GetAsync(new Uri(uri));</b></code>
<code>  if (response.IsSuccessStatusCode)</code>
<code>  {</code>
<code>    <b>string html = await response.Content.ReadAsStringAsync();</b></code>
<code>    Console.WriteLine(html[..200]);</code>
<code>  }</code>
<code>  else</code>
<code>  {</code>
<code>    Console.WriteLine($"Status code: {response.StatusCode}");</code>
<code>  }</code>
<code>}</code>
<code>catch (UriFormatException ex)</code>
<code>{</code>
<code>  Console.WriteLine($"Error parsing the Uri {ex.Message}");</code>
<code>}<span aria-label="291" epub:type="pagebreak" id="Page_291" role="doc-pagebreak"></span></code>
<code>catch (HttpRequestException ex)</code>
<code>{</code>
<code>  Console.WriteLine($"HTTP request exception: {ex.Message}");</code>
<code>}</code>
<code>catch (TaskCanceledException ex)</code>
<code>{</code>
<code>  Console.WriteLine($"Task canceled: {ex.Message}");</code>
<code>}</code></pre>
            <aside data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                <div class="top hr" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <hr />
                </div>
                <section class="feature2" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <p id="c11-para-0019" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                        data-immersive-translate-paragraph="1"><b
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">NOTE</b> <i
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">The </i><code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">using</code><i
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> declaration that's
                            used with the </i><code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">HttpClient</code><i
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> and the </i><code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">HttpResponseMessage</code><i
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> invokes the
                        </i><code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Dispose</code><i
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> method at the end of
                            the variable scope. This is explained in detail in <a href="c13.xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Chapter 13</a>,
                            “Managed and Unmanaged Memory.”</i>
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">注意 使用与 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">HttpClient</code>
                                    和 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">HttpResponseMessage</code>
                                    一起的 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">using</code>
                                    声明会在变量作用域结束时调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Dispose</code>
                                    方法。这将在第 13 章“托管和非托管内存”中详细解释。</font>
                            </font>
                        </font>
                    </p>
                    <div class="bottom hr" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                        <hr />
                    </div>
                </section>
            </aside>
            <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">To run the program and pass command-line arguments using the .NET
                CLI, you need to pass two dashes to distinguish the command-line arguments that are meant for the
                application from the arguments used for the .NET CLI and start the application this way:<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">使用 .NET CLI
                            运行程序并传递命令行参数时，需要使用两个连字符来区分应用程序的命令行参数和用于 .NET CLI 的参数，并以此方式启动应用程序：</font>
                    </font>
                </font>
            </p>
            <pre id="c11-code-0003"><code>&gt; dotnet run -- https://csharp.christiannagel.com</code></pre>
            <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">Using top-level statements, the variable <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">args</code> is created
                automatically. Using <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code> with the
                top-level statements, the generated <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Main</code> method is defined
                with an <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code> scope.
                When you write a custom <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Main</code> method that uses
                <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>, it needs to
                be declared to return a <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                :<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">使用顶级语句，变量 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">args</code>
                            会自动创建。使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                            与顶级语句结合，生成的 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Main</code>
                            方法会定义一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code>
                            作用域。当你编写一个使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code> 的自定义
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Main</code>
                            方法时，它需要声明返回一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code> ：
                        </font>
                    </font>
                </font>
            </p>
            <pre id="c11-code-0004"><code>public class Program</code>
<code>{</code>
<code>  static <b>async Task</b> Main(string[] args)</code>
<code>  {</code>
<code>    //…</code>
<code>  }</code>
<code>}</code></pre>
        </section>
        <section aria-labelledby="head-2-98" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
            <span id="c11-sec-0007" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
            <h2 id="head-2-98" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">TASKS<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">任务</font>
                    </font>
                </font>
            </h2>
            <p id="c11-para-0022" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">The <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code> and <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code> keywords are
                compiler features. The compiler creates code by using functionality from the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code> class, which you
                also can write yourself. This section gives information about the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code> class and what
                the compiler does with the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code> and <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code> keywords. It
                shows you an effortless way to create an asynchronous method and demonstrates how to invoke multiple
                asynchronous methods in parallel. You also see how you can change a class to offer the asynchronous
                pattern with the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code> and <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code> keywords.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1"> <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code> 和
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                            关键字是编译器特性。编译器通过使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                            类的功能来生成代码，你也可以自己编写这个类。本节提供了关于 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                            类以及编译器如何使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code> 和
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                            关键字的信息。它向你展示了一种轻松创建异步方法的方式，并演示了如何并行调用多个异步方法。你还看到如何通过使用 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code> 和
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                            关键字将类改为提供异步模式。</font>
                    </font>
                </font>
            </p>
            <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">The sample application uses these namespaces besides the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">System</code> namespace:<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">示例应用程序除了 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">System</code>
                            命名空间外，还使用这些命名空间：</font>
                    </font>
                </font>
            </p>
            <ul class="none" id="c11-list-0004" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                <li id="c11-li-0016" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">System.Collections.Generic</code>
                </li>
                <li id="c11-li-0017" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">System.IO</code>
                </li>
                <li id="c11-li-0018" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">System.Linq</code>
                </li>
                <li id="c11-li-0019" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">System.Net</code>
                </li>
                <li id="c11-li-0020" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">System.Runtime.CompilerServices</code>
                </li>
                <li id="c11-li-0021" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">System.Threading</code>
                </li>
                <li id="c11-li-0022" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">System.Threading.Tasks</code>
                </li>
            </ul>
            <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"><span aria-label="292"
                    epub:type="pagebreak" id="Page_292" role="doc-pagebreak"
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span></p>
            <aside data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                <div class="top hr" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <hr />
                </div>
                <section class="feature2" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <p id="c11-para-0024" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                        data-immersive-translate-paragraph="1"><b
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">NOTE</b> <i
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">This downloadable
                            sample application makes use of command-line arguments, so you can easily verify each
                            scenario. For example, using the .NET CLI, you can pass the </i>
                        <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code>
                        <i data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> command-line
                            parameter with this command: </i>
                        <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">dotnet run -- -async</code>
                        <i data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">. When using Visual
                            Studio, you can also configure the application arguments in Debug Project Settings.</i>
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">
                                    注意：此可下载的示例应用程序使用命令行参数，因此您可以轻松验证每个场景。例如，使用 .NET CLI，您可以通过此命令传递 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code>
                                    命令行参数： <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">dotnet run -- -async</code>
                                    。在使用 Visual Studio 时，您也可以在调试项目设置中配置应用程序参数。</font>
                            </font>
                        </font>
                    </p>
                    <div class="bottom hr" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                        <hr />
                    </div>
                </section>
            </aside>
            <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">To better understand what's going on, the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TraceThreadAndTask</code>
                method is created to write thread and task information to the console. <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.CurrentId</code> returns
                the identifier of the task. <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Thread.CurrentThread.ManagedThreadId</code>
                returns the identifier of the current thread (code file <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TaskFoundations/Program.cs</code>):
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">为了更好地理解正在发生的事情，创建了 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TraceThreadAndTask</code>
                            方法来将线程和任务信息写入控制台。 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.CurrentId</code>
                            返回任务的标识符。 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Thread.CurrentThread.ManagedThreadId</code>
                            返回当前线程的标识符（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TaskFoundations/Program.cs</code>
                            ）：</font>
                    </font>
                </font>
            </p>
            <pre id="c11-code-0005"><code>public static void TraceThreadAndTask(string info)</code>
<code>{</code>
<code>  string taskInfo = Task.CurrentId == null ? "no task" : "task " + </code>
<code>    Task.CurrentId;</code>
<code> </code>
<code>  Console.WriteLine($"{info} in thread {Thread.CurrentThread.ManagedThreadId} " + </code>
<code>    $"and {taskInfo}");</code>
<code>}</code></pre>
            <section data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"><span id="c11-sec-0009"
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
                <h3 id="head-3-220" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">Creating Tasks <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">创建任务</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">Let's start with the synchronous method <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Greeting</code>, which
                    takes a while before returning a string (code file <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TaskFoundations/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">让我们从同步方法 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Greeting</code>
                                开始，该方法在返回字符串之前需要一段时间（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TaskFoundations/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c11-code-0006"><code>static string Greeting(string name)</code>
<code>{</code>
<code>  TraceThreadAndTask($"running {nameof(Greeting)}");</code>
<code>  Task.Delay(3000).Wait();</code>
<code>  return $"Hello, {name}";</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">To make such a method asynchronously, you define the method
                    <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GreetingAsync</code>.
                    The task-based asynchronous pattern specifies that an asynchronous method is named with the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Async</code> suffix and
                    returns a <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>.
                    <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GreetingAsync</code> is
                    defined to have the same input parameters as the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Greeting</code> method
                    but returns <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task&lt;string&gt;</code>.
                    <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task&lt;string&gt;</code>
                    defines a task that returns a <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">string</code> in the
                    future. A simple way to return a task is by using the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.Run</code> method.
                    This method creates a new task and starts it. The generic version <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.Run&lt;string&gt;()</code>
                    creates a task that returns a <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">string</code>. Because
                    the compiler already knows the return type from the implementation (<code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Greeting</code> returns a
                    string), you can also simplify the implementation by using <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.Run()</code>
                    :<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">要使这种方法异步化，你需要定义方法 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GreetingAsync</code>
                                。基于任务的异步模式指定异步方法以 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Async</code>
                                后缀命名并返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code> 。
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GreetingAsync</code>
                                被定义为与 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Greeting</code>
                                方法具有相同的输入参数，但返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task&lt;string&gt;</code>
                                。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task&lt;string&gt;</code>
                                定义了一个任务，该任务在未来返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">string</code>
                                。一种简单返回任务的方法是使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.Run</code>
                                方法。该方法创建一个新任务并启动它。泛型版本 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.Run&lt;string&gt;()</code>
                                创建一个返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">string</code>
                                的任务。由于编译器已经从实现中知道返回类型（ <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Greeting</code>
                                返回一个字符串），你也可以通过使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.Run()</code>
                                简化实现：</font>
                        </font>
                    </font>
                </p>
                <pre id="c11-code-0007"><code>static <b>Task&lt;string&gt;</b> Greeting<b>Async</b>(string name) =&gt; </code>
<code>  Task.Run(() =&gt; </code>
<code>  {</code>
<code>    TraceThreadAndTask($"running {nameof(GreetingAsync)}");</code>
<code>    return Greeting(name);</code>
<code>  });</code></pre>
            </section>
            <section data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"><span id="c11-sec-0010"
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
                <h3 id="head-3-221" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">Calling an Asynchronous Method <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">调用异步方法</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">You can call this asynchronous method <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GreetingAsync</code> by
                    using the <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                    keyword on the task that is returned. The <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code> keyword
                    requires the method to be declared with the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code> modifier.
                    The code within this method does not continue before the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GreetingAsync</code>
                    method is completed. However, you <span aria-label="293" epub:type="pagebreak" id="Page_293"
                        role="doc-pagebreak"
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>can reuse the
                    thread that started the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">CallerWithAsync</code>
                    method. This thread is not blocked (code file <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TaskFoundations/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">你可以通过在返回的任务上使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                                关键字来调用这个异步方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GreetingAsync</code>
                                。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                                关键字要求方法必须使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code>
                                修饰符声明。此方法内的代码在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GreetingAsync</code>
                                方法完成之前不会继续执行。然而，你可以重用启动 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">CallerWithAsync</code>
                                方法的线程。该线程不会被阻塞（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TaskFoundations/Program.cs</code>
                                ）。</font>
                        </font>
                    </font>
                </p>
                <pre id="c11-code-0008"><code>private <b>async</b> static void CallerWithAsync()</code>
<code>{</code>
<code>  TraceThreadAndTask($"started {nameof(CallerWithAsync)}");</code>
<code>  string result = <b>await</b> GreetingAsync("Stephanie");</code>
<code>  Console.WriteLine(result);</code>
<code>  TraceThreadAndTask($"ended {nameof(CallerWithAsync)}");</code>
<code>} </code></pre>
                <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">When you run the application, you can see from the first
                    output that there's no task. The <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GreetingAsync</code>
                    method is running in a task, and this task is using a different thread from the caller. The
                    synchronous <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Greeting</code> method
                    then runs in this task. As the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Greeting</code> method
                    returns, the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GreetingAsync</code>
                    method returns, and the scope is back in the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">CallerWithAsync</code>
                    method after the await. Now, the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">CallerWithAsync</code>
                    method runs in a different thread than before. There's not a task anymore, but although the method
                    started with thread 1, after the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code> thread 4 was
                    used. The <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                    made sure that the continuation happens after the task was completed, but it now uses a different
                    thread. This behavior is different between Console applications and applications that have a
                    synchronization context, which is described later in this chapter in the “Async with Windows Apps”
                    section:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">当你运行应用程序时，从第一个输出中可以看到没有任务。 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GreetingAsync</code>
                                方法在一个任务中运行，这个任务使用的是调用者不同的线程。同步的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Greeting</code>
                                方法随后在这个任务中运行。当 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Greeting</code>
                                方法返回时， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GreetingAsync</code>
                                方法返回，在 await 之后作用域回到 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">CallerWithAsync</code>
                                方法。现在， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">CallerWithAsync</code>
                                方法在不同于之前的线程中运行。没有任务了，尽管方法以线程 1 开始，但在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                                线程 4 被使用。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                                确保了在任务完成后继续执行，但它现在使用的是不同的线程。这种行为在控制台应用程序和具有同步上下文的应用程序之间有所不同，后者将在本章后面的“与 Windows 应用程序一起使用
                                Async”部分进行描述：</font>
                        </font>
                    </font>
                </p>
                <pre id="c11-code-0009"><code>started CallerWithAsync in thread 1 and no task</code>
<code>running GreetingAsync in thread 4 and task 1</code>
<code>running Greeting in thread 4 and task 1</code>
<code>Hello, Stephanie</code>
<code>ended CallerWithAsync in thread 4 and no task</code></pre>
                <aside data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <div class="top hr" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                        <p id="c11-para-0031" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">NOTE</b> <i
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">The </i> <code
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code> <i
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> modifier can be
                                used with methods that return </i> <code
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">void</code> <i
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> or return an
                                object that offers the </i> <code
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GetAwaiter</code>
                            <i data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> method. .NET
                                offers the </i> <code
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code> <i
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> and </i> <code
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ValueTask</code>
                            <i data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> types. With the
                                Windows Runtime, you also can use </i> <code
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncOperation</code>
                            <i data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">. You should avoid
                                using the </i> <code
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code> <i
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> modifier with
                                void methods; read more about this in the “Error Handling” section later in this
                                chapter.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code>
                                        修饰符可以与返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">void</code>
                                        或返回提供 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GetAwaiter</code>
                                        方法的对象的方法一起使用。.NET 提供了 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                                        和 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ValueTask</code>
                                        类型。使用 Windows 运行时，你也可以使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncOperation</code>
                                        。你应该避免在 void 方法中使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code>
                                        修饰符；在本章后面的“错误处理”部分了解更多信息。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                            <hr />
                        </div>
                    </section>
                </aside>
                <p id="c11-para-0032" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">The next section explains what's driving the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code> keyword.
                    Behind the scenes, continuation tasks are used.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">下一节解释了驱动 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                                关键字的原理。在幕后，使用的是延续任务。</font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"><span id="c11-sec-0012"
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
                <h3 id="head-3-222" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">Using the Awaiter <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用 Awaiter</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">You can use the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code> keyword with
                    any object that offers the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GetAwaiter</code> method
                    and returns an awaiter. An awaiter implements the interface <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">INotifyCompletion</code>
                    with the method <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">OnCompleted</code>. This
                    method is invoked when the task is completed. With the following code snippet, instead of using
                    <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code> on the
                    task, the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GetAwaiter</code> method
                    of the task is used. <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GetAwaiter</code> from
                    the <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code> class
                    returns a <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TaskAwaiter</code>. Using
                    the <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">OnCompleted</code>
                    method, a local function is assigned that is invoked when the task is completed (code file <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TaskFoundations/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">你可以使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code>
                                关键字与任何提供 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GetAwaiter</code>
                                方法和返回 awaiter 的对象一起使用。Awaiter 实现了 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">INotifyCompletion</code>
                                接口，并具有 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">OnCompleted</code>
                                方法。当任务完成时，会调用该方法。通过以下代码片段，不是在任务上使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                                ，而是使用任务的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GetAwaiter</code>
                                方法。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GetAwaiter</code>
                                类的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                                方法返回一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TaskAwaiter</code>
                                。使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">OnCompleted</code>
                                方法，将一个局部函数分配给该函数，当任务完成时会被调用（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TaskFoundations/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c11-code-0010"><code>private static void CallerWithAwaiter()</code>
<code>{</code>
<code>  TraceThreadAndTask($"starting {nameof(CallerWithAwaiter)}");</code>
<code>  <b>TaskAwaiter&lt;string&gt; awaiter = GreetingAsync("Matthias").GetAwaiter();</b></code>
<code>  awaiter.OnCompleted(OnCompleteAwaiter);</code>
<code> </code>
<code>  void OnCompleteAwaiter()</code>
<code>  {</code>
<code>    Console.WriteLine(awaiter.GetResult());</code>
<code>    TraceThreadAndTask($"ended {nameof(CallerWithAwaiter)}");</code>
<code>  }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1"><span aria-label="294" epub:type="pagebreak" id="Page_294"
                        role="doc-pagebreak"
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>When you run the
                    application, you can see a result similar to the scenario in which you used the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code> keyword:
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">当你运行应用程序时，你可以看到与使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                                关键字时类似的结果：</font>
                        </font>
                    </font>
                </p>
                <pre id="c11-code-0011"><code>starting CallerWithAwaiter in thread 1 and no task</code>
<code>running GreetingAsync in thread 4 and task 1</code>
<code>running Greeting in thread 4 and task 1</code>
<code>Hello, Matthias</code>
<code>ended CallerWithAwaiter in thread 4 and no task</code></pre>
                <p id="c11-para-0035" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">The compiler converts the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code> keyword by
                    putting all the code that follows within the block of an <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">OnCompleted</code>
                    method.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">编译器通过将所有后续代码置于 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">OnCompleted</code>
                                方法的块中来转换 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                                关键字。</font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"><span id="c11-sec-0013"
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
                <h3 id="head-3-223" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">Continuation with Tasks <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">与任务继续</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">You can also handle continuation by using features of the
                    <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code> object.
                    <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GreetingAsync</code>
                    returns a <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task&lt;string&gt;</code>
                    object. The <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                    object contains information about the task created and allows waiting for its completion. The <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ContinueWith</code>
                    method of the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code> class defines
                    the code that should be invoked as soon as the task is finished. The delegate assigned to the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ContinueWith</code>
                    method receives the completed task with its argument, which allows accessing the result from the
                    task using the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Result</code> property
                    (code file <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TaskFoundations/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">您也可以通过使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                                对象的功能来处理继续。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GreetingAsync</code>
                                返回一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task&lt;string&gt;</code>
                                对象。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                                对象包含有关创建的任务的信息，并允许等待其完成。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                                类的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ContinueWith</code>
                                方法定义了任务完成后应调用的代码。分配给 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ContinueWith</code>
                                方法的代理接收到完成的任务及其参数，这允许使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Result</code>
                                属性从任务中访问结果（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TaskFoundations/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c11-code-0012"><code>private static void CallerWithContinuationTask()</code>
<code>{</code>
<code>  TraceThreadAndTask("started CallerWithContinuationTask");</code>
<code> </code>
<code>  var t1 = GreetingAsync("Stephanie");</code>
<code> </code>
<code>  <b>t1.ContinueWith</b>(t =&gt;</code>
<code>  {</code>
<code>    string result = t.Result;</code>
<code>    Console.WriteLine(result);</code>
<code> </code>
<code>    TraceThreadAndTask("ended CallerWithContinuationTask");</code>
<code>  });</code>
<code>}</code></pre>
            </section>
            <section data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"><span id="c11-sec-0014"
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
                <h3 id="head-3-224" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">Synchronization Context <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">同步上下文</font>
                        </font>
                    </font>
                </h3>
                <p id="c11-para-0037" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">If you verify the thread that is used within the methods, you
                    will find that in all three methods—
                    <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">CallerWithAsync</code>,
                    <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">CallerWithAwaiter</code>,
                    and <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">CallerWithContinuationTask</code>
                    —different threads are used during the lifetime of the methods. One thread is used to invoke the
                    method <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GreetingAsync</code>, and
                    another thread takes action after the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code> keyword or
                    within the code block in the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ContinueWith</code>
                    method.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">如果你验证方法中使用的线程，你会发现，在所有三种方法—— <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">CallerWithAsync</code>
                                、 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">CallerWithAwaiter</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">CallerWithContinuationTask</code>
                                ——的整个生命周期中，都使用了不同的线程。一个线程用于调用方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GreetingAsync</code>
                                ，另一个线程在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                                关键字之后或 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ContinueWith</code>
                                方法中的代码块内执行操作。</font>
                        </font>
                    </font>
                </p>
                <p id="c11-para-0038" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">With a console application, usually this is not an issue.
                    However, you have to ensure that at least one foreground thread is still running before all
                    background tasks that should be completed are finished. The sample application invokes <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Console.ReadLine</code>
                    to keep the main thread running until the Return key is pressed.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                对于控制台应用程序，通常这不是问题。但是，你必须确保在所有应该完成的背景任务完成之前，至少有一个前台线程仍在运行。示例应用程序调用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Console.ReadLine</code>
                                来保持主线程运行，直到按下回车键。</font>
                        </font>
                    </font>
                </p>
                <p id="c11-para-0039" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">With applications that are bound to a specific thread for
                    some actions (for example, with WPF, UWP, and WinUI applications, UI elements can be accessed only
                    from the UI thread). This is an issue.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">对于某些操作绑定到特定线程的应用程序（例如，在 WPF、UWP 和
                                WinUI 应用程序中，UI 元素只能从 UI 线程访问）。这是一个问题。</font>
                        </font>
                    </font>
                </p>
                <p id="c11-para-0040" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">Using the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code> and <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code> keywords you
                    don't have to do any special actions to access the UI thread after an <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code> completion.
                    By default, the generated code switches the thread to the thread that has the synchronization
                    context. A WPF application sets a <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">DispatcherSynchronizationContext</code>,
                    and a Windows Forms application sets a <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WindowsFormsSynchronizationContext</code>.
                    Windows apps use the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WinRTSynchronizationContext</code>.
                    If the calling thread of the asynchronous method is assigned to the synchronization context, then
                    with the continuous execution after the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>, the same
                    synchronization context is used by default. If the same synchronization context shouldn't be used,
                    you must invoke the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code> method <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ConfigureAwait(continueOnCapturedContext: false)</code>.
                    An example that illustrates this usefulness is a Windows app in which the code that follows the
                    <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code> is not
                    using any UI elements. In this case, it is faster to avoid the switch to the synchronization
                    context.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                                关键字，在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                                完成后无需执行任何特殊操作即可访问 UI 线程。默认情况下，生成的代码会将线程切换到具有同步上下文的线程。WPF 应用程序设置 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">DispatcherSynchronizationContext</code>
                                ，Windows Forms 应用程序设置 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WindowsFormsSynchronizationContext</code>
                                。Windows 应用程序使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WinRTSynchronizationContext</code>
                                。如果异步方法的调用线程被分配给同步上下文，那么在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                                后的持续执行中，默认使用相同的同步上下文。如果不应使用相同的同步上下文，则必须调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                                方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ConfigureAwait(continueOnCapturedContext: false)</code>
                                。一个说明此用处的例子是一个 Windows 应用程序，其中 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                                后的代码不使用任何 UI 元素。在这种情况下，避免切换到同步上下文更快。 </font>
                        </font>
                    </font>
                </p>
            </section> <span aria-label="295" epub:type="pagebreak" id="Page_295" role="doc-pagebreak"
                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
            <section data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"><span id="c11-sec-0015"
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
                <h3 id="head-3-225" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">Using Multiple Asynchronous Methods <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用多个异步方法 </font>
                        </font>
                    </font>
                </h3>
                <p id="c11-para-0041" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">Within an asynchronous method, you can call multiple
                    asynchronous methods. How you code this depends on whether the results from one asynchronous method
                    are needed by another.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                在一个异步方法中，可以调用多个异步方法。如何编写这取决于一个异步方法的返回结果是否被另一个异步方法需要。 </font>
                        </font>
                    </font>
                </p>
                <section data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"><span id="c11-sec-0016"
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
                    <h4 id="head-4-37" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                        data-immersive-translate-paragraph="1">Calling Asynchronous Methods Sequentially<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">按顺序调用异步方法</font>
                            </font>
                        </font>
                    </h4>
                    <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                        data-immersive-translate-paragraph="1">You can use the <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code> keyword
                        to call every asynchronous method. In cases where one method is dependent on the result of
                        another method, this is useful. In the following code snippet, <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code> is used
                        with every invocation of <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GreetingAsync</code>
                        (code file <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TaskFoundations/Program.cs</code>):
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">你可以使用 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                                    关键字来调用所有异步方法。当某个方法依赖于另一个方法的结果时，这很有用。在以下代码片段中， <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                                    与每次调用的 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GreetingAsync</code>
                                    （代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TaskFoundations/Program.cs</code>
                                    ）一起使用：</font>
                            </font>
                        </font>
                    </p>
                    <pre id="c11-code-0013"><code>private async static void MultipleAsyncMethods()</code>
<code>{</code>
<code>  string s1 = <b>await</b> GreetingAsync("Stephanie");</code>
<code>  string s2 = <b>await</b> GreetingAsync("Matthias");</code>
<code>  Console.WriteLine($"Finished both methods.{Environment.NewLine} " +</code>
<code>    $"Result 1: {s1}{Environment.NewLine} Result 2: {s2}");</code>
<code>}</code></pre>
                </section>
                <section data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"><span id="c11-sec-0017"
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
                    <h4 id="head-4-38" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                        data-immersive-translate-paragraph="1">Using Combinators<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                            <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">使用组合器</font>
                            </font>
                        </font>
                    </h4>
                    <p id="c11-para-0043" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                        data-immersive-translate-paragraph="1">If the asynchronous methods are not dependent on each
                        other, it is a lot faster not to <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code> on each
                        separately; instead, assign the return of the asynchronous method to a <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code> variable.
                        The <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GreetingAsync</code>
                        method returns <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task&lt;string&gt;</code>.
                        Both these methods can now run in parallel. Combinators can help with this. A combinator accepts
                        multiple parameters of the same type and returns a value of the same type. The passed parameters
                        are “combined” to one. <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                        combinators accept multiple <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code> objects
                        as parameters and return a <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>.<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">如果异步方法之间没有依赖关系，那么不在每个方法上单独使用
                                    <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                                    会更快；相反，应将异步方法的返回值赋给一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                                    变量。 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GreetingAsync</code>
                                    方法返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task&lt;string&gt;</code>
                                    。现在这两个方法可以并行运行。组合子可以帮助实现这一点。组合子接受多个相同类型的参数，并返回相同类型的值。传递的参数被“组合”成一个。 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                                    组合子接受多个 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                                    对象作为参数，并返回一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                                    。</font>
                            </font>
                        </font>
                    </p>
                    <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                        data-immersive-translate-paragraph="1">The sample code invokes the <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.WhenAll</code>
                        combinator method that you can <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code> to have
                        both tasks finished (code file <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TaskFoundations/Program.cs</code>):
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">示例代码调用了 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.WhenAll</code>
                                    组合子方法，你可以使用它来确保两个任务都完成（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TaskFoundations/Program.cs</code>
                                    ）：</font>
                            </font>
                        </font>
                    </p>
                    <pre id="c11-code-0014"><code>private async static void MultipleAsyncMethodsWithCombinators1()</code>
<code>{</code>
<code>  <b>Task&lt;string&gt; t1</b> = GreetingAsync("Stephanie");</code>
<code>  <b>Task&lt;string&gt; t2</b> = GreetingAsync("Matthias");</code>
<code>  <b>await Task.WhenAll(t1, t2);</b></code>
<code>  Console.WriteLine($"Finished both methods.{Environment.NewLine} " +</code>
<code>    $"Result 1: {t1.Result}{Environment.NewLine} Result 2: {t2.Result}");</code>
<code>}</code></pre>
                    <p id="c11-para-0045" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                        data-immersive-translate-paragraph="1">The <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code> class
                        defines the <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WhenAll</code> and
                        <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WhenAny</code>
                        combinators. The <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code> returned
                        from the <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WhenAll</code> method
                        is completed as soon as all tasks passed to the method are completed; the <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code> returned
                        from the <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WhenAny</code> method
                        is completed as soon as one of the tasks passed to the method is completed.<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1"> <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                                    类定义了 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WhenAll</code>
                                    和 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WhenAny</code>
                                    组合器。从 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WhenAll</code>
                                    方法返回的 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                                    在传递给方法的所有任务都完成后立即完成；从 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WhenAny</code>
                                    方法返回的 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                                    在传递给方法的任一任务完成后立即完成。</font>
                            </font>
                        </font>
                    </p>
                    <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                        data-immersive-translate-paragraph="1">The <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WhenAll</code> method
                        of the <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                        type defines several overloads. If all the tasks return the same type, you can use an array of
                        this type for the result of the <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>. The
                        <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GreetingAsync</code>
                        method returns a <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task&lt;string&gt;</code>,
                        and awaiting for this method results in a <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">string</code>.
                        Therefore, you can use <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.WhenAll</code>
                        to return a <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">string</code> array:
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1"> <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                                    类型的 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WhenAll</code>
                                    方法定义了多个重载。如果所有任务都返回相同类型，你可以使用该类型的数组作为 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                                    的结果。 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GreetingAsync</code>
                                    方法返回一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task&lt;string&gt;</code>
                                    ，等待这个方法会导致 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">string</code>
                                    。因此，你可以使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.WhenAll</code>
                                    来返回一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">string</code>
                                    数组：</font>
                            </font>
                        </font>
                    </p>
                    <pre id="c11-code-0015"><code>private async static void MultipleAsyncMethodsWithCombinators2()</code>
<code>{</code>
<code>  Task&lt;string&gt; t1 = GreetingAsync("Stephanie");</code>
<code>  Task&lt;string&gt; t2 = GreetingAsync("Matthias");</code>
<code>  <b>string[] result = await Task.WhenAll(t1, t2);</b></code>
<code>  Console.WriteLine($"Finished both methods.{Environment.NewLine} " +</code>
<code>    $"Result 1: {result[0]}{Environment.NewLine} Result 2: {result[1]}");</code>
<code>}</code></pre>
                    <p id="c11-para-0047" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                        data-immersive-translate-paragraph="1">The <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WhenAll</code> method
                        is of practical use when the waiting task can continue only when all tasks it's waiting for are
                        finished. The <code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WhenAny</code> method
                        can be used when the calling task can do some work when any task it's waiting for is completed.
                        It can use a result from the task to go on.<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">当等待的任务只有在它等待的所有任务都完成后才能继续时，
                                    <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WhenAll</code>
                                    方法很有用。当调用任务在其等待的任一任务完成时可以做一些工作时，可以使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WhenAny</code>
                                    方法。它可以使用任务的结果继续进行。</font>
                            </font>
                        </font>
                    </p>
                </section>
            </section> <span aria-label="296" epub:type="pagebreak" id="Page_296" role="doc-pagebreak"
                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
            <section data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"><span id="c11-sec-0018"
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
                <h3 id="head-3-226" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">Using ValueTasks <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用 ValueTasks </font>
                        </font>
                    </font>
                </h3>
                <p id="c11-para-0048" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">Previous to C# 7, the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code> keyword
                    required a <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                    to wait for. Since C# 7, any class implementing the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GetAwaiter</code> method
                    can be used. A type that can be used with <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code> is <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ValueTask</code>. <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code> is a class,
                    but <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ValueTask</code> is
                    a struct. This has a performance advantage because the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ValueTask</code> doesn't
                    have an object on the heap.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在 C# 7 之前， <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                                关键字需要一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                                来等待。自 C# 7 起，任何实现 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GetAwaiter</code>
                                方法的类都可以使用。可以用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                                的类型是 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ValueTask</code>
                                。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                                是一个类，但 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ValueTask</code>
                                是一个结构体。这有一个性能优势，因为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ValueTask</code>
                                在堆上没有对象。</font>
                        </font>
                    </font>
                </p>
                <p id="c11-para-0049" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">What is the real overhead of a <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code> object
                    compared to the asynchronous method call? A method that needs to be invoked asynchronously typically
                    has a lot more overhead than an object on the heap. Most times, the overhead of a <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code> object on the
                    heap can be ignored—but not always. For example, a method can have one path where data is retrieved
                    from a service with an asynchronous API. With this data retrieval, the data is written to a local
                    cache. When you invoke the method the second time, the data can be retrieved in a fast manner
                    without needing to create a <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code> object.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                                对象与异步方法调用相比的真实开销是什么？需要异步调用的方法通常比堆上的对象有更多的开销。大多数情况下，堆上 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                                对象的开销可以忽略——但并非总是如此。例如，一个方法可以有一条路径，从具有异步 API
                                的服务中检索数据。通过这种数据检索，数据会被写入本地缓存。当你第二次调用该方法时，数据可以快速检索，而无需创建 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                                对象。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">The sample method <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GreetingValueTaskAsync</code>
                    does exactly this. In case the name is already found in the dictionary, the result is returned as a
                    <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ValueTask</code>. If
                    the name isn't in the dictionary, the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GreetingAsync</code>
                    method is invoked, which returns a <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>. This task is
                    awaited. The result received is used to return it in a <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ValueTask</code> (code
                    file <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TaskFoundations/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">示例方法 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GreetingValueTaskAsync</code>
                                正是这样做的。如果名称已在字典中找到，结果会以 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ValueTask</code>
                                返回。如果名称不在字典中，会调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GreetingAsync</code>
                                方法，该方法返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                                。这个任务被等待。收到的结果用于在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ValueTask</code>
                                中返回（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TaskFoundations/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c11-code-0016"><code>private readonly static Dictionary&lt;string, string&gt; names = new Dictionary&lt;string, string&gt;();</code>
<code> </code>
<code>static async ValueTask&lt;string&gt; GreetingValueTaskAsync(string name)</code>
<code>{</code>
<code>  if (names.TryGetValue(name, out string result))</code>
<code>  {</code>
<code>    return result;</code>
<code>  }</code>
<code>  else</code>
<code>  {</code>
<code>    result = await GreetingAsync(name);</code>
<code>    names.Add(name, result);</code>
<code>    return result;                </code>
<code>  }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">The <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">UseValueTask</code>
                    method invokes the method <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GreetingValueTaskAsync</code>
                    two times with the same name. The first time, the data is retrieved using the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GreetingAsync</code>
                    method; the second time, data is found in the dictionary and returned from there:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">方法 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">UseValueTask</code>
                                调用名为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GreetingValueTaskAsync</code>
                                的方法两次。第一次，使用方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GreetingAsync</code>
                                获取数据；第二次，在字典中查找数据并从那里返回：</font>
                        </font>
                    </font>
                </p>
                <pre id="c11-code-0017"><code>private static async void UseValueTask()</code>
<code>{</code>
<code>  string result = await GreetingValueTaskAsync("Katharina");</code>
<code>  Console.WriteLine(result);</code>
<code>  string result2 = await GreetingValueTaskAsync("Katharina");</code>
<code>  Console.WriteLine(result2);</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">If a method doesn't use the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code> modifier and
                    a <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ValueTask</code>
                    needs to be returned, <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ValueTask</code> objects
                    can be created using the constructor passing the result or passing a <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code> object:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">如果方法不使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code>
                                修饰符且需要返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ValueTask</code>
                                ，可以使用构造函数传递结果或传递一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                                对象：</font>
                        </font>
                    </font>
                </p>
                <pre id="c11-code-0018"><code>static ValueTask&lt;string&gt; GreetingValueTask2Async(string name)</code>
<code>{</code>
<code>  if (names.TryGetValue(name, out string result))</code>
<code>  {</code>
<code>    <b>return new ValueTask&lt;string&gt;(result);</b></code>
<code>  }</code>
<code>  else</code>
<code>  {</code>
<code>    Task&lt;string&gt; t1 =  GreetingAsync(name);</code>
<code>                <span aria-label="297" epub:type="pagebreak" id="Page_297" role="doc-pagebreak"></span></code>
<code>    TaskAwaiter&lt;string&gt; awaiter = t1.GetAwaiter();</code>
<code>    awaiter.OnCompleted(OnCompletion);</code>
<code>    return new ValueTask&lt;string&gt;(t1);</code>
<code> </code>
<code>    void OnCompletion()</code>
<code>    {</code>
<code>      names.Add(name, awaiter.GetResult());</code>
<code>    }</code>
<code>  }</code>
<code>}</code></pre>
            </section>
        </section>
        <section aria-labelledby="head-2-99" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
            <span id="c11-sec-0019" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
            <h2 id="head-2-99" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">ERROR HANDLING<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">错误处理</font>
                    </font>
                </font>
            </h2>
            <p id="c11-para-0053" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1"><a href="c10.xhtml"
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Chapter 10</a>, “Errors and
                Exceptions,” provides detailed coverage of errors and exception handling. However, in the context of
                asynchronous methods, you should be aware of some special handling of errors.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">第 10
                            章“错误和异常”提供了对错误和异常处理的详细说明。然而，在异步方法的情况下，您应该了解一些特殊的错误处理方式。</font>
                    </font>
                </font>
            </p>
            <p id="c11-para-0054" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">The code for the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ErrorHandling</code> example
                makes use of the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">System.Threading.Tasks</code>
                namespace in addition to the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">System</code> namespace.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1"> <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ErrorHandling</code>
                            示例的代码除了使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">System</code>
                            命名空间外，还使用了 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">System.Threading.Tasks</code>
                            命名空间。</font>
                    </font>
                </font>
            </p>
            <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">Let's start with a simple method that throws an exception after a
                delay (code file <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ErrorHandling/Program.cs</code>):
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">让我们从一个简单的示例开始，该示例在延迟后抛出异常（代码文件 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ErrorHandling/Program.cs</code>
                            ）：</font>
                    </font>
                </font>
            </p>
            <pre id="c11-code-0019"><code>static async Task ThrowAfter(int ms, string message)</code>
<code>{</code>
<code>  await Task.Delay(ms);</code>
<code>  throw new Exception(message);</code>
<code>}</code></pre>
            <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">If you call the asynchronous method without awaiting it, you can
                put the asynchronous method within a <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">try</code>
                /
                <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">catch</code> block—and the
                exception will not be caught. That's because the method <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">DontHandle</code> that's
                shown in the following code snippet has already completed before the exception from <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ThrowAfter</code> is thrown.
                You need to await the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ThrowAfter</code> method, as
                shown in the example that follows in the next section. Pay attention that the exception is not caught in
                this code snippet:<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">如果你不等待异步方法，可以将异步方法放在 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">try</code> /
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">catch</code>
                            块中——异常将不会被捕获。这是因为以下代码片段中显示的方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">DontHandle</code>
                            在 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ThrowAfter</code>
                            抛出异常之前已经完成。你需要等待 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ThrowAfter</code>
                            方法，如下一节中的示例所示。请注意，此代码片段中并未捕获异常：</font>
                    </font>
                </font>
            </p>
            <pre id="c11-code-0020"><code>private static void DontHandle()</code>
<code>{</code>
<code>  try</code>
<code>  {</code>
<code>    ThrowAfter(200, "first");</code>
<code>    // exception is not caught because this method is finished</code>
<code>    // before the exception is thrown</code>
<code>  }</code>
<code>  catch (Exception ex)</code>
<code>  {</code>
<code>    Console.WriteLine(ex.Message);</code>
<code>  }</code>
<code>}</code></pre>
            <aside data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                <div class="top hr" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <hr />
                </div>
                <section class="feature2" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <p id="c11-para-0058" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                        data-immersive-translate-paragraph="1"><b
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WARNING</b> <i
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Asynchronous methods
                            that return </i><code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">void</code><i
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> cannot be awaited.
                            The issue with this is that exceptions that are thrown from </i><code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async void</code><i
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> methods cannot be
                            caught. That's why it is best to return a </i><code
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code><i
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> type from an
                            asynchronous method. Handler methods or overridden base methods are exempted from this rule
                            because you can't change the return type here. In cases where you need async void methods,
                            it's best to handle exceptions directly within this method; otherwise, the exception can be
                            missed.</i>
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">警告：返回 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">void</code>
                                    的异步方法不能被等待。这个问题在于从 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async void</code>
                                    方法抛出的异常无法被捕获。因此，最好从异步方法返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                                    类型。处理程序方法或重写的基方法不受此规则限制，因为在这里你不能更改返回类型。当你需要异步 void 方法时，最好直接在此方法中处理异常；否则，可能会错过异常。
                                </font>
                            </font>
                        </font>
                    </p>
                    <div class="bottom hr" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                        <hr />
                    </div>
                </section>
            </aside> <span aria-label="298" epub:type="pagebreak" id="Page_298" role="doc-pagebreak"
                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
            <section data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"><span id="c11-sec-0021"
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
                <h3 id="head-3-227" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">Handling Exceptions with Asynchronous Methods <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用异步方法处理异常</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">A good way to deal with exceptions from asynchronous methods
                    is to use <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                    and put a <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">try</code>
                    /
                    <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">catch</code> statement
                    around it, as shown in the following code snippet. The <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">HandleOnError</code>
                    method releases the thread after calling the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ThrowAfter</code> method
                    asynchronously, but it keeps the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code> referenced to
                    continue as soon as the task is completed. When that happens (which, in this case, is when the
                    exception is thrown after two seconds), the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">catch</code> matches and
                    the code within the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">catch</code> block is
                    invoked (code file <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ErrorHandling/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">处理异步方法异常的一个好方法是使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                                ，并在其周围放置 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">try</code> /
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">catch</code>
                                语句，如下面的代码片段所示。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">HandleOnError</code>
                                方法在异步调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ThrowAfter</code>
                                方法后释放线程，但保留 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                                引用以便在任务完成时继续执行。当这种情况发生时（在本例中，是在两秒后抛出异常时）， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">catch</code>
                                匹配，并调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">catch</code>
                                块内的代码（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ErrorHandling/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c11-code-0021"><code>private static async void HandleOnError()</code>
<code>{</code>
<code>  <b>try</b></code>
<code>  <b>{</b></code>
<code>    <b>await ThrowAfter(2000, "first");</b></code>
<code>  <b>}</b></code>
<code>  <b>catch (Exception ex)</b></code>
<code>  <b>{</b></code>
<code>    <b>Console.WriteLine($"handled {ex.Message}");</b></code>
<code>  <b>}</b></code>
<code>}</code></pre>
            </section>
            <section data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"><span id="c11-sec-0022"
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
                <h3 id="head-3-228" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">Handling Exceptions with Multiple Asynchronous Methods <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用多个异步方法处理异常</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">What if two asynchronous methods are invoked and both throw
                    exceptions? In the following example, first the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ThrowAfter</code> method
                    is invoked, which throws an exception with the message <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">first</code> after two
                    seconds. After this method is completed, the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ThrowAfter</code> method
                    is invoked, throwing an exception after one second. Because the first call to <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ThrowAfter</code> already
                    throws an exception, the code within the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">try</code> block does not
                    continue to invoke the second method, instead landing within the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">catch</code> block to
                    deal with the first exception (code file <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ErrorHandling/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                如果两个异步方法被调用并且它们都抛出异常怎么办？在以下示例中，首先调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ThrowAfter</code>
                                方法，该方法在两秒后抛出带有消息 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">first</code>
                                的异常。在此方法完成后，调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ThrowAfter</code>
                                方法，它在第一秒后抛出异常。由于对 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ThrowAfter</code>
                                的第一调用已经抛出异常， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">try</code>
                                块内的代码不会继续调用第二个方法，而是进入 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">catch</code>
                                块处理第一个异常（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ErrorHandling/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c11-code-0022"><code>private static async void StartTwoTasks()</code>
<code>{</code>
<code>  try</code>
<code>  {</code>
<code>    await ThrowAfter(2000, "first");</code>
<code>    await ThrowAfter(1000, "second"); // the second call is not invoked</code>
<code>    // because the first method throws</code>
<code>    // an exception</code>
<code>  }</code>
<code>  catch (Exception ex)</code>
<code>  {</code>
<code>    Console.WriteLine($"handled {ex.Message}");</code>
<code>  }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">Now start the two calls to <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ThrowAfter</code> in
                    parallel. The first method throws an exception after two seconds and the second one after one
                    second. With <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.WhenAll</code>, you
                    wait until both tasks are completed, whether an exception is thrown or not. Therefore, after a wait
                    of about two seconds, <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.WhenAll</code> is
                    completed, and the exception is caught with the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">catch</code> statement.
                    However, you only see the exception information from the first task that is passed to the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WhenAll</code> method.
                    It's not the task that threw the exception first (which is the second task), but the first task in
                    the list:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">现在并行启动对 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ThrowAfter</code>
                                的两个调用。第一个方法在两秒后抛出异常，第二个方法在第一秒后抛出异常。使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.WhenAll</code>
                                ，你等待两个任务都完成，无论是否抛出异常。因此，大约两秒后等待完成， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.WhenAll</code>
                                完成，并使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">catch</code>
                                语句捕获异常。然而，你只看到传递给 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WhenAll</code>
                                方法的第一个任务异常信息。它不是第一个抛出异常的任务（即第二个任务），而是列表中的第一个任务：</font>
                        </font>
                    </font>
                </p>
                <pre id="c11-code-0023"><code>private async static void StartTwoTasksParallel()</code>
<code>{</code>
<code>  try</code>
<code>  {<span aria-label="299" epub:type="pagebreak" id="Page_299" role="doc-pagebreak"></span></code>
<code>    <b>Task t1 =</b> ThrowAfter(2000, "first");</code>
<code>    <b>Task t2 =</b> ThrowAfter(1000, "second");</code>
<code>    <b>await Task.WhenAll(t1, t2);</b></code>
<code>  }</code>
<code>  catch (Exception ex)</code>
<code>  {</code>
<code>    // just display the exception information of the first task</code>
<code>    // that is awaited within WhenAll</code>
<code>    Console.WriteLine($"handled {ex.Message}");</code>
<code>  }</code>
<code>}</code></pre>
                <p id="c11-para-0062" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">One way to get the exception information from all tasks is to
                    declare the task variables <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">t1</code> and <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">t2</code> outside of the
                    <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">try</code> block, so
                    they can be accessed from within the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">catch</code> block. Here
                    you can check the status of the task to determine whether they are in a faulted state with the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IsFaulted</code>
                    property. In case of an exception, the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IsFaulted</code> property
                    returns true. The exception information itself can be accessed by using <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Exception.InnerException</code>
                    of the <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                    class. Another, and usually better, way to retrieve exception information from all tasks is
                    demonstrated next.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">一种获取所有任务异常信息的方法是，在 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">try</code>
                                块外部声明任务变量 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">t1</code> 和
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">t2</code>
                                ，以便它们可以在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">catch</code>
                                块内部被访问。在这里，您可以检查任务的状态，以确定它们是否处于具有 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IsFaulted</code>
                                属性的故障状态。在发生异常的情况下， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IsFaulted</code>
                                属性返回 true。异常信息本身可以通过使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                                类的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Exception.InnerException</code>
                                来访问。接下来演示了另一种（通常更好）从所有任务中检索异常信息的方法。</font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"><span id="c11-sec-0023"
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
                <h3 id="head-3-229" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">Using AggregateException Information <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用 AggregateException 信息</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">To get the exception information from all failing tasks, you
                    can write the result from <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.WhenAll</code> to a
                    <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code> variable.
                    This task is then awaited until all tasks are completed. Otherwise, the exception would still be
                    missed. As described in the preceding section, with the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">catch</code> statement,
                    only the exception of the first task can be retrieved. However, now you have access to the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Exception</code> property
                    of the outer task. The <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Exception</code> property
                    is of type <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">AggregateException</code>.
                    This exception type defines the property <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">InnerExceptions</code>
                    (not only <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">InnerException</code>),
                    which contains a list of all the exceptions that have been awaited for. Now you can easily iterate
                    through all the exceptions (code file <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ErrorHandling/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">要从所有失败的任务中获取异常信息，你可以将 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.WhenAll</code>
                                的结果写入 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                                变量。然后等待该任务直到所有任务完成。否则，异常仍然会被遗漏。正如前一节所述，使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">catch</code>
                                语句只能检索第一个任务的异常。然而，现在你可以访问外部任务的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Exception</code>
                                属性。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Exception</code>
                                属性的类型是 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">AggregateException</code>
                                。该异常类型定义了 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">InnerExceptions</code>
                                属性（而不仅仅是 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">InnerException</code>
                                ），其中包含所有已等待的异常列表。现在你可以轻松地遍历所有异常（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ErrorHandling/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c11-code-0024"><code>private static async void ShowAggregatedException()</code>
<code>{</code>
<code>  <b>Task taskResult = null;</b></code>
<code>  try</code>
<code>  {</code>
<code>    Task t1 = ThrowAfter(2000, "first");</code>
<code>    Task t2 = ThrowAfter(1000, "second");</code>
<code>    <b>await (taskResult = Task.WhenAll(t1, t2));</b></code>
<code>  }</code>
<code>  catch (Exception ex)</code>
<code>  {</code>
<code>    Console.WriteLine($"handled {ex.Message}");</code>
<code>    foreach (var ex1 in <b>taskResult.Exception.InnerExceptions)</b></code>
<code>    {</code>
<code>      Console.WriteLine($"inner exception {ex1.Message}");</code>
<code>    }</code>
<code>  }</code>
<code>}</code></pre>
            </section>
        </section>
        <section aria-labelledby="head-2-100" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
            <span id="c11-sec-0024" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
            <h2 id="head-2-100" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">CANCELLATION OF ASYNC METHODS<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">异步方法的取消</font>
                    </font>
                </font>
            </h2>
            <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">To cancel asynchronous operations, .NET includes a cancellation
                framework. The heart of this is the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">CancellationToken</code>
                that's created from a <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">CancellationTokenSource</code>
                defined in the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">System.Threading</code>
                namespace. To allow for cleanup of resources, a task should never be killed. To demonstrate how this can
                be done, the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">RunTaskAsync</code> method
                receives a <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">CancellationToken</code> with
                a parameter. Within the implementation, <span aria-label="300" epub:type="pagebreak" id="Page_300"
                    role="doc-pagebreak"
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>the cancellation token
                is checked if cancellation is requested. If it is, the task has time for cleanup of some resources and
                exits by invoking the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ThrowIfCancellationRequested</code>
                method of the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">CancellationToken</code>. In
                case cleanup is not required, you can immediately invoke <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ThrowIfCancellationRequired</code>,
                which throws the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">OperationCanceledException</code>
                if cancellation is required (code file <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TaskCancellation/Program.cs</code>):
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">要取消异步操作，.NET 包含一个取消框架。这个框架的核心是由 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">CancellationToken</code>
                            创建的，而 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">CancellationToken</code>
                            是在 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">System.Threading</code>
                            命名空间中定义的。为了允许资源清理，任务永远不应该被直接终止。为了演示如何实现这一点， <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">RunTaskAsync</code>
                            方法接收一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">CancellationToken</code>
                            ，其中包含一个参数。在实现中，会检查取消令牌是否请求取消。如果请求取消，任务将有时间进行一些资源清理，并通过调用 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">CancellationToken</code>
                            的 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ThrowIfCancellationRequested</code>
                            方法退出。如果不需要清理，可以直接调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ThrowIfCancellationRequired</code>
                            ，如果需要取消，它将抛出 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">OperationCanceledException</code>
                            （代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TaskCancellation/Program.cs</code>
                            ）：</font>
                    </font>
                </font>
            </p>
            <pre id="c11-code-0025"><code>Task RunTaskAsync(CancellationToken cancellationToken) =&gt;</code>
<code>  Task.Run(async () =&gt;</code>
<code>  {</code>
<code>    while (true)</code>
<code>    {</code>
<code>      Console.Write(".");</code>
<code>      await Task.Delay(100);</code>
<code>      if (cancellationToken.IsCancellationRequested)</code>
<code>      {</code>
<code>        // do some cleanup</code>
<code>        Console.WriteLine("resource cleanup and good bye!");</code>
<code>        cancellationToken.ThrowIfCancellationRequested();</code>
<code>      }</code>
<code>    }</code>
<code>  });</code></pre>
            <p id="c11-para-0065" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">The <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.Delay</code> method
                offers an overload where you can pass the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">CancellationToken</code> as
                well. This method throws an <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">OperationCanceledException</code>
                as well. If you use this overloaded <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.Delay</code> method and
                need some resource cleanup in the code, you need to catch the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">OperationCanceledException</code>
                to do the cleanup and re-throw the exception.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1"> <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.Delay</code>
                            方法提供了一个重载版本，允许你传递 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">CancellationToken</code>
                            。这个方法也会抛出 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">OperationCanceledException</code>
                            。如果你使用这个重载的 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.Delay</code>
                            方法，并且在代码中需要一些资源清理，你需要捕获 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">OperationCanceledException</code>
                            来进行清理，并重新抛出异常。</font>
                    </font>
                </font>
            </p>
            <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">When you start the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">RunTaskAsync</code> method, a
                <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">CancellationTokenSource</code>
                is created. Passing a <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TimeSpan</code> to the
                constructor cancels the associated token after the specified time. If you have some other task that
                should do the cancellation, this task can invoke the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Cancel</code> method of the
                <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">CancellationTokenSource</code>.
                The try/catch block catches the previously mentioned OperationCanceledException when cancellation
                occurs.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">当你开始使用 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">RunTaskAsync</code>
                            方法时，会创建一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">CancellationTokenSource</code>
                            。将 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TimeSpan</code>
                            传递给构造函数会在指定时间后取消关联的令牌。如果你有其他需要执行取消操作的任务，该任务可以调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">CancellationTokenSource</code>
                            的 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Cancel</code>
                            方法。try/catch 块会在发生取消操作时捕获前面提到的 OperationCanceledException。</font>
                    </font>
                </font>
            </p>
            <pre id="c11-code-0026"><code>CancellationTokenSource cancellation = new(TimeSpan.FromSeconds(5));</code>
<code> </code>
<code>try</code>
<code>{</code>
<code>  await RunTaskAsync(cancellation.Token);</code>
<code>}</code>
<code>catch (OperationCanceledException ex)</code>
<code>{</code>
<code>  Console.WriteLine(ex.Message);</code>
<code>}</code></pre>
        </section>
        <section aria-labelledby="head-2-101" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
            <span id="c11-sec-0025" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
            <h2 id="head-2-101" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">ASYNC STREAMS<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">异步流</font>
                    </font>
                </font>
            </h2>
            <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">A great enhancement since C# 8 is the support of async streams.
                Instead of getting just one result from an asynchronous method, a stream of async results can be
                received. Async streams is based on the interfaces <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncDisposable</code>,
                <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncEnumerable</code>,
                and <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncEnumerator</code>, and
                updated implementations for the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">foreach</code> and <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">yield</code> statements.
                <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncDisposable</code>
                defines the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">DisposeAsync</code> method
                for asynchronously disposing of resources. <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncEnumerable</code>
                corresponds to the synchronous <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IEnumerable</code> interface
                and defines the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GetAsyncEnumerator</code>
                method. <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncEnumerator</code>
                corresponds to the synchronous <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IEnumerator</code> interface
                and defines the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">MoveNextAsync</code> method
                and the <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Current</code>
                property. The <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">foreach</code> statement has
                been updated with the syntax <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await foreach</code> to
                iterate through async streams. The <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">yield</code> statement has
                been modified to support returning <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncEnumerable</code> and
                <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncEnumerator</code>.
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">自 C# 8
                            以来的一项重大增强是异步流的支持。不再只是从异步方法中获取一个结果，而是可以接收一个异步结果流。异步流基于 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncDisposable</code>
                            、 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncEnumerable</code>
                            和 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncEnumerator</code>
                            接口，并更新了 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">foreach</code> 和
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">yield</code>
                            语句的实现。 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncDisposable</code>
                            定义了异步释放资源的 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">DisposeAsync</code>
                            方法。 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncEnumerable</code>
                            对应于同步的 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IEnumerable</code>
                            接口，并定义了 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GetAsyncEnumerator</code>
                            方法。 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncEnumerator</code>
                            对应于同步的 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IEnumerator</code>
                            接口，并定义了 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">MoveNextAsync</code>
                            方法和 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Current</code>
                            属性。 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">foreach</code>
                            语句已使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await foreach</code>
                            语法更新，用于迭代异步流。 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">yield</code>
                            语句已修改以支持返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncEnumerable</code>
                            和 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncEnumerator</code>
                            。</font>
                    </font>
                </font><span aria-label="301" epub:type="pagebreak" id="Page_301" role="doc-pagebreak"
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span></p>
            <aside data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                <div class="top hr" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <hr />
                </div>
                <section class="feature2" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <p id="c11-para-0068" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                        data-immersive-translate-paragraph="1"><b
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">NOTE</b> <i
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Read <a
                                href="c06.xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Chapter 6</a>,
                            “Arrays,” for information about how the </i>
                        <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">foreach</code>
                        <i data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> and </i>
                        <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">yield</code>
                        <i data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> statements make use
                            of the synchronous iterator interfaces.</i>
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">注意：请阅读第 6 章“数组”，了解 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">foreach</code>
                                    和 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">yield</code>
                                    语句如何使用同步迭代器接口的信息。</font>
                            </font>
                        </font>
                    </p>
                    <div class="bottom hr" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                        <hr />
                    </div>
                </section>
            </aside>
            <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">To see async streams in action, a virtual device represented from
                the class <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ADevice</code>
                returns random sensor data in an async stream. The sensor data is defined with the record <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">SensorData</code>. The device
                returns sensor data until it is canceled. Adding the attribute <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">EnumeratorCancellation</code>
                to the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">CancellationToken</code>
                allows cancellation via an extension method shown later. Within the endless loop implementation, the
                <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">yield return</code>
                statement is used to return stream values for the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncEnumerable</code>
                interface (code file <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">AsyncStreams/Program.cs</code>):
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">要查看异步流的效果，一个由 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ADevice</code>
                            类表示的虚拟设备以异步流的形式返回随机传感器数据。传感器数据由记录 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">SensorData</code>
                            定义。设备会持续返回传感器数据直到被取消。通过稍后展示的扩展方法，将属性 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">EnumeratorCancellation</code>
                            添加到 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">CancellationToken</code>
                            允许取消。在无限循环实现中，使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">yield return</code>
                            语句返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncEnumerable</code>
                            接口的流值（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">AsyncStreams/Program.cs</code>
                            ）：</font>
                    </font>
                </font>
            </p>
            <pre id="c11-code-0027"><code>public record SensorData(int Value1, int Value2);</code>
<code> </code>
<code>public class ADevice</code>
<code>{</code>
<code>  private Random _random = new();</code>
<code>  public async IAsyncEnumerable&lt;SensorData&gt; GetSensorData(</code>
<code>    [EnumeratorCancellation] CancellationToken = default)</code>
<code>  {</code>
<code>    while(true)</code>
<code>    {</code>
<code>      await Task.Delay(250, cancellationToken);</code>
<code>      <b>yield return</b> new SensorData(_random.Next(20), _random.Next(20));</code>
<code>    }</code>
<code>  }</code>
<code>}</code></pre>
            <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">After defining a method that returns an async stream with the
                help of the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">yield return</code>
                statement, let's use this from an <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await foreach</code>. Here,
                the async stream is iterated, and the cancellation token is passed using the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WithCancellation</code>
                method to stop the stream after five seconds:<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">在定义一个使用 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">yield return</code>
                            语句返回异步流的函数后，让我们从 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await foreach</code>
                            中使用它。这里，异步流被迭代，并使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WithCancellation</code>
                            方法传递取消令牌，以便在五秒后停止流：</font>
                    </font>
                </font>
            </p>
            <pre id="c11-code-0028"><code>using System;</code>
<code>using System.Threading;</code>
<code>using System.Threading.Tasks;</code>
<code> </code>
<code>CancellationTokenSource cancellation = new(TimeSpan.FromSeconds(5));</code>
<code> </code>
<code>var aDevice = new ADevice();</code>
<code>try</code>
<code>{</code>
<code>  <b>await foreach (var data in aDevice.GetSensorData().WithCancellation(cancellation.Token))</b></code>
<code>  {</code>
<code>    Console.WriteLine($"{data.Value1} {data.Value2}");</code>
<code>  }</code>
<code>}</code>
<code>catch (OperationCanceledException ex)</code>
<code>{</code>
<code>  Console.WriteLine(ex.Message);</code>
<code>}</code></pre>
            <aside data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                <div class="top hr" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <hr />
                </div>
                <section class="feature2" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <p id="c11-para-0072" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                        data-immersive-translate-paragraph="1"><b
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">NOTE</b> <i
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">See <a
                                href="c25.xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Chapter 25</a>,
                            “Services,” and <a href="c28.xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Chapter 28</a>,
                            “SignalR,” for information about how async streaming can be used to asynchronously stream
                            data across the network.</i>
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">注意：请参阅第 25 章“服务”和第 28
                                    章“SignalR”，了解异步流如何用于跨网络异步流式传输数据的信息。</font>
                            </font>
                        </font>
                    </p>
                    <div class="bottom hr" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                        <hr />
                    </div>
                </section>
            </aside>
        </section> <span aria-label="302" epub:type="pagebreak" id="Page_302" role="doc-pagebreak"
            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
        <section aria-labelledby="head-2-102" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
            <span id="c11-sec-0028" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
            <h2 id="head-2-102" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">ASYNC WITH WINDOWS APPS<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">与 Windows 应用异步操作</font>
                    </font>
                </font>
            </h2>
            <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">Using the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code> keyword with
                Windows apps works the same as what you've already seen in this chapter. However, you need to be aware
                that after calling <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code> from the UI
                thread, when the asynchronous method returns, you're back in the UI thread by default. This makes it
                easy to update UI elements after the asynchronous method is completed.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">使用 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code> 关键字与
                            Windows 应用的操作方式与本章前面所见相同。然而，你需要注意的是，从 UI 线程调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                            后，当异步方法返回时，你将默认回到 UI 线程。这使得在异步方法完成后更新 UI 元素变得容易。</font>
                    </font>
                </font>
            </p>
            <aside data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                <div class="top hr" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <hr />
                </div>
                <section class="feature2" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <p id="c11-para-0074" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                        data-immersive-translate-paragraph="1"><b
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">NOTE</b> <i
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">The Windows apps
                            sample code in this chapter uses the new technology WinUI to create a Windows application.
                            Because this technology is so new, please check for updated readme files in the directory of
                            the code samples for what you need to run this application. Using WPF or UWP instead is not
                            a lot different, and you can change the code for these technologies easily.</i>
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">注意 本章中的 Windows 应用示例代码使用新技术
                                    WinUI 创建 Windows 应用程序。由于这项技术非常新，请检查代码示例目录中的更新 readme 文件，了解运行此应用程序所需的说明。使用 WPF 或 UWP
                                    替代方案差别不大，你可以轻松地修改这些技术的代码。</font>
                            </font>
                        </font>
                    </p>
                    <div class="bottom hr" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                        <hr />
                    </div>
                </section>
            </aside>
            <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">Let's create a WinUI Desktop application with Visual Studio. This
                app contains five buttons and a <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TextBlock</code> element to
                demonstrate different scenarios (code file <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">AsyncWindowsApps/MainWindow.xaml</code>):
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">让我们使用 Visual Studio 创建一个 WinUI
                            桌面应用程序。该应用包含五个按钮和一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TextBlock</code>
                            元素，用于演示不同场景（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">AsyncWindowsApps/MainWindow.xaml</code>
                            ）：</font>
                    </font>
                </font>
            </p>
            <pre id="c11-code-0029"><code>&lt;StackPanel&gt;</code>
<code>  &lt;Button Content="Start Async" Click="OnStartAsync" Margin="4"/&gt;</code>
<code>  &lt;Button Content="Start Async with ConfigureAwait" Click="OnStartAsyncConfigureAwait" </code>
<code>    Margin="4"/&gt;</code>
<code>  &lt;Button Content="Start Async with Thread Switch" </code>
<code>    Click="OnStartAsyncWithThreadSwitch" Margin="4"/&gt;</code>
<code>  &lt;Button Content="Use IAsyncOperation" Click="OnIAsyncOperation" Margin="4"/&gt;</code>
<code>  &lt;Button Content="Deadlock" Click="OnStartDeadlock" Margin="4"/&gt;</code>
<code>  &lt;TextBlock x:Name="text1" Margin="4"/&gt;</code>
<code>&lt;/StackPanel&gt;</code></pre>
            <aside data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                <div class="top hr" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <hr />
                </div>
                <section class="feature2" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <p id="c11-para-0077" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                        data-immersive-translate-paragraph="1"><b
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">NOTE</b> <i
                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Programming WinUI
                            apps is covered in detail in <a href="c29.xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Chapters 29</a>
                            through 32.</i>
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">注意：在 29 章至 32 章中详细介绍了如何编程
                                    WinUI 应用。</font>
                            </font>
                        </font>
                    </p>
                    <div class="bottom hr" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                        <hr />
                    </div>
                </section>
            </aside>
            <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">In the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">OnStartAsync</code> method,
                the thread ID of the UI thread is written to the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TextBlock</code> element.
                Next, the asynchronous method <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.Delay</code>, which does
                not block the UI thread, is invoked, and after this method is completed, the thread ID is written to the
                <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TextBlock</code> again
                (code file <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">AsyncWindowsDesktopApp/MainWindow.xaml.cs</code>):
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">在 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">OnStartAsync</code>
                            方法中，UI 线程的线程 ID 被写入 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TextBlock</code>
                            元素。接下来，调用异步方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.Delay</code>
                            ，该方法不会阻塞 UI 线程，当此方法完成后，线程 ID 再次被写入 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TextBlock</code>
                            （代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">AsyncWindowsDesktopApp/MainWindow.xaml.cs</code>
                            ）：</font>
                    </font>
                </font>
            </p>
            <pre id="c11-code-0030"><code>private async void OnStartAsync(object sender, RoutedEventArgs e)</code>
<code>{</code>
<code>  text1.Text = $"UI thread: {GetThread()}";</code>
<code>  await Task.Delay(1000);</code>
<code>  text1.Text += $"\n after await: {GetThread()}";</code>
<code>}</code></pre>
            <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">For accessing the thread ID, WinUI can now use the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Thread</code> class. With
                older UWP versions, you need to use <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Environment.CurrentManagedThreadId</code>
                instead:<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">要访问线程 ID，WinUI 现在可以使用 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Thread</code>
                            类。对于较旧的 UWP 版本，您需要使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Environment.CurrentManagedThreadId</code>
                            ：</font>
                    </font>
                </font>
            </p>
            <pre
                id="c11-code-0031"><code>private string GetThread() =&gt; $"thread: {Thread.CurrentThread.ManagedThreadId}";</code></pre>
            <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1"><span aria-label="303" epub:type="pagebreak" id="Page_303"
                    role="doc-pagebreak"
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>When you run the
                application, you can see similar output in the text element. Contrary to console applications, with
                Windows apps defining a synchronization context, after the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code> you can see the
                same thread as before. This allows direct access to UI elements:<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            运行应用程序时，您可以在文本元素中看到类似的输出。与控制台应用程序不同，Windows 应用定义了同步上下文，在 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                            之后，您可以看到之前的相同线程。这允许直接访问 UI 元素：</font>
                    </font>
                </font>
            </p>
            <pre id="c11-code-0032"><code>UI thread: thread 1</code>
<code>after await: thread 1</code></pre>
            <section data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"><span id="c11-sec-0031"
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
                <h3 id="head-3-230" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">Configure Await <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">配置 Await</font>
                        </font>
                    </font>
                </h3>
                <p id="c11-para-0081" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">If you don't need access to UI elements, you can configure
                    <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code> not to use
                    the synchronization context. The next code snippet demonstrates the configuration and also shows why
                    you shouldn't access UI elements from a background thread.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">如果你不需要访问 UI 元素，可以配置 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                                不使用同步上下文。下一个代码片段展示了如何进行配置，同时也说明了为什么你不应该从后台线程访问 UI 元素。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">With the method <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">OnStartAsyncConfigureAwait</code>,
                    after writing the ID of the UI thread to the text information, the local function <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">AsyncFunction</code> is
                    invoked. In this local function, the starting thread is written before the asynchronous method <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.Delay</code> is
                    invoked. Using the task returned from this method, the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ConfigureAwait</code> is
                    invoked. With this method, the task is configured by passing the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">continueOnCapturedContext</code>
                    argument set to <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">false</code>. With this
                    context configuration, you see that the thread after the await is not the UI thread anymore. Using a
                    different thread to write the result to the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">result</code> variable is
                    okay. What you should never do is shown in the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">try</code> block:
                    accessing UI elements from a non-UI thread. The exception you get contains the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">HRESULT</code> value as
                    shown in the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">when</code> clause. Just
                    this exception is caught in the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">catch</code>
                    : the result is returned to the caller. With the caller, <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ConfigureAwait</code> is
                    invoked as well, but this time the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">continueOnCapturedContext</code>
                    is set to true. Here, both before and after the await, the method is running in the UI thread (code
                    file <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">AsyncWindowsDesktopApp/MainWindow.xaml.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用方法 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">OnStartAsyncConfigureAwait</code>
                                ，在将 UI 线程的 ID 写入文本信息后，会调用本地函数 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">AsyncFunction</code>
                                。在这个本地函数中，在调用异步方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.Delay</code>
                                之前会写入启动线程。使用这个方法返回的任务，会调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ConfigureAwait</code>
                                。通过这个方法，任务是通过将 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">continueOnCapturedContext</code>
                                参数设置为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">false</code>
                                来配置的。在这个上下文配置中，你会发现 await 之后的线程不再是 UI 线程了。使用不同的线程将结果写入 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">result</code>
                                变量是可以的。你永远不应该做的事情显示在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">try</code>
                                块中：从非 UI 线程访问 UI 元素。你得到的异常包含 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">HRESULT</code>
                                值，如 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">when</code>
                                条款所示。只有这个异常在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">catch</code>
                                中被捕获：结果返回给调用者。对于调用者，也会调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ConfigureAwait</code>
                                ，但这次 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">continueOnCapturedContext</code>
                                设置为 true。在这里，无论是 await 之前还是之后，方法都在 UI 线程中运行（代码文件 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">AsyncWindowsDesktopApp/MainWindow.xaml.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c11-code-0033"><code>private async void OnStartAsyncConfigureAwait(object sender, RoutedEventArgs e)</code>
<code>{</code>
<code>  text1.Text = $"UI thread: {GetThread()}";</code>
<code> </code>
<code>  <b>string s = await AsyncFunction().ConfigureAwait(</b></code>
<code>    <b>continueOnCapturedContext: true);</b></code>
<code> </code>
<code>  // after await, with continueOnCapturedContext true we are back in the UI thread</code>
<code>  text1.Text += $"\n{s}\nafter await: {GetThread()}";</code>
<code> </code>
<code>  async Task&lt;string&gt; AsyncFunction()</code>
<code>  {</code>
<code>    string result = $"\nasync function: {GetThread()}\n";</code>
<code>    <b>await Task.Delay(1000).ConfigureAwait(continueOnCapturedContext: false);</b></code>
<code>    result += $"\nasync function after await : {GetThread()};";</code>
<code> </code>
<code>    try</code>
<code>    {</code>
<code>      text1.Text = "this is a call from the wrong thread";</code>
<code>      return "not reached";</code>
<code>    }</code>
<code>    catch (Exception ex) when (ex.HResult == -2147417842)</code>
<code>    {</code>
<code>      result += $"exception: {ex.Message}";</code>
<code>      return result;</code>
<code>      // we know it's the wrong thread</code>
<code>      // don't access UI elements from the previous try block</code>
<code>    }</code>
<code>  }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"><span aria-label="304"
                        epub:type="pagebreak" id="Page_304" role="doc-pagebreak"
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span></p>
                <aside data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <div class="top hr" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                        <p id="c11-para-0084" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">NOTE</b> <i
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Exception
                                handling and filtering is explained in <a href="c10.xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Chapter
                                    10</a>.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意 异常处理和过滤在第 10 章中解释。
                                    </font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                            <hr />
                        </div>
                    </section>
                </aside>
                <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">When you run the application, you can see output similar to
                    the following. In the async local function after the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>, a different
                    thread is used. The text “
                    <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">not reached</code>
                    ” is never written, because the exception is thrown:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">当你运行应用程序时，你可以看到类似以下的输出。在 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                                后的异步本地函数中，使用了不同的线程。文本“ <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">not reached</code>
                                ”永远不会被写入，因为抛出了异常：</font>
                        </font>
                    </font>
                </p>
                <pre id="c11-code-0034"><code>UI thread: thread 1</code>
<code>async function: thread 1</code>
<code>async function after await: thread 5; exception: The application called an interface</code>
<code>that was marshalled for a different thread.</code>
<code>after await: thread 1</code></pre>
                <aside data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <div class="top hr" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                        <p id="c11-para-0087" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">NOTE</b> <i
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">In later WinUI
                                chapters in this book, data binding is used instead of directly accessing properties of
                                UI elements. However, with WinUI, you also can't write properties that are bound to UI
                                elements from a non-UI thread.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意 在本书后续的 WinUI
                                        章节中，使用数据绑定代替直接访问 UI 元素的属性。然而，使用 WinUI 时，你也无法从非 UI 线程写入绑定到 UI 元素的属性。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                            <hr />
                        </div>
                    </section>
                </aside>
            </section>
            <section data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"><span id="c11-sec-0034"
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
                <h3 id="head-3-231" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">Switch to the UI Thread <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">切换到 UI 线程 </font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">In some scenarios, there's no effortless way around using a
                    background thread and accessing UI elements. Here, you can switch to the UI thread with the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">DispatcherQueue</code>
                    object that is returned from the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">DispatcherQueue</code>
                    property. The <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">DispatcherQueue</code>
                    property is defined in the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">DependencyObject</code>
                    class. <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">DependencyObject</code>
                    is a base class of UI elements. Invoking the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TryEnqueu</code> method
                    of the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">DispatcherQueue</code>
                    object runs the passed lambda expression again in a UI thread (code file <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">AsyncWindowsDesktopApp/MainWindow.xaml.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在某些场景下，没有轻松绕过使用后台线程和访问 UI
                                元素的方法。在这里，你可以使用从 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">DispatcherQueue</code>
                                属性返回的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">DispatcherQueue</code>
                                对象切换到 UI 线程。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">DispatcherQueue</code>
                                属性在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">DependencyObject</code>
                                类中定义。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">DependencyObject</code>
                                是 UI 元素的基础类。调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">DispatcherQueue</code>
                                对象的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">TryEnqueu</code>
                                方法会在 UI 线程中再次运行传入的 lambda 表达式（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">AsyncWindowsDesktopApp/MainWindow.xaml.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c11-code-0035"><code>private async void OnStartAsyncWithThreadSwitch(object sender, RoutedEventArgs e)</code>
<code>{</code>
<code>  text1.Text = $"UI thread: {GetThread()}";</code>
<code> </code>
<code>  string s = await AsyncFunction();</code>
<code> </code>
<code>  text1.Text += $"\nafter await: {GetThread()}";</code>
<code> </code>
<code>  async Task&lt;string&gt; AsyncFunction()</code>
<code>  {</code>
<code>    string result = $"\nasync function: {GetThread()}\n";</code>
<code>    await Task.Delay(1000).ConfigureAwait(continueOnCapturedContext: false);</code>
<code>    result += $"\nasync function after await : {GetThread()}";</code>
<code> </code>
<code>    text1.DispatcherQueue.TryEnqueue(() =&gt;</code>
<code>    {</code>
<code>      text1.Text += </code>
<code>        $"\nasync function switch back to the UI thread: {GetThread()}";</code>
<code>    }</code>
<code>    return result;</code>
<code>  }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1"><span aria-label="305" epub:type="pagebreak" id="Page_305"
                        role="doc-pagebreak"
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>When you run the
                    application, you can see the UI thread used when using <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">RunAsync</code>
                    :<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">当你运行应用程序时，可以看到在使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">RunAsync</code>
                                时使用的 UI 线程：</font>
                        </font>
                    </font>
                </p>
                <pre id="c11-code-0036"><code>UI Thread: thread 1</code>
<code>async function switch back to the UI thread: thread 1</code>
<code>async function: thread 1</code>
<code>async function after await: thread 4</code>
<code>after await: thread 1</code></pre>
            </section>
            <section data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"><span id="c11-sec-0035"
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
                <h3 id="head-3-232" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">Using IAsyncOperation <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用 IAsyncOperation</font>
                        </font>
                    </font>
                </h3>
                <p id="c11-para-0090" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">Asynchronous methods are defined by the Windows Runtime not
                    to return a <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                    or a <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ValueTask</code>.
                    <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code> and <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ValueTask</code> are not
                    part of the Windows Runtime. Instead, these methods return an object that implements the interface
                    <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncOperation</code>.
                    <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncOperation</code>
                    does not define the method <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GetAwaiter</code> as
                    needed by the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code> keyword.
                    However, an <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncOperation</code> is
                    automatically converted to a <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code> when you use
                    the <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                    keyword. You can also use the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">AsTask</code> extension
                    method to convert an <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncOperation</code>
                    object to a task.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">异步方法由 Windows 运行时定义，不会返回 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code> 或
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ValueTask</code>
                                。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code> 和
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ValueTask</code>
                                不是 Windows 运行时的一部分。相反，这些方法返回一个实现 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncOperation</code>
                                接口的对象。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncOperation</code>
                                没有定义 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                                关键字所需的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">GetAwaiter</code>
                                方法。然而，当你使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                                关键字时， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncOperation</code>
                                会自动转换为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                                。你也可以使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">AsTask</code>
                                扩展方法将 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncOperation</code>
                                对象转换为任务。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">With the example application, in the method <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">OnIAsyncOperation</code>,
                    the <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ShowAsync</code>
                    method of the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">MessageDialog</code> is
                    invoked. This method returns an <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncOperation</code>,
                    and you can simply use the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code> keyword to
                    get the result (code file <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">AsyncDesktopWindowsApp/MainWindow.xaml.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用示例应用程序，在 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">OnIAsyncOperation</code>
                                方法中，调用了 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">MessageDialog</code>
                                的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">ShowAsync</code>
                                方法。该方法返回一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">IAsyncOperation</code>
                                ，你可以简单地使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                                关键字获取结果（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">AsyncDesktopWindowsApp/MainWindow.xaml.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c11-code-0037"><code>private async void OnIAsyncOperation(object sender, RoutedEventArgs e)</code>
<code>{</code>
<code>  MessageDialog dlg = new("Select One, Two, Or Three", "Sample");</code>
<code> </code>
<code>  dlg.Commands.Add(new UICommand("One", null, 1));</code>
<code>  dlg.Commands.Add(new UICommand("Two", null, 2));</code>
<code>  dlg.Commands.Add(new UICommand("Three", null, 3));</code>
<code> </code>
<code>  <b>IUICommand command = await dlg.ShowAsync();</b></code>
<code> </code>
<code>  text1.Text = $"Command {command.Id} with the label {command.Label} invoked";</code>
<code>}</code></pre>
            </section>
            <section data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"><span id="c11-sec-0036"
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
                <h3 id="head-3-233" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">Avoid Blocking Scenarios <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">避免阻塞场景</font>
                        </font>
                    </font>
                </h3>
                <p id="c11-para-0092" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">It's dangerous using <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Wait</code> on a <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code> and the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code> keyword
                    together. With applications using the synchronization context, this can easily result in a deadlock.
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Wait</code> 和
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code>
                                关键字一起使用时，使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                                是危险的。对于使用同步上下文的应用程序，这很容易导致死锁。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                    data-immersive-translate-paragraph="1">In the method <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">OnStartDeadlock</code>,
                    the local function <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">DelayAsync</code> is
                    invoked. <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">DelayAsync</code> waits
                    on the completion of <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.Delay</code> before
                    continuing in the foreground thread. However, the caller invokes the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Wait</code> method on the
                    task returned from <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">DelayAsync</code>. The
                    <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Wait</code> method
                    blocks the calling thread until the task is completed. In this case, the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Wait</code> is invoked
                    from the foreground thread, so the <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Wait</code> blocks the
                    foreground thread. The <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code> on <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.Delay</code> can
                    never complete, because the foreground thread is not available. This is a classical deadlock
                    scenario (code file <code
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">AsyncWindowsDesktopApp/MainWindow.xaml.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">OnStartDeadlock</code>
                                方法中，调用了本地函数 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">DelayAsync</code>
                                。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">DelayAsync</code>
                                在前台线程中等待 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.Delay</code>
                                完成后才继续执行。然而，调用者在对 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">DelayAsync</code>
                                返回的任务上调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Wait</code>
                                方法。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Wait</code>
                                方法会阻塞调用线程，直到任务完成。在这种情况下， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Wait</code>
                                是从前台线程调用的，所以 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Wait</code>
                                阻塞了前台线程。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                                在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.Delay</code>
                                上永远无法完成，因为前台线程不可用。这是一个经典的死锁场景（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">AsyncWindowsDesktopApp/MainWindow.xaml.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c11-code-0038"><code>private void OnStartDeadlock(object sender, RoutedEventArgs e)</code>
<code>{</code>
<code>  DelayAsync().Wait();</code>
<code>}</code>
<code> </code>
<code>private async Task DelayAsync()</code>
<code>{</code>
<code>  await Task.Delay(1000);</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"><span aria-label="306"
                        epub:type="pagebreak" id="Page_306" role="doc-pagebreak"
                        data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span></p>
                <aside data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                    <div class="top hr" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                        <p id="c11-para-0095" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">WARNING</b> <i
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Avoid using </i>
                            <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Wait</code> <i
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> and </i> <code
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code> <i
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"> together in
                                applications using the synchronization context.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">警告：在使用同步上下文的应用程序中，避免将
                                        <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Wait</code>
                                        和 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                                        一起使用。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
                            <hr />
                        </div>
                    </section>
                </aside>
            </section>
        </section>
        <section aria-labelledby="head-2-103" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">
            <span id="c11-sec-0038" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"></span>
            <h2 id="head-2-103" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">SUMMARY<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">摘要</font>
                    </font>
                </font>
            </h2>
            <p id="c11-para-0096" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">This chapter introduced the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code> and <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code> keywords. In the
                examples provided, you've seen the advantages of the task-based asynchronous pattern compared to the
                asynchronous pattern and the event-based asynchronous pattern available with earlier editions of .NET.
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">本章介绍了 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code> 和
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                            关键字。在提供的示例中，你看到了基于任务的异步模式与早期.NET 版本中可用的异步模式和事件驱动的异步模式相比的优势。</font>
                    </font>
                </font>
            </p>
            <p id="c11-para-0097" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">You've also seen how easy it is to create asynchronous methods
                with the help of the <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code> class and learned
                how to use the <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code>
                and <code data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code> keywords
                to wait for these methods without blocking threads. You looked at the error-handling and cancelation
                aspects of asynchronous methods, and you've seen how async streams are supported with C#. For invoking
                asynchronous methods in parallel, you've seen the use of <code
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.WhenAll</code>.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">你还看到了借助 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task</code>
                            类创建异步方法的便捷性，并学习了如何使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">async</code> 和
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">await</code>
                            关键字来等待这些方法而不阻塞线程。你研究了异步方法的错误处理和取消方面，并看到了 C#如何支持异步流。为了并行调用异步方法，你看到了 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Task.WhenAll</code>
                            的使用。</font>
                    </font>
                </font>
            </p>
            <p id="c11-para-0098" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">For more information on parallel programming and details about
                threads and tasks, see <a href="c17.xhtml"
                    data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5">Chapter 17</a>, “Parallel
                Programming.”<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">有关并行编程的更多信息以及线程和任务的详细信息，请参阅第 17
                            章，“并行编程。”</font>
                    </font>
                </font>
            </p>
            <p id="c11-para-0099" data-immersive-translate-walked="dbdc3d91-7d2e-45ac-8ef7-db6f2f5210e5"
                data-immersive-translate-paragraph="1">The next chapter continues with core features of C# and .NET and
                gives detailed information on reflection, metadata, and source generators.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">下一章将继续介绍 C#和.NET
                            的核心特性，并提供有关反射、元数据和源生成器的详细信息。</font>
                    </font>
                </font>
            </p>
        </section>
    </section>
</body>
<div id="immersive-translate-popup" style="all: initial"></div>

</html>