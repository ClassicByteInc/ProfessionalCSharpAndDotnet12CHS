<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops"
    xmlns:svg="http://www.w3.org/2000/svg" epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en"
    imt-state="dual" imt-trans-position="after">

<head>
    <title>17 并行编程 --- 17 Parallel Programming</title>
    <link href="WileyTemplate_v5.5.css" rel="stylesheet" type="text/css" />
    <meta content="urn:uuid:e0000000-0000-0000-0000-000006715209" name="Adept.expected.resource" />
    <style data-id="immersive-translate-input-injected-css">
        .immersive-translate-input {
            position: absolute;
            top: 0;
            right: 0;
            left: 0;
            bottom: 0;
            z-index: 2147483647;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .immersive-translate-attach-loading::after {
            content: " ";

            --loading-color: #f78fb6;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: block;
            margin: 12px auto;
            position: relative;
            color: white;
            left: -100px;
            box-sizing: border-box;
            animation: immersiveTranslateShadowRolling 1.5s linear infinite;

            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-2000%, -50%);
            z-index: 100;
        }

        .immersive-translate-loading-spinner {
            vertical-align: middle !important;
            width: 10px !important;
            height: 10px !important;
            display: inline-block !important;
            margin: 0 4px !important;
            border: 2px rgba(221, 244, 255, 0.6) solid !important;
            border-top: 2px rgba(0, 0, 0, 0.375) solid !important;
            border-left: 2px rgba(0, 0, 0, 0.375) solid !important;
            border-radius: 50% !important;
            padding: 0 !important;
            -webkit-animation: immersive-translate-loading-animation 0.6s infinite linear !important;
            animation: immersive-translate-loading-animation 0.6s infinite linear !important;
        }

        @-webkit-keyframes immersive-translate-loading-animation {
            from {
                -webkit-transform: rotate(0deg);
            }

            to {
                -webkit-transform: rotate(359deg);
            }
        }

        @keyframes immersive-translate-loading-animation {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(359deg);
            }
        }

        .immersive-translate-input-loading {
            --loading-color: #f78fb6;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: block;
            margin: 12px auto;
            position: relative;
            color: white;
            left: -100px;
            box-sizing: border-box;
            animation: immersiveTranslateShadowRolling 1.5s linear infinite;
        }

        @keyframes immersiveTranslateShadowRolling {
            0% {
                box-shadow: 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0),
                    0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
            }

            12% {
                box-shadow: 100px 0 var(--loading-color), 0px 0 rgba(255, 255, 255, 0),
                    0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
            }

            25% {
                box-shadow: 110px 0 var(--loading-color), 100px 0 var(--loading-color),
                    0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
            }

            36% {
                box-shadow: 120px 0 var(--loading-color), 110px 0 var(--loading-color),
                    100px 0 var(--loading-color), 0px 0 rgba(255, 255, 255, 0);
            }

            50% {
                box-shadow: 130px 0 var(--loading-color), 120px 0 var(--loading-color),
                    110px 0 var(--loading-color), 100px 0 var(--loading-color);
            }

            62% {
                box-shadow: 200px 0 rgba(255, 255, 255, 0), 130px 0 var(--loading-color),
                    120px 0 var(--loading-color), 110px 0 var(--loading-color);
            }

            75% {
                box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0),
                    130px 0 var(--loading-color), 120px 0 var(--loading-color);
            }

            87% {
                box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0),
                    200px 0 rgba(255, 255, 255, 0), 130px 0 var(--loading-color);
            }

            100% {
                box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0),
                    200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0);
            }
        }

        .immersive-translate-toast {
            display: flex;
            position: fixed;
            z-index: 2147483647;
            left: 0;
            right: 0;
            top: 1%;
            width: fit-content;
            padding: 12px 20px;
            margin: auto;
            overflow: auto;
            background: #fef6f9;
            box-shadow: 0px 4px 10px 0px rgba(0, 10, 30, 0.06);
            font-size: 15px;
            border-radius: 8px;
            color: #333;
        }

        .immersive-translate-toast-content {
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        .immersive-translate-toast-hidden {
            margin: 0 20px 0 72px;
            text-decoration: underline;
            cursor: pointer;
        }

        .immersive-translate-toast-close {
            color: #666666;
            font-size: 20px;
            font-weight: bold;
            padding: 0 10px;
            cursor: pointer;
        }

        @media screen and (max-width: 768px) {
            .immersive-translate-toast {
                top: 0;
                padding: 12px 0px 0 10px;
            }

            .immersive-translate-toast-content {
                flex-direction: column;
                text-align: center;
            }

            .immersive-translate-toast-hidden {
                margin: 10px auto;
            }
        }

        .immersive-translate-modal {
            display: none;
            position: fixed;
            z-index: 2147483647;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0, 0, 0);
            background-color: rgba(0, 0, 0, 0.4);
            font-size: 15px;
        }

        .immersive-translate-modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 40px 24px 24px;
            border: 1px solid #888;
            border-radius: 10px;
            width: 80%;
            max-width: 270px;
            font-family: system-ui, -apple-system, "Segoe UI", "Roboto", "Ubuntu",
                "Cantarell", "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji",
                "Segoe UI Symbol", "Noto Color Emoji";
            position: relative;
        }

        @media screen and (max-width: 768px) {
            .immersive-translate-modal-content {
                margin: 50% auto !important;
            }
        }

        .immersive-translate-modal .immersive-translate-modal-content-in-input {
            max-width: 500px;
        }

        .immersive-translate-modal-content-in-input .immersive-translate-modal-body {
            text-align: left;
            max-height: unset;
        }

        .immersive-translate-modal-title {
            text-align: center;
            font-size: 16px;
            font-weight: 700;
            color: #333333;
        }

        .immersive-translate-modal-body {
            text-align: center;
            font-size: 14px;
            font-weight: 400;
            color: #333333;
            word-break: break-all;
            margin-top: 24px;
        }

        @media screen and (max-width: 768px) {
            .immersive-translate-modal-body {
                max-height: 250px;
                overflow-y: auto;
            }
        }

        .immersive-translate-close {
            color: #666666;
            position: absolute;
            right: 16px;
            top: 16px;
            font-size: 20px;
            font-weight: bold;
        }

        .immersive-translate-close:hover,
        .immersive-translate-close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .immersive-translate-modal-footer {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 24px;
        }

        .immersive-translate-btn {
            width: fit-content;
            color: #fff;
            background-color: #ea4c89;
            border: none;
            font-size: 16px;
            margin: 0 8px;
            padding: 9px 30px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .immersive-translate-btn:hover {
            background-color: #f082ac;
        }

        .immersive-translate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .immersive-translate-btn:disabled:hover {
            background-color: #ea4c89;
        }

        .immersive-translate-cancel-btn {
            /* gray color */
            background-color: rgb(89, 107, 120);
        }

        .immersive-translate-cancel-btn:hover {
            background-color: hsl(205, 20%, 32%);
        }

        .immersive-translate-action-btn {
            background-color: transparent;
            color: #ea4c89;
            border: 1px solid #ea4c89;
        }

        .immersive-translate-btn svg {
            margin-right: 5px;
        }

        .immersive-translate-link {
            cursor: pointer;
            user-select: none;
            -webkit-user-drag: none;
            text-decoration: none;
            color: #007bff;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
        }

        .immersive-translate-primary-link {
            cursor: pointer;
            user-select: none;
            -webkit-user-drag: none;
            text-decoration: none;
            color: #ea4c89;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
        }

        .immersive-translate-modal input[type="radio"] {
            margin: 0 6px;
            cursor: pointer;
        }

        .immersive-translate-modal label {
            cursor: pointer;
        }

        .immersive-translate-close-action {
            position: absolute;
            top: 2px;
            right: 0px;
            cursor: pointer;
        }

        .imt-image-status {
            background-color: rgba(0, 0, 0, 0.5) !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 16px !important;
        }

        .imt-image-status img,
        .imt-image-status svg,
        .imt-img-loading {
            width: 28px !important;
            height: 28px !important;
            margin: 0 0 8px 0 !important;
            min-height: 28px !important;
            min-width: 28px !important;
            position: relative !important;
        }

        .imt-img-loading {
            background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADgAAAA4CAMAAACfWMssAAAAtFBMVEUAAAD////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////oK74hAAAAPHRSTlMABBMIDyQXHwyBfFdDMSw+OjXCb+5RG51IvV/k0rOqlGRM6KKMhdvNyZBz9MaupmxpWyj437iYd/yJVNZeuUC7AAACt0lEQVRIx53T2XKiUBCA4QYOiyCbiAsuuGBcYtxiYtT3f6/pbqoYHVFO5r+iivpo6DpAWYpqeoFfr9f90DsYAuRSWkFnPO50OgR9PwiCUFcl2GEcx+N/YBh6pvKaefHlUgZd1zVe0NbYcQjGBfzrPE8Xz8aF+71D8gG6DHFPpc4a7xFiCDuhaWgKgGIJQ3d5IMGDrpS4S5KgpIm+en9f6PlAhKby4JwEIxlYJV9h5k5nee9GoxHJ2IDSNB0dwdad1NAxDJ/uXDHYmebdk4PdbkS58CIVHdYSUHTYYRWOJblWSyu2lmy3KNFVJNBhxcuGW4YBVCbYGRZwIooipHsNqjM4FbgOQqQqSKQQU9V8xmi1QlgHqQQ6DDBvRUVCDirs+EzGDGOQTCATgtYTnbCVLgsVgRE0T1QE0qHCFAht2z6dLvJQs3Lo2FQoDxWNUiBhaP4eRgwNkI+dAjVOA/kUrIDwf3CG8NfNOE0eiFotSuo+rBiq8tD9oY4Qzc6YJw99hl1wzpQvD7ef2M8QgnOGJfJw+EltQc+oX2yn907QB22WZcvlUpd143dqQu+8pCJZuGE4xCuPXJqqcs5sNpsI93Rmzym1k4Npk+oD1SH3/a3LOK/JpUBpWfqNySxWzCfNCUITuDG5dtuphrUJ1myeIE9bIsPiKrfqTai5WZxbhtNphYx6GEIHihyGFTI69lje/rxajdh0s0msZ0zYxyPLhYCb1CyHm9Qsd2H37Y3lugVwL9kNh8Ot8cha6fUNQ8nuXi5z9/ExsAO4zQrb/ev1yrCB7lGyQzgYDGuxq1toDN/JGvN+HyWNHKB7zEoK+PX11e12G431erGYzwmytAWU56fkMHY5JJnDRR2eZji3AwtIcrEV8Cojat/BdQ7XOwGV1e1hDjGGjXbdArm8uJZtCH5MbcctVX8A1WpqumJHwckAAAAASUVORK5CYII=");
            background-size: 28px 28px;
            animation: image-loading-rotate 1s linear infinite !important;
        }

        .imt-image-status span {
            color: var(--bg-2, #fff) !important;
            font-size: 14px !important;
            line-height: 14px !important;
            font-weight: 500 !important;
            font-family: "PingFang SC", Arial, sans-serif !important;
        }

        @keyframes image-loading-rotate {
            from {
                transform: rotate(360deg);
            }

            to {
                transform: rotate(0deg);
            }
        }
    </style>
    <style data-id="immersive-translate-default-injected-css">
        :root {
            --immersive-translate-theme-underline-borderColor: #72ece9;
            --immersive-translate-theme-nativeUnderline-borderColor: #72ece9;
            --immersive-translate-theme-nativeDashed-borderColor: #72ece9;
            --immersive-translate-theme-nativeDotted-borderColor: #72ece9;
            --immersive-translate-theme-highlight-backgroundColor: #ffff00;
            --immersive-translate-theme-dashed-borderColor: #59c1bd;
            --immersive-translate-theme-blockquote-borderColor: #cc3355;
            --immersive-translate-theme-thinDashed-borderColor: #ff374f;
            --immersive-translate-theme-dashedBorder-borderColor: #94a3b8;
            --immersive-translate-theme-dashedBorder-borderRadius: 0;
            --immersive-translate-theme-solidBorder-borderColor: #94a3b8;
            --immersive-translate-theme-solidBorder-borderRadius: 0;
            --immersive-translate-theme-dotted-borderColor: #94a3b8;
            --immersive-translate-theme-wavy-borderColor: #72ece9;
            --immersive-translate-theme-dividingLine-borderColor: #94a3b8;
            --immersive-translate-theme-grey-textColor: #2f4f4f;
            --immersive-translate-theme-marker-backgroundColor: #fbda41;
            --immersive-translate-theme-marker-backgroundColor-rgb: 251, 218, 65;
            --immersive-translate-theme-marker2-backgroundColor: #ffff00;
            --immersive-translate-theme-background-backgroundColor: #dbafaf;
            --immersive-translate-theme-background-backgroundColor-rgb: 219, 175, 175;
            --immersive-translate-theme-background-backgroundOpacity: 12;
            --immersive-translate-theme-opacity-opacity: 10;
        }

        [imt-state="dual"] .immersive-translate-target-translation-pre-whitespace {
            white-space: pre-wrap !important;
        }

        [imt-state="dual"] .immersive-translate-pdf-target-container {
            position: absolute;
            background-color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica,
                sans-serif;
            top: 0;
            width: 600px;
            height: 100%;
            z-index: 2;
            line-height: 1.3;
            font-size: 16px;
        }

        [imt-state="dual"] .immersive-translate-target-wrapper[dir="rtl"] {
            text-align: right;
        }

        [imt-state="dual"] .immersive-translate-pdf-target-container .immersive-translate-target-wrapper {
            color: rgb(0, 0, 0);
            white-space: normal;
            position: absolute;
        }

        [imt-state="dual"] .immersive-translate-pdf-target-container .immersive-translate-target-wrapper font {
            color: inherit;
            white-space: inherit;
            position: unset;
        }

        [imt-state="translation"] .immersive-translate-target-wrapper &gt;

        br {
            display: none;
        }

        [imt-state="translation"] .immersive-translate-target-translation-block-wrapper {
            margin: 0 !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper {
            margin: 8px 0 !important;
            display: inline-block;
        }

        [imt-trans-position="before"] .immersive-translate-target-translation-block-wrapper {
            display: block;
        }

        [imt-trans-position="before"] .immersive-translate-target-translation-block-wrapper {
            margin-top: 0 !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-pdf-block-wrapper {
            margin: 0 !important;
            display: inline-block;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-grey-inner {
            color: var(--immersive-translate-theme-grey-textColor);
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-underline-inner {
            border-bottom: 1px solid var(--immersive-translate-theme-underline-borderColor) !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-nativeUnderline-inner {
            text-decoration: underline !important;
            text-decoration-color: var(--immersive-translate-theme-nativeUnderline-borderColor) !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper-theme-dashedBorder {
            border: 1px dashed var(--immersive-translate-theme-dashedBorder-borderColor) !important;
            border-radius: var(--immersive-translate-theme-dashedBorder-borderRadius) !important;
            padding: 6px;
            margin-top: 2px;
            display: inline-block;
        }

        [imt-state="dual"] .immersive-translate-target-translation-inline-wrapper-theme-dashedBorder {
            border: 1px dashed var(--immersive-translate-theme-dashedBorder-borderColor) !important;
            border-radius: var(--immersive-translate-theme-dashedBorder-borderRadius) !important;
            padding: 2px;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper-theme-solidBorder {
            border: 1px solid var(--immersive-translate-theme-solidBorder-borderColor) !important;
            border-radius: var(--immersive-translate-theme-solidBorder-borderRadius) !important;
            padding: 6px;
            margin-top: 2px;
            display: inline-block;
        }

        [imt-state="dual"] .immersive-translate-target-translation-inline-wrapper-theme-solidBorder {
            border: 1px solid var(--immersive-translate-theme-solidBorder-borderColor) !important;
            border-radius: var(--immersive-translate-theme-solidBorder-borderRadius) !important;
            padding: 2px;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-nativeDashed-inner {
            text-decoration: underline !important;
            text-decoration-color: var(--immersive-translate-theme-nativeDashed-borderColor) !important;
            text-decoration-style: dashed !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-thinDashed-inner {
            border-bottom: 1px dashed var(--immersive-translate-theme-thinDashed-borderColor) !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-dotted-inner {
            background-image: linear-gradient(to right,
                    var(--immersive-translate-theme-dotted-borderColor) 30%,
                    rgba(255, 255, 255, 0) 0%);
            background-position: bottom;
            background-size: 5px 1px;
            background-repeat: repeat-x;
            padding-bottom: 3px;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-nativeDotted-inner {
            text-decoration: underline !important;
            text-decoration-color: var(--immersive-translate-theme-nativeDotted-borderColor) !important;
            text-decoration-style: dotted !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-wavy-inner {
            text-decoration: underline !important;
            text-decoration-color: var(--immersive-translate-theme-wavy-borderColor) !important;
            text-decoration-style: wavy !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-dashed-inner {
            background: linear-gradient(to right,
                    var(--immersive-translate-theme-dashed-borderColor) 0%,
                    var(--immersive-translate-theme-dashed-borderColor) 50%,
                    transparent 50%,
                    transparent 100%) repeat-x left bottom;
            background-size: 8px 2px;
            padding-bottom: 2px;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper-theme-dividingLine::before {
            content: "";
            display: block;
            max-width: 80px;
            width: 10%;
            border-top: 1px dashed var(--immersive-translate-theme-dividingLine-borderColor);
            padding-top: 8px;
        }

        [imt-state="dual"] .immersive-translate-target-translation-inline-wrapper-theme-dividingLine::before {
            content: "";
            border-left: 1px dashed var(--immersive-translate-theme-dividingLine-borderColor);
            max-height: 16px;
            height: 16px;
            padding-left: 8px;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-highlight-inner {
            background: var(--immersive-translate-theme-highlight-backgroundColor);
            box-decoration-break: clone;
            -webkit-box-decoration-break: clone;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper-theme-marker {
            line-height: 1.5em;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-marker2-inner {
            font-weight: bold;
            text-shadow: 10px 0px 3px var(--immersive-translate-theme-marker2-backgroundColor),
                16px 3px 9px var(--immersive-translate-theme-marker2-backgroundColor),
                2px 0px 6px var(--immersive-translate-theme-marker2-backgroundColor),
                -12px 0px 12px var(--immersive-translate-theme-marker2-backgroundColor) !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-marker-inner {
            /* TODO: add more texture */
            background: linear-gradient(to right,
                    rgba(var(--immersive-translate-theme-marker-backgroundColor-rgb), 0.1),
                    rgba(var(--immersive-translate-theme-marker-backgroundColor-rgb), 0.9) 3%,
                    rgba(var(--immersive-translate-theme-marker-backgroundColor-rgb), 0.9) 35%,
                    rgba(var(--immersive-translate-theme-marker-backgroundColor-rgb), 0.9) 70%,
                    rgba(var(--immersive-translate-theme-marker-backgroundColor-rgb), 0.8) 95%,
                    rgba(var(--immersive-translate-theme-marker-backgroundColor-rgb), 0.3));
            box-decoration-break: clone;
            -webkit-box-decoration-break: clone;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-weakening {
            opacity: 0.618 !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-italic {
            font-style: italic !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-bold {
            font-weight: bold !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper-theme-paper {
            margin: 8px 0;
            box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
            padding: 16px 32px;
            display: inline-block;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper-theme-blockquote {
            border-left: 4px solid var(--immersive-translate-theme-blockquote-borderColor) !important;
            padding-left: 12px !important;
            margin-top: 4px;
            margin-bottom: 4px;
            padding-top: 4px;
            padding-bottom: 4px;
            display: inline-block;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-mask-inner {
            filter: blur(5px) !important;
            transition: filter 0.3s ease !important;
            border-radius: 10px;
            display: inline-block;
        }

        [data-immersive-translate-root-translation-theme="none"] .immersive-translate-target-translation-theme-mask-inner {
            filter: none !important;
        }

        [data-immersive-translate-root-translation-theme="mask"] .immersive-translate-target-inner {
            filter: blur(5px) !important;
            transition: filter 0.3s ease !important;
            border-radius: 10px;
            display: inline-block;
        }

        /* opacity theme start */

        [imt-state="dual"] .immersive-translate-target-translation-theme-opacity-inner {
            filter: opacity(calc(var(--immersive-translate-theme-opacity-opacity) * 1%)) !important;
            transition: filter 0.3s ease !important;
            border-radius: 10px;
            display: inline-block;
        }

        [data-immersive-translate-root-translation-theme="none"] .immersive-translate-target-translation-theme-opacity-inner {
            filter: none !important;
        }

        [data-immersive-translate-root-translation-theme="opacity"] .immersive-translate-target-inner,
        [imt-state="dual"] .immersive-translate-target-translation-theme-opacity-inner:hover {
            filter: opacity(calc(var(--immersive-translate-theme-opacity-opacity) * 1%)) !important;
            transition: filter 0.3s ease !important;
            border-radius: 10px;
            display: inline-block;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-opacity-inner:hover {
            filter: none !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-mask-inner:hover {
            filter: none !important;
        }

        [data-immersive-translate-root-translation-theme="opacity"] .immersive-translate-target-inner:hover {
            filter: none !important;
        }

        [data-immersive-translate-root-translation-theme="mask"] .immersive-translate-target-inner:hover {
            filter: none !important;
        }

        /* opacity theme end */

        /* background theme start */
        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper-theme-background {
            margin: 8px 0;
            background: rgba(var(--immersive-translate-theme-background-backgroundColor-rgb),
                    calc(var(--immersive-translate-theme-background-backgroundOpacity) * 1%));
            border-radius: 4px;
            box-shadow: unset !important;
            padding: 12px;
            display: inline-block;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-background-inner {
            background: rgba(var(--immersive-translate-theme-background-backgroundColor-rgb),
                    calc(var(--immersive-translate-theme-background-backgroundOpacity) * 1%));
            padding-left: 6px;
            padding-right: 6px;
            box-decoration-break: clone;
            -webkit-box-decoration-break: clone;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper .immersive-translate-target-translation-theme-background-inner {
            background: unset;
            padding-left: unset;
            padding-right: unset;
        }

        /* background theme end */

        /* vertical css , please remain it in the last one. */
        .immersive-translate-target-translation-vertical-block-wrapper {
            margin: 0px 8px !important;
        }

        .immersive-translate-text {
            font-size: 15px !important;
        }

        .immersive-translate-error-toast {
            position: fixed;
            top: 5%;
            z-index: 99999999;
            left: 0;
            right: 0;
            margin: auto;
            max-width: 300px;
            padding: 16px;
            border-radius: 12px;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: row;
            justify-content: space-between;
        }

        @media all and (min-width: 750px) {
            .immersive-translate-error-toast {
                max-width: 400px;
            }
        }

        .immersive-translate-clickable-button {
            cursor: pointer;
        }

        .immersive-translate-help-button {
            cursor: pointer;
        }

        .immersive-translate-loading-text:before {
            content: "...";
        }

        /* dark mode for loading */

        @media only screen and (prefers-color-scheme: dark) {
            .immersive-translate-loading {
                border: 2px rgba(255, 255, 255, 0.25) solid !important;
                border-top: 2px rgba(255, 255, 255, 1) solid !important;
            }
        }

        .immersive-translate-error-wrapper {
            position: relative;
            display: inline-flex;
            padding: 6px;
            margin: 0 12px;
            white-space: nowrap;
            font-size: 0.9em;
        }

        [lang="zh-CN"] .immersive-translate-error-wrapper {
            font-size: 0.75em;
        }

        [lang="zh-TW"] .immersive-translate-error-wrapper {
            font-size: 0.75em;
        }

        .immersive-translate-tooltip {
            position: relative;
            display: inline-flex;
            /* little indicater to indicate it's hoverable */
        }

        .immersive-translate-tooltip-content {
            /* here's the magic */
            position: absolute;
            z-index: 100000000000;

            left: 50%;
            bottom: 0;
            transform: translate(-50%, 110%);
            line-height: 1;
            /* and add a small left margin */

            /* basic styles */
            width: max-content;
            max-width: 250px;
            word-wrap: break-word;
            white-space: pre-line;
            padding: 10px;
            border-radius: 10px;
            background: #000c;
            color: #fff;
            text-align: center;
            font-size: 14px;
            display: none;
            /* hide by default */
        }

        .immersive-translate-tooltip:hover .immersive-translate-tooltip-content {
            display: inline-block;
        }

        .immersive-translate-tooltip:hover+.immersive-translate-tooltip-content {
            display: inline-block;
        }

        .immersive-translate-tooltip-content-table {
            left: unset !important;
            bottom: unset !important;
            transform: translate(-10%, 50%) !important;
        }

        .immersive-translate-tooltip:hover:before {
            display: inline-block;
        }

        .immersive-translate-loading-spinner {
            vertical-align: middle !important;
            width: 10px !important;
            height: 10px !important;
            display: inline-block !important;
            margin: 0 4px !important;
            border: 2px rgba(221, 244, 255, 0.6) solid !important;
            border-top: 2px rgba(0, 0, 0, 0.375) solid !important;
            border-left: 2px rgba(0, 0, 0, 0.375) solid !important;
            border-radius: 50% !important;
            padding: 0 !important;
            -webkit-animation: immersive-translate-loading-animation 0.6s infinite linear !important;
            animation: immersive-translate-loading-animation 0.6s infinite linear !important;
        }

        @-webkit-keyframes immersive-translate-loading-animation {
            from {
                -webkit-transform: rotate(0deg);
            }

            to {
                -webkit-transform: rotate(359deg);
            }
        }

        @keyframes immersive-translate-loading-animation {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(359deg);
            }
        }

        .imt-image-status {
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--bg-2, #fff);
            font-size: 14px;
        }
    </style>
    <style data-id="immersive-translate-user-custom-style">
        :root {

            .immersive-translate-target-inner {
                font-family: inherit;
            }


            .immersive-translate-target-inner {
                font-family: inherit;
            }
        }
    </style>
    <style data-id="immersive-translate-dynamic-injected-css">
        .immersive-translate-target-wrapper[dir='rtl'] {
            text-align: right;
        }

        .immersive-translate-target-wrapper[dir='rtl'] [data-immersive-translate-class-bak*='block-wrapper'] {
            display: block;
        }

        .immersive-translate-target-wrapper {
            word-break: break-word;
            user-select: text;
        }

        [imt-state="translation"] .immersive-translate-target-wrapper[dir='rtl'] {
            display: inline-block;
        }

        [dir='rtl'] .immersive-translate-target-wrapper:not([dir]) {
            text-align: left;
        }

        [imt-state=dual] .immersive-translate-target-translation-block-wrapper-theme-dividingLine::before {
            display: block;
        }

        [imt-trans-position=before] .immersive-translate-target-translation-block-wrapper {
            display: block !important;
        }

        [imt-state][data-immersive-translate_rtl] .immersive-translate-target-wrapper {
            display: block !important;
        }
    </style>
</head>

<body epub:type="bodymatter" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
    <section aria-labelledby="c17_1" epub:type="chapter" role="doc-chapter"
        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
        <header data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
            <h1 id="c17_1" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1"><span aria-label="440" epub:type="pagebreak" id="Page_440"
                    role="doc-pagebreak"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span><span id="c17"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span><span
                    class="chapterNumber"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">17</span><br /><span
                    class="chapterTitle" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel
                    Programming</span>
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">17 并行编程</font>
                    </font>
                </font>
            </h1>
        </header>
        <section aria-label="chapter opening" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
            <span id="c17-sec-0001" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
            <aside data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                <div class="top hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                    <hr />
                </div>
                <section class="feature3" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                    <h3 data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                        data-immersive-translate-paragraph="1">WHAT'S IN THIS CHAPTER?<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">本章包含什么内容？</font>
                            </font>
                        </font>
                    </h3>
                    <ul class="check2" id="c17-list-0001"
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                        <li id="c17-li-0001" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                            data-immersive-translate-paragraph="1">Understanding multithreading<font
                                class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">理解多线程</font>
                                </font>
                            </font>
                        </li>
                        <li id="c17-li-0002" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                            data-immersive-translate-paragraph="1">Working with the <code
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code>
                            class<font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">使用 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code>
                                        类</font>
                                </font>
                            </font>
                        </li>
                        <li id="c17-li-0003" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                            data-immersive-translate-paragraph="1">Working with tasks<font
                                class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                <font class="notranslate" data-immersive-translate-translation-element-mark="1">  
                                </font>
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">处理任务</font>
                                </font>
                            </font>
                        </li>
                        <li id="c17-li-0004" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                            data-immersive-translate-paragraph="1">Using the Cancellation framework<font
                                class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">使用取消框架</font>
                                </font>
                            </font>
                        </li>
                        <li id="c17-li-0005" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                            data-immersive-translate-paragraph="1">Publish/subscribe with channels<font
                                class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">使用通道进行发布/订阅</font>
                                </font>
                            </font>
                        </li>
                        <li id="c17-li-0006" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                            data-immersive-translate-paragraph="1">Working with timers<font
                                class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                <font class="notranslate" data-immersive-translate-translation-element-mark="1">  
                                </font>
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">使用计时器</font>
                                </font>
                            </font>
                        </li>
                        <li id="c17-li-0007" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                            data-immersive-translate-paragraph="1">Understanding threading issues<font
                                class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">理解线程问题</font>
                                </font>
                            </font>
                        </li>
                        <li id="c17-li-0008" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                            data-immersive-translate-paragraph="1">Using the lock keyword<font
                                class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">使用 lock 关键字</font>
                                </font>
                            </font>
                        </li>
                        <li id="c17-li-0009" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                            data-immersive-translate-paragraph="1">Synchronizing with Monitor<font
                                class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">与 Monitor 同步</font>
                                </font>
                            </font>
                        </li>
                        <li id="c17-li-1009" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                            data-immersive-translate-paragraph="1">Synchronizing with mutexes<font
                                class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">与互斥锁同步</font>
                                </font>
                            </font>
                        </li>
                        <li id="c17-li-0010" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                            data-immersive-translate-paragraph="1">Working with semaphores<font
                                class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                <font class="notranslate" data-immersive-translate-translation-element-mark="1">  
                                </font>
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">使用信号量工作</font>
                                </font>
                            </font>
                        </li>
                        <li id="c17-li-0011" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                            data-immersive-translate-paragraph="1">Using <code
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ManualResetEvent</code>,
                            <code
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">AutoResetEvent</code>,
                            and <code
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CountdownEvent</code>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">使用 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ManualResetEvent</code>
                                        、 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">AutoResetEvent</code>
                                        和 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CountdownEvent</code>
                                    </font>
                                </font>
                            </font>
                        </li>
                        <li id="c17-li-0012" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                            data-immersive-translate-paragraph="1">Working with <code
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Barrier</code>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                <font class="notranslate" data-immersive-translate-translation-element-mark="1">  
                                </font>
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">与 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Barrier</code>
                                        合作</font>
                                </font>
                            </font>
                        </li>
                        <li id="c17-li-0013" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                            data-immersive-translate-paragraph="1">Managing readers and writers with <code
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ReaderWriterLockSlim</code>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">使用 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ReaderWriterLockSlim</code>
                                        管理读写者</font>
                                </font>
                            </font>
                        </li>
                    </ul>
                    <div class="bottom hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                        <hr />
                    </div>
                </section>
            </aside>
            <aside data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                <div class="top hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                    <hr />
                </div>
                <section class="feature3" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><span
                        id="c17-fea-3001" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
                    <h3 id="head-2-145" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                        data-immersive-translate-paragraph="1">CODE DOWNLOADS FOR THIS CHAPTER<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">本章代码下载</font>
                            </font>
                        </font>
                    </h3>
                    <section data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><span
                            id="c17-sec-2003"
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
                        <p id="c17-para-0003" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                            data-immersive-translate-paragraph="1">The source code for this chapter is available on the
                            book page at <code
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><a href="http://www.wiley.com">www.wiley.com</a></code>.
                            Click the Downloads link. The code can also be found at <code
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><a href="https://github.com/ProfessionalCSharp/ProfessionalCSharp2021">https://github.com/ProfessionalCSharp/ProfessionalCSharp2021</a></code>
                            in the directory <code
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">2_Libs/Parallel</code>.
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">本章的源代码可在书籍页面 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><a href="http://www.wiley.com">www.wiley.com</a></code>
                                        上找到。点击下载链接。代码也可以在目录 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">2_Libs/Parallel</code>
                                        中的 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><a href="https://github.com/ProfessionalCSharp/ProfessionalCSharp2021">https://github.com/ProfessionalCSharp/ProfessionalCSharp2021</a></code>
                                        找到。</font>
                                </font>
                            </font>
                        </p>
                        <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                            data-immersive-translate-paragraph="1"><span aria-label="441" epub:type="pagebreak"
                                id="Page_441" role="doc-pagebreak"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>The code
                            for this chapter is divided into the following major examples:<font
                                class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">本章的代码分为以下主要示例：</font>
                                </font>
                            </font>
                        </p>
                        <ul class="check" id="c17-list-0003"
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                            <li id="c17-li-0014" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                                data-immersive-translate-paragraph="1">Parallel<font
                                    class="notranslate immersive-translate-target-wrapper"
                                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  
                                    </font>
                                    <font
                                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                        data-immersive-translate-translation-element-mark="1">
                                        <font
                                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                            data-immersive-translate-translation-element-mark="1">并行</font>
                                    </font>
                                </font>
                            </li>
                            <li id="c17-li-0015" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                                data-immersive-translate-paragraph="1">Task<font
                                    class="notranslate immersive-translate-target-wrapper"
                                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  
                                    </font>
                                    <font
                                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                        data-immersive-translate-translation-element-mark="1">
                                        <font
                                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                            data-immersive-translate-translation-element-mark="1">任务</font>
                                    </font>
                                </font>
                            </li>
                            <li id="c17-li-0016" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                                data-immersive-translate-paragraph="1">Cancellation<font
                                    class="notranslate immersive-translate-target-wrapper"
                                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  
                                    </font>
                                    <font
                                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                        data-immersive-translate-translation-element-mark="1">
                                        <font
                                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                            data-immersive-translate-translation-element-mark="1">取消</font>
                                    </font>
                                </font>
                            </li>
                            <li id="c17-li-0017" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                                data-immersive-translate-paragraph="1">ChannelSample<font
                                    class="notranslate immersive-translate-target-wrapper"
                                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  
                                    </font>
                                    <font
                                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                        data-immersive-translate-translation-element-mark="1">
                                        <font
                                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                            data-immersive-translate-translation-element-mark="1">通道样本</font>
                                    </font>
                                </font>
                            </li>
                            <li id="c17-li-0018" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                                data-immersive-translate-paragraph="1">Timer<font
                                    class="notranslate immersive-translate-target-wrapper"
                                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  
                                    </font>
                                    <font
                                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                        data-immersive-translate-translation-element-mark="1">
                                        <font
                                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                            data-immersive-translate-translation-element-mark="1">计时器</font>
                                    </font>
                                </font>
                            </li>
                            <li id="c17-li-0019" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                                data-immersive-translate-paragraph="1">WinAppTimer</li>
                            <li id="c17-li-0020" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                                data-immersive-translate-paragraph="1">ThreadingIssues<font
                                    class="notranslate immersive-translate-target-wrapper"
                                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  
                                    </font>
                                    <font
                                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                        data-immersive-translate-translation-element-mark="1">
                                        <font
                                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                            data-immersive-translate-translation-element-mark="1">线程问题 </font>
                                    </font>
                                </font>
                            </li>
                            <li id="c17-li-0021" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                                data-immersive-translate-paragraph="1">SynchronizationSamples<font
                                    class="notranslate immersive-translate-target-wrapper"
                                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  
                                    </font>
                                    <font
                                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                        data-immersive-translate-translation-element-mark="1">
                                        <font
                                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                            data-immersive-translate-translation-element-mark="1">同步示例 </font>
                                    </font>
                                </font>
                            </li>
                            <li id="c17-li-0022" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                                data-immersive-translate-paragraph="1">BarrierSample<font
                                    class="notranslate immersive-translate-target-wrapper"
                                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  
                                    </font>
                                    <font
                                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                        data-immersive-translate-translation-element-mark="1">
                                        <font
                                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                            data-immersive-translate-translation-element-mark="1">屏障示例</font>
                                    </font>
                                </font>
                            </li>
                            <li id="c17-li-0023" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                                data-immersive-translate-paragraph="1">ReaderWriterLockSample</li>
                            <li id="c17-li-0024" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                                data-immersive-translate-paragraph="1">LockAcrossAwait<font
                                    class="notranslate immersive-translate-target-wrapper"
                                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  
                                    </font>
                                    <font
                                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                        data-immersive-translate-translation-element-mark="1">
                                        <font
                                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                            data-immersive-translate-translation-element-mark="1">跨 Await 锁 </font>
                                    </font>
                                </font>
                            </li>
                        </ul>
                        <p id="c17-para-0005" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                            data-immersive-translate-paragraph="1">Samples from this chapter make use of the <code
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">System.Threading</code>,
                            <code
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">System.Threading.Tasks</code>,
                            and <code
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">System.Linq</code>
                            namespaces. All the projects have nullable reference types enabled.<font
                                class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">本章示例使用了 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">System.Threading</code>
                                        、 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">System.Threading.Tasks</code>
                                        和 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">System.Linq</code>
                                        命名空间。所有项目都启用了可空引用类型。</font>
                                </font>
                            </font>
                        </p>
                    </section>
                    <div class="bottom hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                        <hr />
                    </div>
                </section>
            </aside>
        </section>
        <section aria-labelledby="head-2-146" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
            <span id="c17-sec-0002" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
            <h2 id="head-2-146" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">OVERVIEW<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">概述</font>
                    </font>
                </font>
            </h2>
            <p id="c17-para-0006" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">There are several reasons for using multiple threads. Suppose you
                are making a network call from an application that might take some time. You don't want to stall the
                user interface and force the user to wait idly until the response is returned from the server. The user
                could perform some other actions in the meantime or even cancel the request that was sent to the server.
                Using threads can help.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            使用多个线程有多个原因。假设你正在从应用程序中发起一个可能需要较长时间的网络调用。你不想让用户界面停滞，迫使用户无所事事地等待服务器返回响应。用户可以在等待期间执行其他操作，甚至取消发送到服务器的请求。使用线程可以帮助解决这个问题。
                        </font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0007" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">For all activities that require a wait—for example, because of
                file, database, or network access—you can start a new thread to fulfill other activities at the same
                time. Even if you have only processing-intensive tasks to do, threading can help. Multiple threads of a
                single process can run on different CPUs, or, nowadays, on different cores of a multiple-core CPU, at
                the same time.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            对于所有需要等待的活动——例如，由于文件、数据库或网络访问——你可以启动一个新线程来同时执行其他活动。即使你只有处理密集型任务，线程也能提供帮助。单个进程的多个线程可以同时运行在不同的
                            CPU 上，或者，在当今，可以在多核 CPU 的不同核心上同时运行。</font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0008" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">You must be aware of some issues when running multiple threads,
                however. Because they can run during the same time, you can easily get into problems if the threads
                access the same data. To avoid that, you must implement synchronization mechanisms.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            然而，在运行多个线程时，你必须注意一些问题。由于它们可以在同一时间运行，如果线程访问相同的数据，你很容易遇到问题。为了避免这种情况，你必须实现同步机制。</font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0009" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">.NET offers an abstraction mechanism for threads: tasks. Tasks
                allow building relations between tasks—for example, one task should continue when the first one is
                completed. You can also build a hierarchy consisting of multiple tasks.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">.NET
                            提供了线程的抽象机制：任务。任务允许建立任务之间的关系——例如，第一个任务完成后，另一个任务应该继续。你也可以构建一个由多个任务组成的层次结构。</font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0010" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">Instead of using tasks, you can implement parallel activities
                using the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code>
                class. You need to differentiate <i
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">data parallelism</i> where
                working with some data is processed simultaneously between different tasks, or <i
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">task parallelism</i> where
                different functions are executed simultaneously.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">除了使用任务，你可以使用 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code>
                            类来实现并行活动。你需要区分数据并行性，其中一些数据在不同任务中同时处理，或任务并行性，其中不同的函数同时执行。</font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0011" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">When creating parallel programs, you have a lot of different
                options. You should use the simplest option that fits your scenario. This chapter starts with the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code> class, which
                offers easy parallelism. If this is all you need, just use this class. If you need more control, such as
                when you need to manage a relation between tasks or to define a method that returns a task, the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code> class is the way
                to go.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            在创建并行程序时，你有许多不同的选择。你应该使用最适合你场景的最简单选项。本章从 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code>
                            类开始，它提供了简单的并行功能。如果你只需要这些功能，就直接使用这个类。如果你需要更多控制，例如当你需要管理任务之间的关系或定义一个返回任务的方法时， <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                            类是最佳选择。</font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0012" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">This chapter also covers the data flow library, which might be
                the easiest one to use if you need actor-based programming to flow data through pipelines.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            本章还涵盖了数据流库，如果你需要基于角色的编程来通过管道流动数据，这可能是最容易使用的库。</font>
                    </font>
                </font>
            </p>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">If you need even more control over parallelism, such as setting
                priorities, the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Thread</code> class might be
                the one to use.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">如果你需要更多对并行的控制，例如设置优先级， <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Thread</code>
                            类可能是你要使用的类。</font>
                    </font>
                </font><span aria-label="442" epub:type="pagebreak" id="Page_442" role="doc-pagebreak"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span></p>
            <aside data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                <div class="top hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                    <hr />
                </div>
                <section class="feature2" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                    <p id="c17-para-0014" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                        data-immersive-translate-paragraph="1"><b
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">NOTE</b> <i
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">The use of
                            asynchronous methods with the async and await keywords is covered in <a href="c11.xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Chapter 11</a>,
                            “Tasks and Asynchronous Programming.”</i>
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">注意：使用 async 和 await
                                    关键字与异步方法的使用在《任务和异步编程》第 11 章中介绍。</font>
                            </font>
                        </font>
                    </p>
                    <p id="c17-para-0015" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><i
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                            data-immersive-translate-paragraph="1">One variant of task parallelism is offered by
                            Parallel LINQ, which is covered in <a href="c09.xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Chapter 9</a>,
                            “Language Integrated Query.”<font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">任务并行的一种变体是并行 LINQ，它在第 9
                                        章“语言集成查询”中有所介绍。</font>
                                </font>
                            </font></i></p>
                    <div class="bottom hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                        <hr />
                    </div>
                </section>
            </aside>
            <p id="c17-para-0016" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">Creating a program that runs multiple tasks in parallel can lead
                to race conditions and deadlocks. You need to be aware of synchronization techniques.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            创建一个在并行中运行多个任务的程序可能导致竞争条件和死锁。你需要了解同步技术。</font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0017" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">It is best when you can avoid synchronization by not sharing data
                between threads. Of course, this is not always possible. If data sharing is necessary, you must use
                synchronization so that only one task at a time accesses and changes the shared state. If you don't pay
                attention to synchronization, race conditions and deadlocks can apply. A big issue with race conditions
                and deadlocks is that errors occur inconsistently and behave differently with release and debug builds.
                With a higher number of CPU cores, error numbers can increase. Such errors usually are hard to find. So,
                it's best to pay attention to synchronization from the beginning. In the section “Threading Issues,”
                you'll see samples for race conditions and deadlocks.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            当你能够通过不在线程之间共享数据来避免同步时，这是最好的。当然，这并不总是可能的。如果需要共享数据，你必须使用同步，以便一次只有一个任务访问和修改共享状态。如果你不注意同步，竞争条件和死锁就会发生。竞争条件和死锁的一个大问题是错误发生不一致，并且在发布版本和调试版本中的行为不同。随着
                            CPU 核心数量的增加，错误数量可能会增加。这类错误通常很难找到。因此，最好从一开始就注意同步。在“线程问题”部分，你会看到关于竞争条件和死锁的示例。</font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0018" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">Using multiple tasks is easy if the tasks don't access the same
                variables. You can avoid this situation to a certain degree, but at some point, you will find some data
                needs to be shared. When sharing data, you need to apply synchronization techniques. When threads access
                the same data and you don't apply synchronization, you are lucky when the problem pops up immediately.
                However, this is rarely the case. This chapter shows race conditions and deadlocks and how you can avoid
                them by applying synchronization mechanisms.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            如果任务不访问相同的变量，使用多个任务很简单。你可以在一定程度上避免这种情况，但总有一天你会发现某些数据需要共享。当共享数据时，你需要应用同步技术。当线程访问相同的数据而你未应用同步时，如果问题立即出现，你算是幸运的。然而这种情况很少发生。本章将展示竞态条件和死锁，以及如何通过应用同步机制来避免它们。
                        </font>
                    </font>
                </font>
            </p>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">.NET offers several options for synchronization. You can use
                synchronization objects within a process or across processes. You can use them to synchronize one task
                or multiple tasks to access one or more resources. Synchronization objects can also be used to inform
                tasks that something completed. All these synchronization objects are covered in this chapter.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">.NET
                            提供了多种同步选项。你可以在进程内部或跨进程使用同步对象。你可以使用它们来同步单个任务或多个任务访问一个或多个资源。同步对象也可以用来通知任务某项工作已完成。本章涵盖了所有这些同步对象。
                        </font>
                    </font>
                </font>
            </p>
            <aside data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                <div class="top hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                    <hr />
                </div>
                <section class="feature2" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                    <p id="c17-para-0020" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                        data-immersive-translate-paragraph="1"><b
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">NOTE</b> <i
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">The need for
                            synchronization can be partly avoided by using immutable data structures as much as
                            possible. With immutable data structures, the data can be initialized but cannot be changed
                            afterward. That's why synchronization is not needed with these types.</i>
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">注意
                                    通过尽可能多地使用不可变数据结构，可以部分避免同步的需求。使用不可变数据结构时，数据可以被初始化但之后不能被更改。这就是为什么这些类型不需要同步的原因。</font>
                            </font>
                        </font>
                    </p>
                    <div class="bottom hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                        <hr />
                    </div>
                </section>
            </aside>
            <p id="c17-para-0021" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">Now that we're grounded in the basics of multithreading and
                tasks, let's start with the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code> class—an
                uncomplicated way to add parallelism to your application.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">现在我们已经掌握了多线程和任务的基础知识，让我们开始学习 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code>
                            类——一种向应用程序添加并行性的简单方法。</font>
                    </font>
                </font>
            </p>
        </section>
        <section aria-labelledby="head-2-147" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
            <span id="c17-sec-0005" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
            <h2 id="head-2-147" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">PARALLEL CLASS<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">并行类 </font>
                    </font>
                </font>
            </h2>
            <p id="c17-para-0022" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">One great abstraction of threads is the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code> class. With
                this class, both data and task parallelism are offered. This class is in the namespace <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">System.Threading.Tasks</code>.
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">线程的一个很好的抽象是 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code>
                            类。使用这个类，数据并行和任务并行都可以实现。这个类在 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">System.Threading.Tasks</code>
                            命名空间中。</font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0023" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">The <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code> class defines
                static methods for a parallel <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">for</code> and <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">foreach</code>. With the C#
                statements <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">for</code> and
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">foreach</code>, the loop is
                run from one thread. The <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code> class uses
                multiple tasks and, thus, multiple threads for this job.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1"> <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code>
                            类为并行 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">for</code> 和
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">foreach</code>
                            定义了静态方法。使用 C# 语句 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">for</code> 和
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">foreach</code>
                            ，循环由一个线程运行。 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code>
                            类使用多个任务，因此使用多个线程来完成这项工作。</font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0024" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">Whereas the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.For</code> and <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.ForEach</code>
                methods invoke the same code during each iteration, <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.Invoke</code>
                enables you to invoke different methods concurrently. <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.Invoke</code> is for
                task parallelism, and <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.ForEach</code> is
                for data parallelism.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">而 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.For</code>
                            和 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.ForEach</code>
                            方法在每次迭代中调用相同的代码， <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.Invoke</code>
                            则允许你并发调用不同的方法。 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.Invoke</code>
                            用于任务并行， <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.ForEach</code>
                            用于数据并行。</font>
                    </font>
                </font>
            </p> <span aria-label="443" epub:type="pagebreak" id="Page_443" role="doc-pagebreak"
                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
            <section data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><span id="c17-sec-0006"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
                <h3 id="head-3-306" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Looping with the Parallel.For Method <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用 Parallel.For 方法进行循环</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">The <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.For</code>
                    method is like the C# <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">for</code> loop statement
                    for performing a task a number of times. With <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.For</code>, the
                    iterations run in parallel. The order of iteration is not defined.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.For</code>
                                方法类似于 C# 的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">for</code>
                                循环语句，用于执行多次任务。使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.For</code>
                                ，迭代将并行运行。迭代顺序未定义。</font>
                        </font>
                    </font>
                </p>
                <aside data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                    <div class="top hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                        <p id="c17-para-0026" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">NOTE</b> <i
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">This sample makes
                                use of command-line arguments. To work through the different features, pass different
                                arguments as shown on startup of the sample application or check the top-level
                                statements. From Visual Studio, you can pass command-line arguments in the Debug options
                                of the project properties. Using the </i><code
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">dotnet</code><i
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"> command line, to
                                pass the command-line argument </i><code
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">-p</code><i
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">, you can start
                                the command </i><code
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">dotnet run -- -p</code><i
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">
                                        注意：此示例使用命令行参数。要体验不同的功能，可以在启动示例应用程序时传递不同的参数，或检查顶层语句。从 Visual
                                        Studio，你可以在项目属性的调试选项中传递命令行参数。使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">dotnet</code>
                                        命令行来传递命令行参数 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">-p</code>
                                        ，可以启动命令 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">dotnet run -- -p</code>
                                        。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                            <hr />
                        </div>
                    </section>
                </aside>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">To get the information about the thread and the task, the
                    following <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Log</code>
                    method writes thread and task identifiers to the console (code file <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/ParallelSamples/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">为了获取线程和任务的信息，以下 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Log</code>
                                方法将线程和任务标识符写入控制台（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/ParallelSamples/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0001"><code>public static void Log(string prefix) =&gt;</code>
<code>  Console.WriteLine($"{prefix}, task: {Task.CurrentId}, " +</code>
<code>    $"thread: {Thread.CurrentThread.ManagedThreadId}");</code></pre>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Let's look at the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.For</code>
                    method. With this method, the first two parameters define the start and end of the loop. The
                    following example has the iterations from 0 to 9. The third parameter is an <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Action&lt;int&gt;</code>
                    delegate. The integer parameter is the iteration of the loop that is passed to the method referenced
                    by the delegate. The return type of <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.For</code> is
                    the struct <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelLoopResult</code>,
                    which provides information if the loop is completed:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">让我们看看 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.For</code>
                                方法。使用这个方法，前两个参数定义了循环的开始和结束。以下示例的迭代范围是从 0 到 9。第三个参数是一个 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Action&lt;int&gt;</code>
                                委托。整数参数是循环的迭代次数，它会被传递给委托所引用的方法。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.For</code>
                                的返回类型是结构体 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelLoopResult</code>
                                ，它提供了关于循环是否完成的信息：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0002"><code>public static void ParallelFor()</code>
<code>{</code>
<code>  <b>ParallelLoopResult result =</b></code>
<code>    <b>Parallel.For(0, 10, i =&gt;</b></code>
<code>    <b>{</b></code>
<code>      Log($"S {i}");</code>
<code>      Task.Delay(10).Wait();</code>
<code>      Log($"E {i}");</code>
<code>    <b>});</b></code>
<code>  Console.WriteLine($"Is completed: {result.IsCompleted}");</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">In the body of <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.For</code>, the
                    index, task identifier, and thread identifier are written to the console. As shown in the following
                    output, the order is not guaranteed. You will see different results if you run this program once
                    more. This run of the program had the order 1-7-2-0-3 and so on with 10 tasks and 10 threads. A task
                    does not necessarily map to one thread; a thread can be reused by different tasks.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.For</code>
                                的主体中，索引、任务标识符和线程标识符被写入控制台。如以下输出所示，顺序是不确定的。如果你再次运行这个程序，你会看到不同的结果。这次运行的程序顺序是 1-7-2-0-3 等，有
                                10 个任务和 10 个线程。任务不一定映射到一个线程；一个线程可以被不同的任务重用。</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0003"><code>S 1 task: 1, thread: 4</code>
<code>S 7 task: 8, thread: 10</code>
<code>S 2 task: 2, thread: 5</code>
<code>S 0 task: 3, thread: 1</code>
<code>S 3 task: 4, thread: 6</code>
<code>S 4 task: 5, thread: 7</code>
<code>S 5 task: 6, thread: 9</code>
<code>S 6 task: 7, thread: 8</code>
<code>S 8 task: 9, thread: 11</code>
<code>E 1 task: 1, thread: 4</code>
<code>E 6 task: 7, thread: 8</code>
<code>E 3 task: 4, thread: 6<span aria-label="444" epub:type="pagebreak" id="Page_444" role="doc-pagebreak"></span></code>
<code>E 8 task: 9, thread: 11</code>
<code>E 0 task: 3, thread: 1</code>
<code>E 5 task: 6, thread: 9</code>
<code>E 4 task: 5, thread: 7</code>
<code>E 2 task: 2, thread: 5</code>
<code>S 9 task: 10, thread: 12</code>
<code>E 7 task: 8, thread: 10</code>
<code>E 9 task: 10, thread: 12</code>
<code>Is completed: True</code></pre>
                <p id="c17-para-0030" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">The delay within the parallel body waits for 10 milliseconds
                    to have a better chance to create new threads. If you remove this line, you see fewer threads and
                    tasks to be used.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在并行主体中的延迟等待 10
                                毫秒，以便有更好的机会创建新线程。如果你删除这一行，你会看到使用的线程和任务更少。</font>
                        </font>
                    </font>
                </p>
                <p id="c17-para-0031" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">What you can also see with the result is that every end log
                    of a loop uses the same thread and task as the start log. Using <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task.Delay</code> with
                    the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Wait</code> method
                    blocks the current thread until the delay ends.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                你还可以从结果中看到，每个循环的结束日志都使用了与开始日志相同的线程和任务。使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task.Delay</code>
                                与 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Wait</code>
                                方法会阻塞当前线程，直到延迟结束。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Change the previous example to now use the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">await</code> keyword with
                    the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task.Delay</code>
                    method (code file <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/ParallelSamples/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">将前面的示例改为现在使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">await</code>
                                关键字与 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task.Delay</code>
                                方法（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/ParallelSamples/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0004"><code>public static void ParallelForWithAsync()</code>
<code>{</code>
<code>  ParallelLoopResult result =</code>
<code>    Parallel.For(0, 10, <b>async</b> i =&gt;</code>
<code>    {</code>
<code>      Log($"S {i}");</code>
<code>      <b>await Task.Delay(10);</b></code>
<code>      Log($"E {i}");</code>
<code>    });</code>
<code>  Console.WriteLine($"is completed: {result.IsCompleted}");</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">The result is in the following console output snippet. With
                    the output after the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Thread.Delay</code>
                    method, you can see the thread change. For example, loop iteration 1, which had thread ID 4 before
                    the delay, has thread ID 7 after the delay. You can also see that tasks no longer exist—there are
                    only threads—and here previous threads are reused. Another important aspect is that the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">For</code> method of the
                    <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code> class
                    is completed without waiting for the delay. The <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code> class
                    waits for the tasks it created, but it doesn't wait for other background activity. It is also
                    possible that you won't see the output from the methods after the delay at all—if the main thread
                    (which is a foreground thread) is finished, all the background threads are stopped.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">结果在以下控制台输出片段中。使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Thread.Delay</code>
                                方法后的输出，你可以看到线程的变化。例如，在延迟之前具有线程 ID 4 的循环迭代 1，在延迟后具有线程 ID
                                7。你也可以看到任务不再存在——只有线程——并且之前的线程被重复使用。另一个重要方面是 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code>
                                类的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">For</code>
                                方法在等待延迟完成之前就完成了。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code>
                                类等待它创建的任务，但它不等待其他后台活动。也有可能你完全看不到延迟后的方法输出——如果主线程（这是一个前台线程）已经完成，所有后台线程都会停止。</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0005"><code>S 3 task: 1, thread: 6</code>
<code>S 1 task: 6, thread: 4</code>
<code>S 2 task: 8, thread: 5</code>
<code>S 0 task: 4, thread: 1</code>
<code>S 7 task: 5, thread: 11</code>
<code>S 8 task: 2, thread: 10</code>
<code>S 4 task: 7, thread: 8</code>
<code>S 6 task: 9, thread: 9</code>
<code>S 5 task: 3, thread: 7</code>
<code>S 9 task: 1, thread: 6</code>
<code>Is completed: True</code>
<code>E 5 task: , thread: 11</code>
<code>E 8 task: , thread: 7</code>
<code>E 1 task: , thread: 7</code>
<code>E 4 task: , thread: 8</code>
<code>E 0 task: , thread: 6</code>
<code>E 6 task: , thread: 5</code>
<code>E 2 task: , thread: 10<span aria-label="445" epub:type="pagebreak" id="Page_445" role="doc-pagebreak"></span></code>
<code>E 9 task: , thread: 4</code>
<code>E 7 task: , thread: 11</code>
<code>E 3 task: , thread: 9</code></pre>
                <aside data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                    <div class="top hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                        <p id="c17-para-0035" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WARNING</b> <i
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">As demonstrated
                                here, although using async features with .NET and C# is easy, it's still important to
                                know what's happening behind the scenes, and you have to pay attention to some
                                issues.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">警告 如本例所示，虽然使用.NET 和
                                        C#的异步功能很方便，但了解背后发生的事情仍然很重要，你需要注意一些问题。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                            <hr />
                        </div>
                    </section>
                </aside>
            </section>
            <section data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><span id="c17-sec-0009"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
                <h3 id="head-3-307" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Stopping Parallel.For Early <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">提前停止 Parallel.For</font>
                        </font>
                    </font>
                </h3>
                <p id="c17-para-0036" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">You can also break <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.For</code> early
                    without looping through all the iterations. A method overload of the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">For</code> method accepts
                    a third parameter of type <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Action&lt;int, ParallelLoopState&gt;</code>.
                    By defining a method with these parameters, you can influence the outcome of the loop by invoking
                    the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Break</code> or
                    <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Stop</code> method of
                    the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelLoopState</code>.
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">你也可以在不遍历所有迭代的情况下提前终止。 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">For</code>
                                方法的另一个重载版本接受一个类型为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Action&lt;int, ParallelLoopState&gt;</code>
                                的第三个参数。通过定义具有这些参数的方法，你可以通过调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelLoopState</code>
                                的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Break</code>
                                或 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Stop</code>
                                方法来影响循环的结果。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Remember, the order of iterations is not defined (code file
                    <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/ParallelSamples/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">记住，迭代的顺序是未定义的（代码文件 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/ParallelSamples/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0006"><code>public static void StopParallelForEarly()</code>
<code>{</code>
<code>  ParallelLoopResult result =</code>
<code>    Parallel.For(10, 40, (int i, <b>ParallelLoopState pls</b>) =&gt;</code>
<code>    {</code>
<code>      Log($"S {i}");</code>
<code>      if (i&gt; 12)</code>
<code>      {</code>
<code>        <b>pls.Break();</b></code>
<code>        Log($"break now… {i}");</code>
<code>      }</code>
<code>      Task.Delay(10).Wait();</code>
<code>      Log($"E {i}");</code>
<code>    });</code>
<code>  Console.WriteLine($"Is completed: {result.IsCompleted}");</code>
<code>  Console.WriteLine($"lowest break iteration: {result.LowestBreakIteration}");</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">This run of the application demonstrates that the iteration
                    breaks up with a value higher than 12, but other tasks can simultaneously run, and tasks with other
                    values can run. All the tasks that have been started before the break can continue to the end. You
                    can use the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">LowestBreakIteration</code>
                    property to ignore results from tasks that you do not need:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">这个应用程序的运行演示了迭代会以高于 12
                                的值中断，但其他任务可以同时运行，其他值的任务也可以运行。在中断之前已启动的所有任务都可以继续到结束。你可以使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">LowestBreakIteration</code>
                                属性来忽略你不需要的任务的结果：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0007"><code>S 10 task: 1, thread: 1</code>
<code>S 22 task: 5, thread: 8</code>
<code>S 34 task: 9, thread: 11</code>
<code>break now 34 task: 9, thread: 11</code>
<code>S 13 task: 2, thread: 4</code>
<code>break now 13 task: 2, thread: 4</code>
<code>S 28 task: 7, thread: 9</code>
<code>break now 28 task: 7, thread: 9</code>
<code>S 16 task: 3, thread: 5</code>
<code>break now 16 task: 3, thread: 5</code>
<code>S 19 task: 4, thread: 6</code>
<code>break now 19 task: 4, thread: 6</code>
<code>S 31 task: 8, thread: 10<span aria-label="446" epub:type="pagebreak" id="Page_446" role="doc-pagebreak"></span></code>
<code>break now 31 task: 8, thread: 10</code>
<code>S 25 task: 6, thread: 7</code>
<code>break now 25 task: 6, thread: 7</code>
<code>break now 22 task: 5, thread: 8</code>
<code>E 28 task: 7, thread: 9</code>
<code>S 11 task: 10, thread: 12</code>
<code>E 10 task: 1, thread: 1</code>
<code>S 12 task: 1, thread: 1</code>
<code>E 31 task: 8, thread: 10</code>
<code>E 13 task: 2, thread: 4</code>
<code>E 34 task: 9, thread: 11</code>
<code>E 25 task: 6, thread: 7</code>
<code>E 19 task: 4, thread: 6</code>
<code>E 16 task: 3, thread: 5</code>
<code>E 22 task: 5, thread: 8</code>
<code>E 11 task: 10, thread: 12</code>
<code>E 12 task: 1, thread: 1</code>
<code>Is completed: False</code>
<code>lowest break iteration: 13</code></pre>
            </section>
            <section data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><span id="c17-sec-0010"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
                <h3 id="head-3-308" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Parallel.For Initialization <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">并行 For 初始化</font>
                        </font>
                    </font>
                </h3>
                <p id="c17-para-0039" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1"><code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.For</code> might
                    use several threads to do the loops. If you need an initialization that should be done with every
                    thread, you can use the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.For&lt;TLocal&gt;</code>
                    method. The generic version of the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">For</code> method
                    accepts—in addition to the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">from</code> and <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">to</code> values—three
                    delegate parameters. The first parameter is of type <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Func&lt;TLocal&gt;</code>.
                    Because the example here uses a <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">string</code> for <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TLocal</code>, the method
                    needs to be defined as <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Func&lt;string&gt;</code>,
                    a method returning a <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">string</code>. This
                    method is invoked only once for each thread that is used to do the iterations.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.For</code>
                                可能会使用多个线程来执行循环。如果你需要一个应该由每个线程执行的初始化，你可以使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.For&lt;TLocal&gt;</code>
                                方法。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">For</code>
                                方法的泛型版本除了接受 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">from</code> 和
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">to</code>
                                值外，还接受三个委托参数。第一个参数的类型是 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Func&lt;TLocal&gt;</code>
                                。由于这里的示例使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">string</code>
                                作为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TLocal</code>
                                ，因此该方法需要定义为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Func&lt;string&gt;</code>
                                ，即返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">string</code>
                                的方法。这个方法只为每个用于执行迭代的线程被调用一次。</font>
                        </font>
                    </font>
                </p>
                <p id="c17-para-0040" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">The second delegate parameter defines the delegate for the
                    body. In the example, the parameter is of type <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Func&lt;int, ParallelLoopState, string, string&gt;</code>.
                    The first parameter is the loop iteration; the second parameter, <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelLoopState</code>,
                    enables stopping the loop, as shown earlier. With the third parameter, the body method receives the
                    value that is returned from the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">init</code> method. The
                    body method also needs to return a value of the type that was defined with the generic <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">For</code> parameter.
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">第二个委托参数定义了主体部分。在示例中，该参数的类型为 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Func&lt;int, ParallelLoopState, string, string&gt;</code>
                                。第一个参数是循环迭代；第二个参数 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelLoopState</code>
                                可以用于停止循环，如前所述。通过第三个参数，主体方法接收从 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">init</code>
                                方法返回的值。主体方法还需要返回一个类型，该类型由泛型 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">For</code>
                                参数定义。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">The last parameter of the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">For</code> method
                    specifies a delegate, <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Action&lt;TLocal&gt;</code>
                    ; in the example, a string is received. This method, a thread exit method, is called only once for
                    each thread (code file <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/ParallelSamples/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">For</code>
                                方法的最后一个参数指定一个委托 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Action&lt;TLocal&gt;</code>
                                ；在示例中，接收一个字符串。这个方法是一个线程退出方法，每个线程只调用一次（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/ParallelSamples/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0008"><code>public static void ParallelForWithInit()</code>
<code>{</code>
<code>  Parallel.For&lt;string&gt;(0, 10, () =&gt;</code>
<code>  {</code>
<code>    // invoked once for each thread</code>
<code>    Log($"init thread");</code>
<code>    return $"t{Thread.CurrentThread.ManagedThreadId}";</code>
<code>  },</code>
<code>  (i, pls, str1) =&gt;</code>
<code>  {</code>
<code>    // invoked for each member</code>
<code>    Log($"body i {i} str1 {str1}");</code>
<code>    Task.Delay(10).Wait();</code>
<code>    return $"i {i}";</code>
<code>  },</code>
<code>  (str1) =&gt;<span aria-label="447" epub:type="pagebreak" id="Page_447" role="doc-pagebreak"></span></code>
<code>  {</code>
<code>    // final action on each thread</code>
<code>    Log($"finally {str1}");</code>
<code>  });</code>
<code>}</code></pre>
                <p id="c17-para-0042" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">When you run the application with the option <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">-pfi</code>, you can see
                    that the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">init</code>
                    method is called only once for each thread; the body of the loop receives the first string from the
                    initialization and passes this string to the next iteration of the body with the same thread.
                    Lastly, the final action is invoked once for each thread and receives the last result from
                    everybody.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">当您使用选项 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">-pfi</code>
                                运行应用程序时，可以看到 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">init</code>
                                方法每个线程只调用一次；循环的主体接收从初始化的第一个字符串，并将该字符串传递给使用相同线程的下一个主体迭代。最后，最终操作每个线程调用一次，并接收每个主体的最后一个结果。
                            </font>
                        </font>
                    </font>
                </p>
                <p id="c17-para-0043" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">With this functionality, this method fits perfectly to
                    accumulate a result of a huge data collection.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">凭借这项功能，该方法非常适合累积大量数据集合的结果。</font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><span id="c17-sec-0011"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
                <h3 id="head-3-309" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Looping with the Parallel.ForEach Method<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用 Parallel.ForEach 方法进行循环</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">
                    <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.ForEach</code>
                    iterates through a collection implementing <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">IEnumerable</code> in a
                    similar way to the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">foreach</code> statement
                    but in an asynchronous manner. Again, the order is not guaranteed (code file <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/ParallelSamples/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.ForEach</code>
                                以异步方式遍历实现 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">IEnumerable</code>
                                的集合，类似于 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">foreach</code>
                                语句，但顺序不保证（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/ParallelSamples/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0009"><code>public static void ParallelForEach()</code>
<code>{</code>
<code>  string[] data = {"zero", "one", "two", "three", "four", "five",</code>
<code>  "six", "seven", "eight", "nine", "ten", "eleven", "twelve"};</code>
<code>  <b>ParallelLoopResult result =</b></code>
<code>    <b>Parallel.ForEach&lt;string&gt;(data, s =&gt;</b></code>
<code>    <b>{</b></code>
<code>      Console.WriteLine(s);</code>
<code>    <b>});</b></code>
<code>}</code></pre>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">If you need to break up the loop, you can use an overload of
                    the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ForEach</code>
                    method with a <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelLoopState</code>
                    parameter. You can do this in the same way you did earlier with the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">For</code> method. An
                    overload of the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ForEach</code> method can
                    also be used to access an indexer to get the iteration number, as shown here:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">如果需要中断循环，可以使用带 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelLoopState</code>
                                参数的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ForEach</code>
                                方法重载。你可以像之前使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">For</code>
                                方法那样这样做。也可以使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ForEach</code>
                                方法重载来访问索引器以获取迭代次数，如下所示：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0010"><code>Parallel.ForEach&lt;string&gt;(data, (s, pls, l) =&gt;</code>
<code>{</code>
<code>  Console.WriteLine($"{s} {l}");</code>
<code>});</code></pre>
            </section>
            <section data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><span id="c17-sec-0012"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
                <h3 id="head-3-310" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Invoking Multiple Methods with the Parallel.Invoke Method
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用 Parallel.Invoke 方法调用多个方法</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">If multiple tasks should run in parallel, you can use the
                    <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.Invoke</code>
                    method, which offers the task parallelism pattern. <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.Invoke</code>
                    allows the passing of an array of <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Action</code> delegates,
                    whereby you can assign methods that should run. The example code passes the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Foo</code> and <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Bar</code> methods to be
                    invoked in parallel (code file <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">如果多个任务需要并行运行，你可以使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.Invoke</code>
                                方法，该方法提供了任务并行模式。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.Invoke</code>
                                允许传递一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Action</code>
                                委托数组，你可以在其中分配需要运行的方法。示例代码将 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Foo</code> 和
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Bar</code>
                                方法传递给并行调用（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0011"><code>public static void ParallelInvoke()</code>
<code>{</code>
<code>  <b>Parallel.Invoke(Foo, Bar, Foo, Bar, Foo, Bar);</b></code>
<code>}</code>
<code> </code>
<code>public static void Foo() =&gt;</code>
<code>  Console.WriteLine("foo");</code>
<code> </code>
<code>public static void Bar() =&gt;</code>
<code>  Console.WriteLine("bar");</code></pre>
                <p id="c17-para-0047" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1"><span aria-label="448" epub:type="pagebreak" id="Page_448"
                        role="doc-pagebreak"
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>When you run the
                    application multiple times and invoke the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.Invoke</code>
                    method, you'll see the order of invocations is not always the same.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">当你多次运行应用程序并调用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.Invoke</code>
                                方法时，你会发现调用的顺序并不总是相同的。</font>
                        </font>
                    </font>
                </p>
                <p id="c17-para-0048" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">The <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code> class is
                    easy to use—for both task and data parallelism. If more control is needed and you don't want to wait
                    until the action started with the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code> class is
                    completed, the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code> class comes
                    in handy. Of course, it's also possible to combine the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code> and <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code> classes.
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code>
                                类易于使用——无论是任务并行还是数据并行。如果你需要更多控制且不想等待使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code>
                                类启动的操作完成， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                                类就很有用。当然，也可以结合使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code> 和
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code>
                                类。</font>
                        </font>
                    </font>
                </p>
            </section>
        </section>
        <section aria-labelledby="head-2-148" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
            <span id="c17-sec-0013" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
            <h2 id="head-2-148" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">TASKS<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">任务</font>
                    </font>
                </font>
            </h2>
            <p id="c17-para-0049" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">For more control over the parallel actions, you can use the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code> class from the
                namespace <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">System.Threading.Tasks</code>.
                A <i data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">task</i> represents some
                unit of work that should be done. This unit of work can run in a separate thread, and it is also
                possible to start a task in a synchronized manner, which results in a wait for the calling thread. With
                tasks, you have an abstraction layer but also a lot of control over the underlying threads.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">为了对并行操作有更多控制，你可以使用来自命名空间 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">System.Threading.Tasks</code>
                            的 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                            类。任务代表一些应该完成的操作单元。这个操作单元可以在单独的线程中运行，并且也可以以同步方式启动任务，这会导致调用线程等待。使用任务，你有一个抽象层，同时也对底层线程有很强的控制力。
                        </font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0050" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">Tasks provide much more flexibility in organizing the work you
                need to do. For example, you can define continuation work—what should be done after a task is complete.
                This can be differentiated based on whether the task was successful. You can also organize tasks in a
                hierarchy. For example, a parent task can create new children tasks. Optionally, this can create a
                dependency, so canceling a parent task also cancels its child tasks.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            任务在组织你需要完成的工作方面提供了更多的灵活性。例如，你可以定义后续工作——任务完成后应该做什么。这可以根据任务是否成功来区分。你也可以以层次结构的方式组织任务。例如，一个父任务可以创建新的子任务。可选地，这可以创建依赖关系，因此取消父任务也会取消其子任务。
                        </font>
                    </font>
                </font>
            </p>
            <section data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><span id="c17-sec-0014"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
                <h3 id="head-3-311" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Starting Tasks <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">启动任务</font>
                        </font>
                    </font>
                </h3>
                <p id="c17-para-0051" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">To start a task, you can use either <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskFactory</code> or the
                    constructor of the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code> and the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Start</code> method. The
                    <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code> constructor
                    gives you more flexibility in creating the task.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">要启动任务，您可以使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskFactory</code>
                                、 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                                的构造函数或 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Start</code>
                                方法。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                                构造函数在创建任务时提供了更高的灵活性。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">When starting a task, an instance of the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code> class can be
                    created, and the code that should run can be assigned with an <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Action</code> or <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Action&lt;object&gt;</code>
                    delegate, with either no parameters or one object parameter. In the following example, a method is
                    defined with one parameter: <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskMethod</code>. The
                    implementation invokes the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Log</code> method where
                    the ID of the task and the ID of the thread are written to the console, as well as information
                    indicating whether the thread is coming from a thread pool and whether the thread is a background
                    thread. Writing multiple messages to the console is synchronized by using the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code> keyword with
                    the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">s_logLock</code>
                    synchronization object (for synchronization, you can use any reference-type object). This way,
                    parallel calls to <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Log</code> can be done,
                    and multiple writes to the console are not interleaving each other. Otherwise, the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">title</code> could be
                    written by one task, and the thread information that follows by another task (code file <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/TaskSamples/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">启动任务时，可以创建 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                                类的实例，并将应运行的代码分配给 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Action</code>
                                或 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Action&lt;object&gt;</code>
                                委托，不带参数或带一个对象参数。在以下示例中，定义了一个带有一个参数的方法： <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskMethod</code>
                                。实现中调用了 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Log</code>
                                方法，将任务 ID 和线程 ID 写入控制台，以及指示线程是否来自线程池以及是否为后台线程的信息。通过使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code>
                                关键字和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">s_logLock</code>
                                同步对象（对于同步，您可以使用任何引用类型对象），将多个消息写入控制台进行同步。这样，可以并行调用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Log</code>
                                ，并且多个写入控制台的操作不会相互交错。否则， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">title</code>
                                可能会被一个任务写入，而线程信息则由另一个任务写入（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/TaskSamples/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0012"><code>public static void TaskMethod(object? o)</code>
<code>{</code>
<code>  Log(o?.ToString() ?? string.Empty);</code>
<code>}</code>
<code> </code>
<code>private static readonly object s_logLock = new();</code>
<code>public static void Log(string title)</code>
<code>{</code>
<code>  lock (s_logLock)</code>
<code>  {</code>
<code>    Console.WriteLine(title);</code>
<code>    Console.WriteLine($"Task id: {Task.CurrentId?.ToString() ?? "no task"}, " +</code>
<code>      $"thread: {Thread.CurrentThread.ManagedThreadId}");</code>
<code>    Console.WriteLine($"is pooled thread: " +  </code>
<code>      $"{Thread.CurrentThread.IsThreadPoolThread}");</code>
<code>    Console.WriteLine($"is background thread: " +  </code>
<code>      $"{Thread.CurrentThread.IsBackground}");</code>
<code>    Console.WriteLine();</code>
<code>  }</code>
<code>}</code></pre>
                <p id="c17-para-0053" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">The following sections describe different ways to start a new
                    task.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">以下部分将描述启动新任务的不同方法。</font>
                        </font>
                    </font>
                </p> <span aria-label="449" epub:type="pagebreak" id="Page_449" role="doc-pagebreak"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
                <section data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><span id="c17-sec-0015"
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
                    <h4 id="head-4-50" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                        data-immersive-translate-paragraph="1">Tasks Using the Thread Pool<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">使用线程池的任务</font>
                            </font>
                        </font>
                    </h4>
                    <p id="c17-para-0054" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                        data-immersive-translate-paragraph="1">In this section, diverse ways are shown to start a task
                        that uses a thread from the thread pool. The thread pool offers a pool of background threads.
                        The thread pool manages threads on its own, increasing or decreasing the number of threads
                        within the pool as needed. Threads from the pool are used to fulfill some actions and returned
                        to the pool afterward.<font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">
                                    在这一节中，展示了多种启动使用线程池中的线程的任务的方法。线程池提供了一组后台线程。线程池自行管理线程，根据需要增加或减少池中的线程数量。池中的线程用于执行某些操作，之后返回到池中。
                                </font>
                            </font>
                        </font>
                    </p>
                    <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                        data-immersive-translate-paragraph="1">The first way to create a task is with an instantiated
                        <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskFactory</code>,
                        where the method <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskMethod</code> is
                        passed to the <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">StartNew</code>
                        method, and the task is immediately started. The second approach uses the static <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Factory</code>
                        property of the <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code> class to
                        get access to the <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskFactory</code>
                        and to invoke the <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">StartNew</code>
                        method. This is similar to the first version in that it uses a factory, but there's less control
                        over factory creation. The third approach uses the constructor of the <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code> class.
                        When the <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code> object is
                        instantiated, the task does not run immediately. Instead, it is given the status <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Created</code>. The
                        task is then started by calling the <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Start</code> method
                        of the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                        class. The fourth approach calls the <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Run</code> method of
                        the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                        that immediately starts the task. The <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Run</code> method
                        doesn't have an overloaded variant to pass an <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Action&lt;object&gt;</code>
                        delegate, but it's easy to simulate this by assigning a lambda expression of type <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Action</code> and
                        using the parameter within its implementation (code file <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/TaskSamples/Program.cs</code>):
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">创建任务的第一种方式是使用实例化的 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskFactory</code>
                                    ，将方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskMethod</code>
                                    传递给 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">StartNew</code>
                                    方法，任务立即开始。第二种方法使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                                    类的静态 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Factory</code>
                                    属性来访问 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskFactory</code>
                                    并调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">StartNew</code>
                                    方法。这与第一种版本类似，因为它使用了一个工厂，但工厂的创建控制较少。第三种方法使用 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                                    类的构造函数。当实例化 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                                    对象时，任务不会立即运行。相反，它会被赋予状态 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Created</code>
                                    。然后通过调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                                    类的 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Start</code>
                                    方法来启动任务。第四种方法调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                                    的 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Run</code>
                                    方法，该方法立即启动任务。 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Run</code>
                                    方法没有重载的变体来传递 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Action&lt;object&gt;</code>
                                    委托，但可以通过分配一个类型为 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Action</code>
                                    的 lambda 表达式并在其实现中使用该参数来模拟这一点（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/TaskSamples/Program.cs</code>
                                    ）：</font>
                            </font>
                        </font>
                    </p>
                    <pre id="c17-code-0013"><code>public void TasksUsingThreadPool()</code>
<code>{</code>
<code>  <b>TaskFactory tf = new();</b></code>
<code>  <b>Task t1 = tf.StartNew(TaskMethod, "using a task factory");</b></code>
<code>  <b>Task t2 = Task.Factory.StartNew(TaskMethod, "factory via a task");</b></code>
<code>  <b>Task t3 = new(TaskMethod, "using a task constructor and Start");</b></code>
<code>  <b>t3.Start();</b></code>
<code>  <b>Task t4 = Task.Run(() =&gt; TaskMethod("using the Run method"));</b></code>
<code>}</code></pre>
                    <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                        data-immersive-translate-paragraph="1">The output returned with these variants is as follows.
                        All these versions create a new task, and a thread from the thread pool is used. The output can
                        differ any time you run it:<font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">
                                    使用这些变体返回的输出如下。所有这些版本都会创建一个新任务，并使用线程池中的一个线程。输出会在每次运行时有所不同：</font>
                            </font>
                        </font>
                    </p>
                    <pre id="c17-code-0014"><code>using a task factory</code>
<code>Task id: 1, thread: 4</code>
<code>is pooled thread: True</code>
<code>is background thread: True</code>
<code> </code>
<code>factory via a task</code>
<code>Task id: 2, thread: 3</code>
<code>is pooled thread: True</code>
<code>is background thread: True</code>
<code> </code>
<code>using a task constructor and Start</code>
<code>Task id: 3, thread: 5</code>
<code>is pooled thread: True</code>
<code>is background thread: True</code>
<code> </code>
<code>using the Run method</code>
<code>Task id: 4, thread: 7</code>
<code>is pooled thread: True</code>
<code>is background thread: True</code></pre>
                    <p id="c17-para-0057" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                        data-immersive-translate-paragraph="1">With both the <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                        constructor and the <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">StartNew</code>
                        method of the <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskFactory</code>,
                        you can pass values from the enumeration <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskCreationOptions</code>.
                        Using this creation option, you can change how the task should behave differently, as is shown
                        in the next sections.<font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">使用 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                                    构造函数和 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">StartNew</code>
                                    的 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskFactory</code>
                                    方法，你可以从枚举 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskCreationOptions</code>
                                    传递值。使用这个创建选项，你可以改变任务应该如何不同地表现，正如下一节所示。</font>
                            </font>
                        </font>
                    </p>
                </section> <span aria-label="450" epub:type="pagebreak" id="Page_450" role="doc-pagebreak"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
                <section data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><span id="c17-sec-0016"
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
                    <h4 id="head-4-51" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                        data-immersive-translate-paragraph="1">Synchronous Tasks<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                            <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">同步任务</font>
                            </font>
                        </font>
                    </h4>
                    <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                        data-immersive-translate-paragraph="1">A task does not necessarily need to use a thread from a
                        thread pool—it can use other threads as well. Tasks can also run synchronously with the same
                        thread as the calling thread. The following code snippet uses the method <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">RunSynchronously</code>
                        of the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                        class (code file <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/TaskSamples/Program.cs</code>):
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">
                                    一个任务不一定需要使用线程池中的线程——它也可以使用其他线程。任务还可以与调用线程同步运行。以下代码片段使用了 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                                    类的 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">RunSynchronously</code>
                                    方法（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/TaskSamples/Program.cs</code>
                                    ）：</font>
                            </font>
                        </font>
                    </p>
                    <pre id="c17-code-0015"><code>private static void RunSynchronousTask()</code>
<code>{</code>
<code>  TaskMethod("just the main thread");</code>
<code>  <b>Task t1 = new(TaskMethod, "run sync");</b></code>
<code>  <b>t1.RunSynchronously();</b></code>
<code>}</code></pre>
                    <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                        data-immersive-translate-paragraph="1">Here, the <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskMethod</code> is
                        first called directly from the main thread before it is invoked from the newly created <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>. As you
                        can see from the following console output, the main thread doesn't have a task ID. It is not a
                        pooled thread. Calling the method <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">RunSynchronously</code>
                        uses the same thread as the calling thread but creates a task if one wasn't created previously:
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">在这里， <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskMethod</code>
                                    首先在主线程中直接被调用，然后在新创建的 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                                    中被调用。从以下控制台输出中可以看出，主线程没有任务 ID。它不是池中的线程。调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">RunSynchronously</code>
                                    方法使用与调用线程相同的线程，但如果之前没有创建任务，则会创建一个任务：</font>
                            </font>
                        </font>
                    </p>
                    <pre id="c17-code-0016"><code>just the main thread</code>
<code>Task id: no task, thread: 1</code>
<code>is pooled thread: False</code>
<code>is background thread: False</code>
<code> </code>
<code>run sync</code>
<code>Task id: 1, thread: 1</code>
<code>is pooled thread: False</code>
<code>is background thread: False</code></pre>
                </section>
                <section data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><span id="c17-sec-0017"
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
                    <h4 id="head-4-52" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                        data-immersive-translate-paragraph="1">Tasks Using a Separate Thread<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">使用单独线程的任务</font>
                            </font>
                        </font>
                    </h4>
                    <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                        data-immersive-translate-paragraph="1">If the code of a task should run for a longer time, you
                        should use <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskCreationOptions.LongRunning</code>
                        to instruct the task scheduler to create a new thread rather than use a thread from the thread
                        pool. This way, the thread doesn't need to be managed by the thread pool. When a thread is taken
                        from the thread pool, the task scheduler can decide to wait for an already running task to be
                        completed and use this thread instead of creating a new thread with the pool. With a
                        long-running thread, the task scheduler knows immediately that it doesn't make sense to wait for
                        this one. The following code snippet creates a long-running task (code file <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/TaskSamples/Program.cs</code>):
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">如果任务代码需要运行较长时间，你应该使用 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskCreationOptions.LongRunning</code>
                                    来指示任务调度器创建一个新线程，而不是从线程池中使用一个线程。这样，该线程就不需要由线程池管理。当从线程池中获取线程时，任务调度器可以选择等待一个正在运行的任务完成，并使用该线程，而不是创建一个新线程。对于长时间运行的线程，任务调度器会立即知道等待这个线程没有意义。以下代码片段创建了一个长时间运行的任务（代码文件
                                    <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/TaskSamples/Program.cs</code>
                                    ）：</font>
                            </font>
                        </font>
                    </p>
                    <pre id="c17-code-0017"><code>private static void LongRunningTask()</code>
<code>{</code>
<code>  <b>Task t1 = new(TaskMethod, "long running", TaskCreationOptions.LongRunning);</b></code>
<code>  t1.Start();</code>
<code>}</code></pre>
                    <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                        data-immersive-translate-paragraph="1">Indeed, when you use the option <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskCreationOptions.LongRunning</code>,
                        a thread from the thread pool is not used. Instead, a new thread is created:<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">确实，当你使用选项 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskCreationOptions.LongRunning</code>
                                    时，不会使用线程池中的线程。相反，会创建一个新线程：</font>
                            </font>
                        </font>
                    </p>
                    <pre id="c17-code-0018"><code>long running</code>
<code>Task id: 1, thread: 4</code>
<code>is pooled thread: False</code>
<code>is background thread: True</code></pre>
                </section>
            </section>
            <section data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><span id="c17-sec-0018"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
                <h3 id="head-3-312" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Results from Tasks <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">任务结果</font>
                        </font>
                    </font>
                </h3>
                <p id="c17-para-0062" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">When a task is finished, it can write some state information
                    to a shared object. Such a shared object must be thread-safe. Another option is to use a task that
                    returns a result. Such a task is also known as <i
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">future</i> because it
                    returns a result in the future. With early versions of the Task Parallel Library (TPL), the class
                    had the name <span aria-label="451" epub:type="pagebreak" id="Page_451" role="doc-pagebreak"
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
                    <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Future</code> as well.
                    Now it is a generic version of the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code> class. With
                    this class, it is possible to define the type of the result that is returned with a task.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                当一个任务完成时，它可以向一个共享对象写入一些状态信息。这样的共享对象必须是线程安全的。另一个选项是使用一个返回结果的任务。这种任务也被称为
                                future，因为它会在未来返回一个结果。在任务并行库（TPL）的早期版本中，这个类也被称为 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Future</code>
                                。现在它是 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                                类的一个泛型版本。使用这个类，可以定义任务返回结果的类型。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">A method that is invoked by a task to return a result can be
                    declared with any return type. The following example method <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskWithResult</code>
                    returns two <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">int</code>
                    values with the help of a tuple. The input of the method can be void or of type <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">object</code>, as shown
                    here (code file <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/TaskSamples/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">一个由任务调用来返回结果的函数可以用任何返回类型来声明。以下示例方法
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskWithResult</code>
                                借助元组返回两个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">int</code>
                                值。方法的输入可以是 void 或 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">object</code>
                                类型，如这里所示（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/TaskSamples/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0019"><code>public static (int Result, int Remainder) TaskWithResult(object division)</code>
<code>{</code>
<code>  (int x, int y) = ((int x, int y))division;</code>
<code>  int result = x / y;</code>
<code>  int remainder = x % y;</code>
<code>  Console.WriteLine("task creates a result…");</code>
<code>  return (result, remainder);</code>
<code>}</code></pre>
                <aside data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                    <div class="top hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                        <p id="c17-para-0065" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">NOTE</b> <i
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Tuples allow you
                                to combine multiple values into one. Tuples are explained in <a href="c03.xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Chapter
                                    3</a>, “Classes, Records, Structs, and Tuples.”</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">
                                        注意：元组允许你将多个值组合为一个。元组在第三章“类、记录、结构体和元组”中有详细解释。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                            <hr />
                        </div>
                    </section>
                </aside>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">When you define a task to invoke the method <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskWithResult</code>,
                    you use the generic class <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task&lt;TResult&gt;</code>.
                    The generic parameter defines the return type. With the constructor, the method is passed to the
                    <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Func</code> delegate,
                    and the second parameter defines the input value. Because this task needs two input values in the
                    <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">object</code>
                    parameter, a tuple is created as well. Next, the task is started. The <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Result</code> property of
                    the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                    instance <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">t1</code>
                    blocks and waits until the task is completed. Upon task completion, the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Result</code> property
                    contains the result from the task:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">当你定义一个任务来调用方法 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskWithResult</code>
                                时，你使用泛型类 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task&lt;TResult&gt;</code>
                                。泛型参数定义了返回类型。通过构造函数，方法被传递给 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Func</code>
                                委托，第二个参数定义了输入值。因为这个任务需要在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">object</code>
                                参数中提供两个输入值，所以也创建了一个元组。接下来，任务被启动。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                                实例 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">t1</code> 的
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Result</code>
                                属性会阻塞并等待任务完成。任务完成后， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Result</code>
                                属性包含任务的结果：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0020"><code>public static void TaskWithResultDemo()</code>
<code>{</code>
<code>  <b>Task&lt;(int Result, int Remainder)&gt; t1 = new(TaskWithResult, (8, 3));</b></code>
<code>  <b>t1.Start();</b></code>
<code>  Console.WriteLine(<b>t1.Result</b>);</code>
<code>  t1.Wait();</code>
<code>  Console.WriteLine($"result from task: {t1.Result.Result} " +   </code>
<code>    $"{t1.Result.Remainder}");</code>
<code>}</code></pre>
            </section>
            <section data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><span id="c17-sec-0020"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
                <h3 id="head-3-313" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Continuation Tasks <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">延续任务 </font>
                        </font>
                    </font>
                </h3>
                <p id="c17-para-0067" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">With tasks, you can specify that after a task is finished,
                    another specific task should start to run—for example, a new task that uses a result from the
                    previous one or should do some cleanup if the previous task failed.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                使用任务时，你可以指定在任务完成后启动另一个特定的任务——例如，一个使用先前任务结果的新任务，或者如果先前任务失败则进行清理的新任务。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Whereas the task handler has either no parameter or one
                    object parameter, the continuation handler has a parameter of type <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>. Here, you
                    can access information about the originating task (code file <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/TaskSamples/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">任务处理器要么没有参数，要么有一个对象参数，而延续处理器有一个
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                                类型的参数。在这里，你可以访问有关原始任务的信息（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/TaskSamples/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0021"><code>private static void DoOnFirst()</code>
<code>{</code>
<code>  Console.WriteLine($"doing some task {Task.CurrentId}");</code>
<code>  Task.Delay(3000).Wait();</code>
<code>}</code>
<code> <span aria-label="452" epub:type="pagebreak" id="Page_452" role="doc-pagebreak"></span></code>
<code>private static void DoOnSecond(Task t)</code>
<code>{</code>
<code>  Console.WriteLine($"task {t.Id} finished");</code>
<code>  Console.WriteLine($"this task id {Task.CurrentId}");</code>
<code>  Console.WriteLine("do some cleanup");</code>
<code>  Task.Delay(3000).Wait();</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">A continuation task is defined by invoking the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ContinueWith</code>
                    method on a task. You could also use <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskFactory</code> for
                    this. <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">t1.OnContinueWith(DoOnSecond)</code>
                    means that a new task invoking the method <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">DoOnSecond</code> should
                    be started as soon as the task <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">t1</code> is finished.
                    You can start multiple tasks when one task is finished, and a continuation task can have another
                    continuation task, as this next example demonstrates (code file <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/TaskSamples/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">一个延续任务是通过在一个任务上调用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ContinueWith</code>
                                方法来定义的。你也可以使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskFactory</code>
                                来执行这个操作。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">t1.OnContinueWith(DoOnSecond)</code>
                                表示一旦任务 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">t1</code>
                                完成，就应启动一个调用方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">DoOnSecond</code>
                                的新任务。当一项任务完成时，你可以启动多个任务，并且一个延续任务可以拥有另一个延续任务，就像这个下一个示例所展示的那样（代码文件 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/TaskSamples/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0022"><code>public static void ContinuationTasks()</code>
<code>{</code>
<code>  Task t1 = new(DoOnFirst);</code>
<code>  Task t2 = <b>t1.ContinueWith(DoOnSecond);</b></code>
<code>  Task t3 = <b>t1.ContinueWith(DoOnSecond);</b></code>
<code>  Task t4 = <b>t2.ContinueWith(DoOnSecond);</b></code>
<code>  t1.Start();</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">So far, the continuation tasks have been started when the
                    previous task was finished, regardless of the result. With values from <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskContinuationOptions</code>,
                    you can define that a continuation task should start only if the originating task was successful (or
                    faulted). Some of the possible values are <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">OnlyOnFaulted</code>,
                    <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">NotOnFaulted</code>,
                    <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">OnlyOnCanceled</code>,
                    <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">NotOnCanceled</code>,
                    and <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">OnlyOnRanToCompletion</code>
                    :<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">到目前为止，延续任务是在前一个任务完成时启动的，无论结果如何。通过
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskContinuationOptions</code>
                                的值，你可以定义延续任务只有在原始任务成功（或出现故障）时才启动。一些可能的值包括 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">OnlyOnFaulted</code>
                                、 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">NotOnFaulted</code>
                                、 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">OnlyOnCanceled</code>
                                、 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">NotOnCanceled</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">OnlyOnRanToCompletion</code>
                                ：</font>
                        </font>
                    </font>
                </p>
                <pre
                    id="c17-code-0023"><code><b>Task t5 = t1.ContinueWith(DoOnError, TaskContinuationOptions.OnlyOnFaulted);</b></code></pre>
            </section>
            <section data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><span id="c17-sec-0021"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
                <h3 id="head-3-314" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Task Hierarchies <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">任务层次结构</font>
                        </font>
                    </font>
                </h3>
                <p id="c17-para-0071" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">With task continuations, one task is started after another.
                    Tasks can also form a hierarchy. When a task starts a new task, a parent/child hierarchy is started.
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                通过任务延续，一个任务在另一个任务之后启动。任务也可以形成层次结构。当一个任务启动一个新任务时，就会开始一个父/子层次结构。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">In the code snippet that follows, within the task of the
                    parent, a new task object is created, and the task is started. The code for creating a child task is
                    the same as that for a parent task. The only difference is that the task is created from within
                    another task (code file <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/TaskSamples/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                在以下代码片段中，在父任务的内部创建了一个新的任务对象，并启动了该任务。创建子任务的代码与创建父任务的代码相同。唯一的区别是任务是在另一个任务内部创建的（代码文件 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/TaskSamples/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0024"><code>public static void ParentAndChild()</code>
<code>{</code>
<code>  <b>Task parent = new(ParentTask);</b></code>
<code>  <b>parent.Start();</b></code>
<code>  Task.Delay(2000).Wait();</code>
<code>  Console.WriteLine(parent.Status);</code>
<code>  Task.Delay(4000).Wait();</code>
<code>  Console.WriteLine(parent.Status);</code>
<code>}</code>
<code> </code>
<code>private static void ParentTask()</code>
<code>{</code>
<code>  Console.WriteLine($"task id {Task.CurrentId}");</code>
<code>  <b>Task child = new(ChildTask);</b></code>
<code>  <b>child.Start();</b></code>
<code>  Task.Delay(1000).Wait();</code>
<code>  Console.WriteLine("parent started child");</code>
<code>}</code>
<code> <span aria-label="453" epub:type="pagebreak" id="Page_453" role="doc-pagebreak"></span></code>
<code>private static void ChildTask()</code>
<code>{</code>
<code>  Console.WriteLine("child");</code>
<code>  Task.Delay(5000).Wait();</code>
<code>  Console.WriteLine("child finished");</code>
<code>}</code></pre>
                <p id="c17-para-0073" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">If the parent task is finished before the child task, the
                    status of the parent task is shown as <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitingForChildrenToComplete</code>.
                    The parent task is completed with the status <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">RanToCompletion</code> as
                    soon as all children tasks are completed as well. Of course, this is not the case if the parent
                    creates a task with the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskCreationOption DetachedFromParent</code>.
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">如果父任务在子任务之前完成，父任务的状态显示为 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitingForChildrenToComplete</code>
                                。只要所有子任务也都完成了，父任务就会以 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">RanToCompletion</code>
                                的状态完成。当然，如果父任务使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskCreationOption DetachedFromParent</code>
                                创建任务，则情况并非如此。</font>
                        </font>
                    </font>
                </p>
                <p id="c17-para-0074" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Canceling a parent task also cancels the children. The
                    cancellation framework is discussed later.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">取消父任务也会取消子任务。取消框架将在后面讨论。</font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><span id="c17-sec-0022"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
                <h3 id="head-3-315" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Returning Tasks from Methods <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">从方法中返回任务</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">A method that returns a task with results is declared to
                    return <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task&lt;T&gt;</code>—for
                    example, a method that returns a task with a collection of strings:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">一种返回带有结果的任务的方法声明为返回 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task&lt;T&gt;</code>
                                ——例如，返回带有字符串集合的任务的方法：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0025"><code>public Task&lt;IEnumerable&lt;string&gt;&gt; TaskMethodAsync()</code>
<code>{</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Methods that access the network or data are usually
                    implemented in an asynchronous way to return a Task. The Task can then be used to retrieve the
                    results (for example, by using the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">async</code> keyword as
                    explained in <a href="c11.xhtml"
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Chapter 11</a>). If you
                    have a synchronous path or need to implement an interface that is defined that way with synchronous
                    code, there's no need to create a task for the sake of the result value. The <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code> class offers
                    the ability to create a result with a completed task that is finished with the status <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">RanToCompletion</code>
                    using the method <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">FromResult</code>
                    :<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">访问网络或数据的通常以异步方式实现，返回 Task。然后可以使用
                                Task 来获取结果（例如，使用在第 11 章中解释的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">async</code>
                                关键字）。如果你有一个同步路径或需要用同步代码实现定义了该接口，则无需为结果值创建任务。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                                类提供了使用方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">FromResult</code>
                                创建一个状态为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">RanToCompletion</code>
                                的已完成任务来生成结果的能力：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0026"><code>return Task<b>.FromResult</b>&lt;IEnumerable&lt;string&gt;&gt;(</code>
<code>  new List&lt;string&gt;() { "one", "two" });</code></pre>
            </section>
            <section data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><span id="c17-sec-0023"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
                <h3 id="head-3-316" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Waiting for Tasks <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">等待任务</font>
                        </font>
                    </font>
                </h3>
                <p id="c17-para-0077" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">You’ve probably already seen the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WhenAll</code> and <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitAll</code> methods of
                    the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code> class
                    and wondered what the difference might be. Both methods wait for all tasks that are passed to them
                    to complete. The <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitAll</code> method
                    blocks the calling task until all tasks that are waited for are completed. The <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WhenAll</code> method
                    returns a task that in turn allows you to use the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">async</code> keyword to
                    wait for the result, and it does not block the waiting task.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">你可能已经看到了 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                                类的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WhenAll</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitAll</code>
                                方法，并想知道它们之间有什么区别。这两种方法都等待传递给它们的所有任务完成。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitAll</code>
                                方法会阻塞调用任务，直到所有等待的任务完成。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WhenAll</code>
                                方法返回一个任务，该任务反过来允许你使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">async</code>
                                关键字等待结果，并且不会阻塞等待任务。</font>
                        </font>
                    </font>
                </p>
                <p id="c17-para-0078" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Although the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WhenAll</code> and <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitAll</code> methods
                    are finished when all the tasks you are waiting for are completed, you can wait for just one task of
                    a list to be completed with <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WhenAny</code> and <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitAny</code>. Like the
                    <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WhenAll</code> and
                    <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitAll</code> methods,
                    the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitAny</code>
                    method blocks the calling task, whereas <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WhenAny</code> returns a
                    task that can be awaited.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">尽管 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WhenAll</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitAll</code>
                                方法在所有你等待的任务都完成时才会结束，但你可以使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WhenAny</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitAny</code>
                                方法等待列表中的一个任务完成。与 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WhenAll</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitAll</code>
                                方法类似， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitAny</code>
                                方法会阻塞调用任务，而 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WhenAny</code>
                                方法会返回一个可以等待的任务。</font>
                        </font>
                    </font>
                </p>
                <p id="c17-para-0079" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">A method that already has been used several times with
                    several samples is the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task.Delay</code> method.
                    You can specify a number of milliseconds to wait before the task that is returned from this method
                    is completed.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">一个已经使用过几次的 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task.Delay</code>
                                方法。你可以指定一个毫秒数，在从该方法返回的任务完成之前等待。</font>
                        </font>
                    </font>
                </p>
                <p id="c17-para-0080" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">You can invoke the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task.Yield</code> method
                    to give up the CPU and thus allow other tasks to run. If no other task is waiting to run, the task
                    calling <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task.Yield</code>
                    continues immediately. Otherwise, it needs to wait until the CPU is scheduled again for the calling
                    task.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">你可以调用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task.Yield</code>
                                方法放弃 CPU，从而允许其他任务运行。如果没有其他任务等待运行，调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task.Yield</code>
                                的任务会立即继续。否则，它需要等待 CPU 再次调度给调用任务。</font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><span id="c17-sec-0024"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
                <h3 id="head-3-317" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Value Tasks <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">值任务</font>
                        </font>
                    </font>
                </h3>
                <p id="c17-para-0081" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">In case a method sometimes runs asynchronously, but not
                    always, the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                    class might be some overhead that's not needed. .NET now offers <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ValueTask</code>, which
                    is a struct compared to the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code> that is a
                    class; thus, the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ValueTask</code> doesn't
                    have the overhead of an object in the heap. Usually when invoking asynchronous methods, such as
                    making calls to an API server or a database, the overhead of the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code> type can be
                    ignored compared to the time needed for <span aria-label="454" epub:type="pagebreak" id="Page_454"
                        role="doc-pagebreak"
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>the work to be
                    done. However, there are some cases where the overhead cannot be ignored, such as when a method is
                    called thousands of times, and it rarely really needs a call across the network. This is a scenario
                    where the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ValueTask</code> becomes
                    handy.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">如果某个方法有时运行异步，但并非总是如此， <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                                类可能会带来一些不必要的开销。.NET 现在提供了 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ValueTask</code>
                                ，它是一个结构体，而 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                                是一个类；因此， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ValueTask</code>
                                没有对象在堆中的开销。通常在调用异步方法时，例如调用 API 服务器或数据库，与完成工作所需的时间相比， <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                                类型的开销可以忽略不计。然而，在某些情况下，开销不能被忽略，例如当方法被调用数千次，而它很少真正需要跨网络调用时。这就是 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ValueTask</code>
                                变得有用的场景。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Let's check out an example. The method <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">GetTheRealData</code>
                    simulates a method that usually takes a long time, accessing data from the network or a database.
                    Here, sample data is generated with the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Enumerable</code> class.
                    The time and data are both retrieved, and a result in the form of a tuple is returned. This method
                    returns a <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                    as we are used to (code file <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/ValueTaskSample/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">让我们来看一个例子。方法 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">GetTheRealData</code>
                                模拟一个通常需要很长时间的方法，访问网络或数据库中的数据。这里使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Enumerable</code>
                                类生成样本数据。时间和数据都被检索，并以元组形式返回结果。该方法返回我们熟悉的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                                （代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/ValueTaskSample/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0027"><code>public static Task&lt;(IEnumerable&lt;string&gt; data, DateTime retrievedTime)&gt; </code>
<code>  GetTheRealData() =&gt;</code>
<code>    Task.FromResult(</code>
<code>      (Enumerable.Range(0, 10)</code>
<code>        .Select(x =&gt; $"item {x}").AsEnumerable(), DateTime.Now));</code></pre>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">The interesting part now follows in the method <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">GetSomeData</code>. This
                    method is declared to return a <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ValueTask</code>. With
                    the implementation, first a check is done if cached data is not older than five seconds. If the
                    cached data is not older, the cached data is directly returned and passed to the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ValueTask</code>
                    constructor. This doesn't really need a background thread; the data can be directly returned. If the
                    cache is older, the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">GetTheRealData</code>
                    method is invoked. This method needs a real task and could occur with some delay (code file <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/ValueTaskSample/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">现在有趣的部分在方法 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">GetSomeData</code>
                                中。该方法声明返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ValueTask</code>
                                。在实现中，首先检查缓存数据是否早于五秒。如果缓存数据不早，则直接返回缓存数据并将其传递给 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ValueTask</code>
                                构造函数。这真的不需要后台线程；数据可以直接返回。如果缓存已过期，则调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">GetTheRealData</code>
                                方法。此方法需要一个实际的任务，并可能发生一些延迟（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/ValueTaskSample/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0028"><code>private static DateTime _retrieved;</code>
<code>private static IEnumerable&lt;string&gt; _cachedData;</code>
<code>public static async ValueTask&lt;IEnumerable&lt;string&gt;&gt; GetSomeDataAsync()</code>
<code>{</code>
<code>  if (_retrieved&gt;= DateTime.Now.AddSeconds(-5))</code>
<code>  {</code>
<code>    Console.WriteLine("data from the cache");</code>
<code>    return await new ValueTask&lt;IEnumerable&lt;string&gt;&gt;(_cachedData);</code>
<code>  }</code>
<code> </code>
<code>  Console.WriteLine("data from the service");</code>
<code>  (_cachedData, _retrieved) = await GetTheRealData();</code>
<code>  return _cachedData;</code>
<code>}</code></pre>
                <aside data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                    <div class="top hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                        <p id="c17-para-0085" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">NOTE</b> <i
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">The constructor
                                of the </i> <code
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ValueTask</code>
                            <i data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"> accepts type </i>
                            <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TResult</code>
                            <i data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"> for the data to
                                be returned, or it accepts </i> <code
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task&lt;TResult&gt;</code>
                            <i data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"> to supply a </i>
                            <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code> <i
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"> returned from
                                methods that do run asynchronously.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意： <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ValueTask</code>
                                        的构造函数接受 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TResult</code>
                                        类型的返回数据，或者接受 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task&lt;TResult&gt;</code>
                                        以提供从异步运行方法返回的 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                                        。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                            <hr />
                        </div>
                    </section>
                </aside>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">The <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Main</code> method
                    includes a loop to invoke the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">GetSomeDataAsync</code>
                    method several times with a delay after every iteration (code file <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/ValueTaskSample/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Main</code>
                                方法包含一个循环，在每次迭代后延迟调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">GetSomeDataAsync</code>
                                方法几次（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/ValueTaskSample/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0029"><code>static async Task Main(string[] args)</code>
<code>{</code>
<code>  for (int i = 0; i &lt; 20; i++)</code>
<code>  {</code>
<code>    IEnumerable&lt;string&gt; data = await GetSomeDataAsync();</code>
<code>    await Task.Delay(1000);</code>
<code>  }</code>
<code>  Console.ReadLine();</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1"><span aria-label="455" epub:type="pagebreak" id="Page_455"
                        role="doc-pagebreak"
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>When you run the
                    application, you can see that the data is returned from the cache, and after the cache is
                    invalidated, the service is accessed first before the cache is used again.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                运行应用程序时，可以看到数据是从缓存中返回的，在缓存失效后，首先访问服务，然后再使用缓存。</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0030"><code>data from the service</code>
<code>data from the cache</code>
<code>data from the cache</code>
<code>data from the cache</code>
<code>data from the cache</code>
<code>data from the service</code>
<code>data from the cache</code>
<code>data from the cache</code>
<code>data from the cache</code>
<code>data from the cache</code>
<code>data from the service</code>
<code>data from the cache</code>
<code>…</code></pre>
                <aside data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                    <div class="top hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                        <p id="c17-para-0089" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">NOTE</b> <i
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">You haven’t
                                probably come across scenarios yet where you can't ignore the overhead from tasks
                                compared to value tasks. However, having this core feature in .NET is one of the
                                foundations of async streams, which is covered in <a href="c11.xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Chapter
                                    11</a>.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意
                                        你可能还没有遇到过无法忽略任务与值任务相比的开销的场景。然而，在.NET 中拥有这个核心特性是异步流的基础，这将在第 11 章中介绍。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                            <hr />
                        </div>
                    </section>
                </aside>
            </section>
        </section>
        <section aria-labelledby="head-2-149" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
            <span id="c17-sec-0027" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
            <h2 id="head-2-149" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">CANCELLATION FRAMEWORK<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">取消框架</font>
                    </font>
                </font>
            </h2>
            <p id="c17-para-0090" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">.NET includes a cancellation framework to enable the canceling of
                long-running tasks in a standard manner. Every blocking call should support this mechanism. Of course,
                not every blocking call currently implements this new technology, but more and more are doing so. Among
                the technologies that already offer this mechanism are tasks, concurrent collection classes, Parallel
                LINQ, and several synchronization mechanisms.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">.NET
                            包含一个取消框架，以标准方式支持取消长时间运行的任务。每个阻塞调用都应该支持这个机制。当然，并非所有当前的阻塞调用都实现了这项新技术，但越来越多的调用正在这样做。已经提供这种机制的技术包括任务、并发集合类、并行
                            LINQ 以及几种同步机制。</font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0091" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">The cancellation framework is based on cooperative behavior; it
                is not forceful. A long-running task checks whether it is canceled and returns control accordingly.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            取消框架基于协作行为；它不是强制的。长时间运行的任务检查是否被取消，并相应地返回控制权。</font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0092" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">A method that supports cancellation accepts a <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CancellationToken</code>
                parameter. This class defines the property <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">IsCancellationRequested</code>,
                whereby a long operation can check to see whether it should abort. Other ways for a long operation to
                check for cancellation include using a <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitHandle</code> property
                that is signaled when the token is canceled or using the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Register</code> method. The
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Register</code> method
                accepts parameters of type <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Action</code> and <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ICancelableOperation</code>.
                The method that is referenced by the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Action</code> delegate is
                invoked when the token is canceled. This is like the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ICancelableOperation</code>,
                whereby the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Cancel</code>
                method of an object implementing this interface is invoked when the cancellation is done.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">支持取消的方法接受一个 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CancellationToken</code>
                            参数。这个类定义了 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">IsCancellationRequested</code>
                            属性，使得长时间运行的操作可以检查是否应该中止。长时间运行的操作检查取消的其他方式包括使用在令牌被取消时发出信号的 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitHandle</code>
                            属性，或使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Register</code>
                            方法。 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Register</code>
                            方法接受类型为 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Action</code> 和
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ICancelableOperation</code>
                            的参数。当令牌被取消时，由 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Action</code>
                            委托引用的方法会被调用。这类似于 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ICancelableOperation</code>
                            ，即当取消操作完成时，实现该接口的对象的 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Cancel</code>
                            方法会被调用。</font>
                    </font>
                </font>
            </p>
            <section data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><span id="c17-sec-0028"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
                <h3 id="head-3-318" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Cancellation of Parallel.For <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">Parallel.For 的取消</font>
                        </font>
                    </font>
                </h3>
                <p id="c17-para-0093" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">This section starts with a simple example using the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.For</code>
                    method. The <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code> class
                    provides overloads for the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">For</code> method,
                    whereby you can pass a parameter of type <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelOptions</code>.
                    With <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelOptions</code>,
                    you can pass a <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CancellationToken</code>.
                    The <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CancellationToken</code>
                    is generated by creating a <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CancellationTokenSource</code>.
                    <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CancellationTokenSource</code>
                    implements the interface <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ICancelableOperation</code>
                    and can therefore be registered with the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CancellationToken</code>
                    and allows cancellation with the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Cancel</code> method. The
                    example doesn't call the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Cancel</code> method
                    directly but uses a constructor overload to cancel the token after 500 milliseconds.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">这一节从一个使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.For</code>
                                方法的简单示例开始。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code>
                                类为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">For</code>
                                方法提供了重载，你可以传递一个类型为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelOptions</code>
                                的参数。通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelOptions</code>
                                ，你可以传递一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CancellationToken</code>
                                。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CancellationToken</code>
                                是通过创建一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CancellationTokenSource</code>
                                生成的。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CancellationTokenSource</code>
                                实现了 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ICancelableOperation</code>
                                接口，因此可以注册到 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CancellationToken</code>
                                ，并允许通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Cancel</code>
                                方法取消。示例没有直接调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Cancel</code>
                                方法，而是使用构造函数重载在 500 毫秒后取消令牌。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Within the implementation of the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">For</code> loop, the
                    <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code> class
                    verifies the outcome of the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CancellationToken</code>
                    and cancels the operation. Upon cancellation, the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">For</code> method throws
                    an exception of type <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">OperationCanceledException</code>,
                    which is caught in the example. With the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CancellationToken</code>,
                    it is <span aria-label="456" epub:type="pagebreak" id="Page_456" role="doc-pagebreak"
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>possible to
                    register for information when the cancellation is done. This is accomplished by calling the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Register</code> method
                    and passing a delegate that is invoked on cancellation (code file <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/CancellationSamples/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">For</code>
                                循环的实现中， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code>
                                类验证 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CancellationToken</code>
                                的结果并取消操作。在取消时， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">For</code>
                                方法会抛出一个类型为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">OperationCanceledException</code>
                                的异常，示例中捕获了这个异常。通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CancellationToken</code>
                                ，可以注册在取消完成时接收信息。这是通过调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Register</code>
                                方法并传递一个在取消时被调用的委托（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/CancellationSamples/Program.cs</code>
                                ）来完成的：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0031"><code>public static void CancelParallelFor()</code>
<code>{</code>
<code>  <b>CancellationTokenSource cts = new(millisecondsDelay: 500);</b></code>
<code>  cts.Token.Register(() =&gt; Console.WriteLine("*** cancellation activated"));</code>
<code>  try</code>
<code>  {</code>
<code>    ParallelLoopResult result =</code>
<code>      <b>Parallel.For(0, 100, new ParallelOptions</b></code>
<code>      <b>{</b></code>
<code>        <b>CancellationToken = cts.Token,</b></code>
<code>      <b>},</b></code>
<code>      x =&gt;</code>
<code>      {</code>
<code>        Console.WriteLine($"loop {x} started");</code>
<code>        int sum = 0;</code>
<code>        for (int i = 0; i &lt; 100; i++)</code>
<code>        {</code>
<code>          Task.Delay(2).Wait();</code>
<code>          sum += i;</code>
<code>        }</code>
<code>        Console.WriteLine($"loop {x} finished");</code>
<code>      });</code>
<code>  }</code>
<code>  catch (OperationCanceledException ex)</code>
<code>  {</code>
<code>    Console.WriteLine(ex.Message);</code>
<code>  }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">When you run the application, you get output like the
                    following. Iteration 0, 50, 25, 75, and 1 were all started. This is on a system with a quad-core
                    CPU. With the cancellation, all other iterations were canceled before starting. The iterations that
                    were started are allowed to finish because cancellation is always done in a cooperative way to avoid
                    the risk of resource leaks when iterations are canceled somewhere in between:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">运行应用程序时，你会得到如下输出。迭代 0、50、25、75 和 1
                                都已启动。这是在一个四核 CPU
                                系统上运行的。由于取消操作，所有其他迭代在启动前都被取消了。已启动的迭代被允许完成，因为取消操作总是以协作方式进行，以避免在迭代中途取消时出现资源泄漏的风险：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0032"><code>loop 36 started</code>
<code>loop 12 started</code>
<code>loop 72 started</code>
<code>loop 24 started</code>
<code>loop 48 started</code>
<code>loop 60 started</code>
<code>loop 0 started</code>
<code>loop 84 started</code>
<code>loop 96 started</code>
<code><b>***</b> cancellation activated</code>
<code>loop 12 finished</code>
<code>loop 60 finished</code>
<code>loop 36 finished</code>
<code>loop 72 finished</code>
<code>loop 96 finished</code>
<code>loop 84 finished</code>
<code>loop 24 finished<span aria-label="457" epub:type="pagebreak" id="Page_457" role="doc-pagebreak"></span></code>
<code>loop 48 finished</code>
<code>loop 0 finished</code>
<code>The operation was canceled.</code></pre>
            </section>
            <section data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><span id="c17-sec-0029"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
                <h3 id="head-3-319" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Cancellation of Tasks <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">任务的取消</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">The same cancellation pattern is used with tasks. First, a
                    new <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CancellationTokenSource</code>
                    is created. If you need just one cancellation token, you can use a default token by accessing <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task.Factory.CancellationToken</code>.
                    Then, like the previous code, the task is canceled after 500 milliseconds. The task doing the major
                    work within a loop receives the cancellation token via the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskFactory</code>
                    object. The cancellation token is assigned to the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskFactory</code> by
                    setting it in the constructor. This cancellation token is used by the task to check whether
                    cancellation is requested by checking the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">IsCancellationRequested</code>
                    property of the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CancellationToken</code>
                    (code file <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/CancellationSamples/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">相同的取消模式也适用于任务。首先，创建一个新的 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CancellationTokenSource</code>
                                。如果你只需要一个取消令牌，可以通过访问 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task.Factory.CancellationToken</code>
                                使用默认令牌。然后，像之前的代码一样，在 500 毫秒后取消任务。在循环内执行主要工作的任务通过 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskFactory</code>
                                对象接收取消令牌。取消令牌通过在构造函数中设置分配给 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskFactory</code>
                                。任务使用该取消令牌检查是否请求取消，方法是检查 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">IsCancellationRequested</code>
                                的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CancellationToken</code>
                                属性（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/CancellationSamples/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0033"><code>public void CancelTask()</code>
<code>{</code>
<code>  <b>CancellationTokenSource cts = new(millisecondsDelay: 500);</b></code>
<code>  cts.Token.Register(() =&gt; Console.WriteLine("*** task canceled"));</code>
<code>  Task t1 = Task.Run(() =&gt;</code>
<code>  {</code>
<code>    Console.WriteLine("in task");</code>
<code>    for (int i = 0; i &lt; 20; i++)</code>
<code>    {</code>
<code>      Task.Delay(100).Wait();</code>
<code>      <b>CancellationToken token = cts.Token;</b></code>
<code>      if (<b>token.IsCancellationRequested</b>)</code>
<code>      {</code>
<code>        Console.WriteLine("cancelling was requested, " +</code>
<code>          "cancelling from within the task");</code>
<code>        <b>token.ThrowIfCancellationRequested();</b></code>
<code>        break;</code>
<code>      }</code>
<code>      Console.WriteLine("in loop");</code>
<code>    }</code>
<code>    Console.WriteLine("task finished without cancellation");</code>
<code>  }, cts.Token);</code>
<code> </code>
<code>  try</code>
<code>  {</code>
<code>    t1.Wait();</code>
<code>  }</code>
<code>  catch (AggregateException ex)</code>
<code>  {</code>
<code>    Console.WriteLine($"exception: {ex.GetType().Name}, {ex.Message}");</code>
<code>    foreach (var innerException in ex.InnerExcepstions)</code>
<code>    {</code>
<code>      Console.WriteLine($"inner exception: {ex.InnerException.GetType()}," +</code>
<code>        $"{ex.InnerException.Message}");</code>
<code>    }</code>
<code>  }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">When you run the application, you can see that the task
                    starts, runs for a few loops, and gets the cancellation request. The task is canceled and throws a
                    <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskCanceledException</code>,
                    which is initiated from the method call <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ThrowIfCancellationRequested</code>.
                    With the caller waiting for the task, you can see that the exception <span aria-label="458"
                        epub:type="pagebreak" id="Page_458" role="doc-pagebreak"
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
                    <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">AggregateException</code>
                    is caught and contains the inner exception <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskCanceledException</code>.
                    This is used for a hierarchy of cancellations—for example, if you run a <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.For</code>
                    within a task that is canceled as well. The final status of the task is <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Canceled</code>
                    :<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                运行应用程序时，你可以看到任务开始执行，运行几个循环后收到取消请求。任务被取消并抛出 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskCanceledException</code>
                                ，该异常是从方法调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ThrowIfCancellationRequested</code>
                                触发的。在调用者等待任务时，你可以看到捕获了异常 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">AggregateException</code>
                                ，其中包含内部异常 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskCanceledException</code>
                                。这用于取消的层次结构——例如，如果你在一个同样被取消的任务中运行 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.For</code>
                                。任务的最终状态是 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Canceled</code>
                                ：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0034"><code>in task</code>
<code>in loop</code>
<code>in loop</code>
<code>in loop</code>
<code>in loop</code>
<code>*** task canceled</code>
<code>cancelling was requested, cancelling from within the task</code>
<code>exception: AggregateException, One or more errors occurred. (A task was canceled.)</code>
<code>inner exception: System.Threading.Tasks.TaskCanceledException, A task was canceled.</code></pre>
            </section>
        </section>
        <section aria-labelledby="head-2-150" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
            <span id="c17-sec-0030" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
            <h2 id="head-2-150" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">CHANNELS</h2>
            <p id="c17-para-0098" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">In many applications, you have a producer/consumer scenario. One
                task produces data, and another task consumes and processes the data. In <a href="c11.xhtml"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Chapter 11</a>, you can read
                about a device simulation where a device streams sensor data, and this data is consumed using async
                streams. Here, you've seen syntax enhancements with C# as the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">foreach</code> statement was
                extended with <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">await foreach</code>, and the
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">yield</code> statement was
                extended to support <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">IAsyncEnumerable&lt;T&gt;</code>
                and <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">IAsyncEnumerator&lt;T&gt;</code>.
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            在许多应用中，你有一个生产者/消费者场景。一个任务产生数据，另一个任务消费并处理这些数据。在第 11
                            章中，你可以读到关于一个设备模拟的例子，其中设备流式传输传感器数据，这些数据通过异步流被消费。在这里，你看到了 C#的语法增强， <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">foreach</code>
                            语句通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">await foreach</code>
                            进行了扩展，而 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">yield</code>
                            语句扩展以支持 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">IAsyncEnumerable&lt;T&gt;</code>
                            和 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">IAsyncEnumerator&lt;T&gt;</code>
                            。</font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0099" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">With a producer/consumer scenario based on the data you deal
                with, there are different requirements. Is it necessary to deal with data in a fast pace? Is it okay to
                ignore data if processing is not fast enough, or is it required to process every item? Should data be
                ignored if it is already too old and new values can be retrieved? What's the optimal size of the buffer?
                Should the size of the buffer change dynamically?<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            基于你处理的数据的生产者/消费者场景，有不同的需求。是否需要快速处理数据？如果处理不够快，是否可以忽略数据，或者是否必须处理每个项目？如果数据已经太旧，新值可以获取，是否应该忽略数据？缓冲区的最佳大小是多少？缓冲区的大小是否应该动态变化？
                        </font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0100" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">Without requiring that you do a custom implementation, <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">System.Threading.Channels</code>
                offers great flexibility. A channel stores data written from a producer and allows reading data using a
                consumer. This library offers <i
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">unbounded channels</i>, which
                grow dynamically as needed until no more memory is available, and <i
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">bounded channels</i> with a
                fixed size.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">无需要求你进行自定义实现， <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">System.Threading.Channels</code>
                            提供了极大的灵活性。一个通道存储生产者写入的数据，并允许消费者读取数据。这个库提供了无界通道，它们根据需要动态增长，直到没有更多内存可用，以及具有固定大小的有界通道。</font>
                    </font>
                </font>
            </p>
            <section data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><span id="c17-sec-0031"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
                <h3 id="head-3-320" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Creating Bounded and Unbounded Channels <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">创建有界和无界通道</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Let's look at a sample application before going into some of
                    the features offered. The sample data that's written and read from the channel is a record (code
                    file <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/ChannelSample/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                在介绍一些特性之前，我们先来看一个示例应用程序。从通道中写入和读取的样本数据是一条记录（代码文件 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/ChannelSample/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0035"><code>public record SomeData(string Text, int Number);</code></pre>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">An unbounded channel is created with the class <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Channel</code> invoking
                    the static method <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CreateUnbounded</code>.
                    This method returns a class that derives from the abstract generic class <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Channel&lt;T&gt;</code>.
                    Optionally, you can pass settings with <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">UnboundedChannelOptions</code>
                    to specify whether only a single writer or a single reader is used. Depending on the settings,
                    different implementations are used regarding thread safety. Be aware that if you set both values to
                    <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">true</code>, you cannot
                    read and write concurrently. The <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Channel&lt;T&gt;</code>
                    class returned from the creation method defines a <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Reader</code> and a <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Writer</code> property
                    that you can use to read from and write to the channel (code file <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/ChannelSample/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用类 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Channel</code>
                                调用静态方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CreateUnbounded</code>
                                创建一个无界通道。该方法返回一个继承自抽象泛型类 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Channel&lt;T&gt;</code>
                                的类。可选地，你可以通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">UnboundedChannelOptions</code>
                                传递设置来指定是否仅使用单个写入者或单个读取者。根据设置的不同，线程安全性会使用不同的实现。请注意，如果你将两个值都设置为 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">true</code>
                                ，则无法同时进行读写操作。创建方法返回的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Channel&lt;T&gt;</code>
                                类定义了 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Reader</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Writer</code>
                                属性，你可以使用这些属性从通道中读取和写入（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/ChannelSample/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0036"><code><b>Channel&lt;SomeData&gt; channel = Channel.CreateUnbounded&lt;SomeData&gt;(</b></code>
<code>  <b>new UnboundedChannelOptions() { SingleReader = false, SingleWriter = true, });</b></code>
<code> </code>
<code>Console.WriteLine("Using the unbounded channel");</code>
<code> </code>
<code>var t1 = ChannelSample.WriteSomeDataAsync(channel.Writer);</code>
<code>var t2 = ChannelSample.ReadSomeDataAsync(channel.Reader);</code>
<code> </code>
<code>await Task.WhenAll(t1, t2);</code></pre>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1"><span aria-label="459" epub:type="pagebreak" id="Page_459"
                        role="doc-pagebreak"
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>When you create a
                    bounded channel, you specify the number of items the channel should hold by specifying the capacity
                    with the constructor. In addition, you specify options with <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">BoundedChannelOptions</code>.
                    Similarly to the unbounded channel, with the bounded channel you can specify whether just one reader
                    or writer is used. Another option you specify is the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">FullMode</code> property
                    with one value of the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">BoundedChannelFullMode</code>
                    enum as discussed next:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                当你创建一个有界通道时，通过构造函数指定容量来指定通道应持有的项目数量。此外，你可以通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">BoundedChannelOptions</code>
                                指定选项。与无界通道类似，对于有界通道，你也可以指定是否仅使用一个读取者或写入者。另一个你指定的选项是 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">FullMode</code>
                                属性，它使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">BoundedChannelFullMode</code>
                                枚举中的一个值，如下一节所述：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0037"><code>Channel&lt;SomeData&gt; channel = Channel.CreateBounded&lt;SomeData&gt;(</code>
<code>  new BoundedChannelOptions(capacity: 10) </code>
<code>  { </code>
<code>    FullMode = BoundedChannelFullMode.Wait, </code>
<code>    SingleWriter = true </code>
<code>  });</code></pre>
                <p id="c17-para-0104" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">What happens if you try to write to the channel, but the
                    channel is already full? Of course, the unbounded channel cannot be full; it's resized until your
                    application runs out of memory. With the bounded channel, there are different scenarios. You can
                    write to the channel with the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryWrite</code> method
                    and the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WriteAsync</code> method.
                    The <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryWrite</code>
                    method returns <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">true</code> or <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">false</code>, depending
                    on whether it's successful. With the default settings, the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryWrite</code> method
                    fails to write if the channel is at its capacity. The <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WriteAsync</code> method
                    just waits until some data is read and there's capacity available to write the data. The default
                    setting with <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">BoundedChannelFullMode</code>
                    is <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Wait</code>.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                如果你尝试向通道写入数据，但通道已经满了会怎样？当然，无界通道不可能满；它会一直扩展直到你的应用程序耗尽内存。对于有界通道，有不同的情况。你可以使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryWrite</code>
                                方法和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WriteAsync</code>
                                方法向通道写入数据。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryWrite</code>
                                方法会根据是否成功返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">true</code> 或
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">false</code>
                                。在默认设置下，如果通道已满， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryWrite</code>
                                方法会失败。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WriteAsync</code>
                                方法会一直等待直到有数据被读取并且有空间可以写入数据。使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">BoundedChannelFullMode</code>
                                的默认设置是 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Wait</code> 。
                            </font>
                        </font>
                    </font>
                </p>
                <p id="c17-para-0105" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Depending on the data you are dealing with, you might prefer
                    other options. For example, if the producer writes new values that make the older data not that
                    interesting anymore, you can decide to drop the oldest data that hasn't been read. You use the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">DropOldest</code> enum
                    value for this setting. You can also drop the newest data (<code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">DropNewest</code>) or
                    drop the data that's just written (<code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">DropWrite</code>). In all
                    these cases, <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryWrite</code> is
                    successful (although the just written data can be dropped), and <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WriteAsync</code>
                    succeeds faster.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                根据你处理的数据类型，你可能更倾向于其他选项。例如，如果生产者写入的新值使得旧数据不再那么有趣，你可以决定丢弃尚未读取的最旧数据。你使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">DropOldest</code>
                                枚举值来设置这个选项。你也可以丢弃最新数据（ <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">DropNewest</code>
                                ）或丢弃刚刚写入的数据（ <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">DropWrite</code>
                                ）。在这些情况下， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryWrite</code>
                                会成功（尽管刚刚写入的数据可能会被丢弃），而 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WriteAsync</code>
                                会更快地成功。</font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><span id="c17-sec-0032"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
                <h3 id="head-3-321" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Writing to the Channel <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">写入 Channel</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">With the sample application, the method <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WriteSomeDataAsync</code>
                    receives the generic <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ChannelWriter</code> with
                    its parameter and writes data to the channel using the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WriteAsync</code> method
                    in a <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">for</code> loop.
                    The <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Complete</code>
                    method informs the channel that no more data is going to be written. To implement a more natural
                    experience with this sample code, a random time up to 50 milliseconds is used as a delay before
                    every write is done in the loop (code file <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/ChannelSample/ChannelSample.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用示例应用程序时，方法 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WriteSomeDataAsync</code>
                                接收通用参数 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ChannelWriter</code>
                                并使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WriteAsync</code>
                                方法在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">for</code>
                                循环中向通道写入数据。方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Complete</code>
                                通知通道不再写入数据。为了使示例代码体验更自然，在循环中的每次写入操作前使用随机时间（最长 50 毫秒）作为延迟（代码文件 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/ChannelSample/ChannelSample.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0038"><code>public static Task WriteSomeDataAsync(ChannelWriter&lt;SomeData&gt; writer) =&gt;</code>
<code>  Task.Run(async () =&gt;</code>
<code>  {</code>
<code>    for (int i = 0; i &lt; 100; i++)</code>
<code>    {</code>
<code>      Random r = new();</code>
<code>      SomeData data = new($"text {i}", i);</code>
<code>      await Task.Delay(r.Next(50));</code>
<code>      <b>await writer.WriteAsync(data);</b></code>
<code>      Console.WriteLine($"Written {data.Text}");</code>
<code>    }</code>
<code>    <b>writer.Complete();</b></code>
<code>    Console.WriteLine("Writing completed");</code>
<code>  });</code></pre>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">With the implementation of the method <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WriteSomeDataWithTryWriteAsync</code>,
                    the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryWrite</code>
                    method is used to write data to the channel. With this method, it needs to be checked whether the
                    writing was successful. Remember, with a bounded channel, if the channel is at its capacity, with
                    <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">BoundedChannelFullMode.Wait</code>,
                    the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryWrite</code>
                    method fails to add the item and returns <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">false</code>
                    :<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在方法 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WriteSomeDataWithTryWriteAsync</code>
                                的实现中，使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryWrite</code>
                                方法向通道写入数据。使用此方法时，需要检查写入是否成功。记住，对于有界通道，如果通道已满，使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">BoundedChannelFullMode.Wait</code>
                                方法， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryWrite</code>
                                方法会失败并返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">false</code>
                                ：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0039"><code>public static Task WriteSomeDataWithTryWriteAsync(ChannelWriter&lt;SomeData&gt; writer) =&gt;</code>
<code>  Task.Run(async () =&gt;</code>
<code>  {</code>
<code>    for (int i = 0; i &lt; 100; i++)<span aria-label="460" epub:type="pagebreak" id="Page_460" role="doc-pagebreak"></span></code>
<code>    {</code>
<code>      Random r = new();</code>
<code>      SomeData data = new($"text {i}", i);</code>
<code>      await Task.Delay(r.Next(50));</code>
<code>      if (!<b>writer.TryWrite(data)</b>)</code>
<code>      {</code>
<code>        Console.WriteLine($"could not write {data.Number}, channel full");</code>
<code>      }</code>
<code>      else</code>
<code>      {</code>
<code>        Console.WriteLine($"Written {data.Text}");</code>
<code>      }</code>
<code>    }</code>
<code>    writer.Complete();</code>
<code>    Console.WriteLine("Writing completed");</code>
<code>  });</code></pre>
            </section>
            <section data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><span id="c17-sec-0033"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
                <h3 id="head-3-322" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Reading from the Channel <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">从通道读取数据</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">With the implementation of the reader, a separate task is
                    created to read from the channel. The <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ReadAsync</code> method
                    waits until some data can be retrieved. Before reading the data, a delay is used. The delay on
                    reading the data is randomly larger than the delay on writing to the queue, which allows you to see
                    that the capacity is filled over time, and items can be dropped (code file <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/ChannelSample/ChannelSample.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在读者实现中，创建一个单独的任务从通道读取数据。方法 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ReadAsync</code>
                                等待直到可以检索到数据。在读取数据前使用延迟。读取数据的延迟随机比队列写入的延迟大，这允许你看到容量随时间被填满，并且可以丢弃项目（代码文件 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/ChannelSample/ChannelSample.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0040"><code>public static Task ReadSomeDataAsync(ChannelReader&lt;SomeData&gt; reader) =&gt;</code>
<code>  Task.Run(async () =&gt;</code>
<code>  {</code>
<code>    try</code>
<code>    {</code>
<code>      Console.WriteLine("Start reading…");</code>
<code>      Random r = new();</code>
<code>      while (true)</code>
<code>      {</code>
<code>        await Task.Delay(r.Next(80));</code>
<code>        <b>var data = await reader.ReadAsync();</b></code>
<code>        Console.WriteLine($"read: {data.Text}, available items: {reader.Count}");</code>
<code>      }</code>
<code>    }</code>
<code>    catch (<b>ChannelClosedException</b>)</code>
<code>    {</code>
<code>      Console.WriteLine("channel closed");</code>
<code>    }</code>
<code>  });</code></pre>
            </section>
            <section data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><span id="c17-sec-0034"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
                <h3 id="head-3-323" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Async Streaming with the Channel <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用 Channel 进行异步流</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1"><a href="c13.xhtml"
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Chapter 13</a>, “Managed
                    and Unmanaged Memory,” covers async streaming. You can use this C# feature with channels as well.
                    The <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ChannelReader</code>
                    method <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ReadAllAsync</code>
                    returns <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">IAsyncEnumerable&lt;T&gt;</code>,
                    which allows using the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">await foreach</code>
                    statement to asynchronously iterate through all the items (code file <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/ChannelSample/ChannelSample.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">第 13 章“托管和非托管内存”涵盖了异步流。你也可以使用这个
                                C#特性与 Channel 一起。方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ReadAllAsync</code>
                                返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">IAsyncEnumerable&lt;T&gt;</code>
                                ，这允许使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">await foreach</code>
                                语句异步迭代所有项目（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/ChannelSample/ChannelSample.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0041"><code>public static Task ReadSomeDataUsingAsyncStreams(ChannelReader&lt;SomeData&gt; reader) =&gt;    </code>
<code>  Task.Run(async () =&gt;</code>
<code>  {<span aria-label="461" epub:type="pagebreak" id="Page_461" role="doc-pagebreak"></span></code>
<code>    try</code>
<code>    {</code>
<code>      Console.WriteLine("Start reading…");</code>
<code>      Random r = new();</code>
<code>      <b>await foreach (var data in reader.ReadAllAsync())</b></code>
<code>      {</code>
<code>        await Task.Delay(r.Next(80));</code>
<code>        Console.WriteLine($"read: {data.Text} available items: {reader.Count}");</code>
<code>      }</code>
<code>    }</code>
<code>    catch (ChannelClosedException)</code>
<code>    {</code>
<code>      Console.WriteLine("channel closed");</code>
<code>    }</code>
<code>  });</code></pre>
            </section>
        </section>
        <section aria-labelledby="head-2-151" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
            <span id="c17-sec-0035" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
            <h2 id="head-2-151" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">TIMERS<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">计时器 </font>
                    </font>
                </font>
            </h2>
            <p id="c17-para-0110" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">With a timer, you can do a repeat invocation of a method. Two
                timers will be covered in this section: the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Timer</code> class from the
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">System.Threading</code>
                namespace and the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">DispatcherTimer</code> for
                XAML-based apps.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">使用计时器，你可以实现方法的重复调用。本节将介绍两种计时器：来自 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">System.Threading</code>
                            命名空间的 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Timer</code>
                            类和用于基于 XAML 应用的 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">DispatcherTimer</code>
                            。</font>
                    </font>
                </font>
            </p>
            <section data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><span id="c17-sec-0036"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
                <h3 id="head-3-324" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Using the Timer Class <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用计时器类</font>
                        </font>
                    </font>
                </h3>
                <p id="c17-para-0111" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">When you use the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">System.Threading.Timer</code>
                    class, you can pass the method to be invoked as the first parameter in the constructor. This method
                    must fulfill the requirements of the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TimerCallback</code>
                    delegate, which defines a <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">void</code> return type
                    and an <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">object</code>
                    parameter. With the second parameter of the constructor, you can pass any object, which is then
                    received with the object argument in the callback method. For example, you can pass an <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Event</code> object to
                    signal the caller. The third parameter specifies the time span during which the callback should be
                    invoked the first time. With the last parameter, you specify the repeating interval for the
                    callback. If the timer should fire only once, set the fourth parameter to the value <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">–1</code>.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">当你使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">System.Threading.Timer</code>
                                类时，可以在构造函数中将待调用的方法作为第一个参数传递。这个方法必须满足 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TimerCallback</code>
                                委托的要求，该委托定义了一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">void</code>
                                返回类型和一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">object</code>
                                参数。通过构造函数的第二个参数，你可以传递任何对象，该对象随后会在回调方法中通过 object 参数接收。例如，你可以传递一个 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Event</code>
                                对象来通知调用者。第三个参数指定了回调方法首次被调用的时间跨度。通过最后一个参数，你可以指定回调的重复间隔。如果计时器只需要触发一次，将第四个参数设置为值 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">–1</code> 。
                            </font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">If the time interval should be changed after creating the
                    <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Timer</code> object,
                    you can pass new values with the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Change</code> method
                    (code file <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/TimersSample/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">如果要在创建 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Timer</code>
                                对象后更改时间间隔，你可以通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Change</code>
                                方法传递新值（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/TimersSample/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0042"><code>private static void ThreadingTimer()</code>
<code>{</code>
<code>  void TimeAction(object? o) =&gt;</code>
<code>    Console.WriteLine($"System.Threading.Timer {DateTime.Now:T}");  </code>
<code> </code>
<code>  <b>using Timer t1 = new(</b></code>
<code>    <b>TimeAction,</b> </code>
<code>    <b>null,</b></code>
<code>    <b>dueTime: TimeSpan.FromSeconds(2),</b> </code>
<code>    <b>period: TimeSpan.FromSeconds(3)))</b></code>
<code>  {</code>
<code>    Task.Delay(15000).Wait();</code>
<code>  }</code>
<code>}</code></pre>
            </section>
            <section data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><span id="c17-sec-0037"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
                <h3 id="head-3-325" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">WinUI Dispatcher Timer<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">WinUI 调度计时器</font>
                        </font>
                    </font>
                </h3>
                <p id="c17-para-0113" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">The <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">DispatcherTimer</code>
                    from the namespace <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Microsoft.UI.Xaml</code>
                    (for WinUI apps) is a timer for XAML-based apps where the event handler is called within the UI
                    thread; thus, it is possible to directly access user interface elements.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">来自命名空间 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Microsoft.UI.Xaml</code>
                                （用于 WinUI 应用程序）的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">DispatcherTimer</code>
                                是一个基于 XAML 的应用程序的计时器，其中事件处理程序在 UI 线程中调用；因此，可以直接访问用户界面元素。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1"><span aria-label="462" epub:type="pagebreak" id="Page_462"
                        role="doc-pagebreak"
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>The sample
                    application to demonstrate <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">DispatcherTimer</code> is
                    a Windows app that shows the hand of a clock that switches every second. The following XAML code
                    defines the commands that enable you to start and stop the clock (code file <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/WindowsAppTimer/MainWindow.xaml</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">用于演示 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">DispatcherTimer</code>
                                的示例应用程序是一个 Windows 应用程序，它显示一个每秒切换的时钟指针。以下 XAML 代码定义了启动和停止时钟的命令（代码文件 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/WindowsAppTimer/MainWindow.xaml</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0043"><code>&lt;CommandBar IsOpen="True"&gt;</code>
<code>  &lt;AppBarButton Icon="Play" <b>Click="{x:Bind OnStartTimer}"</b> Label="Play"/&gt;</code>
<code>  &lt;AppBarButton Icon="Stop" <b>Click="{x:Bind OnStopTimer}"</b> Label="Stop"/&gt;</code>
<code>&lt;/CommandBar&gt;</code>
<code>&lt;Page.TopAppBar&gt;</code></pre>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">The hand of the clock is defined using the shape <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Line</code>. To rotate
                    the line, you use a <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">RotateTransform</code>
                    element that is bound to the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TimerAngle</code>
                    property:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">时钟指针使用形状 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Line</code>
                                定义。要旋转线条，您使用一个绑定到 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TimerAngle</code>
                                属性的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">RotateTransform</code>
                                元素：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0044"><code>&lt;Canvas Width="300" Height="300" Grid.Row="1"&gt;</code>
<code>  &lt;Ellipse Width="10" Height="10" Fill="Red" Canvas.Left="145" Canvas.Top="145"/&gt;</code>
<code>    &lt;Line Canvas.Left="150" Canvas.Top="150" Fill="Green" StrokeThickness="3" </code>
<code>      Stroke="Blue" X1="0" Y1="0" X2="120" Y2="0"&gt;</code>
<code>      &lt;Line.RenderTransform&gt;</code>
<code>        &lt;RotateTransform CenterX="0" CenterY="0" <b>Angle="{x:Bind TimerAngle, Mode=OneWay}"</b> </code>
<code>          x:Name="rotate"/&gt;</code>
<code>      &lt;/Line.RenderTransform&gt;</code>
<code>    &lt;/Line&gt;</code>
<code>&lt;/Canvas&gt;</code></pre>
                <aside data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                    <div class="top hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                        <p id="c17-para-0117" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">NOTE</b> <i
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WinUI
                                applications and the interface </i> <code
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">INotifyPropertyChanged</code>
                            <i data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"> are introduced in
                                <a href="c29.xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Chapter
                                    29</a>, “Windows Apps.” XAML shapes are explained in <a href="c31.xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Chapter
                                    31</a>, “Styling Windows Apps.”</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意：WinUI 应用程序和界面 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">INotifyPropertyChanged</code>
                                        在《Windows Apps》第 29 章中介绍。XAML 形状在第 31 章《样式化 Windows 应用程序》中解释。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                            <hr />
                        </div>
                    </section>
                </aside>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">The <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">DispatcherTimer</code>
                    object is created in the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">MainWindow</code> class.
                    In the constructor, the handler method <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">OnTick</code> is assigned
                    to the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Tick</code>
                    event, and the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Interval</code> is
                    specified to be one second. The timer is started in the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">OnTimer</code> method—the
                    method that gets called when the user clicks the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Play</code> button in the
                    <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CommandBar</code>. When
                    the tick event is fired, in the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">OnTick</code> method, the
                    property <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TimerAngle</code> gets
                    updated. This property fires the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">PropertyChanged</code>
                    event that's defined by the interface <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">INotifyPropertyChanged</code>
                    to bring this update to the user interface (code file <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/WindowsAppTimer/MainPage.xaml.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">DispatcherTimer</code>
                                对象在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">MainWindow</code>
                                类中创建。在构造函数中，将处理方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">OnTick</code>
                                分配给 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Tick</code>
                                事件，并将 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Interval</code>
                                指定为 1 秒。在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">OnTimer</code>
                                方法中启动计时器——该方法在用户点击 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CommandBar</code>
                                中的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Play</code>
                                按钮时被调用。当 tick 事件被触发时，在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">OnTick</code>
                                方法中，属性 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TimerAngle</code>
                                被更新。此属性会触发由接口 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">INotifyPropertyChanged</code>
                                定义的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">PropertyChanged</code>
                                事件，以将此更新传递给用户界面（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ParallelSamples/WindowsAppTimer/MainPage.xaml.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0045"><code>public sealed partial class MainWindow : Window, INotifyPropertyChanged</code>
<code>{</code>
<code>  <b>private DispatcherTimer _timer = new();</b></code>
<code> </code>
<code>  public event PropertyChangedEventHandler? PropertyChanged;</code>
<code> </code>
<code>  public MainWindow()</code>
<code>  {</code>
<code>    this.Title = "WinUI Dispatcher Timer App";</code>
<code>    this.InitializeComponent();</code>
<code>    <b>_timer.Tick += OnTick;</b></code>
<code>    <b>_timer.Interval = TimeSpan.FromSeconds(1);</b></code>
<code>  }</code>
<code> </code>
<code>  <b>private void OnStartTimer() =&gt; _timer.Start();</b></code>
<code> </code>
<code>  private double _timerAngle;</code>
<code>  public double TimerAngle<span aria-label="463" epub:type="pagebreak" id="Page_463" role="doc-pagebreak"></span></code>
<code>  {</code>
<code>    get =&gt; _timerAngle;</code>
<code>    set</code>
<code>    {</code>
<code>      if (!EqualityComparer&lt;double&gt;.Default.Equals(_timerAngle, value))</code>
<code>      {</code>
<code>        _timerAngle = value;</code>
<code>        PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(nameof(TimerAngle)));</code>
<code>      }</code>
<code>    }</code>
<code>  }</code>
<code> </code>
<code>  <b>private void OnTick(object? sender, object e) =&gt;</b> </code>
<code>    <b>TimerAngle = (TimerAngle + 6) % 360;</b></code>
<code> </code>
<code> </code>
<code>  <b>private void OnStopTimer() =&gt; _timer.Stop();</b></code>
<code>}</code></pre>
                <p id="c17-para-0119" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">When you run the application, the clock hand is shown (see <a
                        href="#c17-fig-0001" id="R_c17-fig-0001"
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Figure 17-1</a>).<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">运行应用程序时，会显示时钟指针（见图 17-1）。</font>
                        </font>
                    </font>
                </p>
                <figure data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"> <img
                        alt="Snapshot of a window titled, Win U I dispatcher timer app." class="center"
                        src="images/c17f001.png" />
                    <figcaption data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                        <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><span
                                class="figureLabel"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><a
                                    href="#R_c17-fig-0001" id="c17-fig-0001" role="doc-backlink"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><b
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                                        data-immersive-translate-paragraph="1">FIGURE 17-1<font
                                            class="notranslate immersive-translate-target-wrapper"
                                            data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                            <font class="notranslate"
                                                data-immersive-translate-translation-element-mark="1">  </font>
                                            <font
                                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                                data-immersive-translate-translation-element-mark="1">
                                                <font
                                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                                    data-immersive-translate-translation-element-mark="1">图 17-1</font>
                                            </font>
                                        </font></b></a></span></p>
                    </figcaption>
                </figure>
            </section>
        </section>
        <section aria-labelledby="head-2-152" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
            <span id="c17-sec-0039" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
            <h2 id="head-2-152" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">THREADING ISSUES<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">线程问题</font>
                    </font>
                </font>
            </h2>
            <p id="c17-para-0120" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">Programming with multiple threads is challenging. When starting
                multiple threads that access the same data, you can get intermittent problems that are hard to find. The
                problems are the same whether you use tasks, Parallel LINQ, or the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code> class. To
                avoid getting into trouble, you must pay attention to synchronization issues and the problems that can
                occur with multiple threads. This section covers two in particular: race conditions and deadlocks.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            多线程编程具有挑战性。当启动多个访问相同数据的线程时，你可能会遇到间歇性问题，这些问题难以查找。无论你使用任务、Parallel LINQ 还是 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code>
                            类，这些问题都是一样的。为了避免陷入麻烦，你必须注意同步问题以及多线程可能出现的其他问题。本节将涵盖两个特别的情况：竞态条件和死锁。</font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0121" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1"><span aria-label="464" epub:type="pagebreak" id="Page_464"
                    role="doc-pagebreak" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>A
                race condition results in inconsistent outcome of the application where results are invalid, and the
                issue only happens from time to time. Deadlocks happen when two threads block each other, and none of
                them can continue.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            竞态条件会导致应用程序结果不一致，结果无效，并且这个问题只是偶尔发生。死锁发生在两个线程互相阻塞，并且它们都无法继续执行时。</font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0122" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">You can start the sample application <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ThreadingIssues</code> with
                command-line arguments to simulate either race conditions or deadlocks.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">你可以使用命令行参数启动示例应用程序 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ThreadingIssues</code>
                            来模拟竞态条件或死锁。</font>
                    </font>
                </font>
            </p>
            <section data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><span id="c17-sec-0040"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
                <h3 id="head-3-326" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Race Conditions <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">竞态条件</font>
                        </font>
                    </font>
                </h3>
                <p id="c17-para-0123" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">A race condition can occur if two or more threads access the
                    same objects and access to the shared state is not synchronized. To demonstrate a race condition,
                    the following example defines the class <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">StateObject</code> with
                    an <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">int</code> field and
                    the method <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ChangeState</code>. In
                    the implementation of <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ChangeState</code>, the
                    state variable is verified to determine whether it contains 5; if it does, the value is incremented.
                    <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Trace.Assert</code> is
                    the next statement, which immediately verifies that state now contains the value 6.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                如果两个或多个线程访问相同的对象，并且对共享状态的访问没有同步，就可能出现竞态条件。为了演示竞态条件，以下示例定义了具有 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">int</code>
                                字段和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ChangeState</code>
                                方法的类 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">StateObject</code>
                                。在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ChangeState</code>
                                的实现中，会验证状态变量以确定其是否包含 5；如果包含，则值会递增。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Trace.Assert</code>
                                是下一条语句，它会立即验证状态现在是否包含值 6。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">After incrementing by 1 a variable that contains the value 5,
                    you might assume that the variable now has the value 6; but this is not necessarily the case. For
                    example, if one thread has just completed the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">if (_state == 5)</code>
                    statement, it might be preempted, with the scheduler running another thread. The second thread now
                    goes into the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">if</code>
                    body and, because the state still has the value 5, the state is incremented by 1 to 6. The first
                    thread is then scheduled again, and in the next statement, the state is incremented to 7. This is
                    when the race condition occurs, and the assert message is shown (code file <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/ThreadingIssues/StateObject.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在将包含值 5 的变量的值增加 1 后，你可能认为该变量的值现在是
                                6；但这并不一定是事实。例如，如果一个线程刚刚完成了 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">if (_state == 5)</code>
                                语句，它可能会被抢占，调度器会运行另一个线程。第二个线程现在进入 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">if</code>
                                的主体，并且由于状态仍然具有值 5，状态会递增到 6。然后第一个线程再次被调度，在接下来的语句中，状态会递增到 7。这就是竞态条件发生的时候，并且会显示断言消息（代码文件
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/ThreadingIssues/StateObject.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0046"><code>public class StateObject</code>
<code>{</code>
<code>  private int _state = 5;</code>
<code>  public void ChangeState(int loop)</code>
<code>  {</code>
<code>    <b>if (_state == 5)</b></code>
<code>    <b>{</b></code>
<code>      <b>_state++;</b></code>
<code>      if (_state != 6)</code>
<code>      {</code>
<code>        Console.WriteLine($"Race condition occurred after {loop} loops");</code>
<code>        Trace.Fail("race condition");</code>
<code>      }</code>
<code>    }</code>
<code>    _state = 5;</code>
<code>  }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">You can verify this by defining a method for a task. The
                    method <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">RaceCondition</code> of
                    the class <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SampleTask</code> gets a
                    <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">StateObject</code> as a
                    parameter. Inside an endless <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">while</code> loop, the
                    <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ChangeState</code>
                    method is invoked. The variable <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">i</code> is used just to
                    show the loop number in the assert message (code file <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/ThreadingIssues/TaskWithRaceCondition.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">你可以通过定义一个任务的方法来验证这一点。类 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SampleTask</code>
                                的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">RaceCondition</code>
                                方法获取一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">StateObject</code>
                                作为参数。在一个无尽的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">while</code>
                                循环中，调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ChangeState</code>
                                方法。变量 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">i</code>
                                仅用于在断言消息中显示循环次数（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/ThreadingIssues/TaskWithRaceCondition.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0047"><code>public class TaskWithRaceCondition</code>
<code>{</code>
<code>  public void RaceCondition(object o)</code>
<code>  {</code>
<code>    if (o is not StateObject state) </code>
<code>      throw new ArgumentException("o must be a StateObject");</code>
<code>    else</code>
<code>    {</code>
<code>      Console.WriteLine("starting RaceCondition - when does the issue occur?");</code>
<code> <span aria-label="465" epub:type="pagebreak" id="Page_465" role="doc-pagebreak"></span></code>
<code>      int i = 0;</code>
<code>      while (true)</code>
<code>      {</code>
<code>        if (!state.ChangeState(i++))</code>
<code>        {</code>
<code>          i = 0;</code>
<code>        }</code>
<code>      }</code>
<code>    }</code>
<code>  }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">In the method <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">RaceConditons</code>, a
                    new <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">StateObject</code>
                    is created that is shared among all the tasks. <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code> objects are
                    created by invoking the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">RaceCondition</code>
                    method with the lambda expression that is passed to the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Run</code> method of the
                    <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>. The main
                    thread then waits for user input. However, there's a good chance that the program will halt before
                    reading user input because a race condition will happen (code file <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/ThreadingIssues/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">RaceConditons</code>
                                方法中，创建了一个在所有任务之间共享的新 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">StateObject</code>
                                。通过调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">RaceCondition</code>
                                方法并传递给 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code> 的
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Run</code>
                                方法的 lambda 表达式来创建 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                                对象。主线程随后等待用户输入。然而，程序很可能在读取用户输入之前就停止运行，因为会发生竞争条件（代码文件 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/ThreadingIssues/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0048"><code>public void RaceConditions()</code>
<code>{</code>
<code>  StateObject state = new();</code>
<code>  for (int i = 0; i &lt; 2; i++)</code>
<code>  {</code>
<code>    Task.Run(() =&gt; new TaskWithRaceCondition().RaceCondition(state));</code>
<code>  }</code>
<code>}</code></pre>
                <p id="c17-para-0127" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">When you start the program, you get race conditions. How long
                    it takes until the first race condition happens depends on your system and whether you build the
                    program as a release build or a debug build. With a release build, the problem happens more often
                    because the code is optimized. If you have multiple CPUs in your system or dual-/quad-core CPUs,
                    where multiple threads can run concurrently, the problem also occurs more often than with a
                    single-core CPU. The problem occurs with a single-core CPU because thread scheduling is preemptive,
                    but the problem doesn't occur that often.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                当你启动程序时，你会遇到竞态条件。第一个竞态条件出现需要多长时间取决于你的系统和你是以发布版本还是调试版本构建程序。以发布版本构建时，问题更频繁发生，因为代码经过了优化。如果你的系统有多个
                                CPU 或双核/四核 CPU，多个线程可以并发运行，问题也比单核 CPU 时更频繁发生。单核 CPU 也会出现这个问题，因为线程调度是抢占式的，但这种情况不太常见。
                            </font>
                        </font>
                    </font>
                </p>
                <p id="c17-para-0128" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">In one run of the program on my system, I saw the first error
                    after 18,205 loops; after resetting to continue looping, the next error manifested after 67,411
                    loops. You always get different results.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在我的系统上运行程序的一次测试中，我在第 18,205
                                次循环后看到了第一个错误；在重置以继续循环后，下一个错误出现在第 67,411 次循环时。你总是得到不同的结果。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">You can avoid the problem by locking the shared object. You
                    do this inside the thread by locking the variable state, which is shared among the threads, with the
                    <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code> statement,
                    as shown in the following example. Only one thread can exist inside the lock block for the state
                    object. Because this object is shared among all threads, a thread must wait at the lock if another
                    thread has the lock for state. As soon as the lock is accepted, the thread owns the lock and gives
                    it up at the end of the lock block. If every thread changing the object referenced with the state
                    variable is using a lock, the race condition no longer occurs:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">你可以通过锁定共享对象来避免这个问题。你可以在线程内部通过使用
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code>
                                语句锁定在所有线程之间共享的变量 state，如下面的示例所示。只有一个线程可以存在于 state 对象的锁块内部。因为这个对象在所有线程之间共享，所以如果另一个线程已经持有
                                state 的锁，当前线程必须在锁处等待。一旦获得锁，线程就拥有这个锁，并在锁块结束时释放它。如果所有使用 state 变量引用的对象的线程都在使用锁，那么竞争条件将不再发生：
                            </font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0049"><code>public class TaskWithRaceConditions</code>
<code>{</code>
<code>  public void RaceCondition(object o)</code>
<code>  {</code>
<code>    if (o is not StateObject state) </code>
<code>      throw new ArgumentException("o must be a StateObject");</code>
<code>    else</code>
<code>    {</code>
<code>      int i = 0;</code>
<code>      while (true)</code>
<code>      {</code>
<code>        <b>lock (state) // no race condition with this lock</b></code>
<code>        {<span aria-label="466" epub:type="pagebreak" id="Page_466" role="doc-pagebreak"></span></code>
<code>          state.ChangeState(i++);</code>
<code>        }</code>
<code>      }</code>
<code>    }</code>
<code>  }</code>
<code>}</code></pre>
                <aside data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                    <div class="top hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                        <p id="c17-para-0131" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">NOTE</b> <i
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">With the
                                downloaded sample code, you need to uncomment the </i> <code
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code> <i
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"> statements for
                                solving the issues with race conditions.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意 使用下载的示例代码时，需要取消注释 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code>
                                        语句以解决与竞态条件相关的问题。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                            <hr />
                        </div>
                    </section>
                </aside>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Instead of performing the lock when using the shared object,
                    you can make the shared object thread-safe. In the following code, the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ChangeState</code> method
                    contains a <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code>
                    statement. Because you cannot lock the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">state</code> variable
                    itself (only reference types can be used for a lock), the variable _
                    <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">sync</code> of type
                    <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">object</code> is
                    defined and used with the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code> statement. If
                    a lock is done using the same synchronization object every time the value state is changed, race
                    conditions no longer happen:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在使用共享对象时，你可以使共享对象线程安全。在以下代码中，
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ChangeState</code>
                                方法包含一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code>
                                语句。由于不能直接锁定 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">state</code>
                                变量本身（只有引用类型可用于锁定），定义了类型为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">object</code>
                                的变量 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">sync</code>
                                ，并使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code>
                                语句进行锁定。如果每次更改值状态时都使用相同的同步对象进行锁定，则不再发生竞态条件：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0050"><code>public class StateObject</code>
<code>{</code>
<code>  private int _state = 5;</code>
<code>  <b>private object _sync = new();</b></code>
<code>  public void ChangeState(int loop)</code>
<code>  {</code>
<code>    <b>lock (_sync)</b></code>
<code>    {</code>
<code>      if (_state == 5)</code>
<code>      {</code>
<code>        _state++;</code>
<code>        if (_state != 6)</code>
<code>        {</code>
<code>          Console.WriteLine($"Race condition occurred after {loop} loops");</code>
<code>          Trace.Fail($"race condition at {loop}");</code>
<code>        }</code>
<code>      }</code>
<code>      _state = 5;</code>
<code>    }</code>
<code>  }</code>
<code>}</code></pre>
            </section>
            <section data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><span id="c17-sec-0042"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
                <h3 id="head-3-327" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Deadlocks <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">死锁</font>
                        </font>
                    </font>
                </h3>
                <p id="c17-para-0133" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Too much locking can get you in trouble as well. In a
                    deadlock, at least two threads halt and wait for each other to release a lock. As both threads wait
                    for each other, a deadlock occurs, and the threads wait endlessly.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                过多的锁定也会带来麻烦。在死锁中，至少有两个线程停止并等待对方释放锁。由于两个线程都在等待对方，就会发生死锁，线程会无限期地等待。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">To demonstrate deadlocks, the following code instantiates two
                    objects of type <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">StateObject</code> and
                    passes them with the constructor of the <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SampleTask</code> class.
                    Two tasks are created: one task running the method <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Deadlock1</code>, and the
                    other task running the method <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Deadlock2</code> (code
                    file <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/ThreadingIssues/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">为了演示死锁，以下代码实例化了两个类型为 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">StateObject</code>
                                的对象，并将它们传递给 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SampleTask</code>
                                类的构造函数。创建了两个任务：一个任务运行方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Deadlock1</code>
                                ，另一个任务运行方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Deadlock2</code>
                                （代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/ThreadingIssues/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0051"><code>StateObject state1 = new();</code>
<code>StateObject state2 = new();</code>
<code>new Task(new SampleTask(state1, state2).Deadlock1).Start();</code>
<code>new Task(new SampleTask(state1, state2).Deadlock2).Start();</code></pre>
                <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1"><span aria-label="467" epub:type="pagebreak" id="Page_467"
                        role="doc-pagebreak"
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>The methods <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Deadlock1</code> and
                    <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Deadlock2</code> now
                    change the state of two objects: <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">s1</code> and <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">s2</code>. That's why two
                    locks are generated. <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Deadlock1</code> first
                    does a lock for <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">s1</code> and next for
                    <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">s2</code>. <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Deadlock2</code> first
                    does a lock for <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">s2</code> and then for
                    <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">s1</code>.
                    Occasionally, the lock for <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">s1</code> in <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Deadlock1</code> is
                    resolved. Next, a thread switch occurs, and <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Deadlock2</code> starts
                    to run and gets the lock for <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">s2</code>. The second
                    thread now waits for the lock of <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">s1</code>. Because it
                    needs to wait, the thread scheduler schedules the first thread again, which now waits for <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">s2</code>. Both threads
                    wait and don't release the lock as long as the lock block is not ended. This is a typical deadlock
                    (code file <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/ThreadingIssues/TaskWithDeadlock.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Deadlock1</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Deadlock2</code>
                                方法现在改变两个对象 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">s1</code> 和
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">s2</code>
                                的状态。这就是为什么生成了两个锁。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Deadlock1</code>
                                首先对 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">s1</code>
                                加锁，然后对 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">s2</code> 加锁。
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Deadlock2</code>
                                首先对 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">s2</code>
                                加锁，然后对 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">s1</code>
                                加锁。偶尔， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Deadlock1</code>
                                中的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">s1</code>
                                锁被解决。接下来，发生线程切换， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Deadlock2</code>
                                开始运行并获取 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">s2</code>
                                的锁。现在第二个线程等待 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">s1</code>
                                的锁。因为它需要等待，线程调度器再次调度第一个线程，现在它等待 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">s2</code>
                                。两个线程都等待，直到锁块结束才释放锁。这是一个典型的死锁（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/ThreadingIssues/TaskWithDeadlock.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c17-code-0052"><code>public class TaskWithDeadlock</code>
<code>{</code>
<code>  public SampleTask(StateObject s1, StateObject s2) = (_s1, _s2) = (s1, s2);</code>
<code>  private readonly StateObject _s1;</code>
<code>  private readonly StateObject _s2;</code>
<code> </code>
<code>  public void Deadlock1()</code>
<code>  {</code>
<code>    int i = 0;</code>
<code>    while (true)</code>
<code>    {</code>
<code>      lock (_s1)</code>
<code>      {</code>
<code>        lock (_s2)</code>
<code>        {</code>
<code>          _s1.ChangeState(i);</code>
<code>          _s2.ChangeState(i++);</code>
<code>          Console.WriteLine($"still running, {i}");</code>
<code>        }</code>
<code>      }</code>
<code>    }</code>
<code>  }</code>
<code> </code>
<code>  public void Deadlock2()</code>
<code>  {</code>
<code>    int i = 0;</code>
<code>    while (true)</code>
<code>    {</code>
<code>      lock (_s2)</code>
<code>      {</code>
<code>        lock (_s1)</code>
<code>        {</code>
<code>          _s1.ChangeState(i);</code>
<code>          _s2.ChangeState(i++);</code>
<code>          Console.WriteLine($"still running, {i}");</code>
<code>        }</code>
<code>      }</code>
<code>    }</code>
<code>  }</code>
<code>}</code></pre>
                <p id="c17-para-0136" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">As a result, the program runs some loops and soon becomes
                    unresponsive. The message “still running” is written a few times to the console. Again, how soon the
                    problem occurs depends on your system configuration, and the result will vary.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                结果，程序运行一些循环后很快变得无响应。消息“仍在运行”几次写入控制台。同样，问题的发生时间取决于您的系统配置，结果会有所不同。</font>
                        </font>
                    </font>
                </p>
                <p id="c17-para-0137" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">A deadlock problem is not always as obvious as it is here.
                    One thread locks _
                    <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">s1</code> and then
                    <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">_s2</code>
                    ; the other thread locks <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">_s2</code> and then <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">_s1</code>. In this case,
                    you just need to change the order so that both threads perform the locks in <span aria-label="468"
                        epub:type="pagebreak" id="Page_468" role="doc-pagebreak"
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>the same order. In
                    a bigger application, the locks might be hidden deeply inside a method, thread 1 locks <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">_s1</code> and <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">_s2</code>, thread 2
                    locks <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">_s2</code> and
                    <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">_s3</code>, and thread
                    3 locks <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">_s3</code> and
                    <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">_s1</code>.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">死锁问题并不总是像这里这么明显。一个线程锁定 _ <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">s1</code>
                                然后调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">_s2</code>
                                ；另一个线程锁定 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">_s2</code>
                                然后调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">_s1</code>
                                。在这种情况下，您只需要改变顺序，使两个线程以相同的顺序执行锁定。在一个更大的应用程序中，锁可能深藏在方法内部，线程 1 锁定 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">_s1</code> 和
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">_s2</code>
                                ，线程 2 锁定 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">_s2</code> 和
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">_s3</code>
                                ，线程 3 锁定 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">_s3</code> 和
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">_s1</code> 。
                            </font>
                        </font>
                    </font>
                </p>
                <p id="c17-para-0138" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">You can prevent deadlocks by reducing the number of lock
                    objects (for example, one lock object to synchronize access to state <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">_s1</code> and <code
                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">_s2</code>), by designing
                    a good lock order in the initial architecture of the application, and by defining timeouts for the
                    locks, as demonstrated in the next section.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">你可以通过减少锁对象的数量（例如，使用一个锁对象来同步对状态
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">_s1</code> 和
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">_s2</code>
                                的访问）、在应用程序的初始架构中设计良好的锁顺序，以及为锁定义超时来防止死锁，如下一节所示。</font>
                        </font>
                    </font>
                </p>
            </section>
        </section>
        <section aria-labelledby="head-2-153" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
            <span id="c17-sec-0043" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
            <h2 id="head-2-153" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">INTERLOCKED</h2>
            <p id="c17-para-0139" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">Instead of using the lock keyword for simple scenarios, there's a
                faster option. The <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Interlocked</code> class is
                used to make simple statements for variables atomic. <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">i</code>
                ++ is not thread-safe. It consists of getting a value from the memory, incrementing the value by <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">1</code>, and storing the
                value back in memory. These operations can be interrupted by the thread scheduler. The <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Interlocked</code> class
                provides methods for incrementing, decrementing, exchanging, and reading values in a thread-safe manner.
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">对于简单场景，除了使用锁关键字外，还有一个更快的选项。 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Interlocked</code>
                            类用于使变量的简单操作原子化。 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">i</code> ++
                            不是线程安全的。它包括从内存中获取值、将值增加 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">1</code>
                            ，然后将值存回内存。这些操作可能被线程调度器中断。 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Interlocked</code>
                            类提供了以线程安全方式递增、递减、交换和读取值的方法。</font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0140" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">Using the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Interlocked</code> class is
                much faster than other synchronization techniques. However, you can use it only for simple
                synchronization issues.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">使用 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Interlocked</code>
                            类比其他同步技术快得多。但是，你只能用它来解决简单的同步问题。</font>
                    </font>
                </font>
            </p>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">For example, instead of performing incrementing inside a <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code> statement as
                shown here:<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">例如，不要在 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code>
                            语句中执行递增操作，就像这里展示的那样：</font>
                    </font>
                </font>
            </p>
            <pre id="c17-code-0053"><code>public int State</code>
<code>{</code>
<code>  get</code>
<code>  {</code>
<code>    lock (this)</code>
<code>    {</code>
<code>      return ++_state;</code>
<code>    }</code>
<code>  }</code>
<code>}</code></pre>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">you can use <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Interlocked.Increment</code>,
                which is faster:<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">你可以使用 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Interlocked.Increment</code>
                            ，它更快：</font>
                    </font>
                </font>
            </p>
            <pre id="c17-code-0054"><code>public int State</code>
<code>{</code>
<code>  get =&gt; <b>Interlocked.Increment(ref _state);</b></code>
<code>}</code></pre>
        </section>
        <section aria-labelledby="head-2-154" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
            <span id="c17-sec-0044" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
            <h2 id="head-2-154" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">MONITOR</h2>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">The C# compiler resolves the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code> statement to use
                the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Monitor</code> class.
                The following <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code>
                statement<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">C# 编译器将 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code>
                            语句解析为使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Monitor</code>
                            类。以下 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code> 语句
                        </font>
                    </font>
                </font>
            </p>
            <pre id="c17-code-0055"><code>lock (obj)</code>
<code>{</code>
<code>  // synchronized region for obj</code>
<code>}</code></pre>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">is resolved to invoke the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Enter</code> method, which
                waits until the thread gets the lock of the object. Only one thread at a time may be the owner of the
                object lock. As soon as the lock is resolved, the thread can enter the synchronized section. The <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Exit</code> method of the
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Monitor</code> class
                releases the lock. The compiler puts the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Exit</code> method into a
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">finally</code> handler of a
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">try</code> block so that
                the lock is also released if an exception is thrown:<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">当确定调用 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Enter</code>
                            方法时，该方法会等待线程获取对象的锁。任何时候只能有一个线程拥有对象锁。一旦锁被获取，线程就可以进入同步区域。 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Monitor</code> 类的
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Exit</code>
                            方法会释放锁。编译器将 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Exit</code> 方法放入
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">try</code> 块的
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">finally</code>
                            处理器中，以便在抛出异常时也能释放锁：</font>
                    </font>
                </font>
            </p>
            <pre id="c17-code-0056"><code>Monitor.Enter(obj);</code>
<code>try<span aria-label="469" epub:type="pagebreak" id="Page_469" role="doc-pagebreak"></span></code>
<code>{</code>
<code>  // synchronized region for obj</code>
<code>}</code>
<code>finally</code>
<code>{</code>
<code>  Monitor.Exit(obj);</code>
<code>}</code></pre>
            <aside data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                <div class="top hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                    <hr />
                </div>
                <section class="feature2" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                    <p id="c17-para-0146" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                        data-immersive-translate-paragraph="1"><b
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">NOTE</b> <i
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"><a href="c10.xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Chapter 10</a>,
                            “Errors and Exceptions,” covers the </i> <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">try</code> <i
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">/</i> <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">finally</code> <i
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"> block.</i>
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">注意：第 10 章“错误和异常”将介绍 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">try</code>
                                    / <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">finally</code>
                                    块。</font>
                            </font>
                        </font>
                    </p>
                    <div class="bottom hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                        <hr />
                    </div>
                </section>
            </aside>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">The <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Monitor</code> class has a
                big advantage over the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code> statement of C#:
                you can add a timeout value for waiting to get the lock. Therefore, instead of endlessly waiting to get
                the lock, you can use the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryEnter</code> method shown
                in the following example, passing a timeout value that defines the maximum amount of time to wait for
                the lock. If the lock for <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">obj</code> is acquired, <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryEnter</code> sets the
                Boolean <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ref</code>
                parameter to <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">true</code>
                and performs synchronized access to the state guarded by the object <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">obj</code>. If <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">obj</code> is locked for more
                than 500 milliseconds by another thread, <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryEnter</code> sets the
                variable <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">_lockTaken</code>
                to <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">false</code>, and the
                thread does not wait any longer but is used to do something else. Maybe later, the thread can try to
                acquire the lock again.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1"> <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Monitor</code> 类比
                            C# 的 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code>
                            语句有一个很大的优势：你可以为等待获取锁添加超时值。因此，你不必无休止地等待获取锁，而是可以使用以下示例中所示的 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryEnter</code>
                            方法，传递一个超时值来定义等待锁的最大时间。如果获取了 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">obj</code> 的锁，
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryEnter</code>
                            将布尔参数 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ref</code> 设置为
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">true</code> 并对由对象
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">obj</code>
                            保护的资源进行同步访问。如果 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">obj</code>
                            被另一个线程锁定了超过 500 毫秒， <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryEnter</code>
                            将变量 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">_lockTaken</code>
                            设置为 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">false</code>
                            ，线程不再等待，而是去做其他事情。也许稍后，线程可以再次尝试获取锁。</font>
                    </font>
                </font>
            </p>
            <pre id="c17-code-0057"><code>bool _lockTaken = false;</code>
<code>Monitor.TryEnter(_obj, 500, ref _lockTaken);</code>
<code>if (_lockTaken)</code>
<code>{</code>
<code>  try</code>
<code>  {</code>
<code>    // acquired the lock</code>
<code>    // synchronized region for obj</code>
<code>  }</code>
<code>  finally</code>
<code>  {</code>
<code>    Monitor.Exit(obj);</code>
<code>  }</code>
<code>}</code>
<code>else</code>
<code>{</code>
<code>  // didn't get the lock, do something else</code>
<code>}</code></pre>
        </section>
        <section aria-labelledby="head-2-155" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
            <span id="c17-sec-0046" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
            <h2 id="head-2-155" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">SPINLOCK</h2>
            <p id="c17-para-0148" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">If the overhead on object-based lock objects (<code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Monitor</code>) would be too
                high because of garbage collection, you can use the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SpinLock</code> struct. <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SpinLock</code> is designed
                with the idea that thread context switches are expensive operations, and for short locks it's faster to
                use CPU cycles (spin) for the wait. With this architecture, <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SpinLock</code> is useful if
                you have many locks (for example, for every node in a list) and hold times are always extremely short.
                You should avoid holding more than one <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SpinLock</code>, and don't
                call anything that might block.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">如果基于对象的锁对象（ <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Monitor</code>
                            ）由于垃圾回收导致的开销过高，你可以使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SpinLock</code>
                            结构。 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SpinLock</code>
                            是基于线程上下文切换是昂贵操作这一理念设计的，对于短锁来说，使用 CPU 周期（自旋）等待更快。在这种架构下， <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SpinLock</code>
                            在你拥有许多锁（例如，列表中的每个节点）且持有时间总是极短时非常有用。你应该避免持有超过一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SpinLock</code>
                            ，并且不要调用任何可能阻塞的操作。</font>
                    </font>
                </font>
            </p>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">Other than the architectural differences, <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SpinLock</code> is similar in
                usage to the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Monitor</code>
                class. You acquire the lock with <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Enter</code> or <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryEnter</code> and release
                the lock with <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Exit</code>.
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SpinLock</code> also offers
                two properties to provide information about whether it is currently locked: <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">IsHeld</code> and <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">IsHeldByCurrentThread</code>.
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">除了架构上的差异， <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SpinLock</code>
                            在使用上与 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Monitor</code>
                            类相似。你使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Enter</code> 或
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryEnter</code>
                            获取锁，使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Exit</code> 释放锁。
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SpinLock</code>
                            还提供了两个属性来提供有关它当前是否被锁定的信息： <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">IsHeld</code> 和
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">IsHeldByCurrentThread</code>
                            。</font>
                    </font>
                </font><span aria-label="470" epub:type="pagebreak" id="Page_470" role="doc-pagebreak"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span></p>
            <aside data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                <div class="top hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                    <hr />
                </div>
                <section class="feature2" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                    <p id="c17-para-0150" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                        data-immersive-translate-paragraph="1"><b
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">NOTE</b> <i
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Be careful when
                            passing </i><code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SpinLock</code><i
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"> instances around.
                            Because </i><code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SpinLock</code><i
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"> is defined as a
                        </i><code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">struct</code><i
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">, assigning one
                            variable to another creates a copy. Always pass </i><code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SpinLock</code><i
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"> instances by
                            reference.</i>
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">注意：传递 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SpinLock</code>
                                    实例时要小心。因为 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SpinLock</code>
                                    被定义为 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">struct</code>
                                    ，将一个变量赋值给另一个变量会创建一个副本。始终通过引用传递 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SpinLock</code>
                                    实例。</font>
                            </font>
                        </font>
                    </p>
                    <div class="bottom hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                        <hr />
                    </div>
                </section>
            </aside>
        </section>
        <section aria-labelledby="head-2-156" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
            <span id="c17-sec-0048" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
            <h2 id="head-2-156" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">WAITHANDLE</h2>
            <p id="c17-para-0151" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1"><code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitHandle</code> is an
                abstract base class that you can use to wait for a signal to be set. You can wait for different things
                because <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitHandle</code>
                is a base class and some classes are derived from it.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1"> <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitHandle</code>
                            是一个抽象基类，你可以用它来等待一个信号被设置。你可以等待不同的事物，因为 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitHandle</code>
                            是一个基类，并且一些类是从它派生出来的。</font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0152" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">With <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitHandle</code>, you can
                wait for one signal to occur (<code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitOne</code>), multiple
                objects that all must be signaled (<code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitAll</code>), or one of
                multiple objects (<code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitAny</code>). <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitAll</code> and <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitAny</code> are static
                members of the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitHandle</code> class and
                accept an array of <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitHandle</code> parameters.
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">使用 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitHandle</code>
                            ，你可以等待一个信号发生（ <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitOne</code>
                            ），多个必须被信号的所有对象（ <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitAll</code>
                            ），或者多个对象中的一个（ <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitAny</code> ）。
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitAll</code> 和
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitAny</code> 是
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitHandle</code>
                            类的静态成员，并接受一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitHandle</code>
                            参数的数组。</font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0153" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1"><code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitHandle</code> has a <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SafeWaitHandle</code>
                property with which you can assign a native handle to an operating system resource and wait for that
                handle. For example, you can assign a <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SafeFileHandle</code> to wait
                for a file I/O operation to complete.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1"> <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitHandle</code>
                            拥有 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SafeWaitHandle</code>
                            属性，你可以通过该属性为操作系统资源分配一个本地句柄并等待该句柄。例如，你可以分配一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SafeFileHandle</code>
                            来等待文件 I/O 操作完成。</font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0154" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">The classes <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Mutex</code>, <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">EventWaitHandle</code>, and
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Semaphore</code> are
                derived from the base class <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitHandle</code>, so you can
                use any of these with waits.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">类 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Mutex</code> 、
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">EventWaitHandle</code>
                            和 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Semaphore</code>
                            都继承自基础类 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitHandle</code>
                            ，因此你可以使用这些类中的任何一种进行等待。</font>
                    </font>
                </font>
            </p>
        </section>
        <section aria-labelledby="head-2-157" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
            <span id="c17-sec-0049" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
            <h2 id="head-2-157" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">MUTEX</h2>
            <p id="c17-para-0155" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1"><code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Mutex</code> (mutual
                exclusion) is one of the classes that offers synchronization across multiple processes. It is similar to
                the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Monitor</code> class in
                that there is just one owner. That is, only one thread can get a lock on the mutex and access the
                synchronized code regions that are secured by the mutex.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1"> <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Mutex</code>
                            （互斥）是提供跨多个进程同步功能的一种类。它与 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Monitor</code>
                            类相似，因为只有一个所有者。也就是说，只有一个线程可以获得互斥锁，并访问由互斥锁保护的同步代码区域。</font>
                    </font>
                </font>
            </p>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">With the constructor of the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Mutex</code> class, you can
                define whether the mutex should initially be owned by the calling thread, define a name for the mutex,
                and determine whether the mutex already exists. In the following example, the third parameter is defined
                as an <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">out</code> parameter
                to receive a Boolean value if the mutex was newly created. If the value returned is <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">false</code>, the mutex was
                already defined. The mutex might be defined in a different process because a mutex with a name is known
                to the operating system and is shared among different processes. If no name is assigned to the mutex,
                the mutex is unnamed and not shared among different processes.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">使用 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Mutex</code>
                            类的构造函数，您可以定义互斥体是否最初由调用线程拥有，为互斥体定义一个名称，并确定互斥体是否已存在。在以下示例中，第三个参数被定义为 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">out</code>
                            参数，以接收一个布尔值，如果互斥体是新创建的。如果返回的值是 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">false</code>
                            ，则互斥体已经定义。互斥体可能在不同进程中定义，因为具有名称的互斥体被操作系统知晓，并在不同进程之间共享。如果未为互斥体分配名称，则互斥体是无名的，不会在不同进程之间共享。
                        </font>
                    </font>
                </font>
            </p>
            <pre
                id="c17-code-0058"><code>using Mutex mutex = new(false, "ProCSharpMutex", out bool createdNew);</code></pre>
            <p id="c17-para-0157" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">To open an existing mutex, you can also use the method <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Mutex.OpenExisting</code>,
                which doesn't require the same .NET privileges as creating the mutex with the constructor.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">要打开现有的互斥体，您也可以使用 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Mutex.OpenExisting</code>
                            方法，该方法不需要与创建互斥体相同的.NET 权限。</font>
                    </font>
                </font>
            </p>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">Because the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Mutex</code> class derives
                from the base class <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitHandle</code>, you can do
                a <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitOne</code> to acquire
                the mutex lock and be the owner of the mutex during that time. The mutex is released by invoking the
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ReleaseMutex</code> method:
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">因为 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Mutex</code>
                            类派生于基础类 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitHandle</code>
                            ，您可以执行 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitOne</code>
                            来获取互斥体锁，并在该期间成为互斥体的所有者。通过调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ReleaseMutex</code>
                            方法释放互斥体：</font>
                    </font>
                </font>
            </p>
            <pre id="c17-code-0059"><code>if (mutex.WaitOne())</code>
<code>{</code>
<code>  try</code>
<code>  {</code>
<code>  // synchronized region</code>
<code>  }</code>
<code>  finally</code>
<code>  {</code>
<code>    mutex.ReleaseMutex();</code>
<code>  }</code>
<code>}<span aria-label="471" epub:type="pagebreak" id="Page_471" role="doc-pagebreak"></span></code>
<code>else</code>
<code>{</code>
<code>  // some problem happened while waiting</code>
<code>}</code></pre>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">Because a named mutex is known system-wide, you can use it to
                keep an application from being started twice. In the following console application, the constructor of
                the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Mutex</code> object is
                invoked. Then it is verified whether the mutex with the name <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SingletonAppMutex</code>
                exists already. If it does, the application exits (code file <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/SingletonUsingMutex/Program.cs</code>):
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            由于命名互斥锁在系统中是全局知名的，你可以用它来防止应用程序被启动两次。在以下控制台应用程序中， <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Mutex</code>
                            对象的构造函数被调用。然后验证是否已经存在名为 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SingletonAppMutex</code>
                            的互斥锁。如果存在，应用程序将退出（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/SingletonUsingMutex/Program.cs</code>
                            ）：</font>
                    </font>
                </font>
            </p>
            <pre id="c17-code-0060"><code>Mutex mutex = new(false, "SingletonAppMutex", out bool mutexCreated);</code>
<code>if (!mutexCreated)</code>
<code>{</code>
<code>  Console.WriteLine("You can only start one instance of the application.");   </code>
<code>  await Task.Delay(3000);       </code>
<code>  Console.WriteLine("Exiting.");</code>
<code>  return;</code>
<code>}</code>
<code>Console.WriteLine("Application running");</code>
<code>Console.WriteLine("Press return to exit");</code>
<code>Console.ReadLine();</code></pre>
        </section>
        <section aria-labelledby="head-2-158" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
            <span id="c17-sec-0050" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
            <h2 id="head-2-158" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">SEMAPHORE<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">信号量</font>
                    </font>
                </font>
            </h2>
            <p id="c17-para-0160" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">A semaphore is similar to a mutex, but unlike the mutex, the
                semaphore can be used by multiple threads at once. A semaphore is a counting mutex, meaning that with a
                semaphore, you can define the number of threads that are allowed to access the resource guarded by the
                semaphore simultaneously. This is useful if you need to limit the number of threads that can access the
                available resources. For example, if a system has three physical I/O ports available, three threads can
                access them simultaneously, but a fourth thread needs to wait until the resource is released by one of
                the other threads.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            信号量与互斥锁类似，但与互斥锁不同，信号量可以被多个线程同时使用。信号量是一种计数型互斥锁，这意味着通过信号量，你可以定义同时允许访问由信号量保护的资源的线程数量。如果你需要限制可以访问可用资源的线程数量，这会很有用。例如，如果一个系统有三个物理
                            I/O 端口可用，三个线程可以同时访问它们，但第四个线程需要等待其他线程释放资源。</font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0161" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">.NET provides two classes with semaphore functionality: <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Semaphore</code> and <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SemaphoreSlim</code>. <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Semaphore</code> can be
                named, can use system-wide resources, and allows synchronization between different processes. <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SemaphoreSlim</code> is a
                lightweight version that is optimized for shorter wait times.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">.NET 提供了两个具有信号量功能的类： <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Semaphore</code>
                            和 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SemaphoreSlim</code>
                            。 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Semaphore</code>
                            可以命名，可以使用全局系统资源，并允许不同进程之间的同步。 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SemaphoreSlim</code>
                            是一个轻量级版本，针对较短的等待时间进行了优化。</font>
                    </font>
                </font>
            </p>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">In the following example application, six tasks are created along
                with one semaphore with a count of three. In the constructor of the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Semaphore</code> class, you
                can define the count for the number of locks that can be acquired with the semaphore (the second
                parameter) and the number of locks that are free initially (the first parameter). If the first parameter
                has a lower value than the second parameter, the difference between the values defines the already
                allocated semaphore count. As with the mutex, you can also assign a name to the semaphore to share it
                among different processes. Here a <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SemaphoreSlim</code> object
                is created that can be used only within the process. After the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SemaphoreSlim</code> object
                is created, six tasks are started, and they all wait for the same semaphore (code file <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/SemaphoreSample/Program.cs</code>):
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">在以下示例应用程序中，创建了六个任务和一个计数值为三的信号量。在 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Semaphore</code>
                            类的构造函数中，您可以定义信号量可以获取的锁数量（第二个参数）以及初始时空闲的锁数量（第一个参数）。如果第一个参数的值低于第二个参数，那么这两个值之间的差值定义了已经分配的信号量计数。与互斥锁一样，您也可以为信号量分配一个名称，以便在不同进程之间共享。这里创建了一个
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SemaphoreSlim</code>
                            对象，它只能在进程内部使用。在创建 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SemaphoreSlim</code>
                            对象后，启动了六个任务，它们都等待同一个信号量（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/SemaphoreSample/Program.cs</code>
                            ）：</font>
                    </font>
                </font>
            </p>
            <pre id="c17-code-0061"><code>int taskCount = 6;</code>
<code>int semaphoreCount = 3;</code>
<code>using <b>SemaphoreSlim semaphore = new(semaphoreCount, semaphoreCount);</b></code>
<code>Task[] tasks = new Task[taskCount];</code>
<code>for (int i = 0; i &lt; taskCount; i++)</code>
<code>{</code>
<code>  tasks[i] = Task.Run(() =&gt; TaskMain(semaphore));</code>
<code>}</code>
<code>Task.WaitAll(tasks);</code>
<code>Console.WriteLine("All tasks finished");</code>
<code>  //…</code></pre>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1"><span aria-label="472" epub:type="pagebreak" id="Page_472"
                    role="doc-pagebreak"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>In the task's main
                method, <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskMain</code>,
                the task does a <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Wait</code>
                to lock the semaphore. Remember that the semaphore has a count of three, so three tasks can acquire the
                lock. Task 4 must wait, and here the timeout of 600 milliseconds is defined as the maximum wait time. If
                the lock cannot be acquired after the wait time has elapsed, the task writes a message to the console
                and repeats the wait in a loop. As soon as the lock is acquired, the thread writes a message to the
                console, sleeps for some time, and releases the lock. Again, with the release of the lock it is
                important that the resource be released in all cases. That's why the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Release</code> method of the
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SemaphoreSlim</code> class
                is invoked in a <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">finally</code> handler (code
                file <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/SemaphoreSample/Program.cs</code>):
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">在任务的 main 方法中， <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TaskMain</code>
                            ，任务执行 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Wait</code>
                            来锁定信号量。记住信号量的计数值为三，因此三个任务可以获取锁。任务 4 必须等待，这里定义了 600
                            毫秒的超时作为最大等待时间。如果在等待时间过后无法获取锁，任务会向控制台写入一条消息，并在循环中重复等待。一旦获取了锁，线程会向控制台写入一条消息，休眠一段时间，然后释放锁。同样，在释放锁时，重要的是在任何情况下都要释放资源。这就是为什么在
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">finally</code>
                            处理器（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/SemaphoreSample/Program.cs</code>
                            ）中调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SemaphoreSlim</code>
                            类的 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Release</code>
                            方法的原因：</font>
                    </font>
                </font>
            </p>
            <pre id="c17-code-0062"><code>// …</code>
<code>void TaskMain(SemaphoreSlim semaphore)</code>
<code>{</code>
<code>  bool isCompleted = false;</code>
<code>  while (!isCompleted)</code>
<code>  {</code>
<code>    <b>if (semaphore.Wait(600))</b></code>
<code>    {</code>
<code>      try</code>
<code>      {</code>
<code>        Console.WriteLine($"Task {Task.CurrentId} locks the semaphore");</code>
<code>        Task.Delay(2000).Wait();</code>
<code>      }</code>
<code>      finally</code>
<code>      {</code>
<code>        Console.WriteLine($"Task {Task.CurrentId} releases the semaphore");</code>
<code>        <b>semaphore.Release();</b></code>
<code>        isCompleted = true;</code>
<code>      }</code>
<code>    }</code>
<code>    else</code>
<code>    {</code>
<code>      Console.WriteLine($"Timeout for task {Task.CurrentId}; wait again");</code>
<code>    }</code>
<code>  }</code>
<code>}</code></pre>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">When you run the application, you can indeed see that with three
                threads the lock is made immediately. The tasks with IDs 4, 5, and 6 must wait. The wait continues in
                the loop until one of the other threads releases the semaphore:<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">运行应用程序时，确实可以看到三个线程立即获取了锁。ID 为 4、5 和 6
                            的任务必须等待。等待在循环中继续，直到其他线程释放信号量：</font>
                    </font>
                </font>
            </p>
            <pre id="c17-code-0063"><code>Task 3 locks the semaphore</code>
<code>Task 1 locks the semaphore</code>
<code>Task 2 locks the semaphore</code>
<code>Timeout for task 4; wait again</code>
<code>Timeout for task 5; wait again</code>
<code>Timeout for task 6; wait again</code>
<code>Timeout for task 4; wait again</code>
<code>Timeout for task 6; wait again</code>
<code>Timeout for task 4; wait again</code>
<code>Timeout for task 5; wait again</code>
<code>Timeout for task 6; wait again</code>
<code>Task 3 releases the semaphore</code>
<code>Task 1 releases the semaphore</code>
<code>Task 2 releases the semaphore</code>
<code>Task 4 locks the semaphore</code>
<code>Task 5 locks the semaphore</code>
<code>Task 6 locks the semaphore<span aria-label="473" epub:type="pagebreak" id="Page_473" role="doc-pagebreak"></span></code>
<code>Task 5 releases the semaphore</code>
<code>Task 6 releases the semaphore</code>
<code>Task 4 releases the semaphore</code>
<code>All tasks finished</code></pre>
        </section>
        <section aria-labelledby="head-2-159" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
            <span id="c17-sec-0051" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
            <h2 id="head-2-159" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">EVENTS<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">事件</font>
                    </font>
                </font>
            </h2>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">Like mutex and semaphore objects, events are also system-wide
                synchronization resources. For using system events from managed code, .NET offers the classes <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ManualResetEvent</code>,
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">AutoResetEvent</code>,
                <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ManualResetEventSlim</code>,
                and <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CountdownEvent</code>
                in the namespace <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">System.Threading</code>.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            与互斥量和信号量对象一样，事件也是系统范围的同步资源。为了在托管代码中使用系统事件，.NET 在 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">System.Threading</code>
                            命名空间中提供了 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ManualResetEvent</code>
                            、 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">AutoResetEvent</code>
                            、 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ManualResetEventSlim</code>
                            和 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CountdownEvent</code>
                            类。</font>
                    </font>
                </font>
            </p>
            <aside data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                <div class="top hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                    <hr />
                </div>
                <section class="feature2" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                    <p id="c17-para-0166" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                        data-immersive-translate-paragraph="1"><b
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">NOTE</b> <i
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">The </i><code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">event</code><i
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"> keyword from C# that
                            is covered in <a href="c07.xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Chapter 7</a>,
                            “Delegates, Lambdas, and Events,” has nothing to do with the event classes from the
                            namespace </i><code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">System.Threading</code><i
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">; the </i><code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">event</code><i
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"> keyword is based on
                            delegates. However, both event classes are .NET wrappers to the system-wide native event
                            resource for synchronization.</i>
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">注意 C# 中的 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">event</code>
                                    关键字，在第七章“委托、Lambda 表达式和事件”中介绍，与 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">System.Threading</code>
                                    命名空间中的事件类无关； <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">event</code>
                                    关键字基于委托。然而，这两个事件类都是 .NET 对系统级原生事件资源的封装，用于同步。</font>
                            </font>
                        </font>
                    </p>
                    <div class="bottom hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                        <hr />
                    </div>
                </section>
            </aside>
            <p id="c17-para-0167" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">You can use events to inform other tasks that some data is
                present, that something is completed, and so on. An event can be signaled or not signaled. A task can
                wait for the event to be in a signaled state with the help of the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitHandle</code> class,
                discussed earlier.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            你可以使用事件来通知其他任务某些数据已存在、某事已完成等。事件可以是已通知的或未通知的。任务可以通过前面讨论的 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitHandle</code>
                            类等待事件处于已通知状态。</font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0168" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">A <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ManualResetEventSlim</code>
                is signaled by invoking the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Set</code> method, and it's
                returned to a nonsignaled state with the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Reset</code> method. If
                multiple threads are waiting for an event to be signaled and the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Set</code> method is invoked,
                then all threads waiting are released. In addition, if a thread invokes the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitOne</code> method but the
                event is already signaled, the waiting thread can continue immediately.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">通过调用 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Set</code> 方法来触发
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ManualResetEventSlim</code>
                            ，并通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Reset</code>
                            方法将其返回到非触发状态。如果多个线程等待事件被触发，并且调用了 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Set</code>
                            方法，那么所有等待的线程都会被释放。此外，如果线程调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitOne</code>
                            方法，但事件已经被触发，那么等待的线程可以立即继续。</font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0169" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">An <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">AutoResetEvent</code> is also
                signaled by invoking the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Set</code> method, and you
                can set it back to a nonsignaled state with the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Reset</code> method. However,
                if a thread is waiting for an auto-reset event to be signaled, the event is automatically changed into a
                nonsignaled state when the wait state of the first thread is finished. This way, if multiple threads are
                waiting for the event to be set, only one thread is released from its wait state. It is not the thread
                that has been waiting the longest for the event to be signaled, but the thread waiting with the highest
                priority.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">一个 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">AutoResetEvent</code>
                            也可以通过调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Set</code>
                            方法来触发，并且你可以使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Reset</code>
                            方法将其重置为非触发状态。然而，如果线程正在等待自动重置事件被触发，当第一个线程的等待状态结束时，事件会自动变为非触发状态。这样，如果有多个线程正在等待事件被设置，只有一个线程会从其等待状态中被释放。不是等待事件触发时间最长的线程，而是具有最高优先级的线程。
                        </font>
                    </font>
                </font>
            </p>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">To demonstrate events with the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ManualResetEventSlim</code>
                class, the following class <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Calculator</code> defines the
                method <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Calculation</code>,
                which is the entry point for a task. With this method, the task receives input data for calculation and
                writes the result to the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Result</code> property. As
                soon as the result is completed (after a random amount of time), the event is signaled by invoking the
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Set</code> method of the
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ManualResetEventSlim</code>
                (code file <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/EventSample/Calculator.cs</code>):
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">为了演示 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ManualResetEventSlim</code>
                            类的事件，以下类 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Calculator</code>
                            定义了方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Calculation</code>
                            ，这是任务的入口点。通过这个方法，任务接收用于计算的输入数据，并将结果写入 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Result</code>
                            属性。一旦结果完成（经过一段随机时间），通过调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ManualResetEventSlim</code>
                            的 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Set</code>
                            方法（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/EventSample/Calculator.cs</code>
                            ）来触发事件：</font>
                    </font>
                </font>
            </p>
            <pre id="c17-code-0064"><code>public class Calculator</code>
<code>{</code>
<code>  <b>private ManualResetEventSlim _mEvent;</b></code>
<code>  public int Result { get; private set; }</code>
<code> </code>
<code>  public Calculator(ManualResetEventSlim ev) =&gt; _mEvent = ev;</code>
<code> </code>
<code>  public void Calculation(int x, int y)</code>
<code>  {</code>
<code>    Console.WriteLine($"Task {Task.CurrentId} starts calculation");</code>
<code>    Task.Delay(new Random().Next(3000)).Wait();</code>
<code>    Result = x + y;<span aria-label="474" epub:type="pagebreak" id="Page_474" role="doc-pagebreak"></span></code>
<code>    // signal the event-completed!</code>
<code>    Console.WriteLine($"Task {Task.CurrentId} is ready");</code>
<code>    <b>_mEvent.Set();</b></code>
<code>  }</code>
<code>}</code></pre>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">The top-level statements of the program defines arrays of four
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ManualResetEventSlim</code>
                objects and four <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Calculator</code> objects.
                Every <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Calculator</code> is
                initialized in the constructor with a <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ManualResetEventSlim</code>
                object, so every task gets its own event object to signal when it is completed. Now, the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code> class is used to
                enable different tasks to run the calculation (code file <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/EventSample/Program.cs</code>):
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">程序的最顶层语句定义了四个 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ManualResetEventSlim</code>
                            对象数组和四个 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Calculator</code>
                            对象数组。每个 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Calculator</code>
                            在构造函数中用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ManualResetEventSlim</code>
                            对象初始化，因此每个任务都有自己的事件对象来标识完成时。现在，使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                            类来使不同任务能够运行计算（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/EventSample/Program.cs</code>
                            ）：</font>
                    </font>
                </font>
            </p>
            <pre id="c17-code-0065"><code>const int taskCount = 4;</code>
<code><b>ManualResetEventSlim[] mEvents = new ManualResetEventSlim[taskCount];co</b></code>
<code>WaitHandle[] waitHandles = new WaitHandle[taskCount];</code>
<code>Calculator[] calcs = new Calculator[taskCount];</code>
<code> </code>
<code>for (int i = 0; i &lt; taskCount; i++)</code>
<code>{</code>
<code>  int i1 = i;</code>
<code>  <b>mEvents[i] = new(false);</b></code>
<code>  waitHandles[i] = mEvents[i].WaitHandle;</code>
<code>  calcs[i] = new(mEvents[i]);</code>
<code>  Task.Run(() =&gt; calcs[i1].Calculation(i1 + 1, i1 + 3));</code>
<code>}</code>
<code>//…</code></pre>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">The <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitHandle</code> class is
                now used to wait for any one of the events in the array. <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitAny</code> waits until
                any one of the events is signaled. In contrast to <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ManualResetEvent</code>,
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ManualResetEventSlim</code>
                does not derive from <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitHandle</code>. That's why
                a separate collection of <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitHandle</code> objects is
                kept, which is filled from the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitHandle</code> property of
                the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ManualResetEventSlim</code>
                class. <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitAny</code>
                returns an index value that provides information about the event that was signaled. The returned value
                matches the index of the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitHandle</code> array that
                is passed to <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitAny</code>. Using this
                index, information from the signaled event can be read:<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">现在 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitHandle</code>
                            类用于等待数组中的任何一个事件。 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitAny</code>
                            等待任何一个事件被信号。与 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ManualResetEvent</code>
                            不同， <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ManualResetEventSlim</code>
                            不继承自 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitHandle</code>
                            。这就是为什么保留了一个单独的 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitHandle</code>
                            对象集合，它从 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ManualResetEventSlim</code>
                            类的 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitHandle</code>
                            属性中填充。 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitAny</code>
                            返回一个索引值，提供有关被信号事件的详细信息。返回的值与传递给 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitAny</code> 的
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitHandle</code>
                            数组的索引相匹配。使用此索引，可以从被信号的事件中读取信息：</font>
                    </font>
                </font>
            </p>
            <pre id="c17-code-0066"><code>for (int i = 0; i &lt; taskCount; i++)</code>
<code>{</code>
<code>  <b>int index = WaitHandle.WaitAny(waitHandles);</b></code>
<code>  <b>if (index == WaitHandle.WaitTimeout)</b></code>
<code>  {</code>
<code>    Console.WriteLine("Timeout!!");</code>
<code>  }</code>
<code>  else</code>
<code>  {</code>
<code>    <b>mEvents[index].Reset();</b></code>
<code>    Console.WriteLine($"finished task for {index}, result:    </code>
<code>      {calcs[index].Result}");</code>
<code>  }</code>
<code>}</code></pre>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">When you start the application, you can see the tasks doing the
                calculation and setting the event to inform the main thread that it can read the result. At random
                times, depending on whether the build is a debug or release build and on your hardware, you might see
                different orders and a different number of tasks performing calls:<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            启动应用程序时，可以看到任务进行计算并将事件设置为通知主线程可以读取结果。根据构建是调试版本还是发布版本以及您的硬件，随机时间可能会看到不同的任务执行顺序和不同数量的任务调用：
                        </font>
                    </font>
                </font>
            </p>
            <pre id="c17-code-0067"><code>Task 4 starts calculation</code>
<code>Task 1 starts calculation</code>
<code>Task 3 starts calculation</code>
<code>Task 2 starts calculation<span aria-label="475" epub:type="pagebreak" id="Page_475" role="doc-pagebreak"></span></code>
<code>Task 3 is ready</code>
<code>finished task for 3, result: 10</code>
<code>Task 4 is ready</code>
<code>finished task for 1, result: 6</code>
<code>Task 1 is ready</code>
<code>Task 2 is ready</code>
<code>finished task for 0, result: 4</code>
<code>finished task for 2, result: 8</code></pre>
            <p id="c17-para-0174" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">In a scenario like this, to fork some work into multiple tasks
                and later join the result, the new <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CountdownEvent</code> class
                can be useful. Instead of creating a separate event object for every task, you need to create only one.
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CountdownEvent</code>
                defines an initial number for all the tasks that set the event, and after the count is reached, the
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CountdownEvent</code> is
                signaled.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">在这种场景下，为了将工作分配到多个任务并稍后合并结果，新的 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CountdownEvent</code>
                            类会很有用。你不需要为每个任务创建单独的事件对象，只需创建一个即可。 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CountdownEvent</code>
                            为所有任务定义了一个初始事件设置数量，当计数达到后， <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CountdownEvent</code>
                            会被触发。</font>
                    </font>
                </font>
            </p>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">The <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Calculator</code> class is
                modified to use the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CountdownEvent</code> instead
                of the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ManualResetEvent</code>.
                Rather than set the signal with the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Set</code> method, <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CountdownEvent</code> defines
                the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Signal</code> method
                (code file <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/EventSampleWithCountdownEvent/Calculator.cs</code>):
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1"> <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Calculator</code>
                            类被修改为使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CountdownEvent</code>
                            而不是 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ManualResetEvent</code>
                            。不再使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Set</code>
                            方法设置信号， <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CountdownEvent</code>
                            定义了 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Signal</code>
                            方法（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/EventSampleWithCountdownEvent/Calculator.cs</code>
                            ）：</font>
                    </font>
                </font>
            </p>
            <pre id="c17-code-0068"><code>public class Calculator</code>
<code>{</code>
<code>  <b>private CountdownEvent _cEvent;</b></code>
<code>  public int Result { get; private set; }</code>
<code> </code>
<code>  public Calculator<b>(CountdownEvent ev) =&gt; _cEvent = ev;</b></code>
<code> </code>
<code>  public void Calculation(int x, int y)</code>
<code>  {</code>
<code>    Console.WriteLine($"Task {Task.CurrentId} starts calculation");</code>
<code>    Task.Delay(new Random().Next(3000)).Wait();</code>
<code>    Result = x + y;</code>
<code>    // signal the event-completed!</code>
<code>    Console.WriteLine($"Task {Task.CurrentId} is ready");</code>
<code>    <b>_cEvent.Signal();</b></code>
<code>  }</code>
<code>}</code></pre>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">You can now simplify the top-level statements so that it's only
                necessary to wait for the single event. If you don't deal with the results separately as it was done
                before, this new edition might be all that's needed:<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            现在可以简化顶层语句，只需等待单个事件即可。如果你不再像之前那样分别处理结果，这个新版本可能就足够了：</font>
                    </font>
                </font>
            </p>
            <pre id="c17-code-0069"><code>const int taskCount = 4;</code>
<code>CountdownEvent cEvent = new(taskCount);</code>
<code>Calculator[] calcs = new Calculator[taskCount];</code>
<code>for (int i = 0; i &lt; taskCount; i++)</code>
<code>{</code>
<code>  calcs[i] = new(cEvent);</code>
<code>  int i1 = i;</code>
<code>  Task.Run(() =&gt; calcs[i1].Calculation, Tuple.Create(i1 + 1, i1 + 3));</code>
<code>}</code>
<code><b>cEvent.Wait();</b></code>
<code> </code>
<code>Console.WriteLine("all finished");</code>
<code>for (int i = 0; i &lt; taskCount; i++)</code>
<code>{</code>
<code>  Console.WriteLine($"task for {i}, result: {calcs[i].Result}");</code>
<code>}</code></pre>
        </section> <span aria-label="476" epub:type="pagebreak" id="Page_476" role="doc-pagebreak"
            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
        <section aria-labelledby="head-2-160" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
            <span id="c17-sec-0053" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
            <h2 id="head-2-160" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">BARRIER</h2>
            <p id="c17-para-0177" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">For synchronization, the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Barrier</code> class is great
                for scenarios in which work is forked into multiple tasks and the work must be joined afterward. <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Barrier</code> is used for
                participants that need to be synchronized. While the job is active, you can dynamically add
                participants—for example, child tasks that are created from a parent task. Participants can wait until
                the work is done by all the other participants before continuing.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">对于同步， <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Barrier</code>
                            类适用于工作被分叉到多个任务中，而后又需要合并的场景。 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Barrier</code>
                            用于需要同步的参与者。当工作处于活动状态时，可以动态添加参与者——例如，从父任务创建的子任务。参与者可以等待其他所有参与者完成工作后再继续。</font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0178" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">The <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">BarrierSample</code> is
                somewhat complex, but it's worthwhile to demonstrate the features of the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Barrier</code> type. The
                sample creates multiple collections of two million random strings. Multiple tasks are used to iterate
                through the collection and count the number of strings, starting with a, b, c, and so on. The work is
                not only distributed between different tasks, but also within a task. After all tasks are iterated
                through the first collection of strings, the result is summarized, and the tasks continue later with the
                next collection.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1"> <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">BarrierSample</code>
                            功能较为复杂，但展示 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Barrier</code>
                            类型的特性是值得的。示例创建了多个包含两百万随机字符串的集合。使用多个任务来遍历这些集合并统计字符串数量，从 a、b、c
                            等开始。工作不仅在不同任务间分配，也在单个任务内部分配。当所有任务遍历完第一个字符串集合后，结果将被汇总，任务随后继续处理下一个集合。</font>
                    </font>
                </font>
            </p>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">The method <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">FillData</code> creates a
                collection and fills it with random strings (code file <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">BarrierSample/Program.cs</code>):
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">方法 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">FillData</code>
                            创建一个集合并用随机字符串填充它（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">BarrierSample/Program.cs</code>
                            ）：</font>
                    </font>
                </font>
            </p>
            <pre id="c17-code-0070"><code>public static IEnumerable&lt;string&gt; FillData(int size)</code>
<code>{</code>
<code>  Random r = new();</code>
<code>  return Enumerable.Range(0, size).Select(x =&gt; GetString(r));</code>
<code>}</code>
<code> </code>
<code>private static string GetString(Random r)</code>
<code>{</code>
<code>  StringBuilder sb = new(6);</code>
<code>  for (int i = 0; i &lt; 6; i++)</code>
<code>  {</code>
<code>    sb.Append((char)(r.Next(26) + 97));</code>
<code>  }</code>
<code>  return sb.ToString();</code>
<code>}</code></pre>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">A helper method to show information about a <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Barrier</code> is defined
                with the method <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">LogBarrierInformation</code>
                :<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">定义了一个辅助方法 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">LogBarrierInformation</code>
                            ，用于显示关于 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Barrier</code>
                            的信息：</font>
                    </font>
                </font>
            </p>
            <pre id="c17-code-0071"><code>private static void LogBarrierInformation(string info, Barrier barrier)</code>
<code>{</code>
<code>  Console.WriteLine($"Task {Task.CurrentId}: {info}. " +</code>
<code>    $"{<b>barrier.ParticipantCount</b>} current and " +</code>
<code>    $"{<b>barrier.ParticipantsRemaining</b>} remaining participants, " +</code>
<code>    $"phase {<b>barrier.CurrentPhaseNumber</b>}");</code>
<code>}</code></pre>
            <p id="c17-para-0181" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">The <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CalculationInTask</code>
                method defines the job performed by a task. With the parameters, the third parameter references the
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Barrier</code> instance.
                The data that is used for the calculation is an array of <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">IList&lt;string&gt;</code>.
                The last parameter, a jagged <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">int</code> array, will be
                used to write the results as the task progresses.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1"> <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CalculationInTask</code>
                            方法定义了任务执行的工作。通过参数，第三个参数引用了 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Barrier</code>
                            实例。用于计算的数据是一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">IList&lt;string&gt;</code>
                            数组。最后一个参数，一个锯齿状的 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">int</code>
                            数组，将用于在任务进行时写入结果。</font>
                    </font>
                </font>
            </p>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">The task makes the processing in a loop. With every loop, an
                array element of <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">IList&lt;string&gt;[]</code>
                is processed. After every loop is completed, the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code> signals that it's
                ready by invoking the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SignalAndWait</code> method,
                and it waits until all the other tasks are ready with this processing as well. This loop continues until
                the task is fully finished. Then the task removes itself from the barrier by invoking the method <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">RemoveParticipant</code>
                (code file <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/BarrierSample/Program.cs</code>):
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">任务使处理在循环中进行。每个循环中，都会处理 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">IList&lt;string&gt;[]</code>
                            的一个数组元素。每个循环完成后， <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code> 通过调用
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SignalAndWait</code>
                            方法发出准备就绪的信号，并等待所有其他任务也完成相同的处理。这个循环会一直持续到任务完全完成。然后，任务通过调用 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">RemoveParticipant</code>
                            方法（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/BarrierSample/Program.cs</code>
                            ）从屏障中移除自己：</font>
                    </font>
                </font>
            </p>
            <pre id="c17-code-0072"><code>private static void CalculationInTask(int jobNumber, int partitionSize,</code>
<code>  Barrier, IList&lt;string&gt;[] coll, int loops, int[][] results)</code>
<code>{</code>
<code>  LogBarrierInformation("CalculationInTask started", barrier);</code>
<code> </code>
<code>  for (int i = 0; i &lt; loops; i++)<span aria-label="477" epub:type="pagebreak" id="Page_477" role="doc-pagebreak"></span></code>
<code>  {</code>
<code>    List&lt;string&gt; data = new(coll[i]);</code>
<code>    int start = jobNumber * partitionSize;</code>
<code>    int end = start + partitionSize;</code>
<code>    Console.WriteLine($"Task {Task.CurrentId} in loop {i}: partition " +</code>
<code>      $"from {start} to {end}");</code>
<code> </code>
<code>    for (int j = start; j &lt; end; j++)</code>
<code>    {</code>
<code>      char c = data[j][0];</code>
<code>      results[i][c - 97]++;</code>
<code>    }</code>
<code>    Console.WriteLine($"Calculation completed from task {Task.CurrentId} " +</code>
<code>      $"in loop {i}. {results[i][0]} times a, {results[i][25]} times z");</code>
<code> </code>
<code>    LogBarrierInformation("sending signal and wait for all", barrier);</code>
<code>    <b>barrier.SignalAndWait();</b></code>
<code>    LogBarrierInformation("waiting completed", barrier);</code>
<code>  }</code>
<code>  <b>barrier.RemoveParticipant();</b></code>
<code>  LogBarrierInformation("finished task, removed participant", barrier);</code>
<code>}</code></pre>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">With the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Main</code> method, a <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Barrier</code> instance is
                created. In the constructor, you can specify the number of participants. In the example, this number is
                3 (<code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">numberTasks + 1</code>)
                because there are two created tasks, and the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Main</code> method is a
                participant as well. When you use <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task.Run</code>, two tasks
                are created to fork the iteration through the collection into two parts. After starting the tasks, using
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SignalAndWait</code>, the
                main method signals its completion and waits until all remaining participants either signal their
                completion or remove themselves as participants from the barrier. As soon as all participants are ready
                with one iteration, the results from the tasks are zipped together with the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Zip</code> extension method.
                Then the next iteration is done to wait for the next results from the tasks (code file <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/BarrierSample/Program.cs</code>):
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">使用 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Main</code>
                            方法会创建一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Barrier</code>
                            实例。在构造函数中，你可以指定参与者的数量。在示例中，这个数量是 3（ <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">numberTasks + 1</code>
                            ），因为创建了两个任务，而 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Main</code>
                            方法也是一个参与者。当你使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task.Run</code>
                            时，会创建两个任务来将集合的迭代分成两部分。启动任务后，使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SignalAndWait</code>
                            ，主方法会发出完成信号并等待所有剩余的参与者要么发出完成信号，要么从障碍中移除自己作为参与者。一旦所有参与者完成一次迭代，任务的结果会使用 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Zip</code>
                            扩展方法一起压缩。然后进行下一次迭代，等待任务的下一次结果（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/BarrierSample/Program.cs</code>
                            ）：</font>
                    </font>
                </font>
            </p>
            <pre id="c17-code-0073"><code>static void Main()</code>
<code>{</code>
<code>  const int numberTasks = 2;</code>
<code>  const int partitionSize = 1_000_000;</code>
<code>  const int loops = 5;</code>
<code>  Dictionary&lt;int, int[][]&gt; taskResults = new Dictionary&lt;int, int[][]&gt;();</code>
<code>  List&lt;string&gt; data = new List&lt;string&gt;[loops];</code>
<code>  for (int i = 0; i &lt; loops; i++)</code>
<code>  {</code>
<code>    data[i] = new List(FillData(partitionSize * numberTasks);</code>
<code>  }</code>
<code> </code>
<code>  using <b>Barrier barrier = new(numberTasks + 1);</b></code>
<code>  LogBarrierInformation("initial participants in barrier", barrier);</code>
<code>  for (int i = 0; i &lt; numberTasks; i++)</code>
<code>  {</code>
<code>    <b>barrier.AddParticipant();</b></code>
<code>    int jobNumber = i;</code>
<code>    taskResults.Add(i, new int[loops][]);</code>
<code>    for (int loop = 0; loop &lt; loops; loop++)</code>
<code>    {</code>
<code>      taskResult[i, loop] = new int[26];</code>
<code>    }<span aria-label="478" epub:type="pagebreak" id="Page_478" role="doc-pagebreak"></span></code>
<code>    Console.WriteLine("Main - starting task job {jobNumber}");</code>
<code>    <b>Task.Run(() =&gt; CalculationInTask(jobNumber, partitionSize,</b></code>
<code>      <b>barrier, data, loops, taskResults[jobNumber]));</b></code>
<code>  <b>}</b></code>
<code> </code>
<code>  <b>for (int loop = 0; loop &lt; 5; loop++)</b></code>
<code>  <b>{</b></code>
<code>    <b>LogBarrierInformation("main task, start signaling and wait", barrier);</b></code>
<code>    <b>barrier.SignalAndWait();</b></code>
<code>    <b>LogBarrierInformation("main task waiting completed", barrier);</b></code>
<code>    int[][] resultCollection1 = taskResults[0];</code>
<code>    int[][] resultCollection2 = taskResults[1];</code>
<code>    var resultCollection = resultCollection1[loop].Zip(</code>
<code>      resultCollection2[loop], (c1, c2) =&gt; c1 + c2);</code>
<code>    char ch = 'a';</code>
<code>    int sum = 0;</code>
<code>    foreach (var x in resultCollection)</code>
<code>    {</code>
<code>      Console.WriteLine($"{ch++}, count: {x}");</code>
<code>      sum += x;</code>
<code>    }</code>
<code>    LogBarrierInformation($"main task finished loop {loop}, sum: {sum}",</code>
<code>      barrier);</code>
<code>  }</code>
<code> </code>
<code>  Console.WriteLine("finished all iterations");</code>
<code>  Console.ReadLine();</code>
<code>}</code></pre>
            <aside data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                <div class="top hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                    <hr />
                </div>
                <section class="feature2" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                    <p id="c17-para-0185" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                        data-immersive-translate-paragraph="1"><b
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">NOTE</b> <i
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Jagged arrays are
                            explained in <a href="c06.xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Chapter 6</a>,
                            “Arrays.” The </i> <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Zip</code> <i
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"> extension method is
                            explained in <a href="c09.xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Chapter
                                9</a>.</i>
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">注意 错位数组在第六章“数组”中解释。 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Zip</code>
                                    扩展方法在第九章中解释。</font>
                            </font>
                        </font>
                    </p>
                    <div class="bottom hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                        <hr />
                    </div>
                </section>
            </aside>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">When you run the application, you can see output like the
                following. In the output, you can see that every call to <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">AddParticipant</code>
                increases the participant count as well as the remaining participant count. As soon as one participant
                invokes <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SignalAndWait</code>, the
                remaining participant count is decremented. When the remaining participant count reaches 0, the wait of
                all participants ends, and the next phase begins:<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">运行应用程序时，您可以看到如下输出。在输出中，可以看到每次调用 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">AddParticipant</code>
                            都会增加参与者数量以及剩余参与者数量。当有一个参与者调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SignalAndWait</code>
                            时，剩余参与者数量会减少。当剩余参与者数量达到 0 时，所有参与者的等待结束，并开始下一阶段：</font>
                    </font>
                </font>
            </p>
            <pre id="c17-code-0074"><code>Task : initial participants in barrier. 1 current and 1 remaining participants, phase 0</code>
<code>Main - starting task job 0</code>
<code>Main - starting task job 1</code>
<code>Task : main task, start signaling and wait. 3 current and 3 remaining participants, phase 0</code>
<code>Task 1: CalculationInTask started. 3 current and 2 remaining participants, phase 0</code>
<code>Task 2: CalculationInTask started. 3 current and 2 remaining participants, phase 0</code>
<code>Task 2 in loop 0: partition from 1000000 to 2000000</code>
<code>Task 1 in loop 0: partition from 0 to 1000000</code>
<code>Calculation completed from task 2 in loop 0. 38361 times a, 38581 times z</code>
<code>Task 2: sending signal and wait for all. 3 current and 2 remaining participants, phase 0</code>
<code>Calculation completed from task 1 in loop 0. 38657 times a, 38643 times z<span aria-label="479" epub:type="pagebreak" id="Page_479" role="doc-pagebreak"></span></code>
<code>Task 1: sending signal and wait for all. 3 current and 1 remaining participants, phase 0</code>
<code>Task 1: waiting completed. 3 current and 3 remaining participants, phase 1</code>
<code>Task : main task waiting completed. 3 current and 3 remaining participants, phase 1</code></pre>
        </section>
        <section aria-labelledby="head-2-161" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
            <span id="c17-sec-0055" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
            <h2 id="head-2-161" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">READERWRITERLOCKSLIM</h2>
            <p id="c17-para-0187" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">For a locking mechanism to allow multiple readers but only one
                writer for a resource, you can use the class <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ReaderWriterLockSlim</code>.
                This class offers a locking functionality in which multiple readers can access the resource if no writer
                locked it, and only a single writer can lock the resource.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">为了使锁定机制允许多个读者但只有一个写者访问资源，你可以使用类 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ReaderWriterLockSlim</code>
                            。这个类提供了一种锁定功能，在没有写者锁定的情况下，多个读者可以访问资源，并且只有一个写者可以锁定资源。</font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0188" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">The <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ReaderWriterLockSlim</code>
                class has blocking and nonblocking methods to acquire a read lock, such as <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">EnterReadLock</code>
                (blocking) and <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryEnterReadLock</code>
                (nonblocking), and to acquire a write lock with <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">EnterWriteLock</code>
                (blocking) and <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryEnterWriteLock</code>
                (nonblocking). If a task reads first and writes afterward, it can acquire an upgradable read lock with
                <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">EnterUpgradableReadLock</code>
                or <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryEnterUpgradableReadLock</code>.
                With this lock, the write lock can be acquired without releasing the read lock.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1"> <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ReaderWriterLockSlim</code>
                            类具有获取读锁的阻塞和非阻塞方法，例如 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">EnterReadLock</code>
                            （阻塞）和 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryEnterReadLock</code>
                            （非阻塞），以及获取写锁的阻塞和非阻塞方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">EnterWriteLock</code>
                            （阻塞）和 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryEnterWriteLock</code>
                            （非阻塞）。如果一个任务先读取后写入，它可以使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">EnterUpgradableReadLock</code>
                            或 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryEnterUpgradableReadLock</code>
                            获取可升级的读锁。有了这种锁，可以在不释放读锁的情况下获取写锁。</font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0189" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">Several properties of this class offer information about the held
                locks, such as <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CurrentReadCount</code>,
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitingReadCount</code>,
                <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitingUpgradableReadCount</code>,
                and <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitingWriteCount</code>.
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">这个类的几个属性提供了关于所持锁的信息，例如 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CurrentReadCount</code>
                            、 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitingReadCount</code>
                            、 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitingUpgradableReadCount</code>
                            和 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitingWriteCount</code>
                            。</font>
                    </font>
                </font>
            </p>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">The following example creates a collection containing six items
                and a <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ReaderWriterLockSlim</code>
                object. The method <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ReaderMethod</code> acquires
                a read lock to read all items of the list and write them to the console. The method <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WriterMethod</code> tries to
                acquire a write lock to change all values of the collection (code file <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/ReaderWriterLockSample/ReaderWriter.cs</code>):
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">以下示例创建了一个包含六个元素和 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ReaderWriterLockSlim</code>
                            对象的集合。方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ReaderMethod</code>
                            获取读锁以读取列表中的所有元素并将它们写入控制台。方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WriterMethod</code>
                            尝试获取写锁以更改集合中的所有值（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/ReaderWriterLockSample/ReaderWriter.cs</code>
                            ）：</font>
                    </font>
                </font>
            </p>
            <pre id="c17-code-0075"><code>sealed class ReaderWriter : IDisposable</code>
<code>{</code>
<code>  private List&lt;int&gt; _items = new() { 0, 1, 2, 3, 4, 5 };</code>
<code>  private ReaderWriterLockSlim _rwl = new();</code>
<code> </code>
<code>  public void ReaderMethod(object? reader)</code>
<code>  {</code>
<code>    try</code>
<code>    {</code>
<code>      <b>_rwl.EnterReadLock();</b></code>
<code> </code>
<code>      for (int i = 0; i &lt; _items.Count; i++)</code>
<code>      {</code>
<code>        Console.WriteLine($"reader {reader}, loop: {i}, item: {_items[i]}");</code>
<code>        Task.Delay(40).Wait();</code>
<code>      }</code>
<code>    }</code>
<code>    finally</code>
<code>    {</code>
<code>      <b>_rwl.ExitReadLock();</b></code>
<code>    }</code>
<code>  }</code>
<code> </code>
<code>  public void WriterMethod(object? writer)</code>
<code>  {</code>
<code>    try</code>
<code>    {</code>
<code>      while <b>(!_rwl.TryEnterWriteLock(50)</b>)</code>
<code>      {</code>
<code>        Console.WriteLine($"Writer {writer} waiting for the write lock");<span aria-label="480" epub:type="pagebreak" id="Page_480" role="doc-pagebreak"></span></code>
<code>        Console.WriteLine($"current reader count: {_rwl.CurrentReadCount}");</code>
<code>      }</code>
<code>      Console.WriteLine($"Writer {writer} acquired the lock");</code>
<code>      for (int i = 0; i &lt; _items.Count; i++)</code>
<code>      {</code>
<code>        _items[i]++;</code>
<code>        Task.Delay(50).Wait();</code>
<code>      }</code>
<code>      Console.WriteLine($"Writer {writer} finished");</code>
<code>    }</code>
<code>    finally</code>
<code>    {</code>
<code>      <b>_rwl.ExitWriteLock();</b></code>
<code>    }</code>
<code>  }</code>
<code> </code>
<code>  private void Dispose(bool disposing)</code>
<code>  {</code>
<code>    if (!disposedValue)</code>
<code>    {</code>
<code>      if (disposing)</code>
<code>      {</code>
<code>        _rwl.Dispose();</code>
<code>      }</code>
<code>      disposedValue = true;</code>
<code>    }</code>
<code>  }</code>
<code> </code>
<code>  void IDisposable.Dispose()</code>
<code>  {</code>
<code>    Dispose(disposing: true);</code>
<code>    GC.SuppressFinalize(this);</code>
<code>  }</code>
<code>}</code></pre>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">With the top-level statements, six long-running tasks are
                created: two concurrent writers and four concurrent readers. To give the first writer a good chance to
                start before the readers, a short delay is used before starting the other tasks (code file <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/ReaderWriterLockSample/Program.cs</code>):
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            使用顶层语句创建了六个长时间运行的任务：两个并发写入者和四个并发读取者。为了给第一个写入者一个良好的启动机会，在启动其他任务之前使用了一个短暂的延迟（代码文件 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/ReaderWriterLockSample/Program.cs</code>
                            ）：</font>
                    </font>
                </font>
            </p>
            <pre id="c17-code-0076"><code>using ReaderWriter rw = new();</code>
<code>TaskFactory taskFactory = new(TaskCreationOptions.LongRunning,  </code>
<code>  TaskContinuationOptions.None);</code>
<code>Task[] tasks = new Task[6];</code>
<code>tasks[0] = taskFactory.StartNew(rw.WriterMethod, 1);</code>
<code>await Task.Delay(5);</code>
<code>tasks[1] = taskFactory.StartNew(rw.ReaderMethod, 1);</code>
<code>tasks[2] = taskFactory.StartNew(rw.ReaderMethod, 2);</code>
<code>tasks[3] = taskFactory.StartNew(rw.WriterMethod, 2);</code>
<code>tasks[4] = taskFactory.StartNew(rw.ReaderMethod, 3);</code>
<code>tasks[5] = taskFactory.StartNew(rw.ReaderMethod, 4);</code>
<code> </code>
<code>Task.WaitAll(tasks);  </code></pre>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">When you run the application, the following shows that the first
                writer gets the lock first. The second writer and all readers need to wait. Next, the second writer gets
                the lock, and after this is finished, the readers can start <span aria-label="481" epub:type="pagebreak"
                    id="Page_481" role="doc-pagebreak"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>working. Running the
                application multiple times can show different results, but there's always only one writer or multiple
                readers running at any given time:<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            当你运行应用程序时，以下情况显示第一个写者首先获得锁。第二个写者和所有读者需要等待。接下来，第二个写者获得锁，完成这个操作后，读者可以开始工作。多次运行应用程序可能会显示不同的结果，但任何时候都只有一个写者或多个读者在运行：
                        </font>
                    </font>
                </font>
            </p>
            <pre id="c17-code-0077"><code>Writer 1 acquired the lock</code>
<code>Starting writer 2</code>
<code>Starting reader 2</code>
<code>Starting reader 3</code>
<code>Starting reader 1</code>
<code>Starting reader 4</code>
<code>Writer 2 waiting for the write lock, current readers: 0</code>
<code>Writer 2 waiting for the write lock, current readers: 0</code>
<code>Writer 2 waiting for the write lock, current readers: 0</code>
<code>Writer 2 waiting for the write lock, current readers: 0</code>
<code>Writer 2 waiting for the write lock, current readers: 0</code>
<code>Writer 1 finished</code>
<code>Writer 2 acquired the lock</code>
<code>Writer 2 finished</code>
<code>reader 3, loop: 0, item: 2</code>
<code>reader 1, loop: 0, item: 2</code>
<code>reader 2, loop: 0, item: 2</code>
<code>…</code></pre>
            <aside data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                <div class="top hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                    <hr />
                </div>
                <section class="feature2" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                    <p id="c17-para-0194" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                        data-immersive-translate-paragraph="1"><b
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">NOTE</b> <i
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">A group of
                            collections that do not need locking are immutable collections defined in the namespace </i>
                        <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">System.Collections.Immutable</code>
                        <i data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">. These collection
                            types are covered in <a href="c08.xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Chapter 8</a>,
                            “Collections.” Other thread-safe collections are collections from the namespace </i> <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">System.Collections.Concurrent</code>
                        <i data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">. The </i> <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">BlockingCollection</code>
                        <i data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"> offers </i> <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Add</code> <i
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"> and </i> <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryAdd</code> <i
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"> methods to add
                            items. The </i> <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Add</code> <i
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"> method blocks, while
                            the </i> <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryAdd</code> <i
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"> method returns </i>
                        <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">true</code> <i
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"> or </i> <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">false</code> <i
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"> depending on whether
                            it was possible to add the item. To retrieve items from the collection, the </i> <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Take</code> <i
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"> method blocks while
                        </i> <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryTake</code>
                        <i data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"> returns </i> <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">true</code> <i
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"> or </i> <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">false</code> <i
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"> to indicate whether
                            it was successful taking an item from the collection. The </i> <code
                            data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">BlockingCollection</code>
                        <i data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"> class can be used for
                            a producer/consumer scenario. A more modern approach for a producer/consumer scenario is
                            offered from channels, as shown in the section “Channels.”</i>
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">注意：一组不需要锁的集合是不可变集合，这些集合定义在命名空间
                                    <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">System.Collections.Immutable</code>
                                    中。这些集合类型在“集合”章节中介绍。其他线程安全的集合来自命名空间 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">System.Collections.Concurrent</code>
                                    。 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">BlockingCollection</code>
                                    提供了 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Add</code>
                                    和 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryAdd</code>
                                    方法来添加元素。 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Add</code>
                                    方法会阻塞，而 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryAdd</code>
                                    方法会根据是否成功添加元素返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">true</code>
                                    或 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">false</code>
                                    。要从集合中检索元素， <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Take</code>
                                    方法会阻塞，而 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">TryTake</code>
                                    方法会返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">true</code>
                                    或 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">false</code>
                                    来指示是否成功从集合中取出元素。 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">BlockingCollection</code>
                                    类可用于生产者/消费者场景。对于生产者/消费者场景，一种更现代的方法是使用通道，如“通道”部分所示。</font>
                            </font>
                        </font>
                    </p>
                    <div class="bottom hr" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                        <hr />
                    </div>
                </section>
            </aside>
        </section>
        <section aria-labelledby="head-2-162" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
            <span id="c17-sec-0057" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
            <h2 id="head-2-162" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">LOCKS WITH AWAIT<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">带 AWAIT 的锁</font>
                    </font>
                </font>
            </h2>
            <p id="c17-para-0195" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">In case you try to use the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code> keyword while
                having the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">async</code>
                keyword in the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code>
                block, you get this compilation error: <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">cannot await in the body of a lock statement</code>.
                The reason is that after the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">async</code> completes, the
                method might run in a different thread than before the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">async</code> keyword. The
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code> keyword needs
                to release the lock in the same thread as the lock is acquired.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">如果你在 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code> 块中使用了
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code>
                            关键字，同时存在 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">async</code>
                            关键字，你会得到这个编译错误： <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">cannot await in the body of a lock statement</code>
                            。原因是 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">async</code>
                            完成后，方法可能会在不同于 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">async</code>
                            关键字之前的线程中运行。 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code>
                            关键字需要在获取锁的同一线程中释放锁。</font>
                    </font>
                </font>
            </p>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">Such a code block results in compilation errors:<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">这样的代码块会导致编译错误：</font>
                    </font>
                </font>
            </p>
            <pre id="c17-code-0078"><code>static async Task IncorrectLockAsync()</code>
<code>{</code>
<code>  <b>lock (s_syncLock)</b></code>
<code>  <b>{</b></code>
<code>    Console.WriteLine($"{nameof(IncorrectLockAsync)} started");</code>
<code>    await Task.Delay(500);  // compiler error: cannot await in the body </code>
<code>      // of a lock statement</code>
<code>    Console.WriteLine($"{nameof(IncorrectLockAsync)} ending");</code>
<code>  <b>}</b></code>
<code>}</code></pre>
            <p id="c17-para-0197" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1"><span aria-label="482" epub:type="pagebreak" id="Page_482"
                    role="doc-pagebreak"
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>How can this be
                solved? You cannot use a <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Monitor</code> for this, as
                the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Monitor</code> needs to
                release the lock from the same thread where it entered the lock. The <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code> keyword is based
                on <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Monitor</code>.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">如何解决这个问题？你不能使用 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Monitor</code>
                            来解决这个问题，因为 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Monitor</code>
                            需要在进入锁的同一线程中释放锁。 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code> 关键字基于
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Monitor</code> 。
                        </font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0198" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">While the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Mutex</code> object can be
                used for synchronization across different processes, it has the same issues: it grants a lock for a
                thread. Releasing the lock from a different thread is not possible. Instead, you can use the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Semaphore</code>— or the
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SemaphoreSlim</code> class.
                Semaphores can release the semaphore from a different thread.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">虽然 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Mutex</code>
                            对象可以用于跨不同进程的同步，但它存在同样的问题：它为线程授予锁。从不同线程释放锁是不可能的。相反，你可以使用 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Semaphore</code>
                            — 或 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SemaphoreSlim</code>
                            类。信号量可以从不同线程释放。</font>
                    </font>
                </font>
            </p>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">The following code snippet waits to acquire a semaphore using
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitAsync</code> on a <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SemaphoreSlim</code> object.
                The <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SemaphoreSlim</code>
                object is initialized with a count of 1; thus, the wait on the semaphore is granted only once. In the
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">finally</code> code block,
                the semaphore is released by invoking the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Release</code> method (code
                file <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/LockAcrossAwait/Program.cs</code>):
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">以下代码片段使用 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitAsync</code>
                            在 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SemaphoreSlim</code>
                            对象上等待获取信号量。 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SemaphoreSlim</code>
                            对象初始化为计数 1；因此，信号量的等待只被允许一次。在 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">finally</code>
                            代码块中，通过调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Release</code>
                            方法释放信号量（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/LockAcrossAwait/Program.cs</code>
                            ）：</font>
                    </font>
                </font>
            </p>
            <pre id="c17-code-0079"><code><b>private static SemaphoreSlim s_asyncLock = new(1);</b></code>
<code>static async Task LockWithSemaphore(string title)</code>
<code>{</code>
<code>  Console.WriteLine($"{title} waiting for lock");</code>
<code>  <b>await s_asyncLock.WaitAsync();</b></code>
<code>  try</code>
<code>  {</code>
<code>    Console.WriteLine($"{title} {nameof(LockWithSemaphore)} started");</code>
<code>    await Task.Delay(500);</code>
<code>    Console.WriteLine($"{title} {nameof(LockWithSemaphore)} ending");</code>
<code>  }</code>
<code>  finally</code>
<code>  {</code>
<code>    <b>s_asyncLock.Release();</b></code>
<code>  }</code>
<code>}</code></pre>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">Let's try to invoke this method from multiple tasks concurrently.
                The method <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">RunUseSemaphoreAsync</code>
                starts six tasks to invoke the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">LockWithSemaphore</code>
                method concurrently.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">让我们尝试从多个任务中同时调用这个方法。方法 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">RunUseSemaphoreAsync</code>
                            启动六个任务来同时调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">LockWithSemaphore</code>
                            方法。</font>
                    </font>
                </font>
            </p>
            <pre id="c17-code-0080"><code>static async Task RunUseSemaphoreAsync()</code>
<code>{</code>
<code>  Console.WriteLine(nameof(RunUseSemaphoreAsync));</code>
<code>  string[] messages = { "one", "two", "three", "four", "five", "six" };</code>
<code>  Task[] tasks = new Task[messages.Length];</code>
<code> </code>
<code>  for (int i = 0; i &lt; messages.Length; i++)</code>
<code>  {</code>
<code>    string message = messages[i];</code>
<code> </code>
<code>    tasks[i] = Task.Run(async () =&gt;</code>
<code>    {</code>
<code>      await LockWithSemaphore(message);</code>
<code>    });</code>
<code>  }</code>
<code> </code>
<code>  await Task.WhenAll(tasks);</code>
<code>  Console.WriteLine();</code>
<code>}</code></pre>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">When you run the program, you can see that multiple tasks are
                started concurrently, but after the semaphore is locked, all other tasks need to wait until the
                semaphore is released again:<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            当你运行程序时，可以看到多个任务同时启动，但在信号量被锁定后，所有其他任务都需要等待信号量再次被释放：</font>
                    </font>
                </font>
            </p>
            <pre id="c17-code-0081"><code>RunLockWithAwaitAsync</code>
<code>two waiting for lock</code>
<code>two LockWithSemaphore started<span aria-label="483" epub:type="pagebreak" id="Page_483" role="doc-pagebreak"></span></code>
<code>three waiting for lock</code>
<code>five waiting for lock</code>
<code>four waiting for lock</code>
<code>six waiting for lock</code>
<code>one waiting for lock</code>
<code>two LockWithSemaphore ending</code>
<code>three LockWithSemaphore started</code>
<code>three LockWithSemaphore ending</code>
<code>five LockWithSemaphore started</code>
<code>five LockWithSemaphore ending</code>
<code>four LockWithSemaphore started</code>
<code>four LockWithSemaphore ending</code>
<code>six LockWithSemaphore started</code>
<code>six LockWithSemaphore ending</code>
<code>one LockWithSemaphore started</code>
<code>one LockWithSemaphore ending</code></pre>
            <p id="c17-para-0202" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">To make the use of the lock easier, you can create a class that
                implements the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">IDisposable</code> interface
                to manage the resource. With this class, you can use the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">using</code> statement in the
                same way as the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code>
                statement is used to lock and release the semaphore.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">为了让锁的使用更方便，你可以创建一个实现 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">IDisposable</code>
                            接口来管理资源的类。有了这个类，你可以像使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code>
                            语句锁定和释放信号量一样，使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">using</code> 语句。
                        </font>
                    </font>
                </font>
            </p>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">The following code snippet implements the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">AsyncSemaphore</code> class
                that allocates a <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SemaphoreSlim</code> in the
                constructor, and on invoking the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitAsync</code> method on
                the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">AsyncSemaphore</code>,
                the inner class <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SemaphoreReleaser</code> is
                returned, which implements the interface <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">IDisposable</code>. On
                calling the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Dispose</code>
                method, the semaphore is released (code file <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/LockAcrossAwait/AsyncSemaphore.cs</code>):
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">以下代码片段实现了 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">AsyncSemaphore</code>
                            类，它在构造函数中分配一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SemaphoreSlim</code>
                            ，并在对 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">AsyncSemaphore</code>
                            调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">WaitAsync</code>
                            方法时返回内部类 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SemaphoreReleaser</code>
                            ，该内部类实现了接口 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">IDisposable</code>
                            。调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Dispose</code>
                            方法时，会释放信号量（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/LockAcrossAwait/AsyncSemaphore.cs</code>
                            ）：</font>
                    </font>
                </font>
            </p>
            <pre id="c17-code-0082"><code>public sealed class AsyncSemaphore </code>
<code>{</code>
<code>  private class SemaphoreReleaser : IDisposable</code>
<code>  {</code>
<code>    private SemaphoreSlim _semaphore;</code>
<code> </code>
<code>    public SemaphoreReleaser(SemaphoreSlim semaphore) =&gt;</code>
<code>      _semaphore = semaphore;</code>
<code> </code>
<code>    public void Dispose() =&gt; <b>_semaphore.Release();</b></code>
<code>  }</code>
<code> </code>
<code>  private SemaphoreSlim _semaphore;</code>
<code>  public AsyncSemaphore() =&gt;</code>
<code>    <b>_semaphore = new SemaphoreSlim(1);</b></code>
<code> </code>
<code>  public async Task&lt;IDisposable&gt; WaitAsync()</code>
<code>  {</code>
<code>    <b>await _semaphore.WaitAsync();</b></code>
<code>    return new SemaphoreReleaser(_semaphore) as IDisposable;</code>
<code>  }</code>
<code>}</code></pre>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">Changing the implementation from the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">LockWithSemaphore</code>
                method shown previously, now a <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">using</code> statement can be
                used where the semaphore is locked. Remember, the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">using</code> statement
                creates a <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">catch</code>
                /
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">finally</code> block, and
                in the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">finally</code>
                block, the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Dispose</code>
                method gets invoked (code file <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/LockAcrossAwait/Program.cs</code>):
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">改变之前展示的 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">LockWithSemaphore</code>
                            方法的实现，现在可以在信号量锁定的地方使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">using</code>
                            语句。记住， <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">using</code>
                            语句会创建一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">catch</code> /
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">finally</code>
                            块，在 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">finally</code>
                            块中， <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Dispose</code>
                            方法会被调用（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">SynchronizationSamples/LockAcrossAwait/Program.cs</code>
                            ）：</font>
                    </font>
                </font>
            </p>
            <pre id="c17-code-0083"><code>private static AsyncSemaphore s_asyncSemaphore = new AsyncSemaphore();</code>
<code>static async Task UseAsyncSemaphore(string title)</code>
<code>{<span aria-label="484" epub:type="pagebreak" id="Page_484" role="doc-pagebreak"></span></code>
<code>  using (await s_asyncSemaphore.WaitAsync())</code>
<code>  {</code>
<code>    Console.WriteLine($"{title} {nameof(LockWithSemaphore)} started");</code>
<code>    await Task.Delay(500);</code>
<code>    Console.WriteLine($"{title} {nameof(LockWithSemaphore)} ending");</code>
<code>  }</code>
<code>}</code></pre>
            <p id="c17-para-0205" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">Using the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">UseAsyncSemaphore</code>
                method similarly to the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">LockWithSemaphore</code>
                method results in the same behavior. However, with a class written once, locking across <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">await</code> becomes simpler.
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">使用与 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">LockWithSemaphore</code>
                            方法类似的方式使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">UseAsyncSemaphore</code>
                            方法会产生相同的行为。然而，一旦编写好一个类，跨 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">await</code>
                            的锁定就变得简单。</font>
                    </font>
                </font>
            </p>
        </section>
        <section aria-labelledby="head-2-163" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
            <span id="c17-sec-0058" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"></span>
            <h2 id="head-2-163" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">SUMMARY<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">摘要</font>
                    </font>
                </font>
            </h2>
            <p id="c17-para-0206" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">This chapter explored how to code applications that use multiple
                tasks by using the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">System.Threading.Tasks</code>
                namespace. Using multithreading in your applications takes careful planning. Too many threads can cause
                resource issues, but not enough threads can cause your application to be sluggish and perform poorly.
                With tasks, you get an abstraction to threads. This abstraction helps you avoid creating too many
                threads because threads are reused from a pool.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">本章探讨了如何使用 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">System.Threading.Tasks</code>
                            命名空间编写使用多个任务的应用程序。在应用程序中使用多线程需要仔细规划。线程太多会导致资源问题，而线程不足会使应用程序反应迟缓且性能不佳。通过任务，你获得了一个线程的抽象。这种抽象帮助你避免创建过多线程，因为线程是从一个线程池中重用的。
                        </font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0207" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">You've seen various ways to create multiple tasks, such as the
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code> class,
                which offers both task and data parallelism with <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.Invoke</code>, <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.ForEach</code>, and
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.For</code>. With
                the <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code> class,
                you've seen how to gain more control over parallel programming. Tasks can run synchronously in the
                calling thread, using a thread from a thread pool, and a separate new thread can be created. Tasks also
                offer a hierarchical model that enables the creation of child tasks, also providing a way to cancel a
                complete hierarchy.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">你已经看到了多种创建多个任务的方法，例如 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel</code>
                            类，它通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.Invoke</code>
                            、 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.ForEach</code>
                            和 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Parallel.For</code>
                            提供任务和数据并行性。通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Task</code>
                            类，你了解了如何对并行编程获得更多控制。任务可以在调用线程中同步运行，使用线程池中的线程，或者创建一个单独的新线程。任务还提供了一个分层模型，可以创建子任务，并提供了一种取消整个层次结构的方法。
                        </font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0208" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">The cancellation framework offers a standard mechanism that can
                be consistently used with different classes to cancel a task early.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            取消框架提供了一个标准机制，可以始终如一地与不同的类一起使用，以提前取消任务。</font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0209" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">You've seen several synchronization objects that are available
                with .NET, and each has advantages and disadvantages. An easy synchronization can be done using the
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code> keyword. Behind
                the scenes, it's the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Monitor</code> type that
                allows setting timeouts, which is not possible with the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code> keyword. For
                synchronization between processes, the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Mutex</code> object offers
                similar functionality. With the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Semaphore</code> object
                you've seen a synchronization object with a count—some tasks are allowed to run concurrently. To inform
                others of information that is ready, various kinds of event objects have been discussed, such as the
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">AutoResetEvent</code>,
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ManualResetEvent</code>,
                and <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CountdownEvent</code>.
                A straightforward way to have multiple readers and one writer is offered by the <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ReaderWriterLock</code>. The
                <code data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Barrier</code> type allows
                for more complex scenarios where multiple tasks can run concurrently until a synchronization point is
                reached. As soon as all tasks reach this point, all can continue concurrently to meet at the next
                synchronization point.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">您已经看到了.NET 中可用的几种同步对象，每个对象都有其优缺点。使用
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code>
                            关键字可以轻松实现同步。在后台，它是 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Monitor</code>
                            类型，允许设置超时，而 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">lock</code>
                            关键字则无法实现这一点。对于进程间的同步， <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Mutex</code>
                            对象提供了类似的功能。通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Semaphore</code>
                            对象，您看到了一个带有计数的同步对象——允许某些任务并发运行。为了通知其他进程信息已准备好，讨论了各种事件对象，如 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">AutoResetEvent</code>
                            、 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ManualResetEvent</code>
                            和 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">CountdownEvent</code>
                            。通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">ReaderWriterLock</code>
                            ，提供了一种让多个读取者和一个写入者共存的方式。 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">Barrier</code>
                            类型允许更复杂的场景，其中多个任务可以并发运行，直到达到同步点。一旦所有任务都到达这一点，所有任务都可以继续并发运行，以在下一个同步点汇合。</font>
                    </font>
                </font>
            </p>
            <p id="c17-para-0210" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">With <code
                    data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">System.Threading.Channels</code>,
                you've seen a new flexible option for publish/subscribe communication using bounded and unbounded
                channels.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">通过 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">System.Threading.Channels</code>
                            ，您看到了一种新的灵活选项，用于使用有界和无界通道进行发布/订阅通信。</font>
                    </font>
                </font>
            </p>
            <p data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">Here are some final guidelines regarding threading:<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">以下是关于线程的一些最终指南：</font>
                    </font>
                </font>
            </p>
            <ul class="check" id="c17-list-0004" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e">
                <li id="c17-li-0025" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Try to keep synchronization requirements to a minimum.
                    Synchronization is complex and blocks threads. You can avoid it if you try to avoid sharing state.
                    Of course, this is not always possible.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                尽量减少同步需求。同步很复杂，会阻塞线程。如果你避免共享状态，就可以避免同步。当然，这并非总是可行。</font>
                        </font>
                    </font>
                </li>
                <li id="c17-li-0026" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Static members of a class should be thread-safe. Usually,
                    this is the case with classes offered with .NET.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">类的静态成员应该是线程安全的。通常，.NET 提供的类都是这样。
                            </font>
                        </font>
                    </font>
                </li>
                <li id="c17-li-0027" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                    data-immersive-translate-paragraph="1">Instance state does not need to be thread-safe. For best
                    performance, synchronization is best used outside the class where it is needed, and not with every
                    member of the class. Instance members of .NET classes usually are not thread-safe. In the Microsoft
                    API documentation, you can find this information documented for every class of .NET in the “Thread
                    Safety” section.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                实例状态不需要线程安全。为了最佳性能，同步最好用于需要它的类外部，而不是类的每个成员。.NET 类的实例成员通常不是线程安全的。在 Microsoft API
                                文档中，你可以在“线程安全”部分找到每个.NET 类的相关信息。</font>
                        </font>
                    </font>
                </li>
            </ul>
            <p id="c17-para-0212" data-immersive-translate-walked="0ebdb4ea-40b5-40ff-a1df-37d6367a7b1e"
                data-immersive-translate-paragraph="1">The next chapter gives information on another core .NET topic:
                files and streams.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">下一章将介绍.NET 的另一个核心主题：文件和流。</font>
                    </font>
                </font>
            </p>
        </section>
    </section>
</body>
<div id="immersive-translate-popup" style="all: initial"></div>

</html>