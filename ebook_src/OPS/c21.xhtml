<!-- 这行注释会存在于经过翻译的源文件中。除非您获得许可请不要删除这个注释。
    翻译由 ClassicByte Org 的 higashitani yume 完成
    使用工具 沉浸式翻译 智谱GLM模型
    您可以阅读这个源代码，也可以向他人分发此源代码，但是不得用于商业用途。
    您也可以自己将这些代码打包成epub分发给别人，但是不得用于商业用途。
    如果此源代码侵犯了您的权益，请联系我我将会删除侵权内容。
    您在阅读此源代码时，可能会看到一些英文内容，这些内容是原书的内容，可能是因为翻译不准确或者是因为原书的内容没有被翻译。
    如果您发现了错误，请联系我我会进行修正。
  -->
<!--This line of comments will exist in the translated source file. Do not delete this comment unless you have permission.
    Translation is done by ClassicByte Org's higashitani yume
    Usage Tools Immersive Translation Zhipu GLM Model
    You can read this source code or distribute it to others, but it may not be used for commercial purposes.
    You can also package these codes yourself into epub and distribute them to others, but they may not be used for commercial purposes.
    If this source code infringes your rights, please contact me and I will delete the infringing content.
    When you read this source code, you may see some English content, which is the content of the original book, which may be because the translation is inaccurate or because the content of the original book has not been translated.
    If you find an error, please contact me and I will correct it.
  -->
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops"
    xmlns:svg="http://www.w3.org/2000/svg" epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en"
    imt-state="dual" imt-trans-position="after">

<head>
    <title>21 Entity Framework Core --- 21 Entity Framework Core</title>
    <link href="WileyTemplate_v5.5.css" rel="stylesheet" type="text/css" />
    <meta content="urn:uuid:e0000000-0000-0000-0000-000006715209" name="Adept.expected.resource" />
    <style data-id="immersive-translate-input-injected-css">
        .immersive-translate-input {
            position: absolute;
            top: 0;
            right: 0;
            left: 0;
            bottom: 0;
            z-index: 2147483647;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .immersive-translate-attach-loading::after {
            content: " ";

            --loading-color: #f78fb6;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: block;
            margin: 12px auto;
            position: relative;
            color: white;
            left: -100px;
            box-sizing: border-box;
            animation: immersiveTranslateShadowRolling 1.5s linear infinite;

            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-2000%, -50%);
            z-index: 100;
        }

        .immersive-translate-loading-spinner {
            vertical-align: middle !important;
            width: 10px !important;
            height: 10px !important;
            display: inline-block !important;
            margin: 0 4px !important;
            border: 2px rgba(221, 244, 255, 0.6) solid !important;
            border-top: 2px rgba(0, 0, 0, 0.375) solid !important;
            border-left: 2px rgba(0, 0, 0, 0.375) solid !important;
            border-radius: 50% !important;
            padding: 0 !important;
            -webkit-animation: immersive-translate-loading-animation 0.6s infinite linear !important;
            animation: immersive-translate-loading-animation 0.6s infinite linear !important;
        }

        @-webkit-keyframes immersive-translate-loading-animation {
            from {
                -webkit-transform: rotate(0deg);
            }

            to {
                -webkit-transform: rotate(359deg);
            }
        }

        @keyframes immersive-translate-loading-animation {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(359deg);
            }
        }

        .immersive-translate-input-loading {
            --loading-color: #f78fb6;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: block;
            margin: 12px auto;
            position: relative;
            color: white;
            left: -100px;
            box-sizing: border-box;
            animation: immersiveTranslateShadowRolling 1.5s linear infinite;
        }

        @keyframes immersiveTranslateShadowRolling {
            0% {
                box-shadow: 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0),
                    0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
            }

            12% {
                box-shadow: 100px 0 var(--loading-color), 0px 0 rgba(255, 255, 255, 0),
                    0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
            }

            25% {
                box-shadow: 110px 0 var(--loading-color), 100px 0 var(--loading-color),
                    0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
            }

            36% {
                box-shadow: 120px 0 var(--loading-color), 110px 0 var(--loading-color),
                    100px 0 var(--loading-color), 0px 0 rgba(255, 255, 255, 0);
            }

            50% {
                box-shadow: 130px 0 var(--loading-color), 120px 0 var(--loading-color),
                    110px 0 var(--loading-color), 100px 0 var(--loading-color);
            }

            62% {
                box-shadow: 200px 0 rgba(255, 255, 255, 0), 130px 0 var(--loading-color),
                    120px 0 var(--loading-color), 110px 0 var(--loading-color);
            }

            75% {
                box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0),
                    130px 0 var(--loading-color), 120px 0 var(--loading-color);
            }

            87% {
                box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0),
                    200px 0 rgba(255, 255, 255, 0), 130px 0 var(--loading-color);
            }

            100% {
                box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0),
                    200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0);
            }
        }

        .immersive-translate-toast {
            display: flex;
            position: fixed;
            z-index: 2147483647;
            left: 0;
            right: 0;
            top: 1%;
            width: fit-content;
            padding: 12px 20px;
            margin: auto;
            overflow: auto;
            background: #fef6f9;
            box-shadow: 0px 4px 10px 0px rgba(0, 10, 30, 0.06);
            font-size: 15px;
            border-radius: 8px;
            color: #333;
        }

        .immersive-translate-toast-content {
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        .immersive-translate-toast-hidden {
            margin: 0 20px 0 72px;
            text-decoration: underline;
            cursor: pointer;
        }

        .immersive-translate-toast-close {
            color: #666666;
            font-size: 20px;
            font-weight: bold;
            padding: 0 10px;
            cursor: pointer;
        }

        @media screen and (max-width: 768px) {
            .immersive-translate-toast {
                top: 0;
                padding: 12px 0px 0 10px;
            }

            .immersive-translate-toast-content {
                flex-direction: column;
                text-align: center;
            }

            .immersive-translate-toast-hidden {
                margin: 10px auto;
            }
        }

        .immersive-translate-modal {
            display: none;
            position: fixed;
            z-index: 2147483647;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0, 0, 0);
            background-color: rgba(0, 0, 0, 0.4);
            font-size: 15px;
        }

        .immersive-translate-modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 40px 24px 24px;
            border: 1px solid #888;
            border-radius: 10px;
            width: 80%;
            max-width: 270px;
            font-family: system-ui, -apple-system, "Segoe UI", "Roboto", "Ubuntu",
                "Cantarell", "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji",
                "Segoe UI Symbol", "Noto Color Emoji";
            position: relative;
        }

        @media screen and (max-width: 768px) {
            .immersive-translate-modal-content {
                margin: 50% auto !important;
            }
        }

        .immersive-translate-modal .immersive-translate-modal-content-in-input {
            max-width: 500px;
        }

        .immersive-translate-modal-content-in-input .immersive-translate-modal-body {
            text-align: left;
            max-height: unset;
        }

        .immersive-translate-modal-title {
            text-align: center;
            font-size: 16px;
            font-weight: 700;
            color: #333333;
        }

        .immersive-translate-modal-body {
            text-align: center;
            font-size: 14px;
            font-weight: 400;
            color: #333333;
            word-break: break-all;
            margin-top: 24px;
        }

        @media screen and (max-width: 768px) {
            .immersive-translate-modal-body {
                max-height: 250px;
                overflow-y: auto;
            }
        }

        .immersive-translate-close {
            color: #666666;
            position: absolute;
            right: 16px;
            top: 16px;
            font-size: 20px;
            font-weight: bold;
        }

        .immersive-translate-close:hover,
        .immersive-translate-close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .immersive-translate-modal-footer {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 24px;
        }

        .immersive-translate-btn {
            width: fit-content;
            color: #fff;
            background-color: #ea4c89;
            border: none;
            font-size: 16px;
            margin: 0 8px;
            padding: 9px 30px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .immersive-translate-btn:hover {
            background-color: #f082ac;
        }

        .immersive-translate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .immersive-translate-btn:disabled:hover {
            background-color: #ea4c89;
        }

        .immersive-translate-cancel-btn {
            /* gray color */
            background-color: rgb(89, 107, 120);
        }

        .immersive-translate-cancel-btn:hover {
            background-color: hsl(205, 20%, 32%);
        }

        .immersive-translate-action-btn {
            background-color: transparent;
            color: #ea4c89;
            border: 1px solid #ea4c89;
        }

        .immersive-translate-btn svg {
            margin-right: 5px;
        }

        .immersive-translate-link {
            cursor: pointer;
            user-select: none;
            -webkit-user-drag: none;
            text-decoration: none;
            color: #007bff;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
        }

        .immersive-translate-primary-link {
            cursor: pointer;
            user-select: none;
            -webkit-user-drag: none;
            text-decoration: none;
            color: #ea4c89;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
        }

        .immersive-translate-modal input[type="radio"] {
            margin: 0 6px;
            cursor: pointer;
        }

        .immersive-translate-modal label {
            cursor: pointer;
        }

        .immersive-translate-close-action {
            position: absolute;
            top: 2px;
            right: 0px;
            cursor: pointer;
        }

        .imt-image-status {
            background-color: rgba(0, 0, 0, 0.5) !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 16px !important;
        }

        .imt-image-status img,
        .imt-image-status svg,
        .imt-img-loading {
            width: 28px !important;
            height: 28px !important;
            margin: 0 0 8px 0 !important;
            min-height: 28px !important;
            min-width: 28px !important;
            position: relative !important;
        }

        .imt-img-loading {
            background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADgAAAA4CAMAAACfWMssAAAAtFBMVEUAAAD////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////oK74hAAAAPHRSTlMABBMIDyQXHwyBfFdDMSw+OjXCb+5RG51IvV/k0rOqlGRM6KKMhdvNyZBz9MaupmxpWyj437iYd/yJVNZeuUC7AAACt0lEQVRIx53T2XKiUBCA4QYOiyCbiAsuuGBcYtxiYtT3f6/pbqoYHVFO5r+iivpo6DpAWYpqeoFfr9f90DsYAuRSWkFnPO50OgR9PwiCUFcl2GEcx+N/YBh6pvKaefHlUgZd1zVe0NbYcQjGBfzrPE8Xz8aF+71D8gG6DHFPpc4a7xFiCDuhaWgKgGIJQ3d5IMGDrpS4S5KgpIm+en9f6PlAhKby4JwEIxlYJV9h5k5nee9GoxHJ2IDSNB0dwdad1NAxDJ/uXDHYmebdk4PdbkS58CIVHdYSUHTYYRWOJblWSyu2lmy3KNFVJNBhxcuGW4YBVCbYGRZwIooipHsNqjM4FbgOQqQqSKQQU9V8xmi1QlgHqQQ6DDBvRUVCDirs+EzGDGOQTCATgtYTnbCVLgsVgRE0T1QE0qHCFAht2z6dLvJQs3Lo2FQoDxWNUiBhaP4eRgwNkI+dAjVOA/kUrIDwf3CG8NfNOE0eiFotSuo+rBiq8tD9oY4Qzc6YJw99hl1wzpQvD7ef2M8QgnOGJfJw+EltQc+oX2yn907QB22WZcvlUpd143dqQu+8pCJZuGE4xCuPXJqqcs5sNpsI93Rmzym1k4Npk+oD1SH3/a3LOK/JpUBpWfqNySxWzCfNCUITuDG5dtuphrUJ1myeIE9bIsPiKrfqTai5WZxbhtNphYx6GEIHihyGFTI69lje/rxajdh0s0msZ0zYxyPLhYCb1CyHm9Qsd2H37Y3lugVwL9kNh8Ot8cha6fUNQ8nuXi5z9/ExsAO4zQrb/ev1yrCB7lGyQzgYDGuxq1toDN/JGvN+HyWNHKB7zEoK+PX11e12G431erGYzwmytAWU56fkMHY5JJnDRR2eZji3AwtIcrEV8Cojat/BdQ7XOwGV1e1hDjGGjXbdArm8uJZtCH5MbcctVX8A1WpqumJHwckAAAAASUVORK5CYII=");
            background-size: 28px 28px;
            animation: image-loading-rotate 1s linear infinite !important;
        }

        .imt-image-status span {
            color: var(--bg-2, #fff) !important;
            font-size: 14px !important;
            line-height: 14px !important;
            font-weight: 500 !important;
            font-family: "PingFang SC", Arial, sans-serif !important;
        }

        @keyframes image-loading-rotate {
            from {
                transform: rotate(360deg);
            }

            to {
                transform: rotate(0deg);
            }
        }
    </style>
    <style data-id="immersive-translate-default-injected-css">
        :root {
            --immersive-translate-theme-underline-borderColor: #72ece9;
            --immersive-translate-theme-nativeUnderline-borderColor: #72ece9;
            --immersive-translate-theme-nativeDashed-borderColor: #72ece9;
            --immersive-translate-theme-nativeDotted-borderColor: #72ece9;
            --immersive-translate-theme-highlight-backgroundColor: #ffff00;
            --immersive-translate-theme-dashed-borderColor: #59c1bd;
            --immersive-translate-theme-blockquote-borderColor: #cc3355;
            --immersive-translate-theme-thinDashed-borderColor: #ff374f;
            --immersive-translate-theme-dashedBorder-borderColor: #94a3b8;
            --immersive-translate-theme-dashedBorder-borderRadius: 0;
            --immersive-translate-theme-solidBorder-borderColor: #94a3b8;
            --immersive-translate-theme-solidBorder-borderRadius: 0;
            --immersive-translate-theme-dotted-borderColor: #94a3b8;
            --immersive-translate-theme-wavy-borderColor: #72ece9;
            --immersive-translate-theme-dividingLine-borderColor: #94a3b8;
            --immersive-translate-theme-grey-textColor: #2f4f4f;
            --immersive-translate-theme-marker-backgroundColor: #fbda41;
            --immersive-translate-theme-marker-backgroundColor-rgb: 251, 218, 65;
            --immersive-translate-theme-marker2-backgroundColor: #ffff00;
            --immersive-translate-theme-background-backgroundColor: #dbafaf;
            --immersive-translate-theme-background-backgroundColor-rgb: 219, 175, 175;
            --immersive-translate-theme-background-backgroundOpacity: 12;
            --immersive-translate-theme-opacity-opacity: 10;
        }

        [imt-state="dual"] .immersive-translate-target-translation-pre-whitespace {
            white-space: pre-wrap !important;
        }

        [imt-state="dual"] .immersive-translate-pdf-target-container {
            position: absolute;
            background-color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica,
                sans-serif;
            top: 0;
            width: 600px;
            height: 100%;
            z-index: 2;
            line-height: 1.3;
            font-size: 16px;
        }

        [imt-state="dual"] .immersive-translate-target-wrapper[dir="rtl"] {
            text-align: right;
        }

        [imt-state="dual"] .immersive-translate-pdf-target-container .immersive-translate-target-wrapper {
            color: rgb(0, 0, 0);
            white-space: normal;
            position: absolute;
        }

        [imt-state="dual"] .immersive-translate-pdf-target-container .immersive-translate-target-wrapper font {
            color: inherit;
            white-space: inherit;
            position: unset;
        }

        [imt-state="translation"] .immersive-translate-target-wrapper &gt;

        br {
            display: none;
        }

        [imt-state="translation"] .immersive-translate-target-translation-block-wrapper {
            margin: 0 !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper {
            margin: 8px 0 !important;
            display: inline-block;
        }

        [imt-trans-position="before"] .immersive-translate-target-translation-block-wrapper {
            display: block;
        }

        [imt-trans-position="before"] .immersive-translate-target-translation-block-wrapper {
            margin-top: 0 !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-pdf-block-wrapper {
            margin: 0 !important;
            display: inline-block;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-grey-inner {
            color: var(--immersive-translate-theme-grey-textColor);
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-underline-inner {
            border-bottom: 1px solid var(--immersive-translate-theme-underline-borderColor) !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-nativeUnderline-inner {
            text-decoration: underline !important;
            text-decoration-color: var(--immersive-translate-theme-nativeUnderline-borderColor) !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper-theme-dashedBorder {
            border: 1px dashed var(--immersive-translate-theme-dashedBorder-borderColor) !important;
            border-radius: var(--immersive-translate-theme-dashedBorder-borderRadius) !important;
            padding: 6px;
            margin-top: 2px;
            display: inline-block;
        }

        [imt-state="dual"] .immersive-translate-target-translation-inline-wrapper-theme-dashedBorder {
            border: 1px dashed var(--immersive-translate-theme-dashedBorder-borderColor) !important;
            border-radius: var(--immersive-translate-theme-dashedBorder-borderRadius) !important;
            padding: 2px;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper-theme-solidBorder {
            border: 1px solid var(--immersive-translate-theme-solidBorder-borderColor) !important;
            border-radius: var(--immersive-translate-theme-solidBorder-borderRadius) !important;
            padding: 6px;
            margin-top: 2px;
            display: inline-block;
        }

        [imt-state="dual"] .immersive-translate-target-translation-inline-wrapper-theme-solidBorder {
            border: 1px solid var(--immersive-translate-theme-solidBorder-borderColor) !important;
            border-radius: var(--immersive-translate-theme-solidBorder-borderRadius) !important;
            padding: 2px;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-nativeDashed-inner {
            text-decoration: underline !important;
            text-decoration-color: var(--immersive-translate-theme-nativeDashed-borderColor) !important;
            text-decoration-style: dashed !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-thinDashed-inner {
            border-bottom: 1px dashed var(--immersive-translate-theme-thinDashed-borderColor) !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-dotted-inner {
            background-image: linear-gradient(to right,
                    var(--immersive-translate-theme-dotted-borderColor) 30%,
                    rgba(255, 255, 255, 0) 0%);
            background-position: bottom;
            background-size: 5px 1px;
            background-repeat: repeat-x;
            padding-bottom: 3px;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-nativeDotted-inner {
            text-decoration: underline !important;
            text-decoration-color: var(--immersive-translate-theme-nativeDotted-borderColor) !important;
            text-decoration-style: dotted !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-wavy-inner {
            text-decoration: underline !important;
            text-decoration-color: var(--immersive-translate-theme-wavy-borderColor) !important;
            text-decoration-style: wavy !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-dashed-inner {
            background: linear-gradient(to right,
                    var(--immersive-translate-theme-dashed-borderColor) 0%,
                    var(--immersive-translate-theme-dashed-borderColor) 50%,
                    transparent 50%,
                    transparent 100%) repeat-x left bottom;
            background-size: 8px 2px;
            padding-bottom: 2px;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper-theme-dividingLine::before {
            content: "";
            display: block;
            max-width: 80px;
            width: 10%;
            border-top: 1px dashed var(--immersive-translate-theme-dividingLine-borderColor);
            padding-top: 8px;
        }

        [imt-state="dual"] .immersive-translate-target-translation-inline-wrapper-theme-dividingLine::before {
            content: "";
            border-left: 1px dashed var(--immersive-translate-theme-dividingLine-borderColor);
            max-height: 16px;
            height: 16px;
            padding-left: 8px;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-highlight-inner {
            background: var(--immersive-translate-theme-highlight-backgroundColor);
            box-decoration-break: clone;
            -webkit-box-decoration-break: clone;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper-theme-marker {
            line-height: 1.5em;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-marker2-inner {
            font-weight: bold;
            text-shadow: 10px 0px 3px var(--immersive-translate-theme-marker2-backgroundColor),
                16px 3px 9px var(--immersive-translate-theme-marker2-backgroundColor),
                2px 0px 6px var(--immersive-translate-theme-marker2-backgroundColor),
                -12px 0px 12px var(--immersive-translate-theme-marker2-backgroundColor) !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-marker-inner {
            /* TODO: add more texture */
            background: linear-gradient(to right,
                    rgba(var(--immersive-translate-theme-marker-backgroundColor-rgb), 0.1),
                    rgba(var(--immersive-translate-theme-marker-backgroundColor-rgb), 0.9) 3%,
                    rgba(var(--immersive-translate-theme-marker-backgroundColor-rgb), 0.9) 35%,
                    rgba(var(--immersive-translate-theme-marker-backgroundColor-rgb), 0.9) 70%,
                    rgba(var(--immersive-translate-theme-marker-backgroundColor-rgb), 0.8) 95%,
                    rgba(var(--immersive-translate-theme-marker-backgroundColor-rgb), 0.3));
            box-decoration-break: clone;
            -webkit-box-decoration-break: clone;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-weakening {
            opacity: 0.618 !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-italic {
            font-style: italic !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-bold {
            font-weight: bold !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper-theme-paper {
            margin: 8px 0;
            box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
            padding: 16px 32px;
            display: inline-block;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper-theme-blockquote {
            border-left: 4px solid var(--immersive-translate-theme-blockquote-borderColor) !important;
            padding-left: 12px !important;
            margin-top: 4px;
            margin-bottom: 4px;
            padding-top: 4px;
            padding-bottom: 4px;
            display: inline-block;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-mask-inner {
            filter: blur(5px) !important;
            transition: filter 0.3s ease !important;
            border-radius: 10px;
            display: inline-block;
        }

        [data-immersive-translate-root-translation-theme="none"] .immersive-translate-target-translation-theme-mask-inner {
            filter: none !important;
        }

        [data-immersive-translate-root-translation-theme="mask"] .immersive-translate-target-inner {
            filter: blur(5px) !important;
            transition: filter 0.3s ease !important;
            border-radius: 10px;
            display: inline-block;
        }

        /* opacity theme start */

        [imt-state="dual"] .immersive-translate-target-translation-theme-opacity-inner {
            filter: opacity(calc(var(--immersive-translate-theme-opacity-opacity) * 1%)) !important;
            transition: filter 0.3s ease !important;
            border-radius: 10px;
            display: inline-block;
        }

        [data-immersive-translate-root-translation-theme="none"] .immersive-translate-target-translation-theme-opacity-inner {
            filter: none !important;
        }

        [data-immersive-translate-root-translation-theme="opacity"] .immersive-translate-target-inner,
        [imt-state="dual"] .immersive-translate-target-translation-theme-opacity-inner:hover {
            filter: opacity(calc(var(--immersive-translate-theme-opacity-opacity) * 1%)) !important;
            transition: filter 0.3s ease !important;
            border-radius: 10px;
            display: inline-block;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-opacity-inner:hover {
            filter: none !important;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-mask-inner:hover {
            filter: none !important;
        }

        [data-immersive-translate-root-translation-theme="opacity"] .immersive-translate-target-inner:hover {
            filter: none !important;
        }

        [data-immersive-translate-root-translation-theme="mask"] .immersive-translate-target-inner:hover {
            filter: none !important;
        }

        /* opacity theme end */

        /* background theme start */
        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper-theme-background {
            margin: 8px 0;
            background: rgba(var(--immersive-translate-theme-background-backgroundColor-rgb),
                    calc(var(--immersive-translate-theme-background-backgroundOpacity) * 1%));
            border-radius: 4px;
            box-shadow: unset !important;
            padding: 12px;
            display: inline-block;
        }

        [imt-state="dual"] .immersive-translate-target-translation-theme-background-inner {
            background: rgba(var(--immersive-translate-theme-background-backgroundColor-rgb),
                    calc(var(--immersive-translate-theme-background-backgroundOpacity) * 1%));
            padding-left: 6px;
            padding-right: 6px;
            box-decoration-break: clone;
            -webkit-box-decoration-break: clone;
        }

        [imt-state="dual"] .immersive-translate-target-translation-block-wrapper .immersive-translate-target-translation-theme-background-inner {
            background: unset;
            padding-left: unset;
            padding-right: unset;
        }

        /* background theme end */

        /* vertical css , please remain it in the last one. */
        .immersive-translate-target-translation-vertical-block-wrapper {
            margin: 0px 8px !important;
        }

        .immersive-translate-text {
            font-size: 15px !important;
        }

        .immersive-translate-error-toast {
            position: fixed;
            top: 5%;
            z-index: 99999999;
            left: 0;
            right: 0;
            margin: auto;
            max-width: 300px;
            padding: 16px;
            border-radius: 12px;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: row;
            justify-content: space-between;
        }

        @media all and (min-width: 750px) {
            .immersive-translate-error-toast {
                max-width: 400px;
            }
        }

        .immersive-translate-clickable-button {
            cursor: pointer;
        }

        .immersive-translate-help-button {
            cursor: pointer;
        }

        .immersive-translate-loading-text:before {
            content: "...";
        }

        /* dark mode for loading */

        @media only screen and (prefers-color-scheme: dark) {
            .immersive-translate-loading {
                border: 2px rgba(255, 255, 255, 0.25) solid !important;
                border-top: 2px rgba(255, 255, 255, 1) solid !important;
            }
        }

        .immersive-translate-error-wrapper {
            position: relative;
            display: inline-flex;
            padding: 6px;
            margin: 0 12px;
            white-space: nowrap;
            font-size: 0.9em;
        }

        [lang="zh-CN"] .immersive-translate-error-wrapper {
            font-size: 0.75em;
        }

        [lang="zh-TW"] .immersive-translate-error-wrapper {
            font-size: 0.75em;
        }

        .immersive-translate-tooltip {
            position: relative;
            display: inline-flex;
            /* little indicater to indicate it's hoverable */
        }

        .immersive-translate-tooltip-content {
            /* here's the magic */
            position: absolute;
            z-index: 100000000000;

            left: 50%;
            bottom: 0;
            transform: translate(-50%, 110%);
            line-height: 1;
            /* and add a small left margin */

            /* basic styles */
            width: max-content;
            max-width: 250px;
            word-wrap: break-word;
            white-space: pre-line;
            padding: 10px;
            border-radius: 10px;
            background: #000c;
            color: #fff;
            text-align: center;
            font-size: 14px;
            display: none;
            /* hide by default */
        }

        .immersive-translate-tooltip:hover .immersive-translate-tooltip-content {
            display: inline-block;
        }

        .immersive-translate-tooltip:hover+.immersive-translate-tooltip-content {
            display: inline-block;
        }

        .immersive-translate-tooltip-content-table {
            left: unset !important;
            bottom: unset !important;
            transform: translate(-10%, 50%) !important;
        }

        .immersive-translate-tooltip:hover:before {
            display: inline-block;
        }

        .immersive-translate-loading-spinner {
            vertical-align: middle !important;
            width: 10px !important;
            height: 10px !important;
            display: inline-block !important;
            margin: 0 4px !important;
            border: 2px rgba(221, 244, 255, 0.6) solid !important;
            border-top: 2px rgba(0, 0, 0, 0.375) solid !important;
            border-left: 2px rgba(0, 0, 0, 0.375) solid !important;
            border-radius: 50% !important;
            padding: 0 !important;
            -webkit-animation: immersive-translate-loading-animation 0.6s infinite linear !important;
            animation: immersive-translate-loading-animation 0.6s infinite linear !important;
        }

        @-webkit-keyframes immersive-translate-loading-animation {
            from {
                -webkit-transform: rotate(0deg);
            }

            to {
                -webkit-transform: rotate(359deg);
            }
        }

        @keyframes immersive-translate-loading-animation {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(359deg);
            }
        }

        .imt-image-status {
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--bg-2, #fff);
            font-size: 14px;
        }
    </style>
    <style data-id="immersive-translate-user-custom-style">
        :root {

            .immersive-translate-target-inner {
                font-family: inherit;
            }


            .immersive-translate-target-inner {
                font-family: inherit;
            }
        }
    </style>
    <style data-id="immersive-translate-dynamic-injected-css">
        .immersive-translate-target-wrapper[dir='rtl'] {
            text-align: right;
        }

        .immersive-translate-target-wrapper[dir='rtl'] [data-immersive-translate-class-bak*='block-wrapper'] {
            display: block;
        }

        .immersive-translate-target-wrapper {
            word-break: break-word;
            user-select: text;
        }

        [imt-state="translation"] .immersive-translate-target-wrapper[dir='rtl'] {
            display: inline-block;
        }

        [dir='rtl'] .immersive-translate-target-wrapper:not([dir]) {
            text-align: left;
        }

        [imt-state=dual] .immersive-translate-target-translation-block-wrapper-theme-dividingLine::before {
            display: block;
        }

        [imt-trans-position=before] .immersive-translate-target-translation-block-wrapper {
            display: block !important;
        }

        [imt-state][data-immersive-translate_rtl] .immersive-translate-target-wrapper {
            display: block !important;
        }
    </style>
</head>

<body epub:type="bodymatter" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
    <section aria-labelledby="c21_1" epub:type="chapter" role="doc-chapter"
        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
        <header data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
            <h1 id="c21_1" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1"><span aria-label="582" epub:type="pagebreak" id="Page_582"
                    role="doc-pagebreak"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span><span id="c21"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span><span
                    class="chapterNumber"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">21</span><br /><span
                    class="chapterTitle" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Entity
                    Framework Core</span></h1>
        </header>
        <section aria-label="chapter opening" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
            <span id="c21-sec-0001" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
            <aside data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                <div class="top hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <hr />
                </div>
                <section class="feature3" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <h3 data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                        data-immersive-translate-paragraph="1">WHAT'S IN THIS CHAPTER?<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">本章包含什么内容？</font>
                            </font>
                        </font>
                    </h3>
                    <ul class="check2" id="c21-list-0001"
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <li id="c21-li-0001" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1">Introducing Entity Framework Core<font
                                class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">介绍 Entity Framework Core
                                    </font>
                                </font>
                            </font>
                        </li>
                        <li id="c21-li-0002" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1">Working with conventions, annotations, and the Fluent
                            API<font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">使用约定、注释和 Fluent API
                                    </font>
                                </font>
                            </font>
                        </li>
                        <li id="c21-li-0003" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1">Using queries, compiled queries, and global query
                            filters<font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">使用查询、编译查询和全局查询过滤器</font>
                                </font>
                            </font>
                        </li>
                        <li id="c21-li-0004" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1">Defining relationships with conventions, annotations,
                            and the Fluent API<font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">使用约定、注释和 Fluent API 定义关系
                                    </font>
                                </font>
                            </font>
                        </li>
                        <li id="c21-li-0005" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1">Using table per hierarchy, table splitting, and owned
                            entities<font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">使用按层次表、表拆分和拥有实体</font>
                                </font>
                            </font>
                        </li>
                        <li id="c21-li-0006" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1">Tracking objects<font
                                class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                <font class="notranslate" data-immersive-translate-translation-element-mark="1">  
                                </font>
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">跟踪对象</font>
                                </font>
                            </font>
                        </li>
                        <li id="c21-li-0007" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1">Updating objects and object trees<font
                                class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">更新对象和对象树</font>
                                </font>
                            </font>
                        </li>
                        <li id="c21-li-0008" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1">Handling conflicts with updates<font
                                class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">处理更新冲突</font>
                                </font>
                            </font>
                        </li>
                        <li id="c21-li-0009" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1">Using transactions<font
                                class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                <font class="notranslate" data-immersive-translate-translation-element-mark="1">  
                                </font>
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">使用事务</font>
                                </font>
                            </font>
                        </li>
                        <li id="c21-li-0010" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1">Using migrations with the .NET CLI tools<font
                                class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">使用 .NET CLI 工具进行迁移</font>
                                </font>
                            </font>
                        </li>
                    </ul>
                    <div class="bottom hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <hr />
                    </div>
                </section>
            </aside>
            <aside data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                <div class="top hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <hr />
                </div>
                <section class="feature3" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span
                        id="c21-fea-0001" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                    <h3 id="head-2-191" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                        data-immersive-translate-paragraph="1">CODE DOWNLOADS FOR THIS CHAPTER<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">本章代码下载</font>
                            </font>
                        </font>
                    </h3>
                    <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span
                            id="c21-sec-0003"
                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                        <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1">The source code for this chapter is available on the
                            book page at <code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><a href="http://www.wiley.com">www.wiley.com</a></code>.
                            Click the Downloads link. The code can also be found at <code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><a href="https://github.com/ProfessionalCSharp/ProfessionalCSharp2021">https://github.com/ProfessionalCSharp/ProfessionalCSharp2021</a></code>
                            in the directory <code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">2_Libs/EFCore</code>.
                            The code for this chapter is divided into the following major examples:<font
                                class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">本章的源代码可在第 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><a href="http://www.wiley.com">www.wiley.com</a></code>
                                        页的书籍页面上找到。点击下载链接。代码也可以在第 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><a href="https://github.com/ProfessionalCSharp/ProfessionalCSharp2021">https://github.com/ProfessionalCSharp/ProfessionalCSharp2021</a></code>
                                        处的 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">2_Libs/EFCore</code>
                                        目录中找到。本章的代码分为以下主要示例：</font>
                                </font>
                            </font>
                        </p>
                        <ul class="check" id="c21-list-0002"
                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                            <li id="c21-li-0011" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                                data-immersive-translate-paragraph="1">Intro<font
                                    class="notranslate immersive-translate-target-wrapper"
                                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  
                                    </font>
                                    <font
                                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                        data-immersive-translate-translation-element-mark="1">
                                        <font
                                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                            data-immersive-translate-translation-element-mark="1">简介</font>
                                    </font>
                                </font>
                            </li>
                            <li id="c21-li-0012" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                                data-immersive-translate-paragraph="1">Models<font
                                    class="notranslate immersive-translate-target-wrapper"
                                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  
                                    </font>
                                    <font
                                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                        data-immersive-translate-translation-element-mark="1">
                                        <font
                                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                            data-immersive-translate-translation-element-mark="1">模型</font>
                                    </font>
                                </font>
                            </li>
                            <li id="c21-li-0013" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                                data-immersive-translate-paragraph="1">ScaffoldSample</li>
                            <li id="c21-li-0014" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                                data-immersive-translate-paragraph="1">MigrationsSample</li>
                            <li id="c21-li-0015" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                                data-immersive-translate-paragraph="1">Queries</li>
                            <li id="c21-li-0016" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                                data-immersive-translate-paragraph="1"><span aria-label="583" epub:type="pagebreak"
                                    id="Page_583" role="doc-pagebreak"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>Relations
                            </li>
                            <li id="c21-li-0017" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                                data-immersive-translate-paragraph="1">LoadingRelatedData<font
                                    class="notranslate immersive-translate-target-wrapper"
                                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  
                                    </font>
                                    <font
                                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                        data-immersive-translate-translation-element-mark="1">
                                        <font
                                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                            data-immersive-translate-translation-element-mark="1">加载关联数据 </font>
                                    </font>
                                </font>
                            </li>
                            <li id="c21-li-0018" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                                data-immersive-translate-paragraph="1">Tracking<font
                                    class="notranslate immersive-translate-target-wrapper"
                                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  
                                    </font>
                                    <font
                                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                                        data-immersive-translate-translation-element-mark="1">
                                        <font
                                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                            data-immersive-translate-translation-element-mark="1">跟踪 </font>
                                    </font>
                                </font>
                            </li>
                            <li id="c21-li-0019" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                                data-immersive-translate-paragraph="1">ConflictHandling-LastWins<font
                                    class="notranslate immersive-translate-target-wrapper"
                                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                    <font
                                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                        data-immersive-translate-translation-element-mark="1">
                                        <font
                                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                            data-immersive-translate-translation-element-mark="1">冲突处理-最后胜利者 </font>
                                    </font>
                                </font>
                            </li>
                            <li id="c21-li-0020" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                                data-immersive-translate-paragraph="1">ConflictHandling-FirstWins<font
                                    class="notranslate immersive-translate-target-wrapper"
                                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                    <font
                                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                        data-immersive-translate-translation-element-mark="1">
                                        <font
                                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                            data-immersive-translate-translation-element-mark="1">冲突处理-首先胜利者</font>
                                    </font>
                                </font>
                            </li>
                            <li id="c21-li-0021" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                                data-immersive-translate-paragraph="1">Cosmos</li>
                        </ul>
                        <p id="c21-para-0004" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1">Samples from this chapter mainly use the <code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Micrsooft.EntityFrameworkCore</code>,
                            <code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Microsoft.EntityFrameworkCore.SqlServer</code>,
                            and <code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Micrsoft.Extensions.Hosting</code>
                            NuGet packages. All the sample projects have <i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">nullable
                                reference types</i> enabled.<font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">本章的示例主要使用 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Micrsooft.EntityFrameworkCore</code>
                                        、 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Microsoft.EntityFrameworkCore.SqlServer</code>
                                        和 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Micrsoft.Extensions.Hosting</code>
                                        NuGet 包。所有示例项目都启用了可空引用类型。</font>
                                </font>
                            </font>
                        </p>
                    </section>
                    <div class="bottom hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <hr />
                    </div>
                </section>
            </aside>
        </section>
        <section aria-labelledby="head-2-192" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
            <span id="c21-sec-0004" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
            <h2 id="head-2-192" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">INTRODUCING EF CORE<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">介绍 EF Core </font>
                    </font>
                </font>
            </h2>
            <p id="c21-para-0005" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">When you use ADO.NET directly, you can use a data reader such as
                <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SqlDataReader</code> or
                <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SqliteDataReader</code> to
                manually fill your objects with data from the database. With Entity Framework Core (EF Core), you don't
                need to write SQL statements because you get the mapping from relational data stores to classes and
                class hierarchies out of the box. With EF Core, you create a context that maps database tables to your
                model types, create new instances of your custom class, and update existing instances to add new records
                and update records in the database. EF Core offers an abstraction layer that makes a lot of the work of
                accessing a database easier.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">当你直接使用 ADO.NET 时，你可以使用 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SqlDataReader</code>
                            或 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SqliteDataReader</code>
                            这样的数据读取器手动用数据库中的数据填充你的对象。使用 Entity Framework Core (EF Core) 时，你不需要编写 SQL
                            语句，因为你可以直接获得从关系数据存储到类和类层次结构的映射。通过 EF
                            Core，你创建一个上下文来将数据库表映射到你的模型类型，创建你自定义类的实例，并更新现有实例以添加新记录和更新数据库中的记录。EF Core
                            提供了一个抽象层，使得访问数据库的工作变得更加简单。</font>
                    </font>
                </font>
            </p>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0005"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-387" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Database Providers <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">数据库提供者</font>
                        </font>
                    </font>
                </h3>
                <p id="c21-para-0006" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">With EF Core, you can use any database where an EF Core
                    provider is available. Check the list of available providers in the Microsoft documentation at <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><a href="https://docs.microsoft.com/ef/core/providers/">https://docs.microsoft.com/ef/core/providers/</a></code>.
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用 EF Core，你可以使用任何有 EF Core
                                提供者的数据库。在 Microsoft 文档中查看可用提供者列表 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><a href="https://docs.microsoft.com/ef/core/providers/">https://docs.microsoft.com/ef/core/providers/</a></code>
                                。</font>
                        </font>
                    </font>
                </p>
                <p id="c21-para-0007" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">In this chapter, I mostly use Microsoft SQL Server. Microsoft
                    SQL Server LocalDB is installed when you install Visual Studio. If you are using a Linux
                    environment, you can install a Linux version of SQL Server. The easiest way to use a Linux version
                    of Microsoft SQL Server is to run a Docker image. Check <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><a href="https://hub.docker.com/_/microsoft-mssql-server">https://hub.docker.com/_/microsoft-mssql-server</a></code>
                    for information on how to pull and configure this Docker image to have SQL Server running inside a
                    Linux container. If you're running a Windows environment, you can use this Docker image as well if
                    you have Docker for Windows installed. After starting this Docker image, you need to use a
                    connection string to access the running server.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在本章中，我主要使用 Microsoft SQL Server。安装
                                Visual Studio 时会安装 Microsoft SQL Server LocalDB。如果你使用的是 Linux 环境，可以安装 SQL Server 的 Linux
                                版本。使用 Microsoft SQL Server Linux 版本最简单的方法是运行一个 Docker 镜像。查看 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><a href="https://hub.docker.com/_/microsoft-mssql-server">https://hub.docker.com/_/microsoft-mssql-server</a></code>
                                了解如何拉取和配置这个 Docker 镜像，以便在 Linux 容器中运行 SQL Server。如果你运行的是 Windows 环境，如果你安装了 Docker for
                                Windows，也可以使用这个 Docker 镜像。启动这个 Docker 镜像后，你需要使用连接字符串来访问运行的服务器。</font>
                        </font>
                    </font>
                </p>
                <p id="c21-para-0008" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">You can also use an Azure SQL Database with the code samples.
                    Just be sure to use a small database (which is enough for the samples), don't select the Core-based
                    pricing model, and use database transaction units (DTUs) instead. This is a lot cheaper with small
                    databases.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">你也可以使用 Azure SQL Database
                                与代码示例。只需确保使用一个小型数据库（这对示例足够），不要选择基于 Core 的定价模型，而是使用数据库事务单位（DTUs）。对于小型数据库来说，这要便宜得多。</font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0006"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-388" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Creating an Azure SQL Database<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">创建 Azure SQL 数据库</font>
                        </font>
                    </font>
                </h3>
                <p id="c21-para-0009" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">To create an SQL database on Microsoft Azure, you can use the
                    Azure CLI. You can use the Azure CLI directly from the Azure portal (<code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><a href="https://portal.azure.com">https://portal.azure.com</a></code>),
                    click the Cloud Shell button, and select the Bash shell. You can also install the Azure CLI to your
                    local system. Check <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><a href="https://docs.microsoft.com/cli/azure/install-azure-cli">https://docs.microsoft.com/cli/azure/install-azure-cli</a></code>
                    for download and installation instructions.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">要在 Microsoft Azure 上创建 SQL
                                数据库，您可以使用 Azure CLI。您可以直接从 Azure 门户（ <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><a href="https://portal.azure.com">https://portal.azure.com</a></code>
                                ）使用 Azure CLI，点击 Cloud Shell 按钮，并选择 Bash shell。您也可以将 Azure CLI 安装到本地系统。下载和安装说明请查看 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><a href="https://docs.microsoft.com/cli/azure/install-azure-cli">https://docs.microsoft.com/cli/azure/install-azure-cli</a></code>
                                。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">To create the database, a Bash script is available with the
                    code download. You can also use the Azure CLI with these instructions as shown in the following
                    script snippet:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">要创建数据库，提供了一个包含代码下载的 Bash
                                脚本。您也可以使用以下脚本片段中的这些说明与 Azure CLI 配合使用：</font>
                        </font>
                    </font>
                </p>
                <ol class="decimal" id="c21-list-0003"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <li id="c21-li-0022" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                        data-immersive-translate-paragraph="1">First, variables are defined. With these variables,
                        select the Azure region that best fits your location.<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">首先定义变量。使用这些变量，选择最适合您位置的 Azure
                                    区域。</font>
                            </font>
                        </font>
                    </li>
                    <li id="c21-li-0023" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                        data-immersive-translate-paragraph="1">You create a resource group with the <code
                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">az group create</code>
                        command. The database server and the database will be added to this resource group.<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">您使用 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">az group create</code>
                                    命令创建资源组。数据库服务器和数据库将被添加到此资源组。</font>
                            </font>
                        </font>
                    </li>
                    <li id="c21-li-0024" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                        data-immersive-translate-paragraph="1"><span aria-label="584" epub:type="pagebreak"
                            id="Page_584" role="doc-pagebreak"
                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>Using <code
                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">az sql server create</code>
                        creates a new database server. You need to enable the firewall to allow access to this server
                        with <code
                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">az sql server firewall-rule create</code>.
                        Using the IP address <code
                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">0.0.0.0</code> allows
                        access from Azure services. With the variable <code
                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">clientip</code>, you
                        need to add the IP address you use to access Azure services. You need to set this when setting
                        the variable <code
                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">clientip</code>.<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">使用 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">az sql server create</code>
                                    创建新的数据库服务器。您需要启用防火墙以允许使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">az sql server firewall-rule create</code>
                                    访问此服务器。使用 IP 地址 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">0.0.0.0</code>
                                    允许从 Azure 服务访问。通过变量 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">clientip</code>
                                    ，您需要添加用于访问 Azure 服务的 IP 地址。您需要在设置变量 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">clientip</code>
                                    时设置此选项。</font>
                            </font>
                        </font>
                    </li>
                    <li id="c21-li-0025" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                        data-immersive-translate-paragraph="1">Finally, using <code
                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">az sql db create</code>,
                        you create the Azure SQL database. Setting the option <code
                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">--service-objective</code>
                        to <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Basic</code>
                        creates a database with a maximum of 5 GB and a cheap option based on data transfer units. The
                        connection string to this database needs to be configured with the sample applications, if you
                        use this Azure service.<font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">最后，使用 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">az sql db create</code>
                                    ，您创建 Azure SQL 数据库。将选项 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">--service-objective</code>
                                    设置为 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Basic</code>
                                    创建一个最大 5 GB 的数据库，并基于数据传输单位提供经济选项。如果您使用此 Azure 服务，需要使用示例应用程序配置此数据库的连接字符串。</font>
                            </font>
                        </font>
                    </li>
                </ol>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">With the source code download, a Bash script is available
                    that you can run from the Azure shell. Just make sure to enter your client's IP address, change the
                    location to your nearest Azure region, and change the password. The commands use the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">\</code> line
                    continuation character, which works with the Azure shell and the Windows Subsystem for Linux. Using
                    the Windows command prompt, you can use <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">^</code> as the line
                    continuation character. The following code uses the \ character (script file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">createazuresql.sh</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在源代码下载中，提供了一个可以在 Azure shell 中运行的
                                Bash 脚本。只需确保输入您的客户端 IP 地址，将位置更改为您最近的 Azure 区域，并更改密码。命令使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">\</code>
                                行延续字符，该字符适用于 Azure shell 和 Windows 子系统 for Linux。使用 Windows 命令提示符时，您可以使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">^</code>
                                作为行延续字符。以下代码使用 \ 字符（脚本文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">createazuresql.sh</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0001"><code>#! /bin/bash</code>
<code> </code>
<code># Prepare variables</code>
<code>rg=rg-procsharp</code>
<code>loc=westeurope</code>
<code>servername=procsharpserver$RANDOM</code>
<code>databasename=procsharp</code>
<code>clientip=enter your client-ip address</code>
<code> </code>
<code>az group create --location $loc --name $rg</code>
<code>az sql server create --name $servername --resource-group $rg --location $loc \</code>
<code>--admin-user myadminuser --admin-password myadminpassword</code>
<code>az sql server firewall-rule create -g $rg -s $servername -n azurerule \</code>
<code>--start-ip-address 0.0.0.0 --end-ip-address 0.0.0.0</code>
<code>az sql server firewall-rule create -g $rg -s $servername -n clientiprule \</code>
<code>--start-ip-address $clientip --end-ip-address $clientp</code>
<code>az sql db create -g $rg -s $servername -n $databasename --service-objective Basic</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">To finally delete all the resources you created here, you can
                    delete the resource group and all the resources associated with it:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">要最终删除您在此处创建的所有资源，您可以删除资源组及其所有相关资源：
                            </font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0002"><code>&gt; az group delete --name $rg</code></pre>
                <p id="c21-para-0013" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">EF Core also supports NOSQL databases—just not relational
                    ones. This is an important distinction to the previous Entity Framework that was available with the
                    .NET Framework. In this chapter, you will use Azure Cosmos DB in the last section and see what's
                    similar and what's different with relational databases.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">EF Core 也支持 NoSQL
                                数据库——但不是关系型数据库。这与之前在 .NET Framework 中可用的 Entity Framework 的重要区别。在本章的最后一节，你将使用 Azure
                                Cosmos DB，并了解它与关系型数据库的异同。</font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0007"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-389" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Creating a Model <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">创建模型</font>
                        </font>
                    </font>
                </h3>
                <p id="c21-para-0014" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The sample application <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Intro</code> for
                    accessing the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Books</code> database is
                    a .NET console app. Version 5 of EF Core supports using records, but there are some limits in
                    particular with updates. For you to see in what scenarios you can use records and when to use
                    classes (at least with .NET 5), the sample application can be built with records or classes. If you
                    define the constant <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">USERECORDS</code> in the
                    project configuration file, the compilation uses a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">record</code>
                    ; otherwise, it uses a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">class</code>.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">用于访问 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Books</code>
                                数据库的示例应用程序 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Intro</code>
                                是一个 .NET 控制台应用程序。EF Core 5 版本支持使用记录，但在更新方面存在一些限制。为了让您了解在哪些场景下可以使用记录，以及在什么情况下应使用类（至少在
                                .NET 5 中），示例应用程序可以采用记录或类进行构建。如果在项目配置文件中定义了常量 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">USERECORDS</code>
                                ，编译将使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">record</code>
                                ；否则，将使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">class</code>
                                。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The sample application defines a simple <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code> type with
                    three properties. The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BookId</code> property
                    maps to the primary key of the table, the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Title</code> property to
                    the <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Title</code>
                    column, and the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Publisher</code> property
                    to the <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Publisher</code>
                    column. With two properties, the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">StringLength</code>
                    attribute is applied to create an SQL Server column type <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">nvarchar(n)</code>. The
                    application is using nullable reference types. With EF Core, this is used with <span
                        aria-label="585" epub:type="pagebreak" id="Page_585" role="doc-pagebreak"
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>conventions. The
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Publisher</code>
                    property is of type <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">string?</code>, which
                    maps it to the database as not required and therefore allows null. The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Title</code> property is
                    not nullable, and thus this is a required column. Creating a record type requires fewer code lines
                    when using the positional records. The members of the primary constructor create init-only setters.
                    To apply attributes to these properties, the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">property</code> keyword
                    needs to be used for applying the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">StringLength</code>
                    attribute. To assign an attribute to a field with an auto property, the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">field</code> keyword is
                    required. The class specifies a constructor with three parameters, and the last of these is
                    optional. The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code> class
                    implements auto properties for all its members. With the class version, the property values can be
                    changed after creating the object (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Intro/Book.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">示例应用程序定义了一个具有三个属性的简单类型。 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BookId</code>
                                属性映射到表的主键， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Title</code>
                                属性映射到 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Title</code>
                                列， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Publisher</code>
                                属性映射到 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Publisher</code>
                                列。使用两个属性，应用了 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">StringLength</code>
                                属性来创建 SQL Server 列类型 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">nvarchar(n)</code>
                                。应用程序使用可空引用类型。在 EF Core 中，这是通过约定使用的。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Publisher</code>
                                属性的类型为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">string?</code>
                                ，将其映射到数据库时不需要，因此允许为空。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Title</code>
                                属性不可为空，因此这是一个必需的列。使用位置记录时，创建记录类型所需的代码行数更少。主构造函数的成员创建只读设置器。要为这些属性应用属性，需要使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">property</code>
                                关键字来应用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">StringLength</code>
                                属性。要将属性分配给自动属性的字段，需要使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">field</code>
                                关键字。该类指定了一个具有三个参数的构造函数，其中最后一个参数是可选的。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code>
                                类为其所有成员实现了自动属性。使用类版本时，可以在创建对象后更改属性值（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Intro/Book.cs</code>
                                ）。</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0003"><code>using System.ComponentModel.DataAnnotations;</code>
<code> </code>
<code>#if USERECORDS</code>
<code> </code>
<code>public record Book(</code>
<code>  [property: StringLength(50)] string Title,</code>
<code>  [property: StringLength(30)] string? Publisher = default,</code>
<code>  int BookId = 0);</code>
<code> </code>
<code>#else</code>
<code> </code>
<code>public class Book</code>
<code>{</code>
<code>  public Book(string title, string? publisher = default, int bookId = default)</code>
<code>  {</code>
<code>    Title = title;</code>
<code>    Publisher = publisher;</code>
<code>    BookId = bookId;</code>
<code>  }</code>
<code>  [StringLength(50)]</code>
<code>  public string Title { get; set; }</code>
<code>  [StringLength(30)]</code>
<code>  public string? Publisher { get; set; }</code>
<code>  public int BookId { get; set; }</code>
<code>}</code>
<code> </code>
<code>#endif</code></pre>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0008"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-390" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Creating a Context <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">创建上下文</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The association of the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Books</code> table with
                    the database is created by the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksContext</code>
                    class. This class derives from the base class <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>, as
                    shown in the following code snippet. The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksContext</code> class
                    defines the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Books</code> property
                    that is of type <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbSet&lt;Book&gt;</code>.
                    This type allows creating queries and adding <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code> instances for
                    storing book data in the database. The constructor specifies arguments of type <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContextOptions</code>.
                    This constructor is used when configuring the context with the dependency injection (DI) container.
                    You specify the connection string to the database in the container configuration, as shown later in
                    this chapter in the section “Configuring the Context with the DI Provider” (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Intro/BooksContext.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Books</code>
                                表与数据库的关联由 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksContext</code>
                                类创建。此类继承自基础类 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                                ，如下面的代码片段所示。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksContext</code>
                                类定义了类型为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbSet&lt;Book&gt;</code>
                                的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Books</code>
                                属性。该类型允许创建查询并为在数据库中存储书籍数据添加 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code>
                                实例。构造函数指定了类型为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContextOptions</code>
                                的参数。此构造函数在通过依赖注入（DI）容器配置上下文时使用。您在容器配置中指定数据库的连接字符串，如本章后面“使用 DI 提供商配置上下文”部分（代码文件 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Intro/BooksContext.cs</code>
                                ）所示：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0004"><code>public class BooksContext : <b>DbContext</b></code>
<code>{</code>
<code>  public BooksContext(<b>DbContextOptions&lt;BooksContext&gt; options</b>)</code>
<code>    : base(options) { }</code>
<code> </code>
<code>  <b>public DbSet&lt;Book&gt; Books =&gt; Set&lt;Book&gt;();</b></code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span aria-label="586"
                        epub:type="pagebreak" id="Page_586" role="doc-pagebreak"
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span></p>
                <aside data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <div class="top hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <p id="c21-para-0018" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NOTE</b> <i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">When creating a
                            </i> <code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                            <i data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"> constructor to be
                                used for dependency injection, you can also specify parameters that are registered with
                                the DI container in addition to specifying the </i> <code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContextOptions</code>
                            <i data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"> parameter.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意：在创建用于依赖注入的 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                                        构造函数时，除了指定 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContextOptions</code>
                                        参数外，还可以指定已在 DI 容器中注册的参数。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                            <hr />
                        </div>
                    </section>
                </aside>
                <aside data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <div class="top hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <p id="c21-para-0019" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NOTE</b> <i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">In many samples
                                (including samples from previous editions of this book), read-write properties are used
                                with properties of type </i> <code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbSet</code> <i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">. With read-write
                                properties, the property is assigned from the base class </i> <code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                            <i data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">. Now because we
                                have nullable enabled, the compiler gives a warning because the property is not
                                initialized from the constructor of this class. The best fix for nullable reference
                                types is to initialize this property by invoking the generic </i> <code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Set</code> <i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"> method of the
                                base class and use a read-only property.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意
                                        在许多示例（包括本书先前版本中的示例）中，读-写属性与类型为 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbSet</code>
                                        的属性一起使用。使用读-写属性时，属性是从基类 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                                        赋值的。现在因为我们启用了可空性，编译器会发出警告，因为该属性不是从该类的构造函数中初始化的。对于可空引用类型的最佳修复方法是通过调用基类的泛型 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Set</code>
                                        方法来初始化此属性，并使用只读属性。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                            <hr />
                        </div>
                    </section>
                </aside>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">If you're not using dependency injection, you can create a
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                    -derived class with a parameterless constructor (or just use the default constructor) instead of the
                    constructor with <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbOptions</code> and
                    override the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OnConfiguring</code>
                    method to specify the database connection string:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">如果你不使用依赖注入，你可以创建一个 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                                派生类，并使用无参数构造函数（或直接使用默认构造函数），而不是使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbOptions</code>
                                构造函数，并重写 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OnConfiguring</code>
                                方法来指定数据库连接字符串：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0005"><code>public class BooksContext: DbContext</code>
<code>{</code>
<code>  <b>public BooksContext() { }</b></code>
<code> </code>
<code>  <b>private const string ConnectionString =</b></code>
<code>    <b>@"server=(localdb)\MSSQLLocalDb;database=ProCSharpBooks;" +</b>     </code>
<code>    <b>@"trusted_connection=true";</b></code>
<code> </code>
<code>  public DbSet&lt;Book&gt; Books =&gt; Set&lt;Book&gt;();</code>
<code> </code>
<code>  <b>protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)</b></code>
<code>  <b>{</b></code>
<code>    <b>optionsBuilder.UseSqlServer(ConnectionString);</b></code>
<code>  <b>}</b></code>
<code>}</code></pre>
                <p id="c21-para-0021" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The sample applications from this book all use the DI
                    container. You've already seen advantages of the DI container in previous chapters and will see it
                    in action in the following chapters as well.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">本书的所有示例应用程序都使用 DI 容器。你已经在之前的章节中看到了
                                DI 容器的优势，在接下来的章节中也会看到它的实际应用。</font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0011"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-391" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Conventions, Annotations, and Fluent API<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">约定、注解和 Fluent API</font>
                        </font>
                    </font>
                </h3>
                <p id="c21-para-0022" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">EF Core is using three concepts to define the model:
                    conventions, annotations, and the Fluent API. With <i
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">conventions</i>, some
                    things happen automatically, but be aware that conventions are based on the EF Core provider. With
                    SQL Server, for example, if the property is of type <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">int</code> or <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Guid</code> and has a
                    name <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Id</code> or <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">{ClassName}Id</code>, the
                    property maps to a primary key. The .NET <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">string</code> type maps
                    to the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">nvarchar(max)</code>
                    database type. Nullability definitions also define the mapping as mentioned in the previous section.
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">EF Core 使用三种概念来定义模型：约定、注解和 Fluent
                                API。通过约定，某些操作会自动进行，但请注意约定是基于 EF Core 提供者的。例如，在 SQL Server 中，如果属性类型为 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">int</code> 或
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Guid</code>
                                且名称为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Id</code> 或
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">{ClassName}Id</code>
                                ，该属性将映射到主键。.NET <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">string</code>
                                类型映射到 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">nvarchar(max)</code>
                                数据库类型。空值定义也定义了映射，如前一节所述。</font>
                        </font>
                    </font>
                </p>
                <p id="c21-para-0023" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Conventions can be overridden using <i
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">annotations</i>—specifying
                    attributes. The previous example used the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">StringLength</code>
                    attribute to map the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Title</code> property to
                    a column type of <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">nvarchar(50)</code>. You
                    can use the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Table</code> and <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Column</code> attributes
                    to define the mapping from a type name to a corresponding table and a property name to a column.
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">可以使用注解（指定属性）来覆盖约定。前面的示例使用了 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">StringLength</code>
                                属性将 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Title</code>
                                属性映射到列类型 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">nvarchar(50)</code>
                                。你可以使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Table</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Column</code>
                                属性来定义从类型名称到对应表的映射，以及从属性名称到列的映射。</font>
                        </font>
                    </font>
                </p>
                <p id="c21-para-0024" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1"><span aria-label="587" epub:type="pagebreak" id="Page_587"
                        role="doc-pagebreak"
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>There's also a
                    convention for mapping .NET Types to table names. With EF Core, the property names of <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbSet</code> typed
                    properties are used as default table names. Creating contexts is shown in the next section.
                    Conventions do not exist for every annotation. To specify not nullable (required) columns, you can
                    use the <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Required</code>
                    attribute. Before .NET 5, a convention with non-nullable reference types was not available.
                    Annotations are more powerful than conventions because you can do more with them.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">还有一个约定用于将 .NET 类型映射到表名。在 EF Core
                                中， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbSet</code>
                                类型的属性名称被用作默认表名。创建上下文的示例将在下一节中展示。并非每个注解都存在约定。要指定非空（必需）列，你可以使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Required</code>
                                属性。在 .NET 5 之前，没有非空引用类型的约定。注解比约定更强大，因为你可以用它们实现更多功能。</font>
                        </font>
                    </font>
                </p>
                <p id="c21-para-0025" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Instead of using annotations, you can also use a <i
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Fluent API</i>, which
                    means you handle configuration via code rather than attributes. With a Fluent API, you can use the
                    return value of a method to invoke the next method. The Fluent API for EF Core is more powerful than
                    the annotations are. The Fluent API is shown later in this chapter in the section “Creating a
                    Model.”<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">除了使用注解，你也可以使用 Fluent
                                API，这意味着你通过代码而不是属性来处理配置。使用 Fluent API，你可以使用方法的返回值来调用下一个方法。EF Core 的 Fluent API
                                比注解更强大。Fluent API 在本章后面的“创建模型”一节中展示。</font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0012"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-392" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Configuring the Context with the DI Provider<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用 DI 提供商配置上下文</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Host</code> class first
                    shown in <a href="c15.xhtml"
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Chapter 15</a>,
                    “Dependency Injection and Configuration,” is used to create and configure the DI container, as shown
                    with the following code snippet (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Intro/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在第 15 章“依赖注入和配置”中首次展示的 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Host</code>
                                类用于创建和配置 DI 容器，如下面的代码片段所示（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Intro/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0006"><code>using var host = Host.CreateDefaultBuilder(args)</code>
<code>  .ConfigureServices((context, services) =&gt;</code>
<code>  {</code>
<code>    <b>var connectionString = context.Configuration.GetConnectionString      ("BooksConnection");</b></code>
<code>    <b>services.AddDbContext&lt;BooksContext&gt;(options =&gt;</b></code>
<code>    <b>{</b></code>
<code>      <b>options.UseSqlServer(connectionString);</b></code>
<code>    <b>});</b></code>
<code>    <b>services.AddScoped&lt;Runner&gt;();</b></code>
<code>  })</code>
<code>  .Build();</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The connection string is retrieved via configuration
                    settings. The connection string used here references a localdb database. If you use other databases,
                    you need to specify the corresponding connection string (configuration file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Intro/appsettings.json</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">连接字符串通过配置设置获取。这里使用的连接字符串引用了一个
                                localdb 数据库。如果你使用其他数据库，需要指定相应的连接字符串（配置文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Intro/appsettings.json</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0007"><code>{</code>
<code>  "ConnectionStrings": {</code>
<code>    "BooksConnection": </code>
<code>      "server=(localdb)\\mssqllocaldb;database=ProCSharpBooks;trusted_connection=true"</code>
<code>  }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">With the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Runner</code> class, the
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code> is
                    injected in the constructor (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Intro/Runner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Runner</code>
                                类， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                                在构造函数中被注入（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Intro/Runner.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0008"><code>public class Runner</code>
<code>{</code>
<code>  private readonly BooksContext _booksContext;</code>
<code>  public Runner(BooksContext booksContext)</code>
<code>  {</code>
<code>    _booksContext = booksContext;</code>
<code>  }</code>
<code>  //…</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">After the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Host</code> class is
                    configured, a new scope from the DI container is created to get a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Runner</code> instance
                    returned with this scope. The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Runner</code> class is
                    then used to invoke various methods using <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksContext</code> to
                    show different scenarios (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Intro/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Host</code>
                                类配置完成后，从依赖注入容器创建一个新的作用域来获取这个作用域返回的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Runner</code>
                                实例。然后使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Runner</code>
                                类通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksContext</code>
                                调用各种方法来展示不同场景（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Intro/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0009"><code>using var scope = host.Services.CreateScope();</code>
<code>var runner = scope.ServiceProvider.GetRequiredService&lt;Runner&gt;();</code>
<code> <span aria-label="588" epub:type="pagebreak" id="Page_588" role="doc-pagebreak"></span></code>
<code>await runner.CreateTheDatabaseAsync();</code>
<code>await runner.AddBookAsync("Professional C# and .NET", "Wrox Press");</code>
<code>await runner.AddBooksAsync();</code>
<code>await runner.ReadBooksAsync();</code>
<code>await runner.QueryBooksAsync();</code>
<code>await runner.DeleteBooksAsync();</code>
<code>await runner.DeleteDatabaseAsync();</code></pre>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0013"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-393" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Creating the Database <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">创建数据库</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The model and the context classes are defined. Now it's also
                    possible to create the database programmatically. When you use the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Database</code> property
                    of the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>, a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DatabaseFacade</code> is
                    returned. You can use this to create and delete databases and to send SQL statements directly to the
                    database. Invoking the method <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EnsureCreatedAsync</code>
                    makes sure that the database is created. If the database already exists, this method returns false.
                    If the database does not exist, the database is created according to the definition of the context
                    and the model, and true is returned (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Intro/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">模型和上下文类已定义。现在也可以通过编程方式创建数据库。当你使用
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Database</code>
                                的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                                属性时，会返回一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DatabaseFacade</code>
                                。你可以使用这个来创建和删除数据库，以及直接向数据库发送 SQL 语句。调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EnsureCreatedAsync</code>
                                方法可以确保数据库被创建。如果数据库已存在，此方法返回 false。如果数据库不存在，将根据上下文和模型的定义创建数据库，并返回 true（代码文件 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Intro/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0010"><code>public async Task CreateTheDatabaseAsync()</code>
<code>{</code>
<code>  bool created = <b>await _booksContext.Database.EnsureCreatedAsync();</b></code>
<code>  string creationInfo = created ? "created" : "exists";</code>
<code>  Console.WriteLine($"database {creationInfo}");</code>
<code>}</code></pre>
                <p id="c21-para-0031" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">When you run the program, if you already created the database
                    earlier, the string <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">database exists</code> is
                    written to the console. If you didn't create the database earlier, the database is created, followed
                    by the string <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">database created</code>.
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">运行程序时，如果你之前已创建数据库，将向控制台写入字符串 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">database exists</code>
                                。如果你之前未创建数据库，将创建数据库，然后写入字符串 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">database created</code>
                                。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">If you use Azure SQL Database, you need to create the
                    database before starting the application. Invoking the method <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EnsureCreatedAsync</code>
                    here creates the schema with the Azure SQL Database.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">如果你使用 Azure SQL
                                Database，需要在启动应用程序前创建数据库。在此处调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EnsureCreatedAsync</code>
                                方法会为 Azure SQL Database 创建架构。</font>
                        </font>
                    </font>
                </p>
                <aside data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <div class="top hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <p id="c21-para-0033" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NOTE</b> <i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Creating the
                                database with</i> <code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Database.EnsureCreatedAsync</code>
                            <i data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">doesn't give any
                                support when the database schema changes. Another option is to create the database with
                                <i
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">migrations</i>.
                                Using migrations, you can upgrade or downgrade the database schema to any specific
                                version. This can be done programmatically or by created SQL scripts. This feature is
                                covered later in this chapter.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意 使用 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Database.EnsureCreatedAsync</code>
                                        创建数据库时，在数据库架构发生变化时不会提供任何支持。另一种选择是使用迁移来创建数据库。通过迁移，你可以将数据库架构升级或降级到任何特定版本。这可以通过编程方式完成，或通过创建
                                        SQL 脚本来完成。本章后面将介绍此功能。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                            <hr />
                        </div>
                    </section>
                </aside>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0015"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-394" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Deleting the Database <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">删除数据库</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Deleting the database is programmatically similar to creating
                    it. You just need to invoke the method <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EnsureDeletedAsync</code>
                    of the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DatabaseFacade</code>
                    :<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">删除数据库在编程上与创建数据库类似。你只需要调用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DatabaseFacade</code>
                                的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EnsureDeletedAsync</code>
                                方法：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0011"><code>public async Task DeleteDatabaseAsync()</code>
<code>{</code>
<code>  Console.Write("Delete the database? (y|n) ");</code>
<code>  string? input = Console.ReadLine();</code>
<code>  if (input?.ToLower() == "y")</code>
<code>  {</code>
<code>    bool deleted = <b>await _booksContext.Database.EnsureDeletedAsync();</b></code>
<code>    string deletionInfo = deleted ? "deleted" : "not deleted";<span aria-label="589" epub:type="pagebreak" id="Page_589" role="doc-pagebreak"></span></code>
<code>    Console.WriteLine($"database {deletionInfo}");</code>
<code>  }</code>
<code>}</code></pre>
                <p id="c21-para-0035" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Just make sure you don't delete a database that should not be
                    deleted. Pay attention to the connection string you use.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">只需确保不要删除不应被删除的数据库。注意你使用的连接字符串。
                            </font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0016"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-395" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Writing to the Database <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">写入数据库</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">After the database and the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Books</code> table are
                    created, you can fill the table with data. The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">AddBookAsync</code>
                    method is created to add a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code> object to the
                    database. <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">AddBookAsync</code> just
                    adds the <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code>
                    object to the context with the state <i
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">added</i>; it doesn't
                    write it to the database. The object is written on invoking the method <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>.
                    After writing the object, the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BookId</code> from the
                    book variable is retrieved. This variable is changed from EF Core because in the database, this is
                    an auto-increment key. This also works when using records because the created init-only set
                    properties are behind-the-scenes properties with the get/set accessor, and the set accessor is
                    annotated to be used only with the initialization (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Intro/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在数据库和 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Books</code>
                                表创建后，你可以向表中填充数据。使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">AddBookAsync</code>
                                方法可以将 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code>
                                对象添加到数据库中。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">AddBookAsync</code>
                                方法只是将 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code>
                                对象添加到上下文中并设置状态，但不会写入数据库。对象是在调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>
                                方法时写入的。写入对象后，从 book 变量中检索 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BookId</code>
                                。这个变量在 EF Core 中发生了变化，因为在数据库中这是一个自增键。使用记录时也适用，因为创建的 init-only set 属性是具有 get/set
                                访问器的幕后属性，set 访问器被注解为仅用于初始化（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Intro/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0012"><code>public async Task AddBookAsync(string title, string publisher)</code>
<code>{</code>
<code>  Book book = new(title, publisher);</code>
<code>  <b>await _booksContext.Books.AddAsync(book);</b></code>
<code>  <b>int records = await _booksContext.SaveChangesAsync();</b></code>
<code>  Console.WriteLine($"{records} record added with {book.BookId}");</code>
<code> </code>
<code>  Console.WriteLine();</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">For adding a list of books, you can use the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">AddRange</code> method,
                    as shown here:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">要添加一系列书籍，可以使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">AddRange</code>
                                方法，如下所示：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0013"><code>public async Task AddBooksAsync()</code>
<code>{</code>
<code>  Book b1 = new("Professional C# 7 and .NET Core 2", "Wrox Press");</code>
<code>  Book b2 = new("Professional C# 6 and .NET Core 1.0", "Wrox Press");</code>
<code>  Book b3 = new("Professional C# 5 and .NET 4.5.1", "Wrox Press");</code>
<code>  Book b4 = new("Essential Algorithms", "Wiley");</code>
<code>  <b>await _booksContext.Books.AddRangeAsync(b1, b2, b3, b4);</b></code>
<code>  int records = await _booksContext.SaveChangesAsync();</code>
<code>  Console.WriteLine($"{records} records added");</code>
<code> </code>
<code>  Console.WriteLine();</code>
<code>}</code></pre>
                <aside data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <div class="top hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <p id="c21-para-0039" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NOTE</b> <i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">To look at the
                                database and see the schema and data, with Visual Studio, you can use SQL Server Object
                                Explorer. For a multiplatform solution on Windows, macOS, and Linux, you can use Azure
                                Data Studio. Check the readme file with the code downloads for a link to installation
                                instructions.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意 要查看数据库并查看模式和数据，使用
                                        Visual Studio 时，你可以使用 SQL Server 对象资源管理器。对于在 Windows、macOS 和 Linux
                                        上的多平台解决方案，你可以使用 Azure Data Studio。查看代码下载的 readme 文件以获取安装说明的链接。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                            <hr />
                        </div>
                    </section>
                </aside>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0018"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-396" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Reading from the Database <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">从数据库读取</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">To read the data from C# code, you need to invoke <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksContext</code> and
                    access the <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Books</code>
                    property. With the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ToListAsync</code>
                    method, a list is returned from a task so that it doesn't block the calling thread (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Intro/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">要从 C#代码中读取数据，需要调用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksContext</code>
                                并访问 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Books</code>
                                属性。通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ToListAsync</code>
                                方法，从任务中返回一个列表，这样就不会阻塞调用线程（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Intro/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0014"><span aria-label="590" epub:type="pagebreak" id="Page_590" role="doc-pagebreak"></span>
<code>public async Task ReadBooksAsync(CancellationToken token = default)</code>
<code>{</code>
<code>  string query = _booksContext.Books.<b>ToQueryString();</b></code>
<code>  Console.WriteLine(query);</code>
<code>  List&lt;Book&gt; books = <b>await _booksContext.Books.ToListAsync(token);</b></code>
<code>  foreach (var b in books)</code>
<code>  {</code>
<code>    Console.WriteLine($"{b.Title} {b.Publisher}");</code>
<code>  }</code>
<code> </code>
<code>  Console.WriteLine();</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">An easy way to see the generated query from the provider is
                    to invoke the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ToQueryString</code>
                    method:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">要轻松查看从提供程序生成的查询，可以调用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ToQueryString</code>
                                方法：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0015"><code>SELECT [b].[BookId], [b].[Publisher], [b].[Title]</code>
<code>FROM [Books] AS [b]</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Entity Framework offers a LINQ provider. With that, you can
                    create LINQ queries to access the database. With the sample application, the method syntax is used
                    as shown here:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">Entity Framework 提供了一个 LINQ
                                提供程序。通过它，您可以创建 LINQ 查询来访问数据库。在示例应用程序中，使用方法语法，如这里所示：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0016"><code>public async Task QueryBooksAsync(CancellationToken token = default)</code>
<code>{</code>
<code>  await _booksContext.Books</code>
<code>    .Where(b =&gt; b.Publisher == "Wrox Press")</code>
<code>    .ForEachAsync(b =&gt;</code>
<code>    {</code>
<code>      Console.WriteLine($"{b.Title} {b.Publisher}");</code>
<code>    }, token);</code>
<code> </code>
<code>  Console.WriteLine();</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">This is the SQL query sent to the database:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">这是发送到数据库的 SQL 查询：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0017"><code>SELECT [b].[BookId], [b].[Publisher], [b].[Title]</code>
<code>FROM [Books] AS [b]</code>
<code>WHERE [b].[Publisher] = N'Wrox Press'</code></pre>
                <aside data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <div class="top hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <p id="c21-para-0045" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NOTE</b> <i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LINQ is discussed
                                in detail in <a href="c09.xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Chapter
                                    9</a>, “Language Integrated Query.”</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意：LINQ 将在第 9
                                        章“语言集成查询”中详细讨论。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                            <hr />
                        </div>
                    </section>
                </aside>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0020"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-397" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Updating with Classes <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用类进行更新</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">So far, the syntax using EF Core has been the same with
                    classes and records. This changes now with updates. When using the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code> class, you
                    can change properties of these objects as needed and invoke <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>.
                    In the following code sample, the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Title</code> property is
                    changed. The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>
                    method verifies that the object has been modified, it is set to be in the modified state, and
                    finally it is updated to the database with an SQL <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UPDATE</code> statement.
                    With the following code snippet, the object with key value 1 is retrieved from the database before
                    being updated (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Intro/Runner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">到目前为止，使用 EF Core
                                的语法在类和记录上是相同的。但在更新时，这一点发生了变化。当使用类时，你可以根据需要更改这些对象的属性并调用更新方法。在以下代码示例中， <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Title</code>
                                属性被更改。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>
                                方法验证对象已被修改，将其设置为已修改状态，最后通过 SQL <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UPDATE</code>
                                语句更新到数据库。在以下代码片段中，更新前从数据库中检索键值为 1 的对象（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Intro/Runner.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0018"><code>public async Task UpdateBoookAsync()</code>
<code>{</code>
<code>  Book? book = await _booksContext.Books.FindAsync(1);</code>
<code>  if (book != null)</code>
<code>  {<span aria-label="591" epub:type="pagebreak" id="Page_591" role="doc-pagebreak"></span></code>
<code>    <b>book.Title</b> = "Professional C# and .NET - 2021 Edition";</code>
<code>    <b>int records = await _booksContext.SaveChangesAsync();</b></code>
<code>    Console.WriteLine($"{records} record updated");</code>
<code>  }</code>
<code>  Console.WriteLine();</code>
<code>}</code></pre>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0021"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-398" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Updating with Records <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用记录更新</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Updating C# records is different than with classes when using
                    EF Core 5. With records, you use the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">with</code> expression to
                    clone an existing record and change values. If you add this object to the context with the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Update</code> method
                    (which sets the state to modified) and an object with the same ID is already tracked from the
                    context, an exception of type <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">InvalidOperationException</code>
                    is thrown. You can solve this by detaching the existing object from the context by setting the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">State</code> property of
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EntityEntry</code> to
                    <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EntityState.Detached</code>.
                    This way, the newly created object can be attached and set to the modified state with the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Update</code> method
                    (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Intro/Runner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在 EF Core 5
                                中，使用记录更新与使用类不同。使用记录时，你使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">with</code>
                                表达式来克隆现有记录并更改值。如果你使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Update</code>
                                方法（该方法将状态设置为已修改）将此对象添加到上下文中，而上下文已经跟踪了具有相同 ID 的对象，则会抛出类型为 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">InvalidOperationException</code>
                                的异常。你可以通过将 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">State</code>
                                属性的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EntityEntry</code>
                                设置为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EntityState.Detached</code>
                                来从上下文中分离现有对象。这样，新创建的对象就可以使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Update</code>
                                方法附加并设置为已修改状态（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Intro/Runner.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0019"><code>public async Task UpdateBookAsync()</code>
<code>{</code>
<code>  Book? book = await _booksContext.Books.FindAsync(1);</code>
<code> </code>
<code>  if (book != null)</code>
<code>  {</code>
<code>    // detach the existing object from the context which allows to </code>
<code>    // attach it with the Update method</code>
<code>    <b>_booksContext.Entry(book).State = EntityState.Detached;</b></code>
<code>    <b>Book bookUpdate = book with { Title = "Professional C# and .NET - 2021 Edition" };</b></code>
<code>    <b>_booksContext.Update(bookUpdate);</b></code>
<code>    int records = await _booksContext.SaveChangesAsync();</code>
<code>    Console.WriteLine($"{records} record updated");</code>
<code>  }</code>
<code>  Console.WriteLine();</code>
<code>}</code></pre>
                <aside data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <div class="top hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <p id="c21-para-0049" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NOTE</b> <i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Later in this
                                chapter in the section “Saving Data,” you can learn more about attaching and detaching
                                objects from the context, why this is important for updates, and how you can query
                                objects without attaching them to the context.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意
                                        在本章后面的“保存数据”部分，你可以了解更多关于从上下文中附加和分离对象的信息，为什么这对于更新很重要，以及如何在不将对象附加到上下文的情况下查询对象。
                                    </font>
                                </font>
                            </font>
                        </p>
                        <p id="c21-para-0050" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1"><i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">The update
                                behavior of EF Core might change after .NET 5. The </i> <code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">with</code> <i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"> expression of
                                records could be influenced by using a proxy to have a similar experience between
                                updating records and updating classes. Check the source code in the GitHub repository
                                for the book for updates and more information.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">EF Core 的更新行为在.NET 5
                                        之后可能会有所变化。使用代理来更新记录可以提供与更新类相似的体验。有关更新和更多信息，请查看本书 GitHub 存储库中的源代码。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                            <hr />
                        </div>
                    </section>
                </aside>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0023"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-399" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Deleting Records <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">删除记录</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Finally, you need to clean up the database and delete all
                    records. You do this by retrieving all records and invoking the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Remove</code> or <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">RemoveRange</code> method
                    to set the state of the objects in the context to <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">deleted</code>. Invoking
                    the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>
                    method now deletes the records from the database and invokes SQL <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Delete</code> statements
                    for every object (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Intro/Runner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">最后，您需要清理数据库并删除所有记录。您通过检索所有记录并调用
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Remove</code>
                                或 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">RemoveRange</code>
                                方法来将上下文中的对象状态设置为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">deleted</code>
                                来实现这一点。调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>
                                方法会从数据库中删除记录，并对每个对象执行 SQL <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Delete</code>
                                语句（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Intro/Runner.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0020"><code>public async Task DeleteBooksAsync()</code>
<code>{<span aria-label="592" epub:type="pagebreak" id="Page_592" role="doc-pagebreak"></span></code>
<code>  List&lt;Book&gt; books = await _booksContext.Books.ToListAsync();</code>
<code>  _booksContext.Books.RemoveRange(books);</code>
<code>  int records = await _booksContext.SaveChangesAsync();</code>
<code>  Console.WriteLine($"{records} records deleted");</code>
<code> </code>
<code>  Console.WriteLine();</code>
<code>}</code></pre>
                <aside data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <div class="top hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <p id="c21-para-0053" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NOTE</b> <i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">An
                                object-relational mapping tool such as EF Core is not useful with all scenarios.
                                Deleting all objects was not done efficiently with the sample code. Instead of sending a
                            </i><code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DELETE</code><i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"> statement to the
                                database for every record to delete, you can delete all records using a single SQL
                                statement. EF Core is not that bad in such scenarios because rather than sending one
                                statement after another to the database, multiple statements are combined into a batch
                                statement. However, it's even better to just send one SQL statement in that case. This
                                can be done using </i><code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">context.Database.ExecuteSqlInterpolated</code><i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"> and </i><code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">context.Database.ExecuteSqlRaw</code><i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意：像 EF Core
                                        这样的对象关系映射工具并非适用于所有场景。示例代码中删除所有对象效率不高。与其为每条要删除的记录向数据库发送 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DELETE</code>
                                        语句，不如使用单个 SQL 语句删除所有记录。在这样场景下，EF Core
                                        表现并不差，因为它将多个语句组合成一个批量语句发送到数据库，而不是一条接一条地发送。但即使在这种情况下，直接发送一个 SQL 语句效果更好。这可以通过
                                        <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">context.Database.ExecuteSqlInterpolated</code>
                                        和 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">context.Database.ExecuteSqlRaw</code>
                                        实现。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                            <hr />
                        </div>
                    </section>
                </aside>
                <p id="c21-para-0054" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Now that you've seen how to add, query, update, and delete
                    records, this chapter steps into features behind the scenes and gets into advanced scenarios using
                    Entity Framework.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">现在你已经了解了如何添加、查询、更新和删除记录，本章将深入探讨
                                Entity Framework 背后的特性，并进入高级场景。</font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0025"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-400" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Logging and Metrics <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">日志记录和指标</font>
                        </font>
                    </font>
                </h3>
                <p id="c21-para-0055" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">You've already seen the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ToQueryString</code>
                    method that returns a query string that's created from a provider so you can take a look at what SQL
                    queries are sent to the database. There's more information available from EF Core. With a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContextOptionsBuilder</code>,
                    you can invoke the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LogTo</code> method and
                    supply a delegate with a method receiving a string parameter to define where log messages should be
                    written to. You can supply the address of the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Console.WriteLine</code>
                    method to have logs written to the console. You can access the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContextOptionsBuilder</code>
                    from the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">AddDbContext</code>
                    method, where you configure the DI container, or on overriding the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code> method
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OnConfiguring</code>
                    (if you don't use DI).<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">你已经见过返回由提供程序创建的查询字符串的 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ToQueryString</code>
                                方法，这样你就可以查看发送到数据库的 SQL 查询。EF Core 提供更多信息。使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContextOptionsBuilder</code>
                                ，你可以调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LogTo</code>
                                方法，并提供一个接收字符串参数的方法的委托来定义日志消息应该写入的位置。你可以提供 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Console.WriteLine</code>
                                方法的地址，以便将日志写入控制台。你可以从 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">AddDbContext</code>
                                方法中访问 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContextOptionsBuilder</code>
                                ，该方法用于配置依赖注入容器，或在重写 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                                方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OnConfiguring</code>
                                （如果你不使用依赖注入）时访问。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">With DI configured, EF Core uses logging based on the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ILogger</code> and <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ILoggerFactory</code>
                    interfaces, as discussed in <a href="c16.xhtml"
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Chapter 16</a>,
                    “Diagnostics and Metrics.” Besides the connection string to the database, you can configure the
                    logging provider <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Console</code> with the
                    source <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Microsoft.EntityFramework</code>
                    and the log level in the configuration file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">appsettings.json</code>.
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">配置了依赖注入后，EF Core 使用基于 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ILogger</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ILoggerFactory</code>
                                接口的日志记录，如第 16 章“诊断和指标”中所述。除了数据库的连接字符串，你还可以在配置文件 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">appsettings.json</code>
                                中使用源 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Microsoft.EntityFramework</code>
                                和日志级别来配置日志提供程序 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Console</code>
                                。</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0021"><code>{</code>
<code>  "Logging": {</code>
<code>    "Console": {</code>
<code>      "LogLevel": {</code>
<code>        "Microsoft.EntityFramework": "Debug"</code>
<code>      }</code>
<code>    }</code>
<code>  },</code>
<code>  "ConnectionStrings": {</code>
<code>    "BooksConnection": </code>
<code>      "server=(localdb)\\mssqllocaldb;database=ProCSharpBooks;trusted_connection=true"</code>
<code>  }</code>
<code>}</code></pre>
                <p id="c21-para-0057" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Debug gives a detailed logging output, including objects
                    created and disposed of. To see the SQL statements sent to the database, you just need to turn on
                    the Information level. For more information on logging, read <a href="c16.xhtml"
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Chapter 16</a>.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">Debug
                                提供详细的日志输出，包括创建和释放的对象。要查看发送到数据库的 SQL 语句，你只需打开信息级别。有关日志记录的更多信息，请阅读第 16 章。</font>
                        </font>
                    </font>
                </p>
                <p id="c21-para-0058" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1"><span aria-label="593" epub:type="pagebreak" id="Page_593"
                        role="doc-pagebreak"
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>When you create a
                    complex LINQ statement, it's often not that easy to find the generated SQL query in the log. To
                    easily find out what query you've created that matches the generated SQL, you can invoke the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">TagWith</code> method as
                    an extension method of <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IQueryable</code>. The
                    string you specify with the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">TagWith</code> method is
                    shown as comments in the output log, which is associated with the SQL statement that's executed.
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">当你创建一个复杂的 LINQ 语句时，通常不容易在日志中找到生成的
                                SQL 查询。为了轻松找到与你创建的查询匹配的 SQL 语句，你可以将 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">TagWith</code>
                                作为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IQueryable</code>
                                的扩展方法来调用。使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">TagWith</code>
                                方法指定的字符串会作为注释显示在输出日志中，并与执行的 SQL 语句相关联。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">EF Core 5.0 has been updated not only to log information but
                    also to allow you to see performance counts. To see the counts, first you need to get the process ID
                    of the application. You can do this using <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">dotnet counters ps</code>.
                    With this process ID, use <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">dotnet</code> counters,
                    specify the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">counters</code> category
                    <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Microsoft.EntityFrameworkCore</code>,
                    and pass the process ID to the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">-p</code> option:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">EF Core 5.0
                                不仅更新了日志信息功能，还允许你查看性能计数。要查看这些计数，首先需要获取应用程序的进程 ID。你可以使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">dotnet counters ps</code>
                                来完成这个操作。有了这个进程 ID，使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">dotnet</code>
                                计数器，指定 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">counters</code>
                                类别 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Microsoft.EntityFrameworkCore</code>
                                ，并将进程 ID 传递给 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">-p</code> 选项：
                            </font>
                        </font>
                    </font>
                </p>
                <pre
                    id="c21-code-0022"><code>&gt; dotnet counters monitor Microsoft.EntityFrameworkCore -p 23480</code></pre>
                <p id="c21-para-0060" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">EF Core shows the number of active <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                    s, failure counts for execution strategies and concurrency failures, queries done, queries with
                    cache hits, and the number of <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>.
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">EF Core 显示了活跃的 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                                数量、执行策略和并发失败的失败计数、执行的查询数量、具有缓存命中的查询数量以及 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>
                                的数量。</font>
                        </font>
                    </font>
                </p>
            </section>
        </section>
        <section aria-labelledby="head-2-193" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
            <span id="c21-sec-0026" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
            <h2 id="head-2-193" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">CREATING A MODEL<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">创建模型</font>
                    </font>
                </font>
            </h2>
            <p id="c21-para-0061" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">The first examples in this chapter mapped a single table. Now,
                let's get into a more complex example with a relationship between tables. In this section, you create a
                model with relations and use more features with model definitions, such as using Fluent APIs, using
                self-contained type configuration, mapping database columns to fields, and using shadow properties.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            本章的第一个示例映射了一个单一表。现在，让我们进入一个更复杂的示例，其中涉及表之间的关系。在本节中，你将创建一个具有关系的模型，并使用更多模型定义的功能，例如使用 Fluent
                            API、使用自包含类型配置、将数据库列映射到字段以及使用影子属性。</font>
                    </font>
                </font>
            </p>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0027"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-401" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Creating a Relation <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">创建关系</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Let's start creating a model. The sample project defines a
                    one-to-many relation using the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code> and <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code> types.
                    The <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                    contains a list of <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code> objects.
                    This relation is simply defined by the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItems</code> property
                    of type <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ICollection&lt;MenuItem&gt;</code>
                    (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Models/MenuCard.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">让我们开始创建模型。示例项目使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                类型定义了一个一对多的关系。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                                包含一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                对象的列表。这个关系简单地通过类型为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ICollection&lt;MenuItem&gt;</code>
                                的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItems</code>
                                属性定义（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Models/MenuCard.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0023"><code>public class MenuCard</code>
<code>{</code>
<code>  public MenuCard(string title, int menuCardId = default) </code>
<code>    =&gt; (Title, MenuCardId) = (title, menuCardId);</code>
<code> </code>
<code>  public int MenuCardId { get; set; }</code>
<code>  public string Title { get; set; }</code>
<code>  public ICollection&lt;MenuItem&gt; MenuItems { get; } = new List&lt;MenuItem&gt;();</code>
<code>  public override string ToString() =&gt; Title;</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The relation can also be accessed in the other direction; a
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code> can
                    access the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code> using the
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                    property. To create a required relationship between <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code> and <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code> (a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code> must be
                    associated with a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>), the
                    property is declared to be not nullable. However, EF Core does not support supplying this relation
                    with the constructor. To solve this dilemma, the field associated with the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code> property
                    is declared to be nullable. With the constructor, this field is not initialized. In case the get
                    accessor of the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code> property
                    is accessed, if the field is still null, an <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">InvalidOperationException</code>
                    is thrown. In retrieving a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code> from the
                    database, EF Core needs to fill this relation. When creating a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                    programmatically, the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code> property
                    can be initialized using a property initializer (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Models/MenuItem.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">关系也可以反方向访问； <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                可以通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                                属性访问 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                                。为了在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                                之间创建必需的关系（一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                必须与一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                                关联），该属性被声明为不可为空。然而，EF Core 不支持通过构造函数提供这种关系。为了解决这个困境，与 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                                属性关联的字段被声明为可空。通过构造函数，该字段不会被初始化。如果访问 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                                属性的获取器，如果字段仍然是 null，则会抛出 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">InvalidOperationException</code>
                                。在从数据库检索 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                时，EF Core 需要填充这个关系。在程序设计 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                时，可以使用属性初始化器（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Models/MenuItem.cs</code>
                                ）来初始化 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                                属性：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0024"><code>public class MenuItem</code>
<code>{</code>
<code>  public MenuItem(string text, int menuItemId = default) =&gt; </code>
<code>    (Text, MenuItemId) = (text, menuItemId);</code>
<code> <span aria-label="594" epub:type="pagebreak" id="Page_594" role="doc-pagebreak"></span></code>
<code>  public int MenuItemId { get; set; }</code>
<code>  public string Text { get; set; }</code>
<code>  public decimal? Price { get; set; }</code>
<code>  private MenuCard? _menuCard;</code>
<code>  public MenuCard MenuCard</code>
<code>  {</code>
<code>    get =&gt; _menuCard ?? throw new InvalidOperationException(</code>
<code>      $"{nameof(MenuCard)} not initialized");</code>
<code>    init =&gt; _menuCard = value;</code>
<code>  }</code>
<code>  public override string ToString() =&gt; Text;</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The mapping to the database is done by the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenusContext</code>
                    class. This class is defined similarly to the previous context type; it just contains two properties
                    to map the two object types: the properties <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItems</code> and
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCards</code> (code
                    file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenusSamples/MenusContext.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">映射到数据库是由 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenusContext</code>
                                类完成的。这个类与之前的上下文类型定义类似；它只包含两个属性来映射两个对象类型：属性 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItems</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCards</code>
                                （代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenusSamples/MenusContext.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0025"><code>public class MenusContext: DbContext</code>
<code>{</code>
<code>  private const string ConnectionString = @"server=(localdb)\MSSQLLocalDb;" +</code>
<code>    "Database=MenuCards;Trusted_Connection=True";</code>
<code> </code>
<code>  public DbSet&lt;MenuItem&gt; MenuItems { get; set; }</code>
<code>  public DbSet&lt;MenuCard&gt; MenuCards { get; set; }</code>
<code> </code>
<code>  protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)</code>
<code>  {</code>
<code>    base.OnConfiguring(optionsBuilder);</code>
<code>    optionsBuilder.UseSqlServer(ConnectionString);</code>
<code>  }</code>
<code>}</code></pre>
                <p id="c21-para-0065" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">There are some parts in the creation code that would be
                    useful to change. For example, the size of the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Text</code> and <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Title</code> columns
                    could be reduced in size from <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NVARCHAR(MAX)</code>. In
                    addition, SQL Server defines a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Money</code> type that
                    could be used for the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Price</code> column, and
                    the schema name could be changed from <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">dbo</code>. Entity
                    Framework gives you two options to make these changes from code: data annotations and the Fluent
                    API, which are both discussed next.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在创建代码中有些部分需要修改。例如， <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Text</code> 和
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Title</code>
                                列的大小可以从 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NVARCHAR(MAX)</code>
                                减小。此外，SQL Server 定义了一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Money</code>
                                类型，可用于 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Price</code>
                                列，模式名称可以从 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">dbo</code>
                                更改。Entity Framework 提供了两种从代码中进行这些修改的选项：数据注解和 Fluent API，接下来将讨论这两种方法。</font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0028"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-402" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Using the Fluent API for Mapping Definitions<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用 Fluent API 进行映射定义</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">In the previous sample code, conventions and annotations are
                    used to specify the mapping of the model types to the database tables. You have more options with
                    the Fluent API by overriding the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OnModelCreating</code>
                    method of the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                    -derived class. In the following code sample, the schema for the database definition is changed from
                    the default <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">dbo</code>
                    to <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">mc</code> to invoke
                    the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">HasDefaultSchema</code>
                    method of the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ModelBuilder</code>
                    class. You use the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ModelBuilder</code> API
                    to specify the schema for the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code> class
                    using the generic method <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Entity</code>. The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ToTable</code> method
                    maps the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code> class to
                    the table <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItems</code>.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                在之前的示例代码中，使用约定和注解来指定模型类型到数据库表的映射。通过重写 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OnModelCreating</code>
                                派生类的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                                方法，Fluent API 提供了更多选项。在以下代码示例中，数据库定义的模式从默认的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">dbo</code>
                                更改为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">mc</code> 以调用
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ModelBuilder</code>
                                类的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">HasDefaultSchema</code>
                                方法。您使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ModelBuilder</code>
                                API 通过泛型方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Entity</code>
                                指定 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                类的模式。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ToTable</code>
                                方法将 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                类映射到表 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItems</code>
                                。</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0026"><code>protected override void OnModelCreating(ModelBuilder modelBuilder)</code>
<code>{</code>
<code>  modelBuilder.HasDefaultSchema("mc");</code>
<code>  modelBuilder.Entity&lt;MenuItem&gt;().ToTable("MenuItems").HasKey(m =&gt; m.MenuItemId);</code>
<code>  modelBuilder.Entity&lt;MenuItem&gt;().Property(m =&gt; m.MenuItemId).ValueGeneratedOnAdd();</code>
<code>  modelBuilder.Entity&lt;MenuItem&gt;().Property(m =&gt; m.Text).HasMaxLength(50);</code>
<code>  modelBuilder.Entity&lt;MenuItem&gt;().Property(m =&gt; m.Price).HasColumnType("Money");</code>
<code> <span aria-label="595" epub:type="pagebreak" id="Page_595" role="doc-pagebreak"></span></code>
<code>  modelBuilder.Entity&lt;MenuItem&gt;().HasOne(m =&gt; m.MenuCard)</code>
<code>    .WithMany(c =&gt; c.MenuItems)</code>
<code>    .HasForeignKey("MenuCardId");</code>
<code> </code>
<code>  //…</code>
<code>}</code></pre>
                <aside data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <div class="top hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <p id="c21-para-0068" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NOTE</b> <i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">The Fluent API
                                gives you more options to configure the annotations, and annotations give you more
                                options than conventions. You can use all these options in combination. Annotations
                                override conventions, and the Fluent API overrides annotations.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意 Fluent API
                                        提供了更多配置注解的选项，而注解比约定提供了更多选项。你可以组合使用所有这些选项。注解会覆盖约定，而 Fluent API 会覆盖注解。</font>
                                </font>
                            </font>
                        </p>
                        <p id="c21-para-0069" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                                data-immersive-translate-paragraph="1">In scenarios where you can choose between the
                                options, what should you select? Often, it's a matter of taste. Some developers prefer
                                annotations as long as this option is possible with the things you need to configure;
                                others always use the Fluent API. But there are other good reasons as well to choose one
                                option over the other. For example, you can use entity types in a shared library, use
                                the same classes to access the database, pass the data across an API, and use the same
                                types with the client application. When you create microservices with a clearly defined
                                use, this can be a good option to reduce the amount of code you need to write. Here, you
                                can use the same annotations to map properties to the database and to validate user
                                inputs on the client and with the API—for example, the string length with the <code
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">StringLength</code>
                                attribute. In such a case, it's a good practice to avoid annotations that are specific
                                for the database provider. You don't want to create a dependency on an EF Core library
                                with a client application where you might not have access to this library or this
                                version of the library. If you use a different application architecture with dedicated
                                data transfer objects (DTO) to be sent across the network, and different types on the
                                client (for example if you need a different technology for the client application such
                                as Angular), selecting a mapping variant is just a matter of taste.<font
                                    class="notranslate immersive-translate-target-wrapper"
                                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                    <font
                                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                        data-immersive-translate-translation-element-mark="1">
                                        <font
                                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                            data-immersive-translate-translation-element-mark="1">
                                            在选择方案时，应该选择哪个选项？通常这取决于个人喜好。一些开发者只要配置项支持，就倾向于使用注解；另一些开发者则始终使用 Fluent
                                            API。但选择不同方案也有其他好的理由。例如，你可以在共享库中使用实体类型，用相同的类来访问数据库、通过 API
                                            传递数据，并在客户端应用程序中使用相同的类型。当你创建用途明确的小服务时，这可以是一个减少需要编写的代码量的好选项。在这里，你可以使用相同的注解来映射属性到数据库，并在客户端和
                                            API 上验证用户输入——例如，使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">StringLength</code>
                                            属性来指定字符串长度。在这种情况下，避免使用特定于数据库提供者的注解是一个好习惯。你不想在客户端应用程序中创建对 EF Core
                                            库的依赖，而你可能无法访问这个库或这个版本的库。
                                            如果你使用不同的应用程序架构，并使用专门的数据传输对象（DTO）在网络上传输，且客户端使用不同的类型（例如，如果你需要为客户端应用程序使用不同的技术，如
                                            Angular），那么选择映射变体只是一个口味问题。</font>
                                    </font>
                                </font></i></p>
                        <div class="bottom hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                            <hr />
                        </div>
                    </section>
                </aside>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0030"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-403" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Using Self-Contained Type Configuration <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用自包含类型配置</font>
                        </font>
                    </font>
                </h3>
                <p id="c21-para-0070" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">If you need to specify several different entity types, the
                    implementation of the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OnModelCreating</code>
                    method can grow large. To create easier-to-understand mappings, you can also create configuration
                    classes for every data class. An entity type configuration class implements the generic interface
                    <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IEntityTypeConfiguration</code>.
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">如果你需要指定多个不同的实体类型， <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OnModelCreating</code>
                                方法的实现可能会变得很大。为了创建更易于理解的映射，你也可以为每个数据类创建配置类。实体类型配置类实现了泛型接口 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IEntityTypeConfiguration</code>
                                。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">With the sample application, a strongly typed list of column
                    names that is used with the configuration of the mappings is defined with the class <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ColumnNames</code>, as
                    shown in the following code snippet. Instead of using strings when using these column names,
                    IntelliSense can automatically complete the code you write, and the compiler warns of misspellings
                    (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Models/ColumnNames.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在示例应用程序中，使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ColumnNames</code>
                                类定义了一个强类型列名列表，该列表用于映射配置，如下面的代码片段所示。在使用这些列名时，而不是使用字符串，IntelliSense
                                可以自动完成你编写的代码，并且编译器会警告拼写错误（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Models/ColumnNames.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0027"><code>internal class ColumnNames</code>
<code>{</code>
<code>  public const string LastUpdated = nameof(LastUpdated);</code>
<code>  public const string IsDeleted = nameof(IsDeleted);</code>
<code>  public const string MenuCardId = nameof(MenuCardId);</code>
<code>  public const string RestaurantId = nameof(RestaurantId);</code>
<code>}</code></pre>
                <p id="c21-para-0072" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">To avoid writing the class name when specifying the
                    constants, you use <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">using static ColumnNames</code>
                    to import the names of the class members.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">为了避免在指定常量时书写类名，你使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">using static ColumnNames</code>
                                来导入类成员的名称。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The class <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCardConfiguration</code>
                    implements the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Configure</code> method
                    of the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IEntityTypeConfiguration</code>
                    interface and specifies the mapping of this class to the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCards</code> table,
                    constraints with the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Title</code> property,
                    and a relation with the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code> class.
                    One <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                    references a list of <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code> objects
                    specified by the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItems</code> property
                    as <span aria-label="596" epub:type="pagebreak" id="Page_596" role="doc-pagebreak"
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>specified with the
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">HasMany</code> method.
                    To go back to the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code> from the
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>, you
                    use the <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">WithOne</code>
                    method. The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code> property
                    of the <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                    class references one <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code> (code
                    file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Models/MenuCardConfiguration.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">类 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCardConfiguration</code>
                                实现了 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IEntityTypeConfiguration</code>
                                接口的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Configure</code>
                                方法，并指定了此类与 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCards</code>
                                表的映射、通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Title</code>
                                属性定义的约束以及与 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                类的关联。一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                                通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">HasMany</code>
                                方法引用了由 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItems</code>
                                属性指定的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                对象列表。要从 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                返回到 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                                ，你使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">WithOne</code>
                                方法。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                类的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                                属性引用了一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                                （代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Models/MenuCardConfiguration.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0028"><code>using Microsoft.EntityFrameworkCore;</code>
<code>using Microsoft.EntityFrameworkCore.Metadata.Builders;</code>
<code>using System;</code>
<code>using static ColumnNames;</code>
<code> </code>
<code>internal class MenuCardConfiguration : IEntityTypeConfiguration&lt;MenuCard&gt;</code>
<code>{</code>
<code>  public void Configure(EntityTypeBuilder&lt;MenuCard&gt; builder)</code>
<code>  {</code>
<code>    builder.ToTable("MenuCards")</code>
<code>      .HasKey(c =&gt; c.MenuCardId);</code>
<code> </code>
<code>    builder.Property(c =&gt; c.MenuCardId)</code>
<code>      .ValueGeneratedOnAdd();</code>
<code>    builder.Property(c =&gt; c.Title)</code>
<code>      .HasMaxLength(50);</code>
<code>    builder.HasMany(c =&gt; c.MenuItems)</code>
<code>      .WithOne(m =&gt; m.MenuCard);</code>
<code> </code>
<code>    //…</code>
<code>  }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code> class is
                    also configured with a specific configuration class. The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Price</code> property of
                    type decimal maps to the SQL Server database type <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Money</code>. When using
                    annotations, you could use the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbType</code> attribute
                    to specify a database type. Another interesting aspect of the implementation is the use of the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">HasForeignKey</code>
                    method to map the relation to the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code> with the
                    foreign key <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCardId</code>.
                    Because the class <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code> does not
                    have a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCardId</code>
                    property, a lambda expression cannot be used to access this property; a string is required. The
                    string that is used is strongly defined with the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ColumnNames</code> class.
                    With this in place, a shadow property is created. Shadow properties are discussed later in the
                    section “Working with Shadow Properties” (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Models/MenuItemConfiguration.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                类也使用特定的配置类进行配置。类型为 decimal 的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Price</code>
                                属性映射到 SQL Server 数据库类型 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Money</code>
                                。在使用注解时，你可以使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbType</code>
                                属性来指定数据库类型。实现的另一个有趣方面是使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">HasForeignKey</code>
                                方法将关系映射到具有外键 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCardId</code>
                                的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                                。由于 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                                类没有 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCardId</code>
                                属性，因此不能使用 lambda 表达式来访问此属性；需要使用字符串。使用的字符串由 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ColumnNames</code>
                                类强定义。这样，就创建了一个影子属性。影子属性将在“使用影子属性”一节中讨论（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Models/MenuItemConfiguration.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0029"><code>internal class MenuItemConfiguration : IEntityTypeConfiguration&lt;MenuItem&gt;</code>
<code>{</code>
<code>  public void Configure(EntityTypeBuilder&lt;Menu&gt; builder)</code>
<code>  {</code>
<code>    builder.ToTable("MenuItems")</code>
<code>      .HasKey(m =&gt; m.MenuItemId);</code>
<code>    builder.Property(m =&gt; m.MenuItemId)</code>
<code>      .ValueGeneratedOnAdd();</code>
<code>    builder.Property(m =&gt; m.Text)</code>
<code>      .HasMaxLength(50);</code>
<code>    builder.Property(m =&gt; m.Price)</code>
<code>      .HasColumnType("Money");</code>
<code> </code>
<code>    builder.HasOne(m =&gt; m.MenuCard)</code>
<code>      .WithMany(c =&gt; c.MenuItems)</code>
<code>      .HasForeignKey(MenuCardId);</code>
<code> </code>
<code>    //…</code>
<code>  }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1"><span aria-label="597" epub:type="pagebreak" id="Page_597"
                        role="doc-pagebreak"
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>To activate the
                    configuration classes with the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OnModelCreating</code>
                    method of the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                    -derived class, you invoke the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ApplyConfiguration</code>
                    method (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Models/MenusContext.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">要使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                                派生类的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OnModelCreating</code>
                                方法激活配置类，你调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ApplyConfiguration</code>
                                方法（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Models/MenusContext.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0030"><code>protected override void OnModelCreating(ModelBuilder modelBuilder)</code>
<code>{</code>
<code>  modelBuilder.HasDefaultSchema("mc")</code>
<code>    .ApplyConfiguration(new MenuCardConfiguration())</code>
<code>    .ApplyConfiguration(new MenuConfiguration());        </code>
<code> </code>
<code>  //…</code>
<code>}</code></pre>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0031"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-404" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Mapping to Fields <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">映射到字段</font>
                        </font>
                    </font>
                </h3>
                <p id="c21-para-0076" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">EF Core allows mapping table columns not only to properties
                    but also to private fields. This makes it possible to create read-only properties and use private
                    fields that are not accessible outside of the class.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">EF Core
                                允许将表列不仅映射到属性，还可以映射到私有字段。这使得创建只读属性和使用在类外部不可访问的私有字段成为可能。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Let's take a look at the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Restaurant</code> class
                    in the following code snippet. This class contains a private field <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">_id</code> that is
                    accessible only within the class. <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Name</code> is a
                    read-only property that accesses the field <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">_name</code> (code file
                    <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Models/Restaurant.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">让我们看一下以下代码片段中的 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Restaurant</code>
                                类。该类包含一个私有字段 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">_id</code>
                                ，它只能在类内部访问。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Name</code>
                                是一个只读属性，它访问字段 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">_name</code>
                                （代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Models/Restaurant.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0031"><code>public class Restaurant</code>
<code>{</code>
<code>  public Restaurant(string name, int id = default) =&gt; (_name, _id) = (name, id);</code>
<code> </code>
<code>  private int _id = default;</code>
<code>  private string _name;</code>
<code>  public string Name =&gt; _name;</code>
<code> </code>
<code>  public override string ToString() =&gt; $"{Name}, {_id}";</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The property <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Name</code> can now be
                    configured to map to the corresponding field with the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">HasField</code> method.
                    The <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">_bookId</code>
                    doesn't have a corresponding property; thus, it is configured with an overload of the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Property</code> method
                    where the name is assigned as a string. The method <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">HasColumnName</code> maps
                    the field to the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Id</code> column in the
                    database (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksSample/BooksContext.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">现在可以通过 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">HasField</code>
                                方法将属性 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Name</code>
                                配置为映射到相应的字段。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">_bookId</code>
                                没有相应的属性；因此，它通过重载的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Property</code>
                                方法进行配置，其中名称被指定为字符串。方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">HasColumnName</code>
                                将字段映射到数据库中的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Id</code>
                                列（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksSample/BooksContext.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0032"><code>internal class RestaurantConfiguration : IEntityTypeConfiguration&lt;Restaurant&gt;</code>
<code>{</code>
<code>  public void Configure(EntityTypeBuilder&lt;Restaurant&gt; builder)</code>
<code>  {</code>
<code>    builder.Property&lt;int&gt;("_id")</code>
<code>      .HasColumnName("Id")</code>
<code>      .IsRequired()</code>
<code>      .UsePropertyAccessMode(PropertyAccessMode.Field);</code>
<code> </code>
<code>    builder.Property(r =&gt; r.Name)</code>
<code>      .HasField("_name")</code>
<code>      .UsePropertyAccessMode(PropertyAccessMode.FieldDuringConstruction)</code>
<code>      .HasMaxLength(30);</code>
<code> </code>
<code>    builder.HasKey("_id");</code>
<code>  }</code>
<code>}</code></pre>
            </section> <span aria-label="598" epub:type="pagebreak" id="Page_598" role="doc-pagebreak"
                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0032"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-405" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Working with Shadow Properties <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用影子属性</font>
                        </font>
                    </font>
                </h3>
                <p id="c21-para-0079" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Not only does EF Core allow mapping database columns to
                    private fields, but it also lets you define a mapping that doesn't show up in the model at all. You
                    can use shadow properties that can be retrieved with the entity in the context but are not available
                    with the model.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">不仅 EF Core
                                允许将数据库列映射到私有字段，它还允许你定义一个完全不会在模型中出现的映射。你可以使用影子属性，这些属性可以通过上下文中的实体检索，但在模型中不可用。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The following code snippet defines the shadow properties
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsDeleted</code>, <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LastUpdated</code>, <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">RestaurantId</code>, and
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCardId</code> with
                    the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuConfiguration</code>.
                    All these properties are not specified with the model type and are available only when using the EF
                    Core context. The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCardId</code> shadow
                    property is created automatically because it's specified as a foreign key with the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">HasForeignKey</code>
                    method (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Models/MenuConfiguration.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">以下代码片段使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuConfiguration</code>
                                定义了 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsDeleted</code>
                                、 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LastUpdated</code>
                                、 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">RestaurantId</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCardId</code>
                                的影子属性。所有这些属性都没有在模型类型中指定，并且只有在使用 EF Core 上下文时才可用。 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCardId</code>
                                影子属性会自动创建，因为它被指定为使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">HasForeignKey</code>
                                方法（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Models/MenuConfiguration.cs</code>
                                ）作为外键：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0033"><code>internal class MenuConfiguration : IEntityTypeConfiguration&lt;Menu&gt;</code>
<code>{</code>
<code>  public void Configure(EntityTypeBuilder&lt;Menu&gt; builder)</code>
<code>  {</code>
<code>    //…</code>
<code> </code>
<code>    builder.HasOne(m =&gt; m.MenuCard)</code>
<code>      .WithMany(c =&gt; c.MenuItems)</code>
<code>      <b>.HasForeignKey(MenuCardId);</b></code>
<code> </code>
<code>    // shadow properties</code>
<code>    <b>builder.Property&lt;bool&gt;(IsDeleted);</b></code>
<code>    <b>builder.Property&lt;DateTime&gt;(LastUpdated);</b></code>
<code>    <b>builder.Property&lt;Guid&gt;(RestaurantId);</b></code>
<code>    // builder.Property&lt;int&gt;(MenuCardId); // created because of HasForeignKey</code>
<code>  }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">You use the shadow property <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LastUpdated</code> to
                    write the actual time when the entity was updated last. You use the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsDeleted</code> property
                    to define a state in which the entity is deleted instead of truly deleting it. Sometimes, it can be
                    useful not to delete the data on the request of the user; instead, you just mark it as deleted. This
                    allows you to make an undo to recover the entity.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">你使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LastUpdated</code>
                                影子属性来记录实体最后一次更新的实际时间。你使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsDeleted</code>
                                属性来定义一个状态，在这个状态下，实体被标记为删除而不是真正删除它。有时，根据用户请求不删除数据可能很有用；你只需将其标记为已删除。这允许你撤销操作以恢复实体。</font>
                        </font>
                    </font>
                </p>
                <aside data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <div class="top hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <p id="c21-para-0082" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NOTE</b> <i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Because of the
                                General Data Protection Regulation (GDPR), </i><code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><a href="https://en.wikipedia.org/wiki/General_Data_Protection_Regulation">https://en.wikipedia.org/wiki/General_Data_Protection_Regulation</a></code><i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">, which is an EU
                                law, you need to be careful to mark data as deleted but not delete it if the data is
                                related to personal data.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意 由于通用数据保护条例（GDPR）， <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><a href="https://en.wikipedia.org/wiki/General_Data_Protection_Regulation">https://en.wikipedia.org/wiki/General_Data_Protection_Regulation</a></code>
                                        ，这是一项欧盟法律，如果你需要标记数据为已删除但不想删除它，并且这些数据与个人数据相关，你需要小心处理。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                            <hr />
                        </div>
                    </section>
                </aside>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">To update the shadow property <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LastUpdated</code>
                    automatically, the method <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>
                    is overridden. If you're using the synchronous <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChanges</code> method
                    to write changes to the database, you need to override this method as well. With the implementation,
                    the actual state of the entities is checked. If the state is <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Added</code>, <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Modified</code>, or <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Deleted</code>, the
                    shadow property is updated with the current time. To manage the shadow property <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsDeleted</code>, deleted
                    entities are changed to the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Modified</code> state,
                    and the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsDeleted</code> shadow
                    property is set to <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">true</code>. Shadow
                    properties don't have a property in the model that allows for accessing them; instead, you can use
                    the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CurrentValues</code>
                    indexer of the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EntityEntry</code> (code
                    file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Models/MenusContext.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">为了自动更新影子属性 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LastUpdated</code>
                                ，需要重写方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>
                                。如果你使用同步 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChanges</code>
                                方法将更改写入数据库，也需要重写这个方法。通过实现，会检查实体的实际状态。如果状态是 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Added</code>
                                、 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Modified</code>
                                或 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Deleted</code>
                                ，影子属性会使用当前时间进行更新。为了管理影子属性 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsDeleted</code>
                                ，已删除的实体会被更改为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Modified</code>
                                状态，并且 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsDeleted</code>
                                影子属性会被设置为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">true</code>
                                。影子属性在模型中没有对应的属性来访问它们；相反，你可以使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CurrentValues</code>
                                的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EntityEntry</code>
                                索引器（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Models/MenusContext.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0034"><code>public override Task&lt;int&gt; SaveChangesAsync(CancellationToken cancellationToken = default)</code>
<code>{<span aria-label="599" epub:type="pagebreak" id="Page_599" role="doc-pagebreak"></span></code>
<code>  ChangeTracker.DetectChanges();</code>
<code> </code>
<code>  foreach (var item in ChangeTracker.Entries&lt;MenuItem&gt;()</code>
<code>    .Where(e =&gt; e.State == EntityState.Added</code>
<code>    || e.State == EntityState.Modified</code>
<code>    || e.State == EntityState.Deleted))</code>
<code>  {</code>
<code>    item.CurrentValues[LastUpdated] = DateTime.Now;</code>
<code> </code>
<code>    if (item.State == EntityState.Deleted)</code>
<code>    {</code>
<code>      item.State = EntityState.Modified;</code>
<code>      item.CurrentValues[IsDeleted] = true;</code>
<code>    }</code>
<code>  }</code>
<code>  return base.SaveChangesAsync(cancellationToken);</code>
<code>}</code></pre>
                <aside data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <div class="top hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <p id="c21-para-0085" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NOTE</b> <i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">The change
                                tracker that is used with the sample code is shown in detail later in the section
                                “Tracking Objects.”</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意
                                        示例代码中使用的变更跟踪器将在本章稍后的“跟踪对象”部分详细说明。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                            <hr />
                        </div>
                    </section>
                </aside>
                <aside data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <div class="top hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <p id="c21-para-0086" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NOTE</b> <i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">When you have an
                            </i> <code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsDeleted</code>
                            <i data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"> property, it
                                would be a good idea not to return entities where </i> <code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsDeleted</code>
                            <i data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"> is set to true
                                when using normal queries. You can do this with the EF Core feature global query
                                filters, which is discussed later in this chapter.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意 当你有一个 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsDeleted</code>
                                        属性时，在使用普通查询时，最好不要返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsDeleted</code>
                                        设置为 true 的实体。你可以使用 EF Core 的全局查询过滤器功能来实现这一点，该功能将在本章后面讨论。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                            <hr />
                        </div>
                    </section>
                </aside>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">To show deleted entities, the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DeleteMenuItemAsync</code>
                    method is defined to delete the entity with the ID that is passed to this method. Here, the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Remove</code> method is
                    invoked by passing the entity object, and <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>
                    is invoked (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Models/Runner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">为了显示已删除的实体，定义了 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DeleteMenuItemAsync</code>
                                方法来删除传入此方法 ID 的实体。这里通过传入实体对象调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Remove</code>
                                方法，并调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>
                                （代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Models/Runner.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0035"><code>public async Task DeleteMenuItemAsync(int id)</code>
<code>{</code>
<code>  MenuItem? menuItem = await _menusContext.MenuItems.FindAsync(id);</code>
<code>  if (menuItem is null) return;</code>
<code> </code>
<code>  _menusContext.Remove(menuItem);</code>
<code>  int records = await _menusContext.SaveChangesAsync();</code>
<code>  Console.WriteLine($"{records} deleted");</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Behind the scenes, the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsDeleted</code> shadow
                    property is set because of the change to the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>
                    method. To verify this, you can access the shadow property using the method <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EF.Property</code> by
                    passing the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsDeleted</code> string.
                    All the <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code>
                    entities with this flag are shown in the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">QueryDeletedMenusAsync</code>
                    method:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在后台，由于对 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>
                                方法的更改， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsDeleted</code>
                                影子属性被设置。要验证这一点，您可以通过传入 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsDeleted</code>
                                字符串使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EF.Property</code>
                                方法访问影子属性。所有带有此标志的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code>
                                实体都在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">QueryDeletedMenusAsync</code>
                                方法中显示：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0036"><code>public async Task QueryDeletedMenuItemsAsync()</code>
<code>{</code>
<code>  IEnumerable&lt;MenuItem&gt; deletedMenuItems =</code>
<code>    await _menusContext.MenuItems</code>
<code>      .Where(b =&gt; EF.Property&lt;bool&gt;(b, IsDeleted))</code>
<code>      .ToListAsync();</code>
<code> <span aria-label="600" epub:type="pagebreak" id="Page_600" role="doc-pagebreak"></span></code>
<code>  foreach (var menuItem in deletedMenuItems)</code>
<code>  {</code>
<code>    Console.WriteLine($"deleted: {menuItem}");</code>
<code>  }</code>
<code>}</code></pre>
                <aside data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <div class="top hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <p id="c21-para-0090" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NOTE</b> <code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EF</code> <i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">is a static class
                                in the namespace </i><code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Microsoft.EntityFrameworkCore</code><i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"> that offers
                                static methods that are useful when EF types are not available. In this section, you've
                                seen the </i><code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Property</code><i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"> method that can
                                be used to access shadow state. Later in this chapter, the </i><code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EF</code><i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"> class is used
                                with compiled queries and </i><code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EF.Functions</code><i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EF</code>
                                        是命名空间 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Microsoft.EntityFrameworkCore</code>
                                        中的静态类，提供了在 EF 类型不可用时有用的静态方法。在本节中，您看到了可以用来访问影子状态的 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Property</code>
                                        方法。在本章后面， <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EF</code>
                                        类与编译查询和 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EF.Functions</code>
                                        一起使用。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                            <hr />
                        </div>
                    </section>
                </aside>
            </section>
        </section>
        <section aria-labelledby="head-2-194" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
            <span id="c21-sec-0037" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
            <h2 id="head-2-194" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">SCAFFOLDING A MODEL FROM THE DATABASE<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">从数据库生成模型</font>
                    </font>
                </font>
            </h2>
            <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">Instead of creating the database from the model as you've seen
                with invoking the method <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EnsureCreatedAsync</code>,
                you can create the model from the database. To do this, create a console application and add the NuGet
                package <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Microsoft.EntityFrameworkCore.Design</code>
                to the packages referenced, and add the <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">dotnet-ef</code> tool to the
                project (unless you already have it registered with the global tools). To access Microsoft SQL Server,
                the package <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Microsoft.EntityFrameworkCore.SqlServer</code>
                is needed as well (project file <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ScaffoldSample/ScaffoldSample.csproj</code>):
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">与其像调用方法 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EnsureCreatedAsync</code>
                            那样从模型创建数据库，你也可以从数据库创建模型。为此，创建一个控制台应用程序，将 NuGet 包 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Microsoft.EntityFrameworkCore.Design</code>
                            添加到引用的包中，并将 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">dotnet-ef</code>
                            工具添加到项目中（除非你已经将其注册为全局工具）。要访问 Microsoft SQL Server，还需要 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Microsoft.EntityFrameworkCore.SqlServer</code>
                            包（项目文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ScaffoldSample/ScaffoldSample.csproj</code>
                            ）：</font>
                    </font>
                </font>
            </p>
            <pre id="c21-code-0037"><code>&lt;Project Sdk="Microsoft.NET.Sdk"&gt;</code>
<code> </code>
<code>  &lt;PropertyGroup&gt;</code>
<code>    &lt;OutputType&gt;Exe&lt;/OutputType&gt;</code>
<code>    &lt;TargetFramework&gt;net5.0&lt;/TargetFramework&gt;</code>
<code>  &lt;/PropertyGroup&gt;</code>
<code> </code>
<code>  &lt;ItemGroup&gt;</code>
<code>    &lt;PackageReference Include="Microsoft.EntityFrameworkCore.Design" Version="5.0.5"&gt;</code>
<code>      &lt;PrivateAssets&gt;all&lt;/PrivateAssets&gt;</code>
<code>      &lt;IncludeAssets&gt;</code>
<code>        runtime; build; native; contentfiles; analyzers; buildtransitive</code>
<code>      &lt;/IncludeAssets&gt;</code>
<code>    &lt;/PackageReference&gt;</code>
<code>    &lt;PackageReference Include="Microsoft.EntityFrameworkCore.SqlServer" Version="5.0.5"/&gt;</code>
<code>  &lt;/ItemGroup&gt;</code>
<code> </code>
<code>&lt;/Project&gt;</code></pre>
            <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">After the tools are installed, you can start the <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">dotnet ef</code> command and
                specify the connecting string to the database and the name of the EF Core provider:<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">安装工具后，你可以开始 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">dotnet ef</code>
                            命令，并指定数据库的连接字符串和 EF Core 提供者的名称：</font>
                    </font>
                </font>
            </p>
            <pre id="c21-code-0038"><code>&gt; dotnet ef dbcontext scaffold</code>
<code>"server=(localdb)\MSSQLLocalDb;database=MenuCards;</code>
<code>trusted_connection=true" "Microsoft.EntityFrameworkCore.SqlServer"</code></pre>
            <p id="c21-para-0093" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">The <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">dbcontext</code> command
                enables you to list <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code> objects from
                the project, as well as create <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DBContext</code> objects. The
                command <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">scaffold</code>
                creates <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                -derived classes as well as model classes. <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">dotnet ef dbcontext scaffold</code>
                needs two required arguments: the connection string to the database and the provider that should be
                used. With the statement shown earlier, the database <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ProCSharpMenus</code> was
                accessed on <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SQL Server <span aria-label="601" epub:type="pagebreak" id="Page_601" role="doc-pagebreak"></span>(localdb)\MSSQLLocalDb</code>.
                The provider used was <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Microsoft.EntityFrameworkCore.SqlServer</code>.
                This NuGet package needs to be added to the project.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1"> <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">dbcontext</code>
                            命令可以让你列出项目中的 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                            对象，以及创建 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DBContext</code>
                            对象。 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">scaffold</code>
                            命令会创建 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                            派生类以及模型类。 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">dotnet ef dbcontext scaffold</code>
                            需要两个必需参数：数据库的连接字符串和应使用的提供者。通过前面显示的语句，在 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SQL Server <span role="doc-pagebreak" id="Page_601" aria-label="601"></span>(localdb)\MSSQLLocalDb</code>
                            上访问了数据库 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ProCSharpMenus</code>
                            。使用的提供者是 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Microsoft.EntityFrameworkCore.SqlServer</code>
                            。这个 NuGet 包需要添加到项目中。</font>
                    </font>
                </font>
            </p>
            <p id="c21-para-0094" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">After running this command, you can see the <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                -derived classes as well as the model types generated. By default, the configuration of the model is
                done using the Fluent API. However, you can change it to use the data annotations supplying the <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">--data-annotations</code>
                option. The EF Core 5.0 design package has a dependency on the Humanizer library (<code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><a href="https://humanizr.net">https://humanizr.net</a></code>)
                and supports pluralization with scaffolding. For example, if you have a table named <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">People</code>, the generated
                class has the name <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Person</code>. You can
                disable pluralization with the option <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">--no-pluralize</code>. You
                can also influence the generated context class name, the tables to map, and the output directory. Just
                check the different available options using the option <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">--help</code>.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">运行此命令后，你可以看到基于 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                            派生的类以及生成的模型类型。默认情况下，模型配置是通过 Fluent API 完成的。但是，你可以通过提供 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">--data-annotations</code>
                            选项将其更改为使用数据注解。EF Core 5.0 设计包依赖于 Humanizer 库 ( <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><a href="https://humanizr.net">https://humanizr.net</a></code>
                            )，并支持通过 scaffolding 实现复数化。例如，如果你有一个名为 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">People</code>
                            的表，生成的类名称将是 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Person</code>
                            。你可以通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">--no-pluralize</code>
                            选项禁用复数化。你也可以影响生成的上下文类名称、要映射的表以及输出目录。只需使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">--help</code>
                            选项检查不同的可用选项。</font>
                    </font>
                </font>
            </p>
        </section>
        <section aria-labelledby="head-2-195" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
            <span id="c21-sec-0038" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
            <h2 id="head-2-195" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">MIGRATIONS</h2>
            <p id="c21-para-0095" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">So far, the database has been created with the <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EnsureCreatedAsync</code>
                method, which is great for small applications. However, if you want to change the database schema after
                the database has been initially created, when using <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EnsureCreatedAsync</code> you
                need to delete and re-create the database. There's another option: you can create the database with EF
                Core <i data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">migrations</i>. With EF
                Core migrations you can update the database schema programmatically. To support continuous integration
                (CI) and continuous delivery (CD), EF Core supports the concept of infrastructure as code (<code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><a href="https://docs.microsoft.com/azure/devops/learn/what-is-infrastructure-as-code">https://docs.microsoft.com/azure/devops/learn/what-is-infrastructure-as-code</a></code>)
                with migrations, which gives you a great option for always supporting repeated deployments. You just
                need to think about who has the right to update the database schema. Usually, it's not the application
                that's running in production, and it's even bad from a security standpoint if the running application is
                allowed to change the schema. Instead, a different application should be in control to do this. You can
                also create SQL scripts for updating the database schema.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">到目前为止，数据库都是通过 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EnsureCreatedAsync</code>
                            方法创建的，这对于小型应用程序来说很方便。但是，如果你想在数据库初始创建后更改数据库架构，在使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EnsureCreatedAsync</code>
                            时需要删除并重新创建数据库。还有另一种选择：你可以使用 EF Core 迁移来创建数据库。通过 EF Core
                            迁移，你可以以编程方式更新数据库架构。为了支持持续集成（CI）和持续交付（CD），EF Core 通过迁移支持基础设施即代码（ <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><a href="https://docs.microsoft.com/azure/devops/learn/what-is-infrastructure-as-code">https://docs.microsoft.com/azure/devops/learn/what-is-infrastructure-as-code</a></code>
                            ）的概念，这为你提供了始终支持重复部署的绝佳选择。你只需要考虑谁有权更新数据库架构。通常，运行中的应用程序不应该有这个权限，而且从安全角度来看，允许运行中的应用程序更改架构也是不利的。相反，应该由另一个应用程序来控制这项操作。你也可以创建用于更新数据库架构的
                            SQL 脚本。</font>
                    </font>
                </font>
            </p>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0039"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-406" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Implementing IDesignTimeDbContextFactory<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">实现 IDesignTimeDbContextFactory
                            </font>
                        </font>
                    </font>
                </h3>
                <p id="c21-para-0096" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">With the sample application, the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code> and <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksContext</code>
                    classes from before are used in a library with the name <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksLib</code>. A
                    console application that has a dependency on this library will do the migration. The console
                    application also has a dependency on the NuGet package <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Microsoft.EntityFrameworkCore.Design</code>.
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用示例应用程序，之前提到的 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code> 和
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksContext</code>
                                类被用于一个名为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksLib</code>
                                的库中。一个依赖这个库的控制台应用程序将执行迁移。该控制台应用程序还依赖 NuGet 包 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Microsoft.EntityFrameworkCore.Design</code>
                                。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Now the .NET CLI tools need to create the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                    -derived class. You have three different options that you can implement to support the migration
                    tools:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">现在 .NET CLI 工具需要创建一个继承自 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                                的类。您有三个不同的选项可以实施来支持迁移工具：</font>
                        </font>
                    </font>
                </p>
                <ul class="check" id="c21-list-0004"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <li id="c21-li-0026" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                        data-immersive-translate-paragraph="1">Implement a default constructor with the <code
                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                        -derived class and override the <code
                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OnConfiguring</code>
                        method<font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">为继承自 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                                    的类实现一个默认构造函数，并重写 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OnConfiguring</code>
                                    方法</font>
                            </font>
                        </font>
                    </li>
                    <li id="c21-li-0027" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                        data-immersive-translate-paragraph="1">Use DI with a web-based project with a <code
                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Program</code> class
                        and a <code
                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CreateWebHostBuilder</code>
                        method<font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">在一个基于 Web 的项目中使用依赖注入，该项目包含一个
                                    <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Program</code>
                                    类和一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CreateWebHostBuilder</code>
                                    方法</font>
                            </font>
                        </font>
                    </li>
                    <li id="c21-li-0028" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                        data-immersive-translate-paragraph="1">Create a factory class that returns an instance of the
                        context<font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">创建一个工厂类，返回上下文实例</font>
                            </font>
                        </font>
                    </li>
                </ul>
                <p id="c21-para-0098" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Here, the DI container has been used with console
                    applications, so I've implemented the third option. The factory class needs to implement the generic
                    interface <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IDesignTimeDbContextFactory</code>
                    and return a context from the method <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CreateDbContext</code>.
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                这里，在控制台应用程序中使用了依赖注入容器，因此我实现了第三种选项。工厂类需要实现泛型接口 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IDesignTimeDbContextFactory</code>
                                ，并从 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CreateDbContext</code>
                                方法返回上下文。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">In the following code sample, the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksContextFactory</code>
                    class implements the interface <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IDesignTimeDbContextFactory</code>.
                    The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CreateDbContext</code>
                    method receives command-line arguments passed to the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">dotnet</code> CLI for
                    creating the migration. The connection string received via the parameters is passed to the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContextOptionsBuilder</code>
                    to create options that in turn are passed as arguments to the constructor of the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksContext</code> (code
                    file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MigrationsApp/BooksContextFactory.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在以下代码示例中， <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksContextFactory</code>
                                类实现了接口 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IDesignTimeDbContextFactory</code>
                                。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CreateDbContext</code>
                                方法接收传递给 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">dotnet</code>
                                CLI 用于创建迁移的命令行参数。通过参数接收的连接字符串被传递给 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContextOptionsBuilder</code>
                                以创建选项，这些选项反过来又作为参数传递给 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksContext</code>
                                （代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MigrationsApp/BooksContextFactory.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0039"><code>using BooksLib;</code>
<code>using Microsoft.EntityFrameworkCore;</code>
<code>using Microsoft.EntityFrameworkCore.Design;<span aria-label="602" epub:type="pagebreak" id="Page_602" role="doc-pagebreak"></span></code>
<code>using System;</code>
<code> </code>
<code>public class BooksContextFactory : IDesignTimeDbContextFactory&lt;BooksContext&gt;</code>
<code>{</code>
<code>  public BooksContext CreateDbContext(string[] args)</code>
<code>  {</code>
<code>    if (args.Length &lt; 1)</code>
<code>    {</code>
<code>      Console.WriteLine($"please supply a connection string");</code>
<code>      Environment.Exit(-1);</code>
<code>      return null!;</code>
<code>    }</code>
<code>    else</code>
<code>    {</code>
<code>      string connectionString = args[0];</code>
<code>      DbContextOptionsBuilder&lt;BooksContext&gt; optionsBuilder = new();</code>
<code>      optionsBuilder.UseSqlServer(connectionString);</code>
<code>      return new BooksContext(optionsBuilder.Options);</code>
<code>    }</code>
<code>  }</code>
<code>}</code></pre>
                <aside data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <div class="top hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <p id="c21-para-0101" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NOTE</b> <i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">If you used the
                            </i> <code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CreateDbContext</code>
                            <i data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"> method before
                                .NET 5, command-line arguments were not passed to this method. In that case, you needed
                                to supply the connection string differently. With .NET 5, this has been fixed, and you
                                can supply any options you need.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意 如果在.NET 5 之前使用了 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CreateDbContext</code>
                                        方法，命令行参数不会被传递到此方法。在这种情况下，你需要以不同的方式提供连接字符串。在.NET 5 中，这个问题已经得到修复，你可以提供任何你需要的选项。
                                    </font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                            <hr />
                        </div>
                    </section>
                </aside>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0041"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-407" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Creating Migrations <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">创建迁移</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">With all this in place, you can create an initial migration.
                    The following command—when started with the current directory set to the library—creates an initial
                    migration named <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">InitBooks</code>. The
                    startup project referenced with the option <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">--startup-project</code>
                    contains the factory code with the connection string to the server:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                现在所有准备工作就绪，你可以创建一个初始迁移。以下命令—当当前目录设置为库时执行—会创建一个名为 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">InitBooks</code>
                                的初始迁移。使用选项 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">--startup-project</code>
                                引用的启动项目包含连接到服务器的工厂代码：</font>
                        </font>
                    </font>
                </p>
                <pre
                    id="c21-code-0040"><code>&gt; dotnet ef migrations add InitBooks --startup-project ../MigrationApp/MigrationApp.csproj -- server=(localdb)\mssqllocaldb;database=ProCSharpBooks;trusted_connection=true</code></pre>
                <p id="c21-para-0103" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">If your project contains multiple EF Core contexts, you need
                    to supply the additional option <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">--context</code> and
                    supply the name of the DB context class.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">如果你的项目包含多个 EF Core 上下文，你需要提供额外的选项
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">--context</code>
                                并提供数据库上下文类名。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Running this command creates a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Migrations</code> folder
                    with a snapshot to create the complete database schema based on the model (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksLib/Migration/BooksContextModelSnapshot.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">执行此命令会创建一个 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Migrations</code>
                                文件夹，包含一个快照，用于根据模型创建完整的数据库模式（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksLib/Migration/BooksContextModelSnapshot.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0041"><code>[DbContext(typeof(BooksContext))]</code>
<code>partial class BooksContextModelSnapshot : ModelSnapshot</code>
<code>{</code>
<code>  protected override void BuildModel(ModelBuilder modelBuilder)</code>
<code>  {</code>
<code>#pragma warning disable 612, 618</code>
<code>    modelBuilder</code>
<code>      .HasAnnotation("Relational:MaxIdentifierLength", 128)</code>
<code>      .HasAnnotation("ProductVersion", "5.0.3")</code>
<code>      .HasAnnotation("SqlServer:ValueGenerationStrategy", <span aria-label="603" epub:type="pagebreak" id="Page_603" role="doc-pagebreak"></span></code>
<code>        SqlServerValueGenerationStrategy.IdentityColumn);</code>
<code> </code>
<code>    modelBuilder.Entity("BooksLib.Book", b =&gt;</code>
<code>    {</code>
<code>      b.Property&lt;int&gt;("BookId")</code>
<code>        .ValueGeneratedOnAdd()</code>
<code>        .HasColumnType("int")</code>
<code>        .HasAnnotation("SqlServer:ValueGenerationStrategy", </code>
<code>          SqlServerValueGenerationStrategy.IdentityColumn);</code>
<code> </code>
<code>      b.Property&lt;string&gt;("Publisher")</code>
<code>        .HasMaxLength(30)</code>
<code>        .HasColumnType("nvarchar(30)");</code>
<code> </code>
<code>      b.Property&lt;string&gt;("Title")</code>
<code>        .IsRequired()</code>
<code>        .HasMaxLength(50)</code>
<code>        .HasColumnType("nvarchar(50)");</code>
<code> </code>
<code>      b.HasKey("BookId");</code>
<code> </code>
<code>      b.ToTable("Books");</code>
<code>    });</code>
<code>#pragma warning restore 612, 618</code>
<code>  }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">For every migration, a migration class deriving from the base
                    class <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Migration</code>
                    is created. This base class defines the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Up</code> and <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Down</code> methods that
                    allow applying the migration to this migration version or to step a level back (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksLib/&lt;version&gt;_InitBooks.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">对于每一次迁移，都会创建一个继承自基础类 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Migration</code>
                                的迁移类。这个基础类定义了 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Up</code> 和
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Down</code>
                                方法，允许将迁移应用到这个迁移版本或回退一个级别（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksLib/&lt;version&gt;_InitBooks.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0042"><code>public partial class InitBooks : Migration</code>
<code>{</code>
<code>  protected override void Up(MigrationBuilder migrationBuilder)</code>
<code>  {</code>
<code>    migrationBuilder.CreateTable(</code>
<code>      name: "Books",</code>
<code>      columns: table =&gt; new</code>
<code>      {</code>
<code>        BookId = table.Column&lt;int&gt;(type: "int", nullable: false)</code>
<code>          .Annotation("SqlServer:Identity", "1, 1"),</code>
<code>        Title = table.Column&lt;string&gt;(type: "nvarchar(50)", maxLength: 50, </code>
<code>           nullable: false),</code>
<code>        Publisher = table.Column&lt;string&gt;(type: "nvarchar(30)", maxLength: 30, </code>
<code>           nullable: true)</code>
<code>      },</code>
<code>      constraints: table =&gt;</code>
<code>      {</code>
<code>        table.PrimaryKey("PK_Books", x =&gt; x.BookId);</code>
<code>      });</code>
<code>  }</code>
<code> <span aria-label="604" epub:type="pagebreak" id="Page_604" role="doc-pagebreak"></span></code>
<code>  protected override void Down(MigrationBuilder migrationBuilder)</code>
<code>  {</code>
<code>    migrationBuilder.DropTable(</code>
<code>      name: "Books");</code>
<code>  }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">After making a change to a model, such as adding an optional
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Isbn</code> property to
                    the <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code> class
                    (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksLib/Book.cs</code>),
                    as shown here:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在模型上做出更改后，例如向 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code>
                                类添加一个可选的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Isbn</code>
                                属性（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksLib/Book.cs</code>
                                ），如下所示：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0043"><code>public class Book</code>
<code>{</code>
<code>  public Book(string title, string? publisher = default, int bookId = default)</code>
<code>  {</code>
<code>    Title = title;</code>
<code>    Publisher = publisher;</code>
<code>    BookId = bookId;</code>
<code>  }</code>
<code>  [StringLength(50)]</code>
<code>  public string Title { get; set; }</code>
<code>  [StringLength(30)]</code>
<code>  public string? Publisher { get; set; }</code>
<code>  public int BookId { get; set; }</code>
<code>  <b>[StringLength(20)]</b></code>
<code>  <b>public string? Isbn { get; set; }</b></code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">you need a new migration:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">你需要一个新的迁移：</font>
                        </font>
                    </font>
                </p>
                <pre
                    id="c21-code-0044"><code>&gt; dotnet ef migrations add AddIsbn --startup-project ../MigrationApp/MigrationApp.csproj -- server=(localdb)\mssqllocaldb;database=ProCSharpBooks;trusted_connection=true</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">With the new migration, that snapshot class is updated to
                    show the current state, and a new <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Migration</code> type is
                    used to add and remove the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Isbn</code> column with
                    the <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Up</code> and <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Down</code> methods (code
                    file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksLib/&lt;version&gt;_AddIsbn.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用新的迁移后，那个快照类会更新以显示当前状态，并使用新的
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Migration</code>
                                类型通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Up</code> 和
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Down</code>
                                方法添加和移除 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Isbn</code>
                                列（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksLib/&lt;version&gt;_AddIsbn.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0045"><code>public partial class AddIsbn : Migration</code>
<code>{</code>
<code>  protected override void Up(MigrationBuilder migrationBuilder)</code>
<code>  {</code>
<code>    migrationBuilder.AddColumn&lt;string&gt;(</code>
<code>      name: "Isbn",</code>
<code>      table: "Books",</code>
<code>      type: "nvarchar(20)",</code>
<code>      maxLength: 20,</code>
<code>      nullable: true);</code>
<code>  }</code>
<code> </code>
<code>  protected override void Down(MigrationBuilder migrationBuilder)</code>
<code>  {</code>
<code>    migrationBuilder.DropColumn(</code>
<code>      name: "Isbn",</code>
<code>      table: "Books");</code>
<code>  }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span aria-label="605"
                        epub:type="pagebreak" id="Page_605" role="doc-pagebreak"
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span></p>
                <aside data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <div class="top hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <p id="c21-para-0110" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NOTE</b> <i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Migrations are
                                fully customizable. You can adapt the code to your own needs. With migrations, you might
                                lose data. For example, with a migration, you might reduce the string length of a
                                property. Because you forgot to limit a property with a previous version, the SQL
                                datatype can be </i><code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">nvarchar(max)</code><i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">. If you limit
                                this to </i><code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">nvarchar(50)</code><i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">, some data might
                                be lost. When creating such a migration, you get a warning on the possible data loss.
                                Whether you really lose data depends on whether the data stored in the database. You
                                might know that the data length of the string is never larger than 50 characters, but is
                                this also the case for the production database? You can customize the migration to check
                                for the length of the data before the migration takes place and inform an administrator
                                to take some actions before starting the migration. In any case, you should do a
                                database backup before doing a migration if it's not just for testing purposes.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">
                                        注意：迁移是完全可定制的。你可以根据自身需求调整代码。使用迁移时可能会丢失数据。例如，通过迁移可能会减少某个属性的字符串长度。由于你忘记在之前的版本中限制该属性，SQL
                                        数据类型可能为 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">nvarchar(max)</code>
                                        。如果你将其限制为 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">nvarchar(50)</code>
                                        ，可能会丢失一些数据。在创建此类迁移时，你会收到关于可能丢失数据的警告。你是否真的会丢失数据取决于数据库中存储的数据。你可能知道字符串的长度永远不会超过 50
                                        个字符，但这对于生产数据库也是这样吗？你可以定制迁移，在迁移执行前检查数据长度并通知管理员在开始迁移前采取一些措施。无论如何，如果你不是仅仅为了测试目的，应在执行迁移前进行数据库备份。
                                    </font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                            <hr />
                        </div>
                    </section>
                </aside>
                <aside data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <div class="top hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <p id="c21-para-0111" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NOTE</b> <i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">With every change
                                you're doing, you can create another migration. The new migration defines only the
                                changes needed to get from the previous version to the new version. If a customer's
                                database needs to be updated from any earlier version, the necessary migrations are
                                invoked when migrating the database.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">
                                        注意：对于你做出的每一次更改，都可以创建另一个迁移。新的迁移仅定义从上一个版本到新版本所需的更改。如果客户的数据库需要从任何更早的版本更新，在迁移数据库时会调用必要的迁移。
                                    </font>
                                </font>
                            </font>
                        </p>
                        <p id="c21-para-0112" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1"><i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">During the
                                development process, you might end up with many migrations that are not needed in
                                production. You just need to keep the migrations for all the versions that might be
                                running on the customer sites. To remove the migrations from development time, you can
                                invoke </i> <code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">dotnet ef migrations remove</code>
                            <i data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"> to remove the
                                latest migration code. Then add new larger migrations that contain all the changes since
                                the previous migration.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">
                                        在开发过程中，你可能会得到许多在生产环境中不需要的迁移。你只需要保留所有可能在客户站点上运行的版本的迁移。要从开发时间中移除迁移，你可以调用 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">dotnet ef migrations remove</code>
                                        来移除最新的迁移代码。然后添加新的、包含自上一个迁移以来的所有更改的较大迁移。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                            <hr />
                        </div>
                    </section>
                </aside>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0044"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-408" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Applying Migrations Programmatically <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">程序化应用迁移</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">After you've configured the migrations, you can start the
                    migration process of the database directly from the application. To do this, the console application
                    is configured to use the dependency injection container to retrieve the DB context and then to
                    invoke the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MigrateAsync</code>
                    method of the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Database</code> property
                    (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MigrationsApp/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                配置完迁移后，你可以直接从应用程序启动数据库的迁移过程。为此，控制台应用程序配置为使用依赖注入容器来检索数据库上下文，然后调用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MigrateAsync</code>
                                属性的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Database</code>
                                方法（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MigrationsApp/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0046"><code>using BooksLib;</code>
<code>using Microsoft.EntityFrameworkCore;</code>
<code>using Microsoft.Extensions.Configuration;</code>
<code>using Microsoft.Extensions.DependencyInjection;</code>
<code>using Microsoft.Extensions.Hosting;</code>
<code> </code>
<code>using var host = Host.CreateDefaultBuilder(args)</code>
<code>  .ConfigureServices((context, services) =&gt;</code>
<code>  {</code>
<code>    var connectionString = context.Configuration.GetConnectionString("BooksConnection");</code>
<code>    services.AddDbContext&lt;BooksContext&gt;();</code>
<code>  })</code>
<code>  .Build();</code>
<code> </code>
<code>using var scope = host.Services.CreateScope();</code>
<code>var context = scope.ServiceProvider.GetRequiredService&lt;BooksContext&gt;();</code>
<code>await context.Database.MigrateAsync();</code></pre>
                <p id="c21-para-0114" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1"><span aria-label="606" epub:type="pagebreak" id="Page_606"
                        role="doc-pagebreak"
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>If the database
                    does not exist yet, the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Migrate</code> method
                    creates the database—with the schemas defined by the model—as well as a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">__EFMigrationsHistory</code>
                    table that lists all the migrations that have been applied to the database. You cannot use the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EnsureCreated</code>
                    method to create the database as was used earlier because this method does not apply the migration
                    information to the database.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">如果数据库还不存在， <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Migrate</code>
                                方法会创建数据库——包括模型定义的架构——以及一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">__EFMigrationsHistory</code>
                                表，该表列出了已应用于数据库的所有迁移。你不能像之前那样使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EnsureCreated</code>
                                方法来创建数据库，因为这种方法不会将迁移信息应用到数据库中。</font>
                        </font>
                    </font>
                </p>
                <p id="c21-para-0115" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">With an existing database, the database gets updated to the
                    current version of the migration. Programmatically, you can get all the migrations available in the
                    application with the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">GetMigrations</code>
                    method. To see all applied migrations, you can use the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">GetAppliedMigrations</code>
                    method. For all migrations that are missing in the database, use the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">GetPendingMigrations</code>
                    method.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在已有数据库的情况下，数据库会更新到迁移的当前版本。程序上，你可以用
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">GetMigrations</code>
                                方法获取应用程序中所有可用的迁移。要查看所有已应用的迁移，可以使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">GetAppliedMigrations</code>
                                方法。对于数据库中缺失的所有迁移，使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">GetPendingMigrations</code>
                                方法。</font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0045"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-409" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Other Ways to Apply Migrations <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">应用迁移的其他方法</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Instead of applying migrations programmatically, you can
                    apply migrations using the command line:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">除了程序化应用迁移，你也可以使用命令行来应用迁移：</font>
                        </font>
                    </font>
                </p>
                <pre
                    id="c21-code-0047"><code>&gt; dotnet ef database update --startup-project ../MigrationsConsoleApp</code></pre>
                <p id="c21-para-0117" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">This command applies the latest migration to the database.
                    You can also supply the name of the migration to this command to put the database into a specific
                    version of the migration.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                此命令将最新迁移应用到数据库。你也可以向此命令提供迁移的名称，以将数据库置于特定版本的迁移。</font>
                        </font>
                    </font>
                </p>
                <p id="c21-para-0118" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">If you have a database administrator who needs to keep full
                    control over the database and doesn't allow programmatic changes or changes from a tool such as the
                    .NET Core CLI command line, you can create an SQL script and hand this over (or use it by yourself).
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                如果你有一个需要完全控制数据库的数据库管理员，不允许程序化更改或通过.NET Core CLI 命令行等工具进行更改，你可以创建一个 SQL 脚本并交给他（或自己使用）。
                            </font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The following command line creates the SQL script <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">migrationsscript.sql</code>
                    from the initial database creation up to the latest migration. You can also supply specific from/to
                    values for the range of the migrations that should be applied in the script:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">以下命令行从初始数据库创建到最新的迁移创建 SQL 脚本 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">migrationsscript.sql</code>
                                。你也可以为脚本中应应用的迁移范围提供特定的 from/to 值：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0048"><code>&gt; dotnet ef migrations script --output migrationsscript.sql </code>
<code>--startup-project ..\MigrationsConsoleApp</code></pre>
            </section>
        </section>
        <section aria-labelledby="head-2-196" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
            <span id="c21-sec-0046" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
            <h2 id="head-2-196" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">WORKING WITH QUERIES<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">处理查询</font>
                    </font>
                </font>
            </h2>
            <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">Now that I've defined the model and discussed migrations and
                scaffolding, let's examine queries in more detail. This section covers the following:<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            现在我已经定义了模型并讨论了迁移和脚手架，让我们更详细地研究查询。本节涵盖以下内容：</font>
                    </font>
                </font>
            </p>
            <ul class="check" id="c21-list-0005" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                <li id="c21-li-0029" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Basic queriesAsynchronous streams<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">基础查询异步流</font>
                        </font>
                    </font>
                </li>
                <li id="c21-li-0030" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Raw SQL queries<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">原生 SQL 查询</font>
                        </font>
                    </font>
                </li>
                <li id="c21-li-0031" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Compiled queries for better performance<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">编译查询以提升性能</font>
                        </font>
                    </font>
                </li>
                <li id="c21-li-0032" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Global query filters<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">全局查询过滤器</font>
                        </font>
                    </font>
                </li>
                <li id="c21-li-0033" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EF.Functions</code>
                </li>
            </ul>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0047"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-410" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Basic Queries <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">基本查询</font>
                        </font>
                    </font>
                </h3>
                <p id="c21-para-0121" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">You've already seen that accessing a context property of
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbSet</code> returns a
                    list of all entities of the specified table. Let's look at some more queries and the outcome with
                    SQL sent to the server.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">你已经看到，访问 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbSet</code>
                                的上下文属性会返回指定表的所有实体列表。让我们看看更多查询以及发送到服务器的 SQL 语句的结果。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Accessing the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Books</code> property
                    retrieves all the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code> records from
                    the database (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksSample/QuerySamples.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">访问 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Books</code>
                                属性会从数据库检索所有 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code>
                                记录（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksSample/QuerySamples.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0049"><code>private async Task QueryAllBooksAsync()</code>
<code>{</code>
<code>  Console.WriteLine(nameof(QueryAllBooksAsync));<span aria-label="607" epub:type="pagebreak" id="Page_607" role="doc-pagebreak"></span></code>
<code>  using (var context = new BooksContext())</code>
<code>  {</code>
<code>    <b>List&lt;Book&gt; books = await context.Books.ToListAsync();</b></code>
<code>    foreach (var b in books)</code>
<code>    {</code>
<code>      Console.WriteLine(b);</code>
<code>    }</code>
<code>  }</code>
<code>  Console.WriteLine();</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">You can query for an object with a specific key with the
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">FindAsync</code>
                    method. If the record is not found, this method returns <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">null</code> (code file
                    <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Queries/Runner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">你可以使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">FindAsync</code>
                                方法查询具有特定键的对象。如果记录未找到，此方法将返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">null</code>
                                （代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Queries/Runner.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0050"><code>public async Task FindByKeyAsync(int id)</code>
<code>{</code>
<code>  Console.WriteLine(nameof(FindByKeyAsync));</code>
<code>  MenuItem? menuItem = await _menusContext.MenuItems.FindAsync(id);</code>
<code>  Console.WriteLine(menuItem);</code>
<code>  Console.WriteLine();</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">This results in a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SELECT</code> SQL
                    statement with <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">TOP(1)</code> and a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">WHERE</code> clause:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">这会导致一个带有 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SELECT</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">TOP(1)</code>
                                子句的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">WHERE</code>
                                SQL 语句：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0051"><code>SELECT TOP(1) [m].[MenuItemId], [m].[IsDeleted], [m].[LastUpdated], [m].[MenuCardId], </code>
<code>              [m].[Price], [m].[RestaurantId], [m].[Text]</code>
<code>FROM [mc].[MenuItems] AS [m]</code>
<code>WHERE [m].[MenuItemId] = @__p_0</code></pre>
                <p id="c21-para-0125" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Instead of using a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">FindAsync</code> method,
                    you can also use the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SingleAsync</code> or
                    <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SingleOrDefaultAsync</code>
                    method. The difference between <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SingleAsync</code> and
                    <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SingleOrDefaultAsync</code>
                    is that <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SingleAsync</code> throws
                    an exception when no records are found, whereas <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SingleOrDefaultAsync</code>
                    returns null when no records are found. These methods also throw an exception if more than one
                    record is found.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">除了使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">FindAsync</code>
                                方法，您还可以使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SingleAsync</code>
                                或 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SingleOrDefaultAsync</code>
                                方法。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SingleAsync</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SingleOrDefaultAsync</code>
                                的区别在于， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SingleAsync</code>
                                在未找到记录时抛出异常，而 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SingleOrDefaultAsync</code>
                                在未找到记录时返回 null。如果找到多条记录，这些方法也会抛出异常。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The following code snippet uses the method <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SingleOrDefaultAsync</code>
                    to ask for menu item text that should be available only once (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Queries/Runner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">以下代码片段使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SingleOrDefaultAsync</code>
                                方法来请求菜单项文本，该文本应仅出现一次（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Queries/Runner.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0052"><code>MenuItem? menuItem = await _menusContext.MenuItems</code>
<code>  .TagWith("SingleOrDefault")</code>
<code>  .SingleOrDefaultAsync(m =&gt; m.Text == text);</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The generated SQL statement asks for the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">TOP(2)</code> records,
                    which allows throwing an exception if two records are found:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">生成的 SQL 语句请求 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">TOP(2)</code>
                                记录，这允许在找到两条记录时抛出异常：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0053"><code>SELECT TOP(2) [m].[MenuItemId], [m].[IsDeleted], [m].[LastUpdated], [m].[MenuCardId], </code>
<code>  [m].[Price], [m].[RestaurantId], [m].[Text]</code>
<code>FROM [mc].[MenuItems] AS [m]</code>
<code>WHERE [m].[Text] = @__title_0</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">FirstOrDefaultAsync</code>
                    method doesn't throw an exception if multiple records fulfill the condition. In any case, only the
                    first result is taken, or null is returned if no records are found (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Queries/Runner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">FirstOrDefaultAsync</code>
                                方法在多个记录满足条件时不会抛出异常。在任何情况下，仅取第一个结果，或者如果没有找到记录则返回 null（代码文件 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Queries/Runner.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0054"><code>MenuItem? menuItem = await _menusContext.MenuItems</code>
<code>  .TagWith("FirstOrDefault")</code>
<code>  .FirstOrDefaultAsync(m =&gt; m.Text == title);</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1"><span aria-label="608" epub:type="pagebreak" id="Page_608"
                        role="doc-pagebreak"
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>With <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">FirstOrDefaultAsync</code>,
                    you use a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SELECT TOP(1)</code>
                    :<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">FirstOrDefaultAsync</code>
                                时，你使用一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SELECT TOP(1)</code>
                                ：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0055"><code>SELECT TOP(1) [m].[MenuItemId], [m].[IsDeleted], [m].[LastUpdated], [m].[MenuCardId], </code>
<code>  [m].[Price], [m].[RestaurantId], [m].[Text]</code>
<code>FROM [mc].[MenuItems] AS [m]</code>
<code>WHERE [m].[Text] = @__title_0</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Where</code> method
                    returns all objects fulfilling the condition. It allows for simple filtering based on a condition.
                    You can also use the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Contains</code> or <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">StartsWith</code> method
                    within the <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Where</code>
                    expression (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Queries/Runner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Where</code>
                                方法返回所有满足条件的对象。它允许基于条件进行简单过滤。你也可以在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Where</code>
                                表达式中使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Contains</code>
                                或 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">StartsWith</code>
                                方法（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Queries/Runner.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0056"><code>var menuItems = await _menusContext.MenuItems</code>
<code>  .Where(m =&gt; m.Text.Contains("menu"))</code>
<code>  .TagWith("Where")</code>
<code>  .ToListAsync();</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The resulting SQL statement makes use of a simple <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">WHERE</code> in the SQL
                    clause using a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LIKE</code> for the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Contains</code> method:
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">生成的 SQL 语句在 SQL 子句中使用简单的 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">WHERE</code>
                                ，并使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LIKE</code>
                                作为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Contains</code>
                                方法的参数：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0057"><code>SELECT [m].[MenuItemId], [m].[IsDeleted], [m].[LastUpdated], [m].[MenuCardId], </code>
<code>  [m].[Price], [m].[RestaurantId], [m].[Text]</code>
<code>FROM [mc].[MenuItems] AS [m]</code>
<code>WHERE [m].[Text] LIKE N'%menu%'</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Using the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Skip</code> and <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Take</code> methods, you
                    can implement paging functionality to skip some records and to take only a specific number of
                    records. By invoking this multiple times, you can retrieve page by page (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Queries/Runner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Skip</code> 和
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Take</code>
                                方法，你可以实现分页功能，跳过一些记录并只获取特定数量的记录。通过多次调用，你可以逐页检索（代码文件 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Queries/Runner.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0058"><code>var menuItems = await _menusContext.MenuItems</code>
<code>  .OrderBy(m =&gt; m.MenuItemId)</code>
<code>  .Skip(skip)</code>
<code>  .Take(take)</code>
<code>  .TagWith("SkipAndTake")</code>
<code>  .ToListAsync();</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The following SQL code shows how this translates to the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ORDER BY</code> and <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OFFSET</code>
                    /
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">FETCH</code> clause:
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">以下 SQL 代码展示了这如何转换为 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ORDER BY</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OFFSET</code>
                                / <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">FETCH</code>
                                子句：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0059"><code>SELECT [m].[MenuItemId], [m].[IsDeleted], [m].[LastUpdated], [m].[MenuCardId], </code>
<code>  [m].[Price], [m].[RestaurantId], [m].[Text]</code>
<code>FROM [mc].[MenuItems] AS [m]</code>
<code>ORDER BY [m].[MenuItemId]</code>
<code>OFFSET @__p_0 ROWS FETCH NEXT @__p_1 ROWS ONLY</code></pre>
                <aside data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <div class="top hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <p id="c21-para-0135" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NOTE</b> <i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">In <a
                                    href="c09.xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Chapter
                                    9</a>, you can read about many more LINQ methods and LINQ clauses, which you can
                                also use with EF Core. Just bear in mind that the implementation is different between
                                LINQ to objects and LINQ to EF Core. With LINQ to EF Core, expression trees are used
                                that allow creating an SQL query with the complete LINQ expression at runtime. With LINQ
                                to objects, most of the LINQ queries are defined in the </i> <code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Enumerable</code>
                            <i data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"> class. LINQ with
                                expression trees is implemented in the </i> <code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Queryable</code>
                            <i data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"> class, and many
                                enhancements for EF Core, such as the </i> <code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Async</code> <i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"> variants, are
                                implemented in the </i> <code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EntityFrameworkQueryableExtensions</code>
                            <i data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"> class. For more
                                information about the expression tree, read <a href="c09.xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Chapter
                                    9</a>.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意 在第 9 章，你可以阅读更多关于 LINQ
                                        方法和 LINQ 子句的内容，你也可以用它们与 EF Core 一起使用。只需记住，LINQ to objects 和 LINQ to EF Core
                                        之间的实现是不同的。使用 LINQ to EF Core 时，使用表达式树，这允许在运行时用完整的 LINQ 表达式创建 SQL 查询。使用 LINQ to
                                        objects 时，大多数 LINQ 查询都在 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Enumerable</code>
                                        类中定义。带有表达式树的 LINQ 在 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Queryable</code>
                                        类中实现，许多针对 EF Core 的增强功能，如 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Async</code>
                                        变体，在 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EntityFrameworkQueryableExtensions</code>
                                        类中实现。有关表达式树的更多信息，请阅读第 9 章。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                            <hr />
                        </div>
                    </section>
                </aside>
            </section> <span aria-label="609" epub:type="pagebreak" id="Page_609" role="doc-pagebreak"
                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0049"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-411" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Asynchronous Streams <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">异步流</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">EF Core also supports asynchronous streams. The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbSet</code> method <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">AsAsyncEnumerable</code>
                    returns <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IAsyncEnumerable</code>,
                    which allows using <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">await foreach</code> to
                    iterate through the result (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Queries/Runner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">EF Core 也支持异步流。方法 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">AsAsyncEnumerable</code>
                                返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IAsyncEnumerable</code>
                                ，允许使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">await foreach</code>
                                遍历结果（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Queries/Runner.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0060"><code>public async Task GetAllMenusUsingAsyncStream()</code>
<code>{</code>
<code>  IAsyncEnumerable&lt;MenuItem&gt; menuItems = _menusContext.MenuItems.<b>AsAsyncEnumerable();</b></code>
<code>  await foreach (var menuItem in menuItems)</code>
<code>  {</code>
<code>    Console.WriteLine(menuItem);</code>
<code>  }</code>
<code>}</code></pre>
                <p id="c21-para-0137" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">While this just sends one SQL statement to the database
                    server, not all objects are immediately materialized and tracked from the context. The caller using
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IAsyncEnumerable</code>
                    defines how the objects are materialized using <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">await foreach</code>.
                    Depending on the result size and the size of the objects, this can return faster results and
                    requires memory just as the objects are materialized.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">虽然这仅向数据库服务器发送一条 SQL
                                语句，但并非所有对象都能立即从上下文中被实例化和跟踪。使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IAsyncEnumerable</code>
                                的调用者通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">await foreach</code>
                                定义对象的实例化方式。根据结果大小和对象的大小，这可以更快地返回结果，并且仅在对象实例化时需要内存。</font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0050"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-412" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Raw SQL Queries<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">原始 SQL 查询</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">EF Core also enables you to define raw SQL queries, which in
                    turn return entity objects and track these objects. You just need to invoke the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">FromSqlInterpolated</code>
                    method of the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbSet</code> object, as
                    shown in the following code snippet (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Queries/Runner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">EF Core 还允许你定义原始 SQL
                                查询，这些查询会返回实体对象并跟踪这些对象。你只需要调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbSet</code>
                                对象的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">FromSqlInterpolated</code>
                                方法，如下面的代码片段所示（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Queries/Runner.cs</code>
                                ）。</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0061"><code>var menuItems = await _menusContext.MenuItems</code>
<code>  .FromSqlInterpolated(</code>
<code>    $"SELECT * FROM MenuItems WHERE LIKE '{term}%'")</code>
<code>  .TagWith("RawSQL")</code>
<code>  .ToListAsync();</code></pre>
                <p id="c21-para-0139" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The SQL query assigned to the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">RawSql</code> method
                    needs to return entity types that are part of the model, and data for all the properties of the
                    model need to be returned.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">分配给 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">RawSql</code>
                                方法的 SQL 查询需要返回模型中的实体类型，并且需要返回模型所有属性的数据。</font>
                        </font>
                    </font>
                </p>
                <p id="c21-para-0140" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The SQL string assigned to the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">FromSqlInterpolated</code>
                    method might look like SQL injection can happen as the string is defined. However, because of the
                    argument type <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">FormattableString</code>,
                    the expressions assigned within the string are used to create parameters for the SQL statement. Read
                    <a href="c02.xhtml" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Chapter
                        2</a>, “Core C#,” for more information on <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">FormattableString</code>.
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">分配给 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">FromSqlInterpolated</code>
                                方法的 SQL 字符串可能看起来像会发生 SQL 注入，因为字符串是定义的。然而，由于参数类型 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">FormattableString</code>
                                ，字符串中分配的表达式用于为 SQL 语句创建参数。有关 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">FormattableString</code>
                                的更多信息，请阅读第 2 章，“核心 C#”。</font>
                        </font>
                    </font>
                </p>
                <p id="c21-para-0141" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The method <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">FromSqlInterpolated</code>
                    throws an exception if you pass a normal string. To pass a normal string, you can use <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">FromSqlRaw</code>. This
                    method supports named parameters with the SQL statement. You can pass parameters of type <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SqlParameter</code> to a
                    params array. Don't use string concatenation to create the SQL statement.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">如果传递普通字符串， <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">FromSqlInterpolated</code>
                                方法会抛出异常。要传递普通字符串，可以使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">FromSqlRaw</code>
                                。此方法支持 SQL 语句中的命名参数。您可以将类型为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SqlParameter</code>
                                的参数传递给 params 数组。不要使用字符串连接来创建 SQL 语句。</font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0051"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-413" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Compiled Queries <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">编译查询</font>
                        </font>
                    </font>
                </h3>
                <p id="c21-para-0142" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">For queries that need to be done multiple times or when you
                    need to start them faster as they are needed, you can prepare the compilation process for a query
                    using a compiled query with the method <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EF.CompileQuery</code>.
                    This method offers different generic overloads where you can pass a different number of arguments.
                    The first generic parameter of this method specifies a class deriving from <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>. The
                    query is compiled independent of the context, and you can pass different <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                    instances with every invocation of the precompiled query. With the other generic parameters, you can
                    define the parameters and the return type you need with the query.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">对于需要多次执行或需要根据需求更快启动的查询，您可以使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EF.CompileQuery</code>
                                方法通过编译查询来准备编译过程。此方法提供不同的泛型重载，您可以在其中传递不同数量的参数。此方法的第一个泛型参数指定一个继承自 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                                的类。查询的编译独立于上下文，您可以在每次预编译查询的调用时传递不同的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                                实例。使用其他泛型参数，您可以定义查询所需的参数和返回类型。</font>
                        </font>
                    </font>
                </p>
                <p id="c21-para-0143" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1"><span aria-label="610" epub:type="pagebreak" id="Page_610"
                        role="doc-pagebreak"
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>With the following
                    code snippet, an extension method extends the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenusContext</code> class
                    and creates a compiled query passing a string parameter and returning a list of <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code> objects.
                    The compilation is taking place with the first invocation.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">通过以下代码片段，一个扩展方法扩展了 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenusContext</code>
                                类，并创建了一个编译查询，传递一个字符串参数并返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                对象的列表。编译在第一次调用时进行。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The first parameter that's needed when creating a compiled
                    query is a class deriving from <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                    ; with the following sample code it's the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenusContext</code>. The
                    extension method <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenusByText</code>
                    extends the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenusContext</code>
                    ; thus, this parameter is used as the first argument for the compiled query (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Queries/CompiledQueryExtensions.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">创建编译查询时需要的第一个参数是一个继承自 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                                的类；在以下示例代码中，它是 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenusContext</code>
                                。扩展方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenusByText</code>
                                扩展了 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenusContext</code>
                                ；因此，此参数用作编译查询的第一个参数（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Queries/CompiledQueryExtensions.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0062"><code>using Microsoft.EntityFrameworkCore;</code>
<code>using System;</code>
<code>using System.Collections.Generic;</code>
<code>using System.Linq;</code>
<code> </code>
<code>static class CompiledQueryExtensions</code>
<code>{</code>
<code>  private static Func&lt;MenusContext, string, IEnumerable&lt;MenuItem&gt;&gt;? s_menuItemsByText;</code>
<code> </code>
<code>  private static Func&lt;MenusContext, string, IEnumerable&lt;MenuItem&gt;&gt; </code>
<code>    CompileMenusByTextQuery() </code>
<code>      =&gt; <b>EF.CompileQuery((MenusContext context, string text)</b></code>
<code>        <b>=&gt; context.MenuItems.Where(m =&gt; m.Text == text));</b></code>
<code> </code>
<code>  public static IEnumerable&lt;MenuItem&gt; MenuItemsByText(this MenusContext menusContext, </code>
<code>    string text)</code>
<code>  {</code>
<code>    if (s_menuItemsByText is null)</code>
<code>    {</code>
<code>       s_menuItemsByText = CompileMenusByTextQuery();</code>
<code>    }</code>
<code>    return s_menuItemsByText(menusContext, text);</code>
<code>  }</code>
<code>  //…</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The extension method is used with the following code snippet
                    to invoke <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenusByText</code> using
                    a <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">_menusContext</code>
                    (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Queries/Runner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">扩展方法与以下代码片段一起使用，以使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">_menusContext</code>
                                （代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Queries/Runner.cs</code>
                                ）调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenusByText</code>
                                ：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0063"><code>var menuItems = _menusContext.MenusByText("menu 26");</code>
<code>foreach (var menuItem in menuItems)</code>
<code>{</code>
<code>  Console.WriteLine(menuItem);</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Compiled queries support returning an asynchronous stream by
                    using the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EF.CompileAsyncQuery</code>
                    method. This method returns <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IAsyncEnuerable&lt;T&gt;</code>
                    (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Queries/CompiledQueryExtensions.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">编译查询支持通过使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EF.CompileAsyncQuery</code>
                                方法返回异步流。此方法返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IAsyncEnuerable&lt;T&gt;</code>
                                （代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Queries/CompiledQueryExtensions.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0064"><code>static class CompiledQueryExtensions</code>
<code>{</code>
<code>  //…</code>
<code>  private static Func&lt;MenusContext, string, IAsyncEnumerable&lt;MenuItem&gt;&gt;? </code>
<code>    s_menusByTextAsync;</code>
<code>  private static Func&lt;MenusContext, string, IAsyncEnumerable&lt;Menu&gt;&gt; </code>
<code>    CompileMenuItemsByTextAsyncQuery() <span aria-label="611" epub:type="pagebreak" id="Page_611" role="doc-pagebreak"></span></code>
<code>      =&gt; <b>EF.CompileAsyncQuery((MenusContext context, string text)</b></code>
<code>        =&gt; context.MenuItems.Where(m =&gt; m.Text == text));</code>
<code> </code>
<code>  public static IAsyncEnumerable&lt;Menu&gt; MenuItemsByTextAsync(</code>
<code>    this MenusContext menusContext, string text)</code>
<code>  {</code>
<code>    if (s_menuItemsByTextAsync is null)</code>
<code>    {</code>
<code>      s_menuItemsByTextAsync = CompileMenuItemsByTextAsyncQuery();</code>
<code>    }</code>
<code>    return s_menuItemsByTextAsync(menusContext, text);</code>
<code>  }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">This can be used with an <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">await foreach</code>
                    (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Queries/Runner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">这可以与 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">await foreach</code>
                                （代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Queries/Runner.cs</code>
                                ）一起使用：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0065"><code>await foreach (var menuItem in _menusContext.MenuItemsByTextAsync("menu 26"))</code>
<code>{</code>
<code>  Console.WriteLine(menuItem);</code>
<code>}</code></pre>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0052"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-414" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Global Query Filters <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">全局查询过滤器</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Earlier in this chapter, you saw shadow state used with the
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsDeleted</code>
                    column. Instead of specifying the WHERE clause with every query to filter out the records that have
                    the IsDeleted property set to true, you can define a global query filter when creating the model.
                    This is what the next code snippet does—globally checking for <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsDeleted</code>. Because
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsDeleted</code> is not
                    mapped to the model and is just via shadow state, the value can be retrieved using <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EF.Property</code> (code
                    file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Queries/BooksContext.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在本章之前，你看到了阴影状态与 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsDeleted</code>
                                列一起使用。你不必在每次查询中指定 WHERE 子句来过滤掉 IsDeleted 属性设置为 true
                                的记录，而是在创建模型时定义一个全局查询过滤器。下一个代码片段所做的就是这样——全局检查 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsDeleted</code>
                                。由于 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsDeleted</code>
                                没有映射到模型，只是通过阴影状态，因此可以使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EF.Property</code>
                                获取值（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Queries/BooksContext.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0066"><code>protected override void OnModelCreating(ModelBuilder modelBuilder)</code>
<code>{</code>
<code>  base.OnModelCreating(modelBuilder);</code>
<code> </code>
<code>  <b>modelBuilder.Entity&lt;Book&gt;().HasQueryFilter(</b></code>
<code>    <b>b =&gt; !EF.Property&lt;bool&gt;(b, IsDeleted));</b></code>
<code>  //…</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">With this query filter defined, the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">WHERE</code> check for
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsDeleted</code> is
                    added to every query used with this context.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">定义了此查询过滤器后，对于与此上下文一起使用的每个查询都会添加
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">WHERE</code>
                                检查 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsDeleted</code>
                                。</font>
                        </font>
                    </font>
                </p>
                <aside data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <div class="top hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <p id="c21-para-0150" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NOTE</b> <i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Global query
                                filters are also of practical use with multitenancy requirements. You can filter all
                                queries for a context for a specific tenant ID. You just need to pass the tenant ID when
                                constructing the context. With dependency injection, you need to specify a service that
                                is injected with the constructor where the tenant ID can be retrieved in the query
                                filter.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">
                                        注意：全局查询过滤器在多租户需求中也很有用。你可以为特定租户 ID 过滤上下文的所有查询。你只需要在构建上下文时传递租户
                                        ID。使用依赖注入时，需要在构造函数中指定一个服务，该服务可以在查询过滤器中获取租户 ID。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                            <hr />
                        </div>
                    </section>
                </aside>
                <aside data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <div class="top hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <p id="c21-para-0151" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NOTE</b> <i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Usually, the
                                global query filter should be applied. With queries where you don't want the global
                                query filter active, apply the method</i> <code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IgnoreQueryFilters</code>
                            <i data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">with the
                                query.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">
                                        注意：通常应应用全局查询过滤器。对于不希望全局查询过滤器激活的查询，请在查询中使用 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IgnoreQueryFilters</code>
                                        方法。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                            <hr />
                        </div>
                    </section>
                </aside>
            </section> <span aria-label="612" epub:type="pagebreak" id="Page_612" role="doc-pagebreak"
                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0055"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-415" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">EF.Functions</h3>
                <p id="c21-para-0152" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">EF Core allows custom extension methods that can be
                    implemented by providers. For this, the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EF</code> class defines
                    the <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Functions</code>
                    property of type <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbFunctions</code> that
                    can be extended using extension methods. The SQL Server provider offers methods for date
                    calculations (for example <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DateDiffDay</code>, <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DateDiffHour</code>,
                    <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DateDiffMicrosecond</code>,
                    <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DateDiffMillisecond</code>,
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DateFromParts</code>,
                    and others).<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">EF Core 允许自定义扩展方法，这些方法可以由提供者实现。为此，
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EF</code>
                                类定义了类型为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbFunctions</code>
                                的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Functions</code>
                                属性，该属性可以使用扩展方法进行扩展。SQL Server 提供者提供了日期计算的方法（例如 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DateDiffDay</code>
                                、 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DateDiffHour</code>
                                、 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DateDiffMicrosecond</code>
                                、 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DateDiffMillisecond</code>
                                、 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DateFromParts</code>
                                及其他）。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Like</code> method is
                    part of EF Core for relational database providers. The following code snippet enhances the query of
                    the <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Where</code> method
                    by using <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EF.Functions.Like</code>
                    and supplying an expression that contains the parameter <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">textSegment</code>. The
                    parameter <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">textSegment</code> is
                    embedded within two <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">%</code> characters (code
                    file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Queries/Runner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Like</code>
                                方法是 EF Core 中关系数据库提供者的一部分。以下代码片段通过使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EF.Functions.Like</code>
                                增强了 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Where</code>
                                方法的查询，并提供了包含参数 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">textSegment</code>
                                的表达式。参数 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">textSegment</code>
                                被嵌入在两个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">%</code>
                                字符（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Queries/Runner.cs</code>
                                ）中：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0067"><code>public async Task UseEFCunctions(string textSegment)</code>
<code>{</code>
<code>  Console.WriteLine(nameof(UseEFCunctions));</code>
<code>  string likeExpression = $"%{textSegment}%";</code>
<code> </code>
<code>  var menuItems = await _menusContext.MenuItems</code>
<code>    .Where(m =&gt; EF.Functions.Like(m.Text, likeExpression))</code>
<code>    .ToListAsync();</code>
<code>  foreach (var menuItem in menuItems)</code>
<code>  {</code>
<code>    Console.WriteLine(menuItem);</code>
<code>  }</code>
<code>  Console.WriteLine();</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">When you run the application, the method <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Where</code> that
                    contains <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EF.Functions.Like</code>
                    is translated to the SQL clause <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">WHERE</code> with <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LIKE</code>
                    :<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">当您运行应用程序时，包含 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EF.Functions.Like</code>
                                的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Where</code>
                                方法被转换为使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LIKE</code> 的
                                SQL 子句 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">WHERE</code>
                                ：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0068"><code>SELECT [m].[MenuItemId], [m].[IsDeleted], [m].[LastUpdated], [m].[MenuCardId], </code>
<code>  [m].[Price], [m].[RestaurantId], [m].[Text]</code>
<code>FROM [mc].[MenuItems] AS [m]</code>
<code><b>WHERE [m].[Text] LIKE @__likeExpression_1</b></code></pre>
            </section>
        </section>
        <section aria-labelledby="head-2-197" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
            <span id="c21-sec-0056" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
            <h2 id="head-2-197" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">LOADING RELATED DATA<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">加载关联数据</font>
                    </font>
                </font>
            </h2>
            <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">If a relation is configured to be required in the database, this
                does not necessarily mean it's required in the object model, and to fill related data, you need to be
                aware of this when loading relations. The available options are as follows:<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            如果一个关系在数据库中被配置为必需的，这并不一定意味着它在对象模型中也是必需的，并且在加载关系时你需要意识到这一点以填充相关数据。可用的选项如下：</font>
                    </font>
                </font>
            </p>
            <ul class="check" id="c21-list-0006" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                <li id="c21-li-0034" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Eager loading<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">急加载</font>
                        </font>
                    </font>
                </li>
                <li id="c21-li-0035" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Explicit loading<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">显式加载</font>
                        </font>
                    </font>
                </li>
                <li id="c21-li-0036" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Lazy loading<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">懒加载</font>
                        </font>
                    </font>
                </li>
            </ul>
            <p id="c21-para-0156" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">The sample application implements the data classes <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code>, <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Chapter</code>, <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Person</code>, and <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Address</code>. A <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code> contains a <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Chapters</code> property that
                contains a list of <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Chapter</code>
                s and an <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Author</code>
                property of type <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Person</code>. The <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Author</code> class contains
                an <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Address</code> property
                that references an <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Address</code> object. With
                this sample, each of these classes uses separate tables. In a later sample in this chapter, in the
                section “Owned Entities,” you see how to make objects that share a table.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">示例应用程序实现了数据类 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code> 、
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Chapter</code> 、
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Person</code> 和
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Address</code>
                            。一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code> 包含一个
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Chapters</code>
                            属性，该属性包含一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Chapter</code>
                            列表，以及一个类型为 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Person</code> 的
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Author</code> 属性。
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Author</code>
                            类包含一个引用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Address</code>
                            对象的 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Address</code>
                            属性。通过这个示例，这些类各自使用不同的表。在本章后面的一个示例中，在“拥有的实体”部分，您将了解如何使共享一个表的实体。</font>
                    </font>
                </font>
            </p> <span aria-label="613" epub:type="pagebreak" id="Page_613" role="doc-pagebreak"
                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0057"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-416" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Eager Loading Related Data <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">立即加载相关数据</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">You can load related data immediately when a query is
                    executed by invoking the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Include</code> method and
                    specifying the relation. The following code snippet defines a query to retrieve books and uses the
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Include</code> method
                    to include the related author. The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Person</code> class used
                    with the <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Author</code>
                    property contains another reference to the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Address</code>. Here, the
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ThenInclude</code>
                    method is used to include the address as well. The list of chapters is included using the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Include</code> method
                    accessing the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Chapters</code> property
                    of the <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code> type
                    (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LoadedRelatedData/Runner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">您可以通过调用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Include</code>
                                方法并指定关系来在查询执行时立即加载相关数据。以下代码片段定义了一个检索书籍的查询，并使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Include</code>
                                方法包含相关的作者。与 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Author</code>
                                属性一起使用的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Person</code>
                                类包含对 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Address</code>
                                的另一个引用。在这里，使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ThenInclude</code>
                                方法来包含地址。章节列表使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Include</code>
                                方法包含，该方法访问 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code>
                                类型的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Chapters</code>
                                属性（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LoadedRelatedData/Runner.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0069"><code>public async Task EagerLoadingAsync()</code>
<code>{</code>
<code>  var books = await _booksContext.Books</code>
<code>    .Where(b =&gt; b.Publisher == "pub1")</code>
<code>    <b>.Include(b =&gt; b.Author)</b></code>
<code>    <b>.ThenInclude(a =&gt; a!.Address)</b></code>
<code>    <b>.Include(b =&gt; b.Chapters)</b></code>
<code>    .ToListAsync();</code>
<code>  foreach (var book in books)</code>
<code>  {</code>
<code>    Console.WriteLine($"{book.Title} {book.Author?.FirstName} " +</code>
<code>      $"{book.Author?.Address?.Country}");</code>
<code>  }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Using this query containing <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Include</code> and <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ThenInclude</code>
                    generates a single SQL statement joining the different tables:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用包含 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Include</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ThenInclude</code>
                                的查询会生成一个连接不同表的 SQL 语句：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0070"><code>SELECT [b].[BookId], [b].[AuthorId], [b].[Publisher], [b].[Title], [p].[PersonId], </code>
<code>  [p].[AddressId], [p].[FirstName], [p].[LastName], [a].[AddressId], [a].[City], </code>
<code>  [a].[Country], [c].[ChapterId], [c].[BookId], [c].[Title]</code>
<code>FROM [Books] AS [b]</code>
<code>INNER JOIN [People] AS [p] ON [b].[AuthorId] = [p].[PersonId]</code>
<code>INNER JOIN [Addresses] AS [a] ON [p].[AddressId] = [a].[AddressId]</code>
<code>LEFT JOIN [Chapters] AS [c] ON [b].[BookId] = [c].[BookId]</code>
<code>WHERE [b].[Publisher] = N'One'</code>
<code>ORDER BY [b].[BookId], [p].[PersonId], [a].[AddressId], [c].[ChapterId]</code></pre>
                <aside data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <div class="top hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <p id="c21-para-0160" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NOTE</b> <i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">With EF Core 5,
                                instead of combining several joins, you can enable split queries to create multiple
                                queries. You can configure split queries either with the SQL Server options in the DI
                                configuration to invoke the </i> <code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UseQuerySplittingBehavior</code>
                            <i data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"> method or by
                                using the </i> <code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">AsSplitQuery</code>
                            <i data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"> extension method
                                with a query. With split queries, joins are still done with one-to-one relations, but
                                with one-to-many relations instead of a join, multiple </i> <code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SELECT</code> <i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"> methods are sent
                                to the server, which can improve the performance based on the complexity of the
                                query.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意：在 EF Core 5
                                        中，您可以通过启用拆分查询来创建多个查询，而不是组合多个连接。您可以通过在 DI 配置中使用 SQL Server 选项来调用 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UseQuerySplittingBehavior</code>
                                        方法，或使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">AsSplitQuery</code>
                                        扩展方法与查询一起配置拆分查询。使用拆分查询时，连接仍然通过一对一关系进行，但在一对多关系中，会向服务器发送多个 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SELECT</code>
                                        方法，这可以根据查询的复杂性提高性能。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                            <hr />
                        </div>
                    </section>
                </aside>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0059"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-417" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Eager Loading with Filtered Include <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">带过滤的 Include 的延迟加载</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">EF Core 5 allows filtering with the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Include</code> method to
                    not load all related data. To use filtering with <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Include</code>, specify a
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Where</code> method
                    within the lambda implementation to reference a collection, as is done with the include of chapters,
                    as shown in the following code snippet (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LoadedRelatedData/Runner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">EF Core 5 允许使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Include</code>
                                方法过滤以不加载所有相关数据。要使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Include</code>
                                的过滤功能，请在 lambda 实现中指定一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Where</code>
                                方法来引用集合，就像在章节的 Include 中做的那样，如下面的代码片段所示（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LoadedRelatedData/Runner.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0071"><code>var books = await _booksContext.Books<span aria-label="614" epub:type="pagebreak" id="Page_614" role="doc-pagebreak"></span></code>
<code>  .Where(b =&gt; b.Publisher == "pub2")</code>
<code>  .Include(b =&gt; b.Author)</code>
<code>  .ThenInclude(a =&gt; a!.Address)</code>
<code>  <b>.Include(b =&gt; b.Chapters!.Where(c =&gt; c.ChapterId &gt; 5))</b> </code>
<code>  .ToListAsync();</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">When you run this code, the query is converted to an SQL
                    query with a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SELECT</code> within the
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">JOIN</code>
                    :<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">当您运行此代码时，查询被转换为在 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">JOIN</code>
                                中包含 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SELECT</code>
                                的 SQL 查询：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0072"><code>SELECT [b].[BookId], [b].[AuthorId], [b].[Publisher], [b].[Title], [p].[PersonId], </code>
<code>  [p].[AddressId], [p].[FirstName], [p].[LastName], [a].[AddressId], [a].[City], </code>
<code>  [a].[Country], [t].[ChapterId], [t].[BookId], [t].[Title]</code>
<code>FROM [Books] AS [b]</code>
<code>INNER JOIN [People] AS [p] ON [b].[AuthorId] = [p].[PersonId]</code>
<code>INNER JOIN [Addresses] AS [a] ON [p].[AddressId] = [a].[AddressId]</code>
<code>LEFT JOIN (</code>
<code>  SELECT [c].[ChapterId], [c].[BookId], [c].[Title]</code>
<code>  FROM [Chapters] AS [c]</code>
<code>  WHERE [c].[ChapterId]&gt; 5</code>
<code>) AS [t] ON [b].[BookId] = [t].[BookId]</code>
<code>WHERE [b].[Publisher] = N'One'</code>
<code>ORDER BY [b].[BookId], [p].[PersonId], [a].[AddressId], [t].[ChapterId]</code></pre>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0060"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-418" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Explicit Loading Related Data <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">显式加载关联数据</font>
                        </font>
                    </font>
                </h3>
                <p id="c21-para-0163" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Instead of defining one query where all the needed related
                    data is loaded, you can create a query to load just the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code> objects from
                    the <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Books</code> table
                    and leave all the relations empty. When needed, you make queries using <i
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">explicit loading</i> of
                    related data.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">与其定义一个查询来加载所有需要的关联数据，你可以创建一个查询仅加载
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code>
                                表中的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Books</code>
                                对象，并将所有关系保留为空。当需要时，你可以使用显式加载关联数据的查询。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Take a look at the following code snippet. The query requests
                    all books with a specific publisher. If you try to access the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Chapters</code> and <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Author</code> properties
                    of the resulting book after starting the query, the values for these properties are null (if the
                    related entities are not already loaded into the context). Relations are not loaded implicitly. EF
                    Core supports explicit loading by using <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Entry</code> methods of
                    the context that return <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EntityEntry</code>
                    objects by passing an entity. The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EntityEntry</code> class
                    defines <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Collection</code> and
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Reference</code>
                    methods that allow explicit loading of relations. With a one-to-many relationship, you can use the
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Collection</code>
                    method to specify the collection, whereas a one-to-one relation needs the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Reference</code> method
                    to specify the relation. Explicit loading then happens with the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LoadAsync</code> method
                    (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LoadingRelatedData/Runner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                请查看以下代码片段。查询请求具有特定出版商的所有书籍。如果你在开始查询后尝试访问结果书籍的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Chapters</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Author</code>
                                属性，这些属性的值将为 null（如果关联实体尚未加载到上下文中）。关系不会隐式加载。EF Core 通过上下文中的 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Entry</code>
                                方法支持显式加载，这些方法通过传递一个实体来返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EntityEntry</code>
                                对象。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EntityEntry</code>
                                类定义了 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Collection</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Reference</code>
                                方法，允许显式加载关系。对于一对多关系，你可以使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Collection</code>
                                方法来指定集合，而一对多关系需要使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Reference</code>
                                方法来指定关系。显式加载随后通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LoadAsync</code>
                                方法进行（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LoadingRelatedData/Runner.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0073"><code>public async Task ExplicitLoadingAsync()</code>
<code>{</code>
<code>  var books = await _booksContext.Books</code>
<code>    .Where(b =&gt; b.Publisher == "pub1")</code>
<code>    .ToListAsync();</code>
<code> </code>
<code>  foreach (var book in books)</code>
<code>  {</code>
<code>    Console.WriteLine(book.Title);</code>
<code>    var bookEntry = _booksContext.Entry(book);</code>
<code>    await bookEntry.Reference(b =&gt; b.Author).LoadAsync();</code>
<code>    Console.WriteLine($"{book.Author?.FirstName} {book.Author?.LastName}");</code>
<code> </code>
<code>    await _booksContext.Entry(book.Author).Reference(a =&gt; a!.Address).LoadAsync();</code>
<code>    Console.WriteLine($"{book.Author!.Address!.Country}");</code>
<code> </code>
<code>    await bookEntry.Collection(b =&gt; b.Chapters).LoadAsync();</code>
<code> <span aria-label="615" epub:type="pagebreak" id="Page_615" role="doc-pagebreak"></span></code>
<code>    foreach (var chapter in book.Chapters)</code>
<code>    {</code>
<code>      Console.WriteLine(chapter.Title);</code>
<code>    }</code>
<code>  }</code>
<code>}</code></pre>
                <p id="c21-para-0165" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NavigationEntry</code>
                    class that implements the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LoadAsync</code> method
                    also implements an <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsLoaded</code> property
                    where you can check whether the relation is already loaded. You do not need to check for a loaded
                    relation before invoking the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LoadAsync</code> method;
                    this method already uses the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsLoaded</code> property
                    to check that the request to the SQL server is not done a second time.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">实现 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LoadAsync</code>
                                方法的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NavigationEntry</code>
                                类还实现了 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsLoaded</code>
                                属性，你可以在其中检查关系是否已加载。在调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LoadAsync</code>
                                方法前无需检查加载的关系；该方法已使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsLoaded</code>
                                属性来确保不会对 SQL 服务器发起第二次请求。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">When you run the application with the query for the books,
                    the following <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SELECT</code> statement
                    is executed on SQL Server. This query only accesses the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Books</code> table:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">当运行带有关书查询的应用时，SQL Server 会执行以下
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SELECT</code>
                                语句。该查询仅访问 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Books</code>
                                表：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0074"><code>SELECT [b].[BookId], [b].[AuthorId], [b].[Publisher], [b].[Title]</code>
<code>FROM [Books] AS [b]</code>
<code>WHERE [b].[Publisher] = N'pub1'</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">With the following <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LoadAsync</code> method
                    to retrieve the author for the book, the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SELECT</code> statement
                    retrieves the chapters based on the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PersonId</code>
                    :<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用以下 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LoadAsync</code>
                                方法获取书的作者时， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SELECT</code>
                                语句基于 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PersonId</code>
                                检索章节：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0075"><code>SELECT [p].[PersonId], [p].[AddressId], [p].[FirstName], [p].[LastName]</code>
<code>FROM [People] AS [p]</code>
<code>WHERE [p].[PersonId] = @__p_0</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">After the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Person</code> object is
                    materialized, the values from the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Addresses</code> table
                    are retrieved using the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">AddressId</code>
                    :<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Person</code>
                                对象实例化后，使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">AddressId</code>
                                从 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Addresses</code>
                                表中检索值：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0076"><code>SELECT [a].[AddressId], [a].[City], [a].[Country]</code>
<code>FROM [Addresses] AS [a]</code>
<code>WHERE [a].[AddressId] = @__p_0</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">With a fourth query, chapter information is retrieved from
                    the <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Chapters</code>
                    table using the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BookId</code>
                    :<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用第四个查询，通过 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BookId</code>
                                从 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Chapters</code>
                                表中检索章节信息：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0077"><code>SELECT [c].[ChapterId], [c].[BookId], [c].[Title]</code>
<code>FROM [Chapters] AS [c]</code>
<code>WHERE [c].[BookId] = @__p_0</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Sending all these queries to the database repeats for every
                    book. Because some books are written by the same author, a query to the author and address is not
                    necessary for every book.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                将所有这些查询发送到数据库会为每一本书重复进行。由于有些书是由同一作者撰写的，因此对作者和地址的查询并非对每一本书都是必要的。</font>
                        </font>
                    </font>
                </p>
                <aside data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <div class="top hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <p id="c21-para-0171" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NOTE</b> <i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">With explicit
                                loading, you need to consider the number of requests that you make to the database
                                server. If you know in advance what data you need, consider using eager loading instead.
                                With explicit loading, the</i> <code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                            <i data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">is required. If
                                you send an object tree from an API server to the client, the client usually doesn't
                                have the</i> <code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                            <i data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">accessible and
                                can't load related data without making requests to the API server. Programming services
                                is covered in <a href="c25.xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Chapter
                                    25</a>, “Services.”</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">
                                        注意：在使用显式加载时，您需要考虑对数据库服务器发起的请求数量。如果您事先知道需要哪些数据，可以考虑使用急加载（eager
                                        loading）代替。使用显式加载时，需要 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                                        。如果您从 API 服务器向客户端发送对象树，客户端通常无法访问 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                                        ，并且无法在不向 API 服务器发起请求的情况下加载相关数据。编程服务在“第 25 章，服务”中介绍。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                            <hr />
                        </div>
                    </section>
                </aside>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0062"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-419" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Lazy Loading <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">懒加载</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Instead of using explicit loading to load related data, you
                    have an easy programming option to access properties of data objects, and the relations are loaded
                    like magic. This is easier to program than the explicit loading variant, but it still does the same
                    number of queries. There are also some additional requirements: you need to reference <span
                        aria-label="616" epub:type="pagebreak" id="Page_616" role="doc-pagebreak"
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>the NuGet package
                    <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Microsoft.EntityFrameworkCore.Proxies</code>,
                    and you need to configure proxies with the DI container. Invoke the method <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UseLazyLoadingProxies</code>
                    with the <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">options</code>
                    argument. Change the parameter to turn it on or off (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LoadingRelatedData/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                与其使用显式加载来加载相关数据，你有一个简单的编程选项来访问数据对象属性，关系就像魔法一样被加载。这种编程方式比显式加载变体更容易，但它仍然执行相同数量的查询。还有一些额外的要求：你需要引用
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Microsoft.EntityFrameworkCore.Proxies</code>
                                NuGet 包，并且需要使用依赖注入容器配置代理。使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UseLazyLoadingProxies</code>
                                方法并传入 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">options</code>
                                参数。更改参数来开启或关闭（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LoadingRelatedData/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0078"><code>using var host = Host.CreateDefaultBuilder(args)</code>
<code>  .ConfigureServices((context, services) =&gt;</code>
<code>  {</code>
<code>    var connectionString = context.Configuration.GetConnectionString("BooksConnection");</code>
<code>    services.AddDbContext&lt;BooksContext&gt;(options =&gt;</code>
<code>    {</code>
<code>      <b>options.UseLazyLoadingProxies(true);</b></code>
<code>      options.UseSqlServer(connectionString);</code>
<code>    });</code>
<code>    services.AddScoped&lt;Runner&gt;();</code>
<code>  })</code>
<code>  .Build();</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">With lazy loading, there are some requirements for the entity
                    types. The entity types cannot be <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">sealed</code>, and all
                    the properties used for relations need to be declared <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">virtual</code>. The proxy
                    creates a class that derives from your entity classes and overrides the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">virtual</code> methods.
                    With the implementation of the overridden methods, the same functionality you've seen with explicit
                    loading is used; you just don't have to do this yourself (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LoadingRelatedData/Book.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用懒加载，实体类型有一些要求。实体类型不能是 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">sealed</code>
                                ，并且所有用于关系的属性都需要声明为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">virtual</code>
                                。代理会创建一个从你的实体类派生的类，并重写 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">virtual</code>
                                方法。通过重写方法的实现，使用的是与显式加载相同的功能；你只需要自己不这样做（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LoadingRelatedData/Book.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0079"><code>public class Book</code>
<code>{</code>
<code>  public Book(string title, string? publisher = default, int bookId = default)</code>
<code>  {</code>
<code>    Title = title;</code>
<code>    Publisher = publisher;</code>
<code>    BookId = bookId;</code>
<code>  }</code>
<code>  [StringLength(50)]</code>
<code>  public string Title { get; set; }</code>
<code>  [StringLength(30)]</code>
<code>  public string? Publisher { get; set; }</code>
<code>  public int BookId { get; set; }</code>
<code> </code>
<code>  // set accessor required for lazy loading</code>
<code>  <b>public virtual ICollection&lt;Chapter&gt; Chapters { get; protected set; }</b> </code>
<code>    <b>= new HashSet&lt;Chapter&gt;();</b></code>
<code> </code>
<code>  public int AuthorId { get; set; }</code>
<code>  [ForeignKey(nameof(AuthorId))]</code>
<code>  <b>public virtual Person? Author { get; set; }</b></code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Making the queries is now a lot easier. In the following
                    sample code, only a query to the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Books</code> table is
                    done—without eager or explicit loading definitions—and then the properties <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Chapters</code> and <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Author</code> are used.
                    When the properties are accessed for the first time, more queries to the database server are made to
                    fill these properties (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LoadingRelatedData/Runner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">现在查询变得容易多了。在以下示例代码中，仅对 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Books</code>
                                表进行了查询——没有使用急加载或显式加载定义——然后使用了属性 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Chapters</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Author</code>
                                。当首次访问这些属性时，会向数据库服务器发起更多查询来填充这些属性（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LoadingRelatedData/Runner.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0080"><code>public async Task LazyLoadingAsync()</code>
<code>{</code>
<code>  Console.WriteLine(nameof(LazyLoadingAsync));</code>
<code>  var books = await _booksContext.Books<span aria-label="617" epub:type="pagebreak" id="Page_617" role="doc-pagebreak"></span></code>
<code>    .Where(b =&gt; b.Publisher == "pub1")</code>
<code>    .ToListAsync();</code>
<code> </code>
<code>  foreach (var book in books)</code>
<code>  {</code>
<code>    Console.WriteLine(book.Title);</code>
<code>    Console.WriteLine($"{book.Author?.FirstName} {book.Author?.LastName}");</code>
<code> </code>
<code>    Console.WriteLine($"{book.Author!.Address!.Country}");</code>
<code>    foreach (var chapter in book.Chapters)</code>
<code>    {</code>
<code>      Console.WriteLine(chapter.Title);</code>
<code>    }</code>
<code>  }</code>
<code>  Console.WriteLine();</code>
<code>}</code></pre>
                <aside data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <div class="top hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <p id="c21-para-0176" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NOTE</b> <i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">While lazy
                                loading seems to be the simplest option, queries are handled by accessing simple
                                properties, which can take time. Also, the </i> <code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                            <i data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"> needs to be
                                available. Without this, the properties stay empty.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意
                                        虽然懒加载看似是最简单的选项，但查询是通过访问简单属性来处理的，这可能会耗费时间。此外， <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                                        必须可用。如果没有这个，属性将保持为空。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                            <hr />
                        </div>
                    </section>
                </aside>
            </section>
        </section>
        <section aria-labelledby="head-2-198" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
            <span id="c21-sec-0064" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
            <h2 id="head-2-198" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">WORKING WITH RELATIONSHIPS<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">处理关系</font>
                    </font>
                </font>
            </h2>
            <p id="c21-para-0177" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">With the samples so far, you've seen one-to-one and one-to-many
                relations. With EF Core 5.0 you can also specify many-to-many relations. This section also covers table
                splitting, owned entities, and table per hierarchy.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">到目前为止的示例中，你已经看到了一对一和多对一的关系。在 EF Core
                            5.0 中，你也可以指定多对多关系。本节还涵盖了表拆分、所属实体和按层次表。</font>
                    </font>
                </font>
            </p>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0065"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-420" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Many-to-Many Relations <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">多对多关系</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">A new feature of EF Core 5.0 is the support of many-to-many
                    relations. In the following code snippet, the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code> class defines
                    the <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Authors</code>
                    property of type <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ICollection&lt;Person&gt;</code>.
                    A book can be written by many authors (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relationships/Book.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">EF Core 5.0
                                的一项新功能是支持多对多关系。在以下代码片段中， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code>
                                类定义了 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Authors</code>
                                属性，类型为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ICollection&lt;Person&gt;</code>
                                。一本书可以由多位作者编写（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relationships/Book.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0081"><code>public class Book</code>
<code>{</code>
<code>  public Book(string title, string? publisher = default, int bookId = default)</code>
<code>  {</code>
<code>    Title = title;</code>
<code>    Publisher = publisher;</code>
<code>    BookId = bookId;</code>
<code>  }</code>
<code>  [StringLength(50)]</code>
<code>  public string Title { get; set; }</code>
<code>  [StringLength(30)]</code>
<code>  public string? Publisher { get; set; }</code>
<code>  public int BookId { get; set; }</code>
<code>  public DateTime? ReleaseDate { get; set; }</code>
<code> </code>
<code>  <b>public ICollection&lt;Person&gt; Authors = new HashSet&lt;Person&gt;();</b></code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1"><span aria-label="618" epub:type="pagebreak" id="Page_618"
                        role="doc-pagebreak"
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>On the other side
                    of the relation, with the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Person</code> class, the
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">WrittenBooks</code>
                    property defines a collection of <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code> objects (code
                    file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relationships/Person.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在关系的另一端，对于 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Person</code>
                                类， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">WrittenBooks</code>
                                属性定义了一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code>
                                对象的集合（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relationships/Person.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0082"><code>public class Person</code>
<code>{</code>
<code>  public Person(string firstName, string lastName, int personId = 0)</code>
<code>  {</code>
<code>    FirstName = firstName;</code>
<code>    LastName = lastName;</code>
<code>    PersonId = personId;</code>
<code>  }</code>
<code> </code>
<code>  public int PersonId { get; private set; }</code>
<code> </code>
<code>  public string FirstName { get; set; }</code>
<code>  public string LastName { get; set; }</code>
<code> </code>
<code>  <b>public ICollection&lt;Book&gt; WrittenBooks = new HashSet&lt;Book&gt;();</b></code>
<code> </code>
<code>  //…</code>
<code>}</code></pre>
                <p id="c21-para-0180" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">If you write the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">WrittenBooks</code> and
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Authors</code>
                    properties with a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">get</code> and <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">set</code> accessor (the
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">set</code> accessor
                    doesn't need to be <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">public</code>), the
                    relation is defined by conventions. Without the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">set</code> accessor,
                    Fluent API is needed to specify the relation. To seed the relation with data, the Fluent API is
                    needed in any case. In the database, a many-to-many relation requires a joining or bridging table
                    that contains the keys from both of the related tables. Before version 5, EF Core didn't support
                    many-to-many relations directly, and you had to define two one-to-many relations using another class
                    to map to the joining table. Now, a mapping type is automatically created in between. This mapping
                    type uses a property-bag entity type, which uses the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Dictionary&lt;string, object&gt;</code>
                    type definition to map the keys.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">如果你使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">get</code> 和
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">set</code>
                                访问器编写 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">WrittenBooks</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Authors</code>
                                属性（ <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">set</code>
                                访问器不需要是 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">public</code>
                                ），关系由约定定义。如果没有 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">set</code>
                                访问器，则需要使用 Fluent API 来指定关系。无论哪种情况，都需要使用 Fluent API
                                来用数据初始化关系。在数据库中，多对多关系需要一个连接或桥接表，该表包含两个相关表的主键。在 5 之前，EF Core
                                不直接支持多对多关系，并且你需要使用另一个类来映射到连接表，从而定义两个一对多关系。现在，映射类型会自动创建。这个映射类型使用属性包实体类型，它使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Dictionary&lt;string, object&gt;</code>
                                类型定义来映射键。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">With the following code snippet, the mapping between the
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">WrittenBooks</code>
                    property in the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Person</code> class and
                    the <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Authors</code>
                    property in the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code> class is
                    defined using <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">HasMany</code> and <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">WithMany</code>. To fill
                    the automatically used property-bag entity type with data, you use the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UsingEntity</code>
                    method. <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UsingEntity</code> can be
                    used to rename the column and table names and to specify a custom class instead of using a property
                    bag. With the code sample, data returned from the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">GetBooksAuthors</code> is
                    used to fill the table with initial data (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relationships/BooksContext.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">通过以下代码片段，使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">HasMany</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">WithMany</code>
                                定义了 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Person</code>
                                类中的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">WrittenBooks</code>
                                属性与 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code>
                                类中的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Authors</code>
                                属性之间的映射。为了用数据填充自动使用的属性包实体类型，您使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UsingEntity</code>
                                方法。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UsingEntity</code>
                                可用于重命名列和表名，以及指定自定义类而不是使用属性包。通过代码示例，从 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">GetBooksAuthors</code>
                                返回的数据用于用初始数据填充表格（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relationships/BooksContext.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0083"><code>public class BooksContext : DbContext</code>
<code>{</code>
<code>  public BooksContext(DbContextOptions&lt;BooksContext&gt; options)</code>
<code>    : base(options) { }</code>
<code> </code>
<code>  protected override void OnModelCreating(ModelBuilder modelBuilder)</code>
<code>  {</code>
<code>    modelBuilder.HasDefaultSchema("books");</code>
<code> </code>
<code>    modelBuilder.ApplyConfiguration&lt;Person&gt;(new PersonConfiguration());</code>
<code> </code>
<code>    InitData data = new();</code>
<code>    <b>modelBuilder.Entity&lt;Book&gt;()</b></code>
<code>      <b>.HasMany(b =&gt; b.Authors)</b></code>
<code>      <b>.WithMany(a =&gt; a.WrittenBooks)</b></code>
<code>      <b>.UsingEntity(ba =&gt; ba.HasData(data.GetBooksAuthors()));</b></code>
<code> <span aria-label="619" epub:type="pagebreak" id="Page_619" role="doc-pagebreak"></span></code>
<code>    modelBuilder.Entity&lt;Person&gt;().HasData(data.GetAuthors());</code>
<code>    modelBuilder.Entity&lt;Book&gt;().HasData(data.GetBooks());</code>
<code>  }</code>
<code> </code>
<code>  public DbSet&lt;Book&gt; Books =&gt; Set&lt;Book&gt;();</code>
<code>  public DbSet&lt;Person&gt; People =&gt; Set&lt;Person&gt;();</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">GetBooksAuthors</code>
                    method returns an object array to fill the property bag using anonymous types. The property names
                    for the anonymous type are generated using the relation property name from one side of the relation
                    and the key name property from the other side of the relation. <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Person.WrittenBooks</code>
                    combined with <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book.BookId</code>
                    results in the anonymous type property name <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">WrittenBooksBookId</code>.
                    <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Similarly, Book.Authors</code>
                    combined with <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Person.PersonId</code>
                    results in <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">AuthorsPersonId</code>
                    (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relationships/InitData.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">GetBooksAuthors</code>
                                方法返回一个对象数组，使用匿名类型填充属性包。匿名类型的属性名是使用关系的一侧的关联属性名和另一侧的键名属性生成的。 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Person.WrittenBooks</code>
                                与 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book.BookId</code>
                                结合产生匿名类型的属性名 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">WrittenBooksBookId</code>
                                。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Similarly, Book.Authors</code>
                                与 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Person.PersonId</code>
                                结合产生 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">AuthorsPersonId</code>
                                （代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relationships/InitData.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0084"><code>public object[] GetBooksAuthors()</code>
<code>  =&gt; new object[] </code>
<code>  {</code>
<code>    new { WrittenBooksBookId = 1, AuthorsPersonId = 1 },</code>
<code>    new { WrittenBooksBookId = 1, AuthorsPersonId = 2 },</code>
<code>    new { WrittenBooksBookId = 2, AuthorsPersonId = 1 },</code>
<code>    //…</code>
<code>  };</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">With this mapping in place and with data filled in the
                    database (the sample application makes use of migrations to create and fill the database), you can
                    access the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Authors</code> property
                    of the <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code>
                    class to access information from the book authors. With the following code snippet, eager loading is
                    used to fill the authors. Of course, you can also use explicit or lazy loading as discussed earlier
                    (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relationships/BooksContext.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                有了这个映射设置，并且数据库中已填充数据（示例应用程序使用迁移来创建和填充数据库），您可以通过访问 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Authors</code>
                                类中的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code>
                                属性来获取书籍作者的信息。使用以下代码片段，通过急加载来填充作者。当然，您也可以像之前讨论的那样使用显式加载或懒加载（代码文件 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relationships/BooksContext.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0085"><code>public async Task GetBooksForAuthorAsync()</code>
<code>{</code>
<code>  var books = await _booksContext.Books</code>
<code>    .Where(b =&gt; b.Title.StartsWith("Professional C#"))</code>
<code>    .Include(b =&gt; b.Authors)</code>
<code>    .ToListAsync();</code>
<code>  foreach (var b in books)</code>
<code>  {</code>
<code>    Console.WriteLine(b.Title);</code>
<code>    foreach (var a in b.Authors)</code>
<code>    {</code>
<code>      Console.Write($"{a.FirstName} {a.LastName}");</code>
<code>    }</code>
<code>    Console.WriteLine();</code>
<code>  }</code>
<code>}</code></pre>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0066"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-421" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Table Splitting <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">表拆分</font>
                        </font>
                    </font>
                </h3>
                <p id="c21-para-0184" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Sometimes the number of database columns grows over time and
                    you don't need to access all the columns every time. It's a good idea not to have all the properties
                    within one entity class. With table splitting, you can split a table into multiple entity types.
                    Using table splitting, each class that belongs to the same table needs a one-to-one relationship and
                    defines its own primary key. However, because they share the same table, the primary key is shared,
                    too.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                有时，数据库列的数量会随着时间的推移而增加，而您每次并不需要访问所有列。将所有属性都放在一个实体类中并不是一个好主意。通过表拆分，您可以将一个表拆分为多个实体类型。使用表拆分时，属于同一表的每个类都需要一对一的关系，并定义自己的主键。然而，因为它们共享同一个表，所以主键也是共享的。
                            </font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Let's get into an example with the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code> class
                    that represents information about a lunch menu, and <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuDetails</code>
                    contains information for the kitchen. The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code> class
                    defines some properties for the menu, <span aria-label="620" epub:type="pagebreak" id="Page_620"
                        role="doc-pagebreak"
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>including the
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Details</code>
                    property. The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Details</code> property
                    maps the relation to the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuDetails</code> class
                    (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relationships/Menus.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">让我们通过一个示例来了解， <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                类表示午餐菜单的信息， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuDetails</code>
                                包含厨房的信息。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                类定义了一些菜单属性，包括 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Details</code>
                                属性。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Details</code>
                                属性映射到 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuDetails</code>
                                类的关系（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relationships/Menus.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0086"><code>public class MenuItem</code>
<code>{</code>
<code>  public MenuItem(string title, int menuItemId = 0)</code>
<code>  {</code>
<code>    Title = title;</code>
<code>    MenuItemId = menuItemId;</code>
<code>  }</code>
<code>  public int MenuItemId { get; set; }</code>
<code>  public string Title { get; set; }</code>
<code>  public string? Subtitle { get; set; }</code>
<code>  public decimal Price { get; set; }</code>
<code>  public MenuDetails? Details { get; set; }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuDetails</code> class
                    looks like it would map to its own table—with a primary key—and map to the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code> class
                    with the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code> property
                    (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relationships/Menus.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuDetails</code>
                                类看起来会映射到自己的表——带有一个主键——并通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                属性映射到 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                类（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relationships/Menus.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0087"><code>public class MenuDetails</code>
<code>{</code>
<code>  public int MenuDetailsId { get; set; }</code>
<code>  public string? KitchenInfo { get; set; }</code>
<code>  public int MenusSold { get; set; }</code>
<code>  public MenuItem? MenuItem { get; set; }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Within the context, <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItems</code> and
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuDetails</code> are
                    two <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbSet</code>
                    properties. In the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OnModelCreating</code>
                    method, the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code> class is
                    configured to a one-to-one relationship with <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuDetails</code> using
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">HasOne</code> and <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">WithOne</code>. These
                    APIs already have been discussed. Now you should put your attention to the invocation of the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ToTable</code> methods.
                    Both <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                    and <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuDetails</code>
                    map to the same table <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItems</code>. This
                    makes the difference for table splitting (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relationships/MenusContext.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在上下文中， <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItems</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuDetails</code>
                                是两个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbSet</code>
                                属性。在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OnModelCreating</code>
                                方法中， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                类通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">HasOne</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">WithOne</code>
                                配置为与 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuDetails</code>
                                的一对一关系。这些 API 已经讨论过了。现在你应该关注 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ToTable</code>
                                方法的调用。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuDetails</code>
                                都映射到同一个表 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItems</code>
                                。这使得表拆分有所不同（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relationships/MenusContext.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0088"><code>public class MenusContext : DbContext</code>
<code>{</code>
<code>  public MenusContext(DbContextOptions&lt;MenusContext&gt; options) </code>
<code>    : base(options) { }</code>
<code> </code>
<code>  protected override void OnModelCreating(ModelBuilder modelBuilder)</code>
<code>  {</code>
<code>    modelBuilder.HasDefaultSchema("ms");</code>
<code> </code>
<code>    modelBuilder.Entity&lt;MenuItem&gt;()</code>
<code>      .HasOne&lt;MenuDetails&gt;(m =&gt; m.Details!)</code>
<code>      .WithOne(d =&gt; d.Menu!)</code>
<code>      .HasForeignKey&lt;MenuDetails&gt;(d =&gt; d.MenuDetailsId);</code>
<code>    <b>modelBuilder.Entity&lt;MenuItem&gt;().ToTable("MenuItems");</b></code>
<code>    <b>modelBuilder.Entity&lt;MenuDetails&gt;().ToTable("MenuItems");</b></code>
<code>  }</code>
<code> </code>
<code>  public DbSet&lt;MenuItem&gt; MenuItems =&gt; Set&lt;Menu&gt;();</code>
<code>  public DbSet&lt;MenuDetails&gt; MenuDetails =&gt; Set&lt;MenuDetails&gt;();</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span aria-label="621"
                        epub:type="pagebreak" id="Page_621" role="doc-pagebreak"
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span></p>
                <aside data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <div class="top hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <p id="c21-para-0189" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NOTE</b> <i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EF Core 5
                                partially supports nullable reference types. When entity types are annotated, a
                                convention is used to map to nullable columns. Many of the EF Core APIs are annotated,
                                but not all are (at the time I'm writing this). When you use expressions with relations,
                                nullable references result in a compiler warning. The EF Core team gives a guideline
                                with two different contrary options for ways to deal with this. The first is to make the
                                relation property (</i><code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuDetails</code><i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"> with the
                            </i><code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code><i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"> class) not
                                nullable, even if it could be null. If the entity type is used from EF Core only, this
                                shouldn't be an issue. However, if the entity type is passed around and will be created
                                in other ways, this can lead to issues—for example, </i><code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NullReferenceException</code><i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"> if the relation
                                was not filled. The second option is to declare the reference as nullable (as was done
                                with the sample code) and use the null forgiving operator </i><code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">!</code><i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"> within the
                                arguments of the </i><code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">HasOne</code><i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"> and </i><code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">WithOne</code><i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"> methods to get
                                rid of the compiler warning. With the sample code, the second option is used. With
                                future EF Core versions, some enhancements are planned, including annotations for all
                                the EF Core APIs.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意 EF Core 5
                                        部分支持可空引用类型。当实体类型被注解时，会使用约定来映射到可空列。许多 EF Core API
                                        都被注解了，但并非全部（在我撰写本文时）。当你使用涉及关系的表达式时，可空引用会导致编译器警告。EF Core
                                        团队给出了一个指南，提供了两种不同的、相反的处理方式。第一种是使关系属性（与 <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                        类的 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuDetails</code>
                                        属性）不可空，即使它可能是空的。如果实体类型仅由 EF Core
                                        使用，这不应该是个问题。但是，如果实体类型会被传递并在其他方式下创建，这可能会导致问题——例如， <code
                                            xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NullReferenceException</code>
                                        如果关系没有被填充。第二种选项是声明引用为可空（如示例代码所示），并在 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">HasOne</code>
                                        和 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">WithOne</code>
                                        方法的参数中使用空值容忍操作符 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">!</code>
                                        来消除编译器警告。在示例代码中，使用了第二种选项。对于未来的 EF Core 版本，计划进行一些增强，包括为所有 EF Core API 添加注解。
                                    </font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                            <hr />
                        </div>
                    </section>
                </aside>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">When you verify how the table was generated in the database,
                    you can see with the following SQL statement that the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItems</code> table
                    includes the columns for both the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code> and <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuDetails</code>
                    classes, and only the primary key from the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code> class:
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">当你验证数据库中表是如何生成的时，可以通过以下 SQL 语句看到
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItems</code>
                                表包含了 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuDetails</code>
                                类的列，以及仅来自 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                类的主键：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0089"><code>CREATE TABLE [dbo].[MenuItems](</code>
<code>  [MenuItemId] [int] IDENTITY(1,1) NOT NULL,</code>
<code>  [Price] [decimal](18, 2) NOT NULL,</code>
<code>  [Subtitle] [nvarchar](max) NULL,</code>
<code>  [Title] [nvarchar](max) NULL,</code>
<code>  [KitchenInfo] [nvarchar](max) NULL,</code>
<code>  [MenusSold] [int] NOT NULL,</code>
<code>CONSTRAINT [PK_MenuItems] PRIMARY KEY CLUSTERED </code>
<code>(</code>
<code>  [MenuItemId] ASC</code>
<code>)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, </code>
<code>  ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]</code>
<code>) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]</code>
<code>GO</code></pre>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0068"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-422" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Owned Entities <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">拥有实体</font>
                        </font>
                    </font>
                </h3>
                <p id="c21-para-0191" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">A different way to split a table into multiple entity types
                    is with the feature known as <i
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">owned entities</i>. The
                    owned entities don't need a primary key; they simply can be types owned within a normal entity.
                    Entity types from owned entities can map to a single table—using the table splitting feature—or to
                    different tables. When different tables are used, they share the same primary key.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                将表拆分为多个实体类型的一种不同方式是使用称为拥有实体的特性。拥有实体不需要主键；它们可以简单地作为普通实体中的类型。来自拥有实体的实体类型可以映射到单个表——使用表拆分特性——或映射到不同的表。当使用不同的表时，它们共享相同的主键。
                            </font>
                        </font>
                    </font>
                </p>
                <p id="c21-para-0192" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Let's get into an example that shows both scenarios: using
                    owned entities where part of the data is mapped to the same table and part is mapped to another
                    table.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                让我们通过一个示例来展示这两种场景：使用拥有实体，其中部分数据映射到同一表，而部分数据映射到另一个表。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The following code snippet shows the main entity type, <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Person</code>. This is
                    the owner of owned entities with the primary key <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PersonId</code>. This
                    type contains two addresses: a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PrivateAddress</code> and
                    a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BusinessAddress</code>
                    (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relations/Books/Person.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">以下代码片段显示了主要实体类型 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Person</code>
                                。这是拥有实体的所有者，其主键为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PersonId</code>
                                。此类型包含两个地址：一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PrivateAddress</code>
                                和一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BusinessAddress</code>
                                （代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relations/Books/Person.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0090"><code>public class Person</code>
<code>{</code>
<code>  public int PersonId { get; set; }</code>
<code>  public string Name { get; set; }<span aria-label="622" epub:type="pagebreak" id="Page_622" role="doc-pagebreak"></span></code>
<code>  public Address PrivateAddress { get; set; }</code>
<code>  public Address? BusinessAddress { get; set; }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Address</code> is an
                    owned entity—a type without its own primary key. This type has two string properties and a relation
                    named <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Location</code>
                    of type <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Location</code>. <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Location</code> is
                    another owned entity (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relations/Books/Address.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Address</code>
                                是一个拥有实体——一个没有自己的主键的类型。此类型有两个字符串属性和一个名为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Location</code>
                                的关系，类型为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Location</code>
                                。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Location</code>
                                是另一个拥有实体（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relations/Books/Address.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0091"><code>public class Address</code>
<code>{</code>
<code>  public string? LineOne { get; set; }</code>
<code>  public string? LineTwo { get; set; }</code>
<code>  public Location? Location { get; set; }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Location</code>
                    contains <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Country</code>
                    and <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">City</code>
                    properties, and as an owned entity, it also doesn't define a key (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relations/Books/Location.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Location</code>
                                包含 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Country</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">City</code>
                                属性，作为一个拥有实体，它也不定义一个键（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relations/Books/Location.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0092"><code>public class Location</code>
<code>{</code>
<code>  public string? Country { get; set; }</code>
<code>  public string? City { get; set; }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The most interesting part now comes with the context, where
                    owned entities are defined in the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PersonConfiguration</code>
                    class, as shown with the following code sample. When you customize the model for the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Person</code> class, the
                    first invocation of <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OwnsOne</code> specifies
                    that the <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Person</code>
                    entity owns the entity referenced from the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BusinessAddress</code>
                    property, which is an <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Address</code> type. By
                    default, column names based on the property name and type of the property are combined with an
                    underscore separator. To change this default behavior, column names are configured with the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">HasColumnName</code>
                    method. The properties of the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Location</code> class are
                    owned by the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">People</code> table as
                    well because another <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OwnsOne</code> method is
                    invoked with the builder of the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BusinessAddress</code>.
                    With the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PrivateAddress</code>
                    property of the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Person</code>, before
                    invoking <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OwnsOne</code>, the table
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PrivateAddresses</code>
                    is mapped. Instead of having the private address values stored with the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">People</code> table, here
                    another table is used (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relationships/Books/PersonConfiguration.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">现在最有趣的部分是上下文，其中在 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PersonConfiguration</code>
                                类中定义了拥有的实体，如下面的代码示例所示。当你为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Person</code>
                                类自定义模型时， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OwnsOne</code>
                                的第一次调用指定了 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Person</code>
                                实体拥有从 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BusinessAddress</code>
                                属性引用的实体，该属性是一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Address</code>
                                类型。默认情况下，基于属性名称和类型的列名使用下划线分隔符组合。要更改此默认行为，可以使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">HasColumnName</code>
                                方法配置列名。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Location</code>
                                类的属性也属于 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">People</code>
                                表，因为使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BusinessAddress</code>
                                的构建器调用了另一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OwnsOne</code>
                                方法。使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Person</code>
                                的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PrivateAddress</code>
                                属性，在调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OwnsOne</code>
                                之前，映射了表 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PrivateAddresses</code>
                                。而不是将私有地址值存储在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">People</code>
                                表中，这里使用了另一个表（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relationships/Books/PersonConfiguration.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0093"><code>internal class PersonConfiguration : IEntityTypeConfiguration&lt;Person&gt;</code>
<code>{</code>
<code>  public void Configure(EntityTypeBuilder&lt;Person&gt; builder)</code>
<code>  {</code>
<code>    builder.OwnsOne(p =&gt; p.BusinessAddress, builder =&gt;</code>
<code>    {</code>
<code>      builder.Property(a =&gt; a!.LineOne).HasColumnName("AddressLineOne");</code>
<code>      builder.Property(a =&gt; a!.LineTwo).HasColumnName("AddressLineTwo");</code>
<code>      builder.OwnsOne(a =&gt; a!.Location, locationBuilder =&gt;</code>
<code>      {</code>
<code>        locationBuilder.Property(l =&gt; l!.City).HasColumnName("BusinessCity");</code>
<code>        locationBuilder.Property(l =&gt; l!.Country).HasColumnName("BusinessCountry");</code>
<code>      });</code>
<code>    });</code>
<code> </code>
<code>    builder.OwnsOne(p =&gt; p.PrivateAddress)</code>
<code>      .ToTable("PrivateAddresses")</code>
<code>      .OwnsOne(a =&gt; a!.Location, builder =&gt;</code>
<code>      {<span aria-label="623" epub:type="pagebreak" id="Page_623" role="doc-pagebreak"></span></code>
<code>        builder.Property(a =&gt; a!.City).HasColumnName("City");</code>
<code>        builder.Property(a =&gt; a!.Country).HasColumnName("Country");</code>
<code>      });</code>
<code>  }</code>
<code>}</code>
<code> </code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">When creating the database, the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">People</code> table
                    contains columns from the owned entity types:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">创建数据库时， <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">People</code>
                                表包含从所属实体类型中继承的列：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0094"><code>CREATE TABLE [dbo].[People](</code>
<code>  [PersonId] [int] IDENTITY(1,1) NOT NULL,</code>
<code>  [Name] [nvarchar](max) NULL,</code>
<code>  [CompanyAddress_LineOne] [nvarchar](max) NULL,</code>
<code>  [CompanyAddress_LineTwo] [nvarchar](max) NULL,</code>
<code>  [BusinessCity] [nvarchar](max) NULL,</code>
<code>  [BusinessCountry] [nvarchar](max) NULL,</code>
<code>CONSTRAINT [PK_People] PRIMARY KEY CLUSTERED </code>
<code>(</code>
<code>  [PersonId] ASC</code>
<code>)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, </code>
<code>  ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]</code>
<code>) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]</code>
<code>GO</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The second table (<code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PrivateAddresses</code>)
                    is created because of the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ToTable</code> mapping on
                    the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PrivateAddress</code>
                    property. The key for this table is the same as for the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">People</code> table
                    (<code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PersonId</code>):<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">第二个表（ <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PrivateAddresses</code>
                                ）的创建是因为在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PrivateAddress</code>
                                属性上的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ToTable</code>
                                映射。该表的主键与 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">People</code>
                                表（ <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PersonId</code>
                                ）的主键相同：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0095"><code>CREATE TABLE [dbo].[Addr](</code>
<code>  [PersonId] [int] NOT NULL,</code>
<code>  [LineOne] [nvarchar](max) NULL,</code>
<code>  [LineTwo] [nvarchar](max) NULL,</code>
<code>  [Location_City] [nvarchar](max) NULL,</code>
<code>  [Location_Country] [nvarchar](max) NULL,</code>
<code>CONSTRAINT [PK_Addr] PRIMARY KEY CLUSTERED </code>
<code>(</code>
<code>  [PersonId] ASC</code>
<code>)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, </code>
<code>  ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]</code>
<code>) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]</code>
<code>GO</code></pre>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0069"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-423" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Table per Hierarchy <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">按层次表</font>
                        </font>
                    </font>
                </h3>
                <p id="c21-para-0199" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">EF Core also supports the relationship type of table per
                    hierarchy (TPH). With this relationship, multiple model classes that form a hierarchy are used to
                    map to a single table. This relationship can be specified by using conventions and by using the
                    Fluent API.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">EF Core
                                也支持按层次表（TPH）的关系类型。通过这种关系，多个形成层次结构的模型类可以映射到一个表中。这种关系可以通过约定和 Fluent API 来指定。</font>
                        </font>
                    </font>
                </p>
                <p id="c21-para-0200" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Let's start using conventions and the types <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Payment</code>, <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CashPayment</code>, and
                    <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CreditcardPayment</code>
                    that form a hierarchy. <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Payment</code> is a base
                    class; <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CashPayment</code> and
                    <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CreditcardPayment</code>
                    derive from it.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">让我们开始使用约定以及构成层次结构的 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Payment</code>
                                、 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CashPayment</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CreditcardPayment</code>
                                类型。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Payment</code>
                                是一个基类； <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CashPayment</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CreditcardPayment</code>
                                继承自它。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">With the implementation, the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Payment</code> class
                    defines the primary key with the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PaymentId</code>
                    property, a required <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Name</code>, and an <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Amount</code> property.
                    The <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Amount</code>
                    property maps to a database column type <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Money</code> (code file
                    <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relations/Bank/Payments.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在实现中， <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Payment</code>
                                类使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PaymentId</code>
                                属性定义主键，一个必需的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Name</code>
                                ，以及一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Amount</code>
                                属性。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Amount</code>
                                属性映射到数据库列类型 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Money</code>
                                （代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relations/Bank/Payments.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0096"><code>public abstract class Payment</code>
<code>{</code>
<code>  public Payment(string name, decimal amount, int paymentId = 0)</code>
<code>  {<span aria-label="624" epub:type="pagebreak" id="Page_624" role="doc-pagebreak"></span></code>
<code>    Name = name;</code>
<code>    Amount = amount;</code>
<code>    PaymentId = paymentId;</code>
<code>  }</code>
<code>  public int PaymentId { get; set; }</code>
<code>  [StringLength(20)]</code>
<code>  public string Name { get; set; }</code>
<code>  [Column(TypeName = "Money")]</code>
<code>  public decimal Amount { get; set; }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The class <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CreditcardPayment</code>
                    derives from <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Payment</code> and adds a
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CreditcardNumber</code>
                    property (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relations/Bank/Payments.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CreditcardPayment</code>
                                类继承自 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Payment</code>
                                并添加了一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CreditcardNumber</code>
                                属性（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relations/Bank/Payments.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0097"><code>public class CreditcardPayment : Payment</code>
<code>{</code>
<code>  public CreditcardPayment(string name, decimal amount, int paymentId = 0)</code>
<code>    : base(name, amount, paymentId) { }</code>
<code>  public string? CreditcardNumber { get; set; }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Finally, the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CashPayment</code> class
                    derives from <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Payment</code> but
                    doesn't declare any additional members (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relations/Bank/Payments.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">最后， <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CashPayment</code>
                                类继承自 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Payment</code>
                                但没有声明任何其他成员（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relations/Bank/Payments.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0098"><code>public class CashPayment : Payment</code>
<code>{</code>
<code>  public CashPayment(string name, decimal amount, int paymentId = 0)</code>
<code>    : base(name, amount, paymentId) {  }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The EF Core context class, the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BankContext</code>,
                    defines a <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbSet</code>
                    property for the class to map to the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Payments</code> table.
                    Here, the Fluent API is used to define the TPH mapping. The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">HasDiscriminator</code>
                    method specifies the name of the column to be used to differentiate the derived types that are
                    returned. The method <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">HasValue</code> defines
                    for the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CashPayment</code> class
                    to have the value <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">cash</code> inside the
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Type</code> column, and
                    the mapping to the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CreditcardPayment</code>
                    class is done with a value <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">creditcard</code> (code
                    file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relations/Bank/BankContext.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">EF Core 的上下文类，即 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BankContext</code>
                                ，为该类定义了一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbSet</code>
                                属性，用于映射到 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Payments</code>
                                表。这里使用 Fluent API 来定义 TPH 映射。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">HasDiscriminator</code>
                                方法指定了用于区分返回的派生类型的列名。方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">HasValue</code>
                                定义了 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CashPayment</code>
                                类在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Type</code>
                                列中的值为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">cash</code>
                                ，而与 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CreditcardPayment</code>
                                类的映射则使用值 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">creditcard</code>
                                （代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relations/Bank/BankContext.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0099"><code>public class BankContext : DbContext</code>
<code>{</code>
<code>    public BankContext(DbContextOptions&lt;BankContext&gt; options)</code>
<code>        : base(options) {}</code>
<code> </code>
<code>    public DbSet&lt;Payment&gt; Payments =&gt; Set&lt;Payment&gt;();</code>
<code> </code>
<code>    protected override void OnModelCreating(ModelBuilder modelBuilder)</code>
<code>    {</code>
<code>        modelBuilder.HasDefaultSchema("bank");</code>
<code> </code>
<code>        modelBuilder.Entity&lt;Payment&gt;()</code>
<code>            .HasDiscriminator&lt;string&gt;("Type")</code>
<code>            .HasValue&lt;CashPayment&gt;("cash")</code>
<code>            .HasValue&lt;CreditcardPayment&gt;("creditcard");</code>
<code> </code>
<code>        modelBuilder.Entity&lt;Payment&gt;()</code>
<code>            .Property(p =&gt; p.Amount)</code>
<code>            .HasColumnType("Money");</code>
<code>    }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span aria-label="625"
                        epub:type="pagebreak" id="Page_625" role="doc-pagebreak"
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span></p>
                <aside data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <div class="top hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <p id="c21-para-0206" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NOTE</b> <i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">The sample
                                application for TPH mapping uses the Fluent API. With conventions, the base class can't
                                be abstract, and you need to define </i><code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DBSet</code><i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"> properties for
                                every class of the hierarchy. By convention, the discriminator column is named </i><code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Discriminator</code><i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意：TPH 映射的示例应用程序使用 Fluent
                                        API。使用约定时，基类不能是抽象的，并且你需要为层次结构中的每个类定义 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DBSet</code>
                                        属性。按约定，区分列的名称为 <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Discriminator</code>
                                        。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                            <hr />
                        </div>
                    </section>
                </aside>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The sample data created defines two <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CashPayment</code> and
                    one <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CreditcardPayment</code>
                    payments (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relations/Bank/BankRunner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">创建的示例数据定义了两个 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CashPayment</code>
                                和一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CreditcardPayment</code>
                                支付（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Relations/Bank/BankRunner.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0100"><code>public async Task AddSampleDataAsync()</code>
<code>{</code>
<code>  _bankContext.Payments.Add(new CashPayment("Donald", 0.5M));</code>
<code>  _bankContext.Payments.Add(new CashPayment("Scrooge", 20000M));</code>
<code>  _bankContext.Payments.Add(new CreditcardPayment("Gus Goose", 300M) </code>
<code>  {</code>
<code>    CreditcardNumber = "987654321"</code>
<code>  });</code>
<code>  await _bankContext.SaveChangesAsync();</code>
<code>}</code></pre>
                <p id="c21-para-0208" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">When you run the application to create the database, just a
                    single table—
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Payments</code>—gets
                    created. This table defines a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Type</code> column that
                    maps a record from the table to the corresponding model type.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">当你运行应用程序来创建数据库时，仅创建一个表— <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Payments</code>
                                。该表定义了一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Type</code>
                                列，用于将表中的记录映射到相应的模型类型。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">To query only specific types from the hierarchy, you can use
                    the <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OfType</code>
                    extension method. In the following code snippet, you can see a query to return only payments of type
                    <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CreditcardPayment</code>
                    (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">TPHWithConventions/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">要从层次结构中查询特定类型，可以使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OfType</code>
                                扩展方法。在以下代码片段中，可以看到一个查询，仅返回类型为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CreditcardPayment</code>
                                的支付（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">TPHWithConventions/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0101"><code>public async Task QuerySampleAsync()</code>
<code>{</code>
<code>  var creditcardPayments = await _bankContext.Payments</code>
<code>    .OfType&lt;CreditcardPayment&gt;()</code>
<code>    .ToListAsync();</code>
<code>  foreach (var payment in creditcardPayments)</code>
<code>  {</code>
<code>    Console.WriteLine($"{payment.Name}, {payment.Amount}");</code>
<code>  }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">When you use the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OfType</code> method, EF
                    Core creates a query with a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">WHERE</code> clause to
                    distinguish records only with a value of <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CreditcardPayment</code>
                    :<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OfType</code>
                                方法时，EF Core 会创建一个带有 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">WHERE</code>
                                子句的查询，以区分仅具有 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CreditcardPayment</code>
                                值的记录：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0102"><code>SELECT [p].[PaymentId], [p].[Amount], [p].[Discriminator], [p].[Name], </code>
<code>  [p].[CreditcardNumber]</code>
<code>FROM [Payments] AS [p]</code>
<code>WHERE [p].[Discriminator] = N'CreditcardPayment'</code></pre>
            </section>
        </section>
        <section aria-labelledby="head-2-199" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
            <span id="c21-sec-0071" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
            <h2 id="head-2-199" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">SAVING DATA<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">保存数据</font>
                    </font>
                </font>
            </h2>
            <p id="c21-para-0211" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">After creating the database with models and relations, you can
                write to it. The section “Introducing EF Core” showed you how to add, update, and delete records, but
                now let's examine various aspects of this in more detail.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">在创建包含模型和关系的数据库后，您可以向其中写入数据。第“介绍 EF
                            Core”部分展示了如何添加、更新和删除记录，但现在让我们更详细地探讨这些方面的各个方面。</font>
                    </font>
                </font>
            </p>
            <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">With the sample application, this time the <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IDbContextFactory</code> is
                used to create <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                s. This allows having a shorter lifetime of the context and requires that you dispose of the context
                explicitly. This allows you to better <span aria-label="626" epub:type="pagebreak" id="Page_626"
                    role="doc-pagebreak"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>simulate having
                multiple context objects as you have with web applications and services, where different context
                instances are used with every HTTP request. The <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">AddDbContextFactory</code>
                used in the following code snippet is new with EF Core 5.0 (code file <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Tracking/Program.cs</code>):
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">使用示例应用程序时，这次使用 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IDbContextFactory</code>
                            来创建 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                            。这允许拥有更短的上下文生命周期，并要求你显式地处置上下文。这使你能够更好地模拟在 Web 应用程序和服务中拥有多个上下文对象的情况，在这些情况下，每个 HTTP
                            请求都使用不同的上下文实例。以下代码片段中使用的 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">AddDbContextFactory</code>
                            是 EF Core 5.0 中的新功能（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Tracking/Program.cs</code>
                            ）：</font>
                    </font>
                </font>
            </p>
            <pre id="c21-code-0103"><code>using var host = Host.CreateDefaultBuilder(args)</code>
<code>  .ConfigureServices((context, services) =&gt;</code>
<code>{</code>
<code>  var connectionString = context.Configuration.GetConnectionString("MenusConnection");</code>
<code>  services.AddDbContextFactory&lt;MenusContext&gt;(options =&gt;</code>
<code>  {</code>
<code>    options.UseSqlServer(connectionString);</code>
<code>  });</code>
<code> </code>
<code>  services.AddScoped&lt;Runner&gt;();</code>
<code>}).Build();</code></pre>
            <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">With the <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Runner</code> class, the
                <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IDbContextFactory</code> is
                injected. The variable <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">_menusContextFactory</code>
                can then be used to create new <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                s (code file <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Tracking/Runner.cs</code>):
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">使用 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Runner</code> 类时，
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IDbContextFactory</code>
                            被注入。然后可以使用变量 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">_menusContextFactory</code>
                            来创建新的 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                            （代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Tracking/Runner.cs</code>
                            ）：</font>
                    </font>
                </font>
            </p>
            <pre id="c21-code-0104"><code>private readonly IDbContextFactory&lt;MenusContext&gt; _menusContextFactory;</code>
<code>  public Runner(IDbContextFactory&lt;MenusContext&gt; menusContextFactory) </code>
<code>  =&gt; _menusContextFactory = menusContextFactory;</code></pre>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0072"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-424" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Adding Objects with Relations <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">添加具有关系的对象</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The following code snippet writes a relationship: a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                    containing <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code> objects.
                    Here, the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code> and <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code> objects
                    are instantiated. The bidirectional associations are assigned. With the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>, the
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                    property is assigned to the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>, and with
                    the <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>,
                    the <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItems</code>
                    property is filled with <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code> objects.
                    The <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                    instance is added to the context to invoke the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Add</code> method of the
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCards</code>
                    property. When you add an object to the context, by default, all objects are added to the tree with
                    the state added. Not only is the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code> saved,
                    but the <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                    objects are saved as well. Invoking <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>
                    on the context now creates four records (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Tracking/Runner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">以下代码片段定义了一个关系：一个 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                                包含 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                对象。这里， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                对象被实例化。双向关联被分配。通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                ， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                                属性被赋值给 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                                ，通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                                ， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItems</code>
                                属性被填充为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                对象。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                                实例被添加到上下文中以调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCards</code>
                                属性的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Add</code>
                                方法。当你将对象添加到上下文时，默认情况下，所有对象都会以添加的状态被加入到树中。不仅 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                                被保存， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                对象也被保存。现在在上下文中调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>
                                会创建四条记录（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Tracking/Runner.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0105"><code>public async Task AddRecordsAsync()</code>
<code>{</code>
<code>  Console.WriteLine(nameof(AddRecordsAsync));</code>
<code>  using var context = _menusContextFactory.CreateDbContext();</code>
<code>  MenuCard soupCard = new("Soups");</code>
<code> </code>
<code>  MenuItem[] soups = new[]</code>
<code>  {</code>
<code>    new MenuItem("Consommé Célestine (with shredded pancake)")</code>
<code>    {</code>
<code>      Price = 4.8m,</code>
<code>      MenuCard = soupCard</code>
<code>    },</code>
<code>    new MenuItem("Baked Potato Soup")</code>
<code>    {</code>
<code>      Price = 4.8m,</code>
<code>      MenuCard = soupCard</code>
<code>    },</code>
<code>    new MenuItem("Cheddar Broccoli Soup")</code>
<code>    {</code>
<code>      Price = 4.8m,</code>
<code>      MenuCard = soupCard<span aria-label="627" epub:type="pagebreak" id="Page_627" role="doc-pagebreak"></span></code>
<code>    }</code>
<code>  };</code>
<code> </code>
<code>  foreach (var soup in soups)</code>
<code>  {</code>
<code>    soupCard.MenuItems.Add(soup);</code>
<code>  }</code>
<code> </code>
<code>  context.MenuCards.Add(soupCard);</code>
<code> </code>
<code>  ShowState(context);</code>
<code>  int records = await context.SaveChangesAsync();</code>
<code>  Console.WriteLine($"{records} added");</code>
<code>  Console.WriteLine();</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The method <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ShowState</code> that is
                    invoked after adding the four objects to the context shows the state of all objects that are
                    associated with the context. The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code> class
                    has a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ChangeTracker</code>
                    associated that can be accessed using the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ChangeTracker</code>
                    property. The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Entries</code> method of
                    the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ChangeTracker</code>
                    returns all the objects the change tracker knows about. With the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">foreach</code> loop,
                    every object, including its state, is written to the console (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Tracking/Runner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在将四条对象添加到上下文后调用的 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ShowState</code>
                                方法显示了与上下文关联的所有对象的状态。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                                类有一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ChangeTracker</code>
                                关联，可以通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ChangeTracker</code>
                                属性访问。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ChangeTracker</code>
                                的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Entries</code>
                                方法返回 change tracker 知道的所有对象。通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">foreach</code>
                                循环，每个对象（包括其状态）被写入控制台（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Tracking/Runner.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0106"><code>private void ShowState(MenusContext context)</code>
<code>{</code>
<code>  foreach (EntityEntry entry in context.ChangeTracker.Entries())</code>
<code>  {</code>
<code>    Console.WriteLine($"type: {entry.Entity.GetType().Name}, " +</code>
<code>      $"state: {entry.State}, {entry.Entity}");</code>
<code>  }</code>
<code>  Console.WriteLine();</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Run the application to see the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Added</code> state with
                    these four objects:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">运行应用程序以查看这四条对象的状态：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0107"><code>type: MenuCard, state: Added, Soups</code>
<code>type: MenuItem, state: Added, Consommé Célestine (with shredded pancake)</code>
<code>type: MenuItem, state: Added, Baked Potato Soup</code>
<code>type: MenuItem, state: Added, Cheddar Broccoli Soup</code></pre>
                <p id="c21-para-0217" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Because of this state, the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>
                    method creates SQL <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Insert</code> statements
                    to write every object to the database.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">由于这种状态， <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>
                                方法会创建 SQL <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Insert</code>
                                语句来将每个对象写入数据库。</font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0073"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-425" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Tracking Objects <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">跟踪对象 </font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">You've seen that the context knows about added objects.
                    However, the context also needs to know about changes. To know about changes, every object retrieved
                    needs its state in the context. For seeing this in action, let's create two different queries that
                    return the same object. The following code snippet defines two different queries where each query
                    returns the same object with the menus as they are stored in the database. Only one object gets
                    materialized; with the second query result, it is detected that the record returned has the same
                    primary key value as an object already referenced from the context. Verifying whether the references
                    of the variables <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">m1</code> and <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">m2</code> are the same
                    results in returning the same object (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Tracking/Runner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                你已经看到上下文知道有关添加的对象。然而，上下文还需要知道有关更改的信息。为了知道更改信息，检索到的每个对象都需要其在上下文中的状态。为了演示这一点，让我们创建两个返回相同对象的查询。以下代码片段定义了两个不同的查询，每个查询都返回数据库中存储的菜单对象。只有一个对象被实例化；通过第二个查询结果，检测到返回的记录具有与上下文中已引用的对象相同的
                                primary key 值。验证变量 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">m1</code> 和
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">m2</code>
                                的引用是否相同，结果返回相同的对象（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Tracking/Runner.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0108"><code>public async Task ObjectTrackingAsync()</code>
<code>{</code>
<code>  using var context = _menusContextFactory.CreateDbContext();<span aria-label="628" epub:type="pagebreak" id="Page_628" role="doc-pagebreak"></span></code>
<code>  Console.WriteLine(nameof(ObjectTrackingAsync));</code>
<code>  var m1 = await (from m in context.MenuItems</code>
<code>                  where m.Text.StartsWith("Con")</code>
<code>                  select m).FirstOrDefaultAsync();</code>
<code>  var m2 = await (from m in context.MenuItems</code>
<code>                  where m.Text.Contains("(")</code>
<code>                  select m).FirstOrDefaultAsync();</code>
<code>  if (object.ReferenceEquals(m1, m2))</code>
<code>  {</code>
<code>    Console.WriteLine("the same object");</code>
<code>  }</code>
<code>  else</code>
<code>  {</code>
<code>    Console.WriteLine("not the same");</code>
<code>  }</code>
<code>  ShowState(context);</code>
<code>        </code>
<code>  Console.WriteLine();</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The first LINQ query results in an SQL <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SELECT</code> statement
                    with a <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LIKE</code>
                    comparison to compare for the string to start with the value <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Con</code>
                    :<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">第一个 LINQ 查询结果生成一个 SQL <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SELECT</code>
                                语句，使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LIKE</code>
                                比较来比较字符串是否以值 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Con</code>
                                开头：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0109"><code>SELECT TOP(1) [m].[MenuItemId], [m].[MenuCardId], [m].[Price], [m].[RestaurantId], </code>
<code>  [m].[Text]</code>
<code>FROM [mc].[MenuItems] AS [m]</code>
<code>WHERE [m].[Text] LIKE N'Con%'</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">With the second LINQ query, the database needs to be
                    consulted as well. Here, a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LIKE</code> comparison is
                    done to compare for a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">(</code> in the middle of
                    the text:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用第二个 LINQ 查询时，数据库也需要被查询。这里进行了一个
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">LIKE</code>
                                比较，用于在文本中间比较 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">(</code> ：
                            </font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0110"><code>SELECT TOP(1) [m].[MenuItemId], [m].[MenuCardId], [m].[Price], [m].[RestaurantId], </code>
<code>  [m].[Text]</code>
<code>FROM [mc].[MenuItems] AS [m]</code>
<code>WHERE [m].[Text] LIKE N'%(%'</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">When you run the application, the same object is written to
                    the console, and only one object is kept with the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ChangeTracker</code>. The
                    state is <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Unchanged</code>
                    :<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">运行应用程序时，相同的对象被写入控制台，并且只有一个对象保留
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ChangeTracker</code>
                                。状态是 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Unchanged</code>
                                ：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0111"><code>the same object</code>
<code>type: MenuItem, state: Unchanged, Consommé Célestine (with shredded pancake)</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">To not track the objects running queries from the database,
                    you can invoke the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">AsNoTracking</code>
                    method with the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbSet</code>
                    :<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">要使从数据库运行查询时不跟踪对象，可以调用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">AsNoTracking</code>
                                方法并使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbSet</code>
                                ：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0112"><code>var m1 = await (from m in context.MenuItems.<b>AsNoTracking()</b></code>
<code>          where m.Text.StartsWith("Con")</code>
<code>          select m).FirstOrDefaultAsync();</code></pre>
                <p id="c21-para-0223" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">With such a configuration, two queries are made to the
                    database, two objects are materialized, and the state information is empty.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在这种配置下，数据库进行了两次查询，创建了两个对象，状态信息为空。
                            </font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Instead of configuring the tracking behavior with the query,
                    you can also configure the default tracking behavior setting the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">QueryTrackingBehavior</code>
                    property of the change tracker or configure it with <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UseTrackingBehavior</code>
                    with the options in the DI configuration.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">除了通过查询配置跟踪行为外，您还可以通过设置变更跟踪器的 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">QueryTrackingBehavior</code>
                                属性来配置默认跟踪行为，或使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UseTrackingBehavior</code>
                                在依赖注入配置中使用选项进行配置。</font>
                        </font>
                    </font><span aria-label="629" epub:type="pagebreak" id="Page_629" role="doc-pagebreak"
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span></p>
                <aside data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <div class="top hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <hr />
                    </div>
                    <section class="feature2" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <p id="c21-para-0225" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                            data-immersive-translate-paragraph="1"><b
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NOTE</b> <i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Using the
                            </i><code
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NoTracking</code><i
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"> configuration is
                                useful when the context is used only to read records, but changes are not made. This
                                reduces the overhead of the context as state information is not kept.</i>
                            <font class="notranslate immersive-translate-target-wrapper"
                                data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                                <font
                                    class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                    data-immersive-translate-translation-element-mark="1">
                                    <font
                                        class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                        data-immersive-translate-translation-element-mark="1">注意 当上下文仅用于读取记录而不进行更改时，使用
                                        <code xmlns="http://www.w3.org/1999/xhtml"
                                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NoTracking</code>
                                        配置很有用。这减少了上下文的开销，因为不会保留状态信息。</font>
                                </font>
                            </font>
                        </p>
                        <div class="bottom hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                            <hr />
                        </div>
                    </section>
                </aside>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0075"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-426" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Updating Objects <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                        <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">更新对象 </font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">As objects are tracked, they can be updated easily, as shown
                    in the following code snippet. First, a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code> object is
                    retrieved. With this tracked object, the price is modified before the change is written to the
                    database. In between all changes, state information is written to the console (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Tracking/Runner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                由于对象被跟踪，因此可以轻松更新，如下面的代码片段所示。首先，检索一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                对象。使用这个被跟踪的对象，在将更改写入数据库之前修改价格。在所有更改之间，将状态信息写入控制台（代码文件 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Tracking/Runner.cs</code>
                                ):</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0113"><code>public async Task UpdateRecordsAsync()</code>
<code>{</code>
<code>  using var context = _menusContextFactory.CreateDbContext();</code>
<code>  MenuItem menuItem = await context.MenuItems</code>
<code>    .Skip(1)</code>
<code>    .FirstOrDefaultAsync();</code>
<code> </code>
<code>  ShowState(context);</code>
<code>  menuItem.Price += 0.2m;</code>
<code>  ShowState(context);</code>
<code>  int records = await context.SaveChangesAsync();</code>
<code>  Console.WriteLine($"{records} updated");</code>
<code>  ShowState(context);</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">When you run the application, you can see that the state of
                    the object is <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Unchanged</code> after
                    the record is loaded, <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Modified</code> after the
                    property value is changed, and <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Unchanged</code> after
                    saving is completed:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">当你运行应用程序时，可以看到在记录加载后对象的状态是 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Unchanged</code>
                                ，在属性值更改后是 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Modified</code>
                                ，在保存完成后是 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Unchanged</code>
                                ：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0114"><code>type: MenuItem, state: Unchanged, Baked Potato Soup</code>
<code>type: MenuItem, state: Modified, Baked Potato Soup</code>
<code>1 updated</code>
<code>type: MenuItem, state: Unchanged, Baked Potato Soup</code></pre>
                <p id="c21-para-0228" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">When you access the entries from the change tracker, by
                    default changes are automatically detected. You configure this by setting the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">AutoDetectChangesEnabled</code>
                    property of the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ChangeTracker</code>. To
                    check manually to see whether changes have been made, you invoke the method <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DetectChanges</code>.
                    With the invocation of <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>,
                    the state is changed back to <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Unchanged</code>. You can
                    do this manually by invoking the method <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">AcceptAllChanges</code>.
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">当你从变更跟踪器访问条目时，默认情况下会自动检测更改。你可以通过设置
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">AutoDetectChangesEnabled</code>
                                的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ChangeTracker</code>
                                属性来配置此行为。要手动检查是否已做出更改，你调用方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DetectChanges</code>
                                。通过调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>
                                ，状态会变回 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Unchanged</code>
                                。你可以通过调用方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">AcceptAllChanges</code>
                                手动执行此操作。</font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0076"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-427" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Updating Untracked Objects <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">更新未跟踪对象</font>
                        </font>
                    </font>
                </h3>
                <p id="c21-para-0229" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1"><code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                    s are usually very short-lived. Using EF Core with ASP.NET Core, with one HTTP request one object
                    context is created to retrieve objects. When you receive an update from the client, the object must
                    again be created on the server. This object is not associated with the object context. To update it
                    in the database, the object needs to be associated with the DB context, and the state needs to be
                    changed to create an <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">INSERT</code>, <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UPDATE</code>, or <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DELETE</code> statement.
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                                通常非常短暂。使用 EF Core 与 ASP.NET Core 时，一个 HTTP
                                请求会创建一个对象上下文来检索对象。当从客户端接收更新时，服务器上必须重新创建该对象。此对象与对象上下文没有关联。要在数据库中更新它，该对象需要与 DB
                                上下文关联，并且状态需要更改为创建 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">INSERT</code>
                                、 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UPDATE</code>
                                或 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DELETE</code>
                                语句。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Such a scenario is simulated with the next code snippet. The
                    local function <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">GetMenuItemAsync</code>
                    returns a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code> object
                    that is disconnected from the context; the context is disposed of at the end of the local function.
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">GetMenuItemAsync</code>
                    is invoked by the method <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UpdateRecordUntrackedAsync</code>.
                    This method changes <span aria-label="630" epub:type="pagebreak" id="Page_630" role="doc-pagebreak"
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code> object
                    that is not associated with any context. After the change, the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code> object is
                    passed to the local function <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UpdateMenuAsync</code> to
                    save it in the database within a new context. To mark this method as changed, the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Update</code> method
                    attaches the object to the context and sets the state to <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Modified</code>. Instead
                    of using the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Update</code> method, you
                    can use the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Attach</code> method and
                    set the state via the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">State</code> property of
                    an <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EntityEntry</code>
                    object, as shown with the commented code (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Tracking/Runner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">这种场景通过以下代码片段进行模拟。局部函数 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">GetMenuItemAsync</code>
                                返回一个与上下文断开连接的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                对象；在局部函数结束时，上下文被释放。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">GetMenuItemAsync</code>
                                由方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UpdateRecordUntrackedAsync</code>
                                调用。此方法更改一个与任何上下文无关的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                对象。更改后，将 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                对象传递给局部函数 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UpdateMenuAsync</code>
                                ，以便在新的上下文中将其保存到数据库中。为了将此方法标记为已更改， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Update</code>
                                方法将对象附加到上下文并将状态设置为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Modified</code>
                                。您可以选择不使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Update</code>
                                方法，而是使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Attach</code>
                                方法，并通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EntityEntry</code>
                                对象的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">State</code>
                                属性设置状态，如注释代码所示（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Tracking/Runner.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0115"><code>public async Task UpdateRecordUntrackedAsync()</code>
<code>{</code>
<code>  Task&lt;MenuItem&gt; GetMenuItemAsync()</code>
<code>  {</code>
<code>    using var context = _menusContextFactory.CreateDbContext();</code>
<code>    return context.MenuItems</code>
<code>      .Skip(2)</code>
<code>      .FirstOrDefaultAsync();</code>
<code>  }</code>
<code> </code>
<code>  async Task UpdateMenuAsync(MenuItem menuItem)</code>
<code>  {</code>
<code>    using var context = _menusContextFactory.CreateDbContext();</code>
<code>    ShowState(context);</code>
<code>    // EntityEntry&lt;MenuItem&gt; entry = context.MenuItems.Attach(m);</code>
<code>    // entry.State = EntityState.Modified;</code>
<code>    context.MenuItems.Update(menuItem);</code>
<code>    ShowState(context);</code>
<code>    await context.SaveChangesAsync();</code>
<code>  }</code>
<code> </code>
<code>  var menuItem = await GetMenuItemsAsync();</code>
<code>  menuItem.Price += 0.7m;</code>
<code> </code>
<code>  await UpdateMenuItemAsync(menuItem);</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">When you run the application with the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UpdateRecordTrackedAsync</code>
                    method, you can see that the state is Modified. The object was detached at first, but because the
                    state was explicitly updated, you can see the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Modified</code> state:
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">当你使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UpdateRecordTrackedAsync</code>
                                方法运行应用程序时，可以看到状态是 Modified。对象最初是分离的，但因为状态被显式更新，你可以看到 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Modified</code>
                                状态：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0116"><code>type: MenuItem, state: Modified, Cheddar Broccoli Soup</code></pre>
            </section>
        </section>
        <section aria-labelledby="head-2-200" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
            <span id="c21-sec-0077" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
            <h2 id="head-2-200" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">CONFLICT HANDLING<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">冲突处理</font>
                    </font>
                </font>
            </h2>
            <p id="c21-para-0232" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">What if multiple users change the same record and then save the
                state? Who will win with the changes?<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">如果多个用户修改同一条记录然后保存状态，谁会赢得更改？ </font>
                    </font>
                </font>
            </p>
            <p id="c21-para-0233" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">If multiple users accessing the same database work on different
                records, there's no conflict. All users can save their data without interfering with data edited by
                other users. If multiple users work on the same record, though, you need to give some thought to
                conflict resolution. You have different ways to deal with this. The easiest one is that <i
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">the last one wins</i>. The
                user saving the data last overwrites changes from the user that previously made changes.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            如果多个用户访问同一数据库但处理不同的记录，则没有冲突。所有用户都可以保存他们的数据而不会干扰其他用户编辑的数据。然而，如果多个用户处理同一记录，就需要考虑冲突解决。你有不同的方法来处理这种情况。最简单的方法是“后保存者胜出”。最后保存数据的用户会覆盖之前修改数据的用户的更改。
                        </font>
                    </font>
                </font>
            </p>
            <p id="c21-para-0234" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">EF Core also offers a way for letting the <i
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">first one win</i>. With this
                option, when saving a record, a verification is needed to see if the data that was originally read is
                still in the database. If this is the case, saving data can continue because no changes occurred between
                reading and writing. However, if the data changed, a conflict resolution needs to be done.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">EF Core
                            还提供了一种让第一个保存者胜出的方法。使用此选项时，在保存记录时需要进行验证，以检查最初读取的数据是否仍然存在于数据库中。如果是这种情况，因为读取和写入之间没有发生更改，所以可以继续保存数据。然而，如果数据发生了变化，就需要进行冲突解决。
                        </font>
                    </font>
                </font>
            </p>
            <p id="c21-para-0235" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">Let's get into these different options.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">让我们来看看这些不同的选项。</font>
                    </font>
                </font>
            </p> <span aria-label="631" epub:type="pagebreak" id="Page_631" role="doc-pagebreak"
                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0078"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-428" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The Last One Wins <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">后一个胜出</font>
                        </font>
                    </font>
                </h3>
                <p id="c21-para-0236" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The default scenario is that the last one saving changes
                    wins. To see multiple accesses to the database, the Intro sample with the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksContext</code> is
                    extended with the new sample project <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ConflictHandling-LastWins</code>.
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">默认情况下，最后一个保存更改的会胜出。为了看到对数据库的多次访问，带
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksContext</code>
                                的入门示例被扩展到新的示例项目 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ConflictHandling-LastWins</code>
                                。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">For an easy simulation of two users, two DI scopes are
                    created with two different <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Runner</code> instances.
                    The <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Runner</code>
                    object injects the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksContext</code> in
                    the constructor. Because every <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Runner</code> object is
                    running in a different DI scope, two different <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksContext</code>
                    objects are created for every runner. The first user invokes <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PrepareUpdateAsync</code>
                    where a <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code>
                    record is retrieved from the database. The same record is retrieved from the second user and invokes
                    <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PrepareUpdateAsync</code>
                    as well. After this, both users invoke the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UpdateAsync</code> method
                    where an updated <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code> object is
                    written to the database. The winner is announced on reading the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code> from the
                    database after all the records have been written (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ConflictHandling-LastWins/Program.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">为了轻松模拟两个用户，创建了两个具有不同 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Runner</code>
                                实例的依赖注入范围。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Runner</code>
                                对象在构造函数中注入 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksContext</code>
                                。因为每个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Runner</code>
                                对象都在不同的依赖注入范围内运行，所以每个运行者都会创建两个不同的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksContext</code>
                                对象。第一个用户调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PrepareUpdateAsync</code>
                                ，从数据库中检索一条 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code>
                                记录。第二个用户也检索相同的记录并调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PrepareUpdateAsync</code>
                                。之后，两个用户都调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UpdateAsync</code>
                                方法，将更新的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code>
                                对象写入数据库。在所有记录都写入数据库后，从数据库中读取 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code>
                                来宣布胜者（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ConflictHandling-LastWins/Program.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0117"><code>using var user1Scope = host.Services.CreateScope();</code>
<code>using var user2Scope = host.Services.CreateScope();</code>
<code>var user1Runner = user1Scope.ServiceProvider.GetRequiredService&lt;Runner&gt;();</code>
<code>var user2Runner = user2Scope.ServiceProvider.GetRequiredService&lt;Runner&gt;();</code>
<code>int bookId = await user1Runner.PrepareUpdateAsync("user1");</code>
<code>await user2Runner.PrepareUpdateAsync("user2");</code>
<code>await user1Runner.UpdateAsync();</code>
<code>await user2Runner.UpdateAsync();</code>
<code> </code>
<code>using var checkScope = host.Services.CreateScope();</code>
<code>var runner = checkScope.ServiceProvider.GetRequiredService&lt;Runner&gt;();</code>
<code>string updatedTitle = await runner.GetUpdatedTitleAsyc(bookId);</code>
<code>Console.Write("this is the winner: ");</code>
<code>Console.WriteLine(updatedTitle);</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PrepareUpdateAsync</code>
                    method behaves differently for the first and second users. With the first user, an <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">id</code> argument is not
                    supplied to the method, so the last record is retrieved from the database and set to the selected
                    book, and the <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">id</code>
                    is returned. The second user uses this <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">id</code> to retrieve the
                    same record from the database and writes it to its own instance of the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">_selectedBook</code>
                    field (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ConflictHandling-LastWins/Runner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PrepareUpdateAsync</code>
                                方法对于第一个和第二个用户的行为不同。对于第一个用户，方法未提供 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">id</code>
                                参数，因此从数据库中检索最后一条记录并将其设置为选定的书籍，然后返回 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">id</code>
                                。第二个用户使用这个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">id</code>
                                从数据库中检索相同的记录，并将其写入其 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">_selectedBook</code>
                                字段的实例（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ConflictHandling-LastWins/Runner.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0118"><code>public async Task&lt;int&gt; PrepareUpdateAsync(string user, int id = 0)</code>
<code>{</code>
<code>  _user = user;</code>
<code>  if (id is 0)</code>
<code>  {</code>
<code>    _selectedBook = await _booksContext.Books.OrderBy(b =&gt; b.BookId).LastAsync();</code>
<code>    return _selectedBook.BookId;</code>
<code>  }</code>
<code>  _selectedBook = await _booksContext.Books.FindAsync(id);</code>
<code>  return id;</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UpdateAsync</code> method
                    makes a change to the selected book and uses the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksContext</code> to
                    save the changes. Remember, this method is invoked two times for each of the two simulated users
                    (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ConflictHandling-LastWins/Runner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UpdateAsync</code>
                                方法对选定的书籍进行更改，并使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksContext</code>
                                保存更改。记住，对于这两个模拟用户，该方法被调用两次（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ConflictHandling-LastWins/Runner.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0119"><code>public async Task UpdateAsync()</code>
<code>{</code>
<code>  if (_selectedBook is null) throw new InvalidOperationException(</code>
<code>    "_selectedBook not set. Invoke PrepareUpdateAsync before UpdateAsync");</code>
<code>  _selectedBook.Title = $"Book updated from {_user}";<span aria-label="632" epub:type="pagebreak" id="Page_632" role="doc-pagebreak"></span></code>
<code>  int records = await _booksContext.SaveChangesAsync();</code>
<code>  if (records == 1)</code>
<code>  {</code>
<code>    Console.WriteLine($"Book {_selectedBook.BookId} updated from {_user}");</code>
<code>  }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">After the two users have been active, the book is retrieved
                    again from the database by using the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">FindAsync</code> method.
                    This resolves which update was finally successful (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ConflictHandling-LastWins/Runner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在两个用户活跃后，再次使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">FindAsync</code>
                                方法从数据库中检索书籍。这解决了哪个更新最终成功（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ConflictHandling-LastWins/Runner.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0120"><code>public async Task&lt;string&gt; GetUpdatedTitleAsyc(int id)</code>
<code>{</code>
<code>  var book = await _booksContext.Books.FindAsync(id);</code>
<code>  return $"{book.Title} with id {book.BookId}";</code>
<code>}</code>
<code>private static void CheckUpdate(int id)</code>
<code>{</code>
<code>  using (var context = new BooksContext())</code>
<code>  {</code>
<code>    Book book = context.Books.Find(id);</code>
<code>    Console.WriteLine($"updated: {book.Title}");</code>
<code>  }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">What happens when you run the application? You see the first
                    update is successful, and so is the second update. When updating a record, it is not verified
                    whether any changes happened after reading the record, which is the case with this sample
                    application. The second update just overwrites the data from the first update, as you can see with
                    the application output:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                运行应用程序时会发生什么？您会看到第一次更新成功，第二次更新也成功。在更新记录时，不会验证读取记录后是否发生了任何更改，这是此示例应用程序的情况。第二次更新只是覆盖了第一次更新的数据，正如应用程序输出所示：
                            </font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0121"><code>database created</code>
<code>Book 100 updated from user1</code>
<code>Book 100 updated from user2</code>
<code>this is the winner: Book updated from user2 with id 100</code></pre>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0079"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-429" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The First One Wins <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">第一个胜出</font>
                        </font>
                    </font>
                </h3>
                <p id="c21-para-0242" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">In the previous sample, you saw the default behavior when
                    updating records. The last one wins. If you need a different behavior, such as the first user's
                    changes being saved to the record, you need to make some changes. The sample project <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ConflictHandling-FirstWins</code>
                    uses the <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code>
                    and <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksContext</code>
                    objects like before, but it deals with the first-one-wins scenario.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                在之前的示例中，你看到了更新记录时的默认行为：最后写入的胜出。如果你需要不同的行为，比如第一个用户的更改被保存到记录中，你需要进行一些修改。示例项目 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ConflictHandling-FirstWins</code>
                                仍然使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Book</code> 和
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BooksContext</code>
                                对象，但它处理的是第一个胜出的场景。</font>
                        </font>
                    </font>
                </p>
                <p id="c21-para-0243" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">For conflict resolution, you need to specify the properties
                    that should be verified if any change happened between reading and updating with a <i
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">concurrency token</i>.
                    Based on the property you specify, the SQL <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UPDATE</code> statement
                    is modified to verify not only for the primary key but also all properties that are marked with the
                    concurrency token. Adding many concurrency tokens to the entity type creates a huge <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">WHERE</code> clause with
                    the <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UPDATE</code>
                    statement, which is not very efficient. Instead, you can add a property that is updated from SQL
                    Server with every creation or updating of a record. You can define a property of type <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">byte[]</code> and mark it
                    with the attribute <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Timestamp</code>. This
                    property is checked for changes, and the update fails if the record changed between reading the
                    record to the context and trying to save it. If you don't want to have this property as a member of
                    the class, you can use a shadow property.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                对于冲突解决，你需要指定在读取和更新时使用并发令牌之间是否发生变化的属性。根据你指定的属性，SQL <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UPDATE</code>
                                语句被修改为不仅验证主键，还验证所有标记了并发令牌的属性。给实体类型添加许多并发令牌会在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UPDATE</code>
                                语句中创建一个巨大的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">WHERE</code>
                                子句，这并不高效。相反，你可以添加一个属性，该属性在每次创建或更新记录时由 SQL Server 更新。你可以定义一个类型为 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">byte[]</code>
                                的属性，并用属性 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Timestamp</code>
                                标记它。这个属性会检查变化，如果记录在读取到上下文和尝试保存之间发生了变化，更新就会失败。如果你不希望这个属性作为类的成员，你可以使用影子属性。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">In the following code snippet, the shadow property <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Timestamp</code> of type
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">byte[]</code> is
                    specified. The SQL Server data type where this is mapped to is of type <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">timestamp</code>. With
                    SQL Server, this is all that's needed for an automatic update. <span aria-label="633"
                        epub:type="pagebreak" id="Page_633" role="doc-pagebreak"
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsRowVersion</code>
                    specifies for EF Core that the original value that's retrieved from the database is verified with
                    the current value from the database. If this is no longer the same when updating, some other
                    activity did an update of this record, and the new update will fail (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ConflictHandling-FirstWins/BooksContext.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在以下代码片段中，指定了类型为 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">byte[]</code>
                                的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Timestamp</code>
                                属性。映射到 SQL Server 数据类型的是类型为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">timestamp</code>
                                的数据类型。对于 SQL Server，这已经足够实现自动更新。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsRowVersion</code>
                                指示 EF Core 需要验证从数据库检索到的原始值是否与数据库中的当前值相同。如果更新时不再相同，则表示其他活动已经更新了该记录，新的更新将失败（代码文件 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ConflictHandling-FirstWins/BooksContext.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0122"><code>protected override void OnModelCreating(ModelBuilder modelBuilder)</code>
<code>{</code>
<code>  var sampleBooks = GetSampleBooks();</code>
<code>  modelBuilder.Entity&lt;Book&gt;().HasData(sampleBooks);</code>
<code> </code>
<code>  // shadow property</code>
<code>  <b>modelBuilder.Entity&lt;Book&gt;().Property&lt;byte[]&gt;("Timestamp")</b></code>
<code>    <b>.HasColumnType("timestamp")</b></code>
<code>    <b>.IsRowVersion();</b> </code>
<code>}</code></pre>
                <p id="c21-para-0245" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsRowVersion</code>
                    method is a combination of <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ValueGeneratedOnAddOrUpdate</code>
                    and <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsConcurrencyToken</code>.
                    The properties marked with <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsConcurrencyToken</code>
                    are verified for original and current values, and <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ValueGeneratedOnAddOrUpdate</code>
                    is the information to EF Core that the value gets updated from the database with add or update
                    statements.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1"> <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsRowVersion</code>
                                方法是 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ValueGeneratedOnAddOrUpdate</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsConcurrencyToken</code>
                                的组合。标记为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsConcurrencyToken</code>
                                的属性会验证原始值和当前值，而 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ValueGeneratedOnAddOrUpdate</code>
                                是通知 EF Core 值将通过添加或更新语句从数据库更新的信息。</font>
                        </font>
                    </font>
                </p>
                <p id="c21-para-0246" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The process of the conflict-handling check is like what was
                    done before. Both user 1 and user 2 invoke the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PrepareUpdateAsync</code>
                    method, change the book title, and call the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UpdateAsync</code> method
                    to make the change in the database.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">冲突处理检查的过程与之前类似。用户 1 和用户 2 都调用了
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PrepareUpdateAsync</code>
                                方法，更改了书名，并调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UpdateAsync</code>
                                方法将更改保存到数据库。</font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">The invocations from the top-level statements and the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PrepareUpdate</code>
                    method are not repeated here; it's the same implementation as with the previous conflict handling
                    sample. The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UpdateAsync</code> method
                    is different. This method now needs to check for the exception of type <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbUpdateConcurrencyException</code>
                    because such exceptions can happen when an update is made by another user. By invoking the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>
                    method now, with all the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UPDATE</code> statements
                    created, you create <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">WHERE</code> clauses to
                    check for all concurrency tokens. As the concurrency token is set on the timestamp, if any user
                    changed any other column, the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UPDATE</code> fails.
                    Within the handler of the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UIpdateConcurrencyException</code>,
                    information about the failing records is shown (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ConflictHandling-FirstWins/Runner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">来自顶层语句和 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PrepareUpdate</code>
                                方法的调用在此不再重复；它与之前的冲突处理示例使用相同的实现。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UpdateAsync</code>
                                方法不同。此方法现在需要检查类型为 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbUpdateConcurrencyException</code>
                                的异常，因为当其他用户进行更新时可能会发生此类异常。通过现在调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>
                                方法，并创建所有 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UPDATE</code>
                                语句，你将创建 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">WHERE</code>
                                子句来检查所有并发令牌。由于并发令牌是在时间戳上设置的，如果任何用户更改了其他列， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UPDATE</code>
                                将失败。在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">UIpdateConcurrencyException</code>
                                的处理程序中，会显示失败记录的信息（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ConflictHandling-FirstWins/Runner.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0123"><code>public async Task UpdateAsync()</code>
<code>{</code>
<code>  if (_selectedBook is null || _user is null) </code>
<code>    throw new InvalidOperationException(</code>
<code>      "_selectedBook not set. Invoke PrepareUpdateAsync before UpdateAsync");</code>
<code> </code>
<code>  try</code>
<code>  {</code>
<code>    _selectedBook.Title = $"Book updated from {_user}";</code>
<code>    int records = await _booksContext.SaveChangesAsync();</code>
<code>    if (records == 1)</code>
<code>    {</code>
<code>      Console.WriteLine($"Book {_selectedBook.BookId} updated from {_user}");</code>
<code>    }</code>
<code>  }</code>
<code>  catch (DbUpdateConcurrencyException ex)</code>
<code>  {</code>
<code>    Console.WriteLine($"{_user}: update failed with {_selectedBook.Title}");</code>
<code>    Console.WriteLine($"error: {ex.Message}");<span aria-label="634" epub:type="pagebreak" id="Page_634" role="doc-pagebreak"></span></code>
<code>    foreach (var entry in ex.Entries)</code>
<code>    {</code>
<code>      if (entry.Entity is Book b)</code>
<code>      {</code>
<code>        PropertyEntry pe = entry.Property("TimeStamp");</code>
<code>        Console.WriteLine($"{b.Title} {BitConverter.ToString((byte[])pe.CurrentValue)}");</code>
<code>        ShowChanges(_selectedBook.BookId, _booksContext.Entry(_selectedBook));</code>
<code>      }</code>
<code>    }</code>
<code>  }</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">With objects that are associated with the context, you can
                    access the original values and the current values with a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PropertyEntry</code>
                    object. The original values that were retrieved when reading the object from the database can be
                    accessed with the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OriginalValue</code>
                    property, and the current values can be accessed with the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CurrentValue</code>
                    property. The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PropertyEntry</code>
                    object can be accessed with the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Property</code> method of
                    an <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EntityEntry</code>
                    as shown in the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ShowChanges</code> and
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ShowChange</code>
                    methods (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ConflictHandling-FirstWins/Runner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">对于与上下文关联的对象，你可以使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PropertyEntry</code>
                                对象访问原始值和当前值。从数据库中读取对象时检索的原始值可以通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OriginalValue</code>
                                属性访问，当前值可以通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CurrentValue</code>
                                属性访问。可以使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EntityEntry</code>
                                的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Property</code>
                                方法访问 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">PropertyEntry</code>
                                对象，如 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ShowChanges</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ShowChange</code>
                                方法（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ConflictHandling-FirstWins/Runner.cs</code>
                                ）所示：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0124"><code>private void ShowChanges(int id, EntityEntry entity)</code>
<code>{</code>
<code>  static void ShowChange(PropertyEntry propertyEntry, int id) =&gt;</code>
<code>    Console.WriteLine($"id: {id}, current: {propertyEntry.CurrentValue}, " +</code>
<code>      $"original: {propertyEntry.OriginalValue}, " +</code>
<code>      $"modified: {propertyEntry.IsModified}");</code>
<code> </code>
<code>  ShowChange(entity.Property("Title"), id);</code>
<code>  ShowChange(entity.Property("Publisher"), id);</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">When you run the application, you can see output such as the
                    following. The timestamp values and book IDs differ with every run. The first user updates the book
                    with the original title <i
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">sample book</i> to the
                    new title <i data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">user 1 wins</i>.
                    The <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsModified</code>
                    property returns true for the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Title</code> property but
                    false for the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Publisher</code> property
                    because only the title changes. The original timestamp ends with 1.1.209; after the update to the
                    database, the timestamp changes to 1.17.114. In the meantime, user 2 opens the same record; this
                    book still has a timestamp of 1.1.209. User 2 updates this book, but here the update fails because
                    the timestamp of this book does not match the timestamp from the database. Here, an exception of
                    type <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbUpdateConcurrencyException</code>
                    is thrown. In the exception handler, the reason for the exception is written to the console, as you
                    can see in the program output:<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">运行应用程序时，您可以看到如下输出。时间戳值和书籍 ID
                                每次运行都不同。第一个用户将书籍原标题"sample book"更新为"用户 1 获胜"。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IsModified</code>
                                属性对 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Title</code>
                                属性返回 true，但对 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Publisher</code>
                                属性返回 false，因为只有标题发生了变化。原始时间戳以 1.1.209 结尾；更新数据库后，时间戳变为 1.17.114。与此同时，用户 2
                                打开同一条记录；这本书仍然有时间戳 1.1.209。用户 2 更新这本书，但在这里更新失败，因为这本书的时间戳与数据库中的时间戳不匹配。这里抛出了类型为 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbUpdateConcurrencyException</code>
                                的异常。在异常处理程序中，异常的原因被写入控制台，正如程序输出所示：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0125"><code>Book 100 updated from user1</code>
<code>user2: update failed with Book updated from user2</code>
<code>error: Database operation expected to affect 1 row(s) but actually affected 0 row(s). </code>
<code>Data may have been modified or deleted since entities were loaded. </code>
<code>See http://go.microsoft.com/fwlink/?LinkId=527962 for information on understanding </code>
<code>and handling optimistic concurrency exceptions.</code>
<code>Book updated from user2 00-00-00-00-00-00-08-35</code>
<code>id: 100, current: Book updated from user2, original: title 100, modified: True</code>
<code>id: 100, current: sample, original: sample, modified: False</code>
<code>this is the winner: Book updated from user1 with id 100</code></pre>
                <p id="c21-para-0250" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">When using concurrency tokens and handling the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbConcurrencyException</code>,
                    you can deal with concurrency conflicts as needed. You can, for example, automatically resolve
                    concurrency issues. If different properties are changed, you can retrieve the changed record and
                    merge the changes. If the property changed is a number where you do some calculations—for example, a
                    point system—you can increment or decrement the values from both <span aria-label="635"
                        epub:type="pagebreak" id="Page_635" role="doc-pagebreak"
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>updates and just
                    throw an exception if a limit is reached. You can also ask the user to resolve the concurrency issue
                    by giving the user the information that's currently in the database and ask what changes they would
                    like to make. Just don't ask too much from the user. It's likely that the only thing the user wants
                    is to get rid of this rarely shown dialog, which means they might click OK or Cancel without reading
                    the content. For rare conflicts, you can also write logs and inform the system administrator that an
                    issue needs to be resolved.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在使用并发令牌和处理 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbConcurrencyException</code>
                                时，你可以根据需要处理并发冲突。例如，你可以自动解决并发问题。如果不同属性被更改，你可以检索已更改的记录并合并更改。如果更改的属性是一个数字，你进行一些计算——例如，积分系统——你可以从两个更新中增加或减少值，如果达到限制则抛出异常。你也可以要求用户通过提供数据库中当前的信息并询问他们希望做出哪些更改来解决并发问题。只是不要对用户要求太多。用户可能唯一想要的是摆脱这个很少显示的对话框，这意味着他们可能会在阅读内容之前点击“确定”或“取消”。对于罕见的冲突，你也可以记录日志并通知系统管理员需要解决问题。
                            </font>
                        </font>
                    </font>
                </p>
            </section>
        </section>
        <section aria-labelledby="head-2-201" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
            <span id="c21-sec-0080" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
            <h2 id="head-2-201" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">USING TRANSACTIONS<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">使用事务</font>
                    </font>
                </font>
            </h2>
            <p id="c21-para-0251" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">With every access of the database, a transaction is involved,
                too. You can use transactions implicitly or create them explicitly with configurations as needed. The
                sample project used with this section demonstrates transactions in multiple ways. Here, the <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Menu</code>, <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>, and <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuContext</code> classes
                are used, as shown earlier with the <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Tracking</code> project.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            每次访问数据库时，都会涉及事务。你可以隐式使用事务，也可以根据需要显式创建它们。本节使用的示例项目展示了多种事务用法。这里使用了前面提到的 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Menu</code> 、
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code> 和
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuContext</code>
                            类。</font>
                    </font>
                </font>
            </p>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0081"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-430" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Using Implicit Transactions <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用隐式事务 </font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">An invocation of the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>
                    method automatically resolves to one transaction. If one part of the changes that need to be made
                    fails—for example, because of a database constraint—all the changes already made are rolled back.
                    This is demonstrated with the following code snippet. Here, the first <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code> (<code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">m1</code>) is created
                    with valid data. A reference to an existing <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code> is done
                    by supplying the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCardId</code>. After
                    the update succeeds, the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code> property
                    of the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem m1</code> is
                    filled automatically. However, the second <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code> created,
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">mInvalid</code>,
                    references an invalid menu card by supplying a <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCardId</code> that
                    does not exist in the database. Because of the defined foreign key relation between <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code> and <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>, adding
                    this object will fail (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Transactions/Runtime.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">调用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>
                                方法会自动解析为一个事务。如果需要进行的更改的一部分失败——例如，由于数据库约束——所有已进行的更改都会回滚。以下代码片段展示了这一点。这里，第一个 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                ( <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">m1</code> )
                                使用有效数据创建。通过提供 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCardId</code>
                                引用现有的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                                。更新成功后， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem m1</code>
                                的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                                属性会自动填充。然而，创建的第二个 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                ， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">mInvalid</code>
                                ，通过提供一个数据库中不存在的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCardId</code>
                                引用无效的菜单卡。由于 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                                之间定义的外键关系，添加此对象将失败（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Transactions/Runtime.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0126"><code>public async Task AddTwoRecordsWithOneTxAsync()</code>
<code>{</code>
<code>  Console.WriteLine(nameof(AddTwoRecordsWithOneTxAsync));</code>
<code>  try</code>
<code>  {</code>
<code>    using var context = _menusContextFactory.CreateDbContext();</code>
<code>    var card = context.MenuCards.OrderBy(mc =&gt; mc.MenuCardId).First();</code>
<code>    MenuItem m1 = new("added")</code>
<code>    {</code>
<code>      MenuCardId = card.MenuCardId,</code>
<code>      Price = 99.99m</code>
<code>    };</code>
<code> </code>
<code>    var notExistingCard = Guid.NewGuid();</code>
<code>    MenuItem mInvalid = new("invalid")</code>
<code>    {</code>
<code>      MenuCardId = notExistingCard,</code>
<code>      Price = 999.99m</code>
<code>    };</code>
<code>    context.MenuItems.AddRange(m1, mInvalid);</code>
<code>    int records = await context.SaveChangesAsync();</code>
<code>    Console.WriteLine($"{records} records added");</code>
<code>  }</code>
<code>  catch (DbUpdateException ex)</code>
<code>  {</code>
<code>    Console.WriteLine($"{ex.Message}");</code>
<code>    Console.WriteLine($"{ex.InnerException?.Message}");<span aria-label="636" epub:type="pagebreak" id="Page_636" role="doc-pagebreak"></span></code>
<code>  }</code>
<code>  Console.WriteLine();</code>
<code>}</code></pre>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">After running the application to invoke the method <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">AddTwoRecordsWithOneTxAsync</code>,
                    you can verify the content of the database to see that not a single record was added. The exception
                    message and the message of the inner exception give the details:<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">运行应用程序以调用方法 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">AddTwoRecordsWithOneTxAsync</code>
                                后，可以验证数据库内容，发现没有任何记录被添加。异常消息和内部异常的消息提供了详细信息：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0127"><code>An exception occurred in the database while saving changes for context type 'MenusContext'.</code>
<code>Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while updating </code>
<code>the entries. See the inner exception for details.</code>
<code>---&gt; Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement </code>
<code>conflicted with the FOREIGN KEY constraint "FK_MenuItems_MenuCards_MenuCardId". </code>
<code>The conflict occurred in database "ProCSharpTransactions", table "mc.MenuCards", </code>
<code>column 'MenuCardId'.</code>
<code>      The statement has been terminated.</code></pre>
                <p id="c21-para-0254" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">If writing the first record to the database should be
                    successful even if the second record write fails, you must invoke the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>
                    method multiple times.<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                如果希望即使第二次记录写入失败，第一次记录也能成功写入数据库，就必须多次调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>
                                方法。</font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0082"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-431" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Creating Explicit Transactions <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">显式事务创建</font>
                        </font>
                    </font>
                </h3>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Instead of using implicitly created transactions, you can
                    also create them explicitly. This gives you the advantage of having the option to roll back in case
                    some of your business logic fails, and you can combine multiple invocations of <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>
                    within one transaction. To start a transaction that is associated with the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                    -derived class, you need to invoke the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BeginTransactionAsync</code>
                    method of the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DatabaseFacade</code>
                    class that is returned from the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Database</code> property.
                    The transaction returned implements the interface <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IDbContextTransaction</code>.
                    The SQL statements made with the associated <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code> are
                    enlisted with the transaction. To commit or roll back, you must explicitly invoke the methods <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Commit</code> or <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Rollback</code>. In the
                    sample code, <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Commit</code> is done
                    when the end of the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code> scope is
                    reached; <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Rollback</code> is done
                    in cases where an exception occurs (code file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Transactions/Runner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">
                                与其使用隐式创建的事务，你也可以显式创建它们。这让你在业务逻辑中某些部分失败时能够回滚，并且可以将多个 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>
                                调用组合在一个事务中。要启动与 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                                派生类相关联的事务，你需要调用从 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Database</code>
                                属性返回的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DatabaseFacade</code>
                                类的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">BeginTransactionAsync</code>
                                方法。返回的事务实现了 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">IDbContextTransaction</code>
                                接口。使用相关联的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                                进行的 SQL 语句被包含在事务中。要提交或回滚，你必须显式调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Commit</code>
                                或 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Rollback</code>
                                方法。在示例代码中， <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Commit</code>
                                在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                                范围结束时执行； <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Rollback</code>
                                在发生异常时执行（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Transactions/Runner.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0128"><code>public async Task TwoSaveChangesWithOneTxAsync()</code>
<code>{</code>
<code>  Console.WriteLine(nameof(TwoSaveChangesWithOneTxAsync));</code>
<code>  using var context = _menusContextFactory.CreateDbContext();</code>
<code>  <b>using var tx = await context.Database.BeginTransactionAsync();</b></code>
<code>  try</code>
<code>  {</code>
<code>    var card = context.MenuCards.First();</code>
<code>    MenuItem m1 = new("added with explicit tx")</code>
<code>    {</code>
<code>      MenuCardId = card.MenuCardId,</code>
<code>      Price = 99.99m</code>
<code>    };</code>
<code>    context.MenuItems.Add(m1);</code>
<code>    <b>int records = await context.SaveChangesAsync();</b></code>
<code>    Console.WriteLine($"{records} records added");</code>
<code> </code>
<code>    var notExistingCard = Guid.NewGuid();</code>
<code>    MenuItem mInvalid = new("invalid")</code>
<code>    {</code>
<code>      MenuCardId = notExistingCard,<span aria-label="637" epub:type="pagebreak" id="Page_637" role="doc-pagebreak"></span></code>
<code>      Price = 999.99m</code>
<code>    };</code>
<code>    context.MenuItems.Add(mInvalid);</code>
<code>    <b>records = await context.SaveChangesAsync();</b></code>
<code> </code>
<code>    Console.WriteLine($"{records} records added");</code>
<code>    tx.Commit();</code>
<code>  }</code>
<code>  catch (DbUpdateException ex)</code>
<code>  {</code>
<code>    Console.WriteLine($"{ex.Message}");</code>
<code>    Console.WriteLine($"{ex.InnerException?.Message}");</code>
<code>    Console.WriteLine("rolling back…");</code>
<code>    tx?.Rollback();</code>
<code>  }</code>
<code>  Console.WriteLine();</code>
<code>}</code></pre>
                <p id="c21-para-0256" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">When you run the application, you can see that no records
                    have been added, although the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>
                    method was invoked multiple times. The first return of <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>
                    lists one record as being added, but this record is removed because of the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Rollback</code> later.
                    Depending on the setting of the isolation level, the updated record can be seen only within the
                    transaction before the rollback was done but not outside the transaction.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">运行应用程序时，你会发现尽管 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>
                                方法被多次调用，但没有记录被添加。第一次返回的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">SaveChangesAsync</code>
                                列表了一个被添加的记录，但由于后续的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Rollback</code>
                                操作，该记录被移除了。根据隔离级别的设置，更新后的记录在回滚前的事务内可见，但在事务外不可见。</font>
                        </font>
                    </font>
                </p>
            </section>
            <section data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span id="c21-sec-0083"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
                <h3 id="head-3-432" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">Using Ambient Transactions <font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">使用环境事务</font>
                        </font>
                    </font>
                </h3>
                <p id="c21-para-0257" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">An easy option to deal with transactions is to use ambient
                    transactions from the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">System.Transactions</code>
                    namespace. An ambient transaction is a transaction set to the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Transaction.Current</code>
                    property. Every resource that supports ambient transactions joins the transaction by enlisting to
                    it. ADO.NET and EF Core with SQL Server supports ambient transactions and automatically enlists to
                    this transaction. Every resource that enlisted to this transaction can fail it. If every resource
                    sets the “happy bit,” which means the transactional outcome for this resource is successful and the
                    transaction-scope is successful as well, the transaction gets completed. If any resource that has
                    enlisted did not grant success, when the scope is complete, the transaction rolls back.<font
                        class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">处理事务的一个简单选项是使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">System.Transactions</code>
                                命名空间中的环境事务。环境事务是指设置在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Transaction.Current</code>
                                属性中的事务。支持环境事务的每个资源都会通过加入该事务来参与其中。ADO.NET 和使用 SQL Server 的 EF Core
                                支持环境事务，并自动加入此事务。加入此事务的每个资源都可以使其失败。如果每个资源都设置了“快乐位”，这意味着该资源的交易结果是成功的，并且事务作用域也是成功的，那么事务就会完成。如果加入事务的任何资源没有成功，当作用域完成时，事务会回滚。
                            </font>
                        </font>
                    </font>
                </p>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">You can create an ambient transaction by creating a new <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">TransactionScope</code>.
                    Depending on the parameters used, this sets the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Transaction.Current</code>
                    property to a transaction. With the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">TransactionScopeOption</code>
                    enum type, you can specify <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Required</code>, <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">RequiresNew</code>, and
                    <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Suppress</code>
                    :<font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">您可以通过创建一个新的 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">TransactionScope</code>
                                来创建环境事务。根据所使用的参数，这会将 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Transaction.Current</code>
                                属性设置为事务。使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">TransactionScopeOption</code>
                                枚举类型，您可以指定 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Required</code>
                                、 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">RequiresNew</code>
                                和 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Suppress</code>
                                ：</font>
                        </font>
                    </font>
                </p>
                <ul class="check" id="c21-list-0007"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <li id="c21-li-0037" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                        data-immersive-translate-paragraph="1"><code
                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Required</code>
                        specifies a transaction is required. If one transaction is already set, this transaction is
                        used. If no transaction is available, a new transaction is created.<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1"> <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Required</code>
                                    指定需要一个事务。如果已经设置了事务，则使用该事务。如果没有可用的事务，则创建一个新的事务。</font>
                            </font>
                        </font>
                    </li>
                    <li id="c21-li-0038" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                        data-immersive-translate-paragraph="1"><code
                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">RequiresNew</code>
                        always creates a new transaction that is independent of a transaction that's already active.
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1"> <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">RequiresNew</code>
                                    总是创建一个独立于已激活事务的新事务。</font>
                            </font>
                        </font>
                    </li>
                    <li id="c21-li-0039" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                        data-immersive-translate-paragraph="1">With the <code
                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Suppress</code>
                        option, you specify that this scope should not have a transaction.<font
                            class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">使用 <code
                                        xmlns="http://www.w3.org/1999/xhtml"
                                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Suppress</code>
                                    选项，您指定此作用域不应有事务。</font>
                            </font>
                        </font>
                    </li>
                </ul>
                <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                    data-immersive-translate-paragraph="1">In the following code snippet, with <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">TransactionScopeOption.Required</code>,
                    a new transaction will exist while the variable scope is active. With the second argument, <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">TransactionScopeAsyncFlowOption.Enabled</code>,
                    you specify that the transaction flows across different threads, which is required in an
                    asynchronous method. Otherwise, you need to run in the same thread when starting and completing the
                    transaction, which is not the case when async methods are used without a synchronization context.
                    When the root transaction scope is disposed of (with the sample code, the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">scope</code> variable
                    represents the root scope because this was the first ambient transaction created), the outcome of
                    the transaction is resolved. The <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">scope</code> variable is
                    disposed of at the end of the method <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">AmbientTransactionsAsync</code>.
                    The scope itself must set the “happy bit,” which is done by invoking the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Complete</code> method of
                    the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">TransactionScope</code>.
                    This method is invoked at the end of the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">try</code> code block. If
                    any exception is <span aria-label="638" epub:type="pagebreak" id="Page_638" role="doc-pagebreak"
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>thrown, the
                    exception is aborted, no matter whether the database transactions would be successful. You can try
                    this by using successful database operations and not invoking the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Complete</code> method.
                    To see the outcome of the transaction, the <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">TransactionCompleted</code>
                    event is fired. Within this handler, the status of the transaction is written to the console (code
                    file <code
                        data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Transactions/Runner.cs</code>):
                    <font class="notranslate immersive-translate-target-wrapper"
                        data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                        <font
                            class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                            data-immersive-translate-translation-element-mark="1">
                            <font
                                class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                data-immersive-translate-translation-element-mark="1">在以下代码片段中，使用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">TransactionScopeOption.Required</code>
                                时，在变量作用域内将存在一个新的事务。使用第二个参数 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">TransactionScopeAsyncFlowOption.Enabled</code>
                                时，你指定事务将跨不同线程流动，这在异步方法中是必需的。否则，你需要在开始和完成事务时运行在同一线程上，而异步方法在不使用同步上下文时则不是这种情况。当根事务作用域被销毁时（在示例代码中，
                                <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">scope</code>
                                变量代表根作用域，因为这是创建的第一个环境事务），事务的结果将被确定。 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">scope</code>
                                变量在方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">AmbientTransactionsAsync</code>
                                结束时被销毁。作用域本身必须设置“快乐位”，这是通过调用 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">TransactionScope</code>
                                的 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Complete</code>
                                方法来完成的。该方法在 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">try</code>
                                代码块结束时被调用。如果抛出任何异常，无论数据库事务是否成功，异常都会被中止。你可以通过使用成功的数据库操作并且不调用 <code
                                    xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Complete</code>
                                方法来尝试这一点。要查看事务的结果，会触发 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">TransactionCompleted</code>
                                事件。 在这个处理器中，事务的状态被写入控制台（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Transactions/Runner.cs</code>
                                ）：</font>
                        </font>
                    </font>
                </p>
                <pre id="c21-code-0129"><code>public async Task AmbientTransactionsAsync()</code>
<code>{</code>
<code>  Console.WriteLine(nameof(AmbientTransactionsAsync));</code>
<code> </code>
<code>  <b>using var scope = new TransactionScope(TransactionScopeOption.Required,</b> </code>
<code>    <b>TransactionScopeAsyncFlowOption.Enabled);</b></code>
<code> </code>
<code>  if (Transaction.Current is null) throw new InvalidOperationException(</code>
<code>    "no ambient transaction available");</code>
<code>  <b>Transaction.Current.TransactionCompleted += (sender, e) =&gt;</b></code>
<code>  <b>{</b></code>
<code>    <b>var ti = e.Transaction?.TransactionInformation;</b></code>
<code>    <b>Console.WriteLine($"transaction completed with status: " +</b></code>
<code>      <b>$"{ti?.Status}, identifier: {ti?.LocalIdentifier}");</b></code>
<code>  <b>};</b></code>
<code> </code>
<code>  using var context = _menusContextFactory.CreateDbContext();</code>
<code>  try</code>
<code>  {</code>
<code>    var card = context.MenuCards.First();</code>
<code>    MenuItem m1 = new("added with explicit tx")</code>
<code>    {</code>
<code>      MenuCardId = card.MenuCardId,</code>
<code>      Price = 99.99m</code>
<code>    };</code>
<code>    context.MenuItems.Add(m1);</code>
<code>    int records = await context.SaveChangesAsync();</code>
<code>    Console.WriteLine($"{records} records added");</code>
<code> </code>
<code>    var notExistingCard = Guid.NewGuid();</code>
<code>    MenuItem mInvalid = new("invalid")</code>
<code>    {</code>
<code>      MenuCardId = notExistingCard,</code>
<code>      Price = 999.99m</code>
<code>    };</code>
<code>    context.MenuItems.Add(mInvalid);</code>
<code>    records = await context.SaveChangesAsync();</code>
<code> </code>
<code>    Console.WriteLine($"{records} records added");</code>
<code>    <b>scope.Complete();</b></code>
<code>  }</code>
<code>  catch (DbUpdateException ex)</code>
<code>  {</code>
<code>    Console.WriteLine($"{ex.Message}");</code>
<code>    Console.WriteLine($"{ex.InnerException?.Message}");</code>
<code>  }</code>
<code>  Console.WriteLine();</code>
<code>}</code></pre>
            </section>
        </section> <span aria-label="639" epub:type="pagebreak" id="Page_639" role="doc-pagebreak"
            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
        <section aria-labelledby="head-2-202" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
            <span id="c21-sec-0084" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
            <h2 id="head-2-202" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">USING AZURE COSMOS DB<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">使用 Azure Cosmos DB</font>
                    </font>
                </font>
            </h2>
            <p id="c21-para-0260" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">Azure Cosmos DB (<code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><a href="https://azure.microsoft.com/services/cosmos-db/">https://azure.microsoft.com/services/cosmos-db/</a></code>)
                is a NoSQL database offering from Microsoft that allows storing various types of data. You can use Azure
                Cosmos DB for key-value, column-family, documents, and graph data. You can also use different APIs to
                access your data: SQL, Cassandra, MongoDB, and Gremlin. However, the API depends also on the data you
                store. For example, Gremlin is only used for graph data. EF Core supports only document-based storage
                with SQL.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">Azure Cosmos DB ( <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><a href="https://azure.microsoft.com/services/cosmos-db/">https://azure.microsoft.com/services/cosmos-db/</a></code>
                            ) 是微软提供的 NoSQL 数据库服务，可用于存储各种类型的数据。您可以使用 Azure Cosmos DB 存储键值对、列族、文档和图形数据。您还可以使用不同的 API
                            访问您的数据：SQL、Cassandra、MongoDB 和 Gremlin。然而，API 的选择也取决于您存储的数据类型。例如，Gremlin 仅用于图形数据。EF Core
                            仅支持基于 SQL 的文档存储。</font>
                    </font>
                </font>
            </p>
            <p id="c21-para-0261" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">No matter what APIs or kind of data you use, Azure Cosmos DB
                offers tunable throughput guarantees with a multimaster distribution model to write data
                concurrently—for example, in the United States and Asia. For small production workloads, a free tier is
                available.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">无论您使用哪种 API 或数据类型，Azure Cosmos DB
                            都提供可调节的吞吐量保证，并采用多主分布式模型来并发写入数据——例如，在美国和亚洲。对于小型生产工作负载，提供免费层级。</font>
                    </font>
                </font>
            </p>
            <p id="c21-para-0262" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">To use the sample application, you need to create an SQL version
                of Azure Cosmos DB. You can use the free offering in Microsoft Azure or install a local emulator (<code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><a href="https://docs.microsoft.com/azure/cosmos-db/local-emulator">https://docs.microsoft.com/azure/cosmos-db/local-emulator</a></code>).
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">要使用示例应用程序，您需要创建一个 SQL 版本的 Azure Cosmos
                            DB。您可以使用 Microsoft Azure 中的免费服务，或安装本地模拟器 ( <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><a href="https://docs.microsoft.com/azure/cosmos-db/local-emulator">https://docs.microsoft.com/azure/cosmos-db/local-emulator</a></code>
                            )。</font>
                    </font>
                </font>
            </p>
            <p id="c21-para-0263" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">Although you can use EF Core to access your NoSQL database and
                don't need to learn a new API, there are some important differences. For example, you don't have tables
                with relations among them. Instead, you can group your documents within containers. In a container, you
                can store a lot of different document types because a container is not restricted to a particular schema
                for specific object types.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">尽管你可以使用 EF Core 来访问你的 NoSQL
                            数据库，并且不需要学习新的
                            API，但存在一些重要的差异。例如，你不需要具有相互之间关系的表。相反，你可以在容器中分组你的文档。在一个容器中，你可以存储很多不同类型的文档，因为容器不受特定对象类型的特定模式限制。
                        </font>
                    </font>
                </font>
            </p>
            <p id="c21-para-0264" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">When creating a database, Azure allocates compute and storage
                resources, which are called <i
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">physical partitions</i>.
                Within a physical partition, logical partitions are used. A logical partition is limited to 20 GB. The
                number of logical partitions you can have is unlimited. If your storage needs exceed 20 GB, the data
                needs to be spread across multiple logical partitions. A transaction cannot span logical partitions.
                When working with documents, it's best to have one query within one partition. This increases
                performance and reduces cost. If your query spreads across multiple partitions, more RUs are needed.
                With a partition key, you can specify how to spread the data between logical partitions. See <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><a href="https://docs.microsoft.com/azure/cosmos-db/partitioning-overview">https://docs.microsoft.com/azure/cosmos-db/partitioning-overview</a></code>
                for details.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">在创建数据库时，Azure
                            分配计算和存储资源，这些资源被称为物理分区。在一个物理分区中，使用逻辑分区。逻辑分区限制在 20 GB。你可以拥有的逻辑分区数量是无限的。如果你的存储需求超过 20
                            GB，数据需要分布在多个逻辑分区上。事务不能跨越逻辑分区。在处理文档时，最好在一个分区中有一个查询。这可以提高性能并降低成本。如果你的查询跨越多个分区，则需要更多的
                            RUs。通过分区键，你可以指定如何将数据分布在逻辑分区之间。详情请参考 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><a href="https://docs.microsoft.com/azure/cosmos-db/partitioning-overview">https://docs.microsoft.com/azure/cosmos-db/partitioning-overview</a></code>
                            。</font>
                    </font>
                </font>
            </p>
            <p id="c21-para-0265" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">Next, let's adapt a previous sample to store menu cards and menus
                to be used with Azure Cosmos DB.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">接下来，让我们修改一个之前的示例，以存储用于与 Azure Cosmos
                            DB 一起使用的菜单卡和菜单。</font>
                    </font>
                </font>
            </p>
            <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">The NuGet package needed to use the Azure Cosmos DB provider for
                EF Core is <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Microsoft.EntityFrameworkCore.Cosmos</code>.
                To run the sample application locally, you need to supply the connection string to the Azure Cosmos DB
                database with the user secrets, as shown here:<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">要使用 EF Core 的 Azure Cosmos DB 提供程序，需要
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Microsoft.EntityFrameworkCore.Cosmos</code>
                            NuGet 包。要在本地运行示例应用程序，您需要通过用户密钥提供 Azure Cosmos DB 数据库的连接字符串，如下所示：</font>
                    </font>
                </font>
            </p>
            <pre id="c21-code-0130"><code>{</code>
<code>  "ConnectionStrings": {</code>
<code>    "MenusConnection": </code>
<code>      "AccountEndpoint=… add the connection string to your Azure Cosmos account"</code>
<code>  }</code>
<code>}</code></pre>
            <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">To activate user secrets, you also need to enable the development
                environment by setting the <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DOTNET_ENVIRONMENT</code>
                environment variable to <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Development</code>. The <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CreateDefaultBuilder</code>
                method of the <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Host</code>
                class configures user secrets when this environment variable is set (configuration file <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Cosmos/Properties/launchSettings.json</code>):
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">要激活用户密钥，您还需要通过将 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DOTNET_ENVIRONMENT</code>
                            环境变量设置为 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Development</code>
                            来启用开发环境。 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Host</code> 类的
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">CreateDefaultBuilder</code>
                            方法在设置此环境变量时配置用户密钥（配置文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Cosmos/Properties/launchSettings.json</code>
                            ）：</font>
                    </font>
                </font>
            </p>
            <pre id="c21-code-0131"><code>{</code>
<code>  "profiles": {</code>
<code>    "Cosmos": {</code>
<code>      "commandName": "Project",</code>
<code>      "environmentVariables": {</code>
<code>        "DOTNET_ENVIRONMENT": "Development"</code>
<code>      }</code>
<code>    }</code>
<code>  }</code>
<code>}</code></pre>
            <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"><span aria-label="640"
                    epub:type="pagebreak" id="Page_640" role="doc-pagebreak"
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span></p>
            <aside data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                <div class="top hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <hr />
                </div>
                <section class="feature2" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                    <p id="c21-para-0269" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                        data-immersive-translate-paragraph="1"><b
                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">NOTE</b> <i
                            data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Read <a
                                href="c15.xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Chapter 15</a>,
                            “Dependency Injection and Configuration,” for detailed information on configuration as well
                            as how to configure secrets with Microsoft Azure App Configuration.</i>
                        <font class="notranslate immersive-translate-target-wrapper"
                            data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                            <font
                                class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                                data-immersive-translate-translation-element-mark="1">
                                <font
                                    class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                                    data-immersive-translate-translation-element-mark="1">注意 有关配置的详细信息以及如何使用 Microsoft
                                    Azure App Configuration 配置密钥，请参阅第 15 章，“依赖注入和配置”。</font>
                            </font>
                        </font>
                    </p>
                    <div class="bottom hr" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
                        <hr />
                    </div>
                </section>
            </aside>
            <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">Now the DI container needs can be configured. The connection
                string to the Azure Cosmos DB account is retrieved from the .NET configuration. Also, a restaurant
                identifier is retrieved from configuration. This restaurant identifier will be used as a partition key.
                Imagine multiple restaurants storing their menu cards within one database. The restaurant identifier is
                a good option for a partition key (code file <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Cosmos/Program.cs</code>):
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">现在可以配置依赖注入容器的需求。从.NET 配置中获取 Azure
                            Cosmos DB
                            账户的连接字符串。此外，从配置中获取一个餐厅标识符。这个餐厅标识符将用作分区键。想象多个餐厅在一个数据库中存储他们的菜单卡。餐厅标识符是一个很好的分区键选项（代码文件 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Cosmos/Program.cs</code>
                            ）：</font>
                    </font>
                </font>
            </p>
            <pre id="c21-code-0132"><code>using var host = Host.CreateDefaultBuilder(args)</code>
<code>  .ConfigureServices((context, services) =&gt;</code>
<code>  {</code>
<code>    var connectionString = context.Configuration.GetConnectionString("MenusConnection");</code>
<code>    var restaurantSettings = context.Configuration.GetSection("RestaurantConfiguration");</code>
<code> </code>
<code>    services.Configure&lt;RestaurantConfiguration&gt;(restaurantSettings);</code>
<code>    services.AddDbContext&lt;MenusContext&gt;(options =&gt;</code>
<code>    {</code>
<code>      <b>options.UseCosmos(connectionString, "ProCSharpMenus1");</b></code>
<code>    });</code>
<code>    services.AddScoped&lt;Runner&gt;();</code>
<code>  })</code>
<code>  .Build();</code></pre>
            <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">The <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code> class looks
                similar to the <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code> class
                specified earlier. Here, the <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">RestaurantId</code> is
                defined as well. The partition key needs to be a string (code file <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Cosmos/MenuCard.cs</code>):
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1"> <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                            类与之前指定的 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                            类看起来相似。这里也定义了 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">RestaurantId</code>
                            。分区键需要是一个字符串（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Cosmos/MenuCard.cs</code>
                            ）：</font>
                    </font>
                </font>
            </p>
            <pre id="c21-code-0133"><code>public class MenuCard</code>
<code>{</code>
<code>  public MenuCard(string title, string restaurantId, Guid menuCardId = default) </code>
<code>    =&gt; (Title, RestaurantId, MenuCardId) = (title, restaurantId, menuCardId);</code>
<code> </code>
<code>  public Guid MenuCardId { get; set; }</code>
<code>  public string Title { get; set; }</code>
<code>  public ICollection&lt;MenuItem&gt; MenuItems { get; internal set; } = new HashSet&lt;MenuItem&gt;();</code>
<code>  public string RestaurantId { get; set; }</code>
<code>  public bool IsActive { get; set; } = true;</code>
<code>  public override string ToString() =&gt; Title;</code>
<code>}</code></pre>
            <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">The <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code> class that is
                used here can also be used with a relational database (code file <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Cosmos/MenuItem.cs</code>):
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">这里使用的 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                            类也可以与关系型数据库一起使用（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Cosmos/MenuItem.cs</code>
                            ）：</font>
                    </font>
                </font>
            </p>
            <pre id="c21-code-0134"><code>public class MenuItem</code>
<code>{</code>
<code>  public MenuItem(string text, Guid menuItemId = default) =&gt; </code>
<code>  (Text, MenuItemId) = (text, menuItemId);</code>
<code> </code>
<code>  public Guid MenuItemId { get; set; }</code>
<code>  public string Text { get; set; }<span aria-label="641" epub:type="pagebreak" id="Page_641" role="doc-pagebreak"></span></code>
<code>  public decimal? Price { get; set; }</code>
<code>  public override string ToString() =&gt; Text;</code>
<code>}</code></pre>
            <p id="c21-para-0273" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">For storing documents, you now need to think about how the menu
                cards and the menus should be stored with the Azure Cosmos DB. Earlier in this chapter, you read about
                owned entities. You can use the <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OwnsOne</code> method to add
                the properties of the <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Location</code> and <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Address</code> types to the
                columns of the <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">People</code> table. With
                document-based storage, this is even more important. You can also store a list of objects within one
                object; a hierarchy of JSON data is what is stored inside a document. As menu cards are usually the unit
                to read the menus and also change the menus, <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code> objects can
                be combined with the <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code> using <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OwnsMany</code>.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">为了存储文档，现在你需要考虑如何将菜单卡和菜单与 Azure Cosmos
                            DB 存储起来。在本章之前，你读到了关于拥有实体的内容。你可以使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OwnsOne</code>
                            方法将 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Location</code> 和
                            <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Address</code>
                            类型的属性添加到 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">People</code>
                            表的列中。在基于文档的存储中，这一点更加重要。你还可以在一个对象中存储一组对象；JSON 数据的层次结构就是存储在文档内部。由于菜单卡通常是读取和更改菜单的单位， <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                            对象可以与 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuCard</code>
                            通过 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OwnsMany</code>
                            结合起来。</font>
                    </font>
                </font>
            </p>
            <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">The configuration of the <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenusContext</code> now has
                some specific Azure Cosmos DB configuration with the model. When you use the <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OwnsMany</code> method, you
                include the <code data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                objects. A default container name is defined with the <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">HasDefaultContainer</code>
                method. Remember, with the relational database, the database schema name was specified. A partition key
                is defined with the method <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">HasPartitionKey</code> (code
                file <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Cosmos/MenusContext.cs</code>):
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1"> <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenusContext</code>
                            的配置现在具有一些与模型相关的特定 Azure Cosmos DB 配置。当你使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OwnsMany</code>
                            方法时，你会包含 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">MenuItem</code>
                            对象。使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">HasDefaultContainer</code>
                            方法定义了默认容器名称。记住，在关系型数据库中，指定了数据库模式名称。使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">HasPartitionKey</code>
                            方法（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Cosmos/MenusContext.cs</code>
                            ）定义了分区键：</font>
                    </font>
                </font>
            </p>
            <pre id="c21-code-0135"><code>internal class MenusContext : DbContext</code>
<code>{</code>
<code>  public MenusContext(DbContextOptions&lt;MenusContext&gt; options)</code>
<code>    : base(options) {}</code>
<code> </code>
<code>  public DbSet&lt;MenuCard&gt; MenuCards =&gt; Set&lt;MenuCard&gt;();</code>
<code> </code>
<code>  protected override void OnModelCreating(ModelBuilder modelBuilder)</code>
<code>  {</code>
<code>    <b>modelBuilder.HasDefaultContainer("menucards");</b></code>
<code> </code>
<code>    <b>modelBuilder.Entity&lt;MenuCard&gt;().OwnsMany(c =&gt; c.MenuItems);</b></code>
<code>    <b>modelBuilder.Entity&lt;MenuCard&gt;().HasKey(c =&gt; c.MenuCardId);</b></code>
<code> </code>
<code>    <b>modelBuilder.Entity&lt;MenuCard&gt;().HasPartitionKey(c =&gt; c.RestaurantId);</b></code>
<code>  }</code>
<code>}</code></pre>
            <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">With all this in place, the database can be created, and objects
                can be added, modified, and deleted as you are used to. The database is created with <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EnsureCreatedAsync</code>.
                With the method <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">AddMenuCardAsync</code>, a
                card containing multiple menu items is created, added to the context, and saved (code file <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Cosmos/Runner.cs</code>):
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            所有这些准备工作完成后，数据库即可创建，对象也可以像往常一样添加、修改和删除。数据库是使用 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">EnsureCreatedAsync</code>
                            创建的。使用方法 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">AddMenuCardAsync</code>
                            ，创建一个包含多个菜单项的卡片，将其添加到上下文中并保存（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Cosmos/Runner.cs</code>
                            ）：</font>
                    </font>
                </font>
            </p>
            <pre id="c21-code-0136"><code>public async Task CreateDatabaseAsync()</code>
<code>{</code>
<code>  await _menusContext.Database.EnsureCreatedAsync();</code>
<code>}</code>
<code> </code>
<code>public async Task AddMenuCardAsync()</code>
<code>{</code>
<code>  Console.WriteLine(nameof(AddMenuCardAsync));</code>
<code>  MenuCard soupCard = new("Soups", _restaurantId);</code>
<code> </code>
<code>  MenuItem[] soups = new MenuItem[]</code>
<code>  {</code>
<code>    new("Consommé Célestine (with shredded pancake)")</code>
<code>    {</code>
<code>      Price = 4.8m</code>
<code>    },<span aria-label="642" epub:type="pagebreak" id="Page_642" role="doc-pagebreak"></span></code>
<code>    new("Baked Potato Soup")</code>
<code>    {</code>
<code>      Price = 4.8m</code>
<code>    },</code>
<code>    new("Cheddar Broccoli Soup")</code>
<code>    {</code>
<code>      Price = 4.8m</code>
<code>    }</code>
<code>  };</code>
<code> </code>
<code>  foreach (var soup in soups)</code>
<code>  {</code>
<code>    soupCard.MenuItems.Add(soup);</code>
<code>  }</code>
<code> </code>
<code>  _menusContext.MenuCards.Add(soupCard);</code>
<code> </code>
<code>  int records = await _menusContext.SaveChangesAsync();</code>
<code>  Console.WriteLine($"{records} added");</code>
<code>  Console.WriteLine();</code>
<code>}</code></pre>
            <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">Looking into the storage explorer of the Azure Cosmos DB, you can
                see additional data that's added by the provider and the database. A <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Discriminator</code> is added
                that contains the name of the class used. Remember, a container can have different types stored. The
                discriminator is used with queries. If a discriminator is not supplied with the object model, a shadow
                property is created automatically. With Cosmos DB, an identifier, which consists of the type and the key
                value, is created as well. Timestamp and entity tag (ETag) can be used for conflict handling; these can
                be accessed via shadow properties. Because of the <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OwnsMany</code> model
                definition, the menu items are stored within the menu card:<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">查看 Azure Cosmos DB
                            的存储浏览器，可以看到由提供者和数据库添加的额外数据。添加了一个 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Discriminator</code>
                            ，其中包含所使用的类名。记住，一个容器可以存储不同类型的数据。区分器用于查询。如果对象模型中没有提供区分器，则会自动创建一个影子属性。使用 Cosmos DB
                            时，还会创建一个由类型和键值组成的标识符。时间戳和实体标签（ETag）可用于冲突处理；这些可以通过影子属性访问。由于 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">OwnsMany</code>
                            模型定义，菜单项存储在菜单卡中：</font>
                    </font>
                </font>
            </p>
            <pre id="c21-code-0137"><code>{</code>
<code>  "MenuCardId": "bbe03556-4211-4694-ab73-6ba4af524d40",</code>
<code>  "Discriminator": "MenuCard",</code>
<code>  "IsActive": true,</code>
<code>  "RestaurantId": "FDCD4390-48AD-42F1-AC6A-596F56731795",</code>
<code>  "Title": "Soups",</code>
<code>  "id": "MenuCard|bbe03556-4211-4694-ab73-6ba4af524d40",</code>
<code>  "MenuItems": [</code>
<code>    {</code>
<code>      "MenuItemId": "bc6dabc3-6825-41a1-b45e-6c55a3ab0ada",</code>
<code>      "Price": 4.8,</code>
<code>      "Text": "Consommé Célestine (with shredded pancake)"</code>
<code>    },</code>
<code>    {</code>
<code>      "MenuItemId": "b46b5cca-1b40-4fdf-9fca-84bbf8461f7e",</code>
<code>      "Price": 4.8,</code>
<code>      "Text": "Baked Potato Soup"</code>
<code>    },</code>
<code>    {</code>
<code>      "MenuItemId": "6083da30-c405-4bb8-8f57-8f5c32b496da",</code>
<code>      "Price": 4.8,</code>
<code>      "Text": "Cheddar Broccoli Soup"</code>
<code>    }</code>
<code>  ],</code>
<code>  "_rid": "S+t-ALEbVnkBAAAAAAAAAA==",<span aria-label="643" epub:type="pagebreak" id="Page_643" role="doc-pagebreak"></span></code>
<code>  "_self": "dbs/S+t-AA==/colls/S+t-ALEbVnk=/docs/S+t-ALEbVnkBAAAAAAAAAA==/",</code>
<code>  "_etag": "\"af009326-0000-0d00-0000-6039f6180000\"",</code>
<code>  "_attachments": "attachments/",</code>
<code>  "_ts": 1614411288</code>
<code>}</code></pre>
            <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">The method <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ShowCardsAsync</code> creates
                a query to retrieve the active documents with a title named <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Soups</code> and includes the
                partition key with the query (code file <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Cosmos/Runner.cs</code>):
                <font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">方法 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">ShowCardsAsync</code>
                            创建了一个查询来检索标题名为 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Soups</code>
                            的活动文档，并将分区键包含在查询中（代码文件 <code xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">Cosmos/Runner.cs</code>
                            ）：</font>
                    </font>
                </font>
            </p>
            <pre id="c21-code-0138"><code>public async Task ShowCardsAsync()</code>
<code>{</code>
<code>  var cards = await _menusContext.MenuCards</code>
<code>    .Where(c =&gt; c.IsActive)</code>
<code>    .Where(c =&gt; c.Title == "Soups")</code>
<code>    .WithPartitionKey(_restaurantId)</code>
<code>    .ToListAsync();</code>
<code>  foreach (var card in cards)</code>
<code>  {</code>
<code>    Console.WriteLine(card.Title);</code>
<code>    foreach (var menuItem in card.MenuItems)</code>
<code>    {</code>
<code>      Console.WriteLine(menuItem.Text);</code>
<code>    }</code>
<code>  }</code>
<code>}</code></pre>
            <p data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">The generated query adds the discriminator:<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">生成的查询添加了区分器：</font>
                    </font>
                </font>
            </p>
            <pre id="c21-code-0139"><code>SELECT c</code>
<code>  FROM root c</code>
<code>  WHERE (((c["Discriminator"] = "MenuCard") AND c["IsActive"]) AND (c["Title"] = "Soups"))</code></pre>
            <p id="c21-para-0279" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">As you've seen, there are similarities and important differences
                when using a NoSQL database and a relational database with EF Core. A couple of other differences you
                need to be aware of are that you can't create complex queries to access Azure Cosmos DB, and aggregate
                operators are not supported from this EF Core provider. Making counts is an expensive operation. To
                allow paging across the data with a NoSQL database, many applications just offer prev/next buttons, but
                don't give details on how many pages are available (at least not with exact values).<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">如你所见，在使用 NoSQL 数据库和关系型数据库时，Entity
                            Framework Core 存在相似之处和重要差异。你需要注意的其他一些差异包括无法创建复杂查询来访问 Azure Cosmos DB，以及这个 EF Core
                            提供程序不支持聚合运算符。计数操作非常耗费资源。为了使用 NoSQL 数据库实现分页，许多应用程序仅提供上一页/下一页按钮，但不会提供可用页数的详细信息（至少不会提供精确值）。
                        </font>
                    </font>
                </font>
            </p>
        </section>
        <section aria-labelledby="head-2-203" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">
            <span id="c21-sec-0086" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"></span>
            <h2 id="head-2-203" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">SUMMARY<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN">
                    <font class="notranslate" data-immersive-translate-translation-element-mark="1">  </font>
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">摘要</font>
                    </font>
                </font>
            </h2>
            <p id="c21-para-0280" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">This chapter introduced you to the rich features of the EF Core.
                You've learned how the <code
                    data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code> keeps
                knowledge about entities retrieved and updated and how changes can be written to the database. You've
                also seen how migrations can be used to create and change the database schema from C# code. In terms of
                defining the schema, you've seen how the database mapping can be done using data annotations, and you've
                also seen the Fluent API that offers more features compared to the annotations and conventions.<font
                    class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">本章向你介绍了 EF Core 的丰富功能。你学习了 <code
                                xmlns="http://www.w3.org/1999/xhtml"
                                data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc">DbContext</code>
                            如何保留检索和更新实体的知识，以及如何将更改写入数据库。你还看到了如何使用 C#代码通过迁移来创建和更改数据库模式。在定义模式方面，你看到了如何使用数据注解进行数据库映射，还看到了
                            Fluent API，它比注解和约定提供了更多功能。</font>
                    </font>
                </font>
            </p>
            <p id="c21-para-0281" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">You've seen possibilities for reacting to conflicts when multiple
                users work on the same record, as well as using transactions implicitly or explicitly for more
                transactional control.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">
                            您已经看到了当多个用户同时处理同一记录时，如何应对冲突的可能性，以及如何隐式或显式地使用事务以获得更强大的事务控制。</font>
                    </font>
                </font>
            </p>
            <p id="c21-para-0282" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">This chapter also covered great features of EF Core, such as
                compiled queries, global query filters, table splitting, owned entities, many-to-many relations, and how
                to use a NoSQL database with EF Core.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">本章还介绍了 EF Core
                            的许多强大功能，例如编译查询、全局查询过滤器、表拆分、所属实体、多对多关系，以及如何使用 NoSQL 数据库与 EF Core 一起工作。</font>
                    </font>
                </font>
            </p>
            <p id="c21-para-0283" data-immersive-translate-walked="c2608cd4-c5ce-4828-b593-da75749a69cc"
                data-immersive-translate-paragraph="1">The next chapter gets into globalization and localization
                features of .NET, using culture-specific date, time, and number formats, as well as resources to define
                text for different languages.<font class="notranslate immersive-translate-target-wrapper"
                    data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br />
                    <font
                        class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper"
                        data-immersive-translate-translation-element-mark="1">
                        <font
                            class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner"
                            data-immersive-translate-translation-element-mark="1">下一章将探讨.NET
                            的全球化和本地化功能，包括使用特定文化的日期、时间和数字格式，以及如何使用资源定义不同语言的文本。</font>
                    </font>
                </font>
            </p>
        </section>
    </section>
</body>
<div id="immersive-translate-popup" style="all: initial"></div>

</html>